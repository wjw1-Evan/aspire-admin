---
globs: **/Platform.Admin/**/*.ts,**/Platform.Admin/**/*.tsx,**/config/**/*.ts
description: Ant Design Pro å’Œ UmiJS å¼€å‘è§„èŒƒ
---

# Ant Design Pro + UmiJS å¼€å‘è§„èŒƒ

## ğŸ¯ æŠ€æœ¯æ ˆæ¦‚è§ˆ

### æ ¸å¿ƒæŠ€æœ¯
- **Ant Design Pro** - ä¼ä¸šçº§ä¸­åå° UI è§£å†³æ–¹æ¡ˆ
- **UmiJS 4** - ä¼ä¸šçº§å‰ç«¯åº”ç”¨æ¡†æ¶
- **React 19** - ç”¨æˆ·ç•Œé¢åº“
- **TypeScript** - ç±»å‹å®‰å…¨çš„ JavaScript
- **Biome** - ä»£ç æ ¼å¼åŒ–å’Œ Lint å·¥å…·

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

### æ ‡å‡†ç›®å½•ç»“æ„

```text
Platform.Admin/
â”œâ”€â”€ config/                   # UmiJS é…ç½®
â”‚   â”œâ”€â”€ config.ts            # ä¸»é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ defaultSettings.ts   # é»˜è®¤è®¾ç½®
â”‚   â”œâ”€â”€ proxy.ts            # å¼€å‘ä»£ç†é…ç½®
â”‚   â””â”€â”€ routes.ts           # è·¯ç”±é…ç½®
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/         # å…¨å±€ç»„ä»¶
â”‚   â”œâ”€â”€ pages/             # é¡µé¢ç»„ä»¶
â”‚   â”œâ”€â”€ services/          # API æœåŠ¡
â”‚   â”œâ”€â”€ utils/             # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ app.tsx            # åº”ç”¨å…¥å£é…ç½®
â”‚   â””â”€â”€ request-error-config.ts  # è¯·æ±‚é”™è¯¯é…ç½®
â”œâ”€â”€ biome.json             # Biome é…ç½®
â””â”€â”€ package.json           # ä¾èµ–é…ç½®
```

## ğŸ¨ åº”ç”¨é…ç½®

### app.tsx è¿è¡Œæ—¶é…ç½®

```typescript
// âœ… æ¨èï¼šapp.tsx æ ‡å‡†ç»“æ„
import type { RequestConfig, RunTimeLayoutConfig } from '@umijs/max';
import { history } from '@umijs/max';
import { tokenUtils } from '@/utils/token';
import defaultSettings from '../config/defaultSettings';
import { errorConfig } from './request-error-config';

// è·å–åˆå§‹çŠ¶æ€
export async function getInitialState() {
  const fetchUserInfo = async () => {
    // æ£€æŸ¥ token
    if (!tokenUtils.hasToken()) {
      return undefined;
    }
    
    try {
      const msg = await queryCurrentUser({
        skipErrorHandler: true,
      });
      return msg.data;
    } catch (error) {
      tokenUtils.clearAllTokens();
      history.push('/user/login');
      return undefined;
    }
  };
  
  // éç™»å½•é¡µé¢æ‰§è¡Œåˆå§‹åŒ–
  const { location } = history;
  if (!['/user/login', '/user/register'].includes(location.pathname)) {
    const currentUser = await fetchUserInfo();
    return {
      fetchUserInfo,
      currentUser,
      settings: defaultSettings,
    };
  }
  
  return {
    fetchUserInfo,
    settings: defaultSettings,
  };
}

// ProLayout é…ç½®
export const layout: RunTimeLayoutConfig = ({ initialState, setInitialState }) => {
  return {
    actionsRender: () => [<Question key="doc" />, <SelectLang key="SelectLang" />],
    avatarProps: {
      src: initialState?.currentUser?.avatar,
      title: <AvatarName />,
      render: (_, avatarChildren) => {
        return <AvatarDropdown menu>{avatarChildren}</AvatarDropdown>;
      },
    },
    footerRender: () => <Footer />,
    onPageChange: () => {
      const { location } = history;
      // æœªç™»å½•é‡å®šå‘
      if (!initialState?.currentUser && location.pathname !== '/user/login') {
        history.push('/user/login');
      }
    },
    // åŠ¨æ€èœå•æ¸²æŸ“
    menuDataRender: (menuData) => {
      if (initialState?.currentUser?.menus) {
        return convertMenuTreeToProLayout(initialState.currentUser.menus);
      }
      return menuData;
    },
    ...initialState?.settings,
  };
};
```

## ğŸŒ ç½‘ç»œè¯·æ±‚é…ç½®

### è¯·æ±‚æ‹¦æˆªå™¨

```typescript
// âœ… æ¨èï¼šè¯·æ±‚é…ç½®
export const request: RequestConfig = {
  baseURL: process.env.NODE_ENV === 'development' ? '' : 'https://api.example.com',
  
  // è¯·æ±‚æ‹¦æˆªå™¨ - æ·»åŠ è®¤è¯å¤´
  requestInterceptors: [
    (config: any) => {
      const token = tokenUtils.getToken();
      if (token) {
        config.headers = {
          ...config.headers,
          Authorization: `Bearer ${token}`,
        };
      }
      return config;
    },
  ],

  // å“åº”æ‹¦æˆªå™¨ - å¤„ç† token è¿‡æœŸ
  responseInterceptors: [
    (response) => response,
    async (error: any) => {
      if (error.response?.status === 401) {
        // æ£€æŸ¥æ˜¯å¦æ˜¯åˆ·æ–°tokenè¯·æ±‚ï¼Œé¿å…é€’å½’
        const isRefreshTokenRequest = error.config?.url?.includes('/refresh-token');
        const isRetryRequest = error.config?._retry;
        
        if (isRefreshTokenRequest || isRetryRequest) {
          tokenUtils.clearAllTokens();
          history.push('/user/login');
          return Promise.reject(error);
        }
        
        // å°è¯•åˆ·æ–°token
        const refreshToken = tokenUtils.getRefreshToken();
        if (refreshToken) {
          try {
            const { refreshToken: refreshTokenAPI } = await import('@/services/ant-design-pro/api');
            const refreshResponse = await refreshTokenAPI({ refreshToken });

            if (refreshResponse.success && refreshResponse.data) {
              const refreshResult = refreshResponse.data;
              if (refreshResult.status === 'ok' && refreshResult.token) {
                // ä¿å­˜æ–°tokenå¹¶é‡è¯•è¯·æ±‚
                const expiresAt = refreshResult.expiresAt 
                  ? new Date(refreshResult.expiresAt).getTime() 
                  : undefined;
                tokenUtils.setTokens(
                  refreshResult.token, 
                  refreshResult.refreshToken, 
                  expiresAt
                );

                // é‡è¯•åŸå§‹è¯·æ±‚
                const originalRequest = error.config;
                originalRequest._retry = true;
                originalRequest.headers.Authorization = `Bearer ${refreshResult.token}`;
                return requestClient(originalRequest);
              }
            }
          } catch (refreshError) {
            console.error('Token refresh failed:', refreshError);
          }
        }
        
        // åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬ç™»å½•
        tokenUtils.clearAllTokens();
        history.push('/user/login');
      }
      
      return Promise.reject(error);
    },
  ],
  
  ...errorConfig,
};
```

### é”™è¯¯å¤„ç†é…ç½®

```typescript
// âœ… æ¨èï¼šç»Ÿä¸€é”™è¯¯å¤„ç†
import { message, notification } from 'antd';

export enum ErrorShowType {
  SILENT = 0,
  WARN_MESSAGE = 1,
  ERROR_MESSAGE = 2,
  NOTIFICATION = 3,
  REDIRECT = 9,
}

export const errorConfig: RequestConfig = {
  errorConfig: {
    // é”™è¯¯æŠ›å‡º
    errorThrower: (res) => {
      const { success, data, errorCode, errorMessage, showType } = res;
      if (!success) {
        const error: any = new Error(errorMessage);
        error.name = 'BizError';
        error.info = { errorCode, errorMessage, showType, data };
        throw error;
      }
    },
    
    // é”™è¯¯æ¥æ”¶åŠå¤„ç†
    errorHandler: (error: any, opts: any) => {
      if (opts?.skipErrorHandler) throw error;
      
      if (error.name === 'BizError') {
        const errorInfo = error.info;
        if (errorInfo) {
          const { errorMessage, errorCode } = errorInfo;
          switch (errorInfo.showType) {
            case ErrorShowType.SILENT:
              break;
            case ErrorShowType.WARN_MESSAGE:
              message.warning(errorMessage);
              break;
            case ErrorShowType.ERROR_MESSAGE:
              message.error(errorMessage);
              break;
            case ErrorShowType.NOTIFICATION:
              notification.open({
                description: errorMessage,
                message: errorCode,
              });
              break;
            default:
              message.error(errorMessage);
          }
        }
      } else if (error.response) {
        message.error(`Response status: ${error.response.status}`);
      } else if (error.request) {
        message.error('None response! Please retry.');
      } else {
        message.error('Request error, please retry.');
      }
    },
  },
};
```

## ğŸ“ æœåŠ¡å±‚è®¾è®¡

### API æœåŠ¡å°è£…

```typescript
// âœ… æ¨èï¼šservices/ant-design-pro/api.ts
import { request } from '@umijs/max';
import type { ApiResponse } from '@/types/unified-api';

/** è·å–å½“å‰ç”¨æˆ· GET /api/currentUser */
export async function currentUser(options?: { [key: string]: any }) {
  return request<ApiResponse<API.CurrentUser>>('/api/currentUser', {
    method: 'GET',
    ...(options || {}),
  });
}

/** ç™»å½•æ¥å£ POST /api/login/account */
export async function login(
  body: API.LoginParams, 
  options?: { [key: string]: any }
) {
  return request<ApiResponse<API.LoginData>>('/api/login/account', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    data: body,
    ...(options || {}),
  });
}

/** åˆ·æ–°tokenæ¥å£ POST /api/refresh-token */
export async function refreshToken(
  body: API.RefreshTokenRequest, 
  options?: { [key: string]: any }
) {
  return request<API.ApiResponse<API.RefreshTokenResult>>('/api/refresh-token', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    data: body,
    ...(options || {}),
  });
}

/** é€€å‡ºç™»å½• POST /api/login/outLogin */
export async function outLogin(options?: { [key: string]: any }) {
  return request<Record<string, any>>('/api/login/outLogin', {
    method: 'POST',
    ...(options || {}),
  });
}
```

### Token å·¥å…·å°è£…

```typescript
// âœ… æ¨èï¼šutils/token.ts
const TOKEN_KEY = 'auth_token';
const REFRESH_TOKEN_KEY = 'auth_refresh_token';
const TOKEN_EXPIRES_KEY = 'auth_token_expires';

export const tokenUtils = {
  getToken(): string | null {
    return localStorage.getItem(TOKEN_KEY);
  },

  setToken(token: string): void {
    localStorage.setItem(TOKEN_KEY, token);
  },

  removeToken(): void {
    localStorage.removeItem(TOKEN_KEY);
  },

  hasToken(): boolean {
    return !!this.getToken();
  },

  getRefreshToken(): string | null {
    return localStorage.getItem(REFRESH_TOKEN_KEY);
  },

  setRefreshToken(refreshToken: string): void {
    localStorage.setItem(REFRESH_TOKEN_KEY, refreshToken);
  },

  removeRefreshToken(): void {
    localStorage.removeItem(REFRESH_TOKEN_KEY);
  },

  getTokenExpiresAt(): number | null {
    const expires = localStorage.getItem(TOKEN_EXPIRES_KEY);
    return expires ? parseInt(expires, 10) : null;
  },

  setTokenExpiresAt(expiresAt: number): void {
    localStorage.setItem(TOKEN_EXPIRES_KEY, expiresAt.toString());
  },

  removeTokenExpiresAt(): void {
    localStorage.removeItem(TOKEN_EXPIRES_KEY);
  },

  setTokens(token: string, refreshToken: string, expiresAt?: number): void {
    this.setToken(token);
    this.setRefreshToken(refreshToken);
    if (expiresAt) {
      this.setTokenExpiresAt(expiresAt);
    }
  },

  clearAllTokens(): void {
    this.removeToken();
    this.removeRefreshToken();
    this.removeTokenExpiresAt();
  },

  isTokenExpired(): boolean {
    const expiresAt = this.getTokenExpiresAt();
    if (!expiresAt) return false;
    return Date.now() >= expiresAt;
  },
};
```

## ğŸ“Š é¡µé¢å¼€å‘

### ProTable ä½¿ç”¨

```typescript
// âœ… æ¨èï¼šä½¿ç”¨ ProTable
import { ProTable } from '@ant-design/pro-components';
import type { ProColumns } from '@ant-design/pro-components';

const UserManagement: React.FC = () => {
  const actionRef = useRef<ActionType>();
  
  const columns: ProColumns<API.AppUser>[] = [
    {
      title: 'ç”¨æˆ·å',
      dataIndex: 'username',
      copyable: true,
      ellipsis: true,
    },
    {
      title: 'é‚®ç®±',
      dataIndex: 'email',
      copyable: true,
    },
    {
      title: 'è§’è‰²',
      dataIndex: 'access',
      valueEnum: {
        admin: { text: 'ç®¡ç†å‘˜', status: 'Success' },
        user: { text: 'ç”¨æˆ·', status: 'Default' },
      },
    },
    {
      title: 'æ“ä½œ',
      valueType: 'option',
      render: (_, record) => [
        <a key="edit" onClick={() => handleEdit(record)}>ç¼–è¾‘</a>,
        <a key="delete" onClick={() => handleDelete(record)}>åˆ é™¤</a>,
      ],
    },
  ];

  return (
    <ProTable<API.AppUser>
      headerTitle="ç”¨æˆ·åˆ—è¡¨"
      actionRef={actionRef}
      rowKey="id"
      search={{
        labelWidth: 120,
      }}
      toolBarRender={() => [
        <Button key="primary" type="primary" onClick={() => handleAdd()}>
          æ–°å»º
        </Button>,
      ]}
      request={async (params, sort, filter) => {
        const msg = await getUsers({ ...params, ...sort, ...filter });
        return {
          data: msg.data,
          success: msg.success,
          total: msg.total,
        };
      }}
      columns={columns}
    />
  );
};
```

### ProForm ä½¿ç”¨

```typescript
// âœ… æ¨èï¼šä½¿ç”¨ ProForm
import { ModalForm, ProFormText, ProFormSelect } from '@ant-design/pro-components';

const UserForm: React.FC<UserFormProps> = ({ visible, onCancel, onSubmit, initialValues }) => {
  return (
    <ModalForm
      title={initialValues ? 'ç¼–è¾‘ç”¨æˆ·' : 'æ–°å»ºç”¨æˆ·'}
      open={visible}
      onFinish={async (values) => {
        await onSubmit(values);
        return true;
      }}
      onOpenChange={(open) => {
        if (!open) onCancel();
      }}
      initialValues={initialValues}
    >
      <ProFormText
        name="username"
        label="ç”¨æˆ·å"
        placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
        rules={[{ required: true, message: 'è¯·è¾“å…¥ç”¨æˆ·å' }]}
      />
      
      <ProFormText
        name="email"
        label="é‚®ç®±"
        placeholder="è¯·è¾“å…¥é‚®ç®±"
        rules={[
          { required: true, message: 'è¯·è¾“å…¥é‚®ç®±' },
          { type: 'email', message: 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®' },
        ]}
      />
      
      <ProFormSelect
        name="access"
        label="è§’è‰²"
        valueEnum={{
          admin: 'ç®¡ç†å‘˜',
          user: 'ç”¨æˆ·',
          guest: 'è®¿å®¢',
        }}
        rules={[{ required: true, message: 'è¯·é€‰æ‹©è§’è‰²' }]}
      />
    </ModalForm>
  );
};
```

## ğŸ¯ è·¯ç”±é…ç½®

### routes.ts é…ç½®

```typescript
// âœ… æ¨èï¼šconfig/routes.ts
export default [
  {
    path: '/user',
    layout: false,
    routes: [
      { path: '/user/login', component: './user/login' },
      { path: '/user/register', component: './user/register' },
    ],
  },
  {
    path: '/welcome',
    name: 'æ¬¢è¿',
    icon: 'smile',
    component: './Welcome',
  },
  {
    path: '/admin',
    name: 'ç³»ç»Ÿç®¡ç†',
    icon: 'crown',
    access: 'canAdmin',
    routes: [
      {
        path: '/admin/user-management',
        name: 'ç”¨æˆ·ç®¡ç†',
        component: './user-management',
      },
      {
        path: '/admin/role-management',
        name: 'è§’è‰²ç®¡ç†',
        component: './role-management',
      },
    ],
  },
  { path: '/', redirect: '/welcome' },
  { path: '*', layout: false, component: './404' },
];
```

### åŠ¨æ€èœå•

```typescript
// âœ… æ¨èï¼šåŠ¨æ€èœå•æ¸²æŸ“
function convertMenuTreeToProLayout(menus: API.MenuTreeNode[]): any[] {
  return menus
    .filter(menu => !menu.hideInMenu)
    .map(menu => {
      const menuItem: any = {
        name: menu.name,
        path: menu.path,
        icon: getIconComponent(menu.icon),
      };

      if (menu.isExternal) {
        menuItem.target = menu.openInNewTab ? '_blank' : '_self';
      }

      if (menu.children && menu.children.length > 0) {
        menuItem.routes = convertMenuTreeToProLayout(menu.children);
      }

      return menuItem;
    });
}
```

## ğŸš« é¿å…çš„åšæ³•

- ä¸è¦ç›´æ¥ä¿®æ”¹ ProComponents çš„å†…éƒ¨çŠ¶æ€
- ä¸è¦å¿½ç•¥ TypeScript ç±»å‹æ£€æŸ¥
- ä¸è¦åœ¨ç»„ä»¶ä¸­ç›´æ¥ä½¿ç”¨ localStorageï¼Œä½¿ç”¨ tokenUtils
- ä¸è¦å¿˜è®°å¤„ç†å¼‚æ­¥è¯·æ±‚çš„é”™è¯¯
- ä¸è¦ç¡¬ç¼–ç  API åœ°å€ï¼Œä½¿ç”¨ä»£ç†é…ç½®

## ğŸ”§ æœ€ä½³å®è·µ

1. **ä½¿ç”¨ ProComponents** - å……åˆ†åˆ©ç”¨ Ant Design Pro ç»„ä»¶
2. **ç»Ÿä¸€çŠ¶æ€ç®¡ç†** - ä½¿ç”¨ initialState ç®¡ç†å…¨å±€çŠ¶æ€
3. **è¯·æ±‚æ‹¦æˆªå™¨** - ç»Ÿä¸€å¤„ç†è®¤è¯å’Œé”™è¯¯
4. **ç±»å‹å®šä¹‰** - ä½¿ç”¨ TypeScript ç±»å‹å®šä¹‰
5. **ä»£ç è§„èŒƒ** - éµå¾ª Biome é…ç½®
6. **æƒé™æ§åˆ¶** - ä½¿ç”¨ access æ§åˆ¶é¡µé¢è®¿é—®
7. **åŠ¨æ€èœå•** - æ”¯æŒåç«¯åŠ¨æ€èœå•é…ç½®
8. **Token åˆ·æ–°** - å®ç°è‡ªåŠ¨ token åˆ·æ–°æœºåˆ¶

## ğŸ“š ç›¸å…³èµ„æº

- [Ant Design Pro æ–‡æ¡£](https://pro.ant.design)
- [UmiJS æ–‡æ¡£](https://umijs.org)
- [ProComponents æ–‡æ¡£](https://procomponents.ant.design)

