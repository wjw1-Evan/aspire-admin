---
globs: Platform.ApiService/Controllers/*.cs
description: APIæ§åˆ¶å™¨å¼€å‘è§„èŒƒ
---
# APIæ§åˆ¶å™¨å¼€å‘è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**æ‰€æœ‰æ§åˆ¶å™¨å¿…é¡»ç»§æ‰¿ `BaseApiController`ï¼Œç¦æ­¢ç›´æ¥ç»§æ‰¿ `ControllerBase`**

## âœ… æ­£ç¡®çš„æ§åˆ¶å™¨å®ç°

```csharp
[ApiController]
[Route("api/[controller]")]
[Authorize]
public class UserController : BaseApiController  // âœ… å¿…é¡»ç»§æ‰¿ BaseApiController
{
    private readonly IUserService _userService;

    public UserController(IUserService userService)
    {
        _userService = userService;
    }

    /// <summary>
    /// è·å–æ‰€æœ‰ç”¨æˆ·
    /// </summary>
    [HttpGet]
    public async Task<IActionResult> GetAll()
    {
        var users = await _userService.GetAllUsersAsync();
        return Success(users);  // âœ… ä½¿ç”¨åŸºç±»æ–¹æ³•
    }

    /// <summary>
    /// æ ¹æ®IDè·å–ç”¨æˆ·
    /// </summary>
    [HttpGet("{id}")]
    public async Task<IActionResult> GetById(string id)
    {
        var user = await _userService.GetUserByIdAsync(id);
        if (user == null)
            throw new KeyNotFoundException($"ç”¨æˆ· {id} ä¸å­˜åœ¨");  // âœ… æŠ›å‡ºå¼‚å¸¸
        
        return Success(user);
    }

    /// <summary>
    /// åˆ›å»ºç”¨æˆ·
    /// </summary>
    [HttpPost]
    public async Task<IActionResult> Create([FromBody] CreateUserRequest request)
    {
        if (string.IsNullOrEmpty(request.Name))
            throw new ArgumentException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");  // âœ… å‚æ•°éªŒè¯
        
        var userId = GetRequiredUserId();  // âœ… ä½¿ç”¨åŸºç±»æ–¹æ³•
        var user = await _userService.CreateUserAsync(request, userId);
        
        return Success(user, "åˆ›å»ºæˆåŠŸ");
    }
}
```

## ğŸ”§ BaseApiController æä¾›çš„åŠŸèƒ½

### ç”¨æˆ·ä¿¡æ¯å±æ€§
- `CurrentUserId` - å½“å‰ç”¨æˆ·IDï¼ˆå¯ç©ºï¼‰
- `CurrentUsername` - å½“å‰ç”¨æˆ·åï¼ˆå¯ç©ºï¼‰
- `CurrentUserRole` - å½“å‰ç”¨æˆ·è§’è‰²ï¼ˆå¯ç©ºï¼‰
- `IsAdmin` - æ˜¯å¦ä¸ºç®¡ç†å‘˜
- `IsAuthenticated` - æ˜¯å¦å·²è®¤è¯

### å®‰å…¨è·å–ç”¨æˆ·ä¿¡æ¯
```csharp
// è·å–å¿…éœ€çš„ç”¨æˆ·IDï¼ˆä¸ºç©ºåˆ™è‡ªåŠ¨æŠ›å‡º UnauthorizedAccessExceptionï¼‰
var userId = GetRequiredUserId();
```

### ç»Ÿä¸€å“åº”æ–¹æ³•

#### æˆåŠŸå“åº”
```csharp
// è¿”å›æ•°æ®
return Success(data);

// è¿”å›æ•°æ®å’Œæ¶ˆæ¯
return Success(data, "è·å–æˆåŠŸ");

// è¿”å›æ¶ˆæ¯
return Success("æ“ä½œæˆåŠŸ");

// ApiResponse æ ¼å¼
return SuccessResponse(data);
```

#### é”™è¯¯å“åº”
```csharp
// é€šç”¨é”™è¯¯ï¼ˆå»ºè®®ï¼šç›´æ¥æŠ›å¼‚å¸¸ï¼Œç”± GlobalExceptionMiddleware å¤„ç†ï¼‰
throw new InvalidOperationException("æ“ä½œå¤±è´¥");

// ç‰¹å®šé”™è¯¯
throw new KeyNotFoundException("èµ„æºä¸å­˜åœ¨");
throw new ArgumentException("å‚æ•°é”™è¯¯");
throw new UnauthorizedAccessException("æœªæˆæƒ");

// æ‰‹åŠ¨è¿”å›é”™è¯¯ï¼ˆä¸æ¨èï¼‰
return Error("é”™è¯¯æ¶ˆæ¯");
return NotFoundError("èµ„æºä¸å­˜åœ¨");
return UnauthorizedError("æœªæˆæƒè®¿é—®");
```

## âŒ ç¦æ­¢çš„åšæ³•

### ä¸è¦ç›´æ¥ç»§æ‰¿ ControllerBase
```csharp
// âŒ ç¦æ­¢
[ApiController]
[Route("api/[controller]")]
public class UserController : ControllerBase  // âŒ ç¦æ­¢ç›´æ¥ç»§æ‰¿ ControllerBase
{
    // ...
}
```

### ä¸è¦æ‰‹åŠ¨æå–ç”¨æˆ·ä¿¡æ¯
```csharp
// âŒ ä¸è¦è¿™æ ·åš
var userId = User.FindFirst("userId")?.Value;
if (string.IsNullOrEmpty(userId))
    return Unauthorized(new { success = false, error = "æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯" });

// âœ… åº”è¯¥è¿™æ ·åš
var userId = GetRequiredUserId();
```

### ä¸è¦æ‰‹åŠ¨æ„å»ºå“åº”æ ¼å¼
```csharp
// âŒ ä¸è¦è¿™æ ·åš
return Ok(new { success = true, data = result });

// âœ… åº”è¯¥è¿™æ ·åš
return Success(result);
```

### ä¸è¦æ‰‹åŠ¨ try-catch
```csharp
// âŒ ä¸è¦è¿™æ ·åš
try
{
    var result = await _service.DoSomething();
    return Ok(new { success = true, data = result });
}
catch (Exception ex)
{
    return StatusCode(500, new { success = false, error = ex.Message });
}

// âœ… åº”è¯¥è¿™æ ·åšï¼ˆGlobalExceptionMiddleware ä¼šè‡ªåŠ¨å¤„ç†ï¼‰
var result = await _service.DoSomething();
return Success(result);
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [BaseApiController å®ç°](mdc:Platform.ApiService/Controllers/BaseApiController.cs)
- [å…¨å±€å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶](mdc:Platform.ApiService/Middleware/GlobalExceptionMiddleware.cs)
- [ç»Ÿä¸€æ ‡å‡†æŠ¥å‘Š](mdc:BASEAPICONTROLLER-STANDARDIZATION.md)
