---
globs: Platform.ApiService/Controllers/*.cs
description: APIæ§åˆ¶å™¨å¼€å‘è§„èŒƒ
---
# APIæ§åˆ¶å™¨å¼€å‘è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**æ‰€æœ‰æ§åˆ¶å™¨å¿…é¡»ç»§æ‰¿ `BaseApiController`ï¼Œä½¿ç”¨ç»Ÿä¸€çš„å“åº”æ ¼å¼å’Œå¼‚å¸¸å¤„ç†**

## âœ… æ§åˆ¶å™¨å®ç°è§„èŒƒ

### åŸºç¡€æ§åˆ¶å™¨ç»“æ„

```csharp
[ApiController]
[Route("api/[controller]")]
[Authorize]
public class UserController : BaseApiController
{
    private readonly IUserService _userService;
    private readonly ILogger<UserController> _logger;

    public UserController(IUserService userService, ILogger<UserController> logger)
    {
        _userService = userService;
        _logger = logger;
    }

    /// <summary>
    /// è·å–æ‰€æœ‰ç”¨æˆ·
    /// </summary>
    /// <returns>ç”¨æˆ·åˆ—è¡¨</returns>
    [HttpGet]
    public async Task<IActionResult> GetAll()
    {
        var users = await _userService.GetAllUsersAsync();
        return Success(users);
    }

    /// <summary>
    /// æ ¹æ®IDè·å–ç”¨æˆ·
    /// </summary>
    /// <param name="id">ç”¨æˆ·ID</param>
    /// <returns>ç”¨æˆ·ä¿¡æ¯</returns>
    [HttpGet("{id}")]
    public async Task<IActionResult> GetById(string id)
    {
        var user = await _userService.GetUserByIdAsync(id);
        if (user == null)
            throw new KeyNotFoundException($"ç”¨æˆ· {id} ä¸å­˜åœ¨");
        
        return Success(user);
    }

    /// <summary>
    /// åˆ›å»ºç”¨æˆ·
    /// </summary>
    /// <param name="request">åˆ›å»ºç”¨æˆ·è¯·æ±‚</param>
    /// <returns>åˆ›å»ºçš„ç”¨æˆ·ä¿¡æ¯</returns>
    [HttpPost]
    public async Task<IActionResult> Create([FromBody] CreateUserRequest request)
    {
        if (string.IsNullOrEmpty(request.Username))
            throw new ArgumentException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");
        
        var userId = GetRequiredUserId();
        var user = await _userService.CreateUserAsync(request, userId);
        
        return Success(user, "åˆ›å»ºæˆåŠŸ");
    }

    /// <summary>
    /// æ›´æ–°ç”¨æˆ·
    /// </summary>
    /// <param name="id">ç”¨æˆ·ID</param>
    /// <param name="request">æ›´æ–°ç”¨æˆ·è¯·æ±‚</param>
    /// <returns>æ›´æ–°ç»“æœ</returns>
    [HttpPut("{id}")]
    public async Task<IActionResult> Update(string id, [FromBody] UpdateUserRequest request)
    {
        request.Id = id; // ç¡®ä¿IDä¸€è‡´
        
        var success = await _userService.UpdateUserAsync(request);
        if (!success)
            throw new KeyNotFoundException($"ç”¨æˆ· {id} ä¸å­˜åœ¨");
        
        return Success("æ›´æ–°æˆåŠŸ");
    }

    /// <summary>
    /// åˆ é™¤ç”¨æˆ·
    /// </summary>
    /// <param name="id">ç”¨æˆ·ID</param>
    /// <returns>åˆ é™¤ç»“æœ</returns>
    [HttpDelete("{id}")]
    public async Task<IActionResult> Delete(string id)
    {
        var success = await _userService.DeleteUserAsync(id);
        if (!success)
            throw new KeyNotFoundException($"ç”¨æˆ· {id} ä¸å­˜åœ¨");
        
        return Success("åˆ é™¤æˆåŠŸ");
    }
}
```

### åˆ†é¡µæŸ¥è¯¢æ§åˆ¶å™¨

```csharp
[ApiController]
[Route("api/[controller]")]
[Authorize]
public class UserController : BaseApiController
{
    private readonly IUserService _userService;

    /// <summary>
    /// åˆ†é¡µè·å–ç”¨æˆ·åˆ—è¡¨
    /// </summary>
    /// <param name="request">æŸ¥è¯¢è¯·æ±‚</param>
    /// <returns>åˆ†é¡µç”¨æˆ·åˆ—è¡¨</returns>
    [HttpPost("list")]
    public async Task<IActionResult> GetList([FromBody] UserListRequest request)
    {
        var (users, total) = await _userService.GetUsersPagedAsync(request);
        
        return Success(new
        {
            Items = users,
            Total = total,
            Page = request.Page,
            PageSize = request.PageSize
        });
    }

    /// <summary>
    /// æœç´¢ç”¨æˆ·
    /// </summary>
    /// <param name="keyword">æœç´¢å…³é”®è¯</param>
    /// <param name="page">é¡µç </param>
    /// <param name="pageSize">æ¯é¡µå¤§å°</param>
    /// <returns>æœç´¢ç»“æœ</returns>
    [HttpGet("search")]
    public async Task<IActionResult> Search(
        [FromQuery] string keyword,
        [FromQuery] int page = 1,
        [FromQuery] int pageSize = 10)
    {
        var (users, total) = await _userService.SearchUsersAsync(keyword, page, pageSize);
        
        return Success(new
        {
            Items = users,
            Total = total,
            Page = page,
            PageSize = pageSize
        });
    }
}
```

### æ‰¹é‡æ“ä½œæ§åˆ¶å™¨

```csharp
[ApiController]
[Route("api/[controller]")]
[Authorize]
public class UserController : BaseApiController
{
    private readonly IUserService _userService;

    /// <summary>
    /// æ‰¹é‡åˆ›å»ºç”¨æˆ·
    /// </summary>
    /// <param name="request">æ‰¹é‡åˆ›å»ºè¯·æ±‚</param>
    /// <returns>åˆ›å»ºç»“æœ</returns>
    [HttpPost("batch")]
    public async Task<IActionResult> CreateBatch([FromBody] CreateUserBatchRequest request)
    {
        if (request.Users == null || !request.Users.Any())
            throw new ArgumentException("ç”¨æˆ·åˆ—è¡¨ä¸èƒ½ä¸ºç©º");
        
        var userId = GetRequiredUserId();
        var users = await _userService.CreateUsersBatchAsync(request.Users, userId);
        
        return Success(users, $"æˆåŠŸåˆ›å»º {users.Count} ä¸ªç”¨æˆ·");
    }

    /// <summary>
    /// æ‰¹é‡åˆ é™¤ç”¨æˆ·
    /// </summary>
    /// <param name="request">æ‰¹é‡åˆ é™¤è¯·æ±‚</param>
    /// <returns>åˆ é™¤ç»“æœ</returns>
    [HttpDelete("batch")]
    public async Task<IActionResult> DeleteBatch([FromBody] DeleteUserBatchRequest request)
    {
        if (request.UserIds == null || !request.UserIds.Any())
            throw new ArgumentException("ç”¨æˆ·IDåˆ—è¡¨ä¸èƒ½ä¸ºç©º");
        
        var count = await _userService.DeleteUsersBatchAsync(request.UserIds);
        
        return Success($"æˆåŠŸåˆ é™¤ {count} ä¸ªç”¨æˆ·");
    }

    /// <summary>
    /// æ‰¹é‡æ›´æ–°ç”¨æˆ·çŠ¶æ€
    /// </summary>
    /// <param name="request">æ‰¹é‡æ›´æ–°è¯·æ±‚</param>
    /// <returns>æ›´æ–°ç»“æœ</returns>
    [HttpPut("batch/status")]
    public async Task<IActionResult> UpdateStatusBatch([FromBody] UpdateUserStatusBatchRequest request)
    {
        if (request.UserIds == null || !request.UserIds.Any())
            throw new ArgumentException("ç”¨æˆ·IDåˆ—è¡¨ä¸èƒ½ä¸ºç©º");
        
        var count = await _userService.UpdateUsersStatusBatchAsync(request.UserIds, request.IsActive);
        
        return Success($"æˆåŠŸæ›´æ–° {count} ä¸ªç”¨æˆ·çŠ¶æ€");
    }
}
```

## ğŸ”§ BaseApiController åŠŸèƒ½

### ç”¨æˆ·ä¿¡æ¯è·å–

```csharp
// è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆå¯ä¸ºç©ºï¼‰
var userId = CurrentUserId;
var username = CurrentUsername;
var userRole = CurrentUserRole;
var companyId = CurrentCompanyId;

// è·å–å¿…éœ€çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸ºç©ºåˆ™æŠ›å¼‚å¸¸ï¼‰
var userId = GetRequiredUserId();
var companyId = GetRequiredCompanyId();
```

### ç»Ÿä¸€å“åº”æ–¹æ³•

```csharp
// æˆåŠŸå“åº”
return Success(data);                    // è¿”å›æ•°æ®
return Success(data, "æ“ä½œæˆåŠŸ");        // è¿”å›æ•°æ®å’Œæ¶ˆæ¯
return Success("æ“ä½œæˆåŠŸ");              // åªè¿”å›æ¶ˆæ¯
return SuccessResponse(data);           // ApiResponse æ ¼å¼

// é”™è¯¯å“åº”ï¼ˆå»ºè®®ç›´æ¥æŠ›å¼‚å¸¸ï¼‰
throw new ArgumentException("å‚æ•°é”™è¯¯");
throw new KeyNotFoundException("èµ„æºä¸å­˜åœ¨");
throw new UnauthorizedAccessException("æœªæˆæƒ");
throw new InvalidOperationException("æ“ä½œå¤±è´¥");
```

### æƒé™æ£€æŸ¥

```csharp
// æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
if (!IsAdmin)
    throw new UnauthorizedAccessException("éœ€è¦ç®¡ç†å‘˜æƒé™");

// æ£€æŸ¥æ˜¯å¦å·²è®¤è¯
if (!IsAuthenticated)
    throw new UnauthorizedAccessException("è¯·å…ˆç™»å½•");
```

## ğŸ¯ è¯·æ±‚/å“åº”æ¨¡å‹

### è¯·æ±‚æ¨¡å‹

```csharp
public class UserListRequest
{
    public int Page { get; set; } = 1;
    public int PageSize { get; set; } = 10;
    public string? Keyword { get; set; }
    public string? Role { get; set; }
    public bool? IsActive { get; set; }
    public DateTime? CreatedFrom { get; set; }
    public DateTime? CreatedTo { get; set; }
}

public class CreateUserBatchRequest
{
    public List<CreateUserRequest> Users { get; set; } = new();
}

public class DeleteUserBatchRequest
{
    public List<string> UserIds { get; set; } = new();
}
```

### å“åº”æ¨¡å‹

```csharp
public class UserListResponse
{
    public List<UserResponse> Items { get; set; } = new();
    public long Total { get; set; }
    public int Page { get; set; }
    public int PageSize { get; set; }
}

public class BatchOperationResponse
{
    public int SuccessCount { get; set; }
    public int FailureCount { get; set; }
    public List<string> Errors { get; set; } = new();
}
```

## ğŸš« ç¦æ­¢çš„åšæ³•

### ä¸è¦ç›´æ¥ç»§æ‰¿ ControllerBase

```csharp
// âŒ ç¦æ­¢
[ApiController]
[Route("api/[controller]")]
public class UserController : ControllerBase  // âŒ ç¦æ­¢ç›´æ¥ç»§æ‰¿ ControllerBase
{
    // ...
}
```

### ä¸è¦æ‰‹åŠ¨æ„å»ºå“åº”æ ¼å¼

```csharp
// âŒ ä¸è¦è¿™æ ·åš
return Ok(new { success = true, data = result });
return BadRequest(new { success = false, error = "é”™è¯¯ä¿¡æ¯" });

// âœ… åº”è¯¥è¿™æ ·åš
return Success(result);
throw new ArgumentException("é”™è¯¯ä¿¡æ¯");
```

### ä¸è¦æ‰‹åŠ¨æå–ç”¨æˆ·ä¿¡æ¯

```csharp
// âŒ ä¸è¦è¿™æ ·åš
var userId = User.FindFirst("userId")?.Value;
if (string.IsNullOrEmpty(userId))
    return Unauthorized(new { success = false, error = "æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯" });

// âœ… åº”è¯¥è¿™æ ·åš
var userId = GetRequiredUserId();
```

### ä¸è¦ä½¿ç”¨ try-catch

```csharp
// âŒ ä¸è¦è¿™æ ·åš
try
{
    var result = await _service.DoSomething();
    return Ok(new { success = true, data = result });
}
catch (Exception ex)
{
    return StatusCode(500, new { success = false, error = ex.Message });
}

// âœ… åº”è¯¥è¿™æ ·åšï¼ˆGlobalExceptionMiddleware ä¼šè‡ªåŠ¨å¤„ç†ï¼‰
var result = await _service.DoSomething();
return Success(result);
```

## ğŸ“‹ æ§åˆ¶å™¨å¼€å‘æ£€æŸ¥æ¸…å•

åˆ›å»ºæˆ–ä¿®æ”¹æ§åˆ¶å™¨æ—¶æ£€æŸ¥ï¼š

- [ ] ç»§æ‰¿ BaseApiController
- [ ] æ·»åŠ é€‚å½“çš„ HTTP æ–¹æ³•ç‰¹æ€§
- [ ] æ·»åŠ  XML æ–‡æ¡£æ³¨é‡Š
- [ ] ä½¿ç”¨ç»Ÿä¸€çš„å“åº”æ ¼å¼
- [ ] æ·»åŠ å‚æ•°éªŒè¯
- [ ] ä½¿ç”¨ GetRequiredUserId() è·å–ç”¨æˆ·ä¿¡æ¯
- [ ] æ·»åŠ é€‚å½“çš„æˆæƒç‰¹æ€§
- [ ] éµå¾ª RESTful è®¾è®¡åŸåˆ™
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•
- [ ] æ›´æ–° API æ–‡æ¡£

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [BaseApiController å®ç°](mdc:Platform.ApiService/Controllers/BaseApiController.cs)
- [å…¨å±€å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶](mdc:Platform.ApiService/Middleware/GlobalExceptionMiddleware.cs)
- [æœåŠ¡å±‚å¼€å‘è§„èŒƒ](mdc:.cursor/rules/service-layer.mdc)
