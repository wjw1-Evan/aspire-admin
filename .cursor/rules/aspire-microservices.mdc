---
globs: Platform.AppHost/*.cs,Platform.ApiService/Program.cs,Platform.DataInitializer/Program.cs
description: .NET Aspire å¾®æœåŠ¡æ¶æ„å’Œç¼–æ’è§„èŒƒ
---
# .NET Aspire å¾®æœåŠ¡æ¶æ„ä¸ç¼–æ’è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

- ç»Ÿä¸€é€šè¿‡ .NET Aspire ç¼–æ’æ‰€æœ‰æœåŠ¡ï¼Œé›†ä¸­å¤„ç†ä¾èµ–ã€æœåŠ¡å‘ç°ã€é…ç½®å’Œç›‘æ§
- OpenAI â†’ MongoDB â†’ DataInitializer â†’ ApiService â†’ å‰ç«¯/ç§»åŠ¨ç«¯çš„ä¾èµ–é“¾å¿…é¡»å®Œæ•´ï¼Œç¦ç”¨ç»•è¿‡
- YARP ä½œä¸ºç»Ÿä¸€ç½‘å…³å…¥å£ï¼Œç¦æ­¢å‰ç«¯ç¡¬ç¼–ç åç«¯åœ°å€

## âœ… AppHost å…³é”®é…ç½®è¦ç‚¹

```csharp
// Platform.AppHost/AppHost.csï¼ˆæ ¸å¿ƒéª¨æ¶ï¼‰
var builder = DistributedApplication.CreateBuilder(args);

// 1. æ·»åŠ  OpenAI æœåŠ¡ï¼ˆAI èƒ½åŠ›ï¼‰
var openai = builder.AddOpenAI("openai")
    .WithEndpoint(openAiEndpoint);
var chat = openai.AddModel("chat", "gpt-4o-mini");

// 2. æ·»åŠ  MongoDB æ•°æ®åº“
var mongo = builder.AddMongoDB("mongo")
    .WithMongoExpress()
    .WithLifetime(ContainerLifetime.Persistent)
    .WithDataVolume();
var mongodb = mongo.AddDatabase("mongodb", "aspire-admin-db");

// 3. æ·»åŠ æ•°æ®åˆå§‹åŒ–å¾®æœåŠ¡ï¼ˆä¸€æ¬¡æ€§ä»»åŠ¡ï¼Œå®Œæˆåè‡ªåŠ¨åœæ­¢ï¼‰
var datainitializer = builder.AddProject<Projects.Platform_DataInitializer>("datainitializer")
    .WaitFor(mongodb)
    .WithReference(mongodb)
    .WithHttpEndpoint();

// 4. æ·»åŠ  API æœåŠ¡ï¼ˆä¾èµ–æ•°æ®åˆå§‹åŒ–æœåŠ¡å’Œ OpenAIï¼‰
var apiservice = builder.AddProject<Projects.Platform_ApiService>("apiservice")
    .WithReference(mongodb)
    .WaitForCompletion(datainitializer)
    .WithReference(chat)
    .WithHttpEndpoint()
    .WithReplicas(1)
    .WithHttpHealthCheck("/health")
    .WithEnvironment("Jwt__SecretKey", jwtSecretKey);

// 5. é…ç½® YARP ç½‘å…³
var yarp = builder.AddYarp("apigateway")
    .WithHostPort(15000)
    .WithConfiguration(config =>
        config.AddRoute("/apiservice/{**catch-all}", config.AddCluster(apiservice))
              .WithTransformPathRouteValues("/{**catch-all}"));

// 6. æ·»åŠ å‰ç«¯åº”ç”¨
builder.AddNpmApp("admin", "../Platform.Admin")
    .WithReference(yarp)
    .WaitFor(yarp)
    .WithHttpEndpoint(env: "PORT", port: 15001, targetPort: 8080);

builder.AddNpmApp("app", "../Platform.App")
    .WithReference(yarp)
    .WaitFor(yarp)
    .WithHttpEndpoint(env: "PORT", port: 15002, targetPort: 8081);

// 7. é…ç½® Scalar API æ–‡æ¡£ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
if (builder.Environment.IsDevelopment())
{
    var scalar = builder.AddScalarApiReference();
    scalar.WithApiReference(apiservice);
}

builder.Build().Run();
```

> ğŸ“Œ æç¤ºï¼šå¦‚éœ€æ‰©å®¹ï¼Œå¯å¯¹ `datainitializer` ä¿æŒå•å®ä¾‹ï¼Œå¯¹ `apiservice` è°ƒæ•´ `WithReplicas(n)`ã€‚

## âš™ï¸ å¾®æœåŠ¡ Program.cs æœ€å°æ¸…å•

### ApiService

```csharp
var builder = WebApplication.CreateBuilder(args);
builder.AddServiceDefaults();
builder.Services
    .AddMongoDb(builder.Configuration)
    .AddBusinessServices()
    .AddJwtAuthentication(builder.Configuration)
    .AddMiddlewareServices();

var app = builder.Build();
app.ConfigureMiddlewarePipeline();
app.Run();
```

### DataInitializer

```csharp
var builder = WebApplication.CreateBuilder(args);
builder.AddServiceDefaults();
builder.Services
    .AddMongoDb(builder.Configuration)
    .AddScoped<IDataInitializerService, DataInitializerService>();

var app = builder.Build();
app.ConfigureDataInitialization();
app.Run();
```

## ğŸŒ æœåŠ¡å‘ç°ã€é…ç½®ä¸ç›‘æ§

- `AddServiceDiscovery()`ï¼šç»Ÿä¸€ HttpClient é…ç½®ï¼Œè‡ªåŠ¨æ³¨å…¥æœåŠ¡å‘ç°ä¸éŸ§æ€§ç­–ç•¥
- `AddConfigurationManagement()`ï¼šç»‘å®š `JwtSettings`ã€`MongoDbSettings`ã€`AppSettings`ï¼Œå¹¶æ ¹æ®ç¯å¢ƒåŠ è½½ UserSecrets/Azure Key Vault
- `AddMonitoring()`ï¼šå¯ç”¨ OpenTelemetryï¼ˆTracing + Metricsï¼‰ï¼ŒåŒæ—¶é€šè¿‡ `AddLogging()` è¾“å‡º Console/Debug/EventSource
- å¥åº·æ£€æŸ¥ï¼šåŠ¡å¿…æ³¨å†Œ `MongoDbHealthCheck`ã€`ApiServiceHealthCheck`ã€`DataInitializerHealthCheck`ï¼Œå¹¶æš´éœ² `/health`

## ğŸš€ éƒ¨ç½²ä¸ç¯å¢ƒç­–ç•¥

- å¼€å‘ã€ç”Ÿäº§å…±ç”¨åŒä¸€å¥—éª¨æ¶ï¼Œå·®å¼‚ä»…åœ¨å‰¯æœ¬æ•°åŠå¤–éƒ¨æœåŠ¡é…ç½®
- DataInitializer å§‹ç»ˆå•å®ä¾‹è¿è¡Œï¼›ApiService å¯æŒ‰ç¯å¢ƒæ‰©å®¹
- æ‰€æœ‰å‰ç«¯åº”ç”¨é€šè¿‡ YARP è®¿é—®åç«¯ï¼Œé¿å…ç›´è¿ ApiService

## ğŸš« ç¦æ­¢äº‹é¡¹

- **ç¡¬ç¼–ç æœåŠ¡åœ°å€**ï¼šç¦æ­¢åœ¨ä»»ä½•å®¢æˆ·ç«¯è®¾ç½®å›ºå®š BaseAddressï¼Œå¿…é¡»ä¾èµ–æœåŠ¡å‘ç°
- **è·³è¿‡ä¾èµ–é“¾**ï¼šApiService å¿…é¡»å¼•ç”¨ DataInitializerï¼Œä¿è¯ç´¢å¼•/æ•°æ®å…ˆå®Œæˆ
- **å¿½ç•¥å¥åº·æ£€æŸ¥**ï¼šæ‰€æœ‰æœåŠ¡éƒ½è¦æš´éœ² `/health`ï¼Œå¹¶åœ¨ AppHost ä¸­å£°æ˜ `WithHttpHealthCheck`

## âœ… å¼€å‘æ£€æŸ¥æ¸…å•

- [ ] AppHost ä¸­æœåŠ¡å¼•ç”¨ã€ä¾èµ–ã€å¥åº·æ£€æŸ¥é½å…¨ï¼ˆåŒ…æ‹¬ OpenAIã€MongoDBã€DataInitializerã€ApiServiceï¼‰
- [ ] å¼€å‘ç¯å¢ƒå·²é…ç½® Scalar API æ–‡æ¡£
- [ ] JWT å¯†é’¥é€šè¿‡ç¯å¢ƒå˜é‡æ­£ç¡®ä¼ é€’
- [ ] Program.cs ä»…ä¿ç•™å¿…è¦çš„æœåŠ¡æ³¨å†Œï¼Œé€»è¾‘ç§»è‡³æ‰©å±•æ–¹æ³•
- [ ] æ–°å¢ HttpClient å‡é€šè¿‡ `AddServiceDiscovery()` è·å¾—åœ°å€
- [ ] å…³é”®æœåŠ¡æ¥å…¥å¥åº·æ£€æŸ¥ä¸ OpenTelemetry
- [ ] ä¸åŒç¯å¢ƒçš„é…ç½®æ¥æºæ˜ç¡®ï¼ˆJsonã€UserSecretsã€KeyVaultï¼‰
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–å…³é”®æœåŠ¡çš„å¯åŠ¨ä¸ä¾èµ–

## ğŸ“š å‚è€ƒèµ„æº

- [åº”ç”¨ä¸»æœºé…ç½®](mdc:Platform.AppHost/AppHost.cs)
- [API æœåŠ¡é…ç½®](mdc:Platform.ApiService/Program.cs)
- [æ•°æ®åˆå§‹åŒ–æœåŠ¡é…ç½®](mdc:Platform.DataInitializer/Program.cs)
- [.NET Aspire å®˜æ–¹æ–‡æ¡£](https://learn.microsoft.com/en-us/dotnet/aspire/)
