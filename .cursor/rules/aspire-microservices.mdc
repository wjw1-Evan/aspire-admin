---
description: .NET Aspire å¾®æœåŠ¡æ¶æ„å’Œç¼–æ’è§„èŒƒ
globs: *.cs,*.json
---

# .NET Aspire å¾®æœåŠ¡æ¶æ„å’Œç¼–æ’è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**ä½¿ç”¨ .NET Aspire å®ç°ç°ä»£åŒ–çš„å¾®æœåŠ¡æ¶æ„ï¼Œé€šè¿‡æœåŠ¡ç¼–æ’å®ç°æ¾è€¦åˆã€é«˜å¯ç”¨çš„ç³»ç»Ÿ**

## ğŸ—ï¸ Aspire åº”ç”¨ä¸»æœºæ¶æ„

### AppHost é…ç½®è§„èŒƒ
```csharp
// âœ… æ­£ç¡®ï¼šAppHost.cs æ ‡å‡†é…ç½®
var builder = DistributedApplication.CreateBuilder(args);

// 1. åŸºç¡€è®¾æ–½æœåŠ¡
var mongo = builder.AddMongoDB("mongo")
    .WithMongoExpress()
    .WithLifetime(ContainerLifetime.Persistent);
var mongodb = mongo.AddDatabase("mongodb");

// 2. å¾®æœåŠ¡å®šä¹‰
var datainitializer = builder.AddProject<Projects.Platform_DataInitializer>("datainitializer")
    .WithReference(mongodb)
    .WithHttpEndpoint()
    .WithHttpHealthCheck("/health");

var apiservice = builder.AddProject<Projects.Platform_ApiService>("apiservice")
    .WithReference(mongodb)
    .WithReference(datainitializer)
    .WithHttpHealthCheck("/health");

// 3. API ç½‘å…³é…ç½®
var yarp = builder.AddYarp("apigateway")
    .WithHostPort(15000)
    .WithConfiguration(config => {
        config.AddRoute("/{service}/{**catch-all}", config.AddCluster(apiservice))
            .WithTransformPathRouteValues("/api/{**catch-all}");
    });

// 4. å‰ç«¯åº”ç”¨
builder.AddNpmApp("admin", "../Platform.Admin")
    .WithReference(yarp)
    .WaitFor(yarp)
    .WithHttpEndpoint(env: "PORT", port: 15001);

builder.AddNpmApp("app", "../Platform.App")
    .WithReference(yarp)
    .WaitFor(yarp)
    .WithHttpEndpoint(env: "PORT", port: 15002);

var app = builder.Build();
await app.RunAsync();
```

### æœåŠ¡ä¾èµ–ç®¡ç†
```csharp
// âœ… æ­£ç¡®ï¼šæœåŠ¡ä¾èµ–é¡ºåº
// MongoDB â†’ DataInitializer â†’ ApiService â†’ Frontend Apps

// âœ… æ­£ç¡®ï¼šå¥åº·æ£€æŸ¥é…ç½®
.WithHttpHealthCheck("/health", healthCheck =>
{
    healthCheck.UsePath("/health");
    healthCheck.UseMethod(HttpMethod.Get);
})

// âœ… æ­£ç¡®ï¼šæœåŠ¡å‘ç°é…ç½®
.WithReference(service, reference =>
{
    reference.WithHttpEndpoint();
    reference.WithEnvironment("SERVICE_URL", service.GetEndpoint("http"));
})
```

## ğŸ”§ å¾®æœåŠ¡è®¾è®¡æ¨¡å¼

### ä»»åŠ¡å‹å¾®æœåŠ¡æ¨¡å¼
```csharp
// âœ… æ­£ç¡®ï¼šæ•°æ®åˆå§‹åŒ–å¾®æœåŠ¡å®ç°
public class DataInitializerService : IDataInitializerService
{
    private readonly IMongoDatabase _database;
    private readonly ILogger<DataInitializerService> _logger;

    public async Task InitializeAsync()
    {
        try
        {
            _logger.LogInformation("å¼€å§‹æ•°æ®åˆå§‹åŒ–...");
            
            // 1. åˆ›å»ºæ•°æ®åº“ç´¢å¼•
            await CreateIndexesAsync();
            
            // 2. åˆ›å»ºç³»ç»Ÿèœå•
            await CreateSystemMenusAsync();
            
            _logger.LogInformation("æ•°æ®åˆå§‹åŒ–å®Œæˆ");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "æ•°æ®åˆå§‹åŒ–å¤±è´¥");
            throw;
        }
    }

    public async Task<bool> IsInitializedAsync()
    {
        var menus = _database.GetCollection<Menu>("menus");
        var count = await menus.CountDocumentsAsync(FilterDefinition<Menu>.Empty);
        return count > 0;
    }
}
```

### æœåŠ¡é—´é€šä¿¡
```csharp
// âœ… æ­£ç¡®ï¼šæœåŠ¡é—´ HTTP è°ƒç”¨
public class ApiServiceHealthCheck : IHealthCheck
{
    private readonly HttpClient _httpClient;

    public async Task<HealthCheckResult> CheckHealthAsync(
        HealthCheckContext context, 
        CancellationToken cancellationToken = default)
    {
        try
        {
            var response = await _httpClient.GetAsync("/health", cancellationToken);
            return response.IsSuccessStatusCode 
                ? HealthCheckResult.Healthy("API service is healthy")
                : HealthCheckResult.Unhealthy("API service is unhealthy");
        }
        catch (Exception ex)
        {
            return HealthCheckResult.Unhealthy("API service check failed", ex);
        }
    }
}

// âœ… æ­£ç¡®ï¼šæœåŠ¡å‘ç°å’Œé…ç½®
public class ServiceConfiguration
{
    public static void ConfigureServices(IServiceCollection services, IConfiguration configuration)
    {
        // æœåŠ¡å‘ç°
        services.AddHttpClient<IDataInitializerClient, DataInitializerClient>(client =>
        {
            var serviceUrl = configuration["Services:DataInitializer:Url"];
            client.BaseAddress = new Uri(serviceUrl);
        });

        // å¥åº·æ£€æŸ¥
        services.AddHealthChecks()
            .AddCheck<ApiServiceHealthCheck>("api-service")
            .AddMongoDb(configuration.GetConnectionString("mongodb"));
    }
}
```

## ğŸ“Š ç›‘æ§å’Œå¯è§‚æµ‹æ€§

### åˆ†å¸ƒå¼è¿½è¸ª
```csharp
// âœ… æ­£ç¡®ï¼šOpenTelemetry é…ç½®
public static class TelemetryConfiguration
{
    public static void ConfigureTelemetry(IServiceCollection services)
    {
        services.AddOpenTelemetry()
            .WithTracing(tracing =>
            {
                tracing
                    .AddAspNetCoreInstrumentation()
                    .AddHttpClientInstrumentation()
                    .AddMongoDBInstrumentation()
                    .AddJaegerExporter();
            })
            .WithMetrics(metrics =>
            {
                metrics
                    .AddAspNetCoreInstrumentation()
                    .AddHttpClientInstrumentation()
                    .AddPrometheusExporter();
            });
    }
}

// âœ… æ­£ç¡®ï¼šè‡ªå®šä¹‰æ´»åŠ¨è¿½è¸ª
public class UserService
{
    private static readonly ActivitySource ActivitySource = new("Platform.UserService");

    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        using var activity = ActivitySource.StartActivity("CreateUser");
        activity?.SetTag("user.email", request.Email);
        activity?.SetTag("user.company", request.CompanyId);

        try
        {
            var user = await ProcessUserCreationAsync(request);
            activity?.SetStatus(ActivityStatusCode.Ok);
            return user;
        }
        catch (Exception ex)
        {
            activity?.SetStatus(ActivityStatusCode.Error, ex.Message);
            throw;
        }
    }
}
```

### æ—¥å¿—èšåˆ
```csharp
// âœ… æ­£ç¡®ï¼šç»“æ„åŒ–æ—¥å¿—é…ç½®
public static class LoggingConfiguration
{
    public static void ConfigureLogging(IServiceCollection services, IConfiguration configuration)
    {
        services.AddLogging(builder =>
        {
            builder.AddConsole(options =>
            {
                options.FormatterName = "json";
            });
            
            builder.AddSeq(configuration.GetConnectionString("seq"));
            
            builder.AddFilter("Microsoft.AspNetCore", LogLevel.Warning);
            builder.AddFilter("System.Net.Http.HttpClient", LogLevel.Warning);
        });
    }
}

// âœ… æ­£ç¡®ï¼šç»“æ„åŒ–æ—¥å¿—ä½¿ç”¨
public class OrderService
{
    private readonly ILogger<OrderService> _logger;

    public async Task<Order> ProcessOrderAsync(OrderRequest request)
    {
        using var scope = _logger.BeginScope(new Dictionary<string, object>
        {
            ["OrderId"] = request.OrderId,
            ["UserId"] = request.UserId,
            ["CompanyId"] = request.CompanyId
        });

        _logger.LogInformation("å¼€å§‹å¤„ç†è®¢å• {OrderId}", request.OrderId);

        try
        {
            var order = await CreateOrderAsync(request);
            _logger.LogInformation("è®¢å•å¤„ç†æˆåŠŸ {OrderId}", order.Id);
            return order;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "è®¢å•å¤„ç†å¤±è´¥ {OrderId}", request.OrderId);
            throw;
        }
    }
}
```

## ğŸ”„ æœåŠ¡ç¼–æ’å’Œç”Ÿå‘½å‘¨æœŸ

### æœåŠ¡å¯åŠ¨é¡ºåº
```csharp
// âœ… æ­£ç¡®ï¼šæœåŠ¡ä¾èµ–å’Œå¯åŠ¨é¡ºåº
public class ServiceOrchestration
{
    public static void ConfigureServiceDependencies(IServiceCollection services)
    {
        // 1. åŸºç¡€è®¾æ–½æœåŠ¡ï¼ˆMongoDBï¼‰
        services.AddSingleton<IMongoDatabase>(provider =>
        {
            var connectionString = provider.GetRequiredService<IConfiguration>()
                .GetConnectionString("mongodb");
            var client = new MongoClient(connectionString);
            return client.GetDatabase("aspire-admin");
        });

        // 2. æ•°æ®åˆå§‹åŒ–æœåŠ¡
        services.AddScoped<IDataInitializerService, DataInitializerService>();

        // 3. ä¸šåŠ¡æœåŠ¡ï¼ˆä¾èµ–æ•°æ®åˆå§‹åŒ–ï¼‰
        services.AddScoped<IUserService, UserService>();
        services.AddScoped<IMenuService, MenuService>();
        services.AddScoped<IRoleService, RoleService>();
    }
}
```

### ä¼˜é›…å…³é—­
```csharp
// âœ… æ­£ç¡®ï¼šä¼˜é›…å…³é—­å¤„ç†
public class GracefulShutdownService : IHostedService
{
    private readonly ILogger<GracefulShutdownService> _logger;
    private readonly IHostApplicationLifetime _lifetime;

    public async Task StartAsync(CancellationToken cancellationToken)
    {
        _lifetime.ApplicationStopping.Register(OnStopping);
        _lifetime.ApplicationStopped.Register(OnStopped);
    }

    private void OnStopping()
    {
        _logger.LogInformation("æœåŠ¡æ­£åœ¨åœæ­¢...");
        
        // åœæ­¢æ¥æ”¶æ–°è¯·æ±‚
        // ç­‰å¾…ç°æœ‰è¯·æ±‚å®Œæˆ
        // æ¸…ç†èµ„æº
    }

    private void OnStopped()
    {
        _logger.LogInformation("æœåŠ¡å·²åœæ­¢");
    }

    public Task StopAsync(CancellationToken cancellationToken)
    {
        return Task.CompletedTask;
    }
}
```

## ğŸŒ é…ç½®ç®¡ç†

### ç¯å¢ƒé…ç½®
```json
// âœ… æ­£ç¡®ï¼šappsettings.json é…ç½®
{
  "ConnectionStrings": {
    "mongodb": "mongodb://localhost:27017"
  },
  "Services": {
    "DataInitializer": {
      "Url": "http://localhost:15000/datainitializer",
      "Timeout": "00:01:00"
    },
    "ApiService": {
      "Url": "http://localhost:15000/apiservice",
      "Timeout": "00:00:30"
    }
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Platform": "Debug"
    }
  },
  "HealthChecks": {
    "Enabled": true,
    "Interval": "00:00:30"
  }
}
```

### é…ç½®æ³¨å…¥
```csharp
// âœ… æ­£ç¡®ï¼šé…ç½®é€‰é¡¹æ¨¡å¼
public class ServiceOptions
{
    public const string SectionName = "Services";
    
    public string DataInitializerUrl { get; set; } = string.Empty;
    public TimeSpan Timeout { get; set; } = TimeSpan.FromSeconds(30);
    public int RetryCount { get; set; } = 3;
}

public static class ServiceConfiguration
{
    public static void ConfigureServices(IServiceCollection services, IConfiguration configuration)
    {
        services.Configure<ServiceOptions>(
            configuration.GetSection(ServiceOptions.SectionName));
            
        services.AddHttpClient<IDataInitializerClient, DataInitializerClient>((serviceProvider, client) =>
        {
            var options = serviceProvider.GetRequiredService<IOptions<ServiceOptions>>().Value;
            client.BaseAddress = new Uri(options.DataInitializerUrl);
            client.Timeout = options.Timeout;
        });
    }
}
```

## ğŸš€ éƒ¨ç½²å’Œæ‰©å±•

### Docker é…ç½®
```dockerfile
# âœ… æ­£ç¡®ï¼šå¤šé˜¶æ®µæ„å»º
FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS base
WORKDIR /app
EXPOSE 8080

FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /src
COPY ["Platform.ApiService/Platform.ApiService.csproj", "Platform.ApiService/"]
RUN dotnet restore "Platform.ApiService/Platform.ApiService.csproj"
COPY . .
WORKDIR "/src/Platform.ApiService"
RUN dotnet build "Platform.ApiService.csproj" -c Release -o /app/build

FROM build AS publish
RUN dotnet publish "Platform.ApiService.csproj" -c Release -o /app/publish

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
ENTRYPOINT ["dotnet", "Platform.ApiService.dll"]
```

### Kubernetes éƒ¨ç½²
```yaml
# âœ… æ­£ç¡®ï¼šKubernetes éƒ¨ç½²é…ç½®
apiVersion: apps/v1
kind: Deployment
metadata:
  name: platform-apiservice
spec:
  replicas: 3
  selector:
    matchLabels:
      app: platform-apiservice
  template:
    metadata:
      labels:
        app: platform-apiservice
    spec:
      containers:
      - name: apiservice
        image: platform/apiservice:latest
        ports:
        - containerPort: 8080
        env:
        - name: ConnectionStrings__mongodb
          valueFrom:
            secretKeyRef:
              name: mongodb-secret
              key: connection-string
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health/ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
```

## ğŸ“‹ å¾®æœåŠ¡å¼€å‘æ£€æŸ¥æ¸…å•

### æœåŠ¡è®¾è®¡
- [ ] å•ä¸€èŒè´£åŸåˆ™
- [ ] æ¾è€¦åˆè®¾è®¡
- [ ] æ— çŠ¶æ€æœåŠ¡
- [ ] å¹‚ç­‰æ€§æ“ä½œ
- [ ] ä¼˜é›…é™çº§

### é€šä¿¡åè®®
- [ ] HTTP/REST API
- [ ] å¼‚æ­¥æ¶ˆæ¯ä¼ é€’
- [ ] æœåŠ¡å‘ç°
- [ ] è´Ÿè½½å‡è¡¡
- [ ] ç†”æ–­å™¨æ¨¡å¼

### æ•°æ®ç®¡ç†
- [ ] æ•°æ®åº“åˆ†ç¦»
- [ ] äº‹åŠ¡è¾¹ç•Œ
- [ ] æ•°æ®ä¸€è‡´æ€§
- [ ] ç¼“å­˜ç­–ç•¥
- [ ] æ•°æ®è¿ç§»

### ç›‘æ§è¿ç»´
- [ ] å¥åº·æ£€æŸ¥
- [ ] æŒ‡æ ‡æ”¶é›†
- [ ] æ—¥å¿—èšåˆ
- [ ] åˆ†å¸ƒå¼è¿½è¸ª
- [ ] å‘Šè­¦æœºåˆ¶

## ğŸ“š ç›¸å…³èµ„æº

- [.NET Aspire å®˜æ–¹æ–‡æ¡£](https://learn.microsoft.com/aspnet/core/aspire/)
- [å¾®æœåŠ¡æ¶æ„æ¨¡å¼](https://microservices.io/)
- [OpenTelemetry æ–‡æ¡£](https://opentelemetry.io/docs/)
- [Kubernetes æœ€ä½³å®è·µ](https://kubernetes.io/docs/concepts/)

## ğŸ¯ è®°ä½

**å¾®æœåŠ¡æ¶æ„çš„æ ¸å¿ƒæ˜¯æœåŠ¡ç¼–æ’å’Œå¯è§‚æµ‹æ€§**

- ä½¿ç”¨ Aspire ç®€åŒ–å¾®æœåŠ¡å¼€å‘
- é‡è§†æœåŠ¡é—´çš„ä¾èµ–å…³ç³»
- å®ç°å®Œæ•´çš„ç›‘æ§å’Œæ—¥å¿—
- è®¾è®¡å¯æ‰©å±•çš„æœåŠ¡æ¶æ„
- ä¿æŒæœåŠ¡çš„ç‹¬ç«‹æ€§å’Œå¯æµ‹è¯•æ€§