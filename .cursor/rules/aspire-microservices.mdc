---
globs: Platform.AppHost/*.cs,Platform.ApiService/Program.cs,Platform.DataInitializer/Program.cs
description: .NET Aspire å¾®æœåŠ¡æ¶æ„å’Œç¼–æ’è§„èŒƒ
---
# .NET Aspire å¾®æœåŠ¡æ¶æ„å’Œç¼–æ’è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

### ä½¿ç”¨ .NET Aspire å®ç°å¾®æœåŠ¡ç¼–æ’ï¼Œæä¾›ç»Ÿä¸€çš„æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’Œç›‘æ§

## âœ… Aspire åº”ç”¨ä¸»æœºé…ç½®

### åº”ç”¨ä¸»æœºé…ç½®

```csharp
// Platform.AppHost/AppHost.cs
var builder = DistributedApplication.CreateBuilder(args);

// 1. æ·»åŠ  MongoDB æ•°æ®åº“
var mongo = builder.AddMongoDB("mongo")
    .WithMongoExpress()
    .WithLifetime(ContainerLifetime.Persistent);
var mongodb = mongo.AddDatabase("mongodb");

// 2. æ·»åŠ æ•°æ®åˆå§‹åŒ–å¾®æœåŠ¡
var datainitializer = builder.AddProject<Projects.Platform_DataInitializer>("datainitializer")
    .WithReference(mongodb)
    .WithHttpEndpoint()
    .WithHttpHealthCheck("/health");

// 3. æ·»åŠ  API æœåŠ¡ï¼ˆä¾èµ–æ•°æ®åˆå§‹åŒ–æœåŠ¡ï¼‰
var apiservice = builder.AddProject<Projects.Platform_ApiService>("apiservice")
    .WithReference(mongodb)
    .WithReference(datainitializer)
    .WithHttpHealthCheck("/health");

// 4. é…ç½® YARP ç½‘å…³
var yarp = builder.AddYarp("apigateway")
    .WithHostPort(15000)
    .WithConfiguration(config => {
        // è‡ªåŠ¨è·¯ç”±é…ç½®
        config.AddRoute("/{service}/{**catch-all}", config.AddCluster(apiservice))
            .WithTransformPathRouteValues("/{**catch-all}");
    });

// 5. æ·»åŠ å‰ç«¯åº”ç”¨
builder.AddNpmApp("admin", "../Platform.Admin")
    .WithReference(yarp)
    .WaitFor(yarp)
    .WithHttpEndpoint(env: "PORT", port: 15001);

builder.AddNpmApp("app", "../Platform.App")
    .WithReference(yarp)
    .WaitFor(yarp)
    .WithHttpEndpoint(env: "PORT", port: 15002);

// 6. æ„å»ºåº”ç”¨
var app = builder.Build();
app.Run();
```

### æœåŠ¡ä¾èµ–å…³ç³»

```csharp
// Platform.AppHost/AppHost.cs
public static void ConfigureServiceDependencies(DistributedApplicationBuilder builder)
{
    // æ•°æ®åº“æœåŠ¡
    var mongo = builder.AddMongoDB("mongo")
        .WithMongoExpress()
        .WithLifetime(ContainerLifetime.Persistent);
    var mongodb = mongo.AddDatabase("mongodb");

    // å¾®æœåŠ¡ä¾èµ–é“¾
    var datainitializer = builder.AddProject<Projects.Platform_DataInitializer>("datainitializer")
        .WithReference(mongodb)
        .WithHttpEndpoint()
        .WithHttpHealthCheck("/health");

    var apiservice = builder.AddProject<Projects.Platform_ApiService>("apiservice")
        .WithReference(mongodb)
        .WithReference(datainitializer)
        .WithHttpHealthCheck("/health");

    // ç½‘å…³é…ç½®
    var yarp = builder.AddYarp("apigateway")
        .WithHostPort(15000)
        .WithConfiguration(config => {
            config.AddRoute("/{service}/{**catch-all}", config.AddCluster(apiservice))
                .WithTransformPathRouteValues("/{**catch-all}");
        });

    // å‰ç«¯åº”ç”¨
    builder.AddNpmApp("admin", "../Platform.Admin")
        .WithReference(yarp)
        .WaitFor(yarp)
        .WithHttpEndpoint(env: "PORT", port: 15001);

    builder.AddNpmApp("app", "../Platform.App")
        .WithReference(yarp)
        .WaitFor(yarp)
        .WithHttpEndpoint(env: "PORT", port: 15002);
}
```

## ğŸ¯ å¾®æœåŠ¡é…ç½®

### API æœåŠ¡é…ç½®

```csharp
// Platform.ApiService/Program.cs
var builder = WebApplication.CreateBuilder(args);

// 1. æ·»åŠ  Aspire æœåŠ¡
builder.AddServiceDefaults();

// 2. æ·»åŠ æ•°æ®åº“æœåŠ¡
builder.Services.AddMongoDb(builder.Configuration);

// 3. æ·»åŠ ä¸šåŠ¡æœåŠ¡
builder.Services.AddBusinessServices();

// 4. æ·»åŠ è®¤è¯æœåŠ¡
builder.Services.AddJwtAuthentication(builder.Configuration);

// 5. æ·»åŠ ä¸­é—´ä»¶
builder.Services.AddMiddlewareServices();

// 6. æ„å»ºåº”ç”¨
var app = builder.Build();

// 7. é…ç½®ä¸­é—´ä»¶ç®¡é“
app.ConfigureMiddlewarePipeline();

// 8. è¿è¡Œåº”ç”¨
app.Run();
```

### æ•°æ®åˆå§‹åŒ–æœåŠ¡é…ç½®

```csharp
// Platform.DataInitializer/Program.cs
var builder = WebApplication.CreateBuilder(args);

// 1. æ·»åŠ  Aspire æœåŠ¡
builder.AddServiceDefaults();

// 2. æ·»åŠ æ•°æ®åº“æœåŠ¡
builder.Services.AddMongoDb(builder.Configuration);

// 3. æ·»åŠ æ•°æ®åˆå§‹åŒ–æœåŠ¡
builder.Services.AddScoped<IDataInitializerService, DataInitializerService>();

// 4. æ„å»ºåº”ç”¨
var app = builder.Build();

// 5. é…ç½®æ•°æ®åˆå§‹åŒ–
app.ConfigureDataInitialization();

// 6. è¿è¡Œåº”ç”¨
app.Run();
```

## ğŸ¯ æœåŠ¡å‘ç°å’Œé…ç½®

### æœåŠ¡å‘ç°é…ç½®

```csharp
// Platform.ServiceDefaults/Extensions/ServiceDiscoveryExtensions.cs
public static class ServiceDiscoveryExtensions
{
    /// <summary>
    /// æ·»åŠ æœåŠ¡å‘ç°é…ç½®
    /// </summary>
    public static IServiceCollection AddServiceDiscovery(this IServiceCollection services)
    {
        services.AddServiceDiscovery();
        services.ConfigureHttpClientDefaults(httpClientBuilder =>
        {
            httpClientBuilder.AddStandardResilienceHandler();
            httpClientBuilder.AddServiceDiscovery();
        });
        
        return services;
    }

    /// <summary>
    /// æ·»åŠ å¥åº·æ£€æŸ¥
    /// </summary>
    public static IServiceCollection AddHealthChecks(this IServiceCollection services)
    {
        services.AddHealthChecks()
            .AddCheck<MongoDbHealthCheck>("mongodb")
            .AddCheck<ApiServiceHealthCheck>("apiservice")
            .AddCheck<DataInitializerHealthCheck>("datainitializer");
        
        return services;
    }
}
```

### é…ç½®ç®¡ç†

```csharp
// Platform.ServiceDefaults/Extensions/ConfigurationExtensions.cs
public static class ConfigurationExtensions
{
    /// <summary>
    /// æ·»åŠ é…ç½®ç®¡ç†
    /// </summary>
    public static IServiceCollection AddConfigurationManagement(this IServiceCollection services, IConfiguration configuration)
    {
        // ç»‘å®šé…ç½®ç±»
        services.Configure<JwtSettings>(configuration.GetSection("JwtSettings"));
        services.Configure<MongoDbSettings>(configuration.GetSection("MongoDbSettings"));
        services.Configure<AppSettings>(configuration.GetSection("AppSettings"));
        
        // æ³¨å†Œé…ç½®æœåŠ¡
        services.AddSingleton<IConfigurationService, ConfigurationService>();
        
        return services;
    }

    /// <summary>
    /// æ·»åŠ ç¯å¢ƒç‰¹å®šé…ç½®
    /// </summary>
    public static void ConfigureEnvironment(WebApplicationBuilder builder)
    {
        var environment = builder.Environment.EnvironmentName;
        
        builder.Configuration
            .SetBasePath(builder.Environment.ContentRootPath)
            .AddJsonFile("appsettings.json", optional: false, reloadOnChange: true)
            .AddJsonFile($"appsettings.{environment}.json", optional: true, reloadOnChange: true)
            .AddEnvironmentVariables();

        // å¼€å‘ç¯å¢ƒç‰¹å®šé…ç½®
        if (environment == "Development")
        {
            builder.Configuration.AddUserSecrets<Program>();
        }

        // ç”Ÿäº§ç¯å¢ƒç‰¹å®šé…ç½®
        if (environment == "Production")
        {
            builder.Configuration.AddAzureKeyVault();
        }
    }
}
```

## ğŸ¯ å¥åº·æ£€æŸ¥å’Œç›‘æ§

### å¥åº·æ£€æŸ¥å®ç°

```csharp
// Platform.ApiService/HealthChecks/MongoDbHealthCheck.cs
public class MongoDbHealthCheck : IHealthCheck
{
    private readonly IMongoDatabase _database;

    public MongoDbHealthCheck(IMongoDatabase database)
    {
        _database = database;
    }

    public async Task<HealthCheckResult> CheckHealthAsync(HealthCheckContext context, CancellationToken cancellationToken = default)
    {
        try
        {
            await _database.RunCommandAsync((Command<object>)"{ping:1}", cancellationToken: cancellationToken);
            return HealthCheckResult.Healthy("MongoDB is healthy");
        }
        catch (Exception ex)
        {
            return HealthCheckResult.Unhealthy("MongoDB is unhealthy", ex);
        }
    }
}

// Platform.ApiService/HealthChecks/ApiServiceHealthCheck.cs
public class ApiServiceHealthCheck : IHealthCheck
{
    private readonly ILogger<ApiServiceHealthCheck> _logger;

    public ApiServiceHealthCheck(ILogger<ApiServiceHealthCheck> logger)
    {
        _logger = logger;
    }

    public async Task<HealthCheckResult> CheckHealthAsync(HealthCheckContext context, CancellationToken cancellationToken = default)
    {
        try
        {
            // æ£€æŸ¥å…³é”®æœåŠ¡æ˜¯å¦å¯ç”¨
            var services = context.Registration.GetServices<IHealthCheck>();
            var results = await Task.WhenAll(services.Select(s => s.CheckHealthAsync(context, cancellationToken)));
            
            var unhealthyResults = results.Where(r => r.Status != HealthStatus.Healthy).ToList();
            
            if (unhealthyResults.Any())
            {
                return HealthCheckResult.Unhealthy("Some services are unhealthy", 
                    unhealthyResults.Select(r => r.Exception).Where(e => e != null));
            }
            
            return HealthCheckResult.Healthy("All services are healthy");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Health check failed");
            return HealthCheckResult.Unhealthy("Health check failed", ex);
        }
    }
}
```

### ç›‘æ§é…ç½®

```csharp
// Platform.ServiceDefaults/Extensions/MonitoringExtensions.cs
public static class MonitoringExtensions
{
    /// <summary>
    /// æ·»åŠ ç›‘æ§æœåŠ¡
    /// </summary>
    public static IServiceCollection AddMonitoring(this IServiceCollection services)
    {
        services.AddOpenTelemetry()
            .WithTracing(tracing =>
            {
                tracing.AddAspNetCoreInstrumentation()
                    .AddHttpClientInstrumentation()
                    .AddMongoDBInstrumentation()
                    .AddSource("Platform.ApiService");
            })
            .WithMetrics(metrics =>
            {
                metrics.AddAspNetCoreInstrumentation()
                    .AddHttpClientInstrumentation()
                    .AddMongoDBInstrumentation();
            });

        return services;
    }

    /// <summary>
    /// æ·»åŠ æ—¥å¿—è®°å½•
    /// </summary>
    public static IServiceCollection AddLogging(this IServiceCollection services)
    {
        services.AddLogging(builder =>
        {
            builder.AddConsole();
            builder.AddDebug();
            builder.AddEventSourceLogger();
        });

        return services;
    }
}
```

## ğŸ¯ æœåŠ¡ç¼–æ’å’Œéƒ¨ç½²

### æœåŠ¡ç¼–æ’é…ç½®

```csharp
// Platform.AppHost/AppHost.cs
public static void ConfigureServiceOrchestration(DistributedApplicationBuilder builder)
{
    // 1. æ•°æ®åº“æœåŠ¡ï¼ˆæŒä¹…åŒ–ï¼‰
    var mongo = builder.AddMongoDB("mongo")
        .WithMongoExpress()
        .WithLifetime(ContainerLifetime.Persistent);
    var mongodb = mongo.AddDatabase("mongodb");

    // 2. æ•°æ®åˆå§‹åŒ–æœåŠ¡ï¼ˆå•å®ä¾‹ï¼‰
    var datainitializer = builder.AddProject<Projects.Platform_DataInitializer>("datainitializer")
        .WithReference(mongodb)
        .WithHttpEndpoint()
        .WithHttpHealthCheck("/health")
        .WithReplicas(1); // å•å®ä¾‹è¿è¡Œ

    // 3. API æœåŠ¡ï¼ˆå¯æ‰©å±•ï¼‰
    var apiservice = builder.AddProject<Projects.Platform_ApiService>("apiservice")
        .WithReference(mongodb)
        .WithReference(datainitializer)
        .WithHttpHealthCheck("/health")
        .WithReplicas(2); // 2ä¸ªå®ä¾‹

    // 4. ç½‘å…³æœåŠ¡
    var yarp = builder.AddYarp("apigateway")
        .WithHostPort(15000)
        .WithConfiguration(config => {
            config.AddRoute("/{service}/{**catch-all}", config.AddCluster(apiservice))
                .WithTransformPathRouteValues("/{**catch-all}");
        });

    // 5. å‰ç«¯åº”ç”¨
    builder.AddNpmApp("admin", "../Platform.Admin")
        .WithReference(yarp)
        .WaitFor(yarp)
        .WithHttpEndpoint(env: "PORT", port: 15001);

    builder.AddNpmApp("app", "../Platform.App")
        .WithReference(yarp)
        .WaitFor(yarp)
        .WithHttpEndpoint(env: "PORT", port: 15002);
}
```

### éƒ¨ç½²é…ç½®

```csharp
// Platform.AppHost/AppHost.cs
public static void ConfigureDeployment(DistributedApplicationBuilder builder)
{
    // 1. å¼€å‘ç¯å¢ƒé…ç½®
    if (builder.Environment.IsDevelopment())
    {
        ConfigureDevelopmentEnvironment(builder);
    }
    
    // 2. ç”Ÿäº§ç¯å¢ƒé…ç½®
    if (builder.Environment.IsProduction())
    {
        ConfigureProductionEnvironment(builder);
    }
}

private static void ConfigureDevelopmentEnvironment(DistributedApplicationBuilder builder)
{
    // å¼€å‘ç¯å¢ƒä½¿ç”¨æœ¬åœ°æœåŠ¡
    var mongo = builder.AddMongoDB("mongo")
        .WithMongoExpress()
        .WithLifetime(ContainerLifetime.Persistent);
    var mongodb = mongo.AddDatabase("mongodb");

    var datainitializer = builder.AddProject<Projects.Platform_DataInitializer>("datainitializer")
        .WithReference(mongodb)
        .WithHttpEndpoint()
        .WithHttpHealthCheck("/health");

    var apiservice = builder.AddProject<Projects.Platform_ApiService>("apiservice")
        .WithReference(mongodb)
        .WithReference(datainitializer)
        .WithHttpHealthCheck("/health");

    var yarp = builder.AddYarp("apigateway")
        .WithHostPort(15000)
        .WithConfiguration(config => {
            config.AddRoute("/{service}/{**catch-all}", config.AddCluster(apiservice))
                .WithTransformPathRouteValues("/{**catch-all}");
        });

    builder.AddNpmApp("admin", "../Platform.Admin")
        .WithReference(yarp)
        .WaitFor(yarp)
        .WithHttpEndpoint(env: "PORT", port: 15001);

    builder.AddNpmApp("app", "../Platform.App")
        .WithReference(yarp)
        .WaitFor(yarp)
        .WithHttpEndpoint(env: "PORT", port: 15002);
}

private static void ConfigureProductionEnvironment(DistributedApplicationBuilder builder)
{
    // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨äº‘æœåŠ¡
    var mongo = builder.AddMongoDB("mongo")
        .WithMongoExpress()
        .WithLifetime(ContainerLifetime.Persistent);
    var mongodb = mongo.AddDatabase("mongodb");

    var datainitializer = builder.AddProject<Projects.Platform_DataInitializer>("datainitializer")
        .WithReference(mongodb)
        .WithHttpEndpoint()
        .WithHttpHealthCheck("/health")
        .WithReplicas(1);

    var apiservice = builder.AddProject<Projects.Platform_ApiService>("apiservice")
        .WithReference(mongodb)
        .WithReference(datainitializer)
        .WithHttpHealthCheck("/health")
        .WithReplicas(3); // ç”Ÿäº§ç¯å¢ƒæ›´å¤šå®ä¾‹

    var yarp = builder.AddYarp("apigateway")
        .WithHostPort(15000)
        .WithConfiguration(config => {
            config.AddRoute("/{service}/{**catch-all}", config.AddCluster(apiservice))
                .WithTransformPathRouteValues("/{**catch-all}");
        });

    builder.AddNpmApp("admin", "../Platform.Admin")
        .WithReference(yarp)
        .WaitFor(yarp)
        .WithHttpEndpoint(env: "PORT", port: 15001);

    builder.AddNpmApp("app", "../Platform.App")
        .WithReference(yarp)
        .WaitFor(yarp)
        .WithHttpEndpoint(env: "PORT", port: 15002);
}
```

## ğŸš« ç¦æ­¢çš„åšæ³•

### ä¸è¦ç¡¬ç¼–ç æœåŠ¡åœ°å€

```csharp
// âŒ é”™è¯¯ - ç¡¬ç¼–ç æœåŠ¡åœ°å€
public class ApiClient
{
    private readonly HttpClient _httpClient;
    
    public ApiClient(HttpClient httpClient)
    {
        _httpClient = httpClient;
        _httpClient.BaseAddress = new Uri("http://localhost:15000"); // ç¡¬ç¼–ç 
    }
}

// âœ… æ­£ç¡® - ä½¿ç”¨æœåŠ¡å‘ç°
public class ApiClient
{
    private readonly HttpClient _httpClient;
    
    public ApiClient(HttpClient httpClient)
    {
        _httpClient = httpClient;
        // æœåŠ¡åœ°å€ç”± Aspire è‡ªåŠ¨é…ç½®
    }
}
```

### ä¸è¦å¿½ç•¥æœåŠ¡ä¾èµ–

```csharp
// âŒ é”™è¯¯ - å¿½ç•¥æœåŠ¡ä¾èµ–
var apiservice = builder.AddProject<Projects.Platform_ApiService>("apiservice")
    .WithReference(mongodb)
    .WithHttpHealthCheck("/health");
// æ²¡æœ‰ç­‰å¾…æ•°æ®åˆå§‹åŒ–æœåŠ¡

// âœ… æ­£ç¡® - æ­£ç¡®çš„æœåŠ¡ä¾èµ–
var apiservice = builder.AddProject<Projects.Platform_ApiService>("apiservice")
    .WithReference(mongodb)
    .WithReference(datainitializer) // ç­‰å¾…æ•°æ®åˆå§‹åŒ–æœåŠ¡
    .WithHttpHealthCheck("/health");
```

### ä¸è¦å¿½ç•¥å¥åº·æ£€æŸ¥

```csharp
// âŒ é”™è¯¯ - æ²¡æœ‰å¥åº·æ£€æŸ¥
var apiservice = builder.AddProject<Projects.Platform_ApiService>("apiservice")
    .WithReference(mongodb);

// âœ… æ­£ç¡® - æ·»åŠ å¥åº·æ£€æŸ¥
var apiservice = builder.AddProject<Projects.Platform_ApiService>("apiservice")
    .WithReference(mongodb)
    .WithHttpHealthCheck("/health");
```

## ğŸ“‹ Aspire å¾®æœåŠ¡å¼€å‘æ£€æŸ¥æ¸…å•

åˆ›å»ºæˆ–ä¿®æ”¹å¾®æœåŠ¡æ—¶æ£€æŸ¥ï¼š

- [ ] æ­£ç¡®é…ç½®æœåŠ¡ä¾èµ–
- [ ] æ·»åŠ å¥åº·æ£€æŸ¥ç«¯ç‚¹
- [ ] é…ç½®æœåŠ¡å‘ç°
- [ ] æ·»åŠ ç›‘æ§å’Œæ—¥å¿—
- [ ] é…ç½®ç¯å¢ƒç‰¹å®šè®¾ç½®
- [ ] æ·»åŠ é”™è¯¯å¤„ç†
- [ ] é…ç½®æœåŠ¡ç¼–æ’
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•
- [ ] æ–‡æ¡£åŒ–æœåŠ¡æ¶æ„
- [ ] éªŒè¯æœåŠ¡å¯åŠ¨é¡ºåº

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [åº”ç”¨ä¸»æœºé…ç½®](mdc:Platform.AppHost/AppHost.cs)
- [API æœåŠ¡é…ç½®](mdc:Platform.ApiService/Program.cs)
- [æ•°æ®åˆå§‹åŒ–æœåŠ¡é…ç½®](mdc:Platform.DataInitializer/Program.cs)
- [.NET Aspire å®˜æ–¹æ–‡æ¡£](https://learn.microsoft.com/en-us/dotnet/aspire/)
