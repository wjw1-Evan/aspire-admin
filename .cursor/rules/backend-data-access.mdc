---
alwaysApply: true
description: åç«¯æ•°æ®è®¿é—®å±‚è§„èŒƒ - æ•°æ®åº“æ“ä½œå·¥å‚ä½¿ç”¨è§„èŒƒ
globs: Platform.ApiService/Services/*.cs,Platform.ApiService/Models/*.cs,Platform.ServiceDefaults/**/*.cs
---

# åç«¯æ•°æ®è®¿é—®å±‚è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**æ‰€æœ‰æœåŠ¡å¿…é¡»ä½¿ç”¨ `IDatabaseOperationFactory<T>` è¿›è¡Œæ•°æ®è®¿é—®ï¼Œç¦æ­¢ç›´æ¥ä½¿ç”¨ `IMongoCollection<T>` æˆ– `BaseRepository<T>`**

## ğŸ“‹ æ¦‚è¿°

åŸºäº MongoDB å’Œæ•°æ®åº“æ“ä½œå·¥å‚æ¨¡å¼ï¼Œæä¾›ç»Ÿä¸€çš„æ•°æ®è®¿é—®å±‚è§„èŒƒå’Œæœ€ä½³å®è·µã€‚æ‰€æœ‰æ•°æ®åº“æ“ä½œå¿…é¡»ä½¿ç”¨ `IDatabaseOperationFactory<T>`ï¼Œç¦æ­¢ç›´æ¥ä½¿ç”¨ `IMongoCollection<T>` æˆ–å·²ç§»é™¤çš„ `BaseRepository<T>`ã€‚

## ğŸ—ï¸ æ•°æ®è®¿é—®æ¶æ„

### æ•°æ®åº“æ“ä½œå·¥å‚æ¨¡å¼

```csharp
// âœ… æ•°æ®åº“æ“ä½œå·¥å‚æ¥å£
public interface IDatabaseOperationFactory<T> where T : class, IEntity, ISoftDeletable, ITimestamped
{
    // CRUD æ“ä½œ
    Task<T> CreateAsync(T entity, OperationContext? context = null);
    Task<List<T>> CreateManyAsync(List<T> entities, OperationContext? context = null);
    Task<bool> UpdateAsync(T entity, OperationContext? context = null);
    Task<long> UpdateManyAsync(FilterDefinition<T> filter, UpdateDefinition<T> update, OperationContext? context = null);
    Task<bool> SoftDeleteAsync(string id, OperationContext? context = null);
    Task<long> SoftDeleteManyAsync(List<string> ids, OperationContext? context = null);
    Task<bool> HardDeleteAsync(string id, OperationContext? context = null);
    
    // æŸ¥è¯¢æ“ä½œ
    Task<List<T>> FindAsync(FilterDefinition<T>? filter = null, SortDefinition<T>? sort = null, int? limit = null);
    Task<(List<T> items, long total)> FindPagedAsync(FilterDefinition<T>? filter = null, SortDefinition<T>? sort = null, int page = 1, int pageSize = 20);
    Task<T?> GetByIdAsync(string id);
    Task<long> CountAsync(FilterDefinition<T>? filter = null);
    Task<bool> ExistsAsync(string id);
    
    // è·¨ç§Ÿæˆ·æŸ¥è¯¢
    Task<List<T>> FindWithoutTenantFilterAsync(FilterDefinition<T>? filter = null, SortDefinition<T>? sort = null, int? limit = null);
    Task<T?> GetByIdWithoutTenantFilterAsync(string id);
    
    // æ„å»ºå™¨
    FilterBuilder<T> CreateFilterBuilder();
    SortBuilder<T> CreateSortBuilder();
    UpdateBuilder<T> CreateUpdateBuilder();
    OperationContextBuilder CreateOperationContext();
}
```

### æœåŠ¡å±‚å®ç°

```csharp
// âœ… æœåŠ¡å±‚å®ç°
public interface IUserService
{
    Task<User?> GetUserByIdAsync(string id);
    Task<List<User>> GetUsersAsync(UserListRequest request);
    Task<User> CreateUserAsync(CreateUserRequest request);
    Task<bool> UpdateUserAsync(string id, UpdateUserRequest request);
    Task<bool> DeleteUserAsync(string id);
    Task<bool> ExistsAsync(string id);
}

public class UserService : BaseService, IUserService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    private readonly IPasswordHasher _passwordHasher;

    public UserService(
        IMongoDatabase database,
        IDatabaseOperationFactory<User> userFactory,
        IPasswordHasher passwordHasher,
        IHttpContextAccessor httpContextAccessor,
        ITenantContext tenantContext,
        ILogger<UserService> logger) 
        : base(database, httpContextAccessor, tenantContext, logger)
    {
        _userFactory = userFactory;
        _passwordHasher = passwordHasher;
    }

    public async Task<User?> GetUserByIdAsync(string id)
    {
        id.EnsureNotEmpty(nameof(id));
        
        _logger.LogInformation("Getting user {UserId}", id);
        
        try
        {
            var user = await _userFactory.GetByIdAsync(id);
            if (user == null)
            {
                _logger.LogWarning("User {UserId} not found", id);
            }
            
            return user;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to get user {UserId}", id);
            throw;
        }
    }

    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        request.EnsureNotNull(nameof(request));
        request.Username.EnsureValidUsername();
        request.Email.EnsureValidEmail();
        request.Password.EnsureValidPassword();

        _logger.LogInformation("Creating user with email {Email}", request.Email);

        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
        var existingUser = await _userFactory.FindAsync(
            _userFactory.CreateFilterBuilder()
                .Equal(u => u.Email, request.Email)
                .Build()
        );
        
        if (existingUser.Any())
        {
            throw new InvalidOperationException(ErrorMessages.UserAlreadyExists);
        }

        var user = new User
        {
            Username = request.Username,
            Email = request.Email,
            PasswordHash = _passwordHasher.HashPassword(request.Password),
            CompanyId = GetRequiredCompanyId(),
            IsActive = true
        };

        var createdUser = await _userFactory.CreateAsync(user);
        
        _logger.LogInformation("Successfully created user {UserId}", createdUser.Id);
        return createdUser;
    }
}
```

### 2. æŸ¥è¯¢ä¼˜åŒ–

```csharp
// âœ… æŸ¥è¯¢ä¼˜åŒ–
public async Task<List<User>> GetUsersAsync(UserListRequest request)
{
    var filterBuilder = _userFactory.CreateFilterBuilder();

    // æ·»åŠ æœç´¢æ¡ä»¶
    if (!string.IsNullOrEmpty(request.Keyword))
    {
        filterBuilder.Regex(u => u.Username, request.Keyword)
                    .Regex(u => u.Email, request.Keyword);
    }

    // æ·»åŠ è§’è‰²è¿‡æ»¤
    if (request.RoleIds?.Any() == true)
    {
        filterBuilder.In(u => u.RoleIds, request.RoleIds);
    }

    // æ·»åŠ çŠ¶æ€è¿‡æ»¤
    if (request.IsActive.HasValue)
    {
        filterBuilder.Equal(u => u.IsActive, request.IsActive.Value);
    }

    var filter = filterBuilder.Build();
    var sort = _userFactory.CreateSortBuilder()
        .Descending(u => u.CreatedAt)
        .Build();
    
    return await _userFactory.FindAsync(filter, sort);
}

public async Task<(List<User> users, long total)> GetUsersPagedAsync(UserListRequest request)
{
    var filterBuilder = _userFactory.CreateFilterBuilder();

    // åº”ç”¨ç›¸åŒçš„è¿‡æ»¤æ¡ä»¶
    if (!string.IsNullOrEmpty(request.Keyword))
    {
        filterBuilder.Regex(u => u.Username, request.Keyword)
                    .Regex(u => u.Email, request.Keyword);
    }

    var filter = filterBuilder.Build();
    var sort = _userFactory.CreateSortBuilder()
        .Descending(u => u.CreatedAt)
        .Build();
    
    return await _userFactory.FindPagedAsync(filter, sort, request.Page, request.PageSize);
}
```

### 3. æ‰¹é‡æ“ä½œ

```csharp
// âœ… æ‰¹é‡æ“ä½œ
public async Task<List<User>> CreateUsersAsync(List<CreateUserRequest> requests)
{
    var users = requests.Select(request => new User
    {
        Username = request.Username,
        Email = request.Email,
        PasswordHash = _passwordHasher.HashPassword(request.Password),
        CompanyId = GetRequiredCompanyId(),
        IsActive = true
    }).ToList();

    return await _userFactory.CreateManyAsync(users);
}

public async Task<long> DeactivateUsersAsync(List<string> userIds)
{
    var filter = _userFactory.CreateFilterBuilder()
        .In(u => u.Id, userIds)
        .Build();
    
    var update = _userFactory.CreateUpdateBuilder()
        .Set(u => u.IsActive, false)
        .SetCurrentTimestamp()
        .Build();
    
    return await _userFactory.UpdateManyAsync(filter, update);
}
```

### 4. è·¨ç§Ÿæˆ·æŸ¥è¯¢

```csharp
// âœ… è·¨ç§Ÿæˆ·æŸ¥è¯¢ï¼ˆä¸ªäººä¸­å¿ƒç­‰åœºæ™¯ï¼‰
public async Task<User?> GetUserByIdWithoutTenantFilterAsync(string id)
{
    return await _userFactory.GetByIdWithoutTenantFilterAsync(id);
}

public async Task<List<User>> FindUsersWithoutTenantFilterAsync(string keyword)
{
    var filter = _userFactory.CreateFilterBuilder()
        .Regex(u => u.Username, keyword)
        .Build();
    
    return await _userFactory.FindWithoutTenantFilterAsync(filter);
}
```

## âŒ é¿å…çš„åšæ³•

### 1. ä¸è¦ç›´æ¥ä½¿ç”¨ MongoDB é©±åŠ¨

```csharp
// âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨ MongoDB é©±åŠ¨
public class UserController : ControllerBase
{
    private readonly IMongoCollection<User> _users;

    public async Task<IActionResult> GetUser(string id)
    {
        var user = await _users.Find(x => x.Id == id).FirstOrDefaultAsync();
        return Ok(user);
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ•°æ®åº“æ“ä½œå·¥å‚
public class UserController : BaseApiController
{
    private readonly IUserService _userService;

    public async Task<IActionResult> GetUser(string id)
    {
        var user = await _userService.GetUserByIdAsync(id);
        return Success(user);
    }
}
```

### 2. ä¸è¦ä½¿ç”¨ BaseRepository

```csharp
// âŒ é”™è¯¯ï¼šä½¿ç”¨å·²ç§»é™¤çš„ BaseRepository
public class UserService : BaseService
{
    private readonly BaseRepository<User> _userRepository;
    
    public UserService(BaseRepository<User> userRepository)
    {
        _userRepository = userRepository;
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ•°æ®åº“æ“ä½œå·¥å‚
public class UserService : BaseService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    
    public UserService(IDatabaseOperationFactory<User> userFactory)
    {
        _userFactory = userFactory;
    }
}
```

### 3. ä¸è¦å¿½ç•¥å¤šç§Ÿæˆ·éš”ç¦»

```csharp
// âŒ é”™è¯¯ï¼šå¿½ç•¥å¤šç§Ÿæˆ·éš”ç¦»
public async Task<List<User>> GetUsersAsync()
{
    return await _collection.Find(_ => true).ToListAsync();
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å·¥å‚è‡ªåŠ¨å¤„ç†å¤šç§Ÿæˆ·éš”ç¦»
public async Task<List<User>> GetUsersAsync()
{
    return await _userFactory.FindAsync();
}
```

### 4. ä¸è¦å¿½ç•¥æ“ä½œå®¡è®¡

```csharp
// âŒ é”™è¯¯ï¼šå¿½ç•¥æ“ä½œå®¡è®¡
public async Task<User> CreateUserAsync(CreateUserRequest request)
{
    var user = new User { /* ... */ };
    await _collection.InsertOneAsync(user);
    return user;
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å·¥å‚è‡ªåŠ¨è®°å½•å®¡è®¡
public async Task<User> CreateUserAsync(CreateUserRequest request)
{
    var user = new User { /* ... */ };
    return await _userFactory.CreateAsync(user);
}
```

## ğŸ”§ æœ€ä½³å®è·µ

### 1. æœåŠ¡æ³¨å†Œ

```csharp
// âœ… åœ¨ Program.cs ä¸­æ³¨å†Œæ•°æ®åº“æ“ä½œå·¥å‚
builder.Services.AddDatabaseFactory();

// æˆ–è€…ä¸ºç‰¹å®šå®ä½“æ³¨å†Œ
builder.Services.AddDatabaseOperationFactory<User>();
builder.Services.AddDatabaseOperationFactory<Role>();
```

### 2. ç´¢å¼•ç®¡ç†

```csharp
// âœ… ç´¢å¼•ç®¡ç†ï¼ˆåœ¨æ•°æ®åˆå§‹åŒ–æœåŠ¡ä¸­ï¼‰
public async Task CreateUserIndexesAsync()
{
    // åˆ›å»ºå¤åˆç´¢å¼•
    var indexKeys = Builders<User>.IndexKeys
        .Ascending(x => x.CompanyId)
        .Ascending(x => x.Email);
    
    var indexOptions = new CreateIndexOptions
    {
        Unique = true,
        Name = "company_email_unique"
    };

    await _collection.Indexes.CreateOneAsync(
        new CreateIndexModel<User>(indexKeys, indexOptions));

    // åˆ›å»ºæœç´¢ç´¢å¼•
    var searchIndexKeys = Builders<User>.IndexKeys
        .Ascending(x => x.CompanyId)
        .Text(x => x.Username)
        .Text(x => x.Email);

    await _collection.Indexes.CreateOneAsync(
        new CreateIndexModel<User>(searchIndexKeys));
}
```

### 3. è½¯åˆ é™¤

```csharp
// âœ… è½¯åˆ é™¤å®ç°
public async Task<bool> DeleteUserAsync(string id)
{
    return await _userFactory.SoftDeleteAsync(id);
}

// âœ… æ‰¹é‡è½¯åˆ é™¤
public async Task<long> DeleteUsersAsync(List<string> userIds)
{
    return await _userFactory.SoftDeleteManyAsync(userIds);
}
```

### 4. æ“ä½œå®¡è®¡

```csharp
// âœ… æ“ä½œå®¡è®¡è‡ªåŠ¨è®°å½•
public async Task<User> CreateUserAsync(CreateUserRequest request)
{
    var user = new User { /* ... */ };
    
    // å·¥å‚è‡ªåŠ¨è®°å½•å®¡è®¡ä¿¡æ¯
    return await _userFactory.CreateAsync(user);
}

// âœ… æŸ¥è¯¢æ“ä½œå†å²
public async Task<List<OperationAudit>> GetUserAuditHistoryAsync(string userId)
{
    return await _auditService.GetEntityAuditHistoryAsync("User", userId);
}
```

## ğŸ“‹ æ•°æ®è®¿é—®å±‚æ£€æŸ¥æ¸…å•

å®ç°æ•°æ®è®¿é—®å±‚æ—¶æ£€æŸ¥ï¼š

- [ ] ä½¿ç”¨ `IDatabaseOperationFactory<T>` è¿›è¡Œæ‰€æœ‰æ•°æ®åº“æ“ä½œ
- [ ] ç¦æ­¢ç›´æ¥ä½¿ç”¨ `IMongoCollection<T>` è¿›è¡Œ CRUD æ“ä½œ
- [ ] ç¦æ­¢ä½¿ç”¨ `BaseRepository<T>`ï¼ˆå·²ç§»é™¤ï¼‰
- [ ] å®ç°å¤šç§Ÿæˆ·éš”ç¦»ï¼ˆå·¥å‚è‡ªåŠ¨å¤„ç†ï¼‰
- [ ] æ·»åŠ é€‚å½“çš„å¼‚å¸¸å¤„ç†
- [ ] å®ç°æŸ¥è¯¢ä¼˜åŒ–ï¼ˆä½¿ç”¨ FilterBuilderï¼‰
- [ ] æ·»åŠ ç´¢å¼•æ”¯æŒ
- [ ] å®ç°æ‰¹é‡æ“ä½œ
- [ ] å®ç°è½¯åˆ é™¤
- [ ] æ·»åŠ æ“ä½œå®¡è®¡ï¼ˆå·¥å‚è‡ªåŠ¨å¤„ç†ï¼‰
- [ ] æ·»åŠ æ—¥å¿—è®°å½•
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

## ğŸ§ª æ•°æ®è®¿é—®å±‚æµ‹è¯•

```csharp
// âœ… æ•°æ®è®¿é—®å±‚æµ‹è¯•
[Test]
public async Task CreateUser_ShouldRecordAudit()
{
    // Arrange
    var user = new User { Username = "test", Email = "test@example.com" };
    var context = _userFactory.CreateOperationContext()
        .WithUser("user123", "testuser")
        .WithCompany("company123")
        .Build();

    // Act
    var createdUser = await _userFactory.CreateAsync(user, context);

    // Assert
    Assert.That(createdUser.Id, Is.Not.Null);
    Assert.That(createdUser.CreatedBy, Is.EqualTo("user123"));
    Assert.That(createdUser.CreatedByUsername, Is.EqualTo("testuser"));

    // éªŒè¯å®¡è®¡è®°å½•
    var auditHistory = await _auditService.GetEntityAuditHistoryAsync("User", createdUser.Id);
    Assert.That(auditHistory, Has.Count.EqualTo(1));
    Assert.That(auditHistory[0].OperationType, Is.EqualTo(OperationType.Create));
}

[Test]
public async Task MultiTenantFilter_ShouldWorkCorrectly()
{
    // Arrange
    var company1Users = new List<User> { /* ä¼ä¸š1çš„ç”¨æˆ· */ };
    var company2Users = new List<User> { /* ä¼ä¸š2çš„ç”¨æˆ· */ };

    // Act
    await _userFactory.CreateManyAsync(company1Users, 
        _userFactory.CreateOperationContext().WithCompany("company1").Build());
    
    await _userFactory.CreateManyAsync(company2Users, 
        _userFactory.CreateOperationContext().WithCompany("company2").Build());

    // åˆ‡æ¢åˆ°ä¼ä¸š1ä¸Šä¸‹æ–‡
    _tenantContext.SetCurrentCompanyId("company1");
    var company1Result = await _userFactory.FindAsync();

    // åˆ‡æ¢åˆ°ä¼ä¸š2ä¸Šä¸‹æ–‡
    _tenantContext.SetCurrentCompanyId("company2");
    var company2Result = await _userFactory.FindAsync();

    // Assert
    Assert.That(company1Result, Has.Count.EqualTo(company1Users.Count));
    Assert.That(company2Result, Has.Count.EqualTo(company2Users.Count));
}
```

## ğŸ“š ç›¸å…³èµ„æº

- [æ•°æ®åº“æ“ä½œå·¥å‚ä½¿ç”¨æŒ‡å—](mdc:docs/features/DATABASE-OPERATION-FACTORY-GUIDE.md)
- [æ•°æ®åº“æ“ä½œå·¥å‚è¿ç§»æŒ‡å—](mdc:docs/features/DATABASE-FACTORY-MIGRATION.md)
- [å¤šç§Ÿæˆ·ç³»ç»Ÿå¼€å‘è§„èŒƒ](mdc:.cursor/rules/MULTI-TENANT-DEVELOPMENT.md)
- [æ“ä½œå®¡è®¡ç³»ç»Ÿ](mdc:Platform.ServiceDefaults/Services/AuditService.cs)
- [MongoDB C# é©±åŠ¨æ–‡æ¡£](https://mongodb.github.io/mongo-csharp-driver/)

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

1. **å¼ºåˆ¶ä½¿ç”¨å·¥å‚** - æ‰€æœ‰æ•°æ®åº“æ“ä½œå¿…é¡»ä½¿ç”¨ `IDatabaseOperationFactory<T>`
2. **å¤šç§Ÿæˆ·éš”ç¦»** - å·¥å‚è‡ªåŠ¨å¤„ç†å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»
3. **æ“ä½œå®¡è®¡** - å·¥å‚è‡ªåŠ¨è®°å½•æ‰€æœ‰æ“ä½œå®¡è®¡
4. **ç±»å‹å®‰å…¨** - ä½¿ç”¨å¼ºç±»å‹æ„å»ºå™¨ç¡®ä¿ç¼–è¯‘æ—¶æ£€æŸ¥
5. **æ€§èƒ½ä¼˜åŒ–** - ä½¿ç”¨æ‰¹é‡æ“ä½œå’Œç´¢å¼•ä¼˜åŒ–
6. **è½¯åˆ é™¤** - ä¼˜å…ˆä½¿ç”¨è½¯åˆ é™¤ä¿æŠ¤æ•°æ®
7. **å¼‚å¸¸å¤„ç†** - é€‚å½“çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
8. **å•å…ƒæµ‹è¯•** - ç¡®ä¿å¤šç§Ÿæˆ·è¿‡æ»¤å’Œå®¡è®¡åŠŸèƒ½æ­£å¸¸å·¥ä½œ
