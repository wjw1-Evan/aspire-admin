---
globs: Platform.ApiService/Services/*.cs,Platform.ApiService/Models/*.cs,Platform.ServiceDefaults/**/*.cs
description: åç«¯æ•°æ®è®¿é—®å±‚è§„èŒƒ
---

# åç«¯æ•°æ®è®¿é—®å±‚è§„èŒƒ

## ğŸ¯ æ¦‚è¿°

åŸºäº MongoDB å’Œ Repository æ¨¡å¼ï¼Œæä¾›ç»Ÿä¸€çš„æ•°æ®è®¿é—®å±‚è§„èŒƒå’Œæœ€ä½³å®è·µã€‚

## ğŸ—ï¸ æ•°æ®è®¿é—®æ¶æ„

### Repository æ¨¡å¼

```csharp
// âœ… åŸºç¡€ Repository æ¥å£
public interface IRepository<T> where T : IEntity
{
    Task<T?> GetByIdAsync(string id);
    Task<IEnumerable<T>> GetAllAsync();
    Task<IEnumerable<T>> GetByFilterAsync(Expression<Func<T, bool>> filter);
    Task<T> CreateAsync(T entity);
    Task<T> UpdateAsync(T entity);
    Task<bool> DeleteAsync(string id);
    Task<long> CountAsync(Expression<Func<T, bool>>? filter = null);
    Task<bool> ExistsAsync(Expression<Func<T, bool>> filter);
}

// âœ… åŸºç¡€ Repository å®ç°
public class BaseRepository<T> : IRepository<T> where T : IEntity
{
    protected readonly IMongoCollection<T> _collection;
    protected readonly ILogger<BaseRepository<T>> _logger;

    public BaseRepository(IMongoDatabase database, string collectionName, ILogger<BaseRepository<T>> logger)
    {
        _collection = database.GetCollection<T>(collectionName);
        _logger = logger;
    }

    public virtual async Task<T?> GetByIdAsync(string id)
    {
        try
        {
            var filter = Builders<T>.Filter.Eq(x => x.Id, id);
            return await _collection.Find(filter).FirstOrDefaultAsync();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to get {EntityType} by id {Id}", typeof(T).Name, id);
            throw;
        }
    }

    public virtual async Task<IEnumerable<T>> GetAllAsync()
    {
        try
        {
            return await _collection.Find(_ => true).ToListAsync();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to get all {EntityType}", typeof(T).Name);
            throw;
        }
    }

    public virtual async Task<T> CreateAsync(T entity)
    {
        try
        {
            entity.Id = ObjectId.GenerateNewId().ToString();
            entity.CreatedAt = DateTime.UtcNow;
            entity.UpdatedAt = DateTime.UtcNow;
            
            await _collection.InsertOneAsync(entity);
            return entity;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to create {EntityType}", typeof(T).Name);
            throw;
        }
    }
}
```

### å¤šç§Ÿæˆ· Repository

```csharp
// âœ… å¤šç§Ÿæˆ· Repository
public interface IMultiTenantRepository<T> : IRepository<T> where T : MultiTenantEntity
{
    Task<IEnumerable<T>> GetByCompanyIdAsync(string companyId);
    Task<T?> GetByIdAndCompanyIdAsync(string id, string companyId);
    Task<bool> ExistsInCompanyAsync(string id, string companyId);
}

public class MultiTenantRepository<T> : BaseRepository<T>, IMultiTenantRepository<T> 
    where T : MultiTenantEntity
{
    private readonly ITenantContext _tenantContext;

    public MultiTenantRepository(
        IMongoDatabase database, 
        string collectionName, 
        ILogger<MultiTenantRepository<T>> logger,
        ITenantContext tenantContext) 
        : base(database, collectionName, logger)
    {
        _tenantContext = tenantContext;
    }

    public override async Task<T?> GetByIdAsync(string id)
    {
        var companyId = _tenantContext.GetCurrentCompanyId();
        if (string.IsNullOrEmpty(companyId))
            throw new UnauthorizedAccessException("Company context not available");

        var filter = Builders<T>.Filter.And(
            Builders<T>.Filter.Eq(x => x.Id, id),
            Builders<T>.Filter.Eq(x => x.CompanyId, companyId)
        );

        return await _collection.Find(filter).FirstOrDefaultAsync();
    }

    public async Task<IEnumerable<T>> GetByCompanyIdAsync(string companyId)
    {
        var filter = Builders<T>.Filter.Eq(x => x.CompanyId, companyId);
        return await _collection.Find(filter).ToListAsync();
    }
}
```

## âœ… æ¨èåšæ³•

### 1. æœåŠ¡å±‚å®ç°

```csharp
// âœ… æœåŠ¡å±‚å®ç°
public interface IUserService
{
    Task<User?> GetUserByIdAsync(string id);
    Task<IEnumerable<User>> GetUsersAsync(UserListRequest request);
    Task<User> CreateUserAsync(CreateUserRequest request);
    Task<User> UpdateUserAsync(string id, UpdateUserRequest request);
    Task<bool> DeleteUserAsync(string id);
    Task<bool> ExistsAsync(string id);
}

public class UserService : BaseService, IUserService
{
    private readonly IUserRepository _userRepository;
    private readonly IPasswordHasher _passwordHasher;

    public UserService(
        IUserRepository userRepository,
        IPasswordHasher passwordHasher,
        ILogger<UserService> logger) : base(logger)
    {
        _userRepository = userRepository;
        _passwordHasher = passwordHasher;
    }

    public async Task<User?> GetUserByIdAsync(string id)
    {
        id.EnsureNotEmpty(nameof(id));
        
        _logger.LogInformation("Getting user {UserId}", id);
        
        try
        {
            var user = await _userRepository.GetByIdAsync(id);
            if (user == null)
            {
                _logger.LogWarning("User {UserId} not found", id);
            }
            
            return user;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to get user {UserId}", id);
            throw;
        }
    }

    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        request.EnsureNotNull(nameof(request));
        request.Username.EnsureValidUsername();
        request.Email.EnsureValidEmail();
        request.Password.EnsureValidPassword();

        _logger.LogInformation("Creating user with email {Email}", request.Email);

        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
        var existingUser = await _userRepository.GetByEmailAsync(request.Email);
        if (existingUser != null)
        {
            throw new InvalidOperationException(ErrorMessages.UserAlreadyExists);
        }

        var user = new User
        {
            Username = request.Username,
            Email = request.Email,
            PasswordHash = _passwordHasher.HashPassword(request.Password),
            CompanyId = GetRequiredCompanyId(),
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        };

        await _userRepository.CreateAsync(user);
        
        _logger.LogInformation("Successfully created user {UserId}", user.Id);
        return user;
    }
}
```

### 2. æŸ¥è¯¢ä¼˜åŒ–

```csharp
// âœ… æŸ¥è¯¢ä¼˜åŒ–
public class UserRepository : MultiTenantRepository<User>, IUserRepository
{
    public UserRepository(
        IMongoDatabase database,
        ILogger<UserRepository> logger,
        ITenantContext tenantContext) 
        : base(database, "users", logger, tenantContext)
    {
    }

    public async Task<IEnumerable<User>> GetUsersAsync(UserListRequest request)
    {
        var companyId = GetRequiredCompanyId();
        var filter = Builders<User>.Filter.Eq(x => x.CompanyId, companyId);

        // æ·»åŠ æœç´¢æ¡ä»¶
        if (!string.IsNullOrEmpty(request.Keyword))
        {
            var keywordFilter = Builders<User>.Filter.Or(
                Builders<User>.Filter.Regex(x => x.Username, new BsonRegularExpression(request.Keyword, "i")),
                Builders<User>.Filter.Regex(x => x.Email, new BsonRegularExpression(request.Keyword, "i"))
            );
            filter = Builders<User>.Filter.And(filter, keywordFilter);
        }

        // æ·»åŠ è§’è‰²è¿‡æ»¤
        if (request.RoleIds?.Any() == true)
        {
            filter = Builders<User>.Filter.And(filter, 
                Builders<User>.Filter.AnyIn(x => x.RoleIds, request.RoleIds));
        }

        // æ·»åŠ çŠ¶æ€è¿‡æ»¤
        if (request.IsActive.HasValue)
        {
            filter = Builders<User>.Filter.And(filter, 
                Builders<User>.Filter.Eq(x => x.IsActive, request.IsActive.Value));
        }

        var sort = Builders<User>.Sort.Descending(x => x.CreatedAt);
        
        return await _collection
            .Find(filter)
            .Sort(sort)
            .Skip((request.Page - 1) * request.PageSize)
            .Limit(request.PageSize)
            .ToListAsync();
    }

    public async Task<long> CountUsersAsync(UserListRequest request)
    {
        var companyId = GetRequiredCompanyId();
        var filter = Builders<User>.Filter.Eq(x => x.CompanyId, companyId);

        // åº”ç”¨ç›¸åŒçš„è¿‡æ»¤æ¡ä»¶
        if (!string.IsNullOrEmpty(request.Keyword))
        {
            var keywordFilter = Builders<User>.Filter.Or(
                Builders<User>.Filter.Regex(x => x.Username, new BsonRegularExpression(request.Keyword, "i")),
                Builders<User>.Filter.Regex(x => x.Email, new BsonRegularExpression(request.Keyword, "i"))
            );
            filter = Builders<User>.Filter.And(filter, keywordFilter);
        }

        return await _collection.CountDocumentsAsync(filter);
    }
}
```

### 3. äº‹åŠ¡å¤„ç†

```csharp
// âœ… äº‹åŠ¡å¤„ç†
public class UserService : BaseService, IUserService
{
    public async Task<User> CreateUserWithRoleAsync(CreateUserRequest request, string roleId)
    {
        using var session = await _database.Client.StartSessionAsync();
        session.StartTransaction();

        try
        {
            // åˆ›å»ºç”¨æˆ·
            var user = new User
            {
                Username = request.Username,
                Email = request.Email,
                PasswordHash = _passwordHasher.HashPassword(request.Password),
                CompanyId = GetRequiredCompanyId(),
                RoleIds = new List<string> { roleId }
            };

            await _userRepository.CreateAsync(user);

            // æ›´æ–°è§’è‰²ç”¨æˆ·åˆ—è¡¨
            await _roleRepository.AddUserToRoleAsync(roleId, user.Id);

            await session.CommitTransactionAsync();
            
            _logger.LogInformation("Successfully created user {UserId} with role {RoleId}", 
                user.Id, roleId);
            
            return user;
        }
        catch (Exception ex)
        {
            await session.AbortTransactionAsync();
            _logger.LogError(ex, "Failed to create user with role");
            throw;
        }
    }
}
```

### 4. ç¼“å­˜ç­–ç•¥

```csharp
// âœ… ç¼“å­˜ç­–ç•¥
public class CachedUserService : IUserService
{
    private readonly IUserService _userService;
    private readonly IMemoryCache _cache;
    private readonly ILogger<CachedUserService> _logger;

    public CachedUserService(
        IUserService userService,
        IMemoryCache cache,
        ILogger<CachedUserService> logger)
    {
        _userService = userService;
        _cache = cache;
        _logger = logger;
    }

    public async Task<User?> GetUserByIdAsync(string id)
    {
        var cacheKey = $"user_{id}";
        
        if (_cache.TryGetValue(cacheKey, out User? cachedUser))
        {
            _logger.LogDebug("User {UserId} found in cache", id);
            return cachedUser;
        }

        var user = await _userService.GetUserByIdAsync(id);
        if (user != null)
        {
            _cache.Set(cacheKey, user, TimeSpan.FromMinutes(5));
            _logger.LogDebug("User {UserId} cached for 5 minutes", id);
        }

        return user;
    }

    public async Task<User> UpdateUserAsync(string id, UpdateUserRequest request)
    {
        var user = await _userService.UpdateUserAsync(id, request);
        
        // æ›´æ–°ç¼“å­˜
        var cacheKey = $"user_{id}";
        _cache.Set(cacheKey, user, TimeSpan.FromMinutes(5));
        
        return user;
    }
}
```

## âŒ é¿å…çš„åšæ³•

### 1. ä¸è¦ç›´æ¥ä½¿ç”¨ MongoDB é©±åŠ¨

```csharp
// âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨ MongoDB é©±åŠ¨
public class UserController : ControllerBase
{
    private readonly IMongoCollection<User> _users;

    public async Task<IActionResult> GetUser(string id)
    {
        var user = await _users.Find(x => x.Id == id).FirstOrDefaultAsync();
        return Ok(user);
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ Repository æ¨¡å¼
public class UserController : BaseApiController
{
    private readonly IUserService _userService;

    public async Task<IActionResult> GetUser(string id)
    {
        var user = await _userService.GetUserByIdAsync(id);
        return Success(user);
    }
}
```

### 2. ä¸è¦å¿½ç•¥å¤šç§Ÿæˆ·éš”ç¦»

```csharp
// âŒ é”™è¯¯ï¼šå¿½ç•¥å¤šç§Ÿæˆ·éš”ç¦»
public async Task<IEnumerable<User>> GetUsersAsync()
{
    return await _collection.Find(_ => true).ToListAsync();
}

// âœ… æ­£ç¡®ï¼šç¡®ä¿å¤šç§Ÿæˆ·éš”ç¦»
public async Task<IEnumerable<User>> GetUsersAsync()
{
    var companyId = GetRequiredCompanyId();
    var filter = Builders<User>.Filter.Eq(x => x.CompanyId, companyId);
    return await _collection.Find(filter).ToListAsync();
}
```

### 3. ä¸è¦å¿½ç•¥å¼‚å¸¸å¤„ç†

```csharp
// âŒ é”™è¯¯ï¼šå¿½ç•¥å¼‚å¸¸å¤„ç†
public async Task<User> CreateUserAsync(CreateUserRequest request)
{
    var user = new User { /* ... */ };
    await _collection.InsertOneAsync(user);
    return user;
}

// âœ… æ­£ç¡®ï¼šé€‚å½“çš„å¼‚å¸¸å¤„ç†
public async Task<User> CreateUserAsync(CreateUserRequest request)
{
    try
    {
        var user = new User { /* ... */ };
        await _collection.InsertOneAsync(user);
        return user;
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Failed to create user");
        throw;
    }
}
```

### 4. ä¸è¦å¿½ç•¥æ€§èƒ½ä¼˜åŒ–

```csharp
// âŒ é”™è¯¯ï¼šå¿½ç•¥æ€§èƒ½ä¼˜åŒ–
public async Task<IEnumerable<User>> GetUsersAsync()
{
    return await _collection.Find(_ => true).ToListAsync();
}

// âœ… æ­£ç¡®ï¼šæ·»åŠ åˆ†é¡µå’Œæ’åº
public async Task<IEnumerable<User>> GetUsersAsync(UserListRequest request)
{
    return await _collection
        .Find(_ => true)
        .Sort(Builders<User>.Sort.Descending(x => x.CreatedAt))
        .Skip((request.Page - 1) * request.PageSize)
        .Limit(request.PageSize)
        .ToListAsync();
}
```

## ğŸ”§ æœ€ä½³å®è·µ

### 1. ç´¢å¼•ç®¡ç†

```csharp
// âœ… ç´¢å¼•ç®¡ç†
public class UserRepository : MultiTenantRepository<User>, IUserRepository
{
    public async Task CreateIndexesAsync()
    {
        // åˆ›å»ºå¤åˆç´¢å¼•
        var indexKeys = Builders<User>.IndexKeys
            .Ascending(x => x.CompanyId)
            .Ascending(x => x.Email);
        
        var indexOptions = new CreateIndexOptions
        {
            Unique = true,
            Name = "company_email_unique"
        };

        await _collection.Indexes.CreateOneAsync(
            new CreateIndexModel<User>(indexKeys, indexOptions));

        // åˆ›å»ºæœç´¢ç´¢å¼•
        var searchIndexKeys = Builders<User>.IndexKeys
            .Ascending(x => x.CompanyId)
            .Text(x => x.Username)
            .Text(x => x.Email);

        await _collection.Indexes.CreateOneAsync(
            new CreateIndexModel<User>(searchIndexKeys));
    }
}
```

### 2. æ‰¹é‡æ“ä½œ

```csharp
// âœ… æ‰¹é‡æ“ä½œ
public async Task<IEnumerable<User>> CreateUsersAsync(IEnumerable<CreateUserRequest> requests)
{
    var users = requests.Select(request => new User
    {
        Username = request.Username,
        Email = request.Email,
        PasswordHash = _passwordHasher.HashPassword(request.Password),
        CompanyId = GetRequiredCompanyId()
    }).ToList();

    await _collection.InsertManyAsync(users);
    return users;
}
```

### 3. è½¯åˆ é™¤

```csharp
// âœ… è½¯åˆ é™¤å®ç°
public async Task<bool> SoftDeleteAsync(string id)
{
    var filter = Builders<User>.Filter.Eq(x => x.Id, id);
    var update = Builders<User>.Update
        .Set(x => x.IsDeleted, true)
        .Set(x => x.DeletedAt, DateTime.UtcNow);

    var result = await _collection.UpdateOneAsync(filter, update);
    return result.ModifiedCount > 0;
}
```

## ğŸ“‹ æ•°æ®è®¿é—®å±‚æ£€æŸ¥æ¸…å•

å®ç°æ•°æ®è®¿é—®å±‚æ—¶æ£€æŸ¥ï¼š

- [ ] ä½¿ç”¨ Repository æ¨¡å¼
- [ ] å®ç°å¤šç§Ÿæˆ·éš”ç¦»
- [ ] æ·»åŠ é€‚å½“çš„å¼‚å¸¸å¤„ç†
- [ ] å®ç°æŸ¥è¯¢ä¼˜åŒ–
- [ ] æ·»åŠ ç´¢å¼•æ”¯æŒ
- [ ] å®ç°äº‹åŠ¡å¤„ç†
- [ ] æ·»åŠ ç¼“å­˜ç­–ç•¥
- [ ] å®ç°è½¯åˆ é™¤
- [ ] æ·»åŠ æ—¥å¿—è®°å½•
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

## ğŸ§ª æ•°æ®è®¿é—®å±‚æµ‹è¯•

```csharp
// âœ… æ•°æ®è®¿é—®å±‚æµ‹è¯•
[Test]
public async Task GetUserByIdAsync_ShouldReturnUser_WhenUserExists()
{
    // Arrange
    var user = new User { Id = "1", Username = "test", Email = "test@example.com" };
    await _userRepository.CreateAsync(user);

    // Act
    var result = await _userRepository.GetByIdAsync("1");

    // Assert
    Assert.That(result, Is.Not.Null);
    Assert.That(result.Username, Is.EqualTo("test"));
}
```

## ğŸ“š ç›¸å…³èµ„æº

- [MongoDB C# é©±åŠ¨æ–‡æ¡£](https://mongodb.github.io/mongo-csharp-driver/)
- [Repository æ¨¡å¼](https://docs.microsoft.com/azure/architecture/microservices/microservice-ddd-cqrs-patterns/infrastructure-persistence-layer-design)
- [å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»](mdc:Platform.ApiService/Services/UserService.cs)
- [BaseRepository å®ç°](mdc:Platform.ServiceDefaults/Services/BaseRepository.cs)

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

1. **Repository æ¨¡å¼** - æŠ½è±¡æ•°æ®è®¿é—®é€»è¾‘
2. **å¤šç§Ÿæˆ·éš”ç¦»** - ç¡®ä¿æ•°æ®å®‰å…¨
3. **å¼‚å¸¸å¤„ç†** - é€‚å½“çš„é”™è¯¯å¤„ç†
4. **æ€§èƒ½ä¼˜åŒ–** - æŸ¥è¯¢å’Œç´¢å¼•ä¼˜åŒ–
5. **äº‹åŠ¡å®‰å…¨** - æ•°æ®ä¸€è‡´æ€§
6. **ç¼“å­˜ç­–ç•¥** - æé«˜æ€§èƒ½
7. **æ—¥å¿—è®°å½•** - ä¾¿äºè°ƒè¯•
8. **å•å…ƒæµ‹è¯•** - ä¿è¯è´¨é‡