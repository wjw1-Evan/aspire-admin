---
description: BackendæœåŠ¡å±‚å¼€å‘è§„èŒƒ - ä½¿ç”¨ BaseService å’Œ BaseRepository
globs: Platform.ApiService/Services/*.cs
---

# Backend æœåŠ¡å±‚å¼€å‘è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

æ‰€æœ‰æœåŠ¡ç±»å¿…é¡»ç»§æ‰¿ `BaseService` å¹¶ä½¿ç”¨ `BaseRepository<T>` è¿›è¡Œæ•°æ®è®¿é—®ã€‚

## âœ… æ­£ç¡®çš„æœåŠ¡å®ç°

```csharp
public class MyService : BaseService, IMyService
{
    private readonly BaseRepository<MyEntity> _repository;
    
    // å¦‚éœ€ç›´æ¥è®¿é—®é›†åˆè¿›è¡Œå¤æ‚æŸ¥è¯¢
    private IMongoCollection<MyEntity> _entities => _repository.Collection;
    
    public MyService(
        IMongoDatabase database,
        IHttpContextAccessor httpContextAccessor,
        ILogger<MyService> logger)
        : base(database, httpContextAccessor, logger)
    {
        _repository = new BaseRepository<MyEntity>(database, "my_entities", httpContextAccessor);
    }
    
    // ä½¿ç”¨ä»“å‚¨æ–¹æ³•è€Œä¸æ˜¯æ‰‹åŠ¨å®ç°
    public async Task<MyEntity?> GetByIdAsync(string id)
    {
        return await _repository.GetByIdAsync(id);
    }
    
    public async Task<MyEntity> CreateAsync(CreateRequest request)
    {
        var entity = new MyEntity
        {
            Name = request.Name
            // âœ… CreatedAt, UpdatedAt, IsDeleted ä¼šè‡ªåŠ¨è®¾ç½®
        };
        
        return await _repository.CreateAsync(entity);
    }
    
    public async Task<bool> DeleteAsync(string id, string? reason = null)
    {
        return await _repository.SoftDeleteAsync(id, reason);
    }
}
```

## âŒ ç¦æ­¢çš„åšæ³•

```csharp
// âŒ ä¸è¦ç›´æ¥å®ç° IService è€Œä¸ç»§æ‰¿ BaseService
public class MyService : IMyService
{
    private readonly IMongoCollection<MyEntity> _entities;
    
    // âŒ ä¸è¦é‡å¤å®ç° GetCurrentUserId
    private string? GetCurrentUserId()
    {
        return _httpContextAccessor.HttpContext?.User?.FindFirst("userId")?.Value;
    }
}

// âŒ ä¸è¦æ‰‹åŠ¨è®¾ç½®æ—¶é—´æˆ³
var entity = new MyEntity
{
    Name = "Test",
    CreatedAt = DateTime.UtcNow,  // âŒ BaseRepository ä¼šè‡ªåŠ¨è®¾ç½®
    UpdatedAt = DateTime.UtcNow,  // âŒ BaseRepository ä¼šè‡ªåŠ¨è®¾ç½®
    IsDeleted = false             // âŒ BaseRepository ä¼šè‡ªåŠ¨è®¾ç½®
};

// âŒ ä¸è¦æ‰‹åŠ¨æ„å»ºç®€å•çš„ CRUD æŸ¥è¯¢
var filter = Builders<MyEntity>.Filter.And(
    Builders<MyEntity>.Filter.Eq(e => e.Id, id),
    Builders<MyEntity>.Filter.Eq(e => e.IsDeleted, false)
);
var entity = await _entities.Find(filter).FirstOrDefaultAsync();

// âœ… åº”è¯¥ä½¿ç”¨
var entity = await _repository.GetByIdAsync(id);
```

## ğŸ”§ BaseService æä¾›çš„åŠŸèƒ½

```csharp
// è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
var userId = GetCurrentUserId();
var username = GetCurrentUsername();

// è·å– MongoDB é›†åˆ
var collection = GetCollection<MyEntity>("my_entities");

// æ—¥å¿—è®°å½•ï¼ˆç»§æ‰¿çš„ Logger å±æ€§ï¼‰
LogError(ex, "å‘ç”Ÿé”™è¯¯: {Message}", ex.Message);
LogInformation("æ“ä½œæˆåŠŸ: {UserId}", userId);
LogWarning("è­¦å‘Š: {Message}", message);
```

## ğŸ”§ BaseRepository æä¾›çš„æ–¹æ³•

```csharp
// åŸºç¡€æŸ¥è¯¢ï¼ˆè‡ªåŠ¨æ’é™¤å·²åˆ é™¤ï¼‰
await _repository.GetByIdAsync(id);
await _repository.GetAllAsync();
await _repository.GetAllAsync(sort);

// åˆ›å»ºï¼ˆè‡ªåŠ¨è®¾ç½® CreatedAt, UpdatedAt, IsDeletedï¼‰
await _repository.CreateAsync(entity);

// æ›´æ–°ï¼ˆè‡ªåŠ¨æ›´æ–° UpdatedAtï¼‰
await _repository.UpdateAsync(id, update);

// è½¯åˆ é™¤ï¼ˆè‡ªåŠ¨è®¾ç½®è½¯åˆ é™¤å­—æ®µï¼‰
await _repository.SoftDeleteAsync(id, reason);

// æ£€æŸ¥å­˜åœ¨
await _repository.ExistsAsync(id);
await _repository.ExistsAsync(filter);

// æŸ¥æ‰¾
await _repository.FindOneAsync(filter);
await _repository.FindAsync(filter);

// ç»Ÿè®¡
await _repository.CountAsync(filter);

// åˆ†é¡µ
await _repository.GetPagedAsync(filter, page, pageSize, sort);

// æ‰¹é‡æ“ä½œ
await _repository.UpdateManyAsync(filter, update);
await _repository.SoftDeleteManyAsync(filter, reason);
```

## ğŸ“‹ å®ä½“è¦æ±‚

å®ä½“å¿…é¡»å®ç°ä¸‰ä¸ªæ¥å£ï¼š

```csharp
public class MyEntity : IEntity, ISoftDeletable, ITimestamped
{
    public string? Id { get; set; }
    
    // ISoftDeletable
    public bool IsDeleted { get; set; }
    public DateTime? DeletedAt { get; set; }
    public string? DeletedBy { get; set; }
    public string? DeletedReason { get; set; }
    
    // ITimestamped
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    
    // ä¸šåŠ¡å±æ€§...
}
```

## ğŸ“š å‚è€ƒå®ç°

æŸ¥çœ‹ä»¥ä¸‹æ–‡ä»¶ä½œä¸ºæ ‡å‡†ç¤ºä¾‹ï¼š
- [UserService.cs](mdc:Platform.ApiService/Services/UserService.cs)
- [RoleService.cs](mdc:Platform.ApiService/Services/RoleService.cs)
- [MenuService.cs](mdc:Platform.ApiService/Services/MenuService.cs)
- [NoticeService.cs](mdc:Platform.ApiService/Services/NoticeService.cs)
- [BaseService.cs](mdc:Platform.ApiService/Services/BaseService.cs)
- [BaseRepository.cs](mdc:Platform.ApiService/Services/BaseRepository.cs)
- [åŸºç¡€ç»„ä»¶ä½¿ç”¨æŒ‡å—](mdc:docs/optimization/BASE-COMPONENTS-GUIDE.md)
