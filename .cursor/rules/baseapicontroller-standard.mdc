---
alwaysApply: true
description: BaseApiController ç»Ÿä¸€æ ‡å‡† - æ‰€æœ‰æ§åˆ¶å™¨å¿…é¡»ç»§æ‰¿
---

# BaseApiController ç»Ÿä¸€æ ‡å‡†

## ğŸ¯ å¼ºåˆ¶è§„èŒƒ

**æ‰€æœ‰æ§åˆ¶å™¨å¿…é¡»ç»§æ‰¿ `BaseApiController`ï¼Œç¦æ­¢ç›´æ¥ç»§æ‰¿ `ControllerBase`**

## âœ… æ­£ç¡®ç¤ºä¾‹

```csharp
[ApiController]
[Route("api/[controller]")]
public class MyController : BaseApiController  // âœ… æ­£ç¡®
{
    [HttpGet]
    public async Task<IActionResult> GetData()
    {
        // ä½¿ç”¨åŸºç±»æ–¹æ³•è·å–ç”¨æˆ·ä¿¡æ¯
        var userId = GetRequiredUserId();
        
        var data = await _service.GetDataAsync(userId);
        
        // ä½¿ç”¨åŸºç±»æ–¹æ³•è¿”å›å“åº”
        return Success(data);
    }
}
```

## âŒ é”™è¯¯ç¤ºä¾‹

```csharp
[ApiController]
[Route("api/[controller]")]
public class MyController : ControllerBase  // âŒ ç¦æ­¢ç›´æ¥ç»§æ‰¿ ControllerBase
{
    // ...
}
```

## ğŸ“š BaseApiController æä¾›çš„èƒ½åŠ›

### ç”¨æˆ·ä¿¡æ¯å±æ€§
- `CurrentUserId` - å½“å‰ç”¨æˆ·IDï¼ˆå¯ç©ºï¼‰
- `CurrentUsername` - å½“å‰ç”¨æˆ·åï¼ˆå¯ç©ºï¼‰
- `CurrentUserRole` - å½“å‰ç”¨æˆ·è§’è‰²ï¼ˆå¯ç©ºï¼‰
- `IsAdmin` - æ˜¯å¦ä¸ºç®¡ç†å‘˜
- `IsAuthenticated` - æ˜¯å¦å·²è®¤è¯

### å®‰å…¨è·å–ç”¨æˆ·ä¿¡æ¯
```csharp
// è·å–å¿…éœ€çš„ç”¨æˆ·IDï¼ˆä¸ºç©ºåˆ™è‡ªåŠ¨æŠ›å‡º UnauthorizedAccessExceptionï¼‰
var userId = GetRequiredUserId();
```

### ç»Ÿä¸€å“åº”æ–¹æ³•

#### æˆåŠŸå“åº”
```csharp
// è¿”å›æ•°æ®
return Success(data);

// è¿”å›æ•°æ®å’Œæ¶ˆæ¯
return Success(data, "è·å–æˆåŠŸ");

// è¿”å›æ¶ˆæ¯
return Success("æ“ä½œæˆåŠŸ");

// ApiResponse æ ¼å¼
return SuccessResponse(data);
```

#### é”™è¯¯å“åº”
```csharp
// é€šç”¨é”™è¯¯ï¼ˆå»ºè®®ï¼šç›´æ¥æŠ›å¼‚å¸¸ï¼Œç”± GlobalExceptionMiddleware å¤„ç†ï¼‰
throw new InvalidOperationException("æ“ä½œå¤±è´¥");

// ç‰¹å®šé”™è¯¯
throw new KeyNotFoundException("èµ„æºä¸å­˜åœ¨");
throw new ArgumentException("å‚æ•°é”™è¯¯");
throw new UnauthorizedAccessException("æœªæˆæƒ");

// æ‰‹åŠ¨è¿”å›é”™è¯¯ï¼ˆä¸æ¨èï¼‰
return Error("é”™è¯¯æ¶ˆæ¯");
return NotFoundError("èµ„æºä¸å­˜åœ¨");
return UnauthorizedError("æœªæˆæƒè®¿é—®");
```

## ğŸš« ç¦æ­¢çš„åšæ³•

### âŒ æ‰‹åŠ¨æå–ç”¨æˆ·ä¿¡æ¯
```csharp
// âŒ ä¸è¦è¿™æ ·åš
var userId = User.FindFirst("userId")?.Value;
if (string.IsNullOrEmpty(userId))
    return Unauthorized(new { success = false, error = "æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯" });

// âœ… åº”è¯¥è¿™æ ·åš
var userId = GetRequiredUserId();
```

### âŒ æ‰‹åŠ¨æ„å»ºå“åº”æ ¼å¼
```csharp
// âŒ ä¸è¦è¿™æ ·åš
return Ok(new { success = true, data = result });

// âœ… åº”è¯¥è¿™æ ·åš
return Success(result);
```

### âŒ æ‰‹åŠ¨ try-catch
```csharp
// âŒ ä¸è¦è¿™æ ·åš
try
{
    var result = await _service.DoSomething();
    return Ok(new { success = true, data = result });
}
catch (Exception ex)
{
    return StatusCode(500, new { success = false, error = ex.Message });
}

// âœ… åº”è¯¥è¿™æ ·åšï¼ˆGlobalExceptionMiddleware ä¼šè‡ªåŠ¨å¤„ç†ï¼‰
var result = await _service.DoSomething();
return Success(result);
```

## ğŸ¯ å®Œæ•´ç¤ºä¾‹

```csharp
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace Platform.ApiService.Controllers;

[ApiController]
[Route("api/[controller]")]
[Authorize]
public class ProductController : BaseApiController
{
    private readonly IProductService _productService;

    public ProductController(IProductService productService)
    {
        _productService = productService;
    }

    /// <summary>
    /// è·å–æ‰€æœ‰äº§å“
    /// </summary>
    [HttpGet]
    public async Task<IActionResult> GetAll()
    {
        var products = await _productService.GetAllAsync();
        return Success(products);
    }

    /// <summary>
    /// æ ¹æ®IDè·å–äº§å“
    /// </summary>
    [HttpGet("{id}")]
    public async Task<IActionResult> GetById(string id)
    {
        var product = await _productService.GetByIdAsync(id);
        if (product == null)
            throw new KeyNotFoundException($"äº§å“ {id} ä¸å­˜åœ¨");
        
        return Success(product);
    }

    /// <summary>
    /// åˆ›å»ºäº§å“
    /// </summary>
    [HttpPost]
    public async Task<IActionResult> Create([FromBody] CreateProductRequest request)
    {
        if (string.IsNullOrEmpty(request.Name))
            throw new ArgumentException("äº§å“åç§°ä¸èƒ½ä¸ºç©º");
        
        // ä½¿ç”¨åŸºç±»æ–¹æ³•è·å–å½“å‰ç”¨æˆ·ID
        var userId = GetRequiredUserId();
        
        var product = await _productService.CreateAsync(request, userId);
        return Success(product, "åˆ›å»ºæˆåŠŸ");
    }

    /// <summary>
    /// æ›´æ–°äº§å“
    /// </summary>
    [HttpPut("{id}")]
    public async Task<IActionResult> Update(string id, [FromBody] UpdateProductRequest request)
    {
        var success = await _productService.UpdateAsync(id, request);
        if (!success)
            throw new KeyNotFoundException($"äº§å“ {id} ä¸å­˜åœ¨");
        
        return Success("æ›´æ–°æˆåŠŸ");
    }

    /// <summary>
    /// åˆ é™¤äº§å“
    /// </summary>
    [HttpDelete("{id}")]
    public async Task<IActionResult> Delete(string id)
    {
        var success = await _productService.DeleteAsync(id);
        if (!success)
            throw new KeyNotFoundException($"äº§å“ {id} ä¸å­˜åœ¨");
        
        return NoContent();
    }

    /// <summary>
    /// è·å–æˆ‘çš„äº§å“ï¼ˆéœ€è¦ç”¨æˆ·è®¤è¯ï¼‰
    /// </summary>
    [HttpGet("my-products")]
    public async Task<IActionResult> GetMyProducts()
    {
        // è‡ªåŠ¨è·å–å½“å‰ç”¨æˆ·IDï¼Œå¦‚æœæœªè®¤è¯ä¼šè‡ªåŠ¨æŠ›å¼‚å¸¸
        var userId = GetRequiredUserId();
        
        var products = await _productService.GetUserProductsAsync(userId);
        return Success(products);
    }

    /// <summary>
    /// ç®¡ç†å‘˜æ“ä½œï¼ˆæ£€æŸ¥æƒé™ï¼‰
    /// </summary>
    [HttpPost("admin-action")]
    [Authorize(Roles = "admin")]
    public async Task<IActionResult> AdminAction()
    {
        // å¯ä»¥ä½¿ç”¨ IsAdmin å±æ€§è¿›è¡Œé¢å¤–æ£€æŸ¥
        if (!IsAdmin)
            throw new UnauthorizedAccessException("éœ€è¦ç®¡ç†å‘˜æƒé™");
        
        // æ‰§è¡Œç®¡ç†å‘˜æ“ä½œ
        await _productService.DoAdminActionAsync();
        return Success("æ“ä½œæˆåŠŸ");
    }
}
```

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [BaseApiController å®ç°](mdc:Platform.ApiService/Controllers/BaseApiController.cs)
- [å…¨å±€å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶](mdc:Platform.ApiService/Middleware/GlobalExceptionMiddleware.cs)
- [ç»Ÿä¸€æ ‡å‡†æŠ¥å‘Š](mdc:BASEAPICONTROLLER-STANDARDIZATION.md)

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

1. **ç»Ÿä¸€ç»§æ‰¿** - æ‰€æœ‰æ§åˆ¶å™¨å¿…é¡»ç»§æ‰¿ `BaseApiController`
2. **ä½¿ç”¨åŸºç±»æ–¹æ³•** - ä½¿ç”¨åŸºç±»æä¾›çš„ä¾¿æ·æ–¹æ³•
3. **æŠ›å‡ºå¼‚å¸¸** - ä¸è¦æ‰‹åŠ¨ try-catchï¼ŒæŠ›å‡ºå¼‚å¸¸ç”±ä¸­é—´ä»¶å¤„ç†
4. **ç»Ÿä¸€å“åº”** - ä½¿ç”¨ `Success()` ç­‰æ–¹æ³•ç»Ÿä¸€å“åº”æ ¼å¼
5. **ç®€åŒ–ä»£ç ** - è®©åŸºç±»å’Œä¸­é—´ä»¶å¤„ç†é€šç”¨é€»è¾‘

éµå¾ªè¿™äº›è§„èŒƒï¼Œä»£ç å°†æ›´ç®€æ´ã€æ›´æ˜“ç»´æŠ¤ã€æ›´ç»Ÿä¸€ï¼
