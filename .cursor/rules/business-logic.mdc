---
globs: Platform.ApiService/Services/*.cs,Platform.ServiceDefaults/Services/*.cs
description: ä¸šåŠ¡é€»è¾‘å’ŒæœåŠ¡å±‚å¼€å‘è§„èŒƒ
---
# ä¸šåŠ¡é€»è¾‘å’ŒæœåŠ¡å±‚å¼€å‘è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

### æœåŠ¡å±‚è´Ÿè´£ä¸šåŠ¡é€»è¾‘å®ç°ï¼Œä¿æŒå•ä¸€èŒè´£ï¼Œç¡®ä¿ä¸šåŠ¡è§„åˆ™çš„ä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§

## âœ… æœåŠ¡å±‚æ¶æ„è§„èŒƒ

### æœåŠ¡æ¥å£å®šä¹‰

```csharp
// Platform.ApiService/Services/IUserService.cs
public interface IUserService
{
    // ç”¨æˆ·ç®¡ç†
    Task<User> CreateUserAsync(CreateUserRequest request);
    Task<User?> GetUserByIdAsync(string id);
    Task<List<User>> GetUsersAsync(UserListRequest request);
    Task<bool> UpdateUserAsync(UpdateUserRequest request);
    Task<bool> DeleteUserAsync(string id);
    
    // ç”¨æˆ·çŠ¶æ€ç®¡ç†
    Task<bool> ActivateUserAsync(string id);
    Task<bool> DeactivateUserAsync(string id);
    Task<bool> ResetPasswordAsync(string id, string newPassword);
    
    // ç”¨æˆ·éªŒè¯
    Task<bool> ValidateUserAsync(string id);
    Task<bool> CheckUserExistsAsync(string username);
    
    // ç”¨æˆ·ç»Ÿè®¡
    Task<UserStatistics> GetUserStatisticsAsync();
    Task<long> GetUserCountAsync();
}
```

### æœåŠ¡å®ç°è§„èŒƒ

```csharp
// Platform.ApiService/Services/UserService.cs
public class UserService : IUserService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    private readonly IMongoCollection<UserActivityLog> _activityLogs;
    private readonly IMongoCollection<Role> _roles;
    private readonly IMongoCollection<UserCompany> _userCompanies;
    private readonly IUniquenessChecker _uniquenessChecker;
    private readonly IFieldValidationService _validationService;

    public UserService(
        IDatabaseOperationFactory<User> userFactory,
        IMongoCollection<UserActivityLog> activityLogs,
        IMongoCollection<Role> roles,
        IMongoCollection<UserCompany> userCompanies,
        IUniquenessChecker uniquenessChecker,
        IFieldValidationService validationService)
    {
        _userFactory = userFactory;
        _activityLogs = activityLogs;
        _roles = roles;
        _userCompanies = userCompanies;
        _uniquenessChecker = uniquenessChecker;
        _validationService = validationService;
    }

    /// <summary>
    /// åˆ›å»ºç”¨æˆ·
    /// </summary>
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // 1. ä¸šåŠ¡éªŒè¯
        await ValidateCreateUserRequestAsync(request);
        
        // 2. æ£€æŸ¥å”¯ä¸€æ€§
        await _uniquenessChecker.EnsureUniqueAsync<User>(u => u.Username, request.Username);
        await _uniquenessChecker.EnsureUniqueAsync<User>(u => u.Email, request.Email);
        
        // 3. åˆ›å»ºç”¨æˆ·å®ä½“
        var user = new User
        {
            Username = request.Username,
            Email = request.Email,
            PasswordHash = _passwordHasher.HashPassword(request.Password),
            IsActive = true,
            CompanyId = _userFactory.GetRequiredCompanyId(),
            CreatedBy = _userFactory.GetCurrentUserId(),
            CreatedAt = DateTime.UtcNow
        };
        
        // 4. ä¿å­˜åˆ°æ•°æ®åº“
        var createdUser = await _userFactory.CreateAsync(user);
        
        // 5. è®°å½•æ“ä½œæ—¥å¿—
        _userFactory.LogOperation("åˆ›å»ºç”¨æˆ·", createdUser.Id, new { Username = request.Username });
        
        return createdUser;
    }

    /// <summary>
    /// è·å–ç”¨æˆ·åˆ—è¡¨
    /// </summary>
    public async Task<List<User>> GetUsersAsync(UserListRequest request)
    {
        // 1. æ„å»ºæŸ¥è¯¢æ¡ä»¶
        var filter = _userFactory.CreateFilterBuilder()
            .ExcludeDeleted()
            .WithTenant()
            .Build();

        // 2. æ·»åŠ æœç´¢æ¡ä»¶
        if (!string.IsNullOrEmpty(request.Keyword))
        {
            var searchFilter = _userFactory.CreateFilterBuilder()
                .Regex(u => u.Username, request.Keyword)
                .Or()
                .Regex(u => u.Email, request.Keyword)
                .Build();
            
            filter = _userFactory.CreateFilterBuilder()
                .And(filter)
                .And(searchFilter)
                .Build();
        }

        // 3. æ·»åŠ çŠ¶æ€è¿‡æ»¤
        if (request.IsActive.HasValue)
        {
            var statusFilter = _userFactory.CreateFilterBuilder()
                .Equal(u => u.IsActive, request.IsActive.Value)
                .Build();
            
            filter = _userFactory.CreateFilterBuilder()
                .And(filter)
                .And(statusFilter)
                .Build();
        }

        // 4. æ„å»ºæ’åº
        var sort = _userFactory.CreateSortBuilder()
            .Descending(u => u.CreatedAt)
            .Build();

        // 5. æ‰§è¡ŒæŸ¥è¯¢
        return await _userFactory.FindAsync(filter, sort, request.Limit);
    }

    /// <summary>
    /// æ›´æ–°ç”¨æˆ·
    /// </summary>
    public async Task<bool> UpdateUserAsync(UpdateUserRequest request)
    {
        // 1. è·å–ç°æœ‰ç”¨æˆ·
        var existingUser = await _userFactory.GetByIdAsync(request.Id);
        if (existingUser == null)
        {
            throw new KeyNotFoundException($"ç”¨æˆ· {request.Id} ä¸å­˜åœ¨");
        }

        // 2. ä¸šåŠ¡éªŒè¯
        await ValidateUpdateUserRequestAsync(request, existingUser);
        
        // 3. æ£€æŸ¥å”¯ä¸€æ€§ï¼ˆå¦‚æœéœ€è¦ï¼‰
        if (!string.IsNullOrEmpty(request.Username) && request.Username != existingUser.Username)
        {
            await _uniquenessChecker.EnsureUniqueAsync<User>(u => u.Username, request.Username);
        }
        
        if (!string.IsNullOrEmpty(request.Email) && request.Email != existingUser.Email)
        {
            await _uniquenessChecker.EnsureUniqueAsync<User>(u => u.Email, request.Email);
        }

        // 4. æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        var update = _userFactory.CreateUpdateBuilder()
            .SetCurrentTimestamp()
            .SetOperationTracking(_userFactory.GetCurrentUserId(), _userFactory.GetCurrentUsername())
            .Build();

        if (!string.IsNullOrEmpty(request.Username))
        {
            update = _userFactory.CreateUpdateBuilder()
                .Set(u => u.Username, request.Username)
                .SetCurrentTimestamp()
                .SetOperationTracking(_userFactory.GetCurrentUserId(), _userFactory.GetCurrentUsername())
                .Build();
        }

        if (!string.IsNullOrEmpty(request.Email))
        {
            update = _userFactory.CreateUpdateBuilder()
                .Set(u => u.Email, request.Email)
                .SetCurrentTimestamp()
                .SetOperationTracking(_userFactory.GetCurrentUserId(), _userFactory.GetCurrentUsername())
                .Build();
        }

        // 5. æ‰§è¡Œæ›´æ–°
        var result = await _userFactory.UpdateAsync(existingUser, new OperationContext
        {
            UserId = _userFactory.GetCurrentUserId(),
            Username = _userFactory.GetCurrentUsername(),
            CompanyId = _userFactory.GetCurrentCompanyId(),
            OperationType = OperationType.Update,
            Description = "æ›´æ–°ç”¨æˆ·ä¿¡æ¯"
        });

        // 6. è®°å½•æ“ä½œæ—¥å¿—
        if (result)
        {
            _userFactory.LogOperation("æ›´æ–°ç”¨æˆ·", request.Id, new { 
                Username = request.Username,
                Email = request.Email 
            });
        }

        return result;
    }

    /// <summary>
    /// åˆ é™¤ç”¨æˆ·ï¼ˆè½¯åˆ é™¤ï¼‰
    /// </summary>
    public async Task<bool> DeleteUserAsync(string id)
    {
        // 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
        var user = await _userFactory.GetByIdAsync(id);
        if (user == null)
        {
            throw new KeyNotFoundException($"ç”¨æˆ· {id} ä¸å­˜åœ¨");
        }

        // 2. ä¸šåŠ¡è§„åˆ™æ£€æŸ¥
        await ValidateUserDeletionAsync(user);

        // 3. æ‰§è¡Œè½¯åˆ é™¤
        var result = await _userFactory.SoftDeleteAsync(id, new OperationContext
        {
            UserId = _userFactory.GetCurrentUserId(),
            Username = _userFactory.GetCurrentUsername(),
            CompanyId = _userFactory.GetCurrentCompanyId(),
            OperationType = OperationType.Delete,
            Description = "åˆ é™¤ç”¨æˆ·"
        });

        // 4. è®°å½•æ“ä½œæ—¥å¿—
        if (result)
        {
            _userFactory.LogOperation("åˆ é™¤ç”¨æˆ·", id, new { Username = user.Username });
        }

        return result;
    }

    /// <summary>
    /// æ¿€æ´»ç”¨æˆ·
    /// </summary>
    public async Task<bool> ActivateUserAsync(string id)
    {
        var user = await _userFactory.GetByIdAsync(id);
        if (user == null)
        {
            throw new KeyNotFoundException($"ç”¨æˆ· {id} ä¸å­˜åœ¨");
        }

        if (user.IsActive)
        {
            throw new InvalidOperationException("ç”¨æˆ·å·²ç»æ˜¯æ¿€æ´»çŠ¶æ€");
        }

        var update = _userFactory.CreateUpdateBuilder()
            .Set(u => u.IsActive, true)
            .SetCurrentTimestamp()
            .SetOperationTracking(_userFactory.GetCurrentUserId(), _userFactory.GetCurrentUsername())
            .Build();

        var result = await _userFactory.UpdateAsync(user, new OperationContext
        {
            UserId = _userFactory.GetCurrentUserId(),
            Username = _userFactory.GetCurrentUsername(),
            CompanyId = _userFactory.GetCurrentCompanyId(),
            OperationType = OperationType.Update,
            Description = "æ¿€æ´»ç”¨æˆ·"
        });

        if (result)
        {
            _userFactory.LogOperation("æ¿€æ´»ç”¨æˆ·", id, new { Username = user.Username });
        }

        return result;
    }

    /// <summary>
    /// åœç”¨ç”¨æˆ·
    /// </summary>
    public async Task<bool> DeactivateUserAsync(string id)
    {
        var user = await _userFactory.GetByIdAsync(id);
        if (user == null)
        {
            throw new KeyNotFoundException($"ç”¨æˆ· {id} ä¸å­˜åœ¨");
        }

        if (!user.IsActive)
        {
            throw new InvalidOperationException("ç”¨æˆ·å·²ç»æ˜¯åœç”¨çŠ¶æ€");
        }

        var update = _userFactory.CreateUpdateBuilder()
            .Set(u => u.IsActive, false)
            .SetCurrentTimestamp()
            .SetOperationTracking(_userFactory.GetCurrentUserId(), _userFactory.GetCurrentUsername())
            .Build();

        var result = await _userFactory.UpdateAsync(user, new OperationContext
        {
            UserId = _userFactory.GetCurrentUserId(),
            Username = _userFactory.GetCurrentUsername(),
            CompanyId = _userFactory.GetCurrentCompanyId(),
            OperationType = OperationType.Update,
            Description = "åœç”¨ç”¨æˆ·"
        });

        if (result)
        {
            _userFactory.LogOperation("åœç”¨ç”¨æˆ·", id, new { Username = user.Username });
        }

        return result;
    }

    /// <summary>
    /// é‡ç½®å¯†ç 
    /// </summary>
    public async Task<bool> ResetPasswordAsync(string id, string newPassword)
    {
        var user = await _userFactory.GetByIdAsync(id);
        if (user == null)
        {
            throw new KeyNotFoundException($"ç”¨æˆ· {id} ä¸å­˜åœ¨");
        }

        // éªŒè¯æ–°å¯†ç 
        _validationService.ValidatePassword(newPassword);

        var update = _userFactory.CreateUpdateBuilder()
            .Set(u => u.PasswordHash, _passwordHasher.HashPassword(newPassword))
            .SetCurrentTimestamp()
            .SetOperationTracking(_userFactory.GetCurrentUserId(), _userFactory.GetCurrentUsername())
            .Build();

        var result = await _userFactory.UpdateAsync(user, new OperationContext
        {
            UserId = _userFactory.GetCurrentUserId(),
            Username = _userFactory.GetCurrentUsername(),
            CompanyId = _userFactory.GetCurrentCompanyId(),
            OperationType = OperationType.Update,
            Description = "é‡ç½®å¯†ç "
        });

        if (result)
        {
            _userFactory.LogOperation("é‡ç½®å¯†ç ", id, new { Username = user.Username });
        }

        return result;
    }

    /// <summary>
    /// è·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
    /// </summary>
    public async Task<UserStatistics> GetUserStatisticsAsync()
    {
        var companyId = _userFactory.GetRequiredCompanyId();
        
        var totalUsers = await _userFactory.CountAsync();
        var activeUsers = await _userFactory.CountAsync(
            _userFactory.CreateFilterBuilder()
                .Equal(u => u.IsActive, true)
                .Build()
        );
        var inactiveUsers = totalUsers - activeUsers;

        return new UserStatistics
        {
            TotalUsers = totalUsers,
            ActiveUsers = activeUsers,
            InactiveUsers = inactiveUsers,
            CompanyId = companyId,
            GeneratedAt = DateTime.UtcNow
        };
    }

    // ç§æœ‰éªŒè¯æ–¹æ³•
    private async Task ValidateCreateUserRequestAsync(CreateUserRequest request)
    {
        if (string.IsNullOrEmpty(request.Username))
            throw new ArgumentException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");

        if (string.IsNullOrEmpty(request.Email))
            throw new ArgumentException("é‚®ç®±ä¸èƒ½ä¸ºç©º");

        if (string.IsNullOrEmpty(request.Password))
            throw new ArgumentException("å¯†ç ä¸èƒ½ä¸ºç©º");

        _validationService.ValidateUsername(request.Username);
        _validationService.ValidateEmail(request.Email);
        _validationService.ValidatePassword(request.Password);
    }

    private async Task ValidateUpdateUserRequestAsync(UpdateUserRequest request, User existingUser)
    {
        if (string.IsNullOrEmpty(request.Username) && string.IsNullOrEmpty(request.Email))
            throw new ArgumentException("è‡³å°‘éœ€è¦æ›´æ–°ä¸€ä¸ªå­—æ®µ");

        if (!string.IsNullOrEmpty(request.Username))
        {
            _validationService.ValidateUsername(request.Username);
        }

        if (!string.IsNullOrEmpty(request.Email))
        {
            _validationService.ValidateEmail(request.Email);
        }
    }

    private async Task ValidateUserDeletionAsync(User user)
    {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰å…³è”æ•°æ®
        var hasActivityLogs = await _activityLogs.CountDocumentsAsync(
            Builders<UserActivityLog>.Filter.Eq(al => al.UserId, user.Id)
        ) > 0;

        if (hasActivityLogs)
        {
            throw new InvalidOperationException("ç”¨æˆ·æœ‰æ´»åŠ¨è®°å½•ï¼Œæ— æ³•åˆ é™¤");
        }

        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ä¼ä¸šç®¡ç†å‘˜
        var isAdmin = await _userCompanies.CountDocumentsAsync(
            Builders<UserCompany>.Filter.And(
                Builders<UserCompany>.Filter.Eq(uc => uc.UserId, user.Id),
                Builders<UserCompany>.Filter.Eq(uc => uc.IsAdmin, true)
            )
        ) > 0;

        if (isAdmin)
        {
            throw new InvalidOperationException("ä¼ä¸šç®¡ç†å‘˜æ— æ³•åˆ é™¤");
        }
    }
}
```

## ğŸ¯ ä¸šåŠ¡è§„åˆ™ç®¡ç†

### ä¸šåŠ¡è§„åˆ™æœåŠ¡

```csharp
// Platform.ApiService/Services/BusinessRuleService.cs
public interface IBusinessRuleService
{
    Task<bool> ValidateUserCreationAsync(CreateUserRequest request);
    Task<bool> ValidateUserUpdateAsync(UpdateUserRequest request, User existingUser);
    Task<bool> ValidateUserDeletionAsync(User user);
    Task<bool> ValidateRoleAssignmentAsync(string userId, string roleId);
    Task<bool> ValidateCompanyJoinRequestAsync(CompanyJoinRequest request);
}

public class BusinessRuleService : IBusinessRuleService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    private readonly IDatabaseOperationFactory<Role> _roleFactory;
    private readonly IDatabaseOperationFactory<Company> _companyFactory;

    public BusinessRuleService(
        IDatabaseOperationFactory<User> userFactory,
        IDatabaseOperationFactory<Role> roleFactory,
        IDatabaseOperationFactory<Company> companyFactory)
    {
        _userFactory = userFactory;
        _roleFactory = roleFactory;
        _companyFactory = companyFactory;
    }

    public async Task<bool> ValidateUserCreationAsync(CreateUserRequest request)
    {
        // ä¸šåŠ¡è§„åˆ™1ï¼šç”¨æˆ·åé•¿åº¦é™åˆ¶
        if (request.Username.Length < 3 || request.Username.Length > 50)
        {
            throw new ArgumentException("ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¸ªå­—ç¬¦ä¹‹é—´");
        }

        // ä¸šåŠ¡è§„åˆ™2ï¼šé‚®ç®±æ ¼å¼éªŒè¯
        if (!IsValidEmail(request.Email))
        {
            throw new ArgumentException("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®");
        }

        // ä¸šåŠ¡è§„åˆ™3ï¼šå¯†ç å¼ºåº¦è¦æ±‚
        if (!IsStrongPassword(request.Password))
        {
            throw new ArgumentException("å¯†ç å¿…é¡»åŒ…å«å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦ï¼Œé•¿åº¦è‡³å°‘8ä½");
        }

        // ä¸šåŠ¡è§„åˆ™4ï¼šä¼ä¸šç”¨æˆ·æ•°é‡é™åˆ¶
        var userCount = await _userFactory.CountAsync();
        if (userCount >= 1000) // å‡è®¾ä¼ä¸šæœ€å¤š1000ä¸ªç”¨æˆ·
        {
            throw new InvalidOperationException("ä¼ä¸šç”¨æˆ·æ•°é‡å·²è¾¾ä¸Šé™");
        }

        return true;
    }

    public async Task<bool> ValidateUserUpdateAsync(UpdateUserRequest request, User existingUser)
    {
        // ä¸šåŠ¡è§„åˆ™1ï¼šä¸èƒ½ä¿®æ”¹å·²åˆ é™¤ç”¨æˆ·
        if (existingUser.IsDeleted)
        {
            throw new InvalidOperationException("æ— æ³•ä¿®æ”¹å·²åˆ é™¤çš„ç”¨æˆ·");
        }

        // ä¸šåŠ¡è§„åˆ™2ï¼šä¸èƒ½ä¿®æ”¹å·²åœç”¨ç”¨æˆ·ï¼ˆé™¤éæ˜¯æ¿€æ´»æ“ä½œï¼‰
        if (!existingUser.IsActive && !string.IsNullOrEmpty(request.Username))
        {
            throw new InvalidOperationException("æ— æ³•ä¿®æ”¹å·²åœç”¨ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯");
        }

        return true;
    }

    public async Task<bool> ValidateUserDeletionAsync(User user)
    {
        // ä¸šåŠ¡è§„åˆ™1ï¼šä¸èƒ½åˆ é™¤ä¼ä¸šç®¡ç†å‘˜
        if (user.IsAdmin)
        {
            throw new InvalidOperationException("æ— æ³•åˆ é™¤ä¼ä¸šç®¡ç†å‘˜");
        }

        // ä¸šåŠ¡è§„åˆ™2ï¼šä¸èƒ½åˆ é™¤æœ‰æ´»è·ƒä¼šè¯çš„ç”¨æˆ·
        if (user.LastLoginAt.HasValue && user.LastLoginAt.Value > DateTime.UtcNow.AddHours(-1))
        {
            throw new InvalidOperationException("æ— æ³•åˆ é™¤æœ‰æ´»è·ƒä¼šè¯çš„ç”¨æˆ·");
        }

        return true;
    }

    private bool IsValidEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }

    private bool IsStrongPassword(string password)
    {
        if (string.IsNullOrEmpty(password) || password.Length < 8)
            return false;

        var hasLetter = password.Any(char.IsLetter);
        var hasDigit = password.Any(char.IsDigit);
        var hasSpecialChar = password.Any(c => !char.IsLetterOrDigit(c));

        return hasLetter && hasDigit && hasSpecialChar;
    }
}
```

## ğŸ¯ äº‹åŠ¡å¤„ç†

### MongoDB äº‹åŠ¡æ”¯æŒ

```csharp
// Platform.ApiService/Services/UserService.cs
public async Task<User> CreateUserWithRoleAsync(CreateUserWithRoleRequest request)
{
    if (request == null)
        throw new ArgumentNullException(nameof(request));

    using var session = await _mongoDatabase.Client.StartSessionAsync();
    
    try
    {
        session.StartTransaction();

        // 1. åˆ›å»ºç”¨æˆ·
        var user = new User
        {
            Username = request.Username,
            Email = request.Email,
            PasswordHash = _passwordHasher.HashPassword(request.Password),
            CompanyId = _userFactory.GetRequiredCompanyId(),
            IsActive = true,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        };

        var createdUser = await _userFactory.CreateAsync(user);

        // 2. åˆ†é…è§’è‰²
        if (!string.IsNullOrEmpty(request.RoleId))
        {
            var role = await _roleFactory.GetByIdAsync(request.RoleId);
            if (role == null)
                throw new KeyNotFoundException($"è§’è‰² {request.RoleId} ä¸å­˜åœ¨");

            var userUpdate = _userFactory.CreateUpdateBuilder()
                .Set(u => u.RoleId, request.RoleId)
                .SetCurrentTimestamp()
                .Build();

            await _userFactory.UpdateAsync(createdUser);
            createdUser.RoleId = request.RoleId;
        }

        await session.CommitTransactionAsync();
        
        _logger.LogInformation("åˆ›å»ºç”¨æˆ·å¹¶åˆ†é…è§’è‰²æˆåŠŸ: {UserId}", createdUser.Id);
        return createdUser;
    }
    catch (Exception ex)
    {
        await session.AbortTransactionAsync();
        _logger.LogError(ex, "åˆ›å»ºç”¨æˆ·å¹¶åˆ†é…è§’è‰²å¤±è´¥, ç”¨æˆ·å: {Username}", request.Username);
        throw;
    }
}
```

## ğŸ¯ æœåŠ¡ç»„åˆå’Œç¼–æ’

### æœåŠ¡ç¼–æ’å™¨

```csharp
// Platform.ApiService/Services/ServiceOrchestrator.cs
public interface IServiceOrchestrator
{
    Task<User> CreateUserWithRoleAsync(CreateUserWithRoleRequest request);
    Task<bool> TransferUserToCompanyAsync(string userId, string targetCompanyId);
    Task<bool> BulkUpdateUsersAsync(BulkUpdateUsersRequest request);
}

public class ServiceOrchestrator : IServiceOrchestrator
{
    private readonly IUserService _userService;
    private readonly IRoleService _roleService;
    private readonly IUserCompanyService _userCompanyService;
    private readonly ICompanyService _companyService;

    public ServiceOrchestrator(
        IUserService userService,
        IRoleService roleService,
        IUserCompanyService userCompanyService,
        ICompanyService companyService)
    {
        _userService = userService;
        _roleService = roleService;
        _userCompanyService = userCompanyService;
        _companyService = companyService;
    }

    public async Task<User> CreateUserWithRoleAsync(CreateUserWithRoleRequest request)
    {
        // 1. åˆ›å»ºç”¨æˆ·
        var user = await _userService.CreateUserAsync(request.UserRequest);
        
        // 2. åˆ†é…è§’è‰²
        if (!string.IsNullOrEmpty(request.RoleId))
        {
            await _userCompanyService.AssignRoleAsync(user.Id, request.RoleId);
        }
        
        // 3. è®¾ç½®ä¼ä¸šå…³è”
        if (!string.IsNullOrEmpty(request.CompanyId))
        {
            await _userCompanyService.AddUserToCompanyAsync(user.Id, request.CompanyId);
        }
        
        return user;
    }

    public async Task<bool> TransferUserToCompanyAsync(string userId, string targetCompanyId)
    {
        // 1. éªŒè¯ç›®æ ‡ä¼ä¸šå­˜åœ¨
        var targetCompany = await _companyService.GetCompanyByIdAsync(targetCompanyId);
        if (targetCompany == null)
        {
            throw new KeyNotFoundException($"ç›®æ ‡ä¼ä¸š {targetCompanyId} ä¸å­˜åœ¨");
        }

        // 2. è·å–ç”¨æˆ·å½“å‰ä¼ä¸š
        var userCompany = await _userCompanyService.GetUserCompanyAsync(userId);
        if (userCompany == null)
        {
            throw new KeyNotFoundException($"ç”¨æˆ· {userId} çš„ä¼ä¸šå…³è”ä¸å­˜åœ¨");
        }

        // 3. ç§»é™¤ç”¨æˆ·ä»å½“å‰ä¼ä¸š
        await _userCompanyService.RemoveUserFromCompanyAsync(userId, userCompany.CompanyId);
        
        // 4. æ·»åŠ ç”¨æˆ·åˆ°ç›®æ ‡ä¼ä¸š
        await _userCompanyService.AddUserToCompanyAsync(userId, targetCompanyId);
        
        // 5. æ›´æ–°ç”¨æˆ·çš„ä¼ä¸šID
        var user = await _userService.GetUserByIdAsync(userId);
        if (user != null)
        {
            user.CompanyId = targetCompanyId;
            await _userService.UpdateUserAsync(new UpdateUserRequest { Id = userId });
        }

        return true;
    }

    public async Task<bool> BulkUpdateUsersAsync(BulkUpdateUsersRequest request)
    {
        var results = new List<bool>();
        
        foreach (var userId in request.UserIds)
        {
            try
            {
                var updateRequest = new UpdateUserRequest
                {
                    Id = userId,
                    Username = request.Username,
                    Email = request.Email
                };
                
                var result = await _userService.UpdateUserAsync(updateRequest);
                results.Add(result);
            }
            catch (Exception ex)
            {
                // è®°å½•é”™è¯¯ä½†ç»§ç»­å¤„ç†å…¶ä»–ç”¨æˆ·
                _logger.LogError(ex, "æ‰¹é‡æ›´æ–°ç”¨æˆ· {UserId} å¤±è´¥", userId);
                results.Add(false);
            }
        }

        return results.All(r => r);
    }
}
```

## ğŸš« ç¦æ­¢çš„åšæ³•

### ä¸è¦åœ¨æœåŠ¡ä¸­ç›´æ¥æ“ä½œæ•°æ®åº“

```csharp
// âŒ é”™è¯¯ - ç›´æ¥æ“ä½œæ•°æ®åº“
public class UserService
{
    private readonly IMongoCollection<User> _users;
    
    public async Task<User> CreateUserAsync(User user)
    {
        await _users.InsertOneAsync(user); // ç›´æ¥æ“ä½œæ•°æ®åº“
        return user;
    }
}

// âœ… æ­£ç¡® - ä½¿ç”¨æ•°æ®åº“æ“ä½œå·¥å‚
public class UserService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    
    public async Task<User> CreateUserAsync(User user)
    {
        return await _userFactory.CreateAsync(user); // ä½¿ç”¨å·¥å‚
    }
}
```

### ä¸è¦å¿½ç•¥ä¸šåŠ¡è§„åˆ™éªŒè¯

```csharp
// âŒ é”™è¯¯ - æ²¡æœ‰ä¸šåŠ¡è§„åˆ™éªŒè¯
public async Task<User> CreateUserAsync(CreateUserRequest request)
{
    var user = new User { Username = request.Username };
    return await _userFactory.CreateAsync(user); // æ²¡æœ‰éªŒè¯
}

// âœ… æ­£ç¡® - å®Œæ•´çš„ä¸šåŠ¡è§„åˆ™éªŒè¯
public async Task<User> CreateUserAsync(CreateUserRequest request)
{
    await ValidateCreateUserRequestAsync(request); // ä¸šåŠ¡è§„åˆ™éªŒè¯
    await _uniquenessChecker.EnsureUniqueAsync<User>(u => u.Username, request.Username);
    
    var user = new User { Username = request.Username };
    return await _userFactory.CreateAsync(user);
}
```

### ä¸è¦å¿½ç•¥å¼‚å¸¸å¤„ç†

```csharp
// âŒ é”™è¯¯ - æ²¡æœ‰å¼‚å¸¸å¤„ç†
public async Task<User> GetUserByIdAsync(string id)
{
    return await _userFactory.GetByIdAsync(id); // å¯èƒ½è¿”å›null
}

// âœ… æ­£ç¡® - é€‚å½“çš„å¼‚å¸¸å¤„ç†
public async Task<User> GetUserByIdAsync(string id)
{
    var user = await _userFactory.GetByIdAsync(id);
    if (user == null)
    {
        throw new KeyNotFoundException($"ç”¨æˆ· {id} ä¸å­˜åœ¨");
    }
    return user;
}
```

## ğŸ“‹ æœåŠ¡å±‚å¼€å‘æ£€æŸ¥æ¸…å•

åˆ›å»ºæˆ–ä¿®æ”¹æœåŠ¡æ—¶æ£€æŸ¥ï¼š

- [ ] **å®šä¹‰æ¸…æ™°çš„æ¥å£** - å®ç°å¯¹åº”çš„æœåŠ¡æ¥å£ï¼ˆIUserService ç­‰ï¼‰
- [ ] **å®ç°å•ä¸€èŒè´£åŸåˆ™** - æ¯ä¸ªæœåŠ¡åªè´Ÿè´£ä¸€ä¸ªä¸šåŠ¡é¢†åŸŸ
- [ ] **æ·»åŠ ä¸šåŠ¡è§„åˆ™éªŒè¯** - ä½¿ç”¨éªŒè¯æœåŠ¡å’Œå”¯ä¸€æ€§æ£€æŸ¥å™¨
- [ ] **ä½¿ç”¨æ•°æ®åº“æ“ä½œå·¥å‚** - ä½¿ç”¨ IDatabaseOperationFactoryï¼Œç¦æ­¢ç›´æ¥ä½¿ç”¨ IMongoCollection
- [ ] **æ·»åŠ é€‚å½“çš„å¼‚å¸¸å¤„ç†** - ä½¿ç”¨æ ‡å‡†å¼‚å¸¸ç±»å‹ï¼Œè®°å½•é”™è¯¯æ—¥å¿—
- [ ] **è®°å½•æ“ä½œæ—¥å¿—** - ä½¿ç”¨å·¥å‚çš„æ—¥å¿—æ–¹æ³•è®°å½•å…³é”®æ“ä½œ
- [ ] **ä½¿ç”¨äº‹åŠ¡å¤„ç†** - å¤æ‚æ“ä½œä½¿ç”¨ MongoDB äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§
- [ ] **æ·»åŠ å•å…ƒæµ‹è¯•** - ç¡®ä¿ä¸šåŠ¡é€»è¾‘æ­£ç¡®æ€§
- [ ] **æ–‡æ¡£åŒ–ä¸šåŠ¡è§„åˆ™** - åœ¨ä»£ç ä¸­æ³¨é‡Šä¸šåŠ¡è§„åˆ™
- [ ] **è€ƒè™‘æ€§èƒ½å½±å“** - ä½¿ç”¨æ‰¹é‡æ“ä½œå’ŒæŸ¥è¯¢ä¼˜åŒ–
- [ ] **éªŒè¯è¾“å…¥å‚æ•°** - ä½¿ç”¨éªŒè¯æ‰©å±•æ–¹æ³•ç¡®ä¿å‚æ•°æœ‰æ•ˆæ€§

## ğŸš« ç¦æ­¢çš„åšæ³•

### âŒ ä¸è¦ä½¿ç”¨å·²åºŸå¼ƒçš„ BaseService

```csharp
// âŒ é”™è¯¯ï¼šBaseService å·²ç§»é™¤
public class UserService : BaseService, IUserService
{
    // BaseService å·²ä¸å†å­˜åœ¨
}

// âœ… æ­£ç¡®ï¼šç›´æ¥å®ç°æ¥å£ï¼Œæ³¨å…¥ä¾èµ–
public class UserService : IUserService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    private readonly ILogger<UserService> _logger;
    
    public UserService(
        IDatabaseOperationFactory<User> userFactory,
        ILogger<UserService> logger)
    {
        _userFactory = userFactory;
        _logger = logger;
    }
}
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç”¨æˆ·æœåŠ¡å®ç°](mdc:Platform.ApiService/Services/UserService.cs)
- [è§’è‰²æœåŠ¡å®ç°](mdc:Platform.ApiService/Services/RoleService.cs)
- [ä¼ä¸šæœåŠ¡å®ç°](mdc:Platform.ApiService/Services/CompanyService.cs)
- [æ•°æ®åº“æ“ä½œå·¥å‚ä½¿ç”¨æŒ‡å—](mdc:docs/features/DATABASE-OPERATION-FACTORY-GUIDE.md)
