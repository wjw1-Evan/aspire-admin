---
alwaysApply: true
description: åç«¯æ ¸å¿ƒå¼€å‘è§„èŒƒï¼ˆæ§åˆ¶å™¨ã€æ•°æ®è®¿é—®ã€å¤šç§Ÿæˆ·ã€å…¨å±€èœå•ã€æ•°æ®åˆå§‹åŒ–ï¼‰
globs: Platform.ApiService/**/*.cs,Platform.DataInitializer/**/*.cs,Platform.ServiceDefaults/**/*.cs
---

# åç«¯æ ¸å¿ƒå¼€å‘è§„èŒƒ

æœ¬è§„åˆ™æ•´åˆäº†åŸæœ‰çš„ `baseapicontroller-standard`ã€`backend-data-access`ã€`multi-tenant-development`ã€`no-global-data`ã€`global-menu-architecture`ã€`database-initialization` ç­‰æ–‡ä»¶çš„å†…å®¹ï¼Œç”¨äºç»Ÿä¸€æŒ‡å¯¼åç«¯ä»£ç çš„ç¼–å†™ã€‚æ‰€æœ‰å†…å®¹å‡é€‚ç”¨äº `Platform.ApiService`ã€`Platform.DataInitializer` ä¸ `Platform.ServiceDefaults` ç›®å½•å†…çš„ C# ä»£ç ã€‚

> âœ… **è‹¥éœ€è¦æ›´è¯¦ç»†çš„èƒŒæ™¯è¯´æ˜æˆ–å†å²è®°å½•ï¼Œè¯·å‚é˜…** `docs/features/` ä¸ `docs/reports/` ä¸­å¯¹åº”æ–‡æ¡£ã€‚

---

## 1. æ§åˆ¶å™¨è§„èŒƒï¼ˆBaseApiControllerï¼‰

- **æ‰€æœ‰ API æ§åˆ¶å™¨å¿…é¡»ç»§æ‰¿ `BaseApiController`**ï¼Œç¦æ­¢ç›´æ¥ç»§æ‰¿ `ControllerBase`ã€‚
- ç»Ÿä¸€é€šè¿‡åŸºç±»æ–¹æ³•å¤„ç†å“åº”ï¼š`Success()`ã€`SuccessResponse()`ã€`Error()` ç­‰ã€‚
- å¿…é¡»ä½¿ç”¨ `GetRequiredUserId()` ç­‰å®‰å…¨æ–¹æ³•è®¿é—®å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼›ä¸è¦æ‰‹åŠ¨è§£æ `HttpContext` æˆ– `User.Claims`ã€‚
- éµå¾ªå¼‚å¸¸å³é€»è¾‘ï¼šä¸šåŠ¡æ ¡éªŒå¤±è´¥ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œç”± `UseExceptionHandler()` + `ProblemDetails` ç®¡é“ç»Ÿä¸€å¤„ç†ï¼Œç¦æ­¢åœ¨æ§åˆ¶å™¨ä¸­æ‰‹åŠ¨ `try-catch` è¿”å›é”™è¯¯ã€‚
- åˆç†ä½¿ç”¨ `[Authorize]`ã€`[AllowAnonymous]`ã€`[Authorize(Roles = "...")]` æ§åˆ¶è®¿é—®ï¼›åŸºç±»å·²æä¾› `IsAdmin`ã€`CurrentUserId` ç­‰å±æ€§ã€‚

```csharp
[ApiController]
[Route("api/[controller]")]
[Authorize]
public class UserController : BaseApiController
{
    private readonly IUserService _userService;

    public UserController(IUserService userService)
    {
        _userService = userService;
    }

    [HttpGet("{id}")]
    public async Task<IActionResult> GetById(string id)
    {
        var user = await _userService.GetUserByIdAsync(id)
            ?? throw new KeyNotFoundException($"ç”¨æˆ· {id} ä¸å­˜åœ¨");

        return Success(user);
    }
}
```

---

## 2. æ•°æ®è®¿é—®å±‚è§„èŒƒï¼ˆDatabaseOperationFactoryï¼‰

- **æ‰€æœ‰æ•°æ®åº“æ“ä½œå¿…é¡»é€šè¿‡ `IDatabaseOperationFactory<T>` å®Œæˆ**ï¼Œç¦æ­¢ç›´æ¥ä½¿ç”¨ `IMongoCollection<T>` æˆ–æ—§çš„ `BaseRepository<T>`ã€‚
- **è¿‡æ»¤å™¨æ„å»º**ï¼šå¯¹äºç®€å•æŸ¥è¯¢ï¼Œç›´æ¥ä½¿ç”¨ `Builders<T>.Filter`ï¼›å¯¹äºå¤æ‚æŸ¥è¯¢ï¼Œä½¿ç”¨ `CreateFilterBuilder()` ä¿æŒç±»å‹å®‰å…¨å’Œå¯è¯»æ€§ã€‚
- **æ’åºæ„å»º**ï¼šå¯¹äºç®€å•æ’åºï¼Œç›´æ¥ä½¿ç”¨ `Builders<T>.Sort`ï¼›å¯¹äºå¤æ‚æ’åºï¼Œä½¿ç”¨ `CreateSortBuilder()`ã€‚
- **æ›´æ–°æ„å»º**ï¼šä½¿ç”¨ `CreateUpdateBuilder()` æ„å»ºæ›´æ–°æ“ä½œï¼Œä¿æŒç±»å‹å®‰å…¨ã€‚
- **æŠ•å½±æ„å»º**ï¼šä½¿ç”¨ `CreateProjectionBuilder()` æ„å»ºå­—æ®µæŠ•å½±ï¼Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ã€‚
- å·¥å‚ä¼šè‡ªåŠ¨å¤„ç†ï¼š
  - å¤šç§Ÿæˆ·è¿‡æ»¤ï¼ˆé’ˆå¯¹å®ç° `IMultiTenant` çš„å®ä½“ï¼‰ã€‚
  - è½¯åˆ é™¤æ ‡è®°ä¸æŸ¥è¯¢æ’é™¤ã€‚
  - å®¡è®¡å­—æ®µï¼ˆ`CreatedAt/By`ã€`UpdatedAt/By`ã€`DeletedAt/By`ï¼‰ã€‚
- æ›´æ–°æ“ä½œåªè®¾ç½®ä¸šåŠ¡å­—æ®µï¼Œ**ä¸è¦**æ‰‹åŠ¨è°ƒç”¨ `SetCurrentTimestamp()` æˆ–è®¾ç½®å®¡è®¡å­—æ®µã€‚
- æ‰¹é‡æ“ä½œä½¿ç”¨ `CreateManyAsync`ã€`UpdateManyAsync`ã€`SoftDeleteManyAsync` ç­‰æ–¹æ³•ã€‚

### ç®€å•æŸ¥è¯¢ç¤ºä¾‹ï¼ˆæ¨èï¼‰

```csharp
// âœ… ç®€å•è¿‡æ»¤å™¨ï¼šç›´æ¥ä½¿ç”¨ Builders<T>.Filter
var filter = Builders<T>.Filter.And(
    Builders<T>.Filter.Eq(u => u.Id, id),
    Builders<T>.Filter.Eq(u => u.IsDeleted, false)
);

// âœ… ç®€å•æ’åºï¼šç›´æ¥ä½¿ç”¨ Builders<T>.Sort
var sort = Builders<T>.Sort.Descending(u => u.CreatedAt);

var (items, total) = await _userFactory.FindPagedAsync(filter, sort, request.Page, request.PageSize);
```

### å¤æ‚æŸ¥è¯¢ç¤ºä¾‹ï¼ˆä½¿ç”¨æ„å»ºå™¨ï¼‰

```csharp
// âœ… å¤æ‚è¿‡æ»¤å™¨ï¼šä½¿ç”¨ CreateFilterBuilder() æä¾›æ›´å¥½çš„å¯è¯»æ€§å’Œç±»å‹å®‰å…¨
var filter = _userFactory.CreateFilterBuilder()
    .Regex(u => u.Username, request.Keyword)
    .EqualIfHasValue(u => u.IsActive, request.IsActive)
    .Build();

// âœ… å¤æ‚æ’åºï¼šä½¿ç”¨ CreateSortBuilder()
var sort = _userFactory.CreateSortBuilder()
    .Descending(u => u.CreatedAt)
    .ThenAscending(u => u.Username)
    .Build();

var (items, total) = await _userFactory.FindPagedAsync(filter, sort, request.Page, request.PageSize);
```

### è®¾è®¡åŸåˆ™

- **ç®€æ´ä¼˜å…ˆ**ï¼šå¯¹äºç®€å•æŸ¥è¯¢ï¼Œç›´æ¥ä½¿ç”¨ `Builders<T>` æ–¹æ³•ï¼Œå‡å°‘ä¸å¿…è¦çš„æŠ½è±¡å±‚ã€‚
- **ç±»å‹å®‰å…¨**ï¼šå¯¹äºå¤æ‚æŸ¥è¯¢ï¼Œä½¿ç”¨æ„å»ºå™¨æ–¹æ³•ä¿æŒç±»å‹å®‰å…¨å’Œå¯è¯»æ€§ã€‚
- **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨æŠ•å½±å‡å°‘æ•°æ®ä¼ è¾“ï¼Œä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ã€‚

---

## 3. å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»

- `IDatabaseOperationFactory` ä¼šå¯¹å®ç° `IMultiTenant` çš„å®ä½“è‡ªåŠ¨è¿½åŠ ä¼ä¸šè¿‡æ»¤ï¼Œ**ç¦æ­¢æ‰‹åŠ¨æ·»åŠ  `CompanyId` æ¡ä»¶**ã€‚
- å¯¹äºæœªå®ç° `IMultiTenant` çš„å®ä½“ï¼ˆå¦‚ `AppUser`ï¼‰ï¼Œå¿…é¡»æ‰‹åŠ¨æŒ‰ç…§è§„èŒƒè¿‡æ»¤ï¼š
  - é€šè¿‡ `_factory.GetRequiredUserId()` å’Œ `_factory.GetByIdAsync()` è·å–å½“å‰ç”¨æˆ·ä¸ `CurrentCompanyId`ã€‚
  - åˆ›å»ºå®ä½“æ—¶ä½¿ç”¨ `_factory.GetRequiredCompanyId()` è®¾ç½® `CompanyId`ã€‚
- è·¨ç§Ÿæˆ·åœºæ™¯ä½¿ç”¨ `FindWithoutTenantFilterAsync` / `GetByIdWithoutTenantFilterAsync`ï¼Œå¹¶è®°å½•ä½¿ç”¨åŸå› ã€‚
- åå°çº¿ç¨‹ï¼ˆå¦‚é˜Ÿåˆ—ã€å®šæ—¶ä»»åŠ¡ï¼‰ä¸å¯ä¾èµ– `HttpContext`ï¼Œéœ€è¦é€šè¿‡ç”¨æˆ·è®°å½•æŸ¥è¯¢ä¼ä¸šä¿¡æ¯ã€‚
- å¼€å‘æ–°å®ä½“æ—¶éµå¾ª [æ–°å¢ä¸šåŠ¡å®ä½“å¼€å‘æ¸…å•](mdc:.cursor/rules/new-entity-checklist.mdc)ï¼šç»§æ‰¿æ­£ç¡®çš„åŸºç±»ã€è®¾ç½® `CompanyId`ã€æä¾›ç´¢å¼•ä¸å®¡è®¡ã€‚

### ç¦æ­¢çš„åšæ³•

- åœ¨å¤šç§Ÿæˆ·å®ä½“æŸ¥è¯¢ä¸­æ‰‹å†™ `CompanyId == ...`ã€‚
- åœ¨åå°çº¿ç¨‹ä¸­ä½¿ç”¨ `ITenantContext` æˆ– `IHttpContextAccessor` è·å–ç§Ÿæˆ·ä¿¡æ¯ã€‚
- åˆ›å»ºç¼ºå°‘ `CompanyId` çš„ä¸šåŠ¡æ•°æ®ï¼ˆèœå•é™¤å¤–ï¼‰ã€‚

---

## 4. å…¨å±€èœå•æ¶æ„

- `Menu` æ˜¯å…¨å±€ç³»ç»Ÿèµ„æºï¼Œä¸å®ç° `IMultiTenant`ï¼Œä¹Ÿ **æ²¡æœ‰ `CompanyId` å­—æ®µ**ã€‚
- èœå•åœ¨ `Platform.DataInitializer` ä¸­ç»Ÿä¸€åˆ›å»ºï¼Œç”¨æˆ·ä¸èƒ½æ–°å¢/ä¿®æ”¹/åˆ é™¤èœå•ï¼›ä¸šåŠ¡ä¾§åªåœ¨è§’è‰²ä¸­å¼•ç”¨èœå• IDã€‚
- å‰ç«¯ 100% ä» API è¿”å›çš„èœå•æ ‘æ¸²æŸ“ï¼Œç¦æ­¢å›é€€åˆ° `routes.ts` é™æ€èœå•ã€‚é™æ€è·¯ç”±ä»…ç”¨äº `path -> component` æ˜ å°„ï¼Œåº”è®¾ç½® `hideInMenu: true`ã€‚
- API å±‚ä¸æä¾›èœå• CRUD ç«¯ç‚¹ï¼Œä»…æä¾›æŸ¥è¯¢å½“å‰ç”¨æˆ·å¯è§èœå•ã€‚
- `Role.MenuIds` å­˜å‚¨å¯è®¿é—®èœå•ï¼Œ`PermissionIds` æ§åˆ¶æŒ‰é’®çº§æƒé™ï¼›è§’è‰²ç­‰å®ä½“å¿…é¡»åŒ…å« `CompanyId`ã€‚

---

## 5. æ•°æ®åˆå§‹åŒ–å¾®æœåŠ¡

- `Platform.DataInitializer` æ˜¯å•å®ä¾‹è¿è¡Œçš„å¾®æœåŠ¡ï¼šè´Ÿè´£ç´¢å¼•åˆ›å»ºã€å…¨å±€èœå•ç”Ÿæˆã€ç³»ç»Ÿçº§æ•°æ®åˆå§‹åŒ–ï¼Œå®Œæˆåè‡ªåŠ¨åœæ­¢ã€‚
- **ç¦æ­¢** åœ¨ `Platform.ApiService` å¯åŠ¨æµç¨‹ä¸­å†åˆå§‹åŒ–æ•°æ®åº“æˆ–åˆ›å»ºå…¨å±€æ•°æ®ã€‚
- åˆå§‹åŒ–é€»è¾‘å¿…é¡»å…·å¤‡å¹‚ç­‰æ€§ï¼šé‡å¤æ‰§è¡Œä¸ä¼šäº§ç”Ÿå†²çªæˆ–é‡å¤æ•°æ®ã€‚
- éœ€è¦æ—¶å¯ä»¥æä¾›æ‰‹åŠ¨è§¦å‘ç«¯ç‚¹ï¼ˆå¦‚ `/initialize`ï¼‰ã€å¥åº·æ£€æŸ¥ `/health`ï¼Œå¹¶åœ¨ Aspire Dashboard ä¸­è§‚å¯Ÿæ‰§è¡Œç»“æœã€‚
- æ‰€æœ‰åˆå§‹åŒ–æ“ä½œåº”ä½¿ç”¨ `IDatabaseOperationFactory` æˆ–å®˜æ–¹ Mongo åŸå­æ“ä½œï¼Œé¿å…â€œæŸ¥è¯¢ååˆ¤æ–­å†å†™å…¥â€çš„ç«æ€ã€‚

---

## 6. å®¡è®¡ä¸æ—¶é—´æˆ³

- `CreateAsync` / `UpdateAsync` / `SoftDeleteAsync` ç­‰æ–¹æ³•ä¼šè‡ªåŠ¨å¡«å…… `CreatedAt/By`ã€`UpdatedAt/By`ã€`DeletedAt/By` å­—æ®µã€‚
- æ›´æ–°æ“ä½œ**ä»…**è®¾ç½®ä¸šåŠ¡å­—æ®µï¼Œä¾‹å¦‚ `IsActive`ã€`RoleIds`ï¼Œä¸è¦æ‰‹åŠ¨è®¾ç½®æ—¶é—´æˆ³æˆ–å®¡è®¡ä¿¡æ¯ã€‚
- å¦‚æœéœ€è¦åœ¨åå°è®°å½•æ“ä½œä¸Šä¸‹æ–‡ï¼Œè¯·ä½¿ç”¨ `CreateOperationContext()` æ„é€ å®¡è®¡ä¸Šä¸‹æ–‡ã€‚

---

## 7. å¸¸è§æ£€æŸ¥æ¸…å•

| åœºæ™¯ | å¿…é¡»éµå¾ªçš„è§„èŒƒ |
|------|----------------|
| åˆ›å»ºæ§åˆ¶å™¨ | ç»§æ‰¿ `BaseApiController`ï¼ŒæŠ›å¼‚å¸¸äº¤ç»™ä¸­é—´ä»¶ï¼Œä½¿ç”¨åŸºç±»å“åº”æ–¹æ³• |
| ä¸šåŠ¡æœåŠ¡ | é€šè¿‡ `IDatabaseOperationFactory` è®¿é—®æ•°æ®åº“ï¼Œå†™å•å…ƒæµ‹è¯•è¦†ç›–å¤šç§Ÿæˆ·è¿‡æ»¤ |
| æ–°å®ä½“è®¾è®¡ | é€‰æ‹©åˆé€‚åŸºç±»ï¼Œç¡®ä¿ `CompanyId`/`CurrentCompanyId` è®¾ç½®æ­£ç¡®ï¼Œç¼–å†™ç´¢å¼•ï¼Œè¡¥å……å‰ç«¯/æ–‡æ¡£ |
| èœå•/æƒé™ | ä»…ä¿®æ”¹è§’è‰²ä¸æƒé™é›†åˆï¼Œä¸æä¾›èœå• CRUDï¼›å‰ç«¯ä» API æ¸²æŸ“åŠ¨æ€èœå• |
| åˆå§‹åŒ–é€»è¾‘ | æ”¾åœ¨ `Platform.DataInitializer`ï¼Œä¿è¯å¹‚ç­‰ä¸”è‡ªåŠ¨åœæ­¢ï¼Œç¦æ­¢å¤šå®ä¾‹è¿è¡Œ |

---

## 8. ç¦æ­¢äº‹é¡¹é€ŸæŸ¥

- âŒ ç›´æ¥æ“ä½œ `IMongoCollection<T>` æˆ–é—ç•™çš„ `BaseRepository<T>`ã€‚
- âŒ åœ¨å®ç° `IMultiTenant` çš„æŸ¥è¯¢ä¸­æ‰‹å†™ `CompanyId` æ¡ä»¶ã€‚
- âŒ åœ¨åå°çº¿ç¨‹ä½¿ç”¨ `HttpContext`/`ITenantContext` è·å–ç§Ÿæˆ·ã€‚
- âŒ æ§åˆ¶å™¨æ‰‹åŠ¨è§£æç”¨æˆ·ä¿¡æ¯ã€æ‰‹å†™ `Ok()`/`BadRequest()` å“åº”æˆ–åŒ…è£¹ `try-catch`ã€‚
- âŒ åœ¨ API æœåŠ¡å¯åŠ¨æ—¶åˆ›å»ºèœå•ã€è§’è‰²ã€æƒé™ç­‰å…¨å±€æ•°æ®ã€‚
- âŒ æ‰‹åŠ¨è®¾ç½® `CreatedAt`ã€`UpdatedAt`ã€`DeletedAt`ã€`CreatedBy` ç­‰å®¡è®¡å­—æ®µã€‚
- âŒ ä¸ºèœå•æ·»åŠ  `CompanyId`ï¼Œæˆ–æä¾›ä¿®æ”¹èœå•çš„ API/ç®¡ç†ç•Œé¢ã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `docs/features/` â€“ åŠŸèƒ½è¯´æ˜æ–‡æ¡£ç›®å½•
- `README.md` â€“ é¡¹ç›®ä¸»æ–‡æ¡£
- è¯¦ç»†çš„åŠŸèƒ½è¯´æ˜å’Œæ¶æ„æ–‡æ¡£è¯·å‚è€ƒ `docs/` ç›®å½•ä¸‹çš„ç›¸å…³æ–‡æ¡£

> ğŸ§ª è¯·ä¸ºå…³é”®æµç¨‹ï¼ˆå¤šç§Ÿæˆ·è¿‡æ»¤ã€æ•°æ®åˆå§‹åŒ–ã€èœå•åŠ è½½ç­‰ï¼‰ç¼–å†™æˆ–æ›´æ–°å•å…ƒæµ‹è¯•ä¸é›†æˆæµ‹è¯•ï¼Œç¡®ä¿ä¸Šè¿°è§„èŒƒè½åœ°ã€‚

