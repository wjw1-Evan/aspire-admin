---
globs: *.cs
description: C# åç«¯å¼€å‘è§„èŒƒå’Œæœ€ä½³å®è·µ
---

# C# åç«¯å¼€å‘è§„èŒƒ

## ğŸ¯ é¡¹ç›®ç»“æ„

### æœåŠ¡æ¶æ„
- **Platform.ApiService** - ä¸»è¦çš„ API æœåŠ¡
- **Platform.ServiceDefaults** - å…±äº«æœåŠ¡é…ç½®
- **Platform.AppHost** - åº”ç”¨ç¼–æ’å’Œé…ç½®

### ç›®å½•ç»“æ„
```
Platform.ApiService/
â”œâ”€â”€ Controllers/          # API æ§åˆ¶å™¨
â”œâ”€â”€ Models/              # æ•°æ®æ¨¡å‹
â”œâ”€â”€ Services/            # ä¸šåŠ¡é€»è¾‘æœåŠ¡
â”œâ”€â”€ Scripts/             # æ•°æ®åº“è„šæœ¬
â””â”€â”€ Program.cs           # åº”ç”¨ç¨‹åºå…¥å£
```

## ğŸ—ï¸ ä»£ç è§„èŒƒ

### å‘½åçº¦å®š
- **ç±»**: ä½¿ç”¨ PascalCase (å¦‚ `UserService`)
- **æ–¹æ³•**: ä½¿ç”¨ PascalCase (å¦‚ `GetUserById`)
- **å±æ€§**: ä½¿ç”¨ PascalCase (å¦‚ `UserName`)
- **å­—æ®µ**: ä½¿ç”¨ camelCase æˆ– _camelCase (å¦‚ `_userRepository`)
- **å¸¸é‡**: ä½¿ç”¨ UPPER_SNAKE_CASE (å¦‚ `MAX_RETRY_COUNT`)

### æ§åˆ¶å™¨è®¾è®¡
```csharp
// âœ… æ¨èï¼šæ ‡å‡†çš„ API æ§åˆ¶å™¨
[ApiController]
[Route("api/[controller]")]
public class UsersController : ControllerBase
{
    private readonly IUserService _userService;
    
    public UsersController(IUserService userService)
    {
        _userService = userService;
    }
    
    [HttpGet]
    public async Task<ActionResult<IEnumerable<User>>> GetUsers()
    {
        var users = await _userService.GetAllUsersAsync();
        return Ok(users);
    }
    
    [HttpPost]
    public async Task<ActionResult<User>> CreateUser([FromBody] CreateUserRequest request)
    {
        var user = await _userService.CreateUserAsync(request);
        return CreatedAtAction(nameof(GetUser), new { id = user.Id }, user);
    }
}
```

### æœåŠ¡å±‚è®¾è®¡
```csharp
// âœ… æ¨èï¼šæœåŠ¡æ¥å£å’Œå®ç°
public interface IUserService
{
    Task<IEnumerable<User>> GetAllUsersAsync();
    Task<User?> GetUserByIdAsync(string id);
    Task<User> CreateUserAsync(CreateUserRequest request);
    Task<bool> UpdateUserAsync(string id, UpdateUserRequest request);
    Task<bool> DeleteUserAsync(string id);
}

public class UserService : IUserService
{
    private readonly IUserRepository _userRepository;
    private readonly ILogger<UserService> _logger;
    
    public UserService(IUserRepository userRepository, ILogger<UserService> logger)
    {
        _userRepository = userRepository;
        _logger = logger;
    }
    
    public async Task<IEnumerable<User>> GetAllUsersAsync()
    {
        try
        {
            return await _userRepository.GetAllAsync();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error retrieving users");
            throw;
        }
    }
}
```

## ğŸ—„ï¸ æ•°æ®è®¿é—®

### MongoDB é›†æˆ
```csharp
// âœ… æ¨èï¼šMongoDB æ•°æ®æ¨¡å‹
public class User
{
    [BsonId]
    [BsonRepresentation(BsonType.ObjectId)]
    public string Id { get; set; } = string.Empty;
    
    [BsonElement("username")]
    public string Username { get; set; } = string.Empty;
    
    [BsonElement("email")]
    public string Email { get; set; } = string.Empty;
    
    [BsonElement("role")]
    public string Role { get; set; } = "user";
    
    [BsonElement("createdAt")]
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
}
```

### ä»“å‚¨æ¨¡å¼
```csharp
// âœ… æ¨èï¼šä»“å‚¨æ¥å£å’Œå®ç°
public interface IUserRepository
{
    Task<IEnumerable<User>> GetAllAsync();
    Task<User?> GetByIdAsync(string id);
    Task<User> CreateAsync(User user);
    Task<bool> UpdateAsync(string id, User user);
    Task<bool> DeleteAsync(string id);
}

public class UserRepository : IUserRepository
{
    private readonly IMongoCollection<User> _users;
    
    public UserRepository(IMongoDatabase database)
    {
        _users = database.GetCollection<User>("users");
    }
    
    public async Task<IEnumerable<User>> GetAllAsync()
    {
        return await _users.Find(_ => true).ToListAsync();
    }
}
```

## ğŸ” è®¤è¯å’Œæˆæƒ

### JWT è®¤è¯
```csharp
// âœ… æ¨èï¼šJWT é…ç½®
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidateAudience = true,
            ValidateLifetime = true,
            ValidateIssuerSigningKey = true,
            ValidIssuer = builder.Configuration["Jwt:Issuer"],
            ValidAudience = builder.Configuration["Jwt:Audience"],
            IssuerSigningKey = new SymmetricSecurityKey(
                Encoding.UTF8.GetBytes(builder.Configuration["Jwt:Key"]!))
        };
    });
```

## ğŸš« é¿å…çš„åšæ³•

- ä¸è¦ä½¿ç”¨ `async void`ï¼ˆé™¤äº†äº‹ä»¶å¤„ç†ç¨‹åºï¼‰
- ä¸è¦å¿½ç•¥å¼‚å¸¸ï¼ˆä½¿ç”¨é€‚å½“çš„å¼‚å¸¸å¤„ç†ï¼‰
- ä¸è¦ä½¿ç”¨ `string` ä»£æ›¿å¼ºç±»å‹
- ä¸è¦å¿˜è®°é…ç½®ä¾èµ–æ³¨å…¥
- ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æš´éœ²æ•æ„Ÿä¿¡æ¯

## ğŸ”§ é…ç½®ç®¡ç†

### åº”ç”¨é…ç½®
```csharp
// âœ… æ¨èï¼šä½¿ç”¨ IConfiguration
public class DatabaseSettings
{
    public string ConnectionString { get; set; } = string.Empty;
    public string DatabaseName { get; set; } = string.Empty;
}

// åœ¨ Program.cs ä¸­é…ç½®
builder.Services.Configure<DatabaseSettings>(
    builder.Configuration.GetSection("Database"));
```

### ç¯å¢ƒé…ç½®
```csharp
// âœ… æ¨èï¼šç¯å¢ƒç‰¹å®šé…ç½®
if (builder.Environment.IsDevelopment())
{
    builder.Services.AddSwaggerGen();
}
```