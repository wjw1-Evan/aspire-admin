---
globs: *.cs
description: C# åç«¯å¼€å‘è§„èŒƒå’Œæœ€ä½³å®è·µ
---

# C# åç«¯å¼€å‘è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**éµå¾ª .NET 10 å’Œ C# 13 æœ€ä½³å®è·µï¼Œç¡®ä¿ä»£ç è´¨é‡ã€æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§**

## ğŸ“ XML æ–‡æ¡£æ³¨é‡Šè§„èŒƒ

> **é‡è¦**ï¼šXML æ–‡æ¡£æ³¨é‡Šçš„è¯¦ç»†è§„èŒƒã€æ ¼å¼è¦æ±‚ã€ç¤ºä¾‹å’Œæ£€æŸ¥æ¸…å•è¯·å‚è€ƒ [OpenAPI + Scalar API æ–‡æ¡£è§„èŒƒ](mdc:.cursor/rules/openapi-scalar-standard.mdc)ã€‚

**æ‰€æœ‰å…¬å…±ç±»å‹å’Œæˆå‘˜å¿…é¡»åŒ…å«å®Œæ•´çš„ XML æ–‡æ¡£æ³¨é‡Šï¼Œè¿™æ˜¯å¼ºåˆ¶è¦æ±‚ï¼Œä¸å…è®¸ä¾‹å¤–ã€‚** è¿™æ˜¯ .NET 10 OpenAPI + Scalar API æ–‡æ¡£ç”Ÿæˆçš„åŸºç¡€ã€‚

**âœ… é¡¹ç›®å·²å®ç°**ï¼šæ‰€æœ‰ C# ä»£ç æ–‡ä»¶ï¼ˆ1082+ ä¸ªå…¬å…±æˆå‘˜ï¼‰å·²æ·»åŠ å®Œæ•´çš„ XML æ–‡æ¡£æ³¨é‡Šï¼Œç¼–è¯‘æ—¶æ—  CS1591 è­¦å‘Šã€‚

## ğŸ“ é¡¹ç›®ç»“æ„è§„èŒƒ

### æœåŠ¡å±‚æ¶æ„

```
Platform.ApiService/
â”œâ”€â”€ Controllers/          # API æ§åˆ¶å™¨
â”œâ”€â”€ Services/            # ä¸šåŠ¡é€»è¾‘æœåŠ¡
â”œâ”€â”€ Models/              # æ•°æ®æ¨¡å‹å’Œ DTO
â”œâ”€â”€ Validators/          # å‚æ•°éªŒè¯å™¨
â”œâ”€â”€ Extensions/          # æ‰©å±•æ–¹æ³•
â”œâ”€â”€ Constants/           # å¸¸é‡å®šä¹‰
â”œâ”€â”€ Scripts/             # æ•°æ®è„šæœ¬
â””â”€â”€ Program.cs           # åº”ç”¨å…¥å£
```

### å‘½åè§„èŒƒ

```csharp
// âœ… æ¥å£å‘½å
public interface IUserService { }

// âœ… æœåŠ¡å®ç°å‘½å
public class UserService : IUserService { }

// âœ… æ§åˆ¶å™¨å‘½å
public class UserController : BaseApiController { }

// âœ… æ¨¡å‹å‘½å
public class User : BaseEntity { }
public class CreateUserRequest { }
public class UserResponse { }

// âœ… å¸¸é‡å‘½å
public static class UserConstants
{
    public const string ACTIVE_STATUS = "active";
    public const string PENDING_STATUS = "pending";
}
```

## ğŸ”§ ä»£ç è§„èŒƒ

### 1. æ§åˆ¶å™¨è§„èŒƒ

> **é‡è¦**ï¼šæ§åˆ¶å™¨è§„èŒƒçš„è¯¦ç»†è¦æ±‚è¯·å‚è€ƒ [åç«¯æ ¸å¿ƒå¼€å‘è§„èŒƒ](mdc:.cursor/rules/core-backend-standards.mdc)ã€‚

æ‰€æœ‰ API æ§åˆ¶å™¨å¿…é¡»ç»§æ‰¿ `BaseApiController`ï¼Œä½¿ç”¨åŸºç±»æ–¹æ³•å¤„ç†å“åº”ï¼Œéµå¾ªå¼‚å¸¸å³é€»è¾‘åŸåˆ™ã€‚

```csharp
/// <summary>
/// ç”¨æˆ·ç®¡ç†æ§åˆ¶å™¨
/// </summary>
[ApiController]
[Route("api/[controller]")]
[Authorize]
public class UserController : BaseApiController
{
    private readonly IUserService _userService;

    public UserController(IUserService userService)
    {
        _userService = userService;
    }

    /// <summary>
    /// è·å–ç”¨æˆ·åˆ—è¡¨
    /// </summary>
    /// <param name="request">æŸ¥è¯¢å‚æ•°</param>
    /// <returns>ç”¨æˆ·åˆ—è¡¨</returns>
    [HttpGet]
    public async Task<IActionResult> GetUsers([FromQuery] UserListRequest request)
    {
        var users = await _userService.GetUsersAsync(request);
        return Success(users);
    }
}
```

### 2. æœåŠ¡å±‚è§„èŒƒ

```csharp
/// <summary>
/// ç”¨æˆ·æœåŠ¡æ¥å£
/// </summary>
public interface IUserService
{
    Task<List<User>> GetUsersAsync(UserListRequest request);
    Task<User?> GetUserByIdAsync(string id);
    Task<User> CreateUserAsync(CreateUserRequest request);
    Task<bool> UpdateUserAsync(string id, UpdateUserRequest request);
    Task<bool> DeleteUserAsync(string id);
}

/// <summary>
/// ç”¨æˆ·æœåŠ¡å®ç°
/// </summary>
public class UserService : IUserService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    private readonly ILogger<UserService> _logger;

    public UserService(
        IDatabaseOperationFactory<User> userFactory,
        ILogger<UserService> logger)
    {
        _userFactory = userFactory;
        _logger = logger;
    }

    public async Task<List<User>> GetUsersAsync(UserListRequest request)
    {
        try
        {
            var filter = _userFactory.CreateFilterBuilder()
                .Equal(u => u.IsActive, true)
                .Build();
            
            var users = await _userFactory.FindAsync(filter);
            return users.ToList();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥");
            throw;
        }
    }
}
```

### 3. æ¨¡å‹å®šä¹‰è§„èŒƒ

```csharp
/// <summary>
/// ç”¨æˆ·å®ä½“
/// </summary>
public class User : BaseEntity, 
    Platform.ServiceDefaults.Models.IEntity,
    Platform.ServiceDefaults.Models.ISoftDeletable,
    Platform.ServiceDefaults.Models.ITimestamped
{
    [BsonId]
    [BsonRepresentation(BsonType.ObjectId)]
    public string Id { get; set; } = string.Empty;

    [BsonElement("username")]
    [Required]
    [StringLength(50, MinimumLength = 3)]
    public string Username { get; set; } = string.Empty;

    [BsonElement("email")]
    [Required]
    [EmailAddress]
    public string Email { get; set; } = string.Empty;

    [BsonElement("isActive")]
    public bool IsActive { get; set; } = true;

    [BsonElement("createdAt")]
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;

    [BsonElement("updatedAt")]
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;

    [BsonElement("isDeleted")]
    public bool IsDeleted { get; set; } = false;
}

/// <summary>
/// åˆ›å»ºç”¨æˆ·è¯·æ±‚
/// </summary>
public class CreateUserRequest
{
    [Required]
    [StringLength(50, MinimumLength = 3)]
    public string Username { get; set; } = string.Empty;

    [Required]
    [EmailAddress]
    public string Email { get; set; } = string.Empty;

    [Required]
    [MinLength(6)]
    public string Password { get; set; } = string.Empty;
}
```

## ğŸš« ç¦æ­¢çš„åšæ³•

### 1. ä¸è¦ç›´æ¥ä½¿ç”¨ IMongoCollection

```csharp
// âŒ ç¦æ­¢ï¼šç›´æ¥ä½¿ç”¨ IMongoCollection
private readonly IMongoCollection<User> _users;

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ IDatabaseOperationFactory
private readonly IDatabaseOperationFactory<User> _userFactory;
```

### 2. ä¸è¦æ‰‹åŠ¨å¤„ç†å¼‚å¸¸

> **é‡è¦**ï¼šé”™è¯¯å¤„ç†çš„è¯¦ç»†è§„èŒƒè¯·å‚è€ƒ [é”™è¯¯å¤„ç†ä¸ç»Ÿä¸€å“åº”è§„èŒƒ](mdc:.cursor/rules/error-handling.mdc)ã€‚

```csharp
// âŒ ç¦æ­¢ï¼šæ‰‹åŠ¨ try-catch
try
{
    var result = await _service.DoSomething();
    return Ok(new { success = true, data = result });
}
catch (Exception ex)
{
    return StatusCode(500, new { success = false, error = ex.Message });
}

// âœ… æ­£ç¡®ï¼šæŠ›å‡ºå¼‚å¸¸ï¼Œç”± UseExceptionHandler() + ProblemDetails ç®¡é“ç»Ÿä¸€å¤„ç†
var result = await _service.DoSomething();
return Success(result);
```

### 3. ä¸è¦æ‰‹åŠ¨æ„å»ºå“åº”æ ¼å¼

```csharp
// âŒ ç¦æ­¢ï¼šæ‰‹åŠ¨æ„å»ºå“åº”
return Ok(new { success = true, data = result });

// âœ… æ­£ç¡®ï¼šä½¿ç”¨åŸºç±»æ–¹æ³•
return Success(result);
```

### 4. ä¸è¦æ‰‹åŠ¨æå–ç”¨æˆ·ä¿¡æ¯

```csharp
// âŒ ç¦æ­¢ï¼šæ‰‹åŠ¨æå–ç”¨æˆ·ä¿¡æ¯
var userId = User.FindFirst("userId")?.Value;
if (string.IsNullOrEmpty(userId))
    return Unauthorized();

// âœ… æ­£ç¡®ï¼šä½¿ç”¨åŸºç±»æ–¹æ³•
var userId = GetRequiredUserId();
```

## ğŸ” å¼‚å¸¸å¤„ç†è§„èŒƒ

### 1. ä½¿ç”¨æ ‡å‡†å¼‚å¸¸ç±»å‹

```csharp
// âœ… ç”¨æˆ·ä¸å­˜åœ¨
throw new KeyNotFoundException($"ç”¨æˆ· {userId} ä¸å­˜åœ¨");

// âœ… å‚æ•°é”™è¯¯
throw new ArgumentException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");

// âœ… æƒé™ä¸è¶³
throw new UnauthorizedAccessException("éœ€è¦ç®¡ç†å‘˜æƒé™");

// âœ… ä¸šåŠ¡é€»è¾‘é”™è¯¯
throw new InvalidOperationException("ç”¨æˆ·å·²å­˜åœ¨");
```

### 2. å¼‚å¸¸æ¶ˆæ¯è§„èŒƒ

```csharp
// âœ… åŒ…å«ä¸Šä¸‹æ–‡ä¿¡æ¯
throw new KeyNotFoundException($"ç”¨æˆ· {userId} ä¸å­˜åœ¨");

// âœ… ä½¿ç”¨å¸¸é‡å®šä¹‰é”™è¯¯æ¶ˆæ¯
throw new ArgumentException(UserErrorMessages.UsernameRequired);

// âœ… æä¾›è§£å†³å»ºè®®
throw new InvalidOperationException("ç”¨æˆ·å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–ç”¨æˆ·å");
```

## ğŸ“ æ—¥å¿—è®°å½•è§„èŒƒ

### 1. ç»“æ„åŒ–æ—¥å¿—

```csharp
// âœ… ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—
_logger.LogInformation("ç”¨æˆ· {UserId} ç™»å½•æˆåŠŸï¼ŒIP: {IpAddress}", userId, ipAddress);

// âœ… è®°å½•æ“ä½œæ—¥å¿—
_logger.LogInformation("åˆ›å»ºç”¨æˆ·: {Username}, é‚®ç®±: {Email}", username, email);

// âœ… è®°å½•é”™è¯¯æ—¥å¿—
_logger.LogError(ex, "ç”¨æˆ· {UserId} ç™»å½•å¤±è´¥", userId);
```

### 2. æ—¥å¿—çº§åˆ«ä½¿ç”¨

```csharp
// âœ… Trace - è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
_logger.LogTrace("å¼€å§‹å¤„ç†ç”¨æˆ·è¯·æ±‚: {RequestId}", requestId);

// âœ… Debug - è°ƒè¯•ä¿¡æ¯
_logger.LogDebug("æŸ¥è¯¢ç”¨æˆ·: {UserId}", userId);

// âœ… Information - ä¸€èˆ¬ä¿¡æ¯
_logger.LogInformation("ç”¨æˆ· {UserId} ç™»å½•æˆåŠŸ", userId);

// âœ… Warning - è­¦å‘Šä¿¡æ¯
_logger.LogWarning("ç”¨æˆ· {UserId} å¤šæ¬¡ç™»å½•å¤±è´¥", userId);

// âœ… Error - é”™è¯¯ä¿¡æ¯
_logger.LogError(ex, "å¤„ç†ç”¨æˆ·è¯·æ±‚å¤±è´¥: {RequestId}", requestId);

// âœ… Critical - ä¸¥é‡é”™è¯¯
_logger.LogCritical(ex, "ç³»ç»Ÿå…³é”®é”™è¯¯");
```

## ğŸ” å®‰å…¨è§„èŒƒ

### 1. è¾“å…¥éªŒè¯

```csharp
// âœ… ä½¿ç”¨æ•°æ®æ³¨è§£éªŒè¯
public class CreateUserRequest
{
    [Required(ErrorMessage = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")]
    [StringLength(50, MinimumLength = 3, ErrorMessage = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¸ªå­—ç¬¦ä¹‹é—´")]
    [RegularExpression(@"^[a-zA-Z0-9_]+$", ErrorMessage = "ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿")]
    public string Username { get; set; } = string.Empty;
}

// âœ… ä½¿ç”¨ FluentValidation
public class CreateUserRequestValidator : AbstractValidator<CreateUserRequest>
{
    public CreateUserRequestValidator()
    {
        RuleFor(x => x.Username)
            .NotEmpty().WithMessage("ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
            .Length(3, 50).WithMessage("ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¸ªå­—ç¬¦ä¹‹é—´")
            .Matches(@"^[a-zA-Z0-9_]+$").WithMessage("ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿");
    }
}
```

### 2. æƒé™æ£€æŸ¥

```csharp
// âœ… ä½¿ç”¨ Authorize ç‰¹æ€§
[Authorize(Roles = "admin")]
[HttpDelete("{id}")]
public async Task<IActionResult> DeleteUser(string id)
{
    // å®ç°åˆ é™¤é€»è¾‘
}

// âœ… åœ¨æœåŠ¡å±‚æ£€æŸ¥æƒé™
public async Task<bool> DeleteUserAsync(string id)
{
    if (!IsAdmin())
        throw new UnauthorizedAccessException("éœ€è¦ç®¡ç†å‘˜æƒé™");
    
    // å®ç°åˆ é™¤é€»è¾‘
}
```

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–è§„èŒƒ

### 1. å¼‚æ­¥æ“ä½œ

```csharp
// âœ… ä½¿ç”¨ async/await
public async Task<User> GetUserAsync(string id)
{
    return await _userFactory.GetByIdAsync(id);
}

// âœ… å¹¶è¡Œæ‰§è¡Œç‹¬ç«‹æ“ä½œ
public async Task<UserProfile> GetUserProfileAsync(string userId)
{
    var userTask = _userFactory.GetByIdAsync(userId);
    var rolesTask = _roleFactory.FindAsync(roleFilter);
    
    await Task.WhenAll(userTask, rolesTask);
    
    return new UserProfile
    {
        User = await userTask,
        Roles = await rolesTask
    };
}
```

### 2. æŸ¥è¯¢ä¼˜åŒ–

```csharp
// âœ… ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢
var (users, total) = await _userFactory.FindPagedAsync(filter, sort, page: 1, pageSize: 20);

// âœ… ä½¿ç”¨å­—æ®µæŠ•å½±ï¼Œåªè¿”å›éœ€è¦çš„å­—æ®µï¼ˆæ€§èƒ½ä¼˜åŒ–å…³é”®ï¼‰
var projection = _userFactory.CreateProjectionBuilder()
    .Include(u => u.Id)
    .Include(u => u.Username)
    .Include(u => u.Email)
    .Include(u => u.IsActive)
    .Include(u => u.CreatedAt)
    .Build();

// âœ… åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨æŠ•å½±
var (users, total) = await _userFactory.FindPagedAsync(
    filter, sort, page: 1, pageSize: 20, projection);

// âœ… æ‰¹é‡æŸ¥è¯¢æ—¶ä½¿ç”¨æŠ•å½±
var userProjection = _userFactory.CreateProjectionBuilder()
    .Include(u => u.Id)
    .Include(u => u.Username)
    .Include(u => u.Name)
    .Build();
var users = await _userFactory.FindAsync(userFilter, projection: userProjection);

// âœ… ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
var filter = _userFactory.CreateFilterBuilder()
    .Equal(u => u.IsActive, true)  // ç¡®ä¿æœ‰ç´¢å¼•
    .Equal(u => u.CompanyId, companyId)  // ç¡®ä¿æœ‰å¤åˆç´¢å¼•
    .Build();
```

**å­—æ®µæŠ•å½±ä½¿ç”¨åŸåˆ™**ï¼š

1. **åˆ—è¡¨æŸ¥è¯¢å¿…é¡»ä½¿ç”¨æŠ•å½±** - åªè¿”å›åˆ—è¡¨æ˜¾ç¤ºéœ€è¦çš„å­—æ®µ
2. **æ‰¹é‡æŸ¥è¯¢å¿…é¡»ä½¿ç”¨æŠ•å½±** - å‡å°‘å¤§é‡æ•°æ®ä¼ è¾“
3. **å…³è”æŸ¥è¯¢ä½¿ç”¨æŠ•å½±** - åªè¿”å›å…³è”å¯¹è±¡çš„å…³é”®å­—æ®µ
4. **è¯¦æƒ…æŸ¥è¯¢ä¸ä½¿ç”¨æŠ•å½±** - éœ€è¦è¿”å›å®Œæ•´å¯¹è±¡
5. **æŠ•å½±å­—æ®µå¿…é¡»åŒ…å« Id** - MongoDB æŸ¥è¯¢æ€»æ˜¯è¿”å› `_id` å­—æ®µ
6. **æŠ•å½±å­—æ®µå¿…é¡»åŒ…å«æ’åºå’Œè¿‡æ»¤å­—æ®µ** - ç¡®ä¿æŸ¥è¯¢èƒ½æ­£å¸¸å·¥ä½œ

## ğŸ”§ ä¾èµ–æ³¨å…¥å’Œé…ç½®ç®¡ç†

### æœåŠ¡ç”Ÿå‘½å‘¨æœŸ

```csharp
// âœ… æ­£ç¡®çš„æœåŠ¡ç”Ÿå‘½å‘¨æœŸé€‰æ‹©
builder.Services.AddSingleton<IConfigurationService, ConfigurationService>();  // å•ä¾‹ï¼šé…ç½®æœåŠ¡
builder.Services.AddScoped<IUserService, UserService>();                      // ä½œç”¨åŸŸï¼šä¸šåŠ¡æœåŠ¡
builder.Services.AddTransient<IValidator, RequestValidator>();                // ç¬æ—¶ï¼šéªŒè¯å™¨
```

### æ¥å£ä¼˜å…ˆåŸåˆ™

```csharp
// âœ… æ¨èï¼šé¢å‘æ¥å£ç¼–ç¨‹
public interface IUserService
{
    Task<User> GetUserByIdAsync(string id);
    Task<User> CreateUserAsync(CreateUserRequest request);
}

public class UserService : IUserService
{
    // å®ç°
}

// æ³¨å†ŒæœåŠ¡
builder.Services.AddScoped<IUserService, UserService>();
```

### æœåŠ¡æ³¨å†Œæ¨¡å¼

```csharp
// âœ… è‡ªåŠ¨æœåŠ¡æ³¨å†Œï¼ˆæ¨èï¼‰
// Platform.ApiService/Extensions/ServiceRegistrationExtensions.cs
public static class ServiceRegistrationExtensions
{
    /// <summary>
    /// è‡ªåŠ¨æ³¨å†Œ Platform.ApiService.Services å‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰æœåŠ¡
    /// </summary>
    /// <param name="services">æœåŠ¡é›†åˆ</param>
    /// <returns>æœåŠ¡é›†åˆ</returns>
    /// <remarks>
    /// é€šè¿‡åå°„è‡ªåŠ¨å‘ç°å¹¶æ³¨å†ŒæœåŠ¡ï¼š
    /// - æ‰«æå®ç°ç±»ï¼Œè‡ªåŠ¨æŸ¥æ‰¾å®ƒä»¬å®ç°çš„æ¥å£å¹¶æ³¨å†Œ
    /// - ä½¿ç”¨ IsInterface è¯†åˆ«æ¥å£ï¼Œä¸ä¾èµ–å‘½åçº¦å®šï¼ˆå¦‚ "I" å¼€å¤´ï¼‰
    /// - åŸºäºå®é™…çš„ç±»å‹å…³ç³»è¿›è¡Œæ³¨å†Œ
    /// - æ‰€æœ‰æœåŠ¡ä½¿ç”¨ Scoped ç”Ÿå‘½å‘¨æœŸæ³¨å†Œ
    /// </remarks>
    public static IServiceCollection AddBusinessServices(this IServiceCollection services)
    {
        var assembly = Assembly.GetExecutingAssembly();
        var servicesNamespace = typeof(IUserService).Namespace; // Platform.ApiService.Services
        
        // éå†æ‰€æœ‰å®ç°ç±»ï¼Œæ‰¾åˆ°å®ƒä»¬å®ç°çš„æ¥å£å¹¶æ³¨å†Œ
        foreach (var implementationType in assembly.GetTypes()
            .Where(t => t.IsClass 
                && !t.IsAbstract 
                && t.Namespace == servicesNamespace))
        {
            // æŸ¥æ‰¾å®ç°ç±»å®ç°çš„æ¥å£ï¼ˆåœ¨æŒ‡å®šå‘½åç©ºé—´ä¸‹ï¼Œä¸ä¾èµ–å‘½åçº¦å®šï¼‰
            var interfaceType = implementationType.GetInterfaces()
                .FirstOrDefault(i => i.IsInterface && i.Namespace == servicesNamespace);
            
            if (interfaceType != null)
            {
                services.AddScoped(interfaceType, implementationType);
            }
        }

        return services;
    }
}

// âœ… åœ¨ Program.cs ä¸­ä½¿ç”¨
builder.Services.AddBusinessServices(); // è‡ªåŠ¨æ³¨å†Œæ‰€æœ‰ä¸šåŠ¡æœåŠ¡

// âŒ ç¦æ­¢ï¼šæ‰‹åŠ¨é€ä¸ªæ³¨å†ŒæœåŠ¡
// builder.Services.AddScoped<IUserService, UserService>();
// builder.Services.AddScoped<IAuthService, AuthService>();
// ... æ›´å¤šæœåŠ¡
```

### MongoDB æ•°æ®è®¿é—®å·¥å‚æ³¨å†Œ

```csharp
// Platform.ServiceDefaults/Extensions/ServiceExtensions.cs
public static class ServiceExtensions
{
    /// <summary>
    /// æ³¨å†Œæ•°æ®åº“æ“ä½œå·¥å‚ï¼ˆè‡ªåŠ¨å¤„ç†å¤šç§Ÿæˆ·ã€è½¯åˆ é™¤ã€å®¡è®¡å­—æ®µï¼‰
    /// </summary>
    public static IServiceCollection AddDatabaseFactory(this IServiceCollection services)
    {
        services.AddScoped<IAuditService, AuditService>();
        services.AddScoped(typeof(IDatabaseOperationFactory<>), typeof(DatabaseOperationFactory<>));
        return services;
    }
}

// Program.cs
builder.Services.AddDatabaseFactory();
```

> `IDatabaseOperationFactory<T>` ä¼šæ³¨å…¥ç§Ÿæˆ·è¿‡æ»¤ã€è½¯åˆ é™¤è¿‡æ»¤ä¸å®¡è®¡å­—æ®µå¡«å……ï¼›ç¦æ­¢ç›´æ¥æ³¨å…¥ `IMongoCollection<T>`ã€‚

### é…ç½®ç®¡ç†

```csharp
// âœ… å¼ºç±»å‹é…ç½®
public class JwtSettings
{
    public string SecretKey { get; set; } = string.Empty;
    public string Issuer { get; set; } = string.Empty;
    public string Audience { get; set; } = string.Empty;
    public int ExpirationMinutes { get; set; } = 60;
    public int RefreshTokenExpirationDays { get; set; } = 7;
}

// æ³¨å†Œé…ç½®
builder.Services.Configure<JwtSettings>(builder.Configuration.GetSection("Jwt"));

// ä½¿ç”¨é…ç½®
public class JwtService : IJwtService
{
    private readonly JwtSettings _jwtSettings;
    
    public JwtService(IOptions<JwtSettings> jwtSettings)
    {
        _jwtSettings = jwtSettings.Value;
    }
}
```

### é€‰é¡¹æ¨¡å¼

```csharp
// âœ… é€‰é¡¹æ¨¡å¼å®ç°
public class DatabaseOptions
{
    public string ConnectionString { get; set; } = string.Empty;
    public string DatabaseName { get; set; } = string.Empty;
    public int MaxPoolSize { get; set; } = 100;
    public TimeSpan ConnectionTimeout { get; set; } = TimeSpan.FromSeconds(30);
}

// æ³¨å†Œé€‰é¡¹
builder.Services.Configure<DatabaseOptions>(
    builder.Configuration.GetSection("Database"));

// éªŒè¯é€‰é¡¹
builder.Services.AddOptions<DatabaseOptions>()
    .Bind(builder.Configuration.GetSection("Database"))
    .ValidateDataAnnotations()
    .ValidateOnStart();
```

### å·¥å‚æ¨¡å¼

```csharp
// âœ… æœåŠ¡å·¥å‚æ¨¡å¼
public interface IHttpClientFactory
{
    HttpClient CreateClient(string name);
}

public class CustomHttpClientFactory : IHttpClientFactory
{
    private readonly IHttpClientFactory _httpClientFactory;
    
    public CustomHttpClientFactory(IHttpClientFactory httpClientFactory)
    {
        _httpClientFactory = httpClientFactory;
    }
    
    public HttpClient CreateClient(string name)
    {
        var client = _httpClientFactory.CreateClient(name);
        // é…ç½®å®¢æˆ·ç«¯
        client.DefaultRequestHeaders.Add("User-Agent", "Platform-Client");
        return client;
    }
}

// æ³¨å†Œå·¥å‚
builder.Services.AddHttpClient();
builder.Services.AddScoped<IHttpClientFactory, CustomHttpClientFactory>();
```

### è£…é¥°å™¨æ¨¡å¼

```csharp
// âœ… è£…é¥°å™¨æ¨¡å¼å®ç°
public interface IUserService
{
    Task<User> GetUserByIdAsync(string id);
}

public class UserService : IUserService
{
    // åŸºç¡€å®ç°
}

public class CachedUserService : IUserService
{
    private readonly IUserService _userService;
    private readonly IMemoryCache _cache;
    
    public CachedUserService(IUserService userService, IMemoryCache cache)
    {
        _userService = userService;
        _cache = cache;
    }
    
    public async Task<User> GetUserByIdAsync(string id)
    {
        var cacheKey = $"user_{id}";
        if (_cache.TryGetValue(cacheKey, out User? cachedUser))
            return cachedUser!;
            
        var user = await _userService.GetUserByIdAsync(id);
        _cache.Set(cacheKey, user, TimeSpan.FromMinutes(5));
        return user;
    }
}

// æ³¨å†Œè£…é¥°å™¨
builder.Services.AddScoped<IUserService, UserService>();
builder.Services.Decorate<IUserService, CachedUserService>();
```

### JSON åºåˆ—åŒ–é…ç½®

```csharp
// âœ… ç»Ÿä¸€ JSON åºåˆ—åŒ–é…ç½®
// Platform.ApiService/Program.cs

builder.Services.AddControllers()
    .AddJsonOptions(options =>
    {
        // é…ç½® JSON åºåˆ—åŒ–é€‰é¡¹
        options.JsonSerializerOptions.PropertyNamingPolicy = JsonNamingPolicy.CamelCase;
        options.JsonSerializerOptions.DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull;
        options.JsonSerializerOptions.WriteIndented = false;
        // åºåˆ—åŒ–æšä¸¾ä¸º camelCase å­—ç¬¦ä¸²ï¼Œä¾¿äºå‰ç«¯è¯»å–/æäº¤
        options.JsonSerializerOptions.Converters.Add(
            new JsonStringEnumConverter(JsonNamingPolicy.CamelCase)
        );
    });

// âœ… SignalR ä½¿ç”¨ç›¸åŒçš„ JSON åºåˆ—åŒ–é…ç½®
builder.Services.AddSignalR()
    .AddJsonProtocol(options =>
    {
        // ä½¿ç”¨ä¸æ§åˆ¶å™¨ç›¸åŒçš„ JSON åºåˆ—åŒ–é…ç½®
        options.PayloadSerializerOptions.PropertyNamingPolicy = JsonNamingPolicy.CamelCase;
        options.PayloadSerializerOptions.DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull;
        options.PayloadSerializerOptions.WriteIndented = false;
        // åºåˆ—åŒ–æšä¸¾ä¸º camelCase å­—ç¬¦ä¸²
        options.PayloadSerializerOptions.Converters.Add(
            new JsonStringEnumConverter(JsonNamingPolicy.CamelCase)
        );
    });
```

### ä¾èµ–æ³¨å…¥æœ€ä½³å®è·µ

```csharp
// âœ… è‡ªåŠ¨æ³¨å†ŒæœåŠ¡ï¼ˆå·²å®ç°ï¼‰
// ä½¿ç”¨ Platform.ApiService/Extensions/ServiceRegistrationExtensions.cs ä¸­çš„ AddBusinessServices æ–¹æ³•
// è¯¥æ–¹æ³•é€šè¿‡åå°„è‡ªåŠ¨æ‰«æå¹¶æ³¨å†Œæ‰€æœ‰æœåŠ¡ï¼Œä¸ä¾èµ–å‘½åçº¦å®š

// åœ¨ Program.cs ä¸­ä½¿ç”¨
builder.Services.AddBusinessServices(); // è‡ªåŠ¨æ³¨å†Œæ‰€æœ‰ä¸šåŠ¡æœåŠ¡

// âœ… æ¡ä»¶æ³¨å†ŒæœåŠ¡
if (builder.Environment.IsDevelopment())
{
    builder.Services.AddScoped<IDevelopmentService, DevelopmentService>();
}
else
{
    builder.Services.AddScoped<IProductionService, ProductionService>();
}

// âœ… å¥åº·æ£€æŸ¥æœåŠ¡æ³¨å†Œ
builder.Services.AddHealthChecks()
    .AddCheck<DatabaseHealthCheck>("database")
    .AddCheck<ExternalApiHealthCheck>("external-api");
```

### ä¾èµ–æ³¨å…¥ç¦æ­¢çš„åšæ³•

```csharp
// âŒ ç¦æ­¢ï¼šæœåŠ¡å®šä½å™¨æ¨¡å¼
public class UserController : ControllerBase
{
    public async Task<IActionResult> GetUser(string id)
    {
        var userService = HttpContext.RequestServices.GetService<IUserService>();
        // ä½¿ç”¨æœåŠ¡
    }
}

// âœ… æ­£ç¡®ï¼šæ„é€ å‡½æ•°æ³¨å…¥
public class UserController : ControllerBase
{
    private readonly IUserService _userService;
    
    public UserController(IUserService userService)
    {
        _userService = userService;
    }
}

// âŒ ç¦æ­¢ï¼šæ³¨å†Œå…·ä½“ç±»å‹
builder.Services.AddScoped<UserService>();

// âœ… æ­£ç¡®ï¼šæ³¨å†Œæ¥å£
builder.Services.AddScoped<IUserService, UserService>();

// âŒ ç¦æ­¢ï¼šä¸šåŠ¡æœåŠ¡ä½¿ç”¨å•ä¾‹
builder.Services.AddSingleton<IUserService, UserService>();

// âœ… æ­£ç¡®ï¼šä¸šåŠ¡æœåŠ¡ä½¿ç”¨ä½œç”¨åŸŸ
builder.Services.AddScoped<IUserService, UserService>();

// âŒ ç¦æ­¢ï¼šä¸éªŒè¯é…ç½®
builder.Services.Configure<JwtSettings>(builder.Configuration.GetSection("Jwt"));

// âœ… æ­£ç¡®ï¼šéªŒè¯é…ç½®
builder.Services.AddOptions<JwtSettings>()
    .Bind(builder.Configuration.GetSection("Jwt"))
    .ValidateDataAnnotations()
    .ValidateOnStart();
```

## ğŸ“‹ ä»£ç å®¡æŸ¥æ¸…å•

åœ¨æäº¤ä»£ç å‰ï¼Œæ£€æŸ¥ï¼š

### XML æ–‡æ¡£æ³¨é‡Šï¼ˆå¼ºåˆ¶è¦æ±‚ï¼‰
> è¯¦ç»†æ£€æŸ¥æ¸…å•è¯·å‚è€ƒ [OpenAPI + Scalar API æ–‡æ¡£è§„èŒƒ](mdc:.cursor/rules/openapi-scalar-standard.mdc)
- [ ] **æ‰€æœ‰å…¬å…±ç±»å‹å’Œæˆå‘˜éƒ½æœ‰å®Œæ•´çš„ XML æ³¨é‡Š**
- [ ] **ç¼–è¯‘æ—¶æ²¡æœ‰ XML æ³¨é‡Šè­¦å‘Šï¼ˆCS1591ï¼‰**

### ä»£ç è´¨é‡
- [ ] æ‰€æœ‰æœåŠ¡éƒ½ä½¿ç”¨ `IDatabaseOperationFactory` è€Œä¸æ˜¯ `IMongoCollection`
- [ ] æ§åˆ¶å™¨ç»§æ‰¿ `BaseApiController` å¹¶ä½¿ç”¨å…¶æ–¹æ³•
- [ ] å¼‚å¸¸å¤„ç†ä½¿ç”¨æ ‡å‡†å¼‚å¸¸ç±»å‹å’Œç»“æ„åŒ–æ¶ˆæ¯
- [ ] æ—¥å¿—è®°å½•ä½¿ç”¨ç»“æ„åŒ–æ ¼å¼
- [ ] è¾“å…¥éªŒè¯ä½¿ç”¨æ•°æ®æ³¨è§£æˆ– FluentValidation
- [ ] æƒé™æ£€æŸ¥åœ¨æ§åˆ¶å™¨å’ŒæœåŠ¡å±‚éƒ½æœ‰
- [ ] å¼‚æ­¥æ“ä½œæ­£ç¡®ä½¿ç”¨ async/await
- [ ] æŸ¥è¯¢ä½¿ç”¨äº†é€‚å½“çš„ç´¢å¼•å’Œåˆ†é¡µ
- [ ] éµå¾ªäº†å‘½åè§„èŒƒå’Œé¡¹ç›®ç»“æ„
- [ ] ä½¿ç”¨ `AddBusinessServices()` è‡ªåŠ¨æ³¨å†ŒæœåŠ¡ï¼Œç¦æ­¢æ‰‹åŠ¨é€ä¸ªæ³¨å†Œ
- [ ] ä½¿ç”¨æ¥å£è€Œä¸æ˜¯å…·ä½“ç±»å‹è¿›è¡ŒæœåŠ¡æ³¨å†Œ
- [ ] é€‰æ‹©æ­£ç¡®çš„ç”Ÿå‘½å‘¨æœŸï¼ˆSingleton/Scoped/Transientï¼Œä¸šåŠ¡æœåŠ¡ä½¿ç”¨ Scopedï¼‰
- [ ] éªŒè¯é…ç½®é€‰é¡¹
- [ ] é¿å…å¾ªç¯ä¾èµ–
- [ ] ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—è®°å½•
- [ ] è®°å½•æ€§èƒ½æŒ‡æ ‡å’Œæ“ä½œæ—¥å¿—
- [ ] å®ç°å¥åº·æ£€æŸ¥
- [ ] ä¸­é—´ä»¶ä½¿ç”¨å¼‚æ­¥æ“ä½œé¿å…é˜»å¡
- [ ] åœ¨è¯·æ±‚çº¿ç¨‹ä¸­æå–æ•°æ®ï¼Œé¿å…åå°çº¿ç¨‹è®¿é—® HttpContext

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [C# åç«¯å¼€å‘è§„èŒƒ](mdc:.cursor/rules/csharp-backend.mdc)
- [åç«¯æ ¸å¿ƒå¼€å‘è§„èŒƒ](mdc:.cursor/rules/core-backend-standards.mdc)
- [OpenAPI + Scalar API æ–‡æ¡£è§„èŒƒ](mdc:.cursor/rules/openapi-scalar-standard.mdc)
- [é”™è¯¯å¤„ç†ä¸ç»Ÿä¸€å“åº”è§„èŒƒ](mdc:.cursor/rules/error-handling.mdc)
- [è‡ªåŠ¨æœåŠ¡æ³¨å†Œå®ç°](mdc:Platform.ApiService/Extensions/ServiceRegistrationExtensions.cs)
- [ç»Ÿä¸€å“åº”ä¸­é—´ä»¶](mdc:Platform.ApiService/Middleware/ResponseFormattingMiddleware.cs)
- [æœåŠ¡é»˜è®¤é…ç½®æ‰©å±•æ–¹æ³•](mdc:Platform.ServiceDefaults/Extensions/ServiceExtensions.cs)
- [Platform.ApiService Program](mdc:Platform.ApiService/Program.cs)
- [.NET ä¾èµ–æ³¨å…¥æ–‡æ¡£](https://learn.microsoft.com/aspnet/core/fundamentals/dependency-injection)
- [é…ç½®é€‰é¡¹æ¨¡å¼](https://learn.microsoft.com/aspnet/core/fundamentals/configuration/options)

## ğŸ¯ è®°ä½

1. **XML æ³¨é‡Šå¼ºåˆ¶è¦æ±‚** - æ‰€æœ‰å…¬å…±ç±»å‹å’Œæˆå‘˜å¿…é¡»æœ‰å®Œæ•´çš„ XML æ–‡æ¡£æ³¨é‡Šï¼ˆè¯¦è§ [OpenAPI + Scalar API æ–‡æ¡£è§„èŒƒ](mdc:.cursor/rules/openapi-scalar-standard.mdc)ï¼‰
2. **ç»Ÿä¸€æ¶æ„** - éµå¾ªé¡¹ç›®æ—¢å®šçš„æ¶æ„æ¨¡å¼ï¼ˆè¯¦è§ [åç«¯æ ¸å¿ƒå¼€å‘è§„èŒƒ](mdc:.cursor/rules/core-backend-standards.mdc)ï¼‰
3. **å®‰å…¨ç¬¬ä¸€** - å§‹ç»ˆéªŒè¯è¾“å…¥å’Œæ£€æŸ¥æƒé™
4. **æ€§èƒ½ä¼˜åŒ–** - ä½¿ç”¨å¼‚æ­¥æ“ä½œå’ŒæŸ¥è¯¢ä¼˜åŒ–
5. **é”™è¯¯å¤„ç†** - ä½¿ç”¨ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼ˆè¯¦è§ [é”™è¯¯å¤„ç†è§„èŒƒ](mdc:.cursor/rules/error-handling.mdc)ï¼‰
6. **æ—¥å¿—è®°å½•** - è®°å½•å…³é”®æ“ä½œå’Œé”™è¯¯ä¿¡æ¯
7. **ä»£ç è´¨é‡** - ä¿æŒä»£ç ç®€æ´ã€å¯è¯»å’Œå¯ç»´æŠ¤

éµå¾ªè¿™äº›è§„èŒƒï¼Œç¡®ä¿ä»£ç çš„ä¸€è‡´æ€§ã€å®‰å…¨æ€§å’Œå¯ç»´æŠ¤æ€§ï¼