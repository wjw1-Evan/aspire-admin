---
globs: *.cs
description: C# åç«¯å¼€å‘è§„èŒƒå’Œæœ€ä½³å®è·µ
---

# C# åç«¯å¼€å‘è§„èŒƒ

## ğŸ¯ é¡¹ç›®ç»“æ„

### æœåŠ¡æ¶æ„
- **Platform.ApiService** - ä¸»è¦çš„ API æœåŠ¡
- **Platform.ServiceDefaults** - å…±äº«æœåŠ¡é…ç½®
- **Platform.AppHost** - åº”ç”¨ç¼–æ’å’Œé…ç½®

### ç›®å½•ç»“æ„
```
Platform.ApiService/
â”œâ”€â”€ Controllers/          # API æ§åˆ¶å™¨
â”œâ”€â”€ Models/              # æ•°æ®æ¨¡å‹
â”œâ”€â”€ Services/            # ä¸šåŠ¡é€»è¾‘æœåŠ¡
â”œâ”€â”€ Scripts/             # æ•°æ®åº“è„šæœ¬
â””â”€â”€ Program.cs           # åº”ç”¨ç¨‹åºå…¥å£
```

## ğŸ—ï¸ ä»£ç è§„èŒƒ

### å‘½åçº¦å®š
- **ç±»**: ä½¿ç”¨ PascalCase (å¦‚ `UserService`)
- **æ–¹æ³•**: ä½¿ç”¨ PascalCase (å¦‚ `GetUserById`)
- **å±æ€§**: ä½¿ç”¨ PascalCase (å¦‚ `UserName`)
- **å­—æ®µ**: ä½¿ç”¨ camelCase æˆ– _camelCase (å¦‚ `_userRepository`)
- **å¸¸é‡**: ä½¿ç”¨ UPPER_SNAKE_CASE (å¦‚ `MAX_RETRY_COUNT`)

### æ§åˆ¶å™¨è®¾è®¡

**âš ï¸ é‡è¦ï¼šæ‰€æœ‰æ§åˆ¶å™¨å¿…é¡»ç»§æ‰¿ `BaseApiController`**

```csharp
// âœ… æ¨èï¼šç»§æ‰¿ BaseApiController
[ApiController]
[Route("api/[controller]")]
public class UsersController : BaseApiController  // âœ… å¿…é¡»ç»§æ‰¿ BaseApiController
{
    private readonly IUserService _userService;
    
    public UsersController(IUserService userService)
    {
        _userService = userService;
    }
    
    [HttpGet]
    public async Task<IActionResult> GetUsers()
    {
        var users = await _userService.GetAllUsersAsync();
        return Success(users);  // âœ… ä½¿ç”¨åŸºç±»æ–¹æ³•
    }
    
    [HttpGet("{id}")]
    public async Task<IActionResult> GetUser(string id)
    {
        var user = await _userService.GetUserByIdAsync(id);
        if (user == null)
            throw new KeyNotFoundException($"ç”¨æˆ· {id} ä¸å­˜åœ¨");  // âœ… æŠ›å‡ºå¼‚å¸¸
        
        return Success(user);
    }
    
    [HttpPost]
    public async Task<IActionResult> CreateUser([FromBody] CreateUserRequest request)
    {
        if (string.IsNullOrEmpty(request.Name))
            throw new ArgumentException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");  // âœ… å‚æ•°éªŒè¯
        
        var userId = GetRequiredUserId();  // âœ… ä½¿ç”¨åŸºç±»æ–¹æ³•è·å–ç”¨æˆ·ID
        var user = await _userService.CreateUserAsync(request, userId);
        
        return Success(user, "åˆ›å»ºæˆåŠŸ");
    }
}

// âŒ ç¦æ­¢ï¼šç›´æ¥ç»§æ‰¿ ControllerBase
[ApiController]
[Route("api/[controller]")]
public class UsersController : ControllerBase  // âŒ ç¦æ­¢
{
    // ...
}
```

### æœåŠ¡å±‚è®¾è®¡
```csharp
// âœ… æ¨èï¼šæœåŠ¡æ¥å£å’Œå®ç°
public interface IUserService
{
    Task<IEnumerable<User>> GetAllUsersAsync();
    Task<User?> GetUserByIdAsync(string id);
    Task<User> CreateUserAsync(CreateUserRequest request);
    Task<bool> UpdateUserAsync(string id, UpdateUserRequest request);
    Task<bool> DeleteUserAsync(string id);
}

public class UserService : IUserService
{
    private readonly IUserRepository _userRepository;
    private readonly ILogger<UserService> _logger;
    
    public UserService(IUserRepository userRepository, ILogger<UserService> logger)
    {
        _userRepository = userRepository;
        _logger = logger;
    }
    
    public async Task<IEnumerable<User>> GetAllUsersAsync()
    {
        try
        {
            return await _userRepository.GetAllAsync();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error retrieving users");
            throw;
        }
    }
}
```

## ğŸ—„ï¸ æ•°æ®è®¿é—®

### MongoDB é›†æˆ
```csharp
// âœ… æ¨èï¼šMongoDB æ•°æ®æ¨¡å‹
public class User
{
    [BsonId]
    [BsonRepresentation(BsonType.ObjectId)]
    public string Id { get; set; } = string.Empty;
    
    [BsonElement("username")]
    public string Username { get; set; } = string.Empty;
    
    [BsonElement("email")]
    public string Email { get; set; } = string.Empty;
    
    [BsonElement("role")]
    public string Role { get; set; } = "user";
    
    [BsonElement("createdAt")]
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
}
```

### ä»“å‚¨æ¨¡å¼
```csharp
// âœ… æ¨èï¼šä»“å‚¨æ¥å£å’Œå®ç°
public interface IUserRepository
{
    Task<IEnumerable<User>> GetAllAsync();
    Task<User?> GetByIdAsync(string id);
    Task<User> CreateAsync(User user);
    Task<bool> UpdateAsync(string id, User user);
    Task<bool> DeleteAsync(string id);
}

public class UserRepository : IUserRepository
{
    private readonly IMongoCollection<User> _users;
    
    public UserRepository(IMongoDatabase database)
    {
        _users = database.GetCollection<User>("users");
    }
    
    public async Task<IEnumerable<User>> GetAllAsync()
    {
        return await _users.Find(_ => true).ToListAsync();
    }
}
```

## ğŸ” è®¤è¯å’Œæˆæƒ

### JWT æœåŠ¡å®ç°

```csharp
// âœ… æ¨èï¼šJWT æœåŠ¡æ¥å£å’Œå®ç°
public interface IJwtService
{
    string GenerateToken(AppUser user);
    string GenerateRefreshToken(AppUser user);
    ClaimsPrincipal? ValidateToken(string token);
    ClaimsPrincipal? ValidateRefreshToken(string refreshToken);
    string? GetUserIdFromToken(string token);
    string? GetUserIdFromRefreshToken(string refreshToken);
}

public class JwtService : IJwtService
{
    private readonly string _secretKey;
    private readonly string _issuer;
    private readonly string _audience;
    private readonly int _expirationMinutes;
    private readonly int _refreshTokenExpirationDays;

    public JwtService(IConfiguration configuration)
    {
        _secretKey = configuration["Jwt:SecretKey"] 
            ?? throw new ArgumentNullException("Jwt:SecretKey");
        _issuer = configuration["Jwt:Issuer"] ?? "Platform.ApiService";
        _audience = configuration["Jwt:Audience"] ?? "Platform.Web";
        _expirationMinutes = int.Parse(configuration["Jwt:ExpirationMinutes"] ?? "60");
        _refreshTokenExpirationDays = int.Parse(configuration["Jwt:RefreshTokenExpirationDays"] ?? "7");
    }

    public string GenerateToken(AppUser user)
    {
        var tokenHandler = new JwtSecurityTokenHandler();
        var key = Encoding.ASCII.GetBytes(_secretKey);

        var claims = new List<Claim>
        {
            new(ClaimTypes.NameIdentifier, user.Id ?? string.Empty),
            new(ClaimTypes.Name, user.Username),
            new(ClaimTypes.Email, user.Email ?? string.Empty),
            new(ClaimTypes.Role, user.Role),
            new("userId", user.Id ?? string.Empty),
            new("username", user.Username),
            new("role", user.Role)
        };

        var tokenDescriptor = new SecurityTokenDescriptor
        {
            Subject = new ClaimsIdentity(claims),
            Expires = DateTime.UtcNow.AddMinutes(_expirationMinutes),
            Issuer = _issuer,
            Audience = _audience,
            SigningCredentials = new SigningCredentials(
                new SymmetricSecurityKey(key), 
                SecurityAlgorithms.HmacSha256Signature)
        };

        var token = tokenHandler.CreateToken(tokenDescriptor);
        return tokenHandler.WriteToken(token);
    }

    public string GenerateRefreshToken(AppUser user)
    {
        var tokenHandler = new JwtSecurityTokenHandler();
        var key = Encoding.ASCII.GetBytes(_secretKey);

        var claims = new List<Claim>
        {
            new("type", "refresh"),
            new("userId", user.Id ?? string.Empty),
            new("username", user.Username),
            new("role", user.Role),
            new("iat", DateTimeOffset.UtcNow.ToUnixTimeSeconds().ToString(), 
                ClaimValueTypes.Integer64)
        };

        var tokenDescriptor = new SecurityTokenDescriptor
        {
            Subject = new ClaimsIdentity(claims),
            Expires = DateTime.UtcNow.AddDays(_refreshTokenExpirationDays),
            Issuer = _issuer,
            Audience = _audience,
            SigningCredentials = new SigningCredentials(
                new SymmetricSecurityKey(key), 
                SecurityAlgorithms.HmacSha256Signature)
        };

        var token = tokenHandler.CreateToken(tokenDescriptor);
        return tokenHandler.WriteToken(token);
    }

    public ClaimsPrincipal? ValidateToken(string token)
    {
        try
        {
            var tokenHandler = new JwtSecurityTokenHandler();
            var key = Encoding.ASCII.GetBytes(_secretKey);

            var validationParameters = new TokenValidationParameters
            {
                ValidateIssuerSigningKey = true,
                IssuerSigningKey = new SymmetricSecurityKey(key),
                ValidateIssuer = true,
                ValidIssuer = _issuer,
                ValidateAudience = true,
                ValidAudience = _audience,
                ValidateLifetime = true,
                ClockSkew = TimeSpan.Zero
            };

            var principal = tokenHandler.ValidateToken(token, validationParameters, out _);
            return principal;
        }
        catch
        {
            return null;
        }
    }

    public ClaimsPrincipal? ValidateRefreshToken(string refreshToken)
    {
        try
        {
            var tokenHandler = new JwtSecurityTokenHandler();
            var key = Encoding.ASCII.GetBytes(_secretKey);

            var validationParameters = new TokenValidationParameters
            {
                ValidateIssuerSigningKey = true,
                IssuerSigningKey = new SymmetricSecurityKey(key),
                ValidateIssuer = true,
                ValidIssuer = _issuer,
                ValidateAudience = true,
                ValidAudience = _audience,
                ValidateLifetime = true,
                ClockSkew = TimeSpan.Zero
            };

            var principal = tokenHandler.ValidateToken(refreshToken, validationParameters, out _);
            
            // éªŒè¯æ˜¯å¦ä¸ºåˆ·æ–°token
            var tokenType = principal.FindFirst("type")?.Value;
            if (tokenType != "refresh")
            {
                return null;
            }

            return principal;
        }
        catch
        {
            return null;
        }
    }

    public string? GetUserIdFromToken(string token)
    {
        var principal = ValidateToken(token);
        return principal?.FindFirst("userId")?.Value;
    }

    public string? GetUserIdFromRefreshToken(string refreshToken)
    {
        var principal = ValidateRefreshToken(refreshToken);
        return principal?.FindFirst("userId")?.Value;
    }
}
```

### è®¤è¯æ§åˆ¶å™¨

```csharp
// âœ… æ¨èï¼šè®¤è¯æ§åˆ¶å™¨å®ç°
[ApiController]
[Route("api")]
public class AuthController : ControllerBase
{
    private readonly AuthService _authService;

    public AuthController(AuthService authService)
    {
        _authService = authService;
    }

    /// <summary>
    /// è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
    /// </summary>
    [HttpGet("currentUser")]
    [Authorize]
    public async Task<IActionResult> GetCurrentUser()
    {
        try
        {
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è®¤è¯
            if (!User.Identity?.IsAuthenticated ?? true)
            {
                return Ok(ApiResponse<CurrentUser>.UnauthorizedResult("ç”¨æˆ·æœªè®¤è¯"));
            }

            var user = await _authService.GetCurrentUserAsync();
            if (user == null || !user.IsLogin)
            {
                return Ok(ApiResponse<CurrentUser>.UnauthorizedResult("è¯·å…ˆç™»å½•ï¼"));
            }
            
            return Ok(ApiResponse<CurrentUser>.SuccessResult(user));
        }
        catch (Exception ex)
        {
            return Ok(ApiResponse<CurrentUser>.ServerErrorResult(
                $"è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: {ex.Message}"));
        }
    }

    /// <summary>
    /// ç”¨æˆ·ç™»å½•
    /// </summary>
    [HttpPost("login/account")]
    public async Task<IActionResult> Login([FromBody] LoginRequest request)
    {
        var result = await _authService.LoginAsync(request);
        return Ok(result);
    }

    /// <summary>
    /// åˆ·æ–°è®¿é—®token
    /// </summary>
    [HttpPost("refresh-token")]
    public async Task<IActionResult> RefreshToken([FromBody] RefreshTokenRequest request)
    {
        var result = await _authService.RefreshTokenAsync(request);
        return Ok(result);
    }

    /// <summary>
    /// ç”¨æˆ·ç™»å‡º
    /// </summary>
    [HttpPost("login/outLogin")]
    [Authorize]
    public async Task<IActionResult> Logout()
    {
        await _authService.LogoutAsync();
        return Ok(ApiResponse.SuccessResult("ç™»å‡ºæˆåŠŸ"));
    }

    /// <summary>
    /// ç”¨æˆ·æ³¨å†Œ
    /// </summary>
    [HttpPost("register")]
    public async Task<IActionResult> Register([FromBody] RegisterRequest request)
    {
        var result = await _authService.RegisterAsync(request);
        return Ok(result);
    }

    /// <summary>
    /// ä¿®æ”¹å¯†ç 
    /// </summary>
    [HttpPost("change-password")]
    [Authorize]
    public async Task<IActionResult> ChangePassword([FromBody] ChangePasswordRequest request)
    {
        var result = await _authService.ChangePasswordAsync(request);
        return Ok(result);
    }
}
```

### JWT é…ç½®

```csharp
// âœ… æ¨èï¼šProgram.cs ä¸­çš„ JWT é…ç½®
var jwtSecretKey = builder.Configuration["Jwt:SecretKey"] 
    ?? throw new InvalidOperationException("JWT Secret Key not configured");
var jwtIssuer = builder.Configuration["Jwt:Issuer"] ?? "Platform.ApiService";
var jwtAudience = builder.Configuration["Jwt:Audience"] ?? "Platform.Web";

builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuerSigningKey = true,
            IssuerSigningKey = new SymmetricSecurityKey(
                Encoding.ASCII.GetBytes(jwtSecretKey)),
            ValidateIssuer = true,
            ValidIssuer = jwtIssuer,
            ValidateAudience = true,
            ValidAudience = jwtAudience,
            ValidateLifetime = true,
            ClockSkew = TimeSpan.Zero,
            RequireExpirationTime = true,
            RequireSignedTokens = true
        };
    });

builder.Services.AddAuthorization();
```

## ğŸ“Š ç»Ÿä¸€å“åº”æ¨¡å‹

### API å“åº”å°è£…

```csharp
// âœ… æ¨èï¼šç»Ÿä¸€å“åº”æ¨¡å‹
public class ApiResponse
{
    public bool Success { get; set; }
    public string? ErrorMessage { get; set; }
    public string? ErrorCode { get; set; }
    public int? ShowType { get; set; }

    public static ApiResponse SuccessResult(string message = "æ“ä½œæˆåŠŸ")
    {
        return new ApiResponse
        {
            Success = true,
            ErrorMessage = message,
            ShowType = 1
        };
    }

    public static ApiResponse ErrorResult(string message, string? errorCode = null)
    {
        return new ApiResponse
        {
            Success = false,
            ErrorMessage = message,
            ErrorCode = errorCode,
            ShowType = 2
        };
    }
}

public class ApiResponse<T> : ApiResponse
{
    public T? Data { get; set; }

    public static ApiResponse<T> SuccessResult(T data, string message = "æ“ä½œæˆåŠŸ")
    {
        return new ApiResponse<T>
        {
            Success = true,
            Data = data,
            ErrorMessage = message,
            ShowType = 1
        };
    }

    public static ApiResponse<T> UnauthorizedResult(string message = "æœªæˆæƒ")
    {
        return new ApiResponse<T>
        {
            Success = false,
            ErrorMessage = message,
            ErrorCode = "UNAUTHORIZED",
            ShowType = 2
        };
    }

    public static ApiResponse<T> ServerErrorResult(string message = "æœåŠ¡å™¨é”™è¯¯")
    {
        return new ApiResponse<T>
        {
            Success = false,
            ErrorMessage = message,
            ErrorCode = "SERVER_ERROR",
            ShowType = 2
        };
    }
}
```

## ğŸ—„ï¸ MongoDB é«˜çº§ç”¨æ³•

### å¤æ‚æŸ¥è¯¢

```csharp
// âœ… æ¨èï¼šMongoDB æŸ¥è¯¢ç¤ºä¾‹
public class UserService
{
    private readonly IMongoCollection<AppUser> _users;

    public UserService(IMongoDatabase database)
    {
        _users = database.GetCollection<AppUser>("users");
    }

    // åˆ†é¡µæŸ¥è¯¢
    public async Task<(List<AppUser> users, long total)> GetUsersPaginatedAsync(
        int page, 
        int pageSize, 
        string? keyword = null)
    {
        var filterBuilder = Builders<AppUser>.Filter;
        var filter = filterBuilder.Empty;

        // å…³é”®è¯æœç´¢
        if (!string.IsNullOrEmpty(keyword))
        {
            var keywordFilter = filterBuilder.Or(
                filterBuilder.Regex(u => u.Username, new BsonRegularExpression(keyword, "i")),
                filterBuilder.Regex(u => u.Email, new BsonRegularExpression(keyword, "i"))
            );
            filter &= keywordFilter;
        }

        // åªæŸ¥è¯¢æ´»è·ƒç”¨æˆ·
        filter &= filterBuilder.Eq(u => u.IsActive, true);

        var total = await _users.CountDocumentsAsync(filter);
        var users = await _users.Find(filter)
            .Sort(Builders<AppUser>.Sort.Descending(u => u.CreatedAt))
            .Skip((page - 1) * pageSize)
            .Limit(pageSize)
            .ToListAsync();

        return (users, total);
    }

    // æ‰¹é‡æ›´æ–°
    public async Task<long> BulkUpdateUsersAsync(List<string> userIds, UpdateDefinition<AppUser> update)
    {
        var filter = Builders<AppUser>.Filter.In(u => u.Id, userIds);
        var result = await _users.UpdateManyAsync(filter, update);
        return result.ModifiedCount;
    }

    // èšåˆæŸ¥è¯¢
    public async Task<Dictionary<string, int>> GetUserStatsByRoleAsync()
    {
        var pipeline = new[]
        {
            new BsonDocument("$group", new BsonDocument
            {
                { "_id", "$access" },
                { "count", new BsonDocument("$sum", 1) }
            })
        };

        var results = await _users.Aggregate<BsonDocument>(pipeline).ToListAsync();
        return results.ToDictionary(
            r => r["_id"].AsString,
            r => r["count"].AsInt32
        );
    }
}
```

### ç´¢å¼•ç®¡ç†

```csharp
// âœ… æ¨èï¼šåˆ›å»ºç´¢å¼•
public static async Task CreateIndexesAsync(IMongoDatabase database)
{
    var users = database.GetCollection<AppUser>("users");

    // åˆ›å»ºå”¯ä¸€ç´¢å¼•
    var usernameIndex = Builders<AppUser>.IndexKeys.Ascending(u => u.Username);
    await users.Indexes.CreateOneAsync(new CreateIndexModel<AppUser>(
        usernameIndex,
        new CreateIndexOptions { Unique = true }
    ));

    // åˆ›å»ºå¤åˆç´¢å¼•
    var emailAccessIndex = Builders<AppUser>.IndexKeys
        .Ascending(u => u.Email)
        .Ascending(u => u.Access);
    await users.Indexes.CreateOneAsync(new CreateIndexModel<AppUser>(emailAccessIndex));

    // åˆ›å»ºæ–‡æœ¬ç´¢å¼•ï¼ˆç”¨äºå…¨æ–‡æœç´¢ï¼‰
    var textIndex = Builders<AppUser>.IndexKeys.Text(u => u.Username).Text(u => u.Email);
    await users.Indexes.CreateOneAsync(new CreateIndexModel<AppUser>(textIndex));
}
```

## ğŸ¯ BaseApiController ç»Ÿä¸€æ ‡å‡†

### æ ¸å¿ƒè§„èŒƒ
**æ‰€æœ‰æ§åˆ¶å™¨å¿…é¡»ç»§æ‰¿ `BaseApiController`ï¼Œç¦æ­¢ç›´æ¥ç»§æ‰¿ `ControllerBase`**

### BaseApiController æä¾›çš„èƒ½åŠ›

#### ç”¨æˆ·ä¿¡æ¯å±æ€§
```csharp
protected string? CurrentUserId          // å½“å‰ç”¨æˆ·ID
protected string? CurrentUsername        // å½“å‰ç”¨æˆ·å
protected string? CurrentUserRole        // å½“å‰ç”¨æˆ·è§’è‰²
protected bool IsAdmin                   // æ˜¯å¦ç®¡ç†å‘˜
protected bool IsAuthenticated           // æ˜¯å¦å·²è®¤è¯
```

#### å®‰å…¨è·å–ç”¨æˆ·ä¿¡æ¯
```csharp
// è·å–å¿…éœ€çš„ç”¨æˆ·IDï¼ˆä¸ºç©ºåˆ™è‡ªåŠ¨æŠ›å‡º UnauthorizedAccessExceptionï¼‰
var userId = GetRequiredUserId();
```

#### ç»Ÿä¸€å“åº”æ–¹æ³•
```csharp
// æˆåŠŸå“åº”
return Success(data);
return Success(data, "æ“ä½œæˆåŠŸ");
return Success("æ“ä½œæˆåŠŸ");
return SuccessResponse(data);

// é”™è¯¯å“åº”ï¼ˆä¸æ¨èï¼Œå»ºè®®ç›´æ¥æŠ›å¼‚å¸¸ï¼‰
return Error("é”™è¯¯æ¶ˆæ¯");
return NotFoundError("èµ„æºä¸å­˜åœ¨");
return UnauthorizedError("æœªæˆæƒè®¿é—®");
```

### æœ€ä½³å®è·µ

#### âœ… æ­£ç¡®çš„å¼‚å¸¸å¤„ç†
```csharp
// âœ… æ¨èï¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œç”± GlobalExceptionMiddleware å¤„ç†
[HttpGet("{id}")]
public async Task<IActionResult> GetUser(string id)
{
    var user = await _userService.GetUserByIdAsync(id);
    if (user == null)
        throw new KeyNotFoundException($"ç”¨æˆ· {id} ä¸å­˜åœ¨");
    
    return Success(user);
}

// âŒ ä¸æ¨èï¼šæ‰‹åŠ¨ try-catch
[HttpGet("{id}")]
public async Task<IActionResult> GetUser(string id)
{
    try
    {
        var user = await _userService.GetUserByIdAsync(id);
        return Ok(new { success = true, data = user });
    }
    catch (Exception ex)
    {
        return StatusCode(500, new { success = false, error = ex.Message });
    }
}
```

#### âœ… ä½¿ç”¨åŸºç±»æ–¹æ³•
```csharp
// âœ… æ¨èï¼šä½¿ç”¨åŸºç±»æ–¹æ³•
var userId = GetRequiredUserId();
return Success(data);

// âŒ ä¸æ¨èï¼šæ‰‹åŠ¨æå–å’Œæ„å»ºå“åº”
var userId = User.FindFirst("userId")?.Value;
if (string.IsNullOrEmpty(userId))
    return Unauthorized(new { success = false, error = "æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯" });
return Ok(new { success = true, data = data });
```

## ğŸ”§ ä¸­é—´ä»¶æ¶æ„

é¡¹ç›®ä½¿ç”¨ä»¥ä¸‹ä¸­é—´ä»¶å¤„ç†é€šç”¨åŠŸèƒ½ï¼š

### GlobalExceptionMiddleware
- è‡ªåŠ¨æ•è·æ‰€æœ‰æœªå¤„ç†çš„å¼‚å¸¸
- è½¬æ¢ä¸ºç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼
- è‡ªåŠ¨æ·»åŠ  traceId ç”¨äºè¿½è¸ª
- æ ¹æ®å¼‚å¸¸ç±»å‹è¿”å›åˆé€‚çš„ HTTP çŠ¶æ€ç 

### ActivityLogMiddleware
- è‡ªåŠ¨è®°å½•æ‰€æœ‰ API è¯·æ±‚
- è®°å½•ç”¨æˆ·ä¿¡æ¯ã€è¯·æ±‚è·¯å¾„ã€çŠ¶æ€ç ã€è€—æ—¶ç­‰
- æ™ºèƒ½ç”Ÿæˆæ“ä½œç±»å‹å’Œä¸­æ–‡æè¿°
- å¼‚æ­¥è®°å½•ï¼Œä¸é˜»å¡å“åº”

### ResponseFormattingMiddleware
- è‡ªåŠ¨åŒ…è£…æ‰€æœ‰æˆåŠŸå“åº”
- ç¡®ä¿å“åº”æ ¼å¼ç»Ÿä¸€
- è‡ªåŠ¨æ·»åŠ  timestamp

### ä¸­é—´ä»¶é¡ºåº
```csharp
app.UseMiddleware<GlobalExceptionMiddleware>();       // 1. å¼‚å¸¸å¤„ç†ï¼ˆæœ€å¤–å±‚ï¼‰
app.UseAuthentication();                              // 2. è®¤è¯
app.UseAuthorization();                               // 3. æˆæƒ
app.UseMiddleware<ActivityLogMiddleware>();           // 4. æ—¥å¿—è®°å½•
app.UseCors();                                        // 5. è·¨åŸŸ
app.UseMiddleware<ResponseFormattingMiddleware>();    // 6. å“åº”æ ¼å¼åŒ–
app.MapControllers();                                 // 7. æ§åˆ¶å™¨
```

## ğŸš« é¿å…çš„åšæ³•

### æ§åˆ¶å™¨ç›¸å…³
- âŒ ä¸è¦ç›´æ¥ç»§æ‰¿ `ControllerBase`ï¼ˆå¿…é¡»ç»§æ‰¿ `BaseApiController`ï¼‰
- âŒ ä¸è¦æ‰‹åŠ¨æå–ç”¨æˆ·ä¿¡æ¯ï¼ˆä½¿ç”¨ `GetRequiredUserId()`ï¼‰
- âŒ ä¸è¦æ‰‹åŠ¨æ„å»ºå“åº”æ ¼å¼ï¼ˆä½¿ç”¨ `Success()` æ–¹æ³•ï¼‰
- âŒ ä¸è¦ä½¿ç”¨ try-catch åŒ…è£¹ä¸šåŠ¡é€»è¾‘ï¼ˆç”±ä¸­é—´ä»¶å¤„ç†ï¼‰
- âŒ ä¸è¦æ‰‹åŠ¨è®°å½•æ—¥å¿—ï¼ˆç”± ActivityLogMiddleware å¤„ç†ï¼‰
- âŒ ä¸è¦åœ¨æ§åˆ¶å™¨ä¸­ç¼–å†™ä¸šåŠ¡é€»è¾‘

### é€šç”¨è§„èŒƒ
- âŒ ä¸è¦ä½¿ç”¨ `async void`ï¼ˆé™¤äº†äº‹ä»¶å¤„ç†ç¨‹åºï¼‰
- âŒ ä¸è¦å¿½ç•¥å¼‚å¸¸ï¼ˆä½¿ç”¨é€‚å½“çš„å¼‚å¸¸å¤„ç†ï¼‰
- âŒ ä¸è¦ä½¿ç”¨ `string` ä»£æ›¿å¼ºç±»å‹
- âŒ ä¸è¦å¿˜è®°é…ç½®ä¾èµ–æ³¨å…¥
- âŒ ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æš´éœ²æ•æ„Ÿä¿¡æ¯
- âŒ ä¸è¦å¿˜è®°éªŒè¯è¾“å…¥å‚æ•°
- âŒ ä¸è¦ç¡¬ç¼–ç é…ç½®å€¼
- âŒ ä¸è¦å¿˜è®°æ·»åŠ  XML æ–‡æ¡£æ³¨é‡Š

## ğŸ”§ é…ç½®ç®¡ç†

### åº”ç”¨é…ç½®

```csharp
// âœ… æ¨èï¼šä½¿ç”¨ IConfiguration å’Œ Options æ¨¡å¼
public class JwtSettings
{
    public string SecretKey { get; set; } = string.Empty;
    public string RefreshTokenSecret { get; set; } = string.Empty;
    public string Issuer { get; set; } = string.Empty;
    public string Audience { get; set; } = string.Empty;
    public int ExpirationMinutes { get; set; } = 60;
    public int RefreshTokenExpirationDays { get; set; } = 7;
}

// åœ¨ Program.cs ä¸­é…ç½®
builder.Services.Configure<JwtSettings>(
    builder.Configuration.GetSection("Jwt"));

// åœ¨æœåŠ¡ä¸­ä½¿ç”¨
public class AuthService
{
    private readonly JwtSettings _jwtSettings;

    public AuthService(IOptions<JwtSettings> jwtSettings)
    {
        _jwtSettings = jwtSettings.Value;
    }
}
```

### ç¯å¢ƒé…ç½®

```csharp
// âœ… æ¨èï¼šç¯å¢ƒç‰¹å®šé…ç½®
if (builder.Environment.IsDevelopment())
{
    app.MapOpenApi();
    app.UseDeveloperExceptionPage();
}
else
{
    app.UseExceptionHandler("/error");
    app.UseHsts();
}

// é…ç½® CORS
builder.Services.AddCors(options =>
{
    options.AddDefaultPolicy(policy =>
    {
        if (builder.Environment.IsDevelopment())
        {
            policy.AllowAnyOrigin()
                  .AllowAnyMethod()
                  .AllowAnyHeader();
        }
        else
        {
            policy.WithOrigins(builder.Configuration["AllowedOrigins"]!)
                  .AllowAnyMethod()
                  .AllowAnyHeader()
                  .AllowCredentials();
        }
    });
});
```

## ğŸ”§ ä¾èµ–æ³¨å…¥

### æœåŠ¡æ³¨å†Œ

```csharp
// âœ… æ¨èï¼šProgram.cs ä¸­çš„æœåŠ¡æ³¨å†Œ
// MongoDB
builder.AddMongoDBClient(connectionName: "mongodb");

// ä¸šåŠ¡æœåŠ¡
builder.Services.AddSingleton<IJwtService, JwtService>();
builder.Services.AddSingleton<UserService>();
builder.Services.AddSingleton<AuthService>();
builder.Services.AddSingleton<RoleService>();
builder.Services.AddSingleton<MenuService>();

// HTTP ä¸Šä¸‹æ–‡è®¿é—®å™¨
builder.Services.AddHttpContextAccessor();

// å¥åº·æ£€æŸ¥
builder.Services.AddHealthChecks()
    .AddMongoDb(
        builder.Configuration.GetConnectionString("mongodb")!,
        name: "mongodb",
        timeout: TimeSpan.FromSeconds(3));
```

## ğŸ¯ æœ€ä½³å®è·µ

### æ§åˆ¶å™¨å¼€å‘
1. **ç»§æ‰¿ BaseApiController** - æ‰€æœ‰æ§åˆ¶å™¨å¿…é¡»ç»§æ‰¿ BaseApiController
2. **æŠ›å‡ºå¼‚å¸¸** - ä¸è¦ä½¿ç”¨ try-catchï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ç”±ä¸­é—´ä»¶å¤„ç†
3. **ä½¿ç”¨åŸºç±»æ–¹æ³•** - ä½¿ç”¨ `GetRequiredUserId()` å’Œ `Success()` ç­‰æ–¹æ³•
4. **å‚æ•°éªŒè¯** - ä½¿ç”¨ `ArgumentException` è¿›è¡Œå‚æ•°éªŒè¯
5. **ç»Ÿä¸€å“åº”** - ä½¿ç”¨åŸºç±»æä¾›çš„å“åº”æ–¹æ³•

### é€šç”¨å¼€å‘
6. **ä½¿ç”¨å¼‚æ­¥ç¼–ç¨‹** - æ‰€æœ‰ I/O æ“ä½œéƒ½åº”è¯¥æ˜¯å¼‚æ­¥çš„
7. **ä¾èµ–æ³¨å…¥** - ä½¿ç”¨ä¾èµ–æ³¨å…¥ç®¡ç†æœåŠ¡ç”Ÿå‘½å‘¨æœŸ
8. **é…ç½®ç®¡ç†** - ä½¿ç”¨ Options æ¨¡å¼ç®¡ç†é…ç½®
9. **æ—¥å¿—è®°å½•** - ä½¿ç”¨ ILogger è®°å½•æ—¥å¿—ï¼ˆä¸è¦æ‰‹åŠ¨è®°å½•æ´»åŠ¨æ—¥å¿—ï¼‰
10. **é”™è¯¯å¤„ç†** - ä¾èµ– GlobalExceptionMiddleware ç»Ÿä¸€å¤„ç†
11. **API æ–‡æ¡£** - ä½¿ç”¨ XML æ³¨é‡Šå’Œ Swagger/OpenAPI
12. **éªŒè¯** - ä½¿ç”¨æ•°æ®æ³¨è§£æˆ– FluentValidation éªŒè¯è¾“å…¥
13. **åˆ†ç¦»å…³æ³¨ç‚¹** - æ§åˆ¶å™¨åªè´Ÿè´£ HTTP ç›¸å…³é€»è¾‘
14. **ä½¿ç”¨å¼ºç±»å‹** - é¿å…ä½¿ç”¨ `string` æˆ– `object`
15. **å®‰å…¨æ€§** - ä½¿ç”¨ JWT è®¤è¯å’Œæˆæƒ

### å®Œæ•´ç¤ºä¾‹
```csharp
[ApiController]
[Route("api/[controller]")]
[Authorize]
public class ProductController : BaseApiController  // âœ… ç»§æ‰¿åŸºç±»
{
    private readonly IProductService _productService;

    public ProductController(IProductService productService)
    {
        _productService = productService;
    }

    [HttpGet]
    public async Task<IActionResult> GetAll()
    {
        var products = await _productService.GetAllAsync();
        return Success(products);  // âœ… ä½¿ç”¨åŸºç±»æ–¹æ³•
    }

    [HttpGet("{id}")]
    public async Task<IActionResult> GetById(string id)
    {
        var product = await _productService.GetByIdAsync(id);
        if (product == null)
            throw new KeyNotFoundException($"äº§å“ {id} ä¸å­˜åœ¨");  // âœ… æŠ›å‡ºå¼‚å¸¸
        
        return Success(product);
    }

    [HttpPost]
    public async Task<IActionResult> Create([FromBody] CreateProductRequest request)
    {
        if (string.IsNullOrEmpty(request.Name))
            throw new ArgumentException("äº§å“åç§°ä¸èƒ½ä¸ºç©º");  // âœ… å‚æ•°éªŒè¯
        
        var userId = GetRequiredUserId();  // âœ… ä½¿ç”¨åŸºç±»æ–¹æ³•
        var product = await _productService.CreateAsync(request, userId);
        
        return Success(product, "åˆ›å»ºæˆåŠŸ");
    }
}
```