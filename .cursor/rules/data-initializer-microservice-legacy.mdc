---
description: æ•°æ®åˆå§‹åŒ–å¾®æœåŠ¡æ¶æ„å’Œå•å®ä¾‹è¿è¡Œè§„èŒƒ
---
# æ•°æ®åˆå§‹åŒ–å¾®æœåŠ¡è§„èŒƒ

## ğŸ¯ æ¶æ„åŸåˆ™

æ•°æ®åˆå§‹åŒ–å·¥ä½œå·²è¿ç§»åˆ°ä¸“é—¨çš„ `Platform.DataInitializer` å¾®æœåŠ¡ï¼š

1. **å•å®ä¾‹è¿è¡Œ**ï¼šæ•°æ®åˆå§‹åŒ–å¾®æœåŠ¡åªè¿è¡Œä¸€ä¸ªå®ä¾‹
2. **èŒè´£åˆ†ç¦»**ï¼šä¸“é—¨çš„å¾®æœåŠ¡è´Ÿè´£æ•°æ®åˆå§‹åŒ–
3. **å¹‚ç­‰æ€§ä¿è¯**ï¼šæ‰€æœ‰åˆå§‹åŒ–æ“ä½œéƒ½æ˜¯å¹‚ç­‰çš„
4. **ç®€åŒ–æ¶æ„**ï¼šç§»é™¤åˆ†å¸ƒå¼é”å¤æ‚æ€§

## âœ… æ­£ç¡®çš„æ•°æ®åˆå§‹åŒ–æ–¹å¼

### ä½¿ç”¨ä¸“é—¨çš„æ•°æ®åˆå§‹åŒ–å¾®æœåŠ¡

```csharp
// âœ… åœ¨ Platform.DataInitializer ä¸­æ‰§è¡Œåˆå§‹åŒ–
public class DataInitializerService : IDataInitializerService
{
    public async Task InitializeAsync()
    {
        // 1. åˆ›å»ºæ•°æ®åº“ç´¢å¼•
        await CreateIndexesAsync();
        
        // 2. åˆ›å»ºå…¨å±€èœå•
        await CreateSystemMenusAsync();
    }
}
```

### å•å®ä¾‹è¿è¡Œä¿è¯

```csharp
// âœ… ç›´æ¥æ‰§è¡Œåˆå§‹åŒ–ï¼Œæ— éœ€åˆ†å¸ƒå¼é”
await ExecuteInitializationAsync();
// å•å®ä¾‹éƒ¨ç½²ç¡®ä¿ä¸ä¼šæœ‰å¹¶å‘é—®é¢˜
```

### å¹‚ç­‰æ€§ä¿è¯

```csharp
// âœ… æ‰€æœ‰åˆå§‹åŒ–æ“ä½œéƒ½æ˜¯å¹‚ç­‰çš„
private async Task CreateSystemMenusAsync()
{
    // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡
    var existingCount = await menus.CountDocumentsAsync(Builders<Menu>.Filter.Empty);
    if (existingCount > 0)
    {
        _logger.LogInformation("å…¨å±€èœå•å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º");
        return;
    }
    
    // åˆ›å»ºèœå•...
}
```

## âš ï¸ å…³é”®å®ç°ç»†èŠ‚

### å¾®æœåŠ¡æ¶æ„è®¾è®¡

```csharp
// âœ… æ•°æ®åˆå§‹åŒ–å¾®æœåŠ¡æ¶æ„
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Platform.ApiService   â”‚    â”‚ Platform.DataInitializerâ”‚
â”‚                         â”‚    â”‚                         â”‚
â”‚  â€¢ ç”¨æˆ·è®¤è¯            â”‚    â”‚  â€¢ æ•°æ®åº“ç´¢å¼•åˆ›å»º       â”‚
â”‚  â€¢ ä¸šåŠ¡é€»è¾‘            â”‚    â”‚  â€¢ èœå•åˆå§‹åŒ–           â”‚
â”‚  â€¢ API æ¥å£            â”‚    â”‚  â€¢ å•å®ä¾‹è¿è¡Œä¿è¯       â”‚
â”‚  â€¢ æ•°æ®æ“ä½œ            â”‚    â”‚  â€¢ åˆå§‹åŒ–çŠ¶æ€ç®¡ç†       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æœåŠ¡ä¾èµ–å…³ç³»

```csharp
// âœ… æ­£ç¡®çš„æœåŠ¡ä¾èµ–é¡ºåº
MongoDB â†’ DataInitializer â†’ ApiService â†’ Admin/App

// âœ… AppHost é…ç½®
var datainitializer = builder.AddProject<Projects.Platform_DataInitializer>("datainitializer")
    .WithReference(mongodb);

var apiservice = builder.AddProject<Projects.Platform_ApiService>("apiservice")
    .WithReference(mongodb)
    .WithReference(datainitializer);  // ä¾èµ–æ•°æ®åˆå§‹åŒ–æœåŠ¡
```

### ç´¢å¼•åˆ›å»ºç­–ç•¥

```csharp
// âœ… å¹‚ç­‰çš„ç´¢å¼•åˆ›å»º
private async Task CreateIndexesAsync()
{
    // ç´¢å¼•åˆ›å»ºæ˜¯å¹‚ç­‰çš„ï¼Œé‡å¤æ‰§è¡Œä¸ä¼šå‡ºé”™
    await CreateIndexAsync(collection,
        Builders<Menu>.IndexKeys.Ascending(m => m.Name),
        new CreateIndexOptions { Unique = true },
        "menus.name (å…¨å±€å”¯ä¸€)");
}
```

## âŒ å¸¸è§é”™è¯¯

### é”™è¯¯ 1: åœ¨ ApiService ä¸­è¿›è¡Œæ•°æ®åˆå§‹åŒ–

```csharp
// âŒ é”™è¯¯ï¼šåœ¨ Platform.ApiService ä¸­æ‰§è¡Œæ•°æ®åˆå§‹åŒ–
var initializer = scope.ServiceProvider.GetRequiredService<IDatabaseInitializerService>();
await initializer.InitializeAsync();

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ä¸“é—¨çš„ Platform.DataInitializer å¾®æœåŠ¡
// æ•°æ®åˆå§‹åŒ–ç”±ç‹¬ç«‹çš„å¾®æœåŠ¡è´Ÿè´£
```

### é”™è¯¯ 2: å¤šå®ä¾‹éƒ¨ç½²æ•°æ®åˆå§‹åŒ–æœåŠ¡

```csharp
// âŒ é”™è¯¯ï¼šå¤šä¸ª DataInitializer å®ä¾‹åŒæ—¶è¿è¡Œ
.WithReplicas(3)  // âŒ å¯èƒ½å¯¼è‡´é‡å¤åˆå§‹åŒ–

// âœ… æ­£ç¡®ï¼šå•å®ä¾‹éƒ¨ç½²
.WithHttpEndpoint()  // å•å®ä¾‹éƒ¨ç½²
```

### é”™è¯¯ 3: ä¸ä½¿ç”¨å¹‚ç­‰æ€§æ£€æŸ¥

```csharp
// âŒ é”™è¯¯ï¼šä¸æ£€æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–
await menus.InsertManyAsync(newMenus);  // å¯èƒ½é‡å¤æ’å…¥

// âœ… æ­£ç¡®ï¼šå¹‚ç­‰æ€§æ£€æŸ¥
var existingCount = await menus.CountDocumentsAsync(Builders<Menu>.Filter.Empty);
if (existingCount > 0) return;  // å·²å­˜åœ¨ï¼Œè·³è¿‡
await menus.InsertManyAsync(newMenus);
```

### é”™è¯¯ 4: å¿½ç•¥åˆå§‹åŒ–é”™è¯¯

```csharp
// âŒ é”™è¯¯ï¼šåˆå§‹åŒ–å¤±è´¥æ—¶é˜»å¡åº”ç”¨å¯åŠ¨
await initializer.InitializeAsync();  // å¯èƒ½æŠ›å‡ºå¼‚å¸¸

// âœ… æ­£ç¡®ï¼šåˆå§‹åŒ–å¤±è´¥ä¸åº”é˜»æ­¢åº”ç”¨å¯åŠ¨
try
{
    await initializer.InitializeAsync();
}
catch (Exception ex)
{
    _logger.LogError(ex, "æ•°æ®åˆå§‹åŒ–å¤±è´¥");
    // ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå…è®¸åº”ç”¨ç»§ç»­å¯åŠ¨
}
```

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### å•å®ä¾‹è¿è¡Œä¼˜åŠ¿

```csharp
// âœ… å•å®ä¾‹è¿è¡Œçš„ä¼˜åŠ¿
- æ— é”ç«äº‰å¼€é”€
- æ— åˆ†å¸ƒå¼é”é€šä¿¡å»¶è¿Ÿ
- ç®€åŒ–çš„éƒ¨ç½²å’Œè°ƒè¯•
- æ›´å¿«çš„åˆå§‹åŒ–æ‰§è¡Œ
```

### åˆå§‹åŒ–æ€§èƒ½

```csharp
// âœ… ä¼˜åŒ–åˆå§‹åŒ–æ€§èƒ½
- æ‰¹é‡æ“ä½œå‡å°‘æ•°æ®åº“è®¿é—®
- å¹‚ç­‰æ€§æ£€æŸ¥é¿å…é‡å¤å·¥ä½œ
- è¯¦ç»†çš„æ—¥å¿—è®°å½•ä¾¿äºç›‘æ§
- å¼‚å¸¸å¤„ç†ä¸å½±å“åº”ç”¨å¯åŠ¨
```

## ğŸ” æ•…éšœæ’æŸ¥

### æ£€æŸ¥åˆå§‹åŒ–çŠ¶æ€

```javascript
// MongoDB æŸ¥è¯¢èœå•æ•°é‡
db.menus.countDocuments()

// æ£€æŸ¥èœå•æ•°æ®
db.menus.find({}, {name: 1, title: 1}).pretty()

// æ£€æŸ¥ç´¢å¼•çŠ¶æ€
db.menus.getIndexes()
```

### æ‰‹åŠ¨è§¦å‘åˆå§‹åŒ–

```bash
# æ‰‹åŠ¨è§¦å‘æ•°æ®åˆå§‹åŒ–
curl -X POST http://localhost:15000/datainitializer/initialize

# æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://localhost:15000/datainitializer/health
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®åˆå§‹åŒ–å¾®æœåŠ¡æ¶æ„](mdc:docs/features/DATA-INITIALIZER-MICROSERVICE.md)
- [åˆ†å¸ƒå¼é”ç§»é™¤æ€»ç»“æŠ¥å‘Š](mdc:docs/reports/DISTRIBUTED-LOCK-REMOVAL-SUMMARY.md)
- [DataInitializerService å®ç°](mdc:Platform.DataInitializer/Services/DataInitializerService.cs)
- [CreateAllIndexes è„šæœ¬](mdc:Platform.DataInitializer/Scripts/CreateAllIndexes.cs)

## ğŸ¯ è®°ä½

1. **å•å®ä¾‹è¿è¡Œ**ï¼šæ•°æ®åˆå§‹åŒ–å¾®æœåŠ¡åªè¿è¡Œä¸€ä¸ªå®ä¾‹
2. **èŒè´£åˆ†ç¦»**ï¼šä¸“é—¨çš„å¾®æœåŠ¡è´Ÿè´£æ•°æ®åˆå§‹åŒ–
3. **å¹‚ç­‰æ€§ä¿è¯**ï¼šæ‰€æœ‰åˆå§‹åŒ–æ“ä½œéƒ½æ˜¯å¹‚ç­‰çš„
4. **ç®€åŒ–æ¶æ„**ï¼šç§»é™¤åˆ†å¸ƒå¼é”å¤æ‚æ€§
5. **é”™è¯¯å®¹å¿**ï¼šåˆå§‹åŒ–å¤±è´¥ä¸åº”é˜»æ­¢åº”ç”¨å¯åŠ¨
