---
globs: Platform.ApiService/Models/*.cs,Platform.ServiceDefaults/Models/*.cs
description: æ•°æ®æ¨¡å‹è®¾è®¡å’ŒéªŒè¯è§„èŒƒ
---
# æ•°æ®æ¨¡å‹è®¾è®¡å’ŒéªŒè¯è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**æ•°æ®æ¨¡å‹å¿…é¡»å®ç°å¿…è¦çš„æ¥å£ï¼Œæ”¯æŒå¤šç§Ÿæˆ·ã€è½¯åˆ é™¤ã€æ—¶é—´æˆ³å’Œæ“ä½œè¿½è¸ª**

> **æ³¨æ„**: æœ¬è§„èŒƒåŒ…å«è½¯åˆ é™¤å­—æ®µè¦æ±‚ï¼Œè¯¦è§ [åç«¯æ•°æ®æ¨¡å‹ä¸è½¯åˆ é™¤å­—æ®µè§„èŒƒ](#åç«¯æ•°æ®æ¨¡å‹ä¸è½¯åˆ é™¤å­—æ®µè§„èŒƒ) ç« èŠ‚ã€‚

## âœ… å®ä½“æ¨¡å‹è§„èŒƒ

### åŸºç¡€å®ä½“æ¥å£

```csharp
// Platform.ServiceDefaults/Models/BaseEntity.cs
public interface IEntity
{
    string? Id { get; set; }
}

public interface ISoftDeletable
{
    bool IsDeleted { get; set; }
    DateTime? DeletedAt { get; set; }
    string? DeletedBy { get; set; }
    string? DeletedReason { get; set; }
}

public interface ITimestamped
{
    DateTime CreatedAt { get; set; }
    DateTime UpdatedAt { get; set; }
}

public interface IMultiTenant
{
    string CompanyId { get; set; }
}

public interface IOperationTrackable
{
    string? CreatedBy { get; set; }
    string? CreatedByUsername { get; set; }
    string? UpdatedBy { get; set; }
    string? UpdatedByUsername { get; set; }
    string? LastOperationType { get; set; }
    DateTime? LastOperationAt { get; set; }
}
```

### å®ä½“åŸºç±»

```csharp
// Platform.ServiceDefaults/Models/BaseEntity.cs
public abstract class BaseEntity : IEntity, ISoftDeletable, ITimestamped
{
    [BsonId]
    [BsonRepresentation(BsonType.ObjectId)]
    public string? Id { get; set; }

    [BsonElement("isDeleted")]
    public bool IsDeleted { get; set; } = false;

    [BsonElement("deletedAt")]
    public DateTime? DeletedAt { get; set; }

    [BsonElement("deletedBy")]
    public string? DeletedBy { get; set; }

    [BsonElement("deletedReason")]
    public string? DeletedReason { get; set; }

    [BsonElement("createdAt")]
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;

    [BsonElement("updatedAt")]
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
}

public abstract class MultiTenantEntity : BaseEntity, IMultiTenant
{
    [BsonElement("companyId")]
    public string CompanyId { get; set; } = string.Empty;
}

public abstract class TrackableEntity : MultiTenantEntity, IOperationTrackable
{
    [BsonElement("createdBy")]
    public string? CreatedBy { get; set; }

    [BsonElement("createdByUsername")]
    public string? CreatedByUsername { get; set; }

    [BsonElement("updatedBy")]
    public string? UpdatedBy { get; set; }

    [BsonElement("updatedByUsername")]
    public string? UpdatedByUsername { get; set; }

    [BsonElement("lastOperationType")]
    public string? LastOperationType { get; set; }

    [BsonElement("lastOperationAt")]
    public DateTime? LastOperationAt { get; set; }
}
```

### ä¸šåŠ¡å®ä½“å®ç°

```csharp
// Platform.ApiService/Models/UserModels.cs
public class User : TrackableEntity, INamedEntity
{
    [BsonElement("username")]
    public string Username { get; set; } = string.Empty;

    [BsonElement("email")]
    public string Email { get; set; } = string.Empty;

    [BsonElement("passwordHash")]
    public string PasswordHash { get; set; } = string.Empty;

    [BsonElement("role")]
    public string Role { get; set; } = "user";

    [BsonElement("isActive")]
    public bool IsActive { get; set; } = true;

    [BsonElement("lastLoginAt")]
    public DateTime? LastLoginAt { get; set; }

    [BsonElement("profile")]
    public UserProfile? Profile { get; set; }
}

public class Role : MultiTenantEntity, INamedEntity
{
    [BsonElement("name")]
    public string Name { get; set; } = string.Empty;

    [BsonElement("description")]
    public string Description { get; set; } = string.Empty;

    [BsonElement("permissions")]
    public List<string> Permissions { get; set; } = new();

    [BsonElement("isSystemRole")]
    public bool IsSystemRole { get; set; } = false;
}

public class Notice : TrackableEntity
{
    [BsonElement("title")]
    public string Title { get; set; } = string.Empty;

    [BsonElement("content")]
    public string Content { get; set; } = string.Empty;

    [BsonElement("type")]
    public NoticeType Type { get; set; } = NoticeType.Info;

    [BsonElement("isRead")]
    public bool IsRead { get; set; } = false;

    [BsonElement("readAt")]
    public DateTime? ReadAt { get; set; }
}
```

## ğŸ¯ è¯·æ±‚/å“åº”æ¨¡å‹è§„èŒƒ

### è¯·æ±‚æ¨¡å‹

```csharp
// Platform.ApiService/Models/UserModels.cs
public class CreateUserRequest
{
    [Required(ErrorMessage = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")]
    [StringLength(50, MinimumLength = 3, ErrorMessage = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¸ªå­—ç¬¦ä¹‹é—´")]
    [RegularExpression(@"^[a-zA-Z0-9_]+$", ErrorMessage = "ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿")]
    public string Username { get; set; } = string.Empty;

    [Required(ErrorMessage = "é‚®ç®±ä¸èƒ½ä¸ºç©º")]
    [EmailAddress(ErrorMessage = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")]
    public string Email { get; set; } = string.Empty;

    [Required(ErrorMessage = "å¯†ç ä¸èƒ½ä¸ºç©º")]
    [StringLength(100, MinimumLength = 6, ErrorMessage = "å¯†ç é•¿åº¦å¿…é¡»åœ¨6-100ä¸ªå­—ç¬¦ä¹‹é—´")]
    [RegularExpression(@"^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@$!%*#?&]{6,}$", 
        ErrorMessage = "å¯†ç è‡³å°‘6ä½ï¼Œå¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—")]
    public string Password { get; set; } = string.Empty;

    [StringLength(20, ErrorMessage = "è§’è‰²é•¿åº¦ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦")]
    public string Role { get; set; } = "user";

    public UserProfileRequest? Profile { get; set; }
}

public class UpdateUserRequest
{
    [Required(ErrorMessage = "ç”¨æˆ·IDä¸èƒ½ä¸ºç©º")]
    public string Id { get; set; } = string.Empty;

    [StringLength(50, MinimumLength = 3, ErrorMessage = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¸ªå­—ç¬¦ä¹‹é—´")]
    [RegularExpression(@"^[a-zA-Z0-9_]+$", ErrorMessage = "ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿")]
    public string? Username { get; set; }

    [EmailAddress(ErrorMessage = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")]
    public string? Email { get; set; }

    [StringLength(100, MinimumLength = 6, ErrorMessage = "å¯†ç é•¿åº¦å¿…é¡»åœ¨6-100ä¸ªå­—ç¬¦ä¹‹é—´")]
    [RegularExpression(@"^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@$!%*#?&]{6,}$", 
        ErrorMessage = "å¯†ç è‡³å°‘6ä½ï¼Œå¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—")]
    public string? Password { get; set; }

    [StringLength(20, ErrorMessage = "è§’è‰²é•¿åº¦ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦")]
    public string? Role { get; set; }

    public bool? IsActive { get; set; }

    public UserProfileRequest? Profile { get; set; }
}
```

### å“åº”æ¨¡å‹

```csharp
// Platform.ApiService/Models/UserModels.cs
public class UserResponse
{
    public string Id { get; set; } = string.Empty;
    public string Username { get; set; } = string.Empty;
    public string Email { get; set; } = string.Empty;
    public string Role { get; set; } = string.Empty;
    public bool IsActive { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    public DateTime? LastLoginAt { get; set; }
    public UserProfileResponse? Profile { get; set; }
}

public class UserListResponse
{
    public List<UserResponse> Users { get; set; } = new();
    public long Total { get; set; }
    public int Page { get; set; }
    public int PageSize { get; set; }
}

public class UserProfileResponse
{
    public string? FirstName { get; set; }
    public string? LastName { get; set; }
    public string? Phone { get; set; }
    public string? Avatar { get; set; }
    public string? Bio { get; set; }
}
```

## ğŸ¯ éªŒè¯è§„èŒƒ

### æ•°æ®æ³¨è§£éªŒè¯

```csharp
// Platform.ApiService/Models/UserModels.cs
public class CreateUserRequest
{
    [Required(ErrorMessage = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")]
    [StringLength(50, MinimumLength = 3, ErrorMessage = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¸ªå­—ç¬¦ä¹‹é—´")]
    [RegularExpression(@"^[a-zA-Z0-9_]+$", ErrorMessage = "ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿")]
    public string Username { get; set; } = string.Empty;

    [Required(ErrorMessage = "é‚®ç®±ä¸èƒ½ä¸ºç©º")]
    [EmailAddress(ErrorMessage = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")]
    public string Email { get; set; } = string.Empty;

    [Required(ErrorMessage = "å¯†ç ä¸èƒ½ä¸ºç©º")]
    [StringLength(100, MinimumLength = 6, ErrorMessage = "å¯†ç é•¿åº¦å¿…é¡»åœ¨6-100ä¸ªå­—ç¬¦ä¹‹é—´")]
    [RegularExpression(@"^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@$!%*#?&]{6,}$", 
        ErrorMessage = "å¯†ç è‡³å°‘6ä½ï¼Œå¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—")]
    public string Password { get; set; } = string.Empty;
}
```

### è‡ªå®šä¹‰éªŒè¯ç‰¹æ€§

```csharp
// Platform.ApiService/Validators/CustomValidationAttributes.cs
public class UniqueUsernameAttribute : ValidationAttribute
{
    protected override ValidationResult? IsValid(object? value, ValidationContext validationContext)
    {
        if (value is string username && !string.IsNullOrEmpty(username))
        {
            var userService = validationContext.GetService<IUserService>();
            if (userService != null)
            {
                var existingUser = userService.GetUserByUsernameAsync(username).Result;
                if (existingUser != null)
                {
                    return new ValidationResult($"ç”¨æˆ·å '{username}' å·²å­˜åœ¨");
                }
            }
        }
        return ValidationResult.Success;
    }
}

public class ValidCompanyIdAttribute : ValidationAttribute
{
    protected override ValidationResult? IsValid(object? value, ValidationContext validationContext)
    {
        if (value is string companyId && !string.IsNullOrEmpty(companyId))
        {
            var companyService = validationContext.GetService<ICompanyService>();
            if (companyService != null)
            {
                var company = companyService.GetCompanyByIdAsync(companyId).Result;
                if (company == null)
                {
                    return new ValidationResult($"ä¼ä¸šID '{companyId}' ä¸å­˜åœ¨");
                }
            }
        }
        return ValidationResult.Success;
    }
}
```

## ğŸ¯ MongoDB æ˜ å°„è§„èŒƒ

### BSON å…ƒç´ æ˜ å°„

```csharp
// Platform.ApiService/Models/UserModels.cs
public class User : TrackableEntity
{
    [BsonElement("username")]
    public string Username { get; set; } = string.Empty;

    [BsonElement("email")]
    public string Email { get; set; } = string.Empty;

    [BsonElement("passwordHash")]
    [BsonIgnore] // ä¸åœ¨å“åº”ä¸­è¿”å›å¯†ç å“ˆå¸Œ
    public string PasswordHash { get; set; } = string.Empty;

    [BsonElement("role")]
    public string Role { get; set; } = "user";

    [BsonElement("isActive")]
    public bool IsActive { get; set; } = true;

    [BsonElement("lastLoginAt")]
    public DateTime? LastLoginAt { get; set; }

    [BsonElement("profile")]
    public UserProfile? Profile { get; set; }

    [BsonElement("settings")]
    public UserSettings? Settings { get; set; }
}
```

### ç´¢å¼•é…ç½®

```csharp
// Platform.ApiService/Scripts/CreateUserIndexes.cs
public class CreateUserIndexes : IIndexCreationScript
{
    public async Task CreateIndexesAsync(IMongoDatabase database)
    {
        var users = database.GetCollection<User>("users");
        
        // ç”¨æˆ·åå”¯ä¸€ç´¢å¼•ï¼ˆä¼ä¸šå†…å”¯ä¸€ï¼‰
        await users.Indexes.CreateOneAsync(
            new CreateIndexModel<User>(
                Builders<User>.IndexKeys
                    .Ascending(u => u.CompanyId)
                    .Ascending(u => u.Username),
                new CreateIndexOptions
                {
                    Unique = true,
                    Name = "company_username_unique"
                }
            )
        );

        // é‚®ç®±å”¯ä¸€ç´¢å¼•ï¼ˆä¼ä¸šå†…å”¯ä¸€ï¼‰
        await users.Indexes.CreateOneAsync(
            new CreateIndexModel<User>(
                Builders<User>.IndexKeys
                    .Ascending(u => u.CompanyId)
                    .Ascending(u => u.Email),
                new CreateIndexOptions
                {
                    Unique = true,
                    Name = "company_email_unique"
                }
            )
        );

        // å¤åˆæŸ¥è¯¢ç´¢å¼•
        await users.Indexes.CreateOneAsync(
            new CreateIndexModel<User>(
                Builders<User>.IndexKeys
                    .Ascending(u => u.CompanyId)
                    .Ascending(u => u.IsDeleted)
                    .Ascending(u => u.IsActive)
                    .Descending(u => u.CreatedAt),
                new CreateIndexOptions
                {
                    Name = "company_deleted_active_created"
                }
            )
        );
    }
}
```

## ğŸš« ç¦æ­¢çš„åšæ³•

### ä¸è¦å¿½ç•¥æ¥å£å®ç°

```csharp
// âŒ é”™è¯¯ - æ²¡æœ‰å®ç°å¿…è¦çš„æ¥å£
public class User
{
    public string Id { get; set; }
    public string Username { get; set; }
    // ç¼ºå°‘ ISoftDeletable, ITimestamped, IMultiTenant ç­‰æ¥å£
}

// âœ… æ­£ç¡® - å®ç°å¿…è¦çš„æ¥å£
public class User : TrackableEntity, INamedEntity
{
    public string Username { get; set; } = string.Empty;
    // è‡ªåŠ¨ç»§æ‰¿æ‰€æœ‰å¿…è¦çš„æ¥å£å’Œå­—æ®µ
}
```

### ä¸è¦ç¡¬ç¼–ç å­—æ®µå

```csharp
// âŒ é”™è¯¯ - ç¡¬ç¼–ç å­—æ®µå
public class User
{
    [BsonElement("user_name")] // ä¸ä¸€è‡´çš„å‘½å
    public string Username { get; set; }
}

// âœ… æ­£ç¡® - ä½¿ç”¨ä¸€è‡´çš„å‘½åçº¦å®š
public class User
{
    [BsonElement("username")] // ä½¿ç”¨ camelCase
    public string Username { get; set; }
}
```

### ä¸è¦å¿½ç•¥éªŒè¯

```csharp
// âŒ é”™è¯¯ - æ²¡æœ‰éªŒè¯
public class CreateUserRequest
{
    public string Username { get; set; } = string.Empty;
    public string Email { get; set; } = string.Empty;
    public string Password { get; set; } = string.Empty;
}

// âœ… æ­£ç¡® - å®Œæ•´çš„éªŒè¯
public class CreateUserRequest
{
    [Required(ErrorMessage = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")]
    [StringLength(50, MinimumLength = 3)]
    [RegularExpression(@"^[a-zA-Z0-9_]+$")]
    public string Username { get; set; } = string.Empty;

    [Required(ErrorMessage = "é‚®ç®±ä¸èƒ½ä¸ºç©º")]
    [EmailAddress(ErrorMessage = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")]
    public string Email { get; set; } = string.Empty;

    [Required(ErrorMessage = "å¯†ç ä¸èƒ½ä¸ºç©º")]
    [StringLength(100, MinimumLength = 6)]
    [RegularExpression(@"^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@$!%*#?&]{6,}$")]
    public string Password { get; set; } = string.Empty;
}
```

## ğŸ“‹ æ•°æ®æ¨¡å‹å¼€å‘æ£€æŸ¥æ¸…å•

åˆ›å»ºæˆ–ä¿®æ”¹æ•°æ®æ¨¡å‹æ—¶æ£€æŸ¥ï¼š

- [ ] å®ç°å¿…è¦çš„æ¥å£ï¼ˆIEntity, ISoftDeletable, ITimestamped, IMultiTenantï¼‰
- [ ] ä½¿ç”¨æ­£ç¡®çš„åŸºç±»ï¼ˆBaseEntity, MultiTenantEntity, TrackableEntityï¼‰
- [ ] æ·»åŠ é€‚å½“çš„ BSON å…ƒç´ æ˜ å°„
- [ ] å®ç°æ•°æ®éªŒè¯æ³¨è§£
- [ ] åˆ›å»ºç›¸åº”çš„ç´¢å¼•
- [ ] å®šä¹‰è¯·æ±‚/å“åº”æ¨¡å‹
- [ ] æ·»åŠ  XML æ–‡æ¡£æ³¨é‡Š
- [ ] è€ƒè™‘æ•°æ®è¿ç§»éœ€æ±‚
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] æ›´æ–° API æ–‡æ¡£

## ğŸ”§ åç«¯æ•°æ®æ¨¡å‹ä¸è½¯åˆ é™¤å­—æ®µè§„èŒƒ

æœ¬è§„èŒƒè¯¦ç»†è¯´æ˜åç«¯æ•°æ®æ¨¡å‹çš„æ—¶é—´æˆ³ä¸è½¯åˆ é™¤å­—æ®µè¦æ±‚ï¼Œç¡®ä¿ä¸€è‡´æ€§ã€‚

### å¿…é¡»å­—æ®µä¸æ¥å£

#### ITimestamped å¿…é¡»åŒ…å«ï¼š
- `DateTime CreatedAt { get; set; }`
- `DateTime UpdatedAt { get; set; }`
- `DateTime? DeletedAt { get; set; }`ï¼ˆå¯é€‰ï¼Œä½†æ¨èåŒ…å«ï¼‰

#### ISoftDeletable å¿…é¡»åŒ…å«ï¼š
- `bool IsDeleted { get; set; }`
- `DateTime? DeletedAt { get; set; }`
- `string? DeletedBy { get; set; }`
- `string? DeletedReason { get; set; }`

#### BaseEntity å¿…é¡»åŒ…å«ï¼ˆBSON æ˜ å°„å·²é…ç½®ï¼‰ï¼š
- `Id`, `CreatedAt`, `UpdatedAt`, `IsDeleted`
- `DeletedAt`, `DeletedBy`, `DeletedReason`
- `CreatedBy`, `CreatedByUsername`, `UpdatedBy`, `UpdatedByUsername`

ä»£ç å‚è€ƒï¼š
- [Platform.ServiceDefaults/Models/BaseEntity.cs](mdc:Platform.ServiceDefaults/Models/BaseEntity.cs)

### ç¼–ç è¦ç‚¹

- ä¸è¦åœ¨å®ä½“ä¸Šæ‰‹åŠ¨çœç•¥ä¸Šè¿°å­—æ®µï¼›æŒ‰è§„èŒƒå®Œæ•´å®ç°ï¼Œä¾¿äºå®¡è®¡ä¸ä¸€è‡´æ€§ã€‚
- è½¯åˆ é™¤åº”ä»…åˆ‡æ¢ `IsDeleted=true` å¹¶è®¾ç½® `DeletedAt`ã€`DeletedBy`ï¼Œä¸è¦ç›´æ¥ç‰©ç†åˆ é™¤ï¼ˆé™¤éç¡®æœ‰éœ€è¦ï¼‰ã€‚
- é…åˆ"æ•°æ®å·¥å‚è‡ªåŠ¨å®¡è®¡ä¸æ—¶é—´æˆ³è§„èŒƒ"ä½¿ç”¨ï¼Œé¿å…åœ¨æœåŠ¡å±‚æ‰‹åŠ¨ç»´æŠ¤æ—¶é—´æˆ³ä¸æ“ä½œè€…ä¿¡æ¯ã€‚

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“æ“ä½œå·¥å‚ä½¿ç”¨æŒ‡å—](mdc:docs/features/DATABASE-OPERATION-FACTORY-GUIDE.md)
- [å¤šç§Ÿæˆ·ç³»ç»Ÿå¼€å‘è§„èŒƒ](mdc:.cursor/rules/multi-tenant-development.mdc)
- [åç«¯æ•°æ®è®¿é—®å±‚è§„èŒƒ](mdc:.cursor/rules/backend-data-access.mdc)
