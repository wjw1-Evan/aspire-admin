---
globs: Platform.ApiService/Services/*.cs,Platform.ServiceDefaults/Services/*.cs
description: æ•°æ®åº“æ“ä½œå·¥å‚é‡æ„æ€»ç»“å’Œæ¶æ„å˜æ›´
---
# æ•°æ®åº“æ“ä½œå·¥å‚é‡æ„æ€»ç»“

## ğŸ¯ é‡æ„æ¦‚è¿°

æœ¬æ¬¡é‡æ„å½»åº•æ”¹å˜äº†åç«¯æ•°æ®è®¿é—®æ¶æ„ï¼Œä»ä¼ ç»Ÿçš„ `BaseRepository` æ¨¡å¼è¿ç§»åˆ°ç°ä»£åŒ–çš„ `DatabaseOperationFactory` æ¨¡å¼ï¼Œå®ç°äº†æ›´ç»Ÿä¸€ã€æ›´å®‰å…¨ã€æ›´æ˜“ç»´æŠ¤çš„æ•°æ®è®¿é—®å±‚ã€‚

## âœ¨ ä¸»è¦å˜æ›´

### 1. æ¶æ„æ¨¡å¼å˜æ›´

**æ—§æ¶æ„ï¼ˆå·²ç§»é™¤ï¼‰ï¼š**
```csharp
// âŒ å·²ç§»é™¤ï¼šBaseRepository æ¨¡å¼
public class UserService : BaseService
{
    private readonly BaseRepository<User> _userRepository;
    
    public UserService(BaseRepository<User> userRepository)
    {
        _userRepository = userRepository;
    }
}
```

**æ–°æ¶æ„ï¼ˆå½“å‰ï¼‰ï¼š**
```csharp
// âœ… å½“å‰ï¼šDatabaseOperationFactory æ¨¡å¼
public class UserService : IUserService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    
    public UserService(IDatabaseOperationFactory<User> userFactory)
    {
        _userFactory = userFactory;
    }
}
```

### 2. æ ¸å¿ƒç»„ä»¶å˜æ›´

| ç»„ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| `BaseRepository<T>` | âŒ å·²åˆ é™¤ | ä¼ ç»Ÿçš„æ•°æ®è®¿é—®å±‚ |
| `BaseService` | âŒ å·²åˆ é™¤ | é€šç”¨æœåŠ¡åŸºç±» |
| `IDatabaseOperationFactory<T>` | âœ… æ–°å¢ | ç»Ÿä¸€çš„æ•°æ®æ“ä½œå·¥å‚æ¥å£ |
| `DatabaseOperationFactory<T>` | âœ… æ–°å¢ | æ•°æ®æ“ä½œå·¥å‚å®ç° |
| `FilterBuilder<T>` | âœ… æ–°å¢ | é“¾å¼è¿‡æ»¤å™¨æ„å»ºå™¨ |
| `SortBuilder<T>` | âœ… æ–°å¢ | é“¾å¼æ’åºæ„å»ºå™¨ |
| `UpdateBuilder<T>` | âœ… æ–°å¢ | é“¾å¼æ›´æ–°æ„å»ºå™¨ |
| `IAuditService` | âœ… æ–°å¢ | æ“ä½œå®¡è®¡æœåŠ¡ |

### 3. æœåŠ¡å±‚é‡æ„

**æ‰€æœ‰ 14 ä¸ªæœåŠ¡å·²é‡æ„ï¼š**

- `UserService` - ç”¨æˆ·ç®¡ç†æœåŠ¡
- `RoleService` - è§’è‰²ç®¡ç†æœåŠ¡
- `NoticeService` - é€šçŸ¥ç®¡ç†æœåŠ¡
- `TagService` - æ ‡ç­¾ç®¡ç†æœåŠ¡
- `ImageCaptchaService` - å›¾ç‰‡éªŒè¯ç æœåŠ¡
- `CaptchaService` - éªŒè¯ç æœåŠ¡
- `CompanyService` - ä¼ä¸šç®¡ç†æœåŠ¡
- `UserCompanyService` - ç”¨æˆ·ä¼ä¸šå…³è”æœåŠ¡
- `UserActivityLogService` - ç”¨æˆ·æ´»åŠ¨æ—¥å¿—æœåŠ¡
- `RuleService` - è§„åˆ™ç®¡ç†æœåŠ¡
- `MenuAccessService` - èœå•è®¿é—®æœåŠ¡
- `JoinRequestService` - åŠ å…¥è¯·æ±‚æœåŠ¡
- `AuthService` - è®¤è¯æœåŠ¡
- `MenuService` - èœå•ç®¡ç†æœåŠ¡

## ğŸš€ æ–°æ¶æ„ä¼˜åŠ¿

### 1. ç»Ÿä¸€æ•°æ®è®¿é—®
- **å•ä¸€å…¥å£**ï¼šæ‰€æœ‰æ•°æ®åº“æ“ä½œé€šè¿‡ `IDatabaseOperationFactory<T>` è¿›è¡Œ
- **è‡ªåŠ¨è¿‡æ»¤**ï¼šå¤šç§Ÿæˆ·å’Œè½¯åˆ é™¤è¿‡æ»¤è‡ªåŠ¨åº”ç”¨
- **æ“ä½œå®¡è®¡**ï¼šæ‰€æœ‰ CRUD æ“ä½œè‡ªåŠ¨è®°å½•å®¡è®¡æ—¥å¿—

### 2. ç±»å‹å®‰å…¨
- **å¼ºç±»å‹æ„å»ºå™¨**ï¼š`FilterBuilder<T>`ã€`SortBuilder<T>`ã€`UpdateBuilder<T>`
- **ç¼–è¯‘æ—¶æ£€æŸ¥**ï¼šé¿å…è¿è¡Œæ—¶é”™è¯¯
- **æ™ºèƒ½æç¤º**ï¼šIDE æä¾›å®Œæ•´çš„ä»£ç è¡¥å…¨

### 3. ç®€åŒ–æœåŠ¡å±‚
- **ç§»é™¤åŸºç±»ä¾èµ–**ï¼šæœåŠ¡ä¸å†éœ€è¦ç»§æ‰¿ `BaseService`
- **ç›´æ¥ä¾èµ–æ³¨å…¥**ï¼šåªæ³¨å…¥å®é™…éœ€è¦çš„ä¾èµ–
- **æ¸…æ™°èŒè´£**ï¼šæ¯ä¸ªæœåŠ¡ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘

### 4. å¢å¼ºåŠŸèƒ½
- **è·¨ç§Ÿæˆ·æŸ¥è¯¢**ï¼šæ”¯æŒç‰¹æ®Šåœºæ™¯çš„è·¨ç§Ÿæˆ·æ•°æ®è®¿é—®
- **æ‰¹é‡æ“ä½œ**ï¼šé«˜æ•ˆçš„æ‰¹é‡åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤
- **æ“ä½œè¿½è¸ª**ï¼šå®Œæ•´çš„æ“ä½œå†å²å’Œå®¡è®¡è½¨è¿¹

## ğŸ“‹ ä½¿ç”¨æ¨¡å¼

### åŸºç¡€ CRUD æ“ä½œ
```csharp
// åˆ›å»º
var user = await _userFactory.CreateAsync(newUser);

// æŸ¥è¯¢
var users = await _userFactory.FindAsync();

// æ›´æ–°
var success = await _userFactory.UpdateAsync(user);

// è½¯åˆ é™¤
var success = await _userFactory.SoftDeleteAsync(userId);
```

### å¤æ‚æŸ¥è¯¢
```csharp
// ä½¿ç”¨æ„å»ºå™¨è¿›è¡Œå¤æ‚æŸ¥è¯¢
var filter = _userFactory.CreateFilterBuilder()
    .Equal(u => u.IsActive, true)
    .Regex(u => u.Username, keyword)
    .ExcludeDeleted()
    .WithTenant()
    .Build();

var sort = _userFactory.CreateSortBuilder()
    .Descending(u => u.CreatedAt)
    .Build();

var users = await _userFactory.FindAsync(filter, sort);
```

### æ‰¹é‡æ“ä½œ
```csharp
// æ‰¹é‡åˆ›å»º
var users = await _userFactory.CreateManyAsync(userList);

// æ‰¹é‡æ›´æ–°
var filter = _userFactory.CreateFilterBuilder()
    .In(u => u.Id, userIds)
    .Build();

var update = _userFactory.CreateUpdateBuilder()
    .Set(u => u.IsActive, false)
    .SetOperationTracking()
    .Build();

var count = await _userFactory.UpdateManyAsync(filter, update);
```

## ğŸ”§ æœåŠ¡æ³¨å†Œ

### ä¾èµ–æ³¨å…¥é…ç½®
```csharp
// Program.cs
builder.Services.AddDatabaseFactory(); // æ³¨å†Œæ‰€æœ‰å·¥å‚æœåŠ¡

// æˆ–è€…å•ç‹¬æ³¨å†Œ
builder.Services.AddDatabaseOperationFactory<User>();
builder.Services.AddDatabaseOperationFactory<Role>();
```

### æœåŠ¡æ„é€ å‡½æ•°
```csharp
public class UserService : IUserService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    private readonly IMongoCollection<UserActivityLog> _activityLogs;
    private readonly IUniquenessChecker _uniquenessChecker;

    public UserService(
        IDatabaseOperationFactory<User> userFactory,
        IMongoCollection<UserActivityLog> activityLogs,
        IUniquenessChecker uniquenessChecker)
    {
        _userFactory = userFactory;
        _activityLogs = activityLogs;
        _uniquenessChecker = uniquenessChecker;
    }
}
```

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. å¼ºåˆ¶ä½¿ç”¨å·¥å‚
- **ç¦æ­¢ç›´æ¥ä½¿ç”¨** `IMongoCollection<T>` è¿›è¡Œ CRUD æ“ä½œ
- **ç¦æ­¢ä½¿ç”¨** `BaseRepository<T>`ï¼ˆå·²ç§»é™¤ï¼‰
- **å¿…é¡»ä½¿ç”¨** `IDatabaseOperationFactory<T>` è¿›è¡Œæ‰€æœ‰æ•°æ®åº“æ“ä½œ

### 2. å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»
- æ‰€æœ‰æŸ¥è¯¢è‡ªåŠ¨åº”ç”¨ `CompanyId` è¿‡æ»¤
- ç‰¹æ®Šåœºæ™¯ä½¿ç”¨ `FindWithoutTenantFilterAsync()` æ–¹æ³•
- ç¡®ä¿æ•°æ®å®‰å…¨å’Œéš”ç¦»

### 3. è½¯åˆ é™¤ä¼˜å…ˆ
- ä¼˜å…ˆä½¿ç”¨ `SoftDeleteAsync()` è€Œä¸æ˜¯ `HardDeleteAsync()`
- è½¯åˆ é™¤çš„æ•°æ®ä¸ä¼šåœ¨æŸ¥è¯¢ä¸­è¿”å›
- ä¿ç•™æ•°æ®å®Œæ•´æ€§å’Œå®¡è®¡è½¨è¿¹

### 4. æ“ä½œå®¡è®¡
- æ‰€æœ‰æ“ä½œè‡ªåŠ¨è®°å½•å®¡è®¡æ—¥å¿—
- åŒ…å«ç”¨æˆ·ä¿¡æ¯ã€æ—¶é—´æˆ³ã€æ“ä½œç±»å‹
- æ”¯æŒæ•°æ®å˜æ›´å‰åå¯¹æ¯”

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“æ“ä½œå·¥å‚ä½¿ç”¨æŒ‡å—](mdc:docs/features/DATABASE-OPERATION-FACTORY-GUIDE.md)
- [æ•°æ®åº“æ“ä½œå·¥å‚è¿ç§»æŒ‡å—](mdc:docs/features/DATABASE-FACTORY-MIGRATION.md)
- [BaseService å®Œå…¨åˆ é™¤æŠ¥å‘Š](mdc:docs/optimization/BASESERVICE-COMPLETE-REMOVAL.md)
- [åç«¯æ•°æ®è®¿é—®å±‚è§„èŒƒ](mdc:.cursor/rules/backend-data-access.mdc)
- [æ•°æ®åº“æ“ä½œå·¥å‚ä½¿ç”¨è§„èŒƒ](mdc:.cursor/rules/database-operation-factory.mdc)

## ğŸ¯ æ€»ç»“

è¿™æ¬¡é‡æ„å®ç°äº†ï¼š

1. **æ¶æ„ç°ä»£åŒ–**ï¼šä»ä¼ ç»Ÿ Repository æ¨¡å¼å‡çº§åˆ° Factory æ¨¡å¼
2. **ä»£ç ç®€åŒ–**ï¼šç§»é™¤äº†ä¸å¿…è¦çš„æŠ½è±¡å±‚å’ŒåŸºç±»
3. **åŠŸèƒ½å¢å¼º**ï¼šæä¾›äº†æ›´å¼ºå¤§çš„æŸ¥è¯¢ã€å®¡è®¡å’Œæ‰¹é‡æ“ä½œèƒ½åŠ›
4. **ç±»å‹å®‰å…¨**ï¼šé€šè¿‡å¼ºç±»å‹æ„å»ºå™¨ç¡®ä¿ç¼–è¯‘æ—¶å®‰å…¨
5. **ç»Ÿä¸€æ ‡å‡†**ï¼šæ‰€æœ‰æœåŠ¡éµå¾ªç›¸åŒçš„æ•°æ®è®¿é—®æ¨¡å¼

æ–°çš„æ¶æ„æ›´åŠ ç®€æ´ã€å®‰å…¨ã€é«˜æ•ˆï¼Œä¸ºæœªæ¥çš„å¼€å‘å’Œç»´æŠ¤å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚
