---
alwaysApply: true
---
# æ•°æ®åº“åˆå§‹åŒ–è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**æ•°æ®åˆå§‹åŒ–ç”±ä¸“é—¨çš„ Platform.DataInitializer å¾®æœåŠ¡è´Ÿè´£ï¼Œå•å®ä¾‹è¿è¡Œä¿è¯å®‰å…¨**

## âœ… æ­£ç¡®çš„åˆå§‹åŒ–æ–¹å¼

### ä½¿ç”¨ä¸“é—¨çš„æ•°æ®åˆå§‹åŒ–å¾®æœåŠ¡

æ•°æ®åˆå§‹åŒ–å·¥ä½œå·²è¿ç§»åˆ°ç‹¬ç«‹çš„ `Platform.DataInitializer` å¾®æœåŠ¡ï¼š

```csharp
// âœ… åœ¨ Platform.DataInitializer ä¸­æ‰§è¡Œåˆå§‹åŒ–
public class DataInitializerService : IDataInitializerService
{
    public async Task InitializeAsync()
    {
        // 1. åˆ›å»ºæ•°æ®åº“ç´¢å¼•
        await CreateIndexesAsync();
        
        // 2. åˆ›å»ºå…¨å±€èœå•
        await CreateSystemMenusAsync();
    }
}
```

### å•å®ä¾‹è¿è¡Œä¿è¯

```csharp
// âœ… ç›´æ¥æ‰§è¡Œåˆå§‹åŒ–ï¼Œæ— éœ€åˆ†å¸ƒå¼é”
await ExecuteInitializationAsync();
// å•å®ä¾‹éƒ¨ç½²ç¡®ä¿ä¸ä¼šæœ‰å¹¶å‘é—®é¢˜
```

### ç¡®ä¿å¹‚ç­‰æ€§

æ‰€æœ‰åˆå§‹åŒ–æ“ä½œéƒ½å¿…é¡»æ˜¯å¹‚ç­‰çš„ï¼ˆå¯ä»¥å®‰å…¨åœ°é‡å¤æ‰§è¡Œï¼‰ï¼š

```csharp
// âœ… ç´¢å¼•åˆ›å»ºæ˜¯å¹‚ç­‰çš„
try
{
    await collection.Indexes.CreateOneAsync(...);
}
catch (MongoCommandException ex) when (ex.CodeName == "IndexOptionsConflict")
{
    // ç´¢å¼•å·²å­˜åœ¨ï¼Œè·³è¿‡
}

// âœ… æ•°æ®æ’å…¥å‰æ£€æŸ¥
var exists = await collection.Find(x => x.Id == id).AnyAsync();
if (!exists)
{
    await collection.InsertOneAsync(document);
}
```

## âŒ ç¦æ­¢çš„åšæ³•

### ä¸è¦åœ¨ ApiService ä¸­è¿›è¡Œæ•°æ®åˆå§‹åŒ–

```csharp
// âŒ ç¦æ­¢ï¼šåœ¨ Platform.ApiService ä¸­æ‰§è¡Œæ•°æ®åˆå§‹åŒ–
var initializer = scope.ServiceProvider.GetRequiredService<IDatabaseInitializerService>();
await initializer.InitializeAsync();

// âŒ ç¦æ­¢ï¼šç›´æ¥è°ƒç”¨åˆå§‹åŒ–è„šæœ¬
var fixAllEntities = new FixAllEntitiesIsDeletedField(database);
await fixAllEntities.FixAsync();

var migrateToMultiTenant = new MigrateToMultiTenant(database, logger);
await migrateToMultiTenant.MigrateAsync();
```

### ä¸è¦åˆ›å»ºå…¨å±€æ•°æ®ï¼ˆæœ‰åˆç†ä¾‹å¤–ï¼‰

```csharp
// âŒ ç¦æ­¢ï¼šç³»ç»Ÿå¯åŠ¨æ—¶åˆ›å»ºå…¨å±€ä¸šåŠ¡æ•°æ®
var welcomeNotice = new Notice { /* ... */ };
await _notices.InsertOneAsync(welcomeNotice);

// âŒ ç¦æ­¢ï¼šç³»ç»Ÿå¯åŠ¨æ—¶åˆ›å»ºé»˜è®¤ä¼ä¸š
var defaultCompany = new Company { Code = "default", Name = "é»˜è®¤ä¼ä¸š" };
await _companies.InsertOneAsync(defaultCompany);

// âœ… æ­£ç¡®ï¼šåœ¨ç”¨æˆ·æ³¨å†Œæ—¶åˆ›å»ºä¼ä¸šä¸“å±æ•°æ®
var notice = new Notice 
{ 
    CompanyId = company.Id,  // å¿…é¡»æœ‰ CompanyId
    /* ... */
};

// âœ… ä¾‹å¤–ï¼šå¯ä»¥åˆ›å»ºå…¨å±€ç³»ç»Ÿèœå•ï¼ˆv5.0ï¼‰
// èœå•æ˜¯æ‰€æœ‰ä¼ä¸šå…±äº«çš„ç³»ç»Ÿèµ„æº
var menu = new Menu
{
    Name = "user-management",
    Title = "ç”¨æˆ·ç®¡ç†",
    Path = "/system/user-management",
    // æ—  CompanyId - è¿™æ˜¯åˆç†çš„ä¾‹å¤–
};
```

### ä¸è¦ä½¿ç”¨éåŸå­æ“ä½œ

```csharp
// âŒ ç¦æ­¢ï¼šå…ˆæŸ¥è¯¢å†æ›´æ–°ï¼ˆæœ‰ç«æ€æ¡ä»¶ï¼‰
var lock = await _locks.Find(l => l.Name == name).FirstOrDefaultAsync();
if (lock == null)
{
    await _locks.InsertOneAsync(new Lock { Name = name });
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨åŸå­æ“ä½œ
try
{
    await _locks.InsertOneAsync(new Lock { Name = name });
}
catch (MongoWriteException ex) when (ex.WriteError?.Category == ServerErrorCategory.DuplicateKey)
{
    // å·²å­˜åœ¨ï¼Œå¤„ç†å†²çª
}
```

## ğŸ“‹ åˆå§‹åŒ–æ£€æŸ¥æ¸…å•

åœ¨æ·»åŠ æ–°çš„åˆå§‹åŒ–é€»è¾‘æ—¶ï¼Œç¡®ä¿ï¼š

- [ ] åœ¨ `Platform.DataInitializer` å¾®æœåŠ¡ä¸­å®ç°
- [ ] å•å®ä¾‹è¿è¡Œä¿è¯å®‰å…¨
- [ ] æ‰€æœ‰æ“ä½œéƒ½æ˜¯å¹‚ç­‰çš„
- [ ] ä¸åˆ›å»ºå…¨å±€æ•°æ®ï¼ˆå¿…é¡»æœ‰ CompanyIdï¼‰
- [ ] ä½¿ç”¨ MongoDB åŸå­æ“ä½œ
- [ ] æœ‰è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
- [ ] å¼‚å¸¸ä¸ä¼šé˜»å¡åº”ç”¨å¯åŠ¨

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®åˆå§‹åŒ–å¾®æœåŠ¡æ¶æ„](mdc:docs/features/DATA-INITIALIZER-MICROSERVICE.md)
- [åˆ†å¸ƒå¼é”ç§»é™¤æ€»ç»“æŠ¥å‘Š](mdc:docs/reports/DISTRIBUTED-LOCK-REMOVAL-SUMMARY.md)
- [DataInitializerService](mdc:Platform.DataInitializer/Services/DataInitializerService.cs)
- [CreateAllIndexes](mdc:Platform.DataInitializer/Scripts/CreateAllIndexes.cs)
