---
alwaysApply: true
---

# æ•°æ®åº“åˆå§‹åŒ–è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**æ•°æ®åˆå§‹åŒ–ç”±ä¸“é—¨çš„ Platform.DataInitializer å¾®æœåŠ¡è´Ÿè´£ï¼Œå•å®ä¾‹è¿è¡Œä¿è¯å®‰å…¨**

**å¾®æœåŠ¡åœ¨å®Œæˆåˆå§‹åŒ–ä»»åŠ¡åè‡ªåŠ¨åœæ­¢ï¼Œé¿å…èµ„æºæµªè´¹ï¼ŒçŠ¶æ€æ˜¾ç¤ºä¸º"å®Œæˆ"**

## âœ… æ­£ç¡®çš„æ¶æ„è®¾è®¡

### å¾®æœåŠ¡èŒè´£åˆ†ç¦»

```csharp
// âœ… æ•°æ®åˆå§‹åŒ–å¾®æœåŠ¡èŒè´£
Platform.DataInitializer:
- æ•°æ®åº“ç´¢å¼•åˆ›å»º
- å…¨å±€èœå•åˆå§‹åŒ–
- ç³»ç»Ÿæ•°æ®åˆå§‹åŒ–
- å¹‚ç­‰æ€§ä¿è¯

// âœ… API æœåŠ¡èŒè´£
Platform.ApiService:
- ç”¨æˆ·è®¤è¯
- ä¸šåŠ¡é€»è¾‘
- API æ¥å£
- æ•°æ®æ“ä½œ
```

### æœåŠ¡ä¾èµ–å…³ç³»

```csharp
// âœ… æ­£ç¡®çš„æœåŠ¡å¯åŠ¨é¡ºåº
MongoDB â†’ DataInitializer â†’ ApiService â†’ Admin/App

// âœ… AppHost é…ç½®
var datainitializer = builder.AddProject<Projects.Platform_DataInitializer>("datainitializer")
    .WithReference(mongodb)
    .WithHttpEndpoint()
    .WithHttpHealthCheck("/health");

var apiservice = builder.AddProject<Projects.Platform_ApiService>("apiservice")
    .WithReference(mongodb)
    .WithReference(datainitializer);  // ä¾èµ–æ•°æ®åˆå§‹åŒ–æœåŠ¡
```

## ğŸ”§ å®ç°è§„èŒƒ

### æ•°æ®åˆå§‹åŒ–æœåŠ¡å®ç°

```csharp
// âœ… æ­£ç¡®çš„æœåŠ¡å®ç°
public class DataInitializerService : IDataInitializerService
{
    private readonly IMongoDatabase _database;
    private readonly ILogger<DataInitializerService> _logger;

    public async Task InitializeAsync()
    {
        _logger.LogInformation("========== å¼€å§‹æ•°æ®åˆå§‹åŒ– ==========");
        
        try
        {
            await ExecuteInitializationAsync();
            _logger.LogInformation("========== æ•°æ®åˆå§‹åŒ–å®Œæˆ ==========");
            _logger.LogInformation("ğŸ‰ æ‰€æœ‰æ•°æ®åº“ç´¢å¼•å’Œç³»ç»Ÿèœå•å·²æˆåŠŸåˆ›å»º");
            _logger.LogInformation("ğŸ“Š åˆå§‹åŒ–ç»Ÿè®¡ï¼š");
            _logger.LogInformation("   - æ•°æ®åº“ç´¢å¼•ï¼šå·²åˆ›å»º/æ›´æ–°");
            _logger.LogInformation("   - ç³»ç»Ÿèœå•ï¼šå·²åˆ›å»º/éªŒè¯");
            _logger.LogInformation("âœ… DataInitializer ä»»åŠ¡å®Œæˆï¼ŒæœåŠ¡å¯ä»¥å®‰å…¨åœæ­¢");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "âŒ æ•°æ®åˆå§‹åŒ–å¤±è´¥");
            _logger.LogError("ğŸ›‘ DataInitializer å°†åœæ­¢è¿è¡Œï¼Œè¯·æ£€æŸ¥é”™è¯¯æ—¥å¿—");
            throw; // é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œè®© Program.cs å¤„ç†
        }
    }

    private async Task ExecuteInitializationAsync()
    {
        // 1. åˆ›å»ºæ•°æ®åº“ç´¢å¼•
        await CreateIndexesAsync();
        
        // 2. åˆ›å»ºå…¨å±€èœå•
        await CreateSystemMenusAsync();
    }
}
```

### è‡ªåŠ¨åœæ­¢æœºåˆ¶å®ç°

```csharp
// âœ… Program.cs ä¸­çš„è‡ªåŠ¨åœæ­¢å®ç°
// è‡ªåŠ¨æ‰§è¡Œæ•°æ®åˆå§‹åŒ–
using (var scope = app.Services.CreateScope())
{
    var initializer = scope.ServiceProvider.GetRequiredService<IDataInitializerService>();
    var logger = scope.ServiceProvider.GetRequiredService<ILogger<Program>>();
    
    try
    {
        logger.LogInformation("ğŸš€ DataInitializer å¾®æœåŠ¡å¯åŠ¨ï¼Œå¼€å§‹æ‰§è¡Œæ•°æ®åˆå§‹åŒ–...");
        await initializer.InitializeAsync();
        logger.LogInformation("âœ… æ•°æ®åˆå§‹åŒ–å®Œæˆï¼ŒDataInitializer å¾®æœåŠ¡å°†åœæ­¢è¿è¡Œ");
        
        // åˆå§‹åŒ–å®Œæˆåï¼Œä¼˜é›…åœ°åœæ­¢æœåŠ¡
        logger.LogInformation("ğŸ›‘ DataInitializer å¾®æœåŠ¡å·²å®Œæˆä»»åŠ¡ï¼Œæ­£åœ¨åœæ­¢...");
        return; // ç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œ app.RunAsync()
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "âŒ æ•°æ®åˆå§‹åŒ–å¤±è´¥ï¼ŒDataInitializer å¾®æœåŠ¡å°†åœæ­¢è¿è¡Œ");
        return; // å³ä½¿å¤±è´¥ä¹Ÿåœæ­¢æœåŠ¡
    }
}

// è¿™è¡Œä»£ç ä¸ä¼šè¢«æ‰§è¡Œï¼Œå› ä¸ºä¸Šé¢å·²ç» return äº†
await app.RunAsync();
```

### å•å®ä¾‹è¿è¡Œä¿è¯

```csharp
// âœ… ç›´æ¥æ‰§è¡Œåˆå§‹åŒ–ï¼Œæ— éœ€åˆ†å¸ƒå¼é”
await ExecuteInitializationAsync();
// å•å®ä¾‹éƒ¨ç½²ç¡®ä¿ä¸ä¼šæœ‰å¹¶å‘é—®é¢˜
```

### ç¡®ä¿å¹‚ç­‰æ€§

æ‰€æœ‰åˆå§‹åŒ–æ“ä½œéƒ½å¿…é¡»æ˜¯å¹‚ç­‰çš„ï¼ˆå¯ä»¥å®‰å…¨åœ°é‡å¤æ‰§è¡Œï¼‰ï¼š

```csharp
// âœ… ç´¢å¼•åˆ›å»ºæ˜¯å¹‚ç­‰çš„
try
{
    await collection.Indexes.CreateOneAsync(...);
}
catch (MongoCommandException ex) when (ex.CodeName == "IndexOptionsConflict")
{
    // ç´¢å¼•å·²å­˜åœ¨ï¼Œè·³è¿‡
}

// âœ… æ•°æ®æ’å…¥å‰æ£€æŸ¥
var exists = await collection.Find(x => x.Id == id).AnyAsync();
if (!exists)
{
    await collection.InsertOneAsync(document);
}

// âœ… æ‰€æœ‰åˆå§‹åŒ–æ“ä½œå¿…é¡»æ˜¯å¹‚ç­‰çš„
private async Task CreateSystemMenusAsync()
{
    var menus = _database.GetCollection<Menu>("menus");
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡
    var existingCount = await menus.CountDocumentsAsync(Builders<Menu>.Filter.Empty);
    if (existingCount > 0)
    {
        _logger.LogInformation("å…¨å±€èœå•å·²å­˜åœ¨ï¼ˆ{Count} ä¸ªï¼‰ï¼Œè·³è¿‡åˆ›å»º", existingCount);
        return;
    }
    
    // åˆ›å»ºèœå•...
    await menus.InsertManyAsync(newMenus);
}
```

### é”™è¯¯å¤„ç†ç­–ç•¥

```csharp
// âœ… è‡ªåŠ¨åœæ­¢æ¨¡å¼ï¼šå¤±è´¥æ—¶ä¹Ÿåœæ­¢æœåŠ¡
public async Task InitializeAsync()
{
    try
    {
        await ExecuteInitializationAsync();
        _logger.LogInformation("âœ… DataInitializer ä»»åŠ¡å®Œæˆï¼ŒæœåŠ¡å¯ä»¥å®‰å…¨åœæ­¢");
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "âŒ æ•°æ®åˆå§‹åŒ–å¤±è´¥");
        _logger.LogError("ğŸ›‘ DataInitializer å°†åœæ­¢è¿è¡Œï¼Œè¯·æ£€æŸ¥é”™è¯¯æ—¥å¿—");
        throw; // é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œè®© Program.cs å¤„ç†åœæ­¢é€»è¾‘
    }
}

// âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•
private async Task CreateIndexAsync<T>(IMongoCollection<T> collection, 
    IndexKeysDefinition<T> keys, CreateIndexOptions options, string description)
{
    try
    {
        await collection.Indexes.CreateOneAsync(new CreateIndexModel<T>(keys, options));
        _logger.LogInformation("âœ… åˆ›å»ºç´¢å¼•: {Description}", description);
    }
    catch (MongoCommandException ex) when (ex.CodeName == "IndexOptionsConflict")
    {
        _logger.LogDebug("âš ï¸  ç´¢å¼•å·²å­˜åœ¨: {Description}", description);
    }
    catch (Exception ex)
    {
        _logger.LogWarning("åˆ›å»ºç´¢å¼•å¤±è´¥: {Description}, é”™è¯¯: {Error}", description, ex.Message);
    }
}
```

## ğŸš€ éƒ¨ç½²é…ç½®

### å•å®ä¾‹è¿è¡Œä¿è¯

```csharp
// âœ… å•å®ä¾‹éƒ¨ç½²é…ç½®
var datainitializer = builder.AddProject<Projects.Platform_DataInitializer>("datainitializer")
    .WithReference(mongodb)
    .WithHttpEndpoint()  // å•å®ä¾‹éƒ¨ç½²ï¼Œä¸ä½¿ç”¨ WithReplicas
    .WithHttpHealthCheck("/health");

// âŒ ç¦æ­¢å¤šå®ä¾‹éƒ¨ç½²
.WithReplicas(3)  // å¯èƒ½å¯¼è‡´é‡å¤åˆå§‹åŒ–
```

### ç¯å¢ƒé…ç½®

```json
// âœ… appsettings.json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Platform.DataInitializer": "Information"
    }
  }
}

// âœ… appsettings.Development.json
{
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "Platform.DataInitializer": "Debug"
    }
  }
}
```

## ğŸ“Š API ç«¯ç‚¹è®¾è®¡

### å¥åº·æ£€æŸ¥ç«¯ç‚¹

```csharp
// âœ… æä¾›å¥åº·æ£€æŸ¥ç«¯ç‚¹
app.MapGet("/health", () => Results.Ok(new { 
    status = "healthy", 
    service = "DataInitializer" 
}));
```

### æ‰‹åŠ¨åˆå§‹åŒ–ç«¯ç‚¹

```csharp
// âœ… æä¾›æ‰‹åŠ¨åˆå§‹åŒ–ç«¯ç‚¹
app.MapPost("/initialize", async (IDataInitializerService initializer) =>
{
    try
    {
        await initializer.InitializeAsync();
        return Results.Ok(new { message = "æ•°æ®åˆå§‹åŒ–å®Œæˆ" });
    }
    catch (Exception ex)
    {
        return Results.Problem($"æ•°æ®åˆå§‹åŒ–å¤±è´¥: {ex.Message}");
    }
});
```

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### æœåŠ¡çŠ¶æ€ç›‘æ§

```bash
# åœ¨ Aspire Dashboard ä¸­æŸ¥çœ‹ DataInitializer æœåŠ¡çŠ¶æ€
# çŠ¶æ€è¯´æ˜ï¼š
- "è¿è¡Œä¸­" - æœåŠ¡æ­£åœ¨æ‰§è¡Œåˆå§‹åŒ–
- "å®Œæˆ" - åˆå§‹åŒ–æˆåŠŸï¼ŒæœåŠ¡å·²åœæ­¢
- "å¤±è´¥" - åˆå§‹åŒ–å¤±è´¥ï¼ŒæœåŠ¡å·²åœæ­¢
```

### æ—¥å¿—ç›‘æ§

```bash
# åœ¨ Aspire Dashboard ä¸­æŸ¥çœ‹ DataInitializer æœåŠ¡æ—¥å¿—
# å…³æ³¨ä»¥ä¸‹æ—¥å¿—ï¼š
- "ğŸš€ DataInitializer å¾®æœåŠ¡å¯åŠ¨ï¼Œå¼€å§‹æ‰§è¡Œæ•°æ®åˆå§‹åŒ–..."
- "========== å¼€å§‹æ•°æ®åˆå§‹åŒ– =========="
- "âœ… åˆ›å»ºç´¢å¼•: xxx"
- "å…¨å±€èœå•åˆ›å»ºå®Œæˆï¼Œå…±åˆ›å»º x ä¸ªèœå•"
- "========== æ•°æ®åˆå§‹åŒ–å®Œæˆ =========="
- "ğŸ‰ æ‰€æœ‰æ•°æ®åº“ç´¢å¼•å’Œç³»ç»Ÿèœå•å·²æˆåŠŸåˆ›å»º"
- "ğŸ“Š åˆå§‹åŒ–ç»Ÿè®¡ï¼š"
- "âœ… DataInitializer ä»»åŠ¡å®Œæˆï¼ŒæœåŠ¡å¯ä»¥å®‰å…¨åœæ­¢"
- "âœ… æ•°æ®åˆå§‹åŒ–å®Œæˆï¼ŒDataInitializer å¾®æœåŠ¡å°†åœæ­¢è¿è¡Œ"
- "ğŸ›‘ DataInitializer å¾®æœåŠ¡å·²å®Œæˆä»»åŠ¡ï¼Œæ­£åœ¨åœæ­¢..."
```

### æ‰‹åŠ¨æµ‹è¯•

```bash
# æ‰‹åŠ¨è§¦å‘åˆå§‹åŒ–
curl -X POST http://localhost:15000/datainitializer/initialize

# æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://localhost:15000/datainitializer/health

# æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
mongo aspire-admin --eval "db.menus.countDocuments()"
```

### æ•°æ®åº“éªŒè¯

```javascript
// éªŒè¯èœå•åˆå§‹åŒ–
db.menus.countDocuments()        // æ£€æŸ¥èœå•æ•°é‡
db.menus.find({}, {name: 1, title: 1}).pretty()  // æ£€æŸ¥èœå•å†…å®¹

// éªŒè¯ç´¢å¼•åˆ›å»º
db.menus.getIndexes()           // æ£€æŸ¥ç´¢å¼•
```

## âŒ ç¦æ­¢çš„åšæ³•

### ä¸è¦åœ¨ ApiService ä¸­è¿›è¡Œæ•°æ®åˆå§‹åŒ–

```csharp
// âŒ ç¦æ­¢ï¼šåœ¨ Platform.ApiService ä¸­æ‰§è¡Œæ•°æ®åˆå§‹åŒ–
var initializer = scope.ServiceProvider.GetRequiredService<IDatabaseInitializerService>();
await initializer.InitializeAsync();

// âŒ ç¦æ­¢ï¼šç›´æ¥è°ƒç”¨åˆå§‹åŒ–è„šæœ¬
var fixAllEntities = new FixAllEntitiesIsDeletedField(database);
await fixAllEntities.FixAsync();

var migrateToMultiTenant = new MigrateToMultiTenant(database, logger);
await migrateToMultiTenant.MigrateAsync();
```

### ä¸è¦åˆ›å»ºå…¨å±€æ•°æ®ï¼ˆæœ‰åˆç†ä¾‹å¤–ï¼‰

```csharp
// âŒ ç¦æ­¢ï¼šç³»ç»Ÿå¯åŠ¨æ—¶åˆ›å»ºå…¨å±€ä¸šåŠ¡æ•°æ®
var welcomeNotice = new Notice { /* ... */ };
await _notices.InsertOneAsync(welcomeNotice);

// âŒ ç¦æ­¢ï¼šç³»ç»Ÿå¯åŠ¨æ—¶åˆ›å»ºé»˜è®¤ä¼ä¸š
var defaultCompany = new Company { Code = "default", Name = "é»˜è®¤ä¼ä¸š" };
await _companies.InsertOneAsync(defaultCompany);

// âœ… æ­£ç¡®ï¼šåœ¨ç”¨æˆ·æ³¨å†Œæ—¶åˆ›å»ºä¼ä¸šä¸“å±æ•°æ®
var notice = new Notice 
{ 
    CompanyId = company.Id,  // å¿…é¡»æœ‰ CompanyId
    /* ... */
};

// âœ… ä¾‹å¤–ï¼šå¯ä»¥åˆ›å»ºå…¨å±€ç³»ç»Ÿèœå•ï¼ˆv5.0ï¼‰
// èœå•æ˜¯æ‰€æœ‰ä¼ä¸šå…±äº«çš„ç³»ç»Ÿèµ„æº
var menu = new Menu
{
    Name = "user-management",
    Title = "ç”¨æˆ·ç®¡ç†",
    Path = "/system/user-management",
    // æ—  CompanyId - è¿™æ˜¯åˆç†çš„ä¾‹å¤–
};
```

### ä¸è¦ä½¿ç”¨éåŸå­æ“ä½œ

```csharp
// âŒ ç¦æ­¢ï¼šå…ˆæŸ¥è¯¢å†æ›´æ–°ï¼ˆæœ‰ç«æ€æ¡ä»¶ï¼‰
var lock = await _locks.Find(l => l.Name == name).FirstOrDefaultAsync();
if (lock == null)
{
    await _locks.InsertOneAsync(new Lock { Name = name });
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨åŸå­æ“ä½œ
try
{
    await _locks.InsertOneAsync(new Lock { Name = name });
}
catch (MongoWriteException ex) when (ex.WriteError?.Category == ServerErrorCategory.DuplicateKey)
{
    // å·²å­˜åœ¨ï¼Œå¤„ç†å†²çª
}
```

### ä¸è¦å¤šå®ä¾‹éƒ¨ç½²

```csharp
// âŒ ç¦æ­¢ï¼šå¤šä¸ª DataInitializer å®ä¾‹
.WithReplicas(3)  // å¯èƒ½å¯¼è‡´é‡å¤åˆå§‹åŒ–

// âœ… æ­£ç¡®ï¼šå•å®ä¾‹éƒ¨ç½²
.WithHttpEndpoint()  // å•å®ä¾‹éƒ¨ç½²
```

## ğŸ“‹ åˆå§‹åŒ–æ£€æŸ¥æ¸…å•

åœ¨æ·»åŠ æ–°çš„åˆå§‹åŒ–é€»è¾‘æ—¶ï¼Œç¡®ä¿ï¼š

- [ ] åœ¨ `Platform.DataInitializer` å¾®æœåŠ¡ä¸­å®ç°
- [ ] å•å®ä¾‹è¿è¡Œä¿è¯å®‰å…¨
- [ ] æ‰€æœ‰æ“ä½œéƒ½æ˜¯å¹‚ç­‰çš„
- [ ] ä¸åˆ›å»ºå…¨å±€æ•°æ®ï¼ˆå¿…é¡»æœ‰ CompanyIdï¼Œèœå•é™¤å¤–ï¼‰
- [ ] ä½¿ç”¨ MongoDB åŸå­æ“ä½œ
- [ ] æœ‰è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
- [ ] å¼‚å¸¸ä¸ä¼šé˜»å¡åº”ç”¨å¯åŠ¨
- [ ] å®ç°è‡ªåŠ¨åœæ­¢æœºåˆ¶ï¼ˆå®Œæˆæˆ–å¤±è´¥ååœæ­¢ï¼‰
- [ ] æä¾›å¥åº·æ£€æŸ¥ç«¯ç‚¹
- [ ] æä¾›æ‰‹åŠ¨åˆå§‹åŒ–ç«¯ç‚¹
- [ ] åœ¨ Aspire Dashboard ä¸­æ˜¾ç¤ºæ­£ç¡®çš„çŠ¶æ€

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®åˆå§‹åŒ–å¾®æœåŠ¡æ¶æ„](mdc:docs/features/DATA-INITIALIZER-MICROSERVICE.md)
- [DataInitializer å¾®æœåŠ¡è‡ªåŠ¨åœæ­¢ä¼˜åŒ–](mdc:docs/optimization/DATA-INITIALIZER-AUTO-STOP.md)
- [DataInitializer å¾®æœåŠ¡è‡ªåŠ¨åœæ­¢åŠŸèƒ½å®ç°æŠ¥å‘Š](mdc:docs/reports/DATA-INITIALIZER-AUTO-STOP-IMPLEMENTATION.md)
- [åˆ†å¸ƒå¼é”ç§»é™¤æ€»ç»“æŠ¥å‘Š](mdc:docs/reports/DISTRIBUTED-LOCK-REMOVAL-SUMMARY.md)
- [DataInitializerService](mdc:Platform.DataInitializer/Services/DataInitializerService.cs)
- [CreateAllIndexes](mdc:Platform.DataInitializer/Scripts/CreateAllIndexes.cs)

## ğŸ¯ è®°ä½

1. **èŒè´£åˆ†ç¦»** - æ•°æ®åˆå§‹åŒ–ç”±ä¸“é—¨çš„å¾®æœåŠ¡è´Ÿè´£
2. **å•å®ä¾‹è¿è¡Œ** - ç¡®ä¿åªæœ‰ä¸€ä¸ªå®ä¾‹æ‰§è¡Œåˆå§‹åŒ–
3. **å¹‚ç­‰æ€§ä¿è¯** - æ‰€æœ‰æ“ä½œéƒ½å¯ä»¥å®‰å…¨é‡å¤æ‰§è¡Œ
4. **è‡ªåŠ¨åœæ­¢** - å®Œæˆä»»åŠ¡åè‡ªåŠ¨åœæ­¢ï¼Œé¿å…èµ„æºæµªè´¹
5. **çŠ¶æ€æ¸…æ™°** - åœ¨ Aspire Dashboard ä¸­æ˜¾ç¤ºæ˜ç¡®çš„çŠ¶æ€
6. **ç®€åŒ–æ¶æ„** - ç§»é™¤åˆ†å¸ƒå¼é”ç­‰å¤æ‚æœºåˆ¶
