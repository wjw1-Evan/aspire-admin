---
alwaysApply: true
description: æ•°æ®åº“æ“ä½œå·¥å‚ä½¿ç”¨è§„èŒƒ - ç»Ÿä¸€æ•°æ®è®¿é—®å±‚æ¶æ„
---

# æ•°æ®åº“æ“ä½œå·¥å‚ä½¿ç”¨è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**æ‰€æœ‰æœåŠ¡å¿…é¡»ä½¿ç”¨ `IDatabaseOperationFactory<T>` è¿›è¡Œæ•°æ®è®¿é—®ï¼Œç¦æ­¢ç›´æ¥ä½¿ç”¨ `IMongoCollection<T>` æˆ– `BaseRepository<T>`**

## âœ… æ­£ç¡®çš„æ•°æ®è®¿é—®æ–¹å¼

### 1. æœåŠ¡æ„é€ å‡½æ•°æ³¨å…¥

```csharp
public class UserService : IUserService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    private readonly IDatabaseOperationFactory<Role> _roleFactory;
    private readonly IDatabaseOperationFactory<UserCompany> _userCompanyFactory;

    public UserService(
        IDatabaseOperationFactory<User> userFactory,
        IDatabaseOperationFactory<Role> roleFactory,
        IDatabaseOperationFactory<UserCompany> userCompanyFactory)
    {
        _userFactory = userFactory;
        _roleFactory = roleFactory;
        _userCompanyFactory = userCompanyFactory;
    }
}
```

### 2. åŸºæœ¬ CRUD æ“ä½œ

```csharp
// âœ… åˆ›å»ºå®ä½“
var user = new User { Name = "John", Email = "john@example.com" };
await _userFactory.CreateAsync(user);

// âœ… æ‰¹é‡åˆ›å»º
var users = new List<User> { user1, user2 };
await _userFactory.CreateManyAsync(users);

// âœ… æ›´æ–°å®ä½“
user.Name = "Updated Name";
user.UpdatedAt = DateTime.UtcNow;
await _userFactory.UpdateAsync(user);

// âœ… è½¯åˆ é™¤
await _userFactory.SoftDeleteAsync(userId);

// âœ… æ‰¹é‡è½¯åˆ é™¤
await _userFactory.SoftDeleteManyAsync(userIds);

// âœ… ç¡¬åˆ é™¤ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
await _userFactory.HardDeleteAsync(userId);
```

### 3. æŸ¥è¯¢æ“ä½œ

```csharp
// âœ… æ ¹æ®IDè·å–
var user = await _userFactory.GetByIdAsync(userId);

// âœ… æ¡ä»¶æŸ¥è¯¢
var filter = _userFactory.CreateFilterBuilder()
    .Equal(u => u.IsActive, true)
    .Regex(u => u.Name, "John", "i")
    .Build();
var users = await _userFactory.FindAsync(filter);

// âœ… åˆ†é¡µæŸ¥è¯¢
var users = await _userFactory.FindPagedAsync(filter, skip: 0, limit: 10);

// âœ… è®¡æ•°æŸ¥è¯¢
var count = await _userFactory.CountAsync(filter);

// âœ… å­˜åœ¨æ€§æ£€æŸ¥
var exists = await _userFactory.ExistsAsync(filter);
```

### 4. å¤æ‚æŸ¥è¯¢æ„å»º

```csharp
// âœ… ä½¿ç”¨ FilterBuilder
var filter = _userFactory.CreateFilterBuilder()
    .Equal(u => u.CompanyId, companyId)
    .Equal(u => u.IsActive, true)
    .In(u => u.RoleIds, roleIds)
    .Regex(u => u.Name, searchTerm, "i")
    .Build();

// âœ… ä½¿ç”¨ SortBuilder
var sort = _userFactory.CreateSortBuilder()
    .Ascending(u => u.CreatedAt)
    .Descending(u => u.Name)
    .Build();

// âœ… ç»„åˆæŸ¥è¯¢
var users = await _userFactory.FindAsync(filter, sort: sort);
```

### 5. æ•°ç»„æŸ¥è¯¢å¤„ç†

```csharp
// âœ… å¤„ç†æ•°ç»„åŒ…å«æŸ¥è¯¢
var userCompanyFilter = _userCompanyFactory.CreateFilterBuilder()
    .Equal(uc => uc.CompanyId, companyId)
    .Equal(uc => uc.Status, "active")
    .Build();

// ä½¿ç”¨ MongoDB çš„ AnyIn æ“ä½œç¬¦
var anyInFilter = Builders<UserCompany>.Filter.AnyIn(uc => uc.RoleIds, roleIds);
var combinedFilter = Builders<UserCompany>.Filter.And(userCompanyFilter, anyInFilter);
var userCompanies = await _userCompanyFactory.FindAsync(combinedFilter);
```

## âŒ ç¦æ­¢çš„åšæ³•

### 1. ä¸è¦ç›´æ¥ä½¿ç”¨ IMongoCollection

```csharp
// âŒ ç¦æ­¢ï¼šç›´æ¥ä½¿ç”¨ IMongoCollection
private readonly IMongoCollection<User> _users;

public UserService(IMongoDatabase database)
{
    _users = database.GetCollection<User>("users");  // âŒ ç¦æ­¢
}

// âŒ ç¦æ­¢ï¼šç›´æ¥è°ƒç”¨ MongoDB æ–¹æ³•
await _users.InsertOneAsync(user);
await _users.FindAsync(filter);
await _users.UpdateOneAsync(filter, update);
```

### 2. ä¸è¦ä½¿ç”¨ BaseRepository

```csharp
// âŒ ç¦æ­¢ï¼šä½¿ç”¨ BaseRepository
private readonly BaseRepository<User> _userRepository;

public UserService(BaseRepository<User> userRepository)
{
    _userRepository = userRepository;  // âŒ ç¦æ­¢
}
```

### 3. ä¸è¦æ‰‹åŠ¨å¤„ç†å¤šç§Ÿæˆ·è¿‡æ»¤

```csharp
// âŒ ç¦æ­¢ï¼šæ‰‹åŠ¨æ·»åŠ  CompanyId è¿‡æ»¤
var filter = Builders<User>.Filter.And(
    Builders<User>.Filter.Eq(u => u.CompanyId, companyId),  // âŒ å·¥å‚è‡ªåŠ¨å¤„ç†
    Builders<User>.Filter.Eq(u => u.IsActive, true)
);
```

### 4. ä¸è¦æ‰‹åŠ¨å¤„ç†è½¯åˆ é™¤

```csharp
// âŒ ç¦æ­¢ï¼šæ‰‹åŠ¨æ·»åŠ  IsDeleted è¿‡æ»¤
var filter = Builders<User>.Filter.And(
    Builders<User>.Filter.Eq(u => u.IsDeleted, false),  // âŒ å·¥å‚è‡ªåŠ¨å¤„ç†
    Builders<User>.Filter.Eq(u => u.IsActive, true)
);
```

## ğŸ”§ æ¨¡å‹è¦æ±‚

### å®ä½“å¿…é¡»å®ç°çš„æ¥å£

æ‰€æœ‰ä¸ `IDatabaseOperationFactory` ä¸€èµ·ä½¿ç”¨çš„æ¨¡å‹å¿…é¡»å®ç°ï¼š

```csharp
public class User : BaseEntity, 
    Platform.ServiceDefaults.Models.IEntity,
    Platform.ServiceDefaults.Models.ISoftDeletable,
    Platform.ServiceDefaults.Models.ITimestamped
{
    [BsonId]
    [BsonRepresentation(BsonType.ObjectId)]
    public string Id { get; set; } = string.Empty;

    [BsonElement("createdAt")]
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;

    [BsonElement("updatedAt")]
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;

    [BsonElement("isDeleted")]
    public bool IsDeleted { get; set; } = false;

    // å…¶ä»–ä¸šåŠ¡å­—æ®µ...
}
```

### å¿…éœ€å­—æ®µ

- `Id` - ä¸»é”®æ ‡è¯†ç¬¦
- `CreatedAt` - åˆ›å»ºæ—¶é—´
- `UpdatedAt` - æ›´æ–°æ—¶é—´  
- `IsDeleted` - è½¯åˆ é™¤æ ‡è®°

## ğŸ¯ å·¥å‚æä¾›çš„ä¾¿åˆ©æ–¹æ³•

### ç”¨æˆ·ä¸Šä¸‹æ–‡æ–¹æ³•

```csharp
// âœ… è·å–å½“å‰ç”¨æˆ·ID
var userId = _userFactory.GetCurrentUserId();

// âœ… è·å–å½“å‰ç”¨æˆ·å
var username = _userFactory.GetCurrentUsername();

// âœ… è·å–å½“å‰ä¼ä¸šID
var companyId = _userFactory.GetCurrentCompanyId();

// âœ… è·å–å¿…éœ€çš„ç”¨æˆ·IDï¼ˆä¸ºç©ºåˆ™æŠ›å¼‚å¸¸ï¼‰
var userId = _userFactory.GetRequiredUserId();

// âœ… è·å–å¿…éœ€çš„ä¼ä¸šIDï¼ˆä¸ºç©ºåˆ™æŠ›å¼‚å¸¸ï¼‰
var companyId = _userFactory.GetRequiredCompanyId();
```

### æ—¥å¿—è®°å½•æ–¹æ³•

```csharp
// âœ… è®°å½•æ“ä½œæ—¥å¿—
_userFactory.LogOperation("CREATE", "User", userId, "åˆ›å»ºç”¨æˆ·");

// âœ… è®°å½•ä¿¡æ¯æ—¥å¿—
_userFactory.LogInformation("ç”¨æˆ· {UserId} ç™»å½•æˆåŠŸ", userId);

// âœ… è®°å½•é”™è¯¯æ—¥å¿—
_userFactory.LogError("ç”¨æˆ· {UserId} ç™»å½•å¤±è´¥", userId);
```

## ğŸ” ç‰¹æ®ŠæŸ¥è¯¢åœºæ™¯

### 1. è·¨ç§Ÿæˆ·æŸ¥è¯¢

```csharp
// âœ… æŸ¥è¯¢æ—¶ä¸åº”ç”¨å¤šç§Ÿæˆ·è¿‡æ»¤
var users = await _userFactory.FindWithoutTenantFilterAsync(filter);

// âœ… æ ¹æ®IDæŸ¥è¯¢æ—¶ä¸åº”ç”¨å¤šç§Ÿæˆ·è¿‡æ»¤
var user = await _userFactory.GetByIdWithoutTenantFilterAsync(userId);
```

### 2. å¤æ‚æ’åº

```csharp
// âœ… åŠ¨æ€æ’åº
var sortBuilder = _userFactory.CreateSortBuilder();
if (request.SortBy == "name")
    sortBuilder.Ascending(u => u.Name);
else if (request.SortBy == "createdAt")
    sortBuilder.Descending(u => u.CreatedAt);
else
    sortBuilder.Ascending(u => u.Name);  // é»˜è®¤æ’åº

var sort = sortBuilder.Build();
var users = await _userFactory.FindAsync(filter, sort: sort);
```

### 3. æ­£åˆ™è¡¨è¾¾å¼æŸ¥è¯¢

```csharp
// âœ… å¤§å°å†™ä¸æ•æ„Ÿæœç´¢
var filter = _userFactory.CreateFilterBuilder()
    .Regex(u => u.Name, searchTerm, "i")  // "i" è¡¨ç¤ºå¿½ç•¥å¤§å°å†™
    .Build();
```

## ğŸ“‹ ä»£ç å®¡æŸ¥æ¸…å•

åœ¨åˆ›å»ºæˆ–ä¿®æ”¹æœåŠ¡æ—¶ï¼Œæ£€æŸ¥ï¼š

- [ ] æœåŠ¡æ„é€ å‡½æ•°æ³¨å…¥äº† `IDatabaseOperationFactory<T>` è€Œä¸æ˜¯ `IMongoCollection<T>`
- [ ] æ‰€æœ‰æ•°æ®åº“æ“ä½œéƒ½ä½¿ç”¨å·¥å‚æ–¹æ³•
- [ ] æ¨¡å‹ç±»å®ç°äº† `IEntity`, `ISoftDeletable`, `ITimestamped` æ¥å£
- [ ] æ²¡æœ‰æ‰‹åŠ¨æ·»åŠ  `CompanyId` æˆ– `IsDeleted` è¿‡æ»¤æ¡ä»¶
- [ ] ä½¿ç”¨äº†æ­£ç¡®çš„æŸ¥è¯¢æ„å»ºå™¨æ–¹æ³•
- [ ] å¤æ‚æŸ¥è¯¢æ­£ç¡®ä½¿ç”¨äº† MongoDB çš„ `Builders<T>` ç±»
- [ ] æ·»åŠ äº†å¿…è¦çš„ `using MongoDB.Driver;` è¯­å¥

## ğŸš« å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ

### é”™è¯¯ 1: æ¨¡å‹æ¥å£ç¼ºå¤±

```
é”™è¯¯: ç±»å‹"User"ä¸èƒ½ç”¨ä½œæ³›å‹ç±»å‹æˆ–æ–¹æ³•"IDatabaseOperationFactory<T>"ä¸­çš„ç±»å‹å‚æ•°"T"
è§£å†³: è®© User ç±»å®ç° IEntity, ISoftDeletable, ITimestamped æ¥å£
```

### é”™è¯¯ 2: æ–¹æ³•ä¸å­˜åœ¨

```
é”™è¯¯: 'IDatabaseOperationFactory<User>' does not contain a definition for 'FindFirstAsync'
è§£å†³: ä½¿ç”¨ FindAsync(filter).FirstOrDefault() æ›¿ä»£
```

### é”™è¯¯ 3: å‚æ•°ç±»å‹ä¸åŒ¹é…

```
é”™è¯¯: Argument 1: cannot convert from 'string' to 'User'
è§£å†³: UpdateAsync éœ€è¦å®ä½“å¯¹è±¡ï¼Œä¸æ˜¯ID
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [IDatabaseOperationFactory æ¥å£å®šä¹‰](mdc:Platform.ServiceDefaults/Services/IDatabaseOperationFactory.cs)
- [FilterBuilder å®ç°](mdc:Platform.ServiceDefaults/Services/FilterBuilder.cs)
- [UpdateBuilder å®ç°](mdc:Platform.ServiceDefaults/Services/UpdateBuilder.cs)
- [SortBuilder å®ç°](mdc:Platform.ServiceDefaults/Services/SortBuilder.cs)
- [æ•°æ®åº“æ“ä½œå·¥å‚è¿ç§»æ€»ç»“](mdc:docs/features/DATABASE-FACTORY-MIGRATION.md)

## ğŸ¯ è®°ä½

1. **ç»Ÿä¸€ä½¿ç”¨å·¥å‚** - æ‰€æœ‰æ•°æ®è®¿é—®éƒ½é€šè¿‡ `IDatabaseOperationFactory`
2. **è‡ªåŠ¨å¤„ç†** - å¤šç§Ÿæˆ·è¿‡æ»¤å’Œè½¯åˆ é™¤ç”±å·¥å‚è‡ªåŠ¨å¤„ç†
3. **ç±»å‹å®‰å…¨** - ä½¿ç”¨å¼ºç±»å‹çš„æŸ¥è¯¢æ„å»ºå™¨
4. **æ“ä½œå®¡è®¡** - å·¥å‚è‡ªåŠ¨è®°å½•æ‰€æœ‰æ•°æ®åº“æ“ä½œ
5. **ç®€åŒ–ä»£ç ** - å‡å°‘é‡å¤çš„è¿‡æ»¤å’Œæ›´æ–°é€»è¾‘

éµå¾ªè¿™äº›è§„èŒƒï¼Œç¡®ä¿ä»£ç çš„ä¸€è‡´æ€§ã€å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ï¼