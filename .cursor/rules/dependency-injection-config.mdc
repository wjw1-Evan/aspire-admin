---
globs: Platform.ApiService/Program.cs,Platform.ApiService/Services/*.cs,Platform.ServiceDefaults/**/*.cs
description: ä¾èµ–æ³¨å…¥å’Œé…ç½®ç®¡ç†è§„èŒƒ
---

# ä¾èµ–æ³¨å…¥å’Œé…ç½®ç®¡ç†è§„èŒƒ

## ğŸ¯ æ¦‚è¿°

åŸºäº .NET Core ä¾èµ–æ³¨å…¥å®¹å™¨ï¼Œæä¾›ç»Ÿä¸€çš„ä¾èµ–æ³¨å…¥å’Œé…ç½®ç®¡ç†è§„èŒƒã€‚

## ğŸ—ï¸ ä¾èµ–æ³¨å…¥æ¶æ„

### æœåŠ¡ç”Ÿå‘½å‘¨æœŸ

```csharp
// âœ… æ­£ç¡®çš„æœåŠ¡ç”Ÿå‘½å‘¨æœŸé€‰æ‹©
builder.Services.AddSingleton<IConfigurationService, ConfigurationService>();  // å•ä¾‹ï¼šé…ç½®æœåŠ¡
builder.Services.AddScoped<IUserService, UserService>();                      // ä½œç”¨åŸŸï¼šä¸šåŠ¡æœåŠ¡
builder.Services.AddTransient<IValidator, RequestValidator>();                // ç¬æ—¶ï¼šéªŒè¯å™¨
```

### æ¥å£ä¼˜å…ˆåŸåˆ™

```csharp
// âœ… æ¨èï¼šé¢å‘æ¥å£ç¼–ç¨‹
public interface IUserService
{
    Task<User> GetUserByIdAsync(string id);
    Task<User> CreateUserAsync(CreateUserRequest request);
}

public class UserService : IUserService
{
    // å®ç°
}

// æ³¨å†ŒæœåŠ¡
builder.Services.AddScoped<IUserService, UserService>();
```

## âœ… æ¨èåšæ³•

### 1. æœåŠ¡æ³¨å†Œæ¨¡å¼

```csharp
// âœ… æ ‡å‡†æœåŠ¡æ³¨å†Œ
public static class ServiceCollectionExtensions
{
    public static IServiceCollection AddPlatformServices(this IServiceCollection services)
    {
        // æ ¸å¿ƒæœåŠ¡
        services.AddScoped<IPasswordHasher, BCryptPasswordHasher>();
        services.AddScoped<IJwtService, JwtService>();
        
        // ä¸šåŠ¡æœåŠ¡
        services.AddScoped<IUserService, UserService>();
        services.AddScoped<IAuthService, AuthService>();
        services.AddScoped<IRoleService, RoleService>();
        
        // æ•°æ®è®¿é—®æœåŠ¡
        services.AddScoped<IUserRepository, UserRepository>();
        
        return services;
    }
}
```

### 2. é…ç½®ç®¡ç†

```csharp
// âœ… å¼ºç±»å‹é…ç½®
public class JwtSettings
{
    public string SecretKey { get; set; } = string.Empty;
    public string Issuer { get; set; } = string.Empty;
    public string Audience { get; set; } = string.Empty;
    public int ExpirationMinutes { get; set; } = 60;
    public int RefreshTokenExpirationDays { get; set; } = 7;
}

// æ³¨å†Œé…ç½®
builder.Services.Configure<JwtSettings>(builder.Configuration.GetSection("Jwt"));

// ä½¿ç”¨é…ç½®
public class JwtService : IJwtService
{
    private readonly JwtSettings _jwtSettings;
    
    public JwtService(IOptions<JwtSettings> jwtSettings)
    {
        _jwtSettings = jwtSettings.Value;
    }
}
```

### 3. é€‰é¡¹æ¨¡å¼

```csharp
// âœ… é€‰é¡¹æ¨¡å¼å®ç°
public class DatabaseOptions
{
    public string ConnectionString { get; set; } = string.Empty;
    public string DatabaseName { get; set; } = string.Empty;
    public int MaxPoolSize { get; set; } = 100;
    public TimeSpan ConnectionTimeout { get; set; } = TimeSpan.FromSeconds(30);
}

// æ³¨å†Œé€‰é¡¹
builder.Services.Configure<DatabaseOptions>(
    builder.Configuration.GetSection("Database"));

// éªŒè¯é€‰é¡¹
builder.Services.AddOptions<DatabaseOptions>()
    .Bind(builder.Configuration.GetSection("Database"))
    .ValidateDataAnnotations()
    .ValidateOnStart();
```

### 4. å·¥å‚æ¨¡å¼

```csharp
// âœ… æœåŠ¡å·¥å‚æ¨¡å¼
public interface IHttpClientFactory
{
    HttpClient CreateClient(string name);
}

public class CustomHttpClientFactory : IHttpClientFactory
{
    private readonly IHttpClientFactory _httpClientFactory;
    
    public CustomHttpClientFactory(IHttpClientFactory httpClientFactory)
    {
        _httpClientFactory = httpClientFactory;
    }
    
    public HttpClient CreateClient(string name)
    {
        var client = _httpClientFactory.CreateClient(name);
        // é…ç½®å®¢æˆ·ç«¯
        client.DefaultRequestHeaders.Add("User-Agent", "Platform-Client");
        return client;
    }
}

// æ³¨å†Œå·¥å‚
builder.Services.AddHttpClient();
builder.Services.AddScoped<IHttpClientFactory, CustomHttpClientFactory>();
```

### 5. è£…é¥°å™¨æ¨¡å¼

```csharp
// âœ… è£…é¥°å™¨æ¨¡å¼å®ç°
public interface IUserService
{
    Task<User> GetUserByIdAsync(string id);
}

public class UserService : IUserService
{
    // åŸºç¡€å®ç°
}

public class CachedUserService : IUserService
{
    private readonly IUserService _userService;
    private readonly IMemoryCache _cache;
    
    public CachedUserService(IUserService userService, IMemoryCache cache)
    {
        _userService = userService;
        _cache = cache;
    }
    
    public async Task<User> GetUserByIdAsync(string id)
    {
        var cacheKey = $"user_{id}";
        if (_cache.TryGetValue(cacheKey, out User? cachedUser))
            return cachedUser!;
            
        var user = await _userService.GetUserByIdAsync(id);
        _cache.Set(cacheKey, user, TimeSpan.FromMinutes(5));
        return user;
    }
}

// æ³¨å†Œè£…é¥°å™¨
builder.Services.AddScoped<IUserService, UserService>();
builder.Services.Decorate<IUserService, CachedUserService>();
```

## âŒ é¿å…çš„åšæ³•

### 1. ä¸è¦ä½¿ç”¨æœåŠ¡å®šä½å™¨æ¨¡å¼

```csharp
// âŒ é”™è¯¯ï¼šæœåŠ¡å®šä½å™¨æ¨¡å¼
public class UserController : ControllerBase
{
    public async Task<IActionResult> GetUser(string id)
    {
        var userService = HttpContext.RequestServices.GetService<IUserService>();
        // ä½¿ç”¨æœåŠ¡
    }
}

// âœ… æ­£ç¡®ï¼šæ„é€ å‡½æ•°æ³¨å…¥
public class UserController : ControllerBase
{
    private readonly IUserService _userService;
    
    public UserController(IUserService userService)
    {
        _userService = userService;
    }
}
```

### 2. ä¸è¦æ³¨å†Œå…·ä½“ç±»å‹

```csharp
// âŒ é”™è¯¯ï¼šæ³¨å†Œå…·ä½“ç±»å‹
builder.Services.AddScoped<UserService>();

// âœ… æ­£ç¡®ï¼šæ³¨å†Œæ¥å£
builder.Services.AddScoped<IUserService, UserService>();
```

### 3. ä¸è¦è¿‡åº¦ä½¿ç”¨å•ä¾‹

```csharp
// âŒ é”™è¯¯ï¼šä¸šåŠ¡æœåŠ¡ä½¿ç”¨å•ä¾‹
builder.Services.AddSingleton<IUserService, UserService>();

// âœ… æ­£ç¡®ï¼šä¸šåŠ¡æœåŠ¡ä½¿ç”¨ä½œç”¨åŸŸ
builder.Services.AddScoped<IUserService, UserService>();
```

### 4. ä¸è¦å¿½ç•¥é…ç½®éªŒè¯

```csharp
// âŒ é”™è¯¯ï¼šä¸éªŒè¯é…ç½®
builder.Services.Configure<JwtSettings>(builder.Configuration.GetSection("Jwt"));

// âœ… æ­£ç¡®ï¼šéªŒè¯é…ç½®
builder.Services.AddOptions<JwtSettings>()
    .Bind(builder.Configuration.GetSection("Jwt"))
    .ValidateDataAnnotations()
    .ValidateOnStart();
```

## ğŸ”§ æœ€ä½³å®è·µ

### 1. æœåŠ¡å‘ç°å’Œè‡ªåŠ¨æ³¨å†Œ

```csharp
// âœ… è‡ªåŠ¨æ³¨å†ŒæœåŠ¡
public static class ServiceCollectionExtensions
{
    public static IServiceCollection AddServicesFromAssembly(this IServiceCollection services, Assembly assembly)
    {
        var serviceTypes = assembly.GetTypes()
            .Where(t => t.IsClass && !t.IsAbstract)
            .Where(t => t.GetInterfaces().Any(i => i.Name == $"I{t.Name}"));

        foreach (var serviceType in serviceTypes)
        {
            var interfaceType = serviceType.GetInterfaces()
                .First(i => i.Name == $"I{serviceType.Name}");
            
            services.AddScoped(interfaceType, serviceType);
        }

        return services;
    }
}
```

### 2. æ¡ä»¶æ³¨å†Œ

```csharp
// âœ… æ¡ä»¶æ³¨å†ŒæœåŠ¡
if (builder.Environment.IsDevelopment())
{
    builder.Services.AddScoped<IDevelopmentService, DevelopmentService>();
}
else
{
    builder.Services.AddScoped<IProductionService, ProductionService>();
}
```

### 3. é…ç½®çƒ­é‡è½½

```csharp
// âœ… é…ç½®çƒ­é‡è½½
builder.Services.Configure<DatabaseOptions>(options =>
{
    builder.Configuration.GetSection("Database").Bind(options);
    builder.Configuration.GetReloadToken().RegisterChangeCallback(
        _ => builder.Configuration.GetSection("Database").Bind(options), null);
});
```

### 4. å¥åº·æ£€æŸ¥é›†æˆ

```csharp
// âœ… å¥åº·æ£€æŸ¥æœåŠ¡æ³¨å†Œ
builder.Services.AddHealthChecks()
    .AddCheck<DatabaseHealthCheck>("database")
    .AddCheck<ExternalApiHealthCheck>("external-api");

public class DatabaseHealthCheck : IHealthCheck
{
    private readonly IMongoDatabase _database;
    
    public async Task<HealthCheckResult> CheckHealthAsync(HealthCheckContext context, CancellationToken cancellationToken = default)
    {
        try
        {
            await _database.RunCommandAsync((Command<object>)"{ping:1}", cancellationToken: cancellationToken);
            return HealthCheckResult.Healthy("Database is accessible");
        }
        catch (Exception ex)
        {
            return HealthCheckResult.Unhealthy("Database is not accessible", ex);
        }
    }
}
```

## ğŸ“‹ ä¾èµ–æ³¨å…¥æ£€æŸ¥æ¸…å•

æ³¨å†ŒæœåŠ¡æ—¶æ£€æŸ¥ï¼š

- [ ] ä½¿ç”¨æ¥å£è€Œä¸æ˜¯å…·ä½“ç±»å‹
- [ ] é€‰æ‹©æ­£ç¡®çš„ç”Ÿå‘½å‘¨æœŸï¼ˆSingleton/Scoped/Transientï¼‰
- [ ] éªŒè¯é…ç½®é€‰é¡¹
- [ ] æ·»åŠ é€‚å½“çš„æ—¥å¿—è®°å½•
- [ ] è€ƒè™‘æœåŠ¡çš„çº¿ç¨‹å®‰å…¨æ€§
- [ ] é¿å…å¾ªç¯ä¾èµ–
- [ ] ä½¿ç”¨å·¥å‚æ¨¡å¼å¤„ç†å¤æ‚åˆ›å»ºé€»è¾‘
- [ ] æ·»åŠ å¥åº·æ£€æŸ¥ï¼ˆå¦‚é€‚ç”¨ï¼‰
- [ ] è€ƒè™‘æœåŠ¡çš„å¯æµ‹è¯•æ€§
- [ ] æ–‡æ¡£åŒ–æœåŠ¡ä¾èµ–å…³ç³»

## ğŸ§ª æµ‹è¯•ä¾èµ–æ³¨å…¥

```csharp
// âœ… ä¾èµ–æ³¨å…¥æµ‹è¯•
[Test]
public void ServiceCollection_ShouldRegisterAllServices()
{
    // Arrange
    var services = new ServiceCollection();
    services.AddPlatformServices();

    // Act & Assert
    var provider = services.BuildServiceProvider();
    
    Assert.DoesNotThrow(() => provider.GetRequiredService<IUserService>());
    Assert.DoesNotThrow(() => provider.GetRequiredService<IAuthService>());
    Assert.DoesNotThrow(() => provider.GetRequiredService<IRoleService>());
}
```

## ğŸ“š ç›¸å…³èµ„æº

- [.NET ä¾èµ–æ³¨å…¥æ–‡æ¡£](https://docs.microsoft.com/aspnet/core/fundamentals/dependency-injection)
- [é…ç½®é€‰é¡¹æ¨¡å¼](https://docs.microsoft.com/aspnet/core/fundamentals/configuration/options)
- [æœåŠ¡ç”Ÿå‘½å‘¨æœŸ](https://docs.microsoft.com/aspnet/core/fundamentals/dependency-injection#service-lifetimes)
- [Program.cs é…ç½®](mdc:Platform.ApiService/Program.cs)
- [ServiceDefaults æ‰©å±•](mdc:Platform.ServiceDefaults/Extensions.cs)

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

1. **æ¥å£ä¼˜å…ˆ** - é¢å‘æ¥å£ç¼–ç¨‹
2. **ç”Ÿå‘½å‘¨æœŸæ­£ç¡®** - æ ¹æ®ä½¿ç”¨åœºæ™¯é€‰æ‹©ç”Ÿå‘½å‘¨æœŸ
3. **é…ç½®éªŒè¯** - å¯åŠ¨æ—¶éªŒè¯é…ç½®
4. **é¿å…å¾ªç¯ä¾èµ–** - è®¾è®¡æ¸…æ™°çš„ä¾èµ–å…³ç³»
5. **å¯æµ‹è¯•æ€§** - ä¾¿äºå•å…ƒæµ‹è¯•
6. **æ€§èƒ½è€ƒè™‘** - é¿å…ä¸å¿…è¦çš„å¯¹è±¡åˆ›å»º
7. **æ–‡æ¡£åŒ–** - æ˜ç¡®æœåŠ¡èŒè´£å’Œä¾èµ–
8. **é”™è¯¯å¤„ç†** - é€‚å½“çš„å¼‚å¸¸å¤„ç†