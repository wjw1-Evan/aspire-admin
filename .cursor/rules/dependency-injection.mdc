---
globs: Platform.ApiService/Services/*.cs,Platform.ServiceDefaults/Services/*.cs
description: ä¾èµ–æ³¨å…¥å’Œé…ç½®ç®¡ç†è§„èŒƒ
---
# ä¾èµ–æ³¨å…¥å’Œé…ç½®ç®¡ç†è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

### ä½¿ç”¨ä¾èµ–æ³¨å…¥å®ç°æ¾è€¦åˆï¼Œé€šè¿‡é…ç½®ç®¡ç†å®ç°ç¯å¢ƒé€‚é…

## âœ… æœåŠ¡æ³¨å†Œè§„èŒƒ

### åŸºç¡€æœåŠ¡æ³¨å†Œ

```csharp
// Platform.ServiceDefaults/Extensions/ServiceExtensions.cs
public static class ServiceExtensions
{
    /// <summary>
    /// æ·»åŠ æ•°æ®åº“æ“ä½œå·¥å‚æœåŠ¡
    /// </summary>
    public static IServiceCollection AddDatabaseFactory(this IServiceCollection services)
    {
        services.AddScoped<IAuditService, AuditService>();
        services.AddScoped(typeof(IDatabaseOperationFactory<>), typeof(DatabaseOperationFactory<>));
        return services;
    }

    /// <summary>
    /// æ·»åŠ ä¸šåŠ¡æœåŠ¡
    /// </summary>
    public static IServiceCollection AddBusinessServices(this IServiceCollection services)
    {
        // ç”¨æˆ·ç›¸å…³æœåŠ¡
        services.AddScoped<IUserService, UserService>();
        services.AddScoped<IAuthService, AuthService>();
        services.AddScoped<IUserCompanyService, UserCompanyService>();
        services.AddScoped<IUserActivityLogService, UserActivityLogService>();
        
        // ä¼ä¸šç›¸å…³æœåŠ¡
        services.AddScoped<ICompanyService, CompanyService>();
        services.AddScoped<IJoinRequestService, JoinRequestService>();
        
        // æƒé™ç›¸å…³æœåŠ¡
        services.AddScoped<IRoleService, RoleService>();
        services.AddScoped<IMenuService, MenuService>();
        services.AddScoped<IMenuAccessService, MenuAccessService>();
        
        // å·¥å…·æœåŠ¡
        services.AddScoped<IUniquenessChecker, UniquenessChecker>();
        services.AddScoped<IFieldValidationService, FieldValidationService>();
        services.AddScoped<IPasswordHasher, PasswordHasher>();
        services.AddScoped<IJwtService, JwtService>();
        
        // éªŒè¯ç æœåŠ¡
        services.AddScoped<ICaptchaService, CaptchaService>();
        services.AddScoped<IImageCaptchaService, ImageCaptchaService>();
        
        // å…¶ä»–æœåŠ¡
        services.AddScoped<INoticeService, NoticeService>();
        services.AddScoped<ITagService, TagService>();
        services.AddScoped<IRuleService, RuleService>();
        
        return services;
    }
}
```

### MongoDB é›†åˆæ³¨å†Œ

```csharp
// Platform.ApiService/Extensions/MongoDbExtensions.cs
public static class MongoDbExtensions
{
    /// <summary>
    /// æ³¨å†Œ MongoDB é›†åˆ
    /// </summary>
    public static IServiceCollection AddMongoCollections(this IServiceCollection services)
    {
        services.AddSingleton<IMongoCollection<AppUser>>(provider =>
        {
            var database = provider.GetRequiredService<IMongoDatabase>();
            return database.GetCollection<AppUser>("users");
        });

        services.AddSingleton<IMongoCollection<Company>>(provider =>
        {
            var database = provider.GetRequiredService<IMongoDatabase>();
            return database.GetCollection<Company>("companies");
        });

        services.AddSingleton<IMongoCollection<Role>>(provider =>
        {
            var database = provider.GetRequiredService<IMongoDatabase>();
            return database.GetCollection<Role>("roles");
        });

        services.AddSingleton<IMongoCollection<Menu>>(provider =>
        {
            var database = provider.GetRequiredService<IMongoDatabase>();
            return database.GetCollection<Menu>("menus");
        });

        services.AddSingleton<IMongoCollection<UserCompany>>(provider =>
        {
            var database = provider.GetRequiredService<IMongoDatabase>();
            return database.GetCollection<UserCompany>("userCompanies");
        });

        services.AddSingleton<IMongoCollection<UserActivityLog>>(provider =>
        {
            var database = provider.GetRequiredService<IMongoDatabase>();
            return database.GetCollection<UserActivityLog>("userActivityLogs");
        });

        services.AddSingleton<IMongoCollection<CompanyJoinRequest>>(provider =>
        {
            var database = provider.GetRequiredService<IMongoDatabase>();
            return database.GetCollection<CompanyJoinRequest>("joinRequests");
        });

        services.AddSingleton<IMongoCollection<NoticeIconItem>>(provider =>
        {
            var database = provider.GetRequiredService<IMongoDatabase>();
            return database.GetCollection<NoticeIconItem>("notices");
        });

        services.AddSingleton<IMongoCollection<TagItem>>(provider =>
        {
            var database = provider.GetRequiredService<IMongoDatabase>();
            return database.GetCollection<TagItem>("tags");
        });

        services.AddSingleton<IMongoCollection<RuleListItem>>(provider =>
        {
            var database = provider.GetRequiredService<IMongoDatabase>();
            return database.GetCollection<RuleListItem>("rules");
        });

        services.AddSingleton<IMongoCollection<Captcha>>(provider =>
        {
            var database = provider.GetRequiredService<IMongoDatabase>();
            return database.GetCollection<Captcha>("captchas");
        });

        services.AddSingleton<IMongoCollection<CaptchaImage>>(provider =>
        {
            var database = provider.GetRequiredService<IMongoDatabase>();
            return database.GetCollection<CaptchaImage>("captchaImages");
        });

        return services;
    }
}
```

### é…ç½®æœåŠ¡æ³¨å†Œ

```csharp
// Platform.ApiService/Extensions/ConfigurationExtensions.cs
public static class ConfigurationExtensions
{
    /// <summary>
    /// æ·»åŠ é…ç½®æœåŠ¡
    /// </summary>
    public static IServiceCollection AddConfigurationServices(this IServiceCollection services, IConfiguration configuration)
    {
        // ç»‘å®šé…ç½®ç±»
        services.Configure<JwtSettings>(configuration.GetSection("JwtSettings"));
        services.Configure<MongoDbSettings>(configuration.GetSection("MongoDbSettings"));
        services.Configure<AppSettings>(configuration.GetSection("AppSettings"));
        
        // æ³¨å†Œé…ç½®æœåŠ¡
        services.AddSingleton<IConfigurationService, ConfigurationService>();
        
        return services;
    }
}
```

## ğŸ¯ æœåŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†

### ç”Ÿå‘½å‘¨æœŸé€‰æ‹©æŒ‡å—

```csharp
// âœ… æ­£ç¡® - æ ¹æ®ä½¿ç”¨åœºæ™¯é€‰æ‹©ç”Ÿå‘½å‘¨æœŸ
public static class ServiceLifetimeExamples
{
    // Singleton - æ— çŠ¶æ€ã€çº¿ç¨‹å®‰å…¨ã€æ˜‚è´µåˆ›å»º
    services.AddSingleton<IConfigurationService, ConfigurationService>();
    services.AddSingleton<IPasswordHasher, PasswordHasher>();
    services.AddSingleton<IJwtService, JwtService>();
    
    // Scoped - æœ‰çŠ¶æ€ã€è¯·æ±‚çº§åˆ«ã€æ•°æ®åº“æ“ä½œ
    services.AddScoped<IUserService, UserService>();
    services.AddScoped<IAuthService, AuthService>();
    services.AddScoped<IDatabaseOperationFactory<User>, DatabaseOperationFactory<User>>();
    
    // Transient - è½»é‡çº§ã€æ¯æ¬¡åˆ›å»ºæ–°å®ä¾‹
    services.AddTransient<IValidator<User>, UserValidator>();
    services.AddTransient<IMapper<User, UserDto>, UserMapper>();
}
```

### æœåŠ¡å·¥å‚æ¨¡å¼

```csharp
// Platform.ApiService/Services/ServiceFactory.cs
public interface IServiceFactory<T>
{
    T CreateService();
}

public class ServiceFactory<T> : IServiceFactory<T>
{
    private readonly IServiceProvider _serviceProvider;
    private readonly Func<IServiceProvider, T> _factory;

    public ServiceFactory(IServiceProvider serviceProvider, Func<IServiceProvider, T> factory)
    {
        _serviceProvider = serviceProvider;
        _factory = factory;
    }

    public T CreateService()
    {
        return _factory(_serviceProvider);
    }
}

// æ³¨å†ŒæœåŠ¡å·¥å‚
services.AddScoped<IServiceFactory<IUserService>>(provider =>
    new ServiceFactory<IUserService>(provider, sp => sp.GetRequiredService<IUserService>()));
```

## ğŸ¯ é…ç½®ç®¡ç†è§„èŒƒ

### é…ç½®ç±»å®šä¹‰

```csharp
// Platform.ApiService/Configuration/JwtSettings.cs
public class JwtSettings
{
    public string SecretKey { get; set; } = string.Empty;
    public string Issuer { get; set; } = string.Empty;
    public string Audience { get; set; } = string.Empty;
    public int ExpirationMinutes { get; set; } = 60;
    public int RefreshTokenExpirationDays { get; set; } = 7;
}

// Platform.ApiService/Configuration/MongoDbSettings.cs
public class MongoDbSettings
{
    public string ConnectionString { get; set; } = string.Empty;
    public string DatabaseName { get; set; } = string.Empty;
    public int ConnectionTimeoutSeconds { get; set; } = 30;
    public int MaxPoolSize { get; set; } = 100;
}

// Platform.ApiService/Configuration/AppSettings.cs
public class AppSettings
{
    public bool EnableSwagger { get; set; } = true;
    public bool EnableCors { get; set; } = true;
    public string[] AllowedOrigins { get; set; } = Array.Empty<string>();
    public int MaxRequestSizeBytes { get; set; } = 10485760; // 10MB
}
```

### é…ç½®éªŒè¯

```csharp
// Platform.ApiService/Configuration/ConfigurationValidator.cs
public static class ConfigurationValidator
{
    public static void ValidateConfiguration(IServiceCollection services, IConfiguration configuration)
    {
        var jwtSettings = configuration.GetSection("JwtSettings").Get<JwtSettings>();
        if (jwtSettings == null || string.IsNullOrEmpty(jwtSettings.SecretKey))
        {
            throw new InvalidOperationException("JWT settings are not configured properly");
        }

        var mongoSettings = configuration.GetSection("MongoDbSettings").Get<MongoDbSettings>();
        if (mongoSettings == null || string.IsNullOrEmpty(mongoSettings.ConnectionString))
        {
            throw new InvalidOperationException("MongoDB settings are not configured properly");
        }

        // éªŒè¯å…¶ä»–å…³é”®é…ç½®
        ValidateRequiredSettings(configuration);
    }

    private static void ValidateRequiredSettings(IConfiguration configuration)
    {
        var requiredSettings = new[]
        {
            "JwtSettings:SecretKey",
            "JwtSettings:Issuer",
            "JwtSettings:Audience",
            "MongoDbSettings:ConnectionString",
            "MongoDbSettings:DatabaseName"
        };

        foreach (var setting in requiredSettings)
        {
            if (string.IsNullOrEmpty(configuration[setting]))
            {
                throw new InvalidOperationException($"Required setting '{setting}' is not configured");
            }
        }
    }
}
```

### ç¯å¢ƒç‰¹å®šé…ç½®

```csharp
// Platform.ApiService/Configuration/EnvironmentConfiguration.cs
public static class EnvironmentConfiguration
{
    public static void ConfigureEnvironment(WebApplicationBuilder builder)
    {
        var environment = builder.Environment.EnvironmentName;
        
        // æ ¹æ®ç¯å¢ƒåŠ è½½ä¸åŒçš„é…ç½®æ–‡ä»¶
        builder.Configuration
            .SetBasePath(builder.Environment.ContentRootPath)
            .AddJsonFile("appsettings.json", optional: false, reloadOnChange: true)
            .AddJsonFile($"appsettings.{environment}.json", optional: true, reloadOnChange: true)
            .AddEnvironmentVariables();

        // å¼€å‘ç¯å¢ƒç‰¹å®šé…ç½®
        if (environment == "Development")
        {
            builder.Configuration.AddUserSecrets<Program>();
        }

        // ç”Ÿäº§ç¯å¢ƒç‰¹å®šé…ç½®
        if (environment == "Production")
        {
            builder.Configuration.AddAzureKeyVault();
        }
    }
}
```

## ğŸ¯ æœåŠ¡è§£æå’Œæ³¨å…¥

### æ„é€ å‡½æ•°æ³¨å…¥

```csharp
// âœ… æ­£ç¡® - æ„é€ å‡½æ•°æ³¨å…¥
public class UserService : IUserService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    private readonly ILogger<UserService> _logger;

    public UserService(
        IDatabaseOperationFactory<User> userFactory,
        ILogger<UserService> logger)
    {
        _userFactory = userFactory;
        _logger = logger;
    }
}
```

### æ–¹æ³•æ³¨å…¥

```csharp
// âœ… æ­£ç¡® - æ–¹æ³•æ³¨å…¥ï¼ˆç”¨äºä¸­é—´ä»¶ï¼‰
public class ActivityLogMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger<ActivityLogMiddleware> _logger;

    public ActivityLogMiddleware(RequestDelegate next, ILogger<ActivityLogMiddleware> logger)
    {
        _next = next;
        _logger = logger;
    }

    public async Task InvokeAsync(HttpContext context, IUserActivityLogService logService)
    {
        // ä½¿ç”¨æ³¨å…¥çš„æœåŠ¡
        await logService.LogActivityAsync(activityData);
        await _next(context);
    }
}
```

### æœåŠ¡å®šä½å™¨æ¨¡å¼ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰

```csharp
// âš ï¸ è°¨æ…ä½¿ç”¨ - æœåŠ¡å®šä½å™¨æ¨¡å¼
public class ServiceLocator
{
    private readonly IServiceProvider _serviceProvider;

    public ServiceLocator(IServiceProvider serviceProvider)
    {
        _serviceProvider = serviceProvider;
    }

    public T GetService<T>() where T : class
    {
        return _serviceProvider.GetRequiredService<T>();
    }

    public T? GetOptionalService<T>() where T : class
    {
        return _serviceProvider.GetService<T>();
    }
}
```

## ğŸš« ç¦æ­¢çš„åšæ³•

### ä¸è¦ä½¿ç”¨æœåŠ¡å®šä½å™¨æ¨¡å¼

```csharp
// âŒ é”™è¯¯ - è¿‡åº¦ä½¿ç”¨æœåŠ¡å®šä½å™¨
public class UserService
{
    private readonly IServiceProvider _serviceProvider;

    public UserService(IServiceProvider serviceProvider)
    {
        _serviceProvider = serviceProvider;
    }

    public async Task<User> GetUserAsync(string id)
    {
        var userFactory = _serviceProvider.GetRequiredService<IDatabaseOperationFactory<User>>();
        var logger = _serviceProvider.GetRequiredService<ILogger<UserService>>();
        // æ¯æ¬¡éƒ½è¦è§£ææœåŠ¡ï¼Œé™ä½æ€§èƒ½
    }
}

// âœ… æ­£ç¡® - ç›´æ¥æ³¨å…¥ä¾èµ–
public class UserService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    private readonly ILogger<UserService> _logger;

    public UserService(
        IDatabaseOperationFactory<User> userFactory,
        ILogger<UserService> logger)
    {
        _userFactory = userFactory;
        _logger = logger;
    }
}
```

### ä¸è¦å¿½ç•¥ç”Ÿå‘½å‘¨æœŸ

```csharp
// âŒ é”™è¯¯ - ç”Ÿå‘½å‘¨æœŸä¸åŒ¹é…
public class UserService
{
    private readonly ILogger<UserService> _logger; // Scoped
    private readonly IConfiguration _configuration; // Singleton
    // æ··åˆç”Ÿå‘½å‘¨æœŸå¯èƒ½å¯¼è‡´é—®é¢˜
}

// âœ… æ­£ç¡® - ç»Ÿä¸€ç”Ÿå‘½å‘¨æœŸ
public class UserService
{
    private readonly ILogger<UserService> _logger; // Scoped
    private readonly IOptions<AppSettings> _appSettings; // Scoped
    // ç»Ÿä¸€ä½¿ç”¨ Scoped ç”Ÿå‘½å‘¨æœŸ
}
```

### ä¸è¦å¾ªç¯ä¾èµ–

```csharp
// âŒ é”™è¯¯ - å¾ªç¯ä¾èµ–
public class UserService
{
    private readonly IRoleService _roleService;
    // UserService ä¾èµ– RoleService
}

public class RoleService
{
    private readonly IUserService _userService;
    // RoleService ä¾èµ– UserService - å¾ªç¯ä¾èµ–ï¼
}

// âœ… æ­£ç¡® - ä½¿ç”¨æ¥å£æˆ–äº‹ä»¶è§£è€¦
public class UserService
{
    private readonly IEventBus _eventBus;
    
    public async Task CreateUserAsync(User user)
    {
        // åˆ›å»ºç”¨æˆ·åå‘å¸ƒäº‹ä»¶
        await _eventBus.PublishAsync(new UserCreatedEvent(user));
    }
}

public class RoleService
{
    private readonly IEventBus _eventBus;
    
    public RoleService(IEventBus eventBus)
    {
        _eventBus = eventBus;
        _eventBus.Subscribe<UserCreatedEvent>(OnUserCreated);
    }
    
    private async Task OnUserCreated(UserCreatedEvent @event)
    {
        // å¤„ç†ç”¨æˆ·åˆ›å»ºäº‹ä»¶
    }
}
```

## ğŸ“‹ ä¾èµ–æ³¨å…¥æ£€æŸ¥æ¸…å•

åˆ›å»ºæˆ–ä¿®æ”¹æœåŠ¡æ—¶æ£€æŸ¥ï¼š

- [ ] é€‰æ‹©æ­£ç¡®çš„ç”Ÿå‘½å‘¨æœŸ
- [ ] é¿å…å¾ªç¯ä¾èµ–
- [ ] ä½¿ç”¨æ„é€ å‡½æ•°æ³¨å…¥
- [ ] æ³¨å†Œæ‰€æœ‰ä¾èµ–æœåŠ¡
- [ ] éªŒè¯é…ç½®å®Œæ•´æ€§
- [ ] æ·»åŠ é…ç½®éªŒè¯
- [ ] è€ƒè™‘æ€§èƒ½å½±å“
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•
- [ ] æ–‡æ¡£åŒ–ä¾èµ–å…³ç³»
- [ ] ä½¿ç”¨æ¥å£æŠ½è±¡

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æœåŠ¡æ³¨å†Œæ‰©å±•](mdc:Platform.ServiceDefaults/Extensions/ServiceExtensions.cs)
- [MongoDB é›†åˆæ³¨å†Œ](mdc:Platform.ApiService/Extensions/MongoDbExtensions.cs)
- [é…ç½®ç®¡ç†æœåŠ¡](mdc:Platform.ApiService/Configuration/)
- [ASP.NET Core ä¾èµ–æ³¨å…¥æ–‡æ¡£](https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection)
