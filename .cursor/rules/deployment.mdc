---
description: éƒ¨ç½²å’Œè¿ç»´è§„èŒƒ
---

# éƒ¨ç½²å’Œè¿ç»´è§„èŒƒ

## ğŸ¯ éƒ¨ç½²æ¶æ„

### æŠ€æœ¯æ ˆ

- **.NET Aspire** - åº”ç”¨ç¼–æ’å’Œéƒ¨ç½²
- **Docker** - å®¹å™¨åŒ–éƒ¨ç½²
- **MongoDB** - æ•°æ®åº“æœåŠ¡
- **YARP** - API ç½‘å…³
- **Nginx** - é™æ€èµ„æºæœåŠ¡

## ğŸ—ï¸ å¼€å‘ç¯å¢ƒéƒ¨ç½²

### å¯åŠ¨é¡ºåº

```bash
# 1. ç¡®ä¿ Docker å·²å¯åŠ¨
docker --version

# 2. é€šè¿‡ AppHost å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆæ¨èï¼‰
dotnet run --project Platform.AppHost

# 3. è®¿é—® Aspire Dashboard æŸ¥çœ‹æœåŠ¡çŠ¶æ€
open http://localhost:15003
```

### æœåŠ¡ç«¯å£åˆ†é…

| æœåŠ¡ | ç«¯å£ | ç”¨é€” |
|------|------|------|
| Aspire Dashboard | 15003 | æœåŠ¡ç›‘æ§é¢æ¿ |
| API ç½‘å…³ (YARP) | 15000 | ç»Ÿä¸€ API å…¥å£ |
| ç®¡ç†åå° | 15001 | Web ç®¡ç†ç•Œé¢ |
| ç§»åŠ¨åº”ç”¨ | 15002 | ç§»åŠ¨ç«¯å¼€å‘æœåŠ¡å™¨ |
| MongoDB | 27017 | æ•°æ®åº“æœåŠ¡ |
| MongoDB Express | 8081 | æ•°æ®åº“ç®¡ç†ç•Œé¢ |

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# .env.development
NODE_ENV=development
API_BASE_URL=http://localhost:15000

# .NET ç¯å¢ƒ
ASPNETCORE_ENVIRONMENT=Development
ASPNETCORE_URLS=http://localhost:5000
```

## ğŸ³ Docker å®¹å™¨åŒ–

### Dockerfile - API æœåŠ¡

```dockerfile
# âœ… æ¨èï¼šPlatform.ApiService/Dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS base
WORKDIR /app
EXPOSE 8080

FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /src
COPY ["Platform.ApiService/Platform.ApiService.csproj", "Platform.ApiService/"]
COPY ["Platform.ServiceDefaults/Platform.ServiceDefaults.csproj", "Platform.ServiceDefaults/"]
RUN dotnet restore "Platform.ApiService/Platform.ApiService.csproj"
COPY . .
WORKDIR "/src/Platform.ApiService"
RUN dotnet build "Platform.ApiService.csproj" -c Release -o /app/build

FROM build AS publish
RUN dotnet publish "Platform.ApiService.csproj" -c Release -o /app/publish

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
ENTRYPOINT ["dotnet", "Platform.ApiService.dll"]
```

### Dockerfile - ç®¡ç†åå°

```dockerfile
# âœ… æ¨èï¼šPlatform.Admin/Dockerfile
FROM node:20-alpine AS base
WORKDIR /app

# å®‰è£…ä¾èµ–
FROM base AS deps
COPY package.json package-lock.json ./
RUN npm ci

# æ„å»ºåº”ç”¨
FROM base AS builder
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN npm run build

# ç”Ÿäº§é•œåƒ
FROM nginx:alpine AS runner
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

### Docker Compose

```yaml
# âœ… æ¨èï¼šdocker-compose.yml
version: '3.8'

services:
  mongodb:
    image: mongo:latest
    container_name: platform-mongodb
    restart: always
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123

  mongo-express:
    image: mongo-express:latest
    container_name: platform-mongo-express
    restart: always
    ports:
      - "8081:8081"
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: admin
      ME_CONFIG_MONGODB_ADMINPASSWORD: admin123
      ME_CONFIG_MONGODB_URL: mongodb://admin:admin123@mongodb:27017/
    depends_on:
      - mongodb

  api-service:
    build:
      context: .
      dockerfile: Platform.ApiService/Dockerfile
    container_name: platform-api
    restart: always
    ports:
      - "5000:8080"
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ConnectionStrings__mongodb: mongodb://admin:admin123@mongodb:27017/platform?authSource=admin
      JwtSettings__SecretKey: ${JWT_SECRET_KEY}
      JwtSettings__RefreshTokenSecret: ${JWT_REFRESH_SECRET_KEY}
    depends_on:
      - mongodb

  admin:
    build:
      context: ./Platform.Admin
      dockerfile: Dockerfile
    container_name: platform-admin
    restart: always
    ports:
      - "80:80"
    depends_on:
      - api-service

volumes:
  mongodb_data:
```

## ğŸš€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### å‡†å¤‡å·¥ä½œ

```bash
# 1. è®¾ç½®ç¯å¢ƒå˜é‡
export JWT_SECRET_KEY="your-production-secret-key-min-32-chars"
export JWT_REFRESH_SECRET_KEY="your-refresh-secret-key-min-32-chars"
export MONGO_ROOT_PASSWORD="your-mongo-password"

# 2. æ„å»º Docker é•œåƒ
docker-compose build

# 3. å¯åŠ¨æœåŠ¡
docker-compose up -d

# 4. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# 5. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
```

### Nginx é…ç½®

```nginx
# âœ… æ¨èï¼šnginx.conf
server {
    listen 80;
    server_name your-domain.com;

    # é‡å®šå‘åˆ° HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL è¯ä¹¦é…ç½®
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # å‰ç«¯é™æ€èµ„æº
    location / {
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
        
        # ç¼“å­˜é…ç½®
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # API ä»£ç†
    location /api/ {
        proxy_pass http://api-service:8080/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # å¥åº·æ£€æŸ¥ç«¯ç‚¹
    location /health {
        proxy_pass http://api-service:8080/health;
        access_log off;
    }
}
```

### ç¯å¢ƒé…ç½®æ–‡ä»¶

```json
// âœ… æ¨èï¼šappsettings.Production.json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "ConnectionStrings": {
    "mongodb": "mongodb://username:password@mongodb:27017/platform?authSource=admin"
  },
  "JwtSettings": {
    "SecretKey": "${JWT_SECRET_KEY}",
    "RefreshTokenSecret": "${JWT_REFRESH_SECRET_KEY}",
    "Issuer": "Platform.ApiService",
    "Audience": "Platform.Users",
    "ExpirationMinutes": 60,
    "RefreshTokenExpirationDays": 7
  },
  "AllowedHosts": "*",
  "Cors": {
    "AllowedOrigins": ["https://your-domain.com"]
  }
}
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—é…ç½®

```csharp
// âœ… æ¨èï¼šProgram.cs æ—¥å¿—é…ç½®
builder.Services.AddLogging(logging =>
{
    logging.ClearProviders();
    logging.AddConsole();
    logging.AddDebug();
    
    if (builder.Environment.IsProduction())
    {
        // ç”Ÿäº§ç¯å¢ƒå¯ä»¥æ·»åŠ å…¶ä»–æ—¥å¿—æä¾›ç¨‹åº
        // logging.AddApplicationInsights();
    }
});
```

### å¥åº·æ£€æŸ¥

```csharp
// âœ… æ¨èï¼šå¥åº·æ£€æŸ¥é…ç½®
builder.Services.AddHealthChecks()
    .AddMongoDb(
        builder.Configuration.GetConnectionString("mongodb")!,
        name: "mongodb",
        timeout: TimeSpan.FromSeconds(3))
    .AddCheck("self", () => HealthCheckResult.Healthy());

app.MapHealthChecks("/health", new HealthCheckOptions
{
    ResponseWriter = UIResponseWriter.WriteHealthCheckUIResponse
});
```

### Aspire ç›‘æ§

```bash
# è®¿é—® Aspire Dashboard
# Development: http://localhost:15003
# Production: é…ç½®å¤–éƒ¨è®¿é—®

# ç›‘æ§æŒ‡æ ‡ï¼š
# - æœåŠ¡çŠ¶æ€
# - è¯·æ±‚è¿½è¸ª
# - æ—¥å¿—èšåˆ
# - æ€§èƒ½æŒ‡æ ‡
```

## ğŸ”’ å®‰å…¨é…ç½®

### HTTPS é…ç½®

```csharp
// âœ… æ¨èï¼šHTTPS é‡å®šå‘
if (!app.Environment.IsDevelopment())
{
    app.UseHttpsRedirection();
    app.UseHsts();
}
```

### CORS é…ç½®

```csharp
// âœ… æ¨èï¼šç”Ÿäº§ç¯å¢ƒ CORS
builder.Services.AddCors(options =>
{
    options.AddDefaultPolicy(policy =>
    {
        if (builder.Environment.IsDevelopment())
        {
            policy.AllowAnyOrigin()
                  .AllowAnyMethod()
                  .AllowAnyHeader();
        }
        else
        {
            policy.WithOrigins(builder.Configuration.GetSection("Cors:AllowedOrigins").Get<string[]>()!)
                  .AllowAnyMethod()
                  .AllowAnyHeader()
                  .AllowCredentials();
        }
    });
});
```

### å¯†é’¥ç®¡ç†

```bash
# âœ… æ¨èï¼šä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†å¯†é’¥
# ä¸è¦å°†å¯†é’¥æäº¤åˆ°ä»£ç ä»“åº“

# .env.production (ä¸æäº¤åˆ° Git)
JWT_SECRET_KEY=your-secret-key-min-32-chars
JWT_REFRESH_SECRET_KEY=your-refresh-secret-key-min-32-chars
MONGO_ROOT_PASSWORD=your-mongo-password

# ä½¿ç”¨ Docker Secrets (æ¨è)
docker secret create jwt_secret_key jwt_secret.txt
docker secret create jwt_refresh_secret refresh_secret.txt
```

## ğŸ”„ CI/CD æµç¨‹

### GitHub Actions ç¤ºä¾‹

```yaml
# âœ… æ¨èï¼š.github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Build API
        run: |
          dotnet restore
          dotnet build --configuration Release
          dotnet publish Platform.ApiService/Platform.ApiService.csproj -c Release -o ./publish

      - name: Build Admin
        run: |
          cd Platform.Admin
          npm ci
          npm run build

      - name: Build Docker images
        run: |
          docker-compose build

      - name: Push to Registry
        run: |
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker-compose push

      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /app
            docker-compose pull
            docker-compose up -d
            docker-compose ps
```

## ğŸ“¦ å¤‡ä»½å’Œæ¢å¤

### æ•°æ®åº“å¤‡ä»½

```bash
# âœ… æ¨èï¼šMongoDB å¤‡ä»½è„šæœ¬
#!/bin/bash

# è®¾ç½®å˜é‡
BACKUP_DIR="/backup/mongodb"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="platform_backup_$TIMESTAMP"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# æ‰§è¡Œå¤‡ä»½
docker exec platform-mongodb mongodump \
  --uri="mongodb://admin:admin123@localhost:27017/platform?authSource=admin" \
  --out="/backup/$BACKUP_NAME"

# å‹ç¼©å¤‡ä»½
docker exec platform-mongodb tar -czf "/backup/$BACKUP_NAME.tar.gz" "/backup/$BACKUP_NAME"

# åˆ é™¤æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘7å¤©ï¼‰
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

echo "Backup completed: $BACKUP_NAME.tar.gz"
```

### æ•°æ®åº“æ¢å¤

```bash
# âœ… æ¨èï¼šMongoDB æ¢å¤è„šæœ¬
#!/bin/bash

# è§£å‹å¤‡ä»½
tar -xzf platform_backup_20240101_120000.tar.gz

# æ¢å¤æ•°æ®
docker exec -i platform-mongodb mongorestore \
  --uri="mongodb://admin:admin123@localhost:27017/platform?authSource=admin" \
  --drop \
  /backup/platform_backup_20240101_120000

echo "Restore completed"
```

## ğŸš« é¿å…çš„åšæ³•

- ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å¯†é’¥å’Œå¯†ç 
- ä¸è¦å¿½ç•¥å®‰å…¨æ›´æ–°å’Œè¡¥ä¸
- ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å¼€å‘é…ç½®
- ä¸è¦å¿˜è®°å®šæœŸå¤‡ä»½æ•°æ®
- ä¸è¦å¿½ç•¥ç›‘æ§å’Œæ—¥å¿—
- ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒæš´éœ²è°ƒè¯•ç«¯ç‚¹

## ğŸ”§ æœ€ä½³å®è·µ

1. **å®¹å™¨åŒ–éƒ¨ç½²** - ä½¿ç”¨ Docker ç¡®ä¿ç¯å¢ƒä¸€è‡´æ€§
2. **å¯†é’¥ç®¡ç†** - ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†æœåŠ¡
3. **å¥åº·æ£€æŸ¥** - é…ç½®æœåŠ¡å¥åº·æ£€æŸ¥ç«¯ç‚¹
4. **æ—¥å¿—ç›‘æ§** - é›†ä¸­ç®¡ç†å’Œç›‘æ§æ—¥å¿—
5. **è‡ªåŠ¨åŒ–éƒ¨ç½²** - ä½¿ç”¨ CI/CD è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹
6. **å®šæœŸå¤‡ä»½** - å®šæœŸå¤‡ä»½æ•°æ®åº“å’Œé…ç½®
7. **è´Ÿè½½å‡è¡¡** - ä½¿ç”¨è´Ÿè½½å‡è¡¡æé«˜å¯ç”¨æ€§
8. **ç°åº¦å‘å¸ƒ** - ä½¿ç”¨ç°åº¦å‘å¸ƒé™ä½é£é™©

## ğŸ“š ç›¸å…³èµ„æº

- [.NET Aspire éƒ¨ç½²æ–‡æ¡£](https://learn.microsoft.com/aspnet/core/aspire/deployment/)
- [Docker å®˜æ–¹æ–‡æ¡£](https://docs.docker.com/)
- [MongoDB å¤‡ä»½æ¢å¤](https://www.mongodb.com/docs/manual/core/backups/)

