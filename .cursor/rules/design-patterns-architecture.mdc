---
description: è®¾è®¡æ¨¡å¼å’Œæ¶æ„åŸåˆ™è§„èŒƒ
globs: *.cs,*.ts,*.tsx,*.js,*.jsx
---

# è®¾è®¡æ¨¡å¼å’Œæ¶æ„åŸåˆ™è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**éµå¾ª SOLID åŸåˆ™å’Œå¸¸è§è®¾è®¡æ¨¡å¼ï¼Œæ„å»ºå¯ç»´æŠ¤ã€å¯æ‰©å±•çš„ä»£ç æ¶æ„**

## ğŸ—ï¸ SOLID åŸåˆ™åº”ç”¨

### å•ä¸€èŒè´£åŸåˆ™ (SRP)
```csharp
// âœ… æ­£ç¡®ï¼šå•ä¸€èŒè´£
public class UserService
{
    private readonly IUserRepository _userRepository;
    private readonly IEmailService _emailService;
    private readonly IPasswordService _passwordService;

    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // åªè´Ÿè´£ç”¨æˆ·åˆ›å»ºçš„ä¸šåŠ¡é€»è¾‘
        var user = new User
        {
            Username = request.Username,
            Email = request.Email,
            CompanyId = request.CompanyId
        };

        user.PasswordHash = _passwordService.HashPassword(request.Password);
        await _userRepository.CreateAsync(user);
        
        await _emailService.SendWelcomeEmailAsync(user.Email);
        
        return user;
    }
}

// âŒ é”™è¯¯ï¼šè¿åå•ä¸€èŒè´£
public class UserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // æ··åˆäº†ç”¨æˆ·åˆ›å»ºã€é‚®ä»¶å‘é€ã€æ—¥å¿—è®°å½•ç­‰å¤šç§èŒè´£
        var user = new User { /* ... */ };
        
        // å¯†ç å“ˆå¸Œ
        user.PasswordHash = BCrypt.HashPassword(request.Password);
        
        // æ•°æ®åº“æ“ä½œ
        await _database.Users.InsertOneAsync(user);
        
        // é‚®ä»¶å‘é€
        await SendEmail(user.Email, "Welcome!");
        
        // æ—¥å¿—è®°å½•
        _logger.LogInformation("User created: {UserId}", user.Id);
        
        return user;
    }
}
```

### å¼€é—­åŸåˆ™ (OCP)
```csharp
// âœ… æ­£ç¡®ï¼šå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
public abstract class NotificationService
{
    public abstract Task SendAsync(string message, string recipient);
}

public class EmailNotificationService : NotificationService
{
    public override async Task SendAsync(string message, string recipient)
    {
        // é‚®ä»¶å‘é€å®ç°
    }
}

public class SmsNotificationService : NotificationService
{
    public override async Task SendAsync(string message, string recipient)
    {
        // çŸ­ä¿¡å‘é€å®ç°
    }
}

public class NotificationManager
{
    private readonly List<NotificationService> _services;

    public NotificationManager(IEnumerable<NotificationService> services)
    {
        _services = services.ToList();
    }

    public async Task NotifyAllAsync(string message, string recipient)
    {
        var tasks = _services.Select(service => service.SendAsync(message, recipient));
        await Task.WhenAll(tasks);
    }
}
```

### é‡Œæ°æ›¿æ¢åŸåˆ™ (LSP)
```csharp
// âœ… æ­£ç¡®ï¼šå­ç±»å¯ä»¥æ›¿æ¢çˆ¶ç±»
public abstract class Repository<T>
{
    public abstract Task<T> GetByIdAsync(string id);
    public abstract Task<List<T>> GetAllAsync();
    public abstract Task CreateAsync(T entity);
}

public class UserRepository : Repository<User>
{
    public override async Task<User> GetByIdAsync(string id)
    {
        // ç”¨æˆ·ç‰¹å®šçš„æŸ¥è¯¢é€»è¾‘
        return await _users.Find(u => u.Id == id).FirstOrDefaultAsync();
    }

    public override async Task<List<User>> GetAllAsync()
    {
        return await _users.Find(_ => true).ToListAsync();
    }

    public override async Task CreateAsync(User user)
    {
        await _users.InsertOneAsync(user);
    }
}

// å®¢æˆ·ç«¯ä»£ç å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨åŸºç±»
public class UserService
{
    private readonly Repository<User> _userRepository;

    public UserService(Repository<User> userRepository)
    {
        _userRepository = userRepository; // å¯ä»¥æ¥å—ä»»ä½• Repository<User> å®ç°
    }
}
```

### æ¥å£éš”ç¦»åŸåˆ™ (ISP)
```csharp
// âœ… æ­£ç¡®ï¼šæ¥å£éš”ç¦»
public interface IUserReader
{
    Task<User> GetByIdAsync(string id);
    Task<List<User>> GetAllAsync();
}

public interface IUserWriter
{
    Task CreateAsync(User user);
    Task UpdateAsync(User user);
    Task DeleteAsync(string id);
}

public interface IUserRepository : IUserReader, IUserWriter
{
    // ç»„åˆå¤šä¸ªå°æ¥å£
}

// âŒ é”™è¯¯ï¼šæ¥å£è¿‡äºåºå¤§
public interface IUserService
{
    // è¯»å–æ“ä½œ
    Task<User> GetByIdAsync(string id);
    Task<List<User>> GetAllAsync();
    
    // å†™å…¥æ“ä½œ
    Task CreateAsync(User user);
    Task UpdateAsync(User user);
    Task DeleteAsync(string id);
    
    // é‚®ä»¶æ“ä½œ
    Task SendEmailAsync(string email, string subject, string body);
    
    // æ—¥å¿—æ“ä½œ
    Task LogActivityAsync(string userId, string activity);
    
    // æƒé™æ“ä½œ
    Task<bool> HasPermissionAsync(string userId, string permission);
}
```

### ä¾èµ–å€’ç½®åŸåˆ™ (DIP)
```csharp
// âœ… æ­£ç¡®ï¼šä¾èµ–æŠ½è±¡è€Œä¸æ˜¯å…·ä½“å®ç°
public interface IUserRepository
{
    Task<User> GetByIdAsync(string id);
    Task CreateAsync(User user);
}

public class UserService
{
    private readonly IUserRepository _userRepository;
    private readonly ILogger<UserService> _logger;

    public UserService(IUserRepository userRepository, ILogger<UserService> logger)
    {
        _userRepository = userRepository;
        _logger = logger;
    }

    public async Task<User> GetUserAsync(string id)
    {
        _logger.LogInformation("Getting user {UserId}", id);
        return await _userRepository.GetByIdAsync(id);
    }
}

// ä¾èµ–æ³¨å…¥é…ç½®
public static class ServiceConfiguration
{
    public static void ConfigureServices(IServiceCollection services)
    {
        services.AddScoped<IUserRepository, UserRepository>();
        services.AddScoped<UserService>();
    }
}
```

## ğŸ¨ å¸¸è§è®¾è®¡æ¨¡å¼

### å·¥å‚æ¨¡å¼
```csharp
// âœ… æ­£ç¡®ï¼šå·¥å‚æ¨¡å¼
public interface INotificationServiceFactory
{
    INotificationService Create(NotificationType type);
}

public class NotificationServiceFactory : INotificationServiceFactory
{
    private readonly IServiceProvider _serviceProvider;

    public NotificationServiceFactory(IServiceProvider serviceProvider)
    {
        _serviceProvider = serviceProvider;
    }

    public INotificationService Create(NotificationType type)
    {
        return type switch
        {
            NotificationType.Email => _serviceProvider.GetRequiredService<EmailNotificationService>(),
            NotificationType.Sms => _serviceProvider.GetRequiredService<SmsNotificationService>(),
            NotificationType.Push => _serviceProvider.GetRequiredService<PushNotificationService>(),
            _ => throw new ArgumentException($"Unsupported notification type: {type}")
        };
    }
}

// ä½¿ç”¨å·¥å‚
public class NotificationManager
{
    private readonly INotificationServiceFactory _factory;

    public async Task SendNotificationAsync(NotificationType type, string message, string recipient)
    {
        var service = _factory.Create(type);
        await service.SendAsync(message, recipient);
    }
}
```

### ç­–ç•¥æ¨¡å¼
```csharp
// âœ… æ­£ç¡®ï¼šç­–ç•¥æ¨¡å¼
public interface IPricingStrategy
{
    decimal CalculatePrice(decimal basePrice, int quantity);
}

public class RegularPricingStrategy : IPricingStrategy
{
    public decimal CalculatePrice(decimal basePrice, int quantity)
    {
        return basePrice * quantity;
    }
}

public class BulkPricingStrategy : IPricingStrategy
{
    public decimal CalculatePrice(decimal basePrice, int quantity)
    {
        if (quantity >= 10)
            return basePrice * quantity * 0.9m; // 10% æŠ˜æ‰£
        return basePrice * quantity;
    }
}

public class PricingContext
{
    private IPricingStrategy _strategy;

    public void SetStrategy(IPricingStrategy strategy)
    {
        _strategy = strategy;
    }

    public decimal CalculatePrice(decimal basePrice, int quantity)
    {
        return _strategy.CalculatePrice(basePrice, quantity);
    }
}
```

### è§‚å¯Ÿè€…æ¨¡å¼
```csharp
// âœ… æ­£ç¡®ï¼šè§‚å¯Ÿè€…æ¨¡å¼
public interface IUserEventObserver
{
    Task OnUserCreatedAsync(User user);
    Task OnUserUpdatedAsync(User user);
    Task OnUserDeletedAsync(string userId);
}

public class UserEventPublisher
{
    private readonly List<IUserEventObserver> _observers = new();

    public void Subscribe(IUserEventObserver observer)
    {
        _observers.Add(observer);
    }

    public void Unsubscribe(IUserEventObserver observer)
    {
        _observers.Remove(observer);
    }

    public async Task NotifyUserCreatedAsync(User user)
    {
        var tasks = _observers.Select(observer => observer.OnUserCreatedAsync(user));
        await Task.WhenAll(tasks);
    }

    public async Task NotifyUserUpdatedAsync(User user)
    {
        var tasks = _observers.Select(observer => observer.OnUserUpdatedAsync(user));
        await Task.WhenAll(tasks);
    }
}

// å…·ä½“è§‚å¯Ÿè€…
public class EmailNotificationObserver : IUserEventObserver
{
    public async Task OnUserCreatedAsync(User user)
    {
        await SendWelcomeEmailAsync(user.Email);
    }

    public async Task OnUserUpdatedAsync(User user)
    {
        // ç”¨æˆ·æ›´æ–°æ—¶çš„é‚®ä»¶é€šçŸ¥
    }

    public async Task OnUserDeletedAsync(string userId)
    {
        // ç”¨æˆ·åˆ é™¤æ—¶çš„é‚®ä»¶é€šçŸ¥
    }
}
```

### è£…é¥°å™¨æ¨¡å¼
```csharp
// âœ… æ­£ç¡®ï¼šè£…é¥°å™¨æ¨¡å¼
public interface IUserService
{
    Task<User> GetUserAsync(string id);
    Task CreateUserAsync(User user);
}

public class UserService : IUserService
{
    public async Task<User> GetUserAsync(string id)
    {
        // åŸºç¡€ç”¨æˆ·æœåŠ¡å®ç°
        return await _userRepository.GetByIdAsync(id);
    }

    public async Task CreateUserAsync(User user)
    {
        await _userRepository.CreateAsync(user);
    }
}

public class LoggingUserServiceDecorator : IUserService
{
    private readonly IUserService _userService;
    private readonly ILogger<LoggingUserServiceDecorator> _logger;

    public LoggingUserServiceDecorator(IUserService userService, ILogger<LoggingUserServiceDecorator> logger)
    {
        _userService = userService;
        _logger = logger;
    }

    public async Task<User> GetUserAsync(string id)
    {
        _logger.LogInformation("Getting user {UserId}", id);
        try
        {
            var user = await _userService.GetUserAsync(id);
            _logger.LogInformation("Successfully retrieved user {UserId}", id);
            return user;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to get user {UserId}", id);
            throw;
        }
    }

    public async Task CreateUserAsync(User user)
    {
        _logger.LogInformation("Creating user {Username}", user.Username);
        await _userService.CreateUserAsync(user);
        _logger.LogInformation("Successfully created user {Username}", user.Username);
    }
}
```

## ğŸ›ï¸ æ¶æ„æ¨¡å¼

### åˆ†å±‚æ¶æ„
```csharp
// âœ… æ­£ç¡®ï¼šåˆ†å±‚æ¶æ„
// 1. è¡¨ç¤ºå±‚ (Controllers)
[ApiController]
[Route("api/[controller]")]
public class UserController : BaseApiController
{
    private readonly IUserService _userService;

    [HttpGet("{id}")]
    public async Task<IActionResult> GetUser(string id)
    {
        var user = await _userService.GetUserAsync(id);
        return Success(user);
    }
}

// 2. ä¸šåŠ¡é€»è¾‘å±‚ (Services)
public class UserService : IUserService
{
    private readonly IUserRepository _userRepository;
    private readonly IEmailService _emailService;

    public async Task<User> GetUserAsync(string id)
    {
        var user = await _userRepository.GetByIdAsync(id);
        if (user == null)
            throw new KeyNotFoundException($"User {id} not found");
        
        return user;
    }
}

// 3. æ•°æ®è®¿é—®å±‚ (Repositories)
public class UserRepository : IUserRepository
{
    private readonly IMongoCollection<User> _users;

    public async Task<User> GetByIdAsync(string id)
    {
        return await _users.Find(u => u.Id == id).FirstOrDefaultAsync();
    }
}
```

### CQRS æ¨¡å¼
```csharp
// âœ… æ­£ç¡®ï¼šCQRS åˆ†ç¦»
// å‘½ä»¤ (Command)
public class CreateUserCommand
{
    public string Username { get; set; } = string.Empty;
    public string Email { get; set; } = string.Empty;
    public string Password { get; set; } = string.Empty;
    public string CompanyId { get; set; } = string.Empty;
}

public class CreateUserCommandHandler
{
    private readonly IUserRepository _userRepository;
    private readonly IPasswordService _passwordService;

    public async Task<string> HandleAsync(CreateUserCommand command)
    {
        var user = new User
        {
            Username = command.Username,
            Email = command.Email,
            CompanyId = command.CompanyId,
            PasswordHash = _passwordService.HashPassword(command.Password)
        };

        await _userRepository.CreateAsync(user);
        return user.Id;
    }
}

// æŸ¥è¯¢ (Query)
public class GetUserQuery
{
    public string Id { get; set; } = string.Empty;
}

public class GetUserQueryHandler
{
    private readonly IUserReadRepository _userReadRepository;

    public async Task<UserDto> HandleAsync(GetUserQuery query)
    {
        var user = await _userReadRepository.GetByIdAsync(query.Id);
        return new UserDto
        {
            Id = user.Id,
            Username = user.Username,
            Email = user.Email
        };
    }
}
```

### é¢†åŸŸé©±åŠ¨è®¾è®¡ (DDD)
```csharp
// âœ… æ­£ç¡®ï¼šé¢†åŸŸæ¨¡å‹
public class User : AggregateRoot
{
    public string Username { get; private set; }
    public string Email { get; private set; }
    public string CompanyId { get; private set; }
    public UserStatus Status { get; private set; }

    private User() { } // EF Core éœ€è¦

    public User(string username, string email, string companyId)
    {
        Username = username;
        Email = email;
        CompanyId = companyId;
        Status = UserStatus.Active;
        
        AddDomainEvent(new UserCreatedEvent(Id, Username, Email));
    }

    public void UpdateEmail(string newEmail)
    {
        if (string.IsNullOrEmpty(newEmail))
            throw new ArgumentException("Email cannot be empty");

        Email = newEmail;
        AddDomainEvent(new UserEmailUpdatedEvent(Id, newEmail));
    }

    public void Deactivate()
    {
        if (Status == UserStatus.Inactive)
            throw new InvalidOperationException("User is already inactive");

        Status = UserStatus.Inactive;
        AddDomainEvent(new UserDeactivatedEvent(Id));
    }
}

// é¢†åŸŸäº‹ä»¶
public abstract class DomainEvent
{
    public DateTime OccurredOn { get; } = DateTime.UtcNow;
}

public class UserCreatedEvent : DomainEvent
{
    public string UserId { get; }
    public string Username { get; }
    public string Email { get; }

    public UserCreatedEvent(string userId, string username, string email)
    {
        UserId = userId;
        Username = username;
        Email = email;
    }
}
```

## ğŸ”§ å‰ç«¯è®¾è®¡æ¨¡å¼

### ç»„ä»¶ç»„åˆæ¨¡å¼
```tsx
// âœ… æ­£ç¡®ï¼šç»„ä»¶ç»„åˆ
interface CardProps {
  children: React.ReactNode;
  className?: string;
}

export function Card({ children, className }: CardProps) {
  return (
    <div className={`card ${className || ''}`}>
      {children}
    </div>
  );
}

export function CardHeader({ children }: { children: React.ReactNode }) {
  return <div className="card-header">{children}</div>;
}

export function CardBody({ children }: { children: React.ReactNode }) {
  return <div className="card-body">{children}</div>;
}

export function CardFooter({ children }: { children: React.ReactNode }) {
  return <div className="card-footer">{children}</div>;
}

// ä½¿ç”¨ç»„åˆ
export function UserCard({ user }: { user: User }) {
  return (
    <Card>
      <CardHeader>
        <h3>{user.username}</h3>
      </CardHeader>
      <CardBody>
        <p>{user.email}</p>
        <p>{user.role}</p>
      </CardBody>
      <CardFooter>
        <Button>ç¼–è¾‘</Button>
        <Button variant="danger">åˆ é™¤</Button>
      </CardFooter>
    </Card>
  );
}
```

### æ¸²æŸ“å±æ€§æ¨¡å¼
```tsx
// âœ… æ­£ç¡®ï¼šæ¸²æŸ“å±æ€§æ¨¡å¼
interface DataFetcherProps<T> {
  url: string;
  children: (data: T | null, loading: boolean, error: string | null) => React.ReactNode;
}

export function DataFetcher<T>({ url, children }: DataFetcherProps<T>) {
  const [data, setData] = useState<T | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchData = async () => {
      try {
        setLoading(true);
        const response = await fetch(url);
        const result = await response.json();
        setData(result);
      } catch (err) {
        setError(err instanceof Error ? err.message : 'Unknown error');
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [url]);

  return <>{children(data, loading, error)}</>;
}

// ä½¿ç”¨æ¸²æŸ“å±æ€§
export function UserList() {
  return (
    <DataFetcher<User[]> url="/api/users">
      {(users, loading, error) => {
        if (loading) return <LoadingSpinner />;
        if (error) return <ErrorMessage message={error} />;
        if (!users) return <EmptyState />;

        return (
          <div>
            {users.map(user => (
              <UserCard key={user.id} user={user} />
            ))}
          </div>
        );
      }}
    </DataFetcher>
  );
}
```

### é«˜é˜¶ç»„ä»¶æ¨¡å¼
```tsx
// âœ… æ­£ç¡®ï¼šé«˜é˜¶ç»„ä»¶
interface WithLoadingProps {
  loading: boolean;
}

export function withLoading<P extends object>(
  Component: React.ComponentType<P>
) {
  return function WithLoadingComponent(props: P & WithLoadingProps) {
    const { loading, ...restProps } = props;

    if (loading) {
      return <LoadingSpinner />;
    }

    return <Component {...(restProps as P)} />;
  };
}

// ä½¿ç”¨é«˜é˜¶ç»„ä»¶
const UserListWithLoading = withLoading(UserList);

export function UserManagementPage() {
  const [users, setUsers] = useState<User[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchUsers().then(data => {
      setUsers(data);
      setLoading(false);
    });
  }, []);

  return <UserListWithLoading users={users} loading={loading} />;
}
```

## ğŸ“‹ è®¾è®¡æ¨¡å¼é€‰æ‹©æŒ‡å—

### ä½•æ—¶ä½¿ç”¨å·¥å‚æ¨¡å¼
- éœ€è¦æ ¹æ®è¿è¡Œæ—¶æ¡ä»¶åˆ›å»ºä¸åŒç±»å‹çš„å¯¹è±¡
- åˆ›å»ºè¿‡ç¨‹å¤æ‚ï¼Œéœ€è¦å°è£…
- éœ€è¦ç»Ÿä¸€çš„å¯¹è±¡åˆ›å»ºæ¥å£

### ä½•æ—¶ä½¿ç”¨ç­–ç•¥æ¨¡å¼
- æœ‰å¤šç§ç®—æ³•æˆ–è¡Œä¸ºéœ€è¦åŠ¨æ€é€‰æ‹©
- ç®—æ³•å¯èƒ½åœ¨è¿è¡Œæ—¶æ”¹å˜
- éœ€è¦é¿å…ä½¿ç”¨å¤§é‡çš„ if-else è¯­å¥

### ä½•æ—¶ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼
- ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å˜åŒ–éœ€è¦é€šçŸ¥å¤šä¸ªå…¶ä»–å¯¹è±¡
- å¯¹è±¡ä¹‹é—´éœ€è¦æ¾è€¦åˆ
- éœ€è¦å®ç°äº‹ä»¶é©±åŠ¨æ¶æ„

### ä½•æ—¶ä½¿ç”¨è£…é¥°å™¨æ¨¡å¼
- éœ€è¦åœ¨ä¸ä¿®æ”¹åŸæœ‰ç±»çš„æƒ…å†µä¸‹æ·»åŠ åŠŸèƒ½
- åŠŸèƒ½å¯ä»¥åŠ¨æ€æ·»åŠ æˆ–ç§»é™¤
- éœ€è¦é¿å…ä½¿ç”¨ç»§æ‰¿æ¥æ‰©å±•åŠŸèƒ½

## ğŸ“š ç›¸å…³èµ„æº

- [è®¾è®¡æ¨¡å¼ï¼šå¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶çš„åŸºç¡€](https://en.wikipedia.org/wiki/Design_Patterns)
- [SOLID åŸåˆ™](https://en.wikipedia.org/wiki/SOLID)
- [é¢†åŸŸé©±åŠ¨è®¾è®¡](https://martinfowler.com/bliki/DomainDrivenDesign.html)
- [React è®¾è®¡æ¨¡å¼](https://reactpatterns.com/)

## ğŸ¯ è®°ä½

**è®¾è®¡æ¨¡å¼æ˜¯å·¥å…·ï¼Œä¸æ˜¯ç›®æ ‡**

- ä¼˜å…ˆè€ƒè™‘ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§
- ä¸è¦è¿‡åº¦è®¾è®¡ï¼Œä¿æŒç®€å•
- æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ¨¡å¼
- æŒç»­é‡æ„å’Œæ”¹è¿›ä»£ç ç»“æ„