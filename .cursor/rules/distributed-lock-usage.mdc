---
description: åˆ†å¸ƒå¼é”ä½¿ç”¨è§„èŒƒå’Œæœ€ä½³å®è·µ
---
# åˆ†å¸ƒå¼é”ä½¿ç”¨è§„èŒƒ

## ğŸ¯ ä½•æ—¶ä½¿ç”¨åˆ†å¸ƒå¼é”

åœ¨ä»¥ä¸‹åœºæ™¯ä¸­**å¿…é¡»**ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼š

1. **æ•°æ®åº“åˆå§‹åŒ–**ï¼šç¡®ä¿å¤šå®ä¾‹åªæœ‰ä¸€ä¸ªæ‰§è¡Œåˆå§‹åŒ–
2. **ç´¢å¼•åˆ›å»º**ï¼šé¿å…å¹¶å‘åˆ›å»ºç›¸åŒç´¢å¼•
3. **å®šæ—¶ä»»åŠ¡**ï¼šç¡®ä¿å®šæ—¶ä»»åŠ¡åªåœ¨ä¸€ä¸ªå®ä¾‹ä¸Šæ‰§è¡Œ
4. **èµ„æºåˆ†é…**ï¼šéœ€è¦å…¨å±€å”¯ä¸€æ€§çš„æ“ä½œ

## âœ… æ­£ç¡®çš„ä½¿ç”¨æ–¹å¼

### åŸºæœ¬ç”¨æ³•

```csharp
// âœ… ä½¿ç”¨ ExecuteWithLockAsync è‡ªåŠ¨ç®¡ç†é”
await _lockService.ExecuteWithLockAsync("lock-name", async () =>
{
    // å—ä¿æŠ¤çš„ä»£ç 
    // åªæœ‰è·å–åˆ°é”çš„å®ä¾‹ä¼šæ‰§è¡Œè¿™é‡Œ
    await DoSomethingAsync();
}, timeoutSeconds: 60);
```

### é”å‘½åè§„èŒƒ

```csharp
// âœ… ä½¿ç”¨æè¿°æ€§çš„é”åç§°
"database-initialization"    // æ•°æ®åº“åˆå§‹åŒ–
"index-creation"             // ç´¢å¼•åˆ›å»º
"daily-report-generation"    // æ¯æ—¥æŠ¥è¡¨ç”Ÿæˆ
"resource-allocation-{id}"   // èµ„æºåˆ†é…ï¼ˆå¸¦IDï¼‰

// âŒ é¿å…ä½¿ç”¨æ¨¡ç³Šçš„åç§°
"lock1"
"temp"
"process"
```

### è¶…æ—¶è®¾ç½®

```csharp
// âœ… æ ¹æ®æ“ä½œæ—¶é•¿è®¾ç½®åˆç†çš„è¶…æ—¶
await _lockService.ExecuteWithLockAsync("index-creation", async () =>
{
    await CreateIndexesAsync();
}, timeoutSeconds: 60);  // ç´¢å¼•åˆ›å»ºå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´

await _lockService.ExecuteWithLockAsync("simple-operation", async () =>
{
    await UpdateConfigAsync();
}, timeoutSeconds: 30);  // ç®€å•æ“ä½œä½¿ç”¨é»˜è®¤30ç§’
```

## âš ï¸ å…³é”®å®ç°ç»†èŠ‚

### å¿…é¡»ä½¿ç”¨ä¸¤é˜¶æ®µé”è·å–ç­–ç•¥

```csharp
// âœ… æ­£ç¡®çš„é”è·å–é€»è¾‘
// é˜¶æ®µ1: å°è¯•æ’å…¥æ–°é”ï¼ˆåŸå­æ“ä½œï¼‰
try
{
    var newLock = new DistributedLock
    {
        LockName = lockName,
        InstanceId = _instanceId,
        AcquiredAt = now,
        ExpiresAt = expiresAt,
        Status = "locked"
    };
    
    await _locks.InsertOneAsync(newLock);
    return true;  // è·å–é”æˆåŠŸ
}
catch (MongoWriteException ex) when (ex.WriteError?.Category == ServerErrorCategory.DuplicateKey)
{
    // é”å·²å­˜åœ¨ï¼Œå°è¯•è·å–è¿‡æœŸçš„é”
}

// é˜¶æ®µ2: å°è¯•è·å–å·²è¿‡æœŸçš„é”ï¼ˆåŸå­æ“ä½œï¼‰
var filter = Builders<DistributedLock>.Filter.And(
    Builders<DistributedLock>.Filter.Eq(l => l.LockName, lockName),
    Builders<DistributedLock>.Filter.Lt(l => l.ExpiresAt, DateTime.UtcNow)
);

var update = Builders<DistributedLock>.Update
    .Set(l => l.InstanceId, _instanceId)
    .Set(l => l.AcquiredAt, DateTime.UtcNow)
    .Set(l => l.ExpiresAt, DateTime.UtcNow.AddSeconds(timeout));

var result = await _locks.FindOneAndUpdateAsync(filter, update, options);
return result != null && result.InstanceId == _instanceId;
```

### å¿…é¡»åˆ›å»ºå”¯ä¸€ç´¢å¼•

```csharp
// âœ… ç¡®ä¿ LockName æœ‰å”¯ä¸€ç´¢å¼•
await _locks.Indexes.CreateOneAsync(
    new CreateIndexModel<DistributedLock>(
        Builders<DistributedLock>.IndexKeys.Ascending(l => l.LockName),
        new CreateIndexOptions { Unique = true, Name = "idx_lockName_unique" }
    )
);
```

### å¿…é¡»åˆ›å»º TTL ç´¢å¼•

```csharp
// âœ… è‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„é”
await _locks.Indexes.CreateOneAsync(
    new CreateIndexModel<DistributedLock>(
        Builders<DistributedLock>.IndexKeys.Ascending(l => l.ExpiresAt),
        new CreateIndexOptions 
        { 
            Name = "idx_expiresAt_ttl",
            ExpireAfter = TimeSpan.Zero  // åœ¨ expiresAt æ—¶é—´è¿‡æœŸ
        }
    )
);
```

## âŒ å¸¸è§é”™è¯¯

### é”™è¯¯ 1: ä½¿ç”¨é”™è¯¯çš„ Filter é€»è¾‘

```csharp
// âŒ é”™è¯¯ï¼šé€»è¾‘çŸ›ç›¾çš„ filter
var filter = Builders<DistributedLock>.Filter.Or(
    Builders<DistributedLock>.Filter.Eq(l => l.LockName, lockName) 
        & Builders<DistributedLock>.Filter.Exists(l => l.Id, false),  // âŒ è¿™ä¸ªæ¡ä»¶æ°¸è¿œä¸æ»¡è¶³
    Builders<DistributedLock>.Filter.Lt(l => l.ExpiresAt, now)
);
```

### é”™è¯¯ 2: ä¾èµ– Upsert è€Œä¸æ˜¯åŸå­æ’å…¥

```csharp
// âŒ é”™è¯¯ï¼šåœ¨é”™è¯¯çš„ filter ä¸‹ä½¿ç”¨ upsert
var options = new FindOneAndUpdateOptions<DistributedLock>
{
    IsUpsert = true,  // âŒ å¯èƒ½å¯¼è‡´å¹¶å‘é—®é¢˜
    ReturnDocument = ReturnDocument.After
};
```

### é”™è¯¯ 3: ä¸éªŒè¯è¿”å›çš„å®ä¾‹ID

```csharp
// âŒ é”™è¯¯ï¼šä¸éªŒè¯å®ä¾‹ID
var result = await _locks.FindOneAndUpdateAsync(filter, update);
return result != null;  // âŒ åº”è¯¥éªŒè¯ result.InstanceId == _instanceId

// âœ… æ­£ç¡®ï¼šéªŒè¯å®ä¾‹ID
var result = await _locks.FindOneAndUpdateAsync(filter, update);
return result != null && result.InstanceId == _instanceId;
```

### é”™è¯¯ 4: å¿˜è®°é‡Šæ”¾é”

```csharp
// âŒ é”™è¯¯ï¼šæ‰‹åŠ¨ç®¡ç†é”ä½†å¿˜è®°é‡Šæ”¾
var acquired = await AcquireLockAsync("lock-name");
if (acquired)
{
    await DoSomethingAsync();
    // âŒ å¿˜è®°é‡Šæ”¾é”
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ ExecuteWithLockAsync è‡ªåŠ¨ç®¡ç†
await _lockService.ExecuteWithLockAsync("lock-name", async () =>
{
    await DoSomethingAsync();
});  // è‡ªåŠ¨é‡Šæ”¾é”
```

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### é”ç²’åº¦

```csharp
// âœ… ç»†ç²’åº¦é”ï¼šé’ˆå¯¹ç‰¹å®šèµ„æº
await _lockService.ExecuteWithLockAsync($"user-update-{userId}", async () =>
{
    await UpdateUserAsync(userId);
});

// âš ï¸ ç²—ç²’åº¦é”ï¼šå½±å“æ‰€æœ‰ç”¨æˆ·æ“ä½œ
await _lockService.ExecuteWithLockAsync("user-operations", async () =>
{
    await UpdateUserAsync(userId);  // é˜»å¡å…¶ä»–ç”¨æˆ·æ“ä½œ
});
```

### è¶…æ—¶æ—¶é—´

```csharp
// âœ… æ ¹æ®æ“ä½œå¤æ‚åº¦è®¾ç½®è¶…æ—¶
çŸ­æ“ä½œï¼š10-30ç§’
ä¸­ç­‰æ“ä½œï¼š30-60ç§’
é•¿æ“ä½œï¼š60-120ç§’

// âŒ é¿å…è¿‡é•¿çš„è¶…æ—¶ï¼ˆå®¹æ˜“é€ æˆæ­»é”ï¼‰
timeoutSeconds: 600  // 10åˆ†é’Ÿå¤ªé•¿
```

## ğŸ” æ•…éšœæ’æŸ¥

### æ£€æŸ¥é”çŠ¶æ€

```javascript
// MongoDB æŸ¥è¯¢å½“å‰é”
db.system_locks.find().pretty()

// æŸ¥æ‰¾è¿‡æœŸä½†æœªæ¸…ç†çš„é”
db.system_locks.find({ expiresAt: { $lt: new Date() } })

// ç»Ÿè®¡é”æ•°é‡
db.system_locks.countDocuments()
```

### æ‰‹åŠ¨æ¸…ç†é”

```javascript
// æ¸…ç†æ‰€æœ‰è¿‡æœŸçš„é”
db.system_locks.deleteMany({ expiresAt: { $lt: new Date() } })

// æ¸…ç†ç‰¹å®šçš„é”
db.system_locks.deleteOne({ lockName: "database-initialization" })
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [DistributedLockService å®ç°](mdc:Platform.ApiService/Services/DistributedLockService.cs)
- [åˆ†å¸ƒå¼é”é€»è¾‘é”™è¯¯ä¿®å¤](mdc:docs/bugfixes/DISTRIBUTED-LOCK-LOGIC-FIX.md)
- [æ•°æ®åº“åˆå§‹åŒ–ä¼˜åŒ–](mdc:docs/optimization/DATABASE-INITIALIZATION-OPTIMIZATION.md)

## ğŸ¯ è®°ä½

1. **åŸå­æ“ä½œä¼˜å…ˆ**ï¼šä½¿ç”¨ InsertOne + FindOneAndUpdateï¼Œè€Œä¸æ˜¯å¤æ‚çš„ filter
2. **å”¯ä¸€ç´¢å¼•ä¿æŠ¤**ï¼šLockName å¿…é¡»æœ‰å”¯ä¸€ç´¢å¼•
3. **TTL è‡ªåŠ¨æ¸…ç†**ï¼šä½¿ç”¨ TTL ç´¢å¼•é˜²æ­¢æ­»é”
4. **éªŒè¯å®ä¾‹ID**ï¼šç¡®ä¿è¿”å›çš„é”æ˜¯å½“å‰å®ä¾‹è·å–çš„
5. **è‡ªåŠ¨ç®¡ç†**ï¼šä½¿ç”¨ ExecuteWithLockAsync è€Œä¸æ˜¯æ‰‹åŠ¨ç®¡ç†
