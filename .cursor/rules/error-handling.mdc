---
globs: Platform.ApiService/**/*.cs,Platform.ServiceDefaults/**/*.cs
description: ç»Ÿä¸€é”™è¯¯å¤„ç†ä¸å“åº”æ ¼å¼è§„èŒƒ
---

# ç»Ÿä¸€é”™è¯¯å¤„ç†ä¸å“åº”æ ¼å¼è§„èŒƒ

## 1. å…¨å±€é…ç½®
- å¯ç”¨ `builder.Services.AddProblemDetails()`ï¼Œå°†æœªå¤„ç†å¼‚å¸¸è½¬æ¢ä¸º `application/problem+json`ï¼Œå¹¶è‡ªåŠ¨é™„å¸¦ `traceId`ã€‚
- åœ¨ `Program.cs` ä¸­è°ƒç”¨ `app.UseExceptionHandler();` ä½œä¸ºé¦–ä¸ªåº”ç”¨ä¸­é—´ä»¶ï¼Œç¦æ­¢ç§»é™¤æˆ–ç»•è¿‡è¯¥é…ç½®ã€‚
- ç»Ÿä¸€ä½¿ç”¨ `ActivityLogMiddleware`ï¼ˆè®°å½•è¯·æ±‚ä¸å“åº”å…ƒæ•°æ®ï¼‰å’Œ `ResponseFormattingMiddleware`ï¼ˆåŒ…è£… 200 æˆåŠŸå“åº”ï¼‰ï¼Œé¡ºåºå¿…é¡»ä¿æŒï¼š`UseExceptionHandler â†’ UseCors â†’ UseAuthentication â†’ UseAuthorization â†’ ActivityLogMiddleware â†’ ResponseFormattingMiddleware`ã€‚

```csharp
// Platform.ApiService/Program.cs
builder.Services.AddProblemDetails();

var app = builder.Build();
app.UseExceptionHandler();
app.UseCors();
app.UseAuthentication();
app.UseAuthorization();
app.UseMiddleware<ActivityLogMiddleware>();
app.UseMiddleware<ResponseFormattingMiddleware>();
```

> `ResponseFormattingMiddleware` ä¼šè‡ªåŠ¨è·³è¿‡ `/health*`ã€`/openapi*`ã€`/scalar*`ã€`/hubs/*` ç­‰ç«¯ç‚¹ï¼Œé˜²æ­¢å¹²æ‰°å¥åº·æ£€æŸ¥ã€OpenAPI å’Œ SignalRã€‚

## 2. ç»Ÿä¸€å“åº”ç»“æ„
- æ§åˆ¶å™¨å¿…é¡»ç»§æ‰¿ `BaseApiController` å¹¶ä½¿ç”¨ `Success()`ã€`SuccessPaged()`ã€`Error()`ã€`ValidationError()` ç­‰è¾…åŠ©æ–¹æ³•æ„é€ è¿”å›å€¼ï¼Œåº•å±‚ç»Ÿä¸€å°è£…ä¸º `ApiResponse<T>`ã€‚
- ä¸šåŠ¡é€»è¾‘åªéœ€è¿”å›åŸå§‹æ•°æ®ï¼›ä¸­é—´ä»¶ä¼šå°† `200 OK`ã€`Content-Type: application/json` çš„ç»“æœåŒ…è£…æˆï¼š

```json
{
  "success": true,
  "data": { ... },
  "timestamp": "2025-11-12T08:15:30.123Z"
}
```

- é 200 å“åº”ï¼ˆå¦‚ 400/401/404/500ï¼‰ä¿æŒåŸæœ‰ bodyï¼Œä¾¿äº ProblemDetails å’Œæ–‡ä»¶ä¸‹è½½ç­‰åœºæ™¯æŒ‰è§„èŒƒè¿”å›ã€‚

```csharp
// æ§åˆ¶å™¨ç¤ºä¾‹
[HttpGet("{id}")]
public async Task<IActionResult> Get(string id)
{
    var user = await _userService.GetByIdAsync(id);
    return Success(user.EnsureFound("ç”¨æˆ·", id));
}
```

## 3. ä¸šåŠ¡å¼‚å¸¸ç­–ç•¥
- **å¼‚å¸¸å³é€»è¾‘**ï¼š
  - èµ„æºä¸å­˜åœ¨ï¼š`KeyNotFoundException`
  - å‚æ•°/çŠ¶æ€éæ³•ï¼š`ArgumentException` / `InvalidOperationException`
  - æƒé™ä¸è¶³ï¼š`UnauthorizedAccessException`
  - å¹¶å‘/å†²çªï¼š`InvalidOperationException`ï¼ˆé™„å¸¦æ˜ç¡®é”™è¯¯æ¶ˆæ¯ï¼‰
- ä¸¥ç¦åœ¨æ§åˆ¶å™¨ä¸­æ‰‹åŠ¨ `try-catch` å¹¶è¿”å›è‡ªå®šä¹‰é”™è¯¯ç»“æ„ï¼Œè®© `UseExceptionHandler` + `ProblemDetails` è´Ÿè´£ç»Ÿä¸€è¾“å‡ºã€‚
- ä½¿ç”¨æ‰©å±•æ–¹æ³•å¿«é€ŸæŠ›å‡ºå¼‚å¸¸ï¼š

```csharp
request.EnsureNotNull(nameof(request));
request.Username.EnsureNotEmpty("ç”¨æˆ·å");
var user = await _userFactory.GetByIdAsync(userId).EnsureFound("ç”¨æˆ·", userId);
```

## 4. æ‰‹åŠ¨é”™è¯¯å“åº”
- åªæœ‰åœ¨éœ€è¦è‡ªå®šä¹‰ä¸šåŠ¡é”™è¯¯ç æ—¶ä½¿ç”¨åŸºç±»æä¾›çš„ `Error()` / `ValidationError()` / `NotFoundError()` ç­‰æ–¹æ³•ï¼š

```csharp
if (!result)
{
    return Error("USER_DELETE_FAILED", "åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
}
```

- å…¶å®ƒæƒ…å†µç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œç”±å…¨å±€ç®¡é“å¤„ç†ã€‚

## 5. éªŒè¯ä¸é”™è¯¯æ¶ˆæ¯
- è¯·æ±‚ä½“éªŒè¯ä¼˜å…ˆä½¿ç”¨ FluentValidationï¼ˆ`Platform.ApiService/Validators`ï¼‰æˆ– `ValidationExtensions`ï¼Œå‡ºç°éªŒè¯å¤±è´¥ç«‹å³æŠ›å‡º `ArgumentException`ã€‚
- ä¿æŒé”™è¯¯æ¶ˆæ¯å¯è¯»ï¼šæ˜ç¡®æŒ‡å‡ºå­—æ®µã€é™åˆ¶æˆ–ç¼ºå¤±æ¡ä»¶ã€‚
- ä½¿ç”¨ `ValidationExtensions` å¯ç”Ÿæˆä¸€è‡´çš„ä¸­æ–‡é”™è¯¯ï¼š`EnsureValidEmail("é‚®ç®±")`ã€`EnsureValidPassword()` ç­‰ã€‚

## 6. æ´»åŠ¨æ—¥å¿—ä¸è¿½è¸ª
- `ActivityLogMiddleware` ä¼šåœ¨è¯·æ±‚å®Œæˆåè®°å½•å“åº”çŠ¶æ€ç ä¸ `ResponseFormattingMiddleware` å†™å…¥çš„ body ç‰‡æ®µï¼Œç¡®ä¿é”™è¯¯ä¸Šä¸‹æ–‡å¯è¿½è¸ªã€‚
- æ‰€æœ‰å¼‚å¸¸éƒ½ä¼šåŒ…å« `HttpContext.TraceIdentifier`ï¼Œåœ¨æ—¥å¿—å’Œå“åº”é‡Œä¿æŒä¸€è‡´ã€‚

## 7. æ£€æŸ¥æ¸…å•
- [ ] `Program.cs` ä»ç„¶è°ƒç”¨ `AddProblemDetails()` ä¸ `UseExceptionHandler()`ã€‚
- [ ] æ§åˆ¶å™¨ç»§æ‰¿ `BaseApiController` å¹¶ä½¿ç”¨å†…ç½® `Success/Error` å¸®åŠ©æ–¹æ³•ã€‚
- [ ] ä¸šåŠ¡å±‚é‡åˆ°å¼‚å¸¸ç›´æ¥æŠ›å‡ºæ ‡å‡†å¼‚å¸¸ç±»å‹ï¼Œæ— è‡ªå®šä¹‰åŒ…è£…ã€‚
- [ ] ä½¿ç”¨ `Ensure*` æ‰©å±•è¿›è¡Œå‚æ•°æ ¡éªŒå’Œèµ„æºæ£€æŸ¥ã€‚
- [ ] æ–°å¢ä¸­é—´ä»¶ä¸ç ´å `ResponseFormattingMiddleware` çš„æ‰§è¡Œé¡ºåºã€‚
- [ ] é”™è¯¯æ¶ˆæ¯åŒ…å«ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆèµ„æºåç§°ã€IDã€é™åˆ¶å€¼ç­‰ï¼‰ã€‚

## ğŸ“š ç›¸å…³å‚è€ƒ
- `Platform.ApiService/Program.cs`
- `Platform.ApiService/Middleware/ResponseFormattingMiddleware.cs`
- `Platform.ApiService/Middleware/ActivityLogMiddleware.cs`
- `Platform.ServiceDefaults/Controllers/BaseApiController.cs`
- `Platform.ApiService/Extensions/ValidationExtensions.cs`
- `Platform.ApiService/Extensions/ResourceExtensions.cs`
