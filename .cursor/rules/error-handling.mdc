---
globs: Platform.ApiService/Services/*.cs,Platform.ServiceDefaults/Services/*.cs
description: ç»Ÿä¸€é”™è¯¯å¤„ç†å’Œæ¶ˆæ¯ç®¡ç†è§„èŒƒ
---
# ç»Ÿä¸€é”™è¯¯å¤„ç†å’Œæ¶ˆæ¯ç®¡ç†è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

### ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶å’Œæ¶ˆæ¯ç®¡ç†ï¼Œç¡®ä¿é”™è¯¯ä¿¡æ¯çš„ä¸€è‡´æ€§å’Œç”¨æˆ·ä½“éªŒ

## âœ… é”™è¯¯å¤„ç†æ¶æ„

### å…¨å±€å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶

```csharp
// Platform.ApiService/Middleware/GlobalExceptionMiddleware.cs
public class GlobalExceptionMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger<GlobalExceptionMiddleware> _logger;

    public GlobalExceptionMiddleware(RequestDelegate next, ILogger<GlobalExceptionMiddleware> logger)
    {
        _next = next;
        _logger = logger;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        try
        {
            await _next(context);
        }
        catch (Exception ex)
        {
            await HandleExceptionAsync(context, ex);
        }
    }

    private async Task HandleExceptionAsync(HttpContext context, Exception exception)
    {
        var traceId = Activity.Current?.Id ?? context.TraceIdentifier;
        
        _logger.LogError(exception, 
            "Unhandled exception occurred. TraceId: {TraceId}, Path: {Path}", 
            traceId, 
            context.Request.Path);

        var response = exception switch
        {
            ArgumentException => CreateErrorResponse("å‚æ•°é”™è¯¯", "BAD_REQUEST", StatusCodes.Status400BadRequest, traceId),
            ArgumentNullException => CreateErrorResponse("å‚æ•°ä¸èƒ½ä¸ºç©º", "BAD_REQUEST", StatusCodes.Status400BadRequest, traceId),
            KeyNotFoundException => CreateErrorResponse("èµ„æºä¸å­˜åœ¨", "NOT_FOUND", StatusCodes.Status404NotFound, traceId),
            UnauthorizedAccessException => CreateErrorResponse("æœªæˆæƒè®¿é—®", "UNAUTHORIZED", StatusCodes.Status401Unauthorized, traceId),
            InvalidOperationException => CreateErrorResponse("æ“ä½œå¤±è´¥", "INVALID_OPERATION", StatusCodes.Status400BadRequest, traceId),
            TimeoutException => CreateErrorResponse("è¯·æ±‚è¶…æ—¶", "TIMEOUT", StatusCodes.Status408RequestTimeout, traceId),
            _ => CreateErrorResponse("æœåŠ¡å™¨å†…éƒ¨é”™è¯¯", "INTERNAL_ERROR", StatusCodes.Status500InternalServerError, traceId)
        };

        context.Response.StatusCode = response.StatusCode;
        context.Response.ContentType = "application/json";
        
        await context.Response.WriteAsync(JsonSerializer.Serialize(response.Body));
    }

    private (int StatusCode, object Body) CreateErrorResponse(
        string message, 
        string errorCode, 
        int statusCode,
        string traceId)
    {
        return (statusCode, new
        {
            success = false,
            errorMessage = message,
            errorCode,
            showType = 2, // ERROR_MESSAGE
            traceId,
            timestamp = DateTime.UtcNow
        });
    }
}
```

### é”™è¯¯æ¶ˆæ¯ç®¡ç†

```csharp
// Platform.ServiceDefaults/Services/ErrorMessageService.cs
public interface IErrorMessageService
{
    string GetErrorMessage(string errorCode);
    string GetErrorMessage(string errorCode, params object[] args);
    string GetValidationErrorMessage(string fieldName, string validationType);
}

public class ErrorMessageService : IErrorMessageService
{
    private readonly ILogger<ErrorMessageService> _logger;
    private readonly Dictionary<string, string> _errorMessages;

    public ErrorMessageService(ILogger<ErrorMessageService> logger)
    {
        _logger = logger;
        _errorMessages = InitializeErrorMessages();
    }

    public string GetErrorMessage(string errorCode)
    {
        if (_errorMessages.TryGetValue(errorCode, out var message))
        {
            return message;
        }

        _logger.LogWarning("æœªæ‰¾åˆ°é”™è¯¯ä»£ç : {ErrorCode}", errorCode);
        return "æœªçŸ¥é”™è¯¯";
    }

    public string GetErrorMessage(string errorCode, params object[] args)
    {
        var message = GetErrorMessage(errorCode);
        try
        {
            return string.Format(message, args);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "æ ¼å¼åŒ–é”™è¯¯æ¶ˆæ¯å¤±è´¥: {ErrorCode}, Args: {Args}", errorCode, args);
            return message;
        }
    }

    public string GetValidationErrorMessage(string fieldName, string validationType)
    {
        var errorCode = $"VALIDATION_{validationType.ToUpperInvariant()}";
        return GetErrorMessage(errorCode, fieldName);
    }

    private Dictionary<string, string> InitializeErrorMessages()
    {
        return new Dictionary<string, string>
        {
            // é€šç”¨é”™è¯¯
            ["INTERNAL_ERROR"] = "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯",
            ["BAD_REQUEST"] = "è¯·æ±‚å‚æ•°é”™è¯¯",
            ["UNAUTHORIZED"] = "æœªæˆæƒè®¿é—®",
            ["FORBIDDEN"] = "ç¦æ­¢è®¿é—®",
            ["NOT_FOUND"] = "èµ„æºä¸å­˜åœ¨",
            ["TIMEOUT"] = "è¯·æ±‚è¶…æ—¶",
            ["CONFLICT"] = "èµ„æºå†²çª",

            // ç”¨æˆ·ç›¸å…³é”™è¯¯
            ["USER_NOT_FOUND"] = "ç”¨æˆ·ä¸å­˜åœ¨",
            ["USER_ALREADY_EXISTS"] = "ç”¨æˆ·å·²å­˜åœ¨",
            ["USER_INACTIVE"] = "ç”¨æˆ·å·²åœç”¨",
            ["USER_DELETED"] = "ç”¨æˆ·å·²åˆ é™¤",
            ["USER_CREATE_FAILED"] = "ç”¨æˆ·åˆ›å»ºå¤±è´¥",
            ["USER_UPDATE_FAILED"] = "ç”¨æˆ·æ›´æ–°å¤±è´¥",
            ["USER_DELETE_FAILED"] = "ç”¨æˆ·åˆ é™¤å¤±è´¥",

            // è§’è‰²ç›¸å…³é”™è¯¯
            ["ROLE_NOT_FOUND"] = "è§’è‰²ä¸å­˜åœ¨",
            ["ROLE_ALREADY_EXISTS"] = "è§’è‰²å·²å­˜åœ¨",
            ["ROLE_CREATE_FAILED"] = "è§’è‰²åˆ›å»ºå¤±è´¥",
            ["ROLE_UPDATE_FAILED"] = "è§’è‰²æ›´æ–°å¤±è´¥",
            ["ROLE_DELETE_FAILED"] = "è§’è‰²åˆ é™¤å¤±è´¥",
            ["ROLE_ASSIGN_FAILED"] = "è§’è‰²åˆ†é…å¤±è´¥",

            // ä¼ä¸šç›¸å…³é”™è¯¯
            ["COMPANY_NOT_FOUND"] = "ä¼ä¸šä¸å­˜åœ¨",
            ["COMPANY_ALREADY_EXISTS"] = "ä¼ä¸šå·²å­˜åœ¨",
            ["COMPANY_CREATE_FAILED"] = "ä¼ä¸šåˆ›å»ºå¤±è´¥",
            ["COMPANY_UPDATE_FAILED"] = "ä¼ä¸šæ›´æ–°å¤±è´¥",
            ["COMPANY_DELETE_FAILED"] = "ä¼ä¸šåˆ é™¤å¤±è´¥",

            // æƒé™ç›¸å…³é”™è¯¯
            ["PERMISSION_DENIED"] = "æƒé™ä¸è¶³",
            ["ADMIN_REQUIRED"] = "éœ€è¦ç®¡ç†å‘˜æƒé™",
            ["INVALID_PERMISSION"] = "æ— æ•ˆæƒé™",
            ["PERMISSION_ASSIGN_FAILED"] = "æƒé™åˆ†é…å¤±è´¥",

            // éªŒè¯ç›¸å…³é”™è¯¯
            ["VALIDATION_REQUIRED"] = "{0} ä¸èƒ½ä¸ºç©º",
            ["VALIDATION_LENGTH"] = "{0} é•¿åº¦å¿…é¡»åœ¨ {1} åˆ° {2} ä¸ªå­—ç¬¦ä¹‹é—´",
            ["VALIDATION_FORMAT"] = "{0} æ ¼å¼ä¸æ­£ç¡®",
            ["VALIDATION_RANGE"] = "{0} å¿…é¡»åœ¨ {1} åˆ° {2} ä¹‹é—´",
            ["VALIDATION_UNIQUE"] = "{0} å·²å­˜åœ¨",
            ["VALIDATION_INVALID"] = "{0} æ— æ•ˆ",

            // æ•°æ®åº“ç›¸å…³é”™è¯¯
            ["DATABASE_CONNECTION_FAILED"] = "æ•°æ®åº“è¿æ¥å¤±è´¥",
            ["DATABASE_OPERATION_FAILED"] = "æ•°æ®åº“æ“ä½œå¤±è´¥",
            ["DATABASE_TIMEOUT"] = "æ•°æ®åº“æ“ä½œè¶…æ—¶",
            ["DATABASE_CONSTRAINT_VIOLATION"] = "æ•°æ®åº“çº¦æŸè¿å",

            // æ–‡ä»¶ç›¸å…³é”™è¯¯
            ["FILE_NOT_FOUND"] = "æ–‡ä»¶ä¸å­˜åœ¨",
            ["FILE_UPLOAD_FAILED"] = "æ–‡ä»¶ä¸Šä¼ å¤±è´¥",
            ["FILE_DOWNLOAD_FAILED"] = "æ–‡ä»¶ä¸‹è½½å¤±è´¥",
            ["FILE_SIZE_EXCEEDED"] = "æ–‡ä»¶å¤§å°è¶…å‡ºé™åˆ¶",
            ["FILE_TYPE_NOT_SUPPORTED"] = "æ–‡ä»¶ç±»å‹ä¸æ”¯æŒ",

            // ç½‘ç»œç›¸å…³é”™è¯¯
            ["NETWORK_ERROR"] = "ç½‘ç»œé”™è¯¯",
            ["NETWORK_TIMEOUT"] = "ç½‘ç»œè¶…æ—¶",
            ["NETWORK_CONNECTION_FAILED"] = "ç½‘ç»œè¿æ¥å¤±è´¥"
        };
    }
}
```

## ğŸ¯ æœåŠ¡å±‚é”™è¯¯å¤„ç†

### ç”¨æˆ·æœåŠ¡é”™è¯¯å¤„ç†

```csharp
// âœ… æ­£ç¡® - ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
public class UserService : IUserService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    private readonly IErrorMessageService _errorMessageService;
    private readonly ILogger<UserService> _logger;

    public UserService(
        IDatabaseOperationFactory<User> userFactory,
        IErrorMessageService errorMessageService,
        ILogger<UserService> logger)
    {
        _userFactory = userFactory;
        _errorMessageService = errorMessageService;
        _logger = logger;
    }

    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        try
        {
            // 1. å‚æ•°éªŒè¯
            if (request == null)
                throw new ArgumentNullException(nameof(request));

            // 2. ä¸šåŠ¡éªŒè¯
            await ValidateCreateUserRequestAsync(request);
            
            // 3. æ£€æŸ¥å”¯ä¸€æ€§
            await _uniquenessChecker.EnsureUniqueAsync<User>(u => u.Username, request.Username);
            await _uniquenessChecker.EnsureUniqueAsync<User>(u => u.Email, request.Email);
            
            // 4. åˆ›å»ºç”¨æˆ·å®ä½“
            var user = new User
            {
                Username = request.Username.Trim(),
                Email = request.Email.Trim().ToLowerInvariant(),
                CompanyId = _userFactory.GetRequiredCompanyId(),
                CreatedBy = _userFactory.GetCurrentUserId(),
                CreatedAt = DateTime.UtcNow
            };
            
            var createdUser = await _userFactory.CreateAsync(user);
            
            _logger.LogInformation("ç”¨æˆ·åˆ›å»ºæˆåŠŸ: {UserId}, ç”¨æˆ·å: {Username}", 
                createdUser.Id, createdUser.Username);
            
            return createdUser;
        }
        catch (ArgumentException ex)
        {
            _logger.LogWarning(ex, "ç”¨æˆ·åˆ›å»ºå‚æ•°é”™è¯¯: {Username}", request?.Username);
            throw;
        }
        catch (InvalidOperationException ex)
        {
            _logger.LogWarning(ex, "ç”¨æˆ·åˆ›å»ºä¸šåŠ¡é”™è¯¯: {Username}", request?.Username);
            throw;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "ç”¨æˆ·åˆ›å»ºå¤±è´¥: {Username}", request?.Username);
            throw new InvalidOperationException(_errorMessageService.GetErrorMessage("USER_CREATE_FAILED"), ex);
        }
    }

    public async Task<User?> GetUserByIdAsync(string id)
    {
        try
        {
            if (string.IsNullOrEmpty(id))
                throw new ArgumentException(_errorMessageService.GetErrorMessage("VALIDATION_REQUIRED", "ç”¨æˆ·ID"), nameof(id));

            var user = await _userFactory.GetByIdAsync(id);
            if (user == null)
            {
                _logger.LogWarning("ç”¨æˆ·ä¸å­˜åœ¨: {UserId}", id);
                throw new KeyNotFoundException(_errorMessageService.GetErrorMessage("USER_NOT_FOUND"));
            }

            return user;
        }
        catch (ArgumentException)
        {
            throw;
        }
        catch (KeyNotFoundException)
        {
            throw;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "è·å–ç”¨æˆ·å¤±è´¥: {UserId}", id);
            throw new InvalidOperationException(_errorMessageService.GetErrorMessage("INTERNAL_ERROR"), ex);
        }
    }

    public async Task<bool> UpdateUserAsync(UpdateUserRequest request)
    {
        try
        {
            // 1. å‚æ•°éªŒè¯
            if (request == null)
                throw new ArgumentNullException(nameof(request));

            if (string.IsNullOrEmpty(request.Id))
                throw new ArgumentException(_errorMessageService.GetErrorMessage("VALIDATION_REQUIRED", "ç”¨æˆ·ID"), nameof(request.Id));

            // 2. è·å–ç°æœ‰ç”¨æˆ·
            var existingUser = await _userFactory.GetByIdAsync(request.Id);
            if (existingUser == null)
            {
                _logger.LogWarning("ç”¨æˆ·ä¸å­˜åœ¨: {UserId}", request.Id);
                throw new KeyNotFoundException(_errorMessageService.GetErrorMessage("USER_NOT_FOUND"));
            }

            // 3. ä¸šåŠ¡éªŒè¯
            await ValidateUpdateUserRequestAsync(request, existingUser);
            
            // 4. æ£€æŸ¥å”¯ä¸€æ€§ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if (!string.IsNullOrEmpty(request.Username) && request.Username != existingUser.Username)
            {
                await _uniquenessChecker.EnsureUniqueAsync<User>(u => u.Username, request.Username);
            }
            
            if (!string.IsNullOrEmpty(request.Email) && request.Email != existingUser.Email)
            {
                await _uniquenessChecker.EnsureUniqueAsync<User>(u => u.Email, request.Email);
            }

            // 5. æ„å»ºæ›´æ–°æ“ä½œ
            var update = _userFactory.CreateUpdateBuilder()
                .SetCurrentTimestamp()
                .SetOperationTracking(_userFactory.GetCurrentUserId(), _userFactory.GetCurrentUsername())
                .Build();

            if (!string.IsNullOrEmpty(request.Username))
            {
                update = _userFactory.CreateUpdateBuilder()
                    .Set(u => u.Username, request.Username)
                    .SetCurrentTimestamp()
                    .SetOperationTracking(_userFactory.GetCurrentUserId(), _userFactory.GetCurrentUsername())
                    .Build();
            }

            if (!string.IsNullOrEmpty(request.Email))
            {
                update = _userFactory.CreateUpdateBuilder()
                    .Set(u => u.Email, request.Email)
                    .SetCurrentTimestamp()
                    .SetOperationTracking(_userFactory.GetCurrentUserId(), _userFactory.GetCurrentUsername())
                    .Build();
            }

            // 6. æ‰§è¡Œæ›´æ–°
            var result = await _userFactory.UpdateAsync(existingUser, new OperationContext
            {
                UserId = _userFactory.GetCurrentUserId(),
                Username = _userFactory.GetCurrentUsername(),
                CompanyId = _userFactory.GetCurrentCompanyId(),
                OperationType = OperationType.Update,
                Description = "æ›´æ–°ç”¨æˆ·ä¿¡æ¯"
            });

            if (result)
            {
                _logger.LogInformation("ç”¨æˆ·æ›´æ–°æˆåŠŸ: {UserId}", request.Id);
            }
            else
            {
                _logger.LogWarning("ç”¨æˆ·æ›´æ–°å¤±è´¥: {UserId}", request.Id);
            }

            return result;
        }
        catch (ArgumentException)
        {
            throw;
        }
        catch (KeyNotFoundException)
        {
            throw;
        }
        catch (InvalidOperationException)
        {
            throw;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "ç”¨æˆ·æ›´æ–°å¤±è´¥: {UserId}", request?.Id);
            throw new InvalidOperationException(_errorMessageService.GetErrorMessage("USER_UPDATE_FAILED"), ex);
        }
    }

    public async Task<bool> DeleteUserAsync(string id)
    {
        try
        {
            if (string.IsNullOrEmpty(id))
                throw new ArgumentException(_errorMessageService.GetErrorMessage("VALIDATION_REQUIRED", "ç”¨æˆ·ID"), nameof(id));

            // 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
            var user = await _userFactory.GetByIdAsync(id);
            if (user == null)
            {
                _logger.LogWarning("ç”¨æˆ·ä¸å­˜åœ¨: {UserId}", id);
                throw new KeyNotFoundException(_errorMessageService.GetErrorMessage("USER_NOT_FOUND"));
            }

            // 2. ä¸šåŠ¡è§„åˆ™æ£€æŸ¥
            await ValidateUserDeletionAsync(user);

            // 3. æ‰§è¡Œè½¯åˆ é™¤
            var result = await _userFactory.SoftDeleteAsync(id, new OperationContext
            {
                UserId = _userFactory.GetCurrentUserId(),
                Username = _userFactory.GetCurrentUsername(),
                CompanyId = _userFactory.GetCurrentCompanyId(),
                OperationType = OperationType.Delete,
                Description = "åˆ é™¤ç”¨æˆ·"
            });

            if (result)
            {
                _logger.LogInformation("ç”¨æˆ·åˆ é™¤æˆåŠŸ: {UserId}, ç”¨æˆ·å: {Username}", id, user.Username);
            }
            else
            {
                _logger.LogWarning("ç”¨æˆ·åˆ é™¤å¤±è´¥: {UserId}", id);
            }

            return result;
        }
        catch (ArgumentException)
        {
            throw;
        }
        catch (KeyNotFoundException)
        {
            throw;
        }
        catch (InvalidOperationException)
        {
            throw;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "ç”¨æˆ·åˆ é™¤å¤±è´¥: {UserId}", id);
            throw new InvalidOperationException(_errorMessageService.GetErrorMessage("USER_DELETE_FAILED"), ex);
        }
    }

    private async Task ValidateCreateUserRequestAsync(CreateUserRequest request)
    {
        if (string.IsNullOrEmpty(request.Username))
            throw new ArgumentException(_errorMessageService.GetErrorMessage("VALIDATION_REQUIRED", "ç”¨æˆ·å"), nameof(request.Username));

        if (request.Username.Length < 3 || request.Username.Length > 50)
            throw new ArgumentException(_errorMessageService.GetErrorMessage("VALIDATION_LENGTH", "ç”¨æˆ·å", 3, 50), nameof(request.Username));

        if (!IsValidUsername(request.Username))
            throw new ArgumentException(_errorMessageService.GetErrorMessage("VALIDATION_FORMAT", "ç”¨æˆ·å"), nameof(request.Username));

        if (string.IsNullOrEmpty(request.Email))
            throw new ArgumentException(_errorMessageService.GetErrorMessage("VALIDATION_REQUIRED", "é‚®ç®±"), nameof(request.Email));

        if (!IsValidEmail(request.Email))
            throw new ArgumentException(_errorMessageService.GetErrorMessage("VALIDATION_FORMAT", "é‚®ç®±"), nameof(request.Email));

        if (string.IsNullOrEmpty(request.Password))
            throw new ArgumentException(_errorMessageService.GetErrorMessage("VALIDATION_REQUIRED", "å¯†ç "), nameof(request.Password));

        if (!IsStrongPassword(request.Password))
            throw new ArgumentException(_errorMessageService.GetErrorMessage("VALIDATION_FORMAT", "å¯†ç "), nameof(request.Password));
    }

    private async Task ValidateUpdateUserRequestAsync(UpdateUserRequest request, User existingUser)
    {
        if (string.IsNullOrEmpty(request.Username) && string.IsNullOrEmpty(request.Email))
            throw new ArgumentException("è‡³å°‘éœ€è¦æ›´æ–°ä¸€ä¸ªå­—æ®µ");

        if (!string.IsNullOrEmpty(request.Username))
        {
            if (request.Username.Length < 3 || request.Username.Length > 50)
                throw new ArgumentException(_errorMessageService.GetErrorMessage("VALIDATION_LENGTH", "ç”¨æˆ·å", 3, 50));

            if (!IsValidUsername(request.Username))
                throw new ArgumentException(_errorMessageService.GetErrorMessage("VALIDATION_FORMAT", "ç”¨æˆ·å"));
        }

        if (!string.IsNullOrEmpty(request.Email))
        {
            if (!IsValidEmail(request.Email))
                throw new ArgumentException(_errorMessageService.GetErrorMessage("VALIDATION_FORMAT", "é‚®ç®±"));
        }
    }

    private async Task ValidateUserDeletionAsync(User user)
    {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰å…³è”æ•°æ®
        var hasActivityLogs = await _activityLogs.CountDocumentsAsync(
            Builders<UserActivityLog>.Filter.Eq(al => al.UserId, user.Id)
        ) > 0;

        if (hasActivityLogs)
        {
            throw new InvalidOperationException("ç”¨æˆ·æœ‰æ´»åŠ¨è®°å½•ï¼Œæ— æ³•åˆ é™¤");
        }

        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ä¼ä¸šç®¡ç†å‘˜
        var isAdmin = await _userCompanies.CountDocumentsAsync(
            Builders<UserCompany>.Filter.And(
                Builders<UserCompany>.Filter.Eq(uc => uc.UserId, user.Id),
                Builders<UserCompany>.Filter.Eq(uc => uc.IsAdmin, true)
            )
        ) > 0;

        if (isAdmin)
        {
            throw new InvalidOperationException("ä¼ä¸šç®¡ç†å‘˜æ— æ³•åˆ é™¤");
        }
    }

    private bool IsValidUsername(string username)
    {
        return username.All(c => char.IsLetterOrDigit(c) || c == '_');
    }

    private bool IsValidEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }

    private bool IsStrongPassword(string password)
    {
        if (string.IsNullOrEmpty(password) || password.Length < 8)
            return false;

        var hasLetter = password.Any(char.IsLetter);
        var hasDigit = password.Any(char.IsDigit);
        var hasSpecialChar = password.Any(c => !char.IsLetterOrDigit(c));

        return hasLetter && hasDigit && hasSpecialChar;
    }
}

// âŒ é”™è¯¯ - æ²¡æœ‰ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // æ²¡æœ‰é”™è¯¯å¤„ç†
        var user = new User
        {
            Username = request.Username,
            Email = request.Email
        };
        
        return await _userFactory.CreateAsync(user);
    }
}
```

## ğŸ¯ é”™è¯¯å“åº”æ ¼å¼

### ç»Ÿä¸€é”™è¯¯å“åº”

```csharp
// Platform.ServiceDefaults/Models/ErrorResponse.cs
public class ErrorResponse
{
    public bool Success { get; set; } = false;
    public string ErrorMessage { get; set; } = string.Empty;
    public string ErrorCode { get; set; } = string.Empty;
    public int ShowType { get; set; } = 2; // ERROR_MESSAGE
    public string TraceId { get; set; } = string.Empty;
    public DateTime Timestamp { get; set; } = DateTime.UtcNow;
    public object? Data { get; set; }
}

// Platform.ServiceDefaults/Models/ValidationErrorResponse.cs
public class ValidationErrorResponse : ErrorResponse
{
    public List<ValidationError> ValidationErrors { get; set; } = new List<ValidationError>();
}

public class ValidationError
{
    public string Field { get; set; } = string.Empty;
    public string Message { get; set; } = string.Empty;
    public string ErrorCode { get; set; } = string.Empty;
}
```

### é”™è¯¯å“åº”æ„å»ºå™¨

```csharp
// Platform.ServiceDefaults/Services/ErrorResponseBuilder.cs
public interface IErrorResponseBuilder
{
    ErrorResponse BuildErrorResponse(string errorCode, string message, string traceId);
    ErrorResponse BuildErrorResponse(string errorCode, string message, string traceId, object data);
    ValidationErrorResponse BuildValidationErrorResponse(List<ValidationError> validationErrors, string traceId);
}

public class ErrorResponseBuilder : IErrorResponseBuilder
{
    private readonly IErrorMessageService _errorMessageService;

    public ErrorResponseBuilder(IErrorMessageService errorMessageService)
    {
        _errorMessageService = errorMessageService;
    }

    public ErrorResponse BuildErrorResponse(string errorCode, string message, string traceId)
    {
        return new ErrorResponse
        {
            Success = false,
            ErrorMessage = message,
            ErrorCode = errorCode,
            ShowType = 2, // ERROR_MESSAGE
            TraceId = traceId,
            Timestamp = DateTime.UtcNow
        };
    }

    public ErrorResponse BuildErrorResponse(string errorCode, string message, string traceId, object data)
    {
        return new ErrorResponse
        {
            Success = false,
            ErrorMessage = message,
            ErrorCode = errorCode,
            ShowType = 2, // ERROR_MESSAGE
            TraceId = traceId,
            Timestamp = DateTime.UtcNow,
            Data = data
        };
    }

    public ValidationErrorResponse BuildValidationErrorResponse(List<ValidationError> validationErrors, string traceId)
    {
        return new ValidationErrorResponse
        {
            Success = false,
            ErrorMessage = "å‚æ•°éªŒè¯å¤±è´¥",
            ErrorCode = "VALIDATION_FAILED",
            ShowType = 2, // ERROR_MESSAGE
            TraceId = traceId,
            Timestamp = DateTime.UtcNow,
            ValidationErrors = validationErrors
        };
    }
}
```

## ğŸš« ç¦æ­¢çš„åšæ³•

### ä¸è¦å¿½ç•¥é”™è¯¯å¤„ç†

```csharp
// âŒ é”™è¯¯ - å¿½ç•¥é”™è¯¯å¤„ç†
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // æ²¡æœ‰é”™è¯¯å¤„ç†
        var user = new User
        {
            Username = request.Username,
            Email = request.Email
        };
        
        return await _userFactory.CreateAsync(user);
    }
}

// âœ… æ­£ç¡® - å®Œæ•´çš„é”™è¯¯å¤„ç†
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        try
        {
            // ä¸šåŠ¡é€»è¾‘
            var user = new User
            {
                Username = request.Username,
                Email = request.Email
            };
            
            return await _userFactory.CreateAsync(user);
        }
        catch (ArgumentException ex)
        {
            _logger.LogWarning(ex, "ç”¨æˆ·åˆ›å»ºå‚æ•°é”™è¯¯: {Username}", request?.Username);
            throw;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "ç”¨æˆ·åˆ›å»ºå¤±è´¥: {Username}", request?.Username);
            throw new InvalidOperationException(_errorMessageService.GetErrorMessage("USER_CREATE_FAILED"), ex);
        }
    }
}
```

### ä¸è¦ç¡¬ç¼–ç é”™è¯¯æ¶ˆæ¯

```csharp
// âŒ é”™è¯¯ - ç¡¬ç¼–ç é”™è¯¯æ¶ˆæ¯
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        if (string.IsNullOrEmpty(request.Username))
            throw new ArgumentException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º"); // ç¡¬ç¼–ç 
        
        if (string.IsNullOrEmpty(request.Email))
            throw new ArgumentException("é‚®ç®±ä¸èƒ½ä¸ºç©º"); // ç¡¬ç¼–ç 
    }
}

// âœ… æ­£ç¡® - ä½¿ç”¨é”™è¯¯æ¶ˆæ¯æœåŠ¡
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        if (string.IsNullOrEmpty(request.Username))
            throw new ArgumentException(_errorMessageService.GetErrorMessage("VALIDATION_REQUIRED", "ç”¨æˆ·å"));
        
        if (string.IsNullOrEmpty(request.Email))
            throw new ArgumentException(_errorMessageService.GetErrorMessage("VALIDATION_REQUIRED", "é‚®ç®±"));
    }
}
```

### ä¸è¦å¿½ç•¥æ—¥å¿—è®°å½•

```csharp
// âŒ é”™è¯¯ - æ²¡æœ‰æ—¥å¿—è®°å½•
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        try
        {
            // ä¸šåŠ¡é€»è¾‘
            return await _userFactory.CreateAsync(user);
        }
        catch (Exception ex)
        {
            // æ²¡æœ‰æ—¥å¿—è®°å½•
            throw;
        }
    }
}

// âœ… æ­£ç¡® - å®Œæ•´çš„æ—¥å¿—è®°å½•
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        try
        {
            // ä¸šåŠ¡é€»è¾‘
            var result = await _userFactory.CreateAsync(user);
            
            _logger.LogInformation("ç”¨æˆ·åˆ›å»ºæˆåŠŸ: {UserId}, ç”¨æˆ·å: {Username}", 
                result.Id, result.Username);
            
            return result;
        }
        catch (ArgumentException ex)
        {
            _logger.LogWarning(ex, "ç”¨æˆ·åˆ›å»ºå‚æ•°é”™è¯¯: {Username}", request?.Username);
            throw;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "ç”¨æˆ·åˆ›å»ºå¤±è´¥: {Username}", request?.Username);
            throw new InvalidOperationException(_errorMessageService.GetErrorMessage("USER_CREATE_FAILED"), ex);
        }
    }
}
```

## ğŸ“‹ é”™è¯¯å¤„ç†æ£€æŸ¥æ¸…å•

åˆ›å»ºæˆ–ä¿®æ”¹æœåŠ¡æ—¶æ£€æŸ¥ï¼š

- [ ] ä½¿ç”¨å…¨å±€å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶
- [ ] ä½¿ç”¨é”™è¯¯æ¶ˆæ¯æœåŠ¡
- [ ] é€‚å½“çš„å¼‚å¸¸ç±»å‹
- [ ] å®Œæ•´çš„æ—¥å¿—è®°å½•
- [ ] ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼
- [ ] å‚æ•°éªŒè¯é”™è¯¯å¤„ç†
- [ ] ä¸šåŠ¡è§„åˆ™é”™è¯¯å¤„ç†
- [ ] æ•°æ®åº“æ“ä½œé”™è¯¯å¤„ç†
- [ ] ç½‘ç»œè¯·æ±‚é”™è¯¯å¤„ç†
- [ ] é”™è¯¯ä¿¡æ¯å›½é™…åŒ–æ”¯æŒ

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç”¨æˆ·æœåŠ¡å®ç°](mdc:Platform.ApiService/Services/UserService.cs)
- [è§’è‰²æœåŠ¡å®ç°](mdc:Platform.ApiService/Services/RoleService.cs)
- [ä¼ä¸šæœåŠ¡å®ç°](mdc:Platform.ApiService/Services/CompanyService.cs)
- [å…¨å±€å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶](mdc:Platform.ApiService/Middleware/GlobalExceptionMiddleware.cs)
