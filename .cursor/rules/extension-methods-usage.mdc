---
globs: Platform.ApiService/Services/*.cs,Platform.ServiceDefaults/Services/*.cs
description: æ‰©å±•æ–¹æ³•ä½¿ç”¨è§„èŒƒ - ValidationExtensions å’Œ ResourceExtensions
---

# æ‰©å±•æ–¹æ³•ä½¿ç”¨è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**ä½¿ç”¨ç»Ÿä¸€çš„æ‰©å±•æ–¹æ³•ï¼ˆValidationExtensions å’Œ ResourceExtensionsï¼‰è¿›è¡Œå‚æ•°éªŒè¯å’Œèµ„æºæ£€æŸ¥ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§ã€å®‰å…¨æ€§å’Œä¸šåŠ¡è§„åˆ™ä¸€è‡´æ€§**

## âœ… å‚æ•°éªŒè¯æ‰©å±•æ–¹æ³•

### åŸºç¡€éªŒè¯æ‰©å±•

```csharp
// Platform.ServiceDefaults/Extensions/ValidationExtensions.cs
public static class ValidationExtensions
{
    /// <summary>
    /// éªŒè¯å­—ç¬¦ä¸²ä¸ä¸ºç©º
    /// </summary>
    public static string ValidateNotEmpty(this string value, string parameterName)
    {
        if (string.IsNullOrWhiteSpace(value))
            throw new ArgumentException($"{parameterName} ä¸èƒ½ä¸ºç©º", parameterName);
        return value;
    }

    /// <summary>
    /// éªŒè¯å­—ç¬¦ä¸²é•¿åº¦
    /// </summary>
    public static string ValidateLength(this string value, int minLength, int maxLength, string parameterName)
    {
        if (string.IsNullOrEmpty(value))
            throw new ArgumentException($"{parameterName} ä¸èƒ½ä¸ºç©º", parameterName);

        if (value.Length < minLength)
            throw new ArgumentException($"{parameterName} é•¿åº¦ä¸èƒ½å°‘äº {minLength} ä¸ªå­—ç¬¦", parameterName);

        if (value.Length > maxLength)
            throw new ArgumentException($"{parameterName} é•¿åº¦ä¸èƒ½è¶…è¿‡ {maxLength} ä¸ªå­—ç¬¦", parameterName);

        return value;
    }

    /// <summary>
    /// éªŒè¯é‚®ç®±æ ¼å¼
    /// </summary>
    public static string ValidateEmail(this string value, string parameterName)
    {
        if (string.IsNullOrWhiteSpace(value))
            throw new ArgumentException($"{parameterName} ä¸èƒ½ä¸ºç©º", parameterName);

        try
        {
            var addr = new System.Net.Mail.MailAddress(value);
            if (addr.Address != value)
                throw new ArgumentException($"{parameterName} æ ¼å¼ä¸æ­£ç¡®", parameterName);
        }
        catch
        {
            throw new ArgumentException($"{parameterName} æ ¼å¼ä¸æ­£ç¡®", parameterName);
        }

        return value;
    }

    /// <summary>
    /// éªŒè¯ç”¨æˆ·åæ ¼å¼
    /// </summary>
    public static string ValidateUsername(this string value, string parameterName)
    {
        if (string.IsNullOrWhiteSpace(value))
            throw new ArgumentException($"{parameterName} ä¸èƒ½ä¸ºç©º", parameterName);

        if (value.Length < 3 || value.Length > 50)
            throw new ArgumentException($"{parameterName} é•¿åº¦å¿…é¡»åœ¨3-50ä¸ªå­—ç¬¦ä¹‹é—´", parameterName);

        if (!value.All(c => char.IsLetterOrDigit(c) || c == '_'))
            throw new ArgumentException($"{parameterName} åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿", parameterName);

        return value;
    }

    /// <summary>
    /// éªŒè¯å¯†ç å¼ºåº¦
    /// </summary>
    public static string ValidatePassword(this string value, string parameterName)
    {
        if (string.IsNullOrWhiteSpace(value))
            throw new ArgumentException($"{parameterName} ä¸èƒ½ä¸ºç©º", parameterName);

        if (value.Length < 8)
            throw new ArgumentException($"{parameterName} é•¿åº¦ä¸èƒ½å°‘äº8ä¸ªå­—ç¬¦", parameterName);

        var hasLetter = value.Any(char.IsLetter);
        var hasDigit = value.Any(char.IsDigit);
        var hasSpecialChar = value.Any(c => !char.IsLetterOrDigit(c));

        if (!hasLetter)
            throw new ArgumentException($"{parameterName} å¿…é¡»åŒ…å«å­—æ¯", parameterName);

        if (!hasDigit)
            throw new ArgumentException($"{parameterName} å¿…é¡»åŒ…å«æ•°å­—", parameterName);

        if (!hasSpecialChar)
            throw new ArgumentException($"{parameterName} å¿…é¡»åŒ…å«ç‰¹æ®Šå­—ç¬¦", parameterName);

        return value;
    }

    /// <summary>
    /// éªŒè¯å¯¹è±¡IDæ ¼å¼
    /// </summary>
    public static string ValidateObjectId(this string value, string parameterName)
    {
        if (string.IsNullOrWhiteSpace(value))
            throw new ArgumentException($"{parameterName} ä¸èƒ½ä¸ºç©º", parameterName);

        if (!ObjectId.TryParse(value, out _))
            throw new ArgumentException($"{parameterName} æ ¼å¼ä¸æ­£ç¡®", parameterName);

        return value;
    }

    /// <summary>
    /// éªŒè¯æ•°å€¼èŒƒå›´
    /// </summary>
    public static T ValidateRange<T>(this T value, T minValue, T maxValue, string parameterName) where T : IComparable<T>
    {
        if (value.CompareTo(minValue) < 0)
            throw new ArgumentException($"{parameterName} ä¸èƒ½å°äº {minValue}", parameterName);

        if (value.CompareTo(maxValue) > 0)
            throw new ArgumentException($"{parameterName} ä¸èƒ½å¤§äº {maxValue}", parameterName);

        return value;
    }

    /// <summary>
    /// éªŒè¯é›†åˆä¸ä¸ºç©º
    /// </summary>
    public static IEnumerable<T> ValidateNotEmpty<T>(this IEnumerable<T> value, string parameterName)
    {
        if (value == null || !value.Any())
            throw new ArgumentException($"{parameterName} ä¸èƒ½ä¸ºç©º", parameterName);

        return value;
    }

    /// <summary>
    /// éªŒè¯é›†åˆæ•°é‡
    /// </summary>
    public static IEnumerable<T> ValidateCount<T>(this IEnumerable<T> value, int minCount, int maxCount, string parameterName)
    {
        if (value == null)
            throw new ArgumentException($"{parameterName} ä¸èƒ½ä¸ºç©º", parameterName);

        var count = value.Count();
        if (count < minCount)
            throw new ArgumentException($"{parameterName} æ•°é‡ä¸èƒ½å°‘äº {minCount}", parameterName);

        if (count > maxCount)
            throw new ArgumentException($"{parameterName} æ•°é‡ä¸èƒ½è¶…è¿‡ {maxCount}", parameterName);

        return value;
    }
}
```

### ä¸šåŠ¡éªŒè¯æ‰©å±•

```csharp
// Platform.ApiService/Extensions/BusinessValidationExtensions.cs
public static class BusinessValidationExtensions
{
    /// <summary>
    /// éªŒè¯ç”¨æˆ·åˆ›å»ºè¯·æ±‚
    /// </summary>
    public static CreateUserRequest ValidateCreateUserRequest(this CreateUserRequest request)
    {
        if (request == null)
            throw new ArgumentNullException(nameof(request));

        request.Username.ValidateUsername(nameof(request.Username));
        request.Email.ValidateEmail(nameof(request.Email));
        request.Password.ValidatePassword(nameof(request.Password));

        return request;
    }

    /// <summary>
    /// éªŒè¯ç”¨æˆ·æ›´æ–°è¯·æ±‚
    /// </summary>
    public static UpdateUserRequest ValidateUpdateUserRequest(this UpdateUserRequest request)
    {
        if (request == null)
            throw new ArgumentNullException(nameof(request));

        request.Id.ValidateObjectId(nameof(request.Id));

        if (!string.IsNullOrEmpty(request.Username))
            request.Username.ValidateUsername(nameof(request.Username));

        if (!string.IsNullOrEmpty(request.Email))
            request.Email.ValidateEmail(nameof(request.Email));

        return request;
    }

    /// <summary>
    /// éªŒè¯åˆ†é¡µè¯·æ±‚
    /// </summary>
    public static T ValidatePagination<T>(this T request) where T : IPaginationRequest
    {
        if (request == null)
            throw new ArgumentNullException(nameof(request));

        if (request.Page.HasValue)
            request.Page.Value.ValidateRange(1, int.MaxValue, nameof(request.Page));

        if (request.PageSize.HasValue)
            request.PageSize.Value.ValidateRange(1, 1000, nameof(request.PageSize));

        return request;
    }
}
```

## âœ… èµ„æºæ£€æŸ¥æ‰©å±•æ–¹æ³•

### åŸºç¡€èµ„æºæ£€æŸ¥æ‰©å±•

```csharp
// Platform.ServiceDefaults/Extensions/ResourceExtensions.cs
public static class ResourceExtensions
{
    /// <summary>
    /// æ£€æŸ¥èµ„æºæ˜¯å¦å­˜åœ¨
    /// </summary>
    public static async Task<T> EnsureExistsAsync<T>(this Task<T?> resourceTask, string resourceName, string resourceId) where T : class
    {
        var resource = await resourceTask;
        if (resource == null)
        {
            throw new KeyNotFoundException($"{resourceName} {resourceId} ä¸å­˜åœ¨");
        }
        return resource;
    }

    /// <summary>
    /// æ£€æŸ¥èµ„æºæ˜¯å¦å­˜åœ¨ï¼ˆå¸¦è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯ï¼‰
    /// </summary>
    public static async Task<T> EnsureExistsAsync<T>(this Task<T?> resourceTask, string errorMessage) where T : class
    {
        var resource = await resourceTask;
        if (resource == null)
        {
            throw new KeyNotFoundException(errorMessage);
        }
        return resource;
    }

    /// <summary>
    /// æ£€æŸ¥èµ„æºæ˜¯å¦ä¸å­˜åœ¨
    /// </summary>
    public static async Task EnsureNotExistsAsync<T>(this Task<T?> resourceTask, string resourceName, string resourceId) where T : class
    {
        var resource = await resourceTask;
        if (resource != null)
        {
            throw new InvalidOperationException($"{resourceName} {resourceId} å·²å­˜åœ¨");
        }
    }

    /// <summary>
    /// æ£€æŸ¥èµ„æºæ˜¯å¦ä¸å­˜åœ¨ï¼ˆå¸¦è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯ï¼‰
    /// </summary>
    public static async Task EnsureNotExistsAsync<T>(this Task<T?> resourceTask, string errorMessage) where T : class
    {
        var resource = await resourceTask;
        if (resource != null)
        {
            throw new InvalidOperationException(errorMessage);
        }
    }

    /// <summary>
    /// æ£€æŸ¥èµ„æºæ˜¯å¦å±äºå½“å‰ä¼ä¸š
    /// </summary>
    public static T EnsureBelongsToCurrentCompany<T>(this T resource, string currentCompanyId, string resourceName, string resourceId) where T : IMultiTenant
    {
        if (resource == null)
        {
            throw new KeyNotFoundException($"{resourceName} {resourceId} ä¸å­˜åœ¨");
        }

        if (resource.CompanyId != currentCompanyId)
        {
            throw new UnauthorizedAccessException($"æ— æƒè®¿é—® {resourceName} {resourceId}");
        }

        return resource;
    }

    /// <summary>
    /// æ£€æŸ¥èµ„æºæ˜¯å¦æœªè¢«åˆ é™¤
    /// </summary>
    public static T EnsureNotDeleted<T>(this T resource, string resourceName, string resourceId) where T : ISoftDeletable
    {
        if (resource == null)
        {
            throw new KeyNotFoundException($"{resourceName} {resourceId} ä¸å­˜åœ¨");
        }

        if (resource.IsDeleted)
        {
            throw new InvalidOperationException($"{resourceName} {resourceId} å·²è¢«åˆ é™¤");
        }

        return resource;
    }

    /// <summary>
    /// æ£€æŸ¥èµ„æºæ˜¯å¦å¤„äºæ´»è·ƒçŠ¶æ€
    /// </summary>
    public static T EnsureActive<T>(this T resource, string resourceName, string resourceId) where T : IActiveEntity
    {
        if (resource == null)
        {
            throw new KeyNotFoundException($"{resourceName} {resourceId} ä¸å­˜åœ¨");
        }

        if (!resource.IsActive)
        {
            throw new InvalidOperationException($"{resourceName} {resourceId} å·²åœç”¨");
        }

        return resource;
    }

    /// <summary>
    /// æ£€æŸ¥èµ„æºæ•°é‡é™åˆ¶
    /// </summary>
    public static async Task EnsureWithinLimitAsync<T>(this Task<long> countTask, long limit, string resourceName)
    {
        var count = await countTask;
        if (count >= limit)
        {
            throw new InvalidOperationException($"{resourceName} æ•°é‡å·²è¾¾ä¸Šé™ {limit}");
        }
    }
}
```

## ğŸ¯ æœåŠ¡ä¸­ä½¿ç”¨æ‰©å±•æ–¹æ³•

### ç”¨æˆ·æœåŠ¡ç¤ºä¾‹

```csharp
// âœ… æ­£ç¡® - ä½¿ç”¨éªŒè¯å’Œèµ„æºæ£€æŸ¥æ‰©å±•
public class UserService : IUserService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    private readonly ILogger<UserService> _logger;

    public UserService(
        IDatabaseOperationFactory<User> userFactory,
        ILogger<UserService> logger)
    {
        _userFactory = userFactory;
        _logger = logger;
    }

    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // 1. ä½¿ç”¨éªŒè¯æ‰©å±•è¿›è¡Œå‚æ•°éªŒè¯
        request.ValidateCreateUserRequest();
        
        // 2. æ£€æŸ¥å”¯ä¸€æ€§ï¼ˆä½¿ç”¨èµ„æºæ£€æŸ¥æ‰©å±•ï¼‰
        var currentUserId = _userFactory.GetRequiredUserId();
        var currentUser = await _userFactory.GetByIdAsync(currentUserId);
        var currentCompanyId = currentUser?.CurrentCompanyId ?? throw new UnauthorizedAccessException("æœªæ‰¾åˆ°ä¼ä¸šä¿¡æ¯");
        
        var existingUser = await _userFactory.FindAsync(
            _userFactory.CreateFilterBuilder()
                .Equal(u => u.Username, request.Username)
                .Equal(u => u.CurrentCompanyId, currentCompanyId)
                .Build()
        );
        
        if (existingUser.Any())
        {
            throw new InvalidOperationException("ç”¨æˆ·åå·²å­˜åœ¨");
        }
        
        // 3. åˆ›å»ºç”¨æˆ·å®ä½“
        var user = new User
        {
            Username = request.Username.Trim(),
            Email = request.Email.Trim().ToLowerInvariant(),
            CurrentCompanyId = currentCompanyId,
            IsActive = true
        };
        
        return await _userFactory.CreateAsync(user);
    }

    public async Task<User?> GetUserByIdAsync(string id)
    {
        // ä½¿ç”¨éªŒè¯æ‰©å±•éªŒè¯ID
        id.ValidateObjectId(nameof(id));
        
        return await _userFactory.GetByIdAsync(id);
    }

    public async Task<bool> UpdateUserAsync(UpdateUserRequest request)
    {
        // 1. ä½¿ç”¨éªŒè¯æ‰©å±•è¿›è¡Œå‚æ•°éªŒè¯
        request.ValidateUpdateUserRequest();
        
        // 2. æ£€æŸ¥èµ„æºæ˜¯å¦å­˜åœ¨
        var existingUser = await _userFactory.GetByIdAsync(request.Id);
        if (existingUser == null)
        {
            throw new KeyNotFoundException($"ç”¨æˆ· {request.Id} ä¸å­˜åœ¨");
        }

        // 3. æ£€æŸ¥å”¯ä¸€æ€§ï¼ˆå¦‚æœéœ€è¦ï¼‰
        if (!string.IsNullOrEmpty(request.Username) && request.Username != existingUser.Username)
        {
            var currentUserId = _userFactory.GetRequiredUserId();
            var currentUser = await _userFactory.GetByIdAsync(currentUserId);
            var currentCompanyId = currentUser?.CurrentCompanyId ?? throw new UnauthorizedAccessException("æœªæ‰¾åˆ°ä¼ä¸šä¿¡æ¯");
            
            var duplicateUser = await _userFactory.FindAsync(
                _userFactory.CreateFilterBuilder()
                    .Equal(u => u.Username, request.Username)
                    .Equal(u => u.CurrentCompanyId, currentCompanyId)
                    .Build()
            );
            
            if (duplicateUser.Any())
            {
                throw new InvalidOperationException("ç”¨æˆ·åå·²å­˜åœ¨");
            }
        }

        // 4. æ„å»ºæ›´æ–°æ“ä½œ
        var update = _userFactory.CreateUpdateBuilder()
            .Set(u => u.Username, request.Username ?? existingUser.Username)
            .Set(u => u.Email, request.Email ?? existingUser.Email)
            .Build();

        // 5. æ‰§è¡Œæ›´æ–°
        return await _userFactory.UpdateAsync(existingUser, update);
    }
}
```

## ğŸš« ç¦æ­¢çš„åšæ³•

### ä¸è¦æ‰‹åŠ¨éªŒè¯å’Œæ£€æŸ¥

```csharp
// âŒ é”™è¯¯ - æ‰‹åŠ¨éªŒè¯å’Œæ£€æŸ¥
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // æ‰‹åŠ¨éªŒè¯ï¼ˆå®¹æ˜“é—æ¼å’Œé‡å¤ï¼‰
        if (string.IsNullOrEmpty(request.Username))
            throw new ArgumentException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");
        
        if (request.Username.Length < 3 || request.Username.Length > 50)
            throw new ArgumentException("ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¸ªå­—ç¬¦ä¹‹é—´");
        
        // æ‰‹åŠ¨æ£€æŸ¥ï¼ˆå®¹æ˜“é—æ¼ï¼‰
        var existingUser = await _userFactory.GetByUsernameAsync(request.Username);
        if (existingUser != null)
        {
            throw new InvalidOperationException("ç”¨æˆ·åå·²å­˜åœ¨");
        }
    }
}

// âœ… æ­£ç¡® - ä½¿ç”¨æ‰©å±•æ–¹æ³•
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // ä½¿ç”¨ç»Ÿä¸€çš„éªŒè¯æ‰©å±•
        request.ValidateCreateUserRequest();
        
        // ä½¿ç”¨ç»Ÿä¸€çš„èµ„æºæ£€æŸ¥æ‰©å±•
        // ... æ£€æŸ¥å”¯ä¸€æ€§
    }
}
```

## ğŸ“‹ æ‰©å±•æ–¹æ³•ä½¿ç”¨æ£€æŸ¥æ¸…å•

åˆ›å»ºæˆ–ä¿®æ”¹æœåŠ¡æ—¶æ£€æŸ¥ï¼š

- [ ] ä½¿ç”¨ ValidationExtensions è¿›è¡Œå‚æ•°éªŒè¯
- [ ] ä½¿ç”¨ ResourceExtensions è¿›è¡Œèµ„æºæ£€æŸ¥
- [ ] éªŒè¯æ‰€æœ‰è¾“å…¥å‚æ•°
- [ ] æ£€æŸ¥èµ„æºæ˜¯å¦å­˜åœ¨
- [ ] æ£€æŸ¥èµ„æºæ˜¯å¦å±äºå½“å‰ä¼ä¸š
- [ ] æ£€æŸ¥èµ„æºæ˜¯å¦æœªè¢«åˆ é™¤
- [ ] é¿å…é‡å¤éªŒè¯å’Œæ£€æŸ¥é€»è¾‘
- [ ] æä¾›æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯
- [ ] ä¿æŒéªŒè¯å’Œæ£€æŸ¥ä¸€è‡´æ€§

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç”¨æˆ·æœåŠ¡å®ç°](mdc:Platform.ApiService/Services/UserService.cs)
- [è§’è‰²æœåŠ¡å®ç°](mdc:Platform.ApiService/Services/RoleService.cs)
- [éªŒè¯æ‰©å±•æ–¹æ³•](mdc:Platform.ServiceDefaults/Extensions/ValidationExtensions.cs)
- [èµ„æºæ£€æŸ¥æ‰©å±•æ–¹æ³•](mdc:Platform.ServiceDefaults/Extensions/ResourceExtensions.cs)
