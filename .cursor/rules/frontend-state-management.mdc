---
globs: Platform.Admin/src/contexts/*.ts,Platform.Admin/src/hooks/*.ts,Platform.App/contexts/*.ts,Platform.App/hooks/*.ts
description: å‰ç«¯çŠ¶æ€ç®¡ç†å’Œæ•°æ®æµè§„èŒƒ
---

# å‰ç«¯çŠ¶æ€ç®¡ç†å’Œæ•°æ®æµè§„èŒƒ

## ğŸ¯ æ¦‚è¿°

åŸºäº React Context + useReducer æ¨¡å¼ï¼Œæä¾›ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†å’Œæ•°æ®æµè§„èŒƒã€‚

## ğŸ—ï¸ çŠ¶æ€ç®¡ç†æ¶æ„

### Context + useReducer æ¨¡å¼

```typescript
// âœ… æ ‡å‡†çŠ¶æ€ç®¡ç†ç»“æ„
interface AppState {
  user: User | null;
  theme: Theme;
  loading: boolean;
  error: string | null;
}

type AppAction = 
  | { type: 'SET_USER'; payload: User }
  | { type: 'SET_THEME'; payload: Theme }
  | { type: 'SET_LOADING'; payload: boolean }
  | { type: 'SET_ERROR'; payload: string | null }
  | { type: 'LOGOUT' };

const appReducer = (state: AppState, action: AppAction): AppState => {
  switch (action.type) {
    case 'SET_USER':
      return { ...state, user: action.payload, error: null };
    case 'SET_THEME':
      return { ...state, theme: action.payload };
    case 'SET_LOADING':
      return { ...state, loading: action.payload };
    case 'SET_ERROR':
      return { ...state, error: action.payload, loading: false };
    case 'LOGOUT':
      return { ...state, user: null, error: null };
    default:
      return state;
  }
};
```

### Context Provider å®ç°

```typescript
// âœ… Context Provider å®ç°
interface AppContextType {
  state: AppState;
  dispatch: React.Dispatch<AppAction>;
  // ä¾¿æ·æ–¹æ³•
  setUser: (user: User) => void;
  setTheme: (theme: Theme) => void;
  setLoading: (loading: boolean) => void;
  setError: (error: string | null) => void;
  logout: () => void;
}

const AppContext = createContext<AppContextType | undefined>(undefined);

export const AppProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [state, dispatch] = useReducer(appReducer, initialState);

  const setUser = useCallback((user: User) => {
    dispatch({ type: 'SET_USER', payload: user });
  }, []);

  const setTheme = useCallback((theme: Theme) => {
    dispatch({ type: 'SET_THEME', payload: theme });
  }, []);

  const setLoading = useCallback((loading: boolean) => {
    dispatch({ type: 'SET_LOADING', payload: loading });
  }, []);

  const setError = useCallback((error: string | null) => {
    dispatch({ type: 'SET_ERROR', payload: error });
  }, []);

  const logout = useCallback(() => {
    dispatch({ type: 'LOGOUT' });
  }, []);

  const value = useMemo(() => ({
    state,
    dispatch,
    setUser,
    setTheme,
    setLoading,
    setError,
    logout
  }), [state, setUser, setTheme, setLoading, setError, logout]);

  return (
    <AppContext.Provider value={value}>
      {children}
    </AppContext.Provider>
  );
};
```

## âœ… æ¨èåšæ³•

### 1. è®¤è¯çŠ¶æ€ç®¡ç†

```typescript
// âœ… è®¤è¯çŠ¶æ€ç®¡ç†
interface AuthState {
  user: User | null;
  token: string | null;
  isAuthenticated: boolean;
  isLoading: boolean;
  error: string | null;
}

type AuthAction =
  | { type: 'LOGIN_START' }
  | { type: 'LOGIN_SUCCESS'; payload: { user: User; token: string } }
  | { type: 'LOGIN_FAILURE'; payload: string }
  | { type: 'LOGOUT' }
  | { type: 'CLEAR_ERROR' };

const authReducer = (state: AuthState, action: AuthAction): AuthState => {
  switch (action.type) {
    case 'LOGIN_START':
      return { ...state, isLoading: true, error: null };
    case 'LOGIN_SUCCESS':
      return {
        ...state,
        user: action.payload.user,
        token: action.payload.token,
        isAuthenticated: true,
        isLoading: false,
        error: null
      };
    case 'LOGIN_FAILURE':
      return {
        ...state,
        user: null,
        token: null,
        isAuthenticated: false,
        isLoading: false,
        error: action.payload
      };
    case 'LOGOUT':
      return {
        ...state,
        user: null,
        token: null,
        isAuthenticated: false,
        isLoading: false,
        error: null
      };
    case 'CLEAR_ERROR':
      return { ...state, error: null };
    default:
      return state;
  }
};
```

### 2. è‡ªå®šä¹‰ Hooks

```typescript
// âœ… è‡ªå®šä¹‰ Hooks
export const useAuth = () => {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};

export const useTheme = () => {
  const context = useContext(ThemeContext);
  if (context === undefined) {
    throw new Error('useTheme must be used within a ThemeProvider');
  }
  return context;
};

// ç»„åˆå¤šä¸ª Context çš„ Hook
export const useAppState = () => {
  const auth = useAuth();
  const theme = useTheme();
  
  return {
    user: auth.state.user,
    isAuthenticated: auth.state.isAuthenticated,
    theme: theme.state.theme,
    setTheme: theme.setTheme
  };
};
```

### 3. å¼‚æ­¥çŠ¶æ€ç®¡ç†

```typescript
// âœ… å¼‚æ­¥çŠ¶æ€ç®¡ç†
interface AsyncState<T> {
  data: T | null;
  loading: boolean;
  error: string | null;
}

type AsyncAction<T> =
  | { type: 'FETCH_START' }
  | { type: 'FETCH_SUCCESS'; payload: T }
  | { type: 'FETCH_FAILURE'; payload: string }
  | { type: 'RESET' };

const asyncReducer = <T>(state: AsyncState<T>, action: AsyncAction<T>): AsyncState<T> => {
  switch (action.type) {
    case 'FETCH_START':
      return { ...state, loading: true, error: null };
    case 'FETCH_SUCCESS':
      return { data: action.payload, loading: false, error: null };
    case 'FETCH_FAILURE':
      return { ...state, loading: false, error: action.payload };
    case 'RESET':
      return { data: null, loading: false, error: null };
    default:
      return state;
  }
};

// ä½¿ç”¨ç¤ºä¾‹
export const useAsyncData = <T>(fetchFn: () => Promise<T>) => {
  const [state, dispatch] = useReducer(asyncReducer<T>, {
    data: null,
    loading: false,
    error: null
  });

  const fetch = useCallback(async () => {
    dispatch({ type: 'FETCH_START' });
    try {
      const data = await fetchFn();
      dispatch({ type: 'FETCH_SUCCESS', payload: data });
    } catch (error) {
      dispatch({ type: 'FETCH_FAILURE', payload: error.message });
    }
  }, [fetchFn]);

  return { ...state, fetch };
};
```

### 4. è¡¨å•çŠ¶æ€ç®¡ç†

```typescript
// âœ… è¡¨å•çŠ¶æ€ç®¡ç†
interface FormState<T> {
  values: T;
  errors: Partial<Record<keyof T, string>>;
  touched: Partial<Record<keyof T, boolean>>;
  isSubmitting: boolean;
  isValid: boolean;
}

type FormAction<T> =
  | { type: 'SET_VALUE'; payload: { field: keyof T; value: any } }
  | { type: 'SET_ERRORS'; payload: Partial<Record<keyof T, string>> }
  | { type: 'SET_TOUCHED'; payload: { field: keyof T; touched: boolean } }
  | { type: 'SET_SUBMITTING'; payload: boolean }
  | { type: 'RESET_FORM'; payload: T };

const formReducer = <T>(state: FormState<T>, action: FormAction<T>): FormState<T> => {
  switch (action.type) {
    case 'SET_VALUE':
      return {
        ...state,
        values: { ...state.values, [action.payload.field]: action.payload.value },
        errors: { ...state.errors, [action.payload.field]: undefined }
      };
    case 'SET_ERRORS':
      return { ...state, errors: action.payload };
    case 'SET_TOUCHED':
      return {
        ...state,
        touched: { ...state.touched, [action.payload.field]: action.payload.touched }
      };
    case 'SET_SUBMITTING':
      return { ...state, isSubmitting: action.payload };
    case 'RESET_FORM':
      return {
        values: action.payload,
        errors: {},
        touched: {},
        isSubmitting: false,
        isValid: true
      };
    default:
      return state;
  }
};
```

### 5. ç¼“å­˜çŠ¶æ€ç®¡ç†

```typescript
// âœ… ç¼“å­˜çŠ¶æ€ç®¡ç†
interface CacheState {
  cache: Map<string, { data: any; timestamp: number; ttl: number }>;
}

type CacheAction =
  | { type: 'SET_CACHE'; payload: { key: string; data: any; ttl: number } }
  | { type: 'GET_CACHE'; payload: string }
  | { type: 'CLEAR_CACHE'; payload?: string }
  | { type: 'CLEAR_EXPIRED' };

const cacheReducer = (state: CacheState, action: CacheAction): CacheState => {
  switch (action.type) {
    case 'SET_CACHE':
      const newCache = new Map(state.cache);
      newCache.set(action.payload.key, {
        data: action.payload.data,
        timestamp: Date.now(),
        ttl: action.payload.ttl
      });
      return { cache: newCache };
    case 'CLEAR_CACHE':
      const clearedCache = new Map(state.cache);
      if (action.payload) {
        clearedCache.delete(action.payload);
      } else {
        clearedCache.clear();
      }
      return { cache: clearedCache };
    case 'CLEAR_EXPIRED':
      const filteredCache = new Map();
      const now = Date.now();
      for (const [key, value] of state.cache) {
        if (now - value.timestamp < value.ttl) {
          filteredCache.set(key, value);
        }
      }
      return { cache: filteredCache };
    default:
      return state;
  }
};
```

## âŒ é¿å…çš„åšæ³•

### 1. ä¸è¦ç›´æ¥ä¿®æ”¹çŠ¶æ€

```typescript
// âŒ é”™è¯¯ï¼šç›´æ¥ä¿®æ”¹çŠ¶æ€
const [user, setUser] = useState<User | null>(null);

const updateUser = (newData: Partial<User>) => {
  user.name = newData.name;  // âŒ ç›´æ¥ä¿®æ”¹çŠ¶æ€
  setUser(user);
};

// âœ… æ­£ç¡®ï¼šä¸å¯å˜æ›´æ–°
const updateUser = (newData: Partial<User>) => {
  setUser(prev => prev ? { ...prev, ...newData } : null);
};
```

### 2. ä¸è¦è¿‡åº¦ä½¿ç”¨ Context

```typescript
// âŒ é”™è¯¯ï¼šä¸ºæ¯ä¸ªçŠ¶æ€åˆ›å»º Context
const UserContext = createContext();
const ThemeContext = createContext();
const LoadingContext = createContext();
const ErrorContext = createContext();

// âœ… æ­£ç¡®ï¼šåˆå¹¶ç›¸å…³çŠ¶æ€
const AppContext = createContext();
```

### 3. ä¸è¦å¿½ç•¥é”™è¯¯å¤„ç†

```typescript
// âŒ é”™è¯¯ï¼šå¿½ç•¥é”™è¯¯å¤„ç†
const fetchUser = async () => {
  const user = await api.getUser();
  setUser(user);
};

// âœ… æ­£ç¡®ï¼šå¤„ç†é”™è¯¯
const fetchUser = async () => {
  try {
    setLoading(true);
    const user = await api.getUser();
    setUser(user);
  } catch (error) {
    setError(error.message);
  } finally {
    setLoading(false);
  }
};
```

### 4. ä¸è¦å¿˜è®°æ¸…ç†å‰¯ä½œç”¨

```typescript
// âŒ é”™è¯¯ï¼šå¿˜è®°æ¸…ç†å‰¯ä½œç”¨
useEffect(() => {
  const timer = setInterval(() => {
    // å®šæ—¶å™¨é€»è¾‘
  }, 1000);
  // æ²¡æœ‰æ¸…ç†å®šæ—¶å™¨
}, []);

// âœ… æ­£ç¡®ï¼šæ¸…ç†å‰¯ä½œç”¨
useEffect(() => {
  const timer = setInterval(() => {
    // å®šæ—¶å™¨é€»è¾‘
  }, 1000);
  
  return () => clearInterval(timer);
}, []);
```

## ğŸ”§ æœ€ä½³å®è·µ

### 1. çŠ¶æ€æŒä¹…åŒ–

```typescript
// âœ… çŠ¶æ€æŒä¹…åŒ–
export const usePersistedState = <T>(
  key: string,
  defaultValue: T
): [T, (value: T) => void] => {
  const [state, setState] = useState<T>(() => {
    try {
      const item = localStorage.getItem(key);
      return item ? JSON.parse(item) : defaultValue;
    } catch {
      return defaultValue;
    }
  });

  const setPersistedState = useCallback((value: T) => {
    setState(value);
    localStorage.setItem(key, JSON.stringify(value));
  }, [key]);

  return [state, setPersistedState];
};
```

### 2. çŠ¶æ€é€‰æ‹©å™¨

```typescript
// âœ… çŠ¶æ€é€‰æ‹©å™¨
export const useUserSelector = () => {
  const { state } = useAuth();
  return useMemo(() => ({
    user: state.user,
    isAuthenticated: state.isAuthenticated,
    isLoading: state.isLoading
  }), [state.user, state.isAuthenticated, state.isLoading]);
};
```

### 3. çŠ¶æ€è°ƒè¯•

```typescript
// âœ… çŠ¶æ€è°ƒè¯•
export const useDebugState = (state: any, label: string) => {
  useEffect(() => {
    console.log(`[${label}] State changed:`, state);
  }, [state, label]);
};
```

### 4. çŠ¶æ€éªŒè¯

```typescript
// âœ… çŠ¶æ€éªŒè¯
const validateState = (state: AppState): boolean => {
  if (state.user && !state.user.id) {
    console.error('Invalid user state: missing id');
    return false;
  }
  if (state.loading && state.error) {
    console.error('Invalid state: loading and error both true');
    return false;
  }
  return true;
};
```

## ğŸ“‹ çŠ¶æ€ç®¡ç†æ£€æŸ¥æ¸…å•

å®ç°çŠ¶æ€ç®¡ç†æ—¶æ£€æŸ¥ï¼š

- [ ] ä½¿ç”¨ä¸å¯å˜æ›´æ–°æ¨¡å¼
- [ ] å®ç°é€‚å½“çš„é”™è¯¯å¤„ç†
- [ ] æ·»åŠ åŠ è½½çŠ¶æ€ç®¡ç†
- [ ] è€ƒè™‘çŠ¶æ€æŒä¹…åŒ–éœ€æ±‚
- [ ] å®ç°çŠ¶æ€éªŒè¯
- [ ] æ·»åŠ è°ƒè¯•æ”¯æŒ
- [ ] è€ƒè™‘æ€§èƒ½ä¼˜åŒ–
- [ ] å®ç°çŠ¶æ€æ¸…ç†
- [ ] æ·»åŠ ç±»å‹å®‰å…¨
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

## ğŸ§ª çŠ¶æ€ç®¡ç†æµ‹è¯•

```typescript
// âœ… çŠ¶æ€ç®¡ç†æµ‹è¯•
describe('AuthReducer', () => {
  it('should handle LOGIN_SUCCESS action', () => {
    const initialState = {
      user: null,
      token: null,
      isAuthenticated: false,
      isLoading: false,
      error: null
    };

    const action = {
      type: 'LOGIN_SUCCESS' as const,
      payload: { user: mockUser, token: 'mock-token' }
    };

    const newState = authReducer(initialState, action);

    expect(newState.user).toEqual(mockUser);
    expect(newState.token).toBe('mock-token');
    expect(newState.isAuthenticated).toBe(true);
    expect(newState.isLoading).toBe(false);
    expect(newState.error).toBeNull();
  });
});
```

## ğŸ“š ç›¸å…³èµ„æº

- [React Context æ–‡æ¡£](https://react.dev/reference/react/createContext)
- [useReducer Hook](https://react.dev/reference/react/useReducer)
- [çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ](https://react.dev/learn/managing-state)
- [è®¤è¯ Context](mdc:Platform.Admin/src/contexts/AuthContext.tsx)
- [ä¸»é¢˜ Context](mdc:Platform.Admin/src/contexts/ThemeContext.tsx)

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

1. **ä¸å¯å˜æ€§** - ä½¿ç”¨ä¸å¯å˜æ›´æ–°æ¨¡å¼
2. **å•ä¸€æ•°æ®æº** - é¿å…çŠ¶æ€é‡å¤
3. **å¯é¢„æµ‹æ€§** - çŠ¶æ€å˜åŒ–å¯é¢„æµ‹
4. **æ€§èƒ½ä¼˜åŒ–** - é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
5. **ç±»å‹å®‰å…¨** - ä½¿ç”¨ TypeScript ç±»å‹
6. **é”™è¯¯å¤„ç†** - é€‚å½“çš„é”™è¯¯å¤„ç†
7. **è°ƒè¯•å‹å¥½** - ä¾¿äºè°ƒè¯•å’Œå¼€å‘
8. **æµ‹è¯•å‹å¥½** - ä¾¿äºå•å…ƒæµ‹è¯•
