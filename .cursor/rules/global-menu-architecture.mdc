---
alwaysApply: true
---
# å…¨å±€èœå•æ¶æ„è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**èœå•æ˜¯å…¨å±€ç³»ç»Ÿèµ„æºï¼Œæ‰€æœ‰ä¼ä¸šå…±äº«ç›¸åŒèœå•ï¼Œé€šè¿‡æƒé™æ§åˆ¶æ˜¾ç¤º**

## âœ… æ­£ç¡®çš„èœå•ç®¡ç†æ–¹å¼

### èœå•åˆ›å»º

```csharp
// âœ… åœ¨ç³»ç»Ÿåˆå§‹åŒ–æ—¶åˆ›å»ºå…¨å±€èœå•
// DatabaseInitializerService.cs
private async Task CreateSystemMenusAsync()
{
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    var existingCount = await menus.CountDocumentsAsync();
    if (existingCount > 0) return;
    
    // åˆ›å»ºå…¨å±€èœå•ï¼ˆæ—  CompanyIdï¼‰
    var welcomeMenu = new Menu
    {
        Name = "welcome",
        Title = "æ¬¢è¿",
        Path = "/welcome",
        Component = "./Welcome",
        Icon = "smile",
        Permissions = new List<string>(),  // æ— æƒé™è¦æ±‚
        // âœ… æ—  CompanyId å­—æ®µ
    };
    
    await menus.InsertOneAsync(welcomeMenu);
}
```

### è§’è‰²å…³è”èœå•

```csharp
// âœ… è§’è‰²é€šè¿‡ MenuIds æ§åˆ¶ç”¨æˆ·å¯è§èœå•
var adminRole = new Role
{
    Name = "ç®¡ç†å‘˜",
    CompanyId = company.Id,  // âœ… è§’è‰²å±äºä¼ä¸š
    MenuIds = allMenuIds,    // âœ… åŒ…å«æ‰€æœ‰èœå•ID
    PermissionIds = allPermissionIds
};
```

### èœå•æƒé™é…ç½®

```csharp
// âœ… èœå•å¯ä»¥å®šä¹‰æ‰€éœ€æƒé™
new Menu
{
    Name = "user-management",
    Title = "ç”¨æˆ·ç®¡ç†",
    Path = "/system/user-management",
    Permissions = new List<string> { "user:read" },  // éœ€è¦ç”¨æˆ·æŸ¥çœ‹æƒé™
    // ...
}
```

## âŒ ç¦æ­¢çš„åšæ³•

### ä¸è¦åœ¨ç”¨æˆ·æ³¨å†Œæ—¶åˆ›å»ºèœå•

```csharp
// âŒ ç¦æ­¢ï¼šç”¨æˆ·æ³¨å†Œæ—¶åˆ›å»ºèœå•
CreatePersonalCompanyAsync()
{
    // ...
    var menus = CreateDefaultMenus(company.Id);  // âŒ ä¸è¦è¿™æ ·åš
    await _menus.InsertManyAsync(menus);
}

// âœ… æ­£ç¡®ï¼šèœå•åœ¨ç³»ç»Ÿåˆå§‹åŒ–æ—¶å·²åˆ›å»ºï¼Œæ— éœ€é‡å¤åˆ›å»º
```

### ä¸è¦ä¸ºèœå•æ·»åŠ  CompanyId

```csharp
// âŒ ç¦æ­¢ï¼šMenu æœ‰ CompanyId
public class Menu : MultiTenantEntity  // âŒ ä¸è¦ç»§æ‰¿ MultiTenantEntity

// âœ… æ­£ç¡®ï¼šMenu æ˜¯å…¨å±€èµ„æº
public class Menu : BaseEntity  // âœ… ä¸åŒ…å« CompanyId
```

### ä¸è¦æä¾›èœå•ç®¡ç†ç•Œé¢

```csharp
// âŒ ç¦æ­¢ï¼šæä¾›èœå•çš„ CRUD API
[HttpPost]
public async Task<IActionResult> CreateMenu(...)  // âŒ ç”¨æˆ·ä¸èƒ½åˆ›å»ºèœå•

[HttpPut("{id}")]
public async Task<IActionResult> UpdateMenu(...)  // âŒ ç”¨æˆ·ä¸èƒ½ä¿®æ”¹èœå•

[HttpDelete("{id}")]
public async Task<IActionResult> DeleteMenu(...)  // âŒ ç”¨æˆ·ä¸èƒ½åˆ é™¤èœå•

// âœ… æ­£ç¡®ï¼šåªæä¾›æŸ¥è¯¢æ¥å£
[HttpGet("user")]
public async Task<IActionResult> GetUserMenus()  // âœ… æŸ¥è¯¢ç”¨æˆ·å¯è§èœå•
```

### ä¸è¦ä½¿ç”¨ BaseRepository æŸ¥è¯¢èœå•

```csharp
// âŒ é”™è¯¯ï¼šBaseRepository ä¼šå°è¯•è¿‡æ»¤ CompanyId
private readonly BaseRepository<Menu> _menuRepository;

public MenuService(...)
{
    _menuRepository = new BaseRepository<Menu>(database, "menus", ...);  // âŒ ä¼šæŠ¥é”™
}

// âœ… æ­£ç¡®ï¼šç›´æ¥ä½¿ç”¨ IMongoCollection
private readonly IMongoCollection<Menu> _menus;

public MenuService(...)
{
    _menus = database.GetCollection<Menu>("menus");  // âœ… å…¨å±€æŸ¥è¯¢
}
```

### ä¸è¦åœ¨ routes.ts ä¸­å®šä¹‰ä¸šåŠ¡èœå•

```typescript
// âŒ ç¦æ­¢ï¼šåœ¨ routes.ts ä¸­å®šä¹‰ä¸šåŠ¡èœå•
export default [
  {
    path: '/welcome',
    name: 'welcome',
    icon: 'smile',  // âŒ ä¸è¦å®šä¹‰èœå•å±æ€§
    component: './Welcome',
  }
];

// âœ… æ­£ç¡®ï¼šåªå®šä¹‰è·¯ç”±æ˜ å°„
export default [
  {
    path: '/welcome',
    component: './Welcome',
    hideInMenu: true,  // âœ… éšè—é™æ€èœå•ï¼Œä½¿ç”¨æ•°æ®åº“èœå•
  }
];
```

### ä¸è¦ä½¿ç”¨é™æ€è·¯ç”±ä½œä¸ºèœå•åå¤‡

```typescript
// âŒ ç¦æ­¢ï¼šä½¿ç”¨ routes.ts ä½œä¸ºèœå•åå¤‡
menuDataRender: (menuData) => {
  if (currentUser?.menus?.length > 0) {
    return æ•°æ®åº“èœå•;
  }
  return menuData;  // âŒ ä¸è¦è¿”å›é™æ€è·¯ç”±ä½œä¸ºåå¤‡
}

// âœ… æ­£ç¡®ï¼šåªä½¿ç”¨æ•°æ®åº“èœå•
menuDataRender: () => {
  if (currentUser?.menus?.length > 0) {
    return æ•°æ®åº“èœå•;
  }
  console.warn('âš ï¸ æ•°æ®åº“ä¸­æ²¡æœ‰èœå•');
  return [];  // âœ… æ˜ç¡®è¿”å›ç©ºï¼Œæš´éœ²é—®é¢˜
}
```

## ğŸ“‹ èœå•å¼€å‘æ¸…å•

### æ·»åŠ æ–°èœå•çš„æ­¥éª¤

- [ ] åœ¨ [DatabaseInitializerService.cs](mdc:Platform.ApiService/Services/DatabaseInitializerService.cs) ä¸­æ·»åŠ èœå•å®šä¹‰
- [ ] åˆ›å»ºå¯¹åº”çš„å‰ç«¯é¡µé¢ç»„ä»¶
- [ ] åœ¨ [routes.ts](mdc:Platform.Admin/config/routes.ts) ä¸­æ·»åŠ è·¯ç”±æ˜ å°„ï¼ˆhideInMenu: trueï¼‰
- [ ] åœ¨ [PermissionService.cs](mdc:Platform.ApiService/Services/PermissionService.cs) ä¸­æ·»åŠ å¯¹åº”æƒé™èµ„æºï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] æ¸…ç©ºæ•°æ®åº“æˆ–æ‰‹åŠ¨æ’å…¥èœå•åˆ°æ•°æ®åº“
- [ ] æµ‹è¯•èœå•æ˜¾ç¤ºå’Œæƒé™æ§åˆ¶

### ä¿®æ”¹ç°æœ‰èœå•

- [ ] ä¿®æ”¹ [DatabaseInitializerService.cs](mdc:Platform.ApiService/Services/DatabaseInitializerService.cs) ä¸­çš„èœå•å®šä¹‰
- [ ] æ¸…ç©ºæ•°æ®åº“é‡æ–°åˆå§‹åŒ–
- [ ] æˆ–æ‰‹åŠ¨æ›´æ–°æ•°æ®åº“ä¸­çš„èœå•è®°å½•
- [ ] æµ‹è¯•éªŒè¯

## ğŸ” èœå•æ˜¾ç¤ºæœºåˆ¶

### ä¸¤å±‚æ§åˆ¶

```
1. MenuIdsï¼ˆç²—ç²’åº¦ï¼‰
   â””â”€ æ§åˆ¶ç”¨æˆ·èƒ½çœ‹åˆ°å“ªäº›èœå•é¡¹
   
2. Permissionsï¼ˆç»†ç²’åº¦ï¼‰
   â””â”€ æ§åˆ¶èœå•å†…çš„åŠŸèƒ½æƒé™ï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰
```

### ç¤ºä¾‹

```csharp
// è§’è‰²é…ç½®
var role = new Role
{
    MenuIds = ["user-management-id"],  // å¯ä»¥çœ‹åˆ°"ç”¨æˆ·ç®¡ç†"èœå•
    PermissionIds = ["user:read"]      // åªèƒ½æŸ¥çœ‹ï¼Œä¸èƒ½å¢åˆ æ”¹
};

// ç”¨æˆ·çœ‹åˆ°çš„æ•ˆæœï¼š
// âœ… å·¦ä¾§æ˜¾ç¤º"ç”¨æˆ·ç®¡ç†"èœå•ï¼ˆMenuIds æ§åˆ¶ï¼‰
// âœ… èƒ½è¿›å…¥ç”¨æˆ·åˆ—è¡¨é¡µé¢
// âœ… èƒ½æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨ï¼ˆuser:read æƒé™ï¼‰
// âŒ æ²¡æœ‰"æ–°å»º"æŒ‰é’®ï¼ˆæ—  user:create æƒé™ï¼‰
// âŒ æ²¡æœ‰"ç¼–è¾‘"æŒ‰é’®ï¼ˆæ—  user:update æƒé™ï¼‰
```

## ğŸ—„ï¸ æ•°æ®åº“ç»“æ„

### menus é›†åˆï¼ˆå…¨å±€èµ„æºï¼‰

```javascript
{
  _id: ObjectId("..."),
  name: "user-management",      // å…¨å±€å”¯ä¸€
  title: "ç”¨æˆ·ç®¡ç†",
  path: "/system/user-management",
  component: "./user-management",
  icon: "user",
  parentId: "system_menu_id",
  permissions: ["user:read"],   // éœ€è¦çš„æƒé™
  sortOrder: 1,
  isEnabled: true,
  isDeleted: false,
  createdAt: ISODate("..."),
  updateAt: ISODate("...")
  // âŒ æ—  companyId å­—æ®µ
}
```

### roles é›†åˆï¼ˆä¼ä¸šèµ„æºï¼‰

```javascript
{
  _id: ObjectId("..."),
  name: "ç®¡ç†å‘˜",
  companyId: "company_123",        // âœ… æœ‰ companyId
  menuIds: ["menu1", "menu2"],     // å¯è®¿é—®çš„å…¨å±€èœå•ID
  permissionIds: ["perm1", ...],
  isDeleted: false
}
```

## âš ï¸ å…³é”®æ³¨æ„äº‹é¡¹

### 1. Menu æ¨¡å‹å¿…é¡»ç»§æ‰¿ BaseEntity

```csharp
// âœ… æ­£ç¡®
public class Menu : BaseEntity, INamedEntity
{
    // æ—  CompanyId
}

// âŒ é”™è¯¯
public class Menu : MultiTenantEntity  // ä¼šè‡ªåŠ¨æ·»åŠ  CompanyId
```

### 2. MenuService ä¸ä½¿ç”¨ BaseRepository

```csharp
// âœ… æ­£ç¡®ï¼šç›´æ¥æŸ¥è¯¢ï¼Œæ—  CompanyId è¿‡æ»¤
private readonly IMongoCollection<Menu> _menus;
_menus = database.GetCollection<Menu>("menus");

// âŒ é”™è¯¯ï¼šBaseRepository ä¼šå°è¯•è¿‡æ»¤ CompanyId
private readonly BaseRepository<Menu> _menuRepository;
```

### 3. èœå•ç´¢å¼•ä¸åŒ…å« CompanyId

```csharp
// âœ… æ­£ç¡®ï¼šèœå•ç´¢å¼•
db.menus.createIndex({ name: 1 }, { unique: true })          // name å…¨å±€å”¯ä¸€
db.menus.createIndex({ parentId: 1, sortOrder: 1 })
db.menus.createIndex({ isDeleted: 1, isEnabled: 1 })

// âŒ é”™è¯¯ï¼šä¸è¦åŒ…å« companyId
db.menus.createIndex({ companyId: 1, name: 1 })  // èœå•æ—  companyId
```

### 4. routes.ts å¿…é¡»ä¿ç•™è·¯ç”±æ˜ å°„

```typescript
// âœ… å¿…é¡»ä¿ç•™ï¼šUmiJS éœ€è¦çŸ¥é“ path â†’ component æ˜ å°„
{ path: '/welcome', component: './Welcome', hideInMenu: true }

// âŒ ä¸èƒ½åˆ é™¤ routes.ts
// å¦åˆ™ UmiJS æ— æ³•æ¸²æŸ“é¡µé¢ç»„ä»¶
```

### 5. æ•°æ®åº“èœå•æ˜¯å¼ºä¾èµ–

- ç³»ç»Ÿåˆå§‹åŒ–å¿…é¡»æˆåŠŸåˆ›å»ºèœå•
- èœå•ç¼ºå¤±ä¼šå¯¼è‡´ç”¨æˆ·çœ‹ä¸åˆ°ä»»ä½•èœå•
- å¿…é¡»ç›‘æ§åˆå§‹åŒ–æ—¥å¿—

## ğŸ§ª éªŒè¯èœå•æ¶æ„

### æ£€æŸ¥èœå•æ˜¯å¦æ­£ç¡®

```bash
# 1. æ£€æŸ¥èœå•æ•°é‡
mongo aspire-admin --eval "db.menus.countDocuments()"
# åº”è¯¥è¿”å› 6

# 2. æ£€æŸ¥èœå•æ˜¯å¦æœ‰ companyId
mongo aspire-admin --eval "db.menus.findOne({}, {companyId: 1})"
# companyId å­—æ®µåº”è¯¥ä¸å­˜åœ¨

# 3. æ£€æŸ¥èœå•æƒé™é…ç½®
mongo aspire-admin --eval "db.menus.find({}, {name: 1, permissions: 1}).pretty()"
```

### æ£€æŸ¥ç”¨æˆ·èœå•æ˜¾ç¤º

```bash
# 1. ç™»å½•ç³»ç»Ÿ
# 2. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°
# 3. åº”è¯¥çœ‹åˆ°ï¼š"âœ… ä½¿ç”¨æ•°æ®åº“èœå•"
# 4. ä¸åº”è¯¥çœ‹åˆ°ï¼š"Using default menus"
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å…¨å±€èœå•æ¶æ„è®¾è®¡](mdc:docs/features/GLOBAL-MENU-ARCHITECTURE.md)
- [èœå•æ¸²æŸ“æœºåˆ¶](mdc:docs/features/MENU-RENDERING-MECHANISM.md)
- [å®Œå…¨åŠ¨æ€èœå•æ¶æ„](mdc:docs/features/DYNAMIC-MENU-ONLY.md)
- [DatabaseInitializerService](mdc:Platform.ApiService/Services/DatabaseInitializerService.cs)
- [Menu æ¨¡å‹](mdc:Platform.ApiService/Models/MenuModels.cs)

## ğŸ¯ è®°ä½

1. **å…¨å±€èµ„æº** - Menu æ—  CompanyIdï¼Œæ‰€æœ‰ä¼ä¸šå…±äº«
2. **ç³»ç»Ÿåˆå§‹åŒ–** - åœ¨ DatabaseInitializerService ä¸­åˆ›å»º
3. **ä¸å¯ç®¡ç†** - ç”¨æˆ·ä¸èƒ½åˆ›å»º/ä¿®æ”¹/åˆ é™¤èœå•
4. **æƒé™æ§åˆ¶** - é€šè¿‡ Role.MenuIds å’Œ Menu.Permissions æ§åˆ¶æ˜¾ç¤º
5. **å•ä¸€æ•°æ®æº** - 100% ä»æ•°æ®åº“åŠ è½½ï¼Œroutes.ts åªæ˜¯è·¯ç”±æ˜ å°„
6. **æ˜ç¡®å¤±è´¥** - èœå•ç¼ºå¤±æ—¶è¿”å›ç©ºï¼Œä¸ä½¿ç”¨é™æ€è·¯ç”±åå¤‡

