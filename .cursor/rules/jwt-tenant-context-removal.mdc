---
description: JWT Token ä¸­ç§»é™¤ CurrentCompanyId çš„æ¶æ„å˜æ›´ - ç»Ÿä¸€ä»æ•°æ®åº“è·å–ä¼ä¸šID
globs: Platform.ApiService/**/*.cs,Platform.ServiceDefaults/**/*.cs
---

# JWT Token ä¸­ç§»é™¤ CurrentCompanyId - æ¶æ„å˜æ›´è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**JWT token ä¸­å·²ç§»é™¤ `CurrentCompanyId` å’Œ `companyId` claimã€‚æ‰€æœ‰ä¼ä¸šIDç›¸å…³çš„é€»è¾‘å¿…é¡»ä»æ•°æ®åº“çš„ `user.CurrentCompanyId` è·å–ï¼Œè€Œä¸æ˜¯ä» JWT token è·å–ã€‚**

## âœ… æ­£ç¡®çš„ä¼ä¸šIDè·å–æ–¹å¼

### ä»æ•°æ®åº“è·å–ä¼ä¸šIDï¼ˆæ¨èæ–¹å¼ï¼‰

```csharp
// âœ… æ­£ç¡®ï¼šä»æ•°æ®åº“è·å–å½“å‰ç”¨æˆ·çš„ä¼ä¸šID
var userId = _userFactory.GetRequiredUserId();
var user = await _userFactory.GetByIdAsync(userId);
if (user == null || string.IsNullOrEmpty(user.CurrentCompanyId))
{
    throw new UnauthorizedAccessException("æœªæ‰¾åˆ°å½“å‰ä¼ä¸šä¿¡æ¯");
}
var companyId = user.CurrentCompanyId;
```

### åœ¨æœåŠ¡ä¸­æ·»åŠ è¾…åŠ©æ–¹æ³•

```csharp
/// <summary>
/// è·å–å½“å‰ç”¨æˆ·çš„ä¼ä¸šIDï¼ˆä»æ•°æ®åº“è·å–ï¼Œä¸ä½¿ç”¨ JWT tokenï¼‰
/// </summary>
private async Task<string> GetCurrentCompanyIdAsync()
{
    // âš ï¸ å·²ç§»é™¤ JWT token ä¸­çš„ CurrentCompanyIdï¼Œä»å½“å‰ç”¨æˆ·è·å–
    var currentUserId = _userFactory.GetRequiredUserId();
    var currentUser = await _userFactory.GetByIdAsync(currentUserId);
    if (currentUser == null || string.IsNullOrEmpty(currentUser.CurrentCompanyId))
    {
        throw new UnauthorizedAccessException("æœªæ‰¾åˆ°å½“å‰ä¼ä¸šä¿¡æ¯");
    }
    return currentUser.CurrentCompanyId;
}

// åœ¨æ–¹æ³•ä¸­ä½¿ç”¨
var companyId = await GetCurrentCompanyIdAsync();
```

### åœ¨ Controller ä¸­è·å–ä¼ä¸šID

```csharp
// âœ… æ­£ç¡®ï¼šåœ¨ Controller ä¸­ä»æ•°æ®åº“è·å–
[HttpGet("current")]
[Authorize]
public async Task<IActionResult> GetCurrentCompany()
{
    // ä»æ•°æ®åº“è·å–å½“å‰ç”¨æˆ·çš„ä¼ä¸šID
    var userId = GetRequiredUserId();
    var userService = HttpContext.RequestServices.GetRequiredService<IDatabaseOperationFactory<AppUser>>();
    var user = await userService.GetByIdAsync(userId);
    if (user == null || string.IsNullOrEmpty(user.CurrentCompanyId))
    {
        throw new UnauthorizedAccessException("æœªæ‰¾åˆ°ä¼ä¸šä¿¡æ¯");
    }
    var companyId = user.CurrentCompanyId;
    
    var company = await _companyService.GetCompanyByIdAsync(companyId);
    return Success(company);
}
```

### å¯é€‰çš„è¾…åŠ©æ–¹æ³•ï¼ˆç”¨äºéå¼ºåˆ¶åœºæ™¯ï¼‰

```csharp
/// <summary>
/// å°è¯•è·å–å½“å‰ç”¨æˆ·çš„ä¼ä¸šIDï¼ˆä»æ•°æ®åº“è·å–ï¼Œä¸ä½¿ç”¨ JWT tokenï¼‰
/// å¦‚æœæ²¡æœ‰ç”¨æˆ·ä¸Šä¸‹æ–‡æˆ–ç”¨æˆ·æœªç™»å½•ï¼Œè¿”å› null
/// </summary>
private async Task<string?> TryGetCurrentCompanyIdAsync()
{
    try
    {
        // âš ï¸ å·²ç§»é™¤ JWT token ä¸­çš„ CurrentCompanyIdï¼Œä»å½“å‰ç”¨æˆ·è·å–
        var currentUserId = _userFactory.GetCurrentUserId();
        if (string.IsNullOrEmpty(currentUserId))
        {
            return null;
        }
        
        var currentUser = await _userFactory.GetByIdAsync(currentUserId);
        return currentUser?.CurrentCompanyId;
    }
    catch
    {
        // å¦‚æœæ— æ³•è·å–ï¼ˆå¦‚ç”¨æˆ·æœªç™»å½•ï¼‰ï¼Œè¿”å› null
        return null;
    }
}
```

## âŒ ç¦æ­¢çš„åšæ³•

### âŒ é”™è¯¯ 1: ä» JWT Token è·å–ä¼ä¸šID

```csharp
// âŒ é”™è¯¯ï¼šTenantContext.GetCurrentCompanyId() ç°åœ¨è¿”å› null
var companyId = _tenantContext.GetCurrentCompanyId();

// âŒ é”™è¯¯ï¼šBaseApiController.GetRequiredCompanyId() å·²åºŸå¼ƒ
var companyId = GetRequiredCompanyId();

// âŒ é”™è¯¯ï¼šDatabaseOperationFactory.GetRequiredCompanyId() ä½¿ç”¨ TenantContext
var companyId = _roleFactory.GetRequiredCompanyId();

// âœ… æ­£ç¡®ï¼šä»æ•°æ®åº“è·å–
var userId = _userFactory.GetRequiredUserId();
var user = await _userFactory.GetByIdAsync(userId);
var companyId = user?.CurrentCompanyId;
```

### âœ… æ­£ç¡®åšæ³•ï¼šä¾èµ–è‡ªåŠ¨ç§Ÿæˆ·è¿‡æ»¤ï¼ˆå·²ä¿®å¤ï¼‰

```csharp
// âœ… æ­£ç¡®ï¼šDatabaseOperationFactory å·²ä¿®å¤ï¼Œä¼šè‡ªåŠ¨ä»æ•°æ®åº“è¯»å–ä¼ä¸šIDå¹¶è¿‡æ»¤
var roles = await _roleFactory.FindAsync();  // âœ… è‡ªåŠ¨è¿‡æ»¤å½“å‰ä¼ä¸šçš„è§’è‰²

// âŒ é”™è¯¯ï¼šä¸è¦æ‰‹åŠ¨æ·»åŠ  CompanyId è¿‡æ»¤ï¼ˆæ•°æ®å·¥å‚ä¼šè‡ªåŠ¨å¤„ç†ï¼‰
var companyId = await GetCurrentCompanyIdAsync();
var filter = _roleFactory.CreateFilterBuilder()
    .Equal(r => r.CompanyId, companyId)  // âŒ ä¸éœ€è¦æ‰‹åŠ¨æ·»åŠ 
    .Equal(r => r.IsActive, true)
    .Build();
var roles = await _roleFactory.FindAsync(filter);  // âŒ é”™è¯¯åšæ³•

// âœ… æ­£ç¡®ï¼šä¾èµ–è‡ªåŠ¨è¿‡æ»¤
var filter = _roleFactory.CreateFilterBuilder()
    .Equal(r => r.IsActive, true)  // âœ… åªæ·»åŠ ä¸šåŠ¡è¿‡æ»¤
    .Build();
var roles = await _roleFactory.FindAsync(filter);  // âœ… æ•°æ®å·¥å‚ä¼šè‡ªåŠ¨æ·»åŠ ä¼ä¸šè¿‡æ»¤
```

### âŒ é”™è¯¯ 3: åœ¨ JWT Token ä¸­æ·»åŠ  CurrentCompanyId

```csharp
// âŒ é”™è¯¯ï¼šä¸è¦é‡æ–°æ·»åŠ  CurrentCompanyId åˆ° JWT token
claims.Add(new("currentCompanyId", user.CurrentCompanyId));
claims.Add(new("companyId", user.CurrentCompanyId));

// âœ… æ­£ç¡®ï¼šJWT token ä¸­ä¸åŒ…å«ä¼ä¸šID
var claims = new List<Claim>
{
    new("userId", user.Id ?? string.Empty),
    new("username", user.Username)
};
// âš ï¸ å·²ç§»é™¤ï¼šä¸å†åœ¨ JWT token ä¸­åŒ…å« CurrentCompanyId
```

## ğŸ”§ å¤šç§Ÿæˆ·æŸ¥è¯¢å¤„ç†ï¼ˆå·²ä¿®å¤ï¼‰

### IMultiTenant å®ä½“æŸ¥è¯¢

**âœ… é‡è¦æ›´æ–°**ï¼š`DatabaseOperationFactory.ApplyTenantFilter` å·²ä¿®å¤ï¼Œç°åœ¨ä¼šè‡ªåŠ¨ä»æ•°æ®åº“è¯»å–ä¼ä¸šIDå¹¶æ·»åŠ è¿‡æ»¤ã€‚æ‰€æœ‰æŸ¥è¯¢ `IMultiTenant` å®ä½“çš„ä»£ç åº”è¯¥ä¾èµ–è‡ªåŠ¨è¿‡æ»¤ï¼Œ**ç¦æ­¢æ‰‹åŠ¨æ·»åŠ  `CompanyId` è¿‡æ»¤**ï¼š

```csharp
// âœ… æ­£ç¡®ï¼šä¾èµ–è‡ªåŠ¨è¿‡æ»¤ï¼ˆæ¨èï¼‰
public async Task<List<Role>> GetRolesAsync()
{
    // âœ… æ•°æ®å·¥å‚ä¼šè‡ªåŠ¨æ·»åŠ ä¼ä¸šè¿‡æ»¤ï¼ˆå› ä¸º Role å®ç°äº† IMultiTenantï¼‰
    var filter = _roleFactory.CreateFilterBuilder()
        .Equal(r => r.IsActive, true)  // âœ… åªæ·»åŠ ä¸šåŠ¡è¿‡æ»¤
        .Build();
    
    var roles = await _roleFactory.FindAsync(filter);
    
    return roles;
}

// âŒ é”™è¯¯ï¼šä¸è¦æ‰‹åŠ¨æ·»åŠ  CompanyId è¿‡æ»¤
public async Task<List<Role>> GetRolesAsync()
{
    var companyId = await GetCurrentCompanyIdAsync();
    var filter = _roleFactory.CreateFilterBuilder()
        .Equal(r => r.CompanyId, companyId)  // âŒ ä¸éœ€è¦æ‰‹åŠ¨æ·»åŠ 
        .Equal(r => r.IsActive, true)
        .Build();
    var roles = await _roleFactory.FindWithoutTenantFilterAsync(filter);  // âŒ é”™è¯¯åšæ³•
    return roles;
}
```

### AppUser æŸ¥è¯¢

`AppUser` ä¸å®ç° `IMultiTenant`ï¼Œå› æ­¤ä¸å—è‡ªåŠ¨ç§Ÿæˆ·è¿‡æ»¤å½±å“ï¼Œä½†ä»éœ€è¦æ‰‹åŠ¨æ·»åŠ  `CurrentCompanyId` è¿‡æ»¤ï¼š

```csharp
// âœ… æ­£ç¡®ï¼šæ‰‹åŠ¨æ·»åŠ  CurrentCompanyId è¿‡æ»¤
public async Task<List<AppUser>> GetUsersAsync()
{
    // 1. ä»æ•°æ®åº“è·å–ä¼ä¸šID
    var companyId = await GetCurrentCompanyIdAsync();
    
    // 2. æ‰‹åŠ¨æ·»åŠ  CurrentCompanyId è¿‡æ»¤
    var filter = _userFactory.CreateFilterBuilder()
        .Equal(u => u.CurrentCompanyId, companyId)  // âœ… æ‰‹åŠ¨æ·»åŠ 
        .Equal(u => u.IsActive, true)
        .Build();
    
    // 3. ä½¿ç”¨ FindAsyncï¼ˆAppUser ä¸å®ç° IMultiTenantï¼Œä¸å—è‡ªåŠ¨è¿‡æ»¤å½±å“ï¼‰
    var users = await _userFactory.FindAsync(filter);
    
    return users;
}
```

## ğŸ¯ å…³é”®å˜æ›´ç‚¹

### 1. JWT Token ç”Ÿæˆ

```csharp
// Platform.ApiService/Services/JwtService.cs
// âš ï¸ å·²ç§»é™¤ï¼šä¸å†åœ¨ JWT token ä¸­åŒ…å« CurrentCompanyId
var claims = new List<Claim>
{
    new("userId", user.Id ?? string.Empty),
    new("username", user.Username)
};
// ä¸å†æ·»åŠ  currentCompanyId å’Œ companyId claim
```

### 2. TenantContext.GetCurrentCompanyId()

```csharp
// Platform.ServiceDefaults/Services/TenantContext.cs
// âš ï¸ æ³¨æ„ï¼šæ­¤æ–¹æ³•ç°åœ¨å§‹ç»ˆè¿”å› nullï¼ˆå› ä¸º JWT token ä¸­æ²¡æœ‰ companyId claimï¼‰
public string? GetCurrentCompanyId()
{
    return _httpContextAccessor.HttpContext?.User?.FindFirst("companyId")?.Value;
    // ç°åœ¨è¿”å› nullï¼Œå› ä¸º JWT token ä¸­å·²ç§»é™¤
}
```

### 3. DatabaseOperationFactory è‡ªåŠ¨ç§Ÿæˆ·è¿‡æ»¤ï¼ˆå·²ä¿®å¤ï¼‰

```csharp
// Platform.ServiceDefaults/Services/DatabaseOperationFactory.cs
// âœ… ä¿®å¤ï¼šä»æ•°æ®åº“è¯»å–ä¼ä¸šIDï¼Œè‡ªåŠ¨æ·»åŠ è¿‡æ»¤
/// <summary>
/// åº”ç”¨å¤šç§Ÿæˆ·è¿‡æ»¤
/// âš ï¸ ä¿®å¤ï¼šä½¿ç”¨ MongoDB å­—æ®µåï¼ˆä» BsonElement ç‰¹æ€§è·å–ï¼‰è€Œé C# å±æ€§å
/// </summary>
private FilterDefinition<T> ApplyTenantFilter(FilterDefinition<T> filter)
{
    if (typeof(IMultiTenant).IsAssignableFrom(typeof(T)))
    {
        // âœ… ä»æ•°æ®åº“è¯»å–å½“å‰ç”¨æˆ·çš„ CurrentCompanyIdï¼ˆä¸ä½¿ç”¨ JWT tokenï¼‰
        var companyId = ResolveCurrentCompanyId();
        if (!string.IsNullOrEmpty(companyId))
        {
            var companyIdProperty = typeof(T).GetProperty("CompanyId");
            if (companyIdProperty != null)
            {
                // âœ… è·å– MongoDB å­—æ®µåï¼šä¼˜å…ˆä½¿ç”¨ BsonElement ç‰¹æ€§ï¼Œå¦åˆ™ä½¿ç”¨ camelCase
                var bsonElementAttr = companyIdProperty.GetCustomAttribute<Bson.Serialization.Attributes.BsonElementAttribute>();
                var fieldName = bsonElementAttr?.ElementName ?? "companyId";
                
                // âœ… ä½¿ç”¨ MongoDB å­—æ®µåæ„å»ºè¿‡æ»¤å™¨
                var companyFilter = Builders<T>.Filter.Eq(fieldName, companyId);
                return Builders<T>.Filter.And(filter, companyFilter);
            }
        }
    }
    return filter;
}

/// <summary>
/// ç»Ÿä¸€è§£æå½“å‰ä¼ä¸šIDï¼šç»Ÿä¸€ä»æ•°æ®åº“ users é›†åˆè¯»å–å½“å‰ç”¨æˆ·çš„ CurrentCompanyId
/// </summary>
private string? ResolveCurrentCompanyId()
{
    // ä»æ•°æ®åº“è¯»å–å½“å‰ç”¨æˆ·çš„ CurrentCompanyId
    var userId = _tenantContext.GetCurrentUserId();
    // ... ä» users é›†åˆè¯»å– currentCompanyId å­—æ®µ
}
```

**é‡è¦æ›´æ–°**ï¼š
- âœ… æ•°æ®å·¥å‚å·²ä¿®å¤ï¼šè‡ªåŠ¨ä»æ•°æ®åº“è¯»å–ä¼ä¸šIDå¹¶æ·»åŠ è¿‡æ»¤
- âœ… ä½¿ç”¨æ­£ç¡®çš„ MongoDB å­—æ®µåï¼ˆä» `BsonElement` ç‰¹æ€§è·å–ï¼‰
- âœ… **ç¦æ­¢æ‰‹åŠ¨æ·»åŠ  CompanyId è¿‡æ»¤** - æ‰€æœ‰å®ç°äº† `IMultiTenant` çš„å®ä½“éƒ½åº”è¯¥ä¾èµ–è‡ªåŠ¨è¿‡æ»¤

### 4. BaseApiController.GetRequiredCompanyId()

```csharp
// Platform.ServiceDefaults/Controllers/BaseApiController.cs
// âš ï¸ å·²åºŸå¼ƒï¼šåŒæ­¥ç‰ˆæœ¬ä¸å†å·¥ä½œ
[Obsolete("å·²ç§»é™¤ JWT token ä¸­çš„ CurrentCompanyIdï¼Œè¯·ä½¿ç”¨ GetRequiredCompanyIdAsync() æ›¿ä»£")]
protected string GetRequiredCompanyId()
{
    throw new InvalidOperationException("JWT token ä¸­ä¸å†åŒ…å« CurrentCompanyIdï¼Œè¯·ä½¿ç”¨ GetRequiredCompanyIdAsync() æ›¿ä»£");
}

// âœ… æ–°æ–¹æ³•ï¼šå¼‚æ­¥ç‰ˆæœ¬ï¼Œä»æ•°æ®åº“è·å–
protected async Task<string> GetRequiredCompanyIdAsync()
{
    var userId = GetRequiredUserId();
    var userService = HttpContext.RequestServices.GetRequiredService<IDatabaseOperationFactory<AppUser>>();
    var user = await userService.GetByIdAsync(userId);
    if (user == null || string.IsNullOrEmpty(user.CurrentCompanyId))
    {
        throw new UnauthorizedAccessException("æœªæ‰¾åˆ°ä¼ä¸šä¿¡æ¯");
    }
    return user.CurrentCompanyId;
}
```

## ğŸ“‹ ä»£ç å®¡æŸ¥æ£€æŸ¥æ¸…å•

åˆ›å»ºæˆ–ä¿®æ”¹ä»£ç æ—¶æ£€æŸ¥ï¼š

- [ ] **ä¸ä» JWT token è·å–ä¼ä¸šID** - ä¸ä½¿ç”¨ `TenantContext.GetCurrentCompanyId()` æˆ– `GetRequiredCompanyId()`
- [ ] **ä»æ•°æ®åº“è·å–ä¼ä¸šID** - æ•°æ®å·¥å‚è‡ªåŠ¨ä»æ•°æ®åº“è¯»å–ï¼Œæ— éœ€æ‰‹åŠ¨è·å–ï¼ˆæŸ¥è¯¢åœºæ™¯ï¼‰
- [ ] **ç¦æ­¢æ‰‹åŠ¨æ·»åŠ  CompanyId è¿‡æ»¤** - æŸ¥è¯¢ `IMultiTenant` å®ä½“æ—¶ä¾èµ–è‡ªåŠ¨è¿‡æ»¤ï¼Œä¸è¦æ‰‹åŠ¨æ·»åŠ 
- [ ] **åˆ›å»ºæ—¶è®¾ç½® CompanyId** - åˆ›å»ºå®ä½“æ—¶éœ€è¦ä½¿ç”¨ `GetRequiredCompanyId()` è®¾ç½® `CompanyId`
- [ ] **è·¨ä¼ä¸šæŸ¥è¯¢ä½¿ç”¨ FindWithoutTenantFilterAsync** - åªæœ‰éœ€è¦è·¨ä¼ä¸šæŸ¥è¯¢æ—¶æ‰ä½¿ç”¨ `FindWithoutTenantFilterAsync` å¹¶æ‰‹åŠ¨æ·»åŠ è¿‡æ»¤
- [ ] **Controller ä½¿ç”¨å¼‚æ­¥æ–¹æ³•** - Controller ä¸­ä½¿ç”¨ `GetRequiredCompanyIdAsync()` è€Œä¸æ˜¯ `GetRequiredCompanyId()`
- [ ] **JWT Token ä¸åŒ…å«ä¼ä¸šID** - ç¡®è®¤ JWT token ç”Ÿæˆæ—¶ä¸æ·»åŠ  `currentCompanyId` æˆ– `companyId` claim

## ğŸ¯ æŸ¥è¯¢æ¨¡å¼

### æ¨¡å¼ 1: æ ‡å‡†æŸ¥è¯¢ï¼ˆIMultiTenant å®ä½“ï¼‰- å·²æ›´æ–°

```csharp
// âœ… æ­£ç¡®æ¨¡å¼ï¼šä¾èµ–è‡ªåŠ¨è¿‡æ»¤ï¼ˆæ¨èï¼‰
public async Task<List<Role>> GetRolesAsync()
{
    // âœ… æ•°æ®å·¥å‚ä¼šè‡ªåŠ¨æ·»åŠ ä¼ä¸šè¿‡æ»¤ï¼ˆå› ä¸º Role å®ç°äº† IMultiTenantï¼‰
    var filter = _roleFactory.CreateFilterBuilder()
        .Equal(r => r.IsActive, true)  // âœ… åªæ·»åŠ ä¸šåŠ¡è¿‡æ»¤
        .Build();
    
    var roles = await _roleFactory.FindAsync(filter);
    
    return roles;
}

// âŒ é”™è¯¯æ¨¡å¼ï¼šæ‰‹åŠ¨æ·»åŠ  CompanyId è¿‡æ»¤
public async Task<List<Role>> GetRolesAsync()
{
    var companyId = await GetCurrentCompanyIdAsync();
    var filter = _roleFactory.CreateFilterBuilder()
        .Equal(r => r.CompanyId, companyId)  // âŒ ä¸éœ€è¦æ‰‹åŠ¨æ·»åŠ 
        .Equal(r => r.IsActive, true)
        .Build();
    var roles = await _roleFactory.FindWithoutTenantFilterAsync(filter);  // âŒ é”™è¯¯åšæ³•
    return roles;
}
```

### æ¨¡å¼ 2: è·¨ä¼ä¸šæŸ¥è¯¢ï¼ˆç‰¹æ®Šåœºæ™¯ï¼‰

```csharp
// âœ… æ­£ç¡®æ¨¡å¼ï¼šè·¨ä¼ä¸šæŸ¥è¯¢æ—¶æ˜ç¡®æŒ‡å®šå¤šä¸ªä¼ä¸šID
public async Task<List<Role>> GetRolesForCompaniesAsync(List<string> companyIds)
{
    // 1. æ‰‹åŠ¨æ„å»ºè¿‡æ»¤å™¨ï¼ˆä¸ä¾èµ–è‡ªåŠ¨è¿‡æ»¤ï¼‰
    var filter = _roleFactory.CreateFilterBuilder()
        .In(r => r.CompanyId, companyIds)  // âœ… æ‰‹åŠ¨æŒ‡å®šå¤šä¸ªä¼ä¸š
        .Equal(r => r.IsActive, true)
        .Build();
    
    // 2. ä½¿ç”¨ FindWithoutTenantFilterAsync
    var roles = await _roleFactory.FindWithoutTenantFilterAsync(filter);
    
    return roles;
}
```

### æ¨¡å¼ 3: AppUser æŸ¥è¯¢

```csharp
// âœ… æ­£ç¡®æ¨¡å¼ï¼šAppUser ä¸å®ç° IMultiTenant
public async Task<List<AppUser>> GetUsersAsync()
{
    // 1. ä»æ•°æ®åº“è·å–ä¼ä¸šID
    var userId = _userFactory.GetRequiredUserId();
    var currentUser = await _userFactory.GetByIdAsync(userId);
    var companyId = currentUser?.CurrentCompanyId ?? throw new UnauthorizedAccessException("æœªæ‰¾åˆ°ä¼ä¸šä¿¡æ¯");
    
    // 2. æ‰‹åŠ¨æ·»åŠ  CurrentCompanyId è¿‡æ»¤ï¼ˆAppUser ä¸ä½¿ç”¨ CompanyIdï¼‰
    var filter = _userFactory.CreateFilterBuilder()
        .Equal(u => u.CurrentCompanyId, companyId)  // âœ… ä½¿ç”¨ CurrentCompanyId
        .Equal(u => u.IsActive, true)
        .Build();
    
    // 3. ä½¿ç”¨ FindAsyncï¼ˆAppUser ä¸å®ç° IMultiTenantï¼Œä¸å—è‡ªåŠ¨è¿‡æ»¤å½±å“ï¼‰
    var users = await _userFactory.FindAsync(filter);
    
    return users;
}
```

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. è‡ªåŠ¨ç§Ÿæˆ·è¿‡æ»¤å·²ä¿®å¤ âœ…

`DatabaseOperationFactory.ApplyTenantFilter` å·²ä¿®å¤ï¼Œç°åœ¨ä¼šè‡ªåŠ¨ä»æ•°æ®åº“è¯»å–ä¼ä¸šIDå¹¶æ·»åŠ  `CompanyId` è¿‡æ»¤ã€‚

**å½±å“**ï¼š
- âœ… æ‰€æœ‰æŸ¥è¯¢ `IMultiTenant` å®ä½“çš„ä»£ç ä¼šè‡ªåŠ¨åº”ç”¨ä¼ä¸šè¿‡æ»¤
- âœ… **ç¦æ­¢æ‰‹åŠ¨æ·»åŠ  CompanyId è¿‡æ»¤** - ä¾èµ–æ•°æ®å·¥å‚çš„è‡ªåŠ¨è¿‡æ»¤æœºåˆ¶
- âœ… æ•°æ®éš”ç¦»ç”±æ•°æ®å·¥å‚ç»Ÿä¸€ä¿éšœ

### 2. æ€§èƒ½è€ƒè™‘

æ•°æ®å·¥å‚ä¼šç¼“å­˜ä¼ä¸šIDçš„æŸ¥è¯¢ç»“æœï¼ˆåœ¨åŒä¸€è¯·æ±‚ä¸­ï¼‰ã€‚å¦‚æœéœ€è¦è·¨å¤šä¸ªæ–¹æ³•ä½¿ç”¨ä¼ä¸šIDï¼Œè€ƒè™‘ï¼š

```csharp
// âœ… åœ¨æ–¹æ³•å¼€å§‹æ—¶è·å–ä¸€æ¬¡ï¼Œé‡å¤ä½¿ç”¨ï¼ˆä»…ç”¨äºåˆ›å»ºå®ä½“æ—¶ï¼‰
public async Task<Role> CreateRoleAsync(CreateRoleRequest request)
{
    var companyId = await GetCurrentCompanyIdAsync();  // åˆ›å»ºæ—¶éœ€è¦è®¾ç½® CompanyId
    
    var role = new Role
    {
        Name = request.Name,
        CompanyId = companyId  // âœ… åˆ›å»ºæ—¶å¿…é¡»è®¾ç½®
    };
    return await _roleFactory.CreateAsync(role);
}

// âœ… æŸ¥è¯¢æ—¶ä¾èµ–è‡ªåŠ¨è¿‡æ»¤ï¼ˆæ¨èï¼‰
public async Task<List<Role>> GetRolesAsync()
{
    // âœ… æ— éœ€æ‰‹åŠ¨è·å– companyIdï¼Œæ•°æ®å·¥å‚ä¼šè‡ªåŠ¨å¤„ç†
    var roles = await _roleFactory.FindAsync();  // è‡ªåŠ¨è¿‡æ»¤å½“å‰ä¼ä¸š
    
    return roles;
}
```

### 3. ç¼“å­˜ç­–ç•¥ï¼ˆå¯é€‰ï¼‰

å¦‚æœé¢‘ç¹è®¿é—®ï¼Œå¯ä»¥è€ƒè™‘ç¼“å­˜ï¼š

```csharp
// âœ… å¯é€‰ï¼šç¼“å­˜å½“å‰ç”¨æˆ·çš„ä¼ä¸šIDï¼ˆä½œç”¨åŸŸå†…ï¼‰
private string? _cachedCompanyId;

private async Task<string> GetCurrentCompanyIdAsync()
{
    if (!string.IsNullOrEmpty(_cachedCompanyId))
        return _cachedCompanyId;
    
    var userId = _userFactory.GetRequiredUserId();
    var user = await _userFactory.GetByIdAsync(userId);
    if (user == null || string.IsNullOrEmpty(user.CurrentCompanyId))
    {
        throw new UnauthorizedAccessException("æœªæ‰¾åˆ°å½“å‰ä¼ä¸šä¿¡æ¯");
    }
    
    _cachedCompanyId = user.CurrentCompanyId;
    return _cachedCompanyId;
}
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [JWT CurrentCompanyId ç§»é™¤ä¿®å¤](mdc:docs/bugfixes/JWT-CURRENT-COMPANY-ID-REMOVAL.md)
- [ä¼ä¸šåˆ‡æ¢æƒé™ä¿®å¤](mdc:docs/bugfixes/COMPANY-SWITCH-PERMISSION-FIX.md)
- [å¤šç§Ÿæˆ·å®ä½“å®Œæ•´è®¾è®¡è§„èŒƒ](mdc:.cursor/rules/multi-tenant-entity-design-complete.mdc)
- [BaseApiController](mdc:Platform.ServiceDefaults/Controllers/BaseApiController.cs)
- [JwtService](mdc:Platform.ApiService/Services/JwtService.cs)

## ğŸ¯ è®°ä½

1. **JWT token ä¸åŒ…å«ä¼ä¸šID** - å·²å®Œå…¨ç§»é™¤ `currentCompanyId` å’Œ `companyId` claim
2. **ç»Ÿä¸€ä»æ•°æ®åº“è·å–** - æ‰€æœ‰ä¼ä¸šIDä» `user.CurrentCompanyId` è·å–
3. **ä¾èµ–è‡ªåŠ¨è¿‡æ»¤** - æŸ¥è¯¢ `IMultiTenant` å®ä½“æ—¶ä¾èµ–æ•°æ®å·¥å‚çš„è‡ªåŠ¨è¿‡æ»¤ï¼Œç¦æ­¢æ‰‹åŠ¨æ·»åŠ  `CompanyId` è¿‡æ»¤
4. **è·¨ä¼ä¸šæŸ¥è¯¢** - åªæœ‰éœ€è¦è·¨ä¼ä¸šæŸ¥è¯¢æ—¶æ‰ä½¿ç”¨ `FindWithoutTenantFilterAsync` å¹¶æ‰‹åŠ¨æ·»åŠ è¿‡æ»¤
5. **å®æ—¶æ€§æ›´å¥½** - ä»æ•°æ®åº“è·å–ç¡®ä¿åˆ‡æ¢ä¼ä¸šåç«‹å³ç”Ÿæ•ˆï¼Œä¸å— JWT token å»¶è¿Ÿå½±å“

éµå¾ªè¿™äº›è§„èŒƒï¼Œç¡®ä¿å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»çš„æ­£ç¡®æ€§å’Œä¸€è‡´æ€§ï¼
