---
description: JWT Token ä¸­ç§»é™¤ CurrentCompanyId çš„æ¶æ„å˜æ›´ - ç»Ÿä¸€ä»æ•°æ®åº“è·å–ä¼ä¸šID
globs: Platform.ApiService/**/*.cs,Platform.ServiceDefaults/**/*.cs
---

# JWT Token ä¸­ç§»é™¤ CurrentCompanyId - æ¶æ„å˜æ›´è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**JWT token ä¸­å·²ç§»é™¤ `CurrentCompanyId` å’Œ `companyId` claimã€‚æ‰€æœ‰ä¼ä¸šIDç›¸å…³çš„é€»è¾‘å¿…é¡»ä»æ•°æ®åº“çš„ `user.CurrentCompanyId` è·å–ï¼Œè€Œä¸æ˜¯ä» JWT token è·å–ã€‚**

## âœ… æ­£ç¡®çš„ä¼ä¸šIDè·å–æ–¹å¼

### ä»æ•°æ®åº“è·å–ä¼ä¸šIDï¼ˆæ¨èæ–¹å¼ï¼‰

```csharp
// âœ… æ­£ç¡®ï¼šä»æ•°æ®åº“è·å–å½“å‰ç”¨æˆ·çš„ä¼ä¸šID
var userId = _userFactory.GetRequiredUserId();
var user = await _userFactory.GetByIdAsync(userId);
if (user == null || string.IsNullOrEmpty(user.CurrentCompanyId))
{
    throw new UnauthorizedAccessException("æœªæ‰¾åˆ°å½“å‰ä¼ä¸šä¿¡æ¯");
}
var companyId = user.CurrentCompanyId;
```

### åœ¨æœåŠ¡ä¸­æ·»åŠ è¾…åŠ©æ–¹æ³•

```csharp
/// <summary>
/// è·å–å½“å‰ç”¨æˆ·çš„ä¼ä¸šIDï¼ˆä»æ•°æ®åº“è·å–ï¼Œä¸ä½¿ç”¨ JWT tokenï¼‰
/// </summary>
private async Task<string> GetCurrentCompanyIdAsync()
{
    // âš ï¸ å·²ç§»é™¤ JWT token ä¸­çš„ CurrentCompanyIdï¼Œä»å½“å‰ç”¨æˆ·è·å–
    var currentUserId = _userFactory.GetRequiredUserId();
    var currentUser = await _userFactory.GetByIdAsync(currentUserId);
    if (currentUser == null || string.IsNullOrEmpty(currentUser.CurrentCompanyId))
    {
        throw new UnauthorizedAccessException("æœªæ‰¾åˆ°å½“å‰ä¼ä¸šä¿¡æ¯");
    }
    return currentUser.CurrentCompanyId;
}

// åœ¨æ–¹æ³•ä¸­ä½¿ç”¨
var companyId = await GetCurrentCompanyIdAsync();
```

### åœ¨ Controller ä¸­è·å–ä¼ä¸šID

```csharp
// âœ… æ­£ç¡®ï¼šåœ¨ Controller ä¸­ä»æ•°æ®åº“è·å–
[HttpGet("current")]
[Authorize]
public async Task<IActionResult> GetCurrentCompany()
{
    // ä»æ•°æ®åº“è·å–å½“å‰ç”¨æˆ·çš„ä¼ä¸šID
    var userId = GetRequiredUserId();
    var userService = HttpContext.RequestServices.GetRequiredService<IDatabaseOperationFactory<AppUser>>();
    var user = await userService.GetByIdAsync(userId);
    if (user == null || string.IsNullOrEmpty(user.CurrentCompanyId))
    {
        throw new UnauthorizedAccessException("æœªæ‰¾åˆ°ä¼ä¸šä¿¡æ¯");
    }
    var companyId = user.CurrentCompanyId;
    
    var company = await _companyService.GetCompanyByIdAsync(companyId);
    return Success(company);
}
```

### å¯é€‰çš„è¾…åŠ©æ–¹æ³•ï¼ˆç”¨äºéå¼ºåˆ¶åœºæ™¯ï¼‰

```csharp
/// <summary>
/// å°è¯•è·å–å½“å‰ç”¨æˆ·çš„ä¼ä¸šIDï¼ˆä»æ•°æ®åº“è·å–ï¼Œä¸ä½¿ç”¨ JWT tokenï¼‰
/// å¦‚æœæ²¡æœ‰ç”¨æˆ·ä¸Šä¸‹æ–‡æˆ–ç”¨æˆ·æœªç™»å½•ï¼Œè¿”å› null
/// </summary>
private async Task<string?> TryGetCurrentCompanyIdAsync()
{
    try
    {
        // âš ï¸ å·²ç§»é™¤ JWT token ä¸­çš„ CurrentCompanyIdï¼Œä»å½“å‰ç”¨æˆ·è·å–
        var currentUserId = _userFactory.GetCurrentUserId();
        if (string.IsNullOrEmpty(currentUserId))
        {
            return null;
        }
        
        var currentUser = await _userFactory.GetByIdAsync(currentUserId);
        return currentUser?.CurrentCompanyId;
    }
    catch
    {
        // å¦‚æœæ— æ³•è·å–ï¼ˆå¦‚ç”¨æˆ·æœªç™»å½•ï¼‰ï¼Œè¿”å› null
        return null;
    }
}
```

## âŒ ç¦æ­¢çš„åšæ³•

### âŒ é”™è¯¯ 1: ä» JWT Token è·å–ä¼ä¸šID

```csharp
// âŒ é”™è¯¯ï¼šTenantContext.GetCurrentCompanyId() ç°åœ¨è¿”å› null
var companyId = _tenantContext.GetCurrentCompanyId();

// âŒ é”™è¯¯ï¼šBaseApiController.GetRequiredCompanyId() å·²åºŸå¼ƒ
var companyId = GetRequiredCompanyId();

// âŒ é”™è¯¯ï¼šDatabaseOperationFactory.GetRequiredCompanyId() ä½¿ç”¨ TenantContext
var companyId = _roleFactory.GetRequiredCompanyId();

// âœ… æ­£ç¡®ï¼šä»æ•°æ®åº“è·å–
var userId = _userFactory.GetRequiredUserId();
var user = await _userFactory.GetByIdAsync(userId);
var companyId = user?.CurrentCompanyId;
```

### âŒ é”™è¯¯ 2: ä¾èµ–è‡ªåŠ¨ç§Ÿæˆ·è¿‡æ»¤

```csharp
// âŒ é”™è¯¯ï¼šDatabaseOperationFactory.ApplyTenantFilter ä¸å†å·¥ä½œ
// å› ä¸º TenantContext.GetCurrentCompanyId() è¿”å› null
var roles = await _roleFactory.FindAsync();  // âŒ ä¸ä¼šè‡ªåŠ¨è¿‡æ»¤ CompanyId

// âœ… æ­£ç¡®ï¼šæ‰‹åŠ¨æ·»åŠ  CompanyId è¿‡æ»¤
var companyId = await GetCurrentCompanyIdAsync();
var filter = _roleFactory.CreateFilterBuilder()
    .Equal(r => r.CompanyId, companyId)  // âœ… æ‰‹åŠ¨æ·»åŠ 
    .Equal(r => r.IsActive, true)
    .Build();

var roles = await _roleFactory.FindWithoutTenantFilterAsync(filter);  // âœ… è·³è¿‡è‡ªåŠ¨è¿‡æ»¤
```

### âŒ é”™è¯¯ 3: åœ¨ JWT Token ä¸­æ·»åŠ  CurrentCompanyId

```csharp
// âŒ é”™è¯¯ï¼šä¸è¦é‡æ–°æ·»åŠ  CurrentCompanyId åˆ° JWT token
claims.Add(new("currentCompanyId", user.CurrentCompanyId));
claims.Add(new("companyId", user.CurrentCompanyId));

// âœ… æ­£ç¡®ï¼šJWT token ä¸­ä¸åŒ…å«ä¼ä¸šID
var claims = new List<Claim>
{
    new("userId", user.Id ?? string.Empty),
    new("username", user.Username)
};
// âš ï¸ å·²ç§»é™¤ï¼šä¸å†åœ¨ JWT token ä¸­åŒ…å« CurrentCompanyId
```

## ğŸ”§ å¤šç§Ÿæˆ·æŸ¥è¯¢å¤„ç†

### IMultiTenant å®ä½“æŸ¥è¯¢

ç”±äº `DatabaseOperationFactory.ApplyTenantFilter` ä¸å†è‡ªåŠ¨æ·»åŠ  `CompanyId` è¿‡æ»¤ï¼ˆå› ä¸º `TenantContext.GetCurrentCompanyId()` è¿”å› nullï¼‰ï¼Œæ‰€æœ‰æŸ¥è¯¢ `IMultiTenant` å®ä½“çš„ä»£ç å¿…é¡»æ‰‹åŠ¨æ·»åŠ  `CompanyId` è¿‡æ»¤ï¼š

```csharp
// âœ… æ­£ç¡®ï¼šæ‰‹åŠ¨æ·»åŠ  CompanyId è¿‡æ»¤
public async Task<List<Role>> GetRolesAsync()
{
    // 1. ä»æ•°æ®åº“è·å–ä¼ä¸šID
    var companyId = await GetCurrentCompanyIdAsync();
    
    // 2. æ‰‹åŠ¨æ·»åŠ  CompanyId è¿‡æ»¤
    var filter = _roleFactory.CreateFilterBuilder()
        .Equal(r => r.CompanyId, companyId)  // âœ… æ‰‹åŠ¨æ·»åŠ 
        .Equal(r => r.IsActive, true)
        .Build();
    
    // 3. ä½¿ç”¨ FindWithoutTenantFilterAsyncï¼ˆå› ä¸ºå·²æ‰‹åŠ¨æ·»åŠ äº† CompanyId è¿‡æ»¤ï¼‰
    var roles = await _roleFactory.FindWithoutTenantFilterAsync(filter);
    
    return roles;
}
```

### AppUser æŸ¥è¯¢

`AppUser` ä¸å®ç° `IMultiTenant`ï¼Œå› æ­¤ä¸å—è‡ªåŠ¨ç§Ÿæˆ·è¿‡æ»¤å½±å“ï¼Œä½†ä»éœ€è¦æ‰‹åŠ¨æ·»åŠ  `CurrentCompanyId` è¿‡æ»¤ï¼š

```csharp
// âœ… æ­£ç¡®ï¼šæ‰‹åŠ¨æ·»åŠ  CurrentCompanyId è¿‡æ»¤
public async Task<List<AppUser>> GetUsersAsync()
{
    // 1. ä»æ•°æ®åº“è·å–ä¼ä¸šID
    var companyId = await GetCurrentCompanyIdAsync();
    
    // 2. æ‰‹åŠ¨æ·»åŠ  CurrentCompanyId è¿‡æ»¤
    var filter = _userFactory.CreateFilterBuilder()
        .Equal(u => u.CurrentCompanyId, companyId)  // âœ… æ‰‹åŠ¨æ·»åŠ 
        .Equal(u => u.IsActive, true)
        .Build();
    
    // 3. ä½¿ç”¨ FindAsyncï¼ˆAppUser ä¸å®ç° IMultiTenantï¼Œä¸å—è‡ªåŠ¨è¿‡æ»¤å½±å“ï¼‰
    var users = await _userFactory.FindAsync(filter);
    
    return users;
}
```

## ğŸ¯ å…³é”®å˜æ›´ç‚¹

### 1. JWT Token ç”Ÿæˆ

```csharp
// Platform.ApiService/Services/JwtService.cs
// âš ï¸ å·²ç§»é™¤ï¼šä¸å†åœ¨ JWT token ä¸­åŒ…å« CurrentCompanyId
var claims = new List<Claim>
{
    new("userId", user.Id ?? string.Empty),
    new("username", user.Username)
};
// ä¸å†æ·»åŠ  currentCompanyId å’Œ companyId claim
```

### 2. TenantContext.GetCurrentCompanyId()

```csharp
// Platform.ServiceDefaults/Services/TenantContext.cs
// âš ï¸ æ³¨æ„ï¼šæ­¤æ–¹æ³•ç°åœ¨å§‹ç»ˆè¿”å› nullï¼ˆå› ä¸º JWT token ä¸­æ²¡æœ‰ companyId claimï¼‰
public string? GetCurrentCompanyId()
{
    return _httpContextAccessor.HttpContext?.User?.FindFirst("companyId")?.Value;
    // ç°åœ¨è¿”å› nullï¼Œå› ä¸º JWT token ä¸­å·²ç§»é™¤
}
```

### 3. DatabaseOperationFactory è‡ªåŠ¨ç§Ÿæˆ·è¿‡æ»¤

```csharp
// Platform.ServiceDefaults/Services/DatabaseOperationFactory.cs
// âš ï¸ æ³¨æ„ï¼šæ­¤æ–¹æ³•ä¸å†è‡ªåŠ¨æ·»åŠ  CompanyId è¿‡æ»¤ï¼ˆå› ä¸º GetCurrentCompanyId() è¿”å› nullï¼‰
private FilterDefinition<T> ApplyTenantFilter(FilterDefinition<T> filter)
{
    if (typeof(IMultiTenant).IsAssignableFrom(typeof(T)))
    {
        var companyId = _tenantContext.GetCurrentCompanyId();  // è¿”å› null
        if (!string.IsNullOrEmpty(companyId))
        {
            // è¿™ä¸ªåˆ†æ”¯æ°¸è¿œä¸ä¼šæ‰§è¡Œ
            var companyFilter = Builders<T>.Filter.Eq("CompanyId", companyId);
            return Builders<T>.Filter.And(filter, companyFilter);
        }
    }
    return filter;  // ç›´æ¥è¿”å›åŸ filterï¼Œä¸æ·»åŠ ç§Ÿæˆ·è¿‡æ»¤
}
```

### 4. BaseApiController.GetRequiredCompanyId()

```csharp
// Platform.ServiceDefaults/Controllers/BaseApiController.cs
// âš ï¸ å·²åºŸå¼ƒï¼šåŒæ­¥ç‰ˆæœ¬ä¸å†å·¥ä½œ
[Obsolete("å·²ç§»é™¤ JWT token ä¸­çš„ CurrentCompanyIdï¼Œè¯·ä½¿ç”¨ GetRequiredCompanyIdAsync() æ›¿ä»£")]
protected string GetRequiredCompanyId()
{
    throw new InvalidOperationException("JWT token ä¸­ä¸å†åŒ…å« CurrentCompanyIdï¼Œè¯·ä½¿ç”¨ GetRequiredCompanyIdAsync() æ›¿ä»£");
}

// âœ… æ–°æ–¹æ³•ï¼šå¼‚æ­¥ç‰ˆæœ¬ï¼Œä»æ•°æ®åº“è·å–
protected async Task<string> GetRequiredCompanyIdAsync()
{
    var userId = GetRequiredUserId();
    var userService = HttpContext.RequestServices.GetRequiredService<IDatabaseOperationFactory<AppUser>>();
    var user = await userService.GetByIdAsync(userId);
    if (user == null || string.IsNullOrEmpty(user.CurrentCompanyId))
    {
        throw new UnauthorizedAccessException("æœªæ‰¾åˆ°ä¼ä¸šä¿¡æ¯");
    }
    return user.CurrentCompanyId;
}
```

## ğŸ“‹ ä»£ç å®¡æŸ¥æ£€æŸ¥æ¸…å•

åˆ›å»ºæˆ–ä¿®æ”¹ä»£ç æ—¶æ£€æŸ¥ï¼š

- [ ] **ä¸ä» JWT token è·å–ä¼ä¸šID** - ä¸ä½¿ç”¨ `TenantContext.GetCurrentCompanyId()` æˆ– `GetRequiredCompanyId()`
- [ ] **ä»æ•°æ®åº“è·å–ä¼ä¸šID** - ä½¿ç”¨ `user.CurrentCompanyId` ä»æ•°æ®åº“è·å–
- [ ] **æ‰‹åŠ¨æ·»åŠ  CompanyId è¿‡æ»¤** - æŸ¥è¯¢ `IMultiTenant` å®ä½“æ—¶æ‰‹åŠ¨æ·»åŠ  `CompanyId` è¿‡æ»¤
- [ ] **ä½¿ç”¨ FindWithoutTenantFilterAsync** - å½“å·²æ‰‹åŠ¨æ·»åŠ  `CompanyId` è¿‡æ»¤æ—¶ï¼Œä½¿ç”¨ `FindWithoutTenantFilterAsync` è·³è¿‡è‡ªåŠ¨è¿‡æ»¤
- [ ] **Controller ä½¿ç”¨å¼‚æ­¥æ–¹æ³•** - Controller ä¸­ä½¿ç”¨ `GetRequiredCompanyIdAsync()` è€Œä¸æ˜¯ `GetRequiredCompanyId()`
- [ ] **JWT Token ä¸åŒ…å«ä¼ä¸šID** - ç¡®è®¤ JWT token ç”Ÿæˆæ—¶ä¸æ·»åŠ  `currentCompanyId` æˆ– `companyId` claim

## ğŸ¯ æŸ¥è¯¢æ¨¡å¼

### æ¨¡å¼ 1: æ ‡å‡†æŸ¥è¯¢ï¼ˆIMultiTenant å®ä½“ï¼‰

```csharp
// âœ… æ­£ç¡®æ¨¡å¼
public async Task<List<Role>> GetRolesAsync()
{
    // 1. ä»æ•°æ®åº“è·å–ä¼ä¸šID
    var userId = _roleFactory.GetRequiredUserId();
    var user = await _userFactory.GetByIdAsync(userId);
    var companyId = user?.CurrentCompanyId ?? throw new UnauthorizedAccessException("æœªæ‰¾åˆ°ä¼ä¸šä¿¡æ¯");
    
    // 2. æ„å»ºè¿‡æ»¤å™¨ï¼ˆæ‰‹åŠ¨æ·»åŠ  CompanyIdï¼‰
    var filter = _roleFactory.CreateFilterBuilder()
        .Equal(r => r.CompanyId, companyId)  // âœ… æ‰‹åŠ¨æ·»åŠ 
        .Equal(r => r.IsActive, true)
        .Build();
    
    // 3. ä½¿ç”¨ FindWithoutTenantFilterAsyncï¼ˆè·³è¿‡è‡ªåŠ¨è¿‡æ»¤ï¼‰
    var roles = await _roleFactory.FindWithoutTenantFilterAsync(filter);
    
    return roles;
}
```

### æ¨¡å¼ 2: è·¨ä¼ä¸šæŸ¥è¯¢ï¼ˆç‰¹æ®Šåœºæ™¯ï¼‰

```csharp
// âœ… æ­£ç¡®æ¨¡å¼ï¼šè·¨ä¼ä¸šæŸ¥è¯¢æ—¶æ˜ç¡®æŒ‡å®šå¤šä¸ªä¼ä¸šID
public async Task<List<Role>> GetRolesForCompaniesAsync(List<string> companyIds)
{
    // 1. æ‰‹åŠ¨æ„å»ºè¿‡æ»¤å™¨ï¼ˆä¸ä¾èµ–è‡ªåŠ¨è¿‡æ»¤ï¼‰
    var filter = _roleFactory.CreateFilterBuilder()
        .In(r => r.CompanyId, companyIds)  // âœ… æ‰‹åŠ¨æŒ‡å®šå¤šä¸ªä¼ä¸š
        .Equal(r => r.IsActive, true)
        .Build();
    
    // 2. ä½¿ç”¨ FindWithoutTenantFilterAsync
    var roles = await _roleFactory.FindWithoutTenantFilterAsync(filter);
    
    return roles;
}
```

### æ¨¡å¼ 3: AppUser æŸ¥è¯¢

```csharp
// âœ… æ­£ç¡®æ¨¡å¼ï¼šAppUser ä¸å®ç° IMultiTenant
public async Task<List<AppUser>> GetUsersAsync()
{
    // 1. ä»æ•°æ®åº“è·å–ä¼ä¸šID
    var userId = _userFactory.GetRequiredUserId();
    var currentUser = await _userFactory.GetByIdAsync(userId);
    var companyId = currentUser?.CurrentCompanyId ?? throw new UnauthorizedAccessException("æœªæ‰¾åˆ°ä¼ä¸šä¿¡æ¯");
    
    // 2. æ‰‹åŠ¨æ·»åŠ  CurrentCompanyId è¿‡æ»¤ï¼ˆAppUser ä¸ä½¿ç”¨ CompanyIdï¼‰
    var filter = _userFactory.CreateFilterBuilder()
        .Equal(u => u.CurrentCompanyId, companyId)  // âœ… ä½¿ç”¨ CurrentCompanyId
        .Equal(u => u.IsActive, true)
        .Build();
    
    // 3. ä½¿ç”¨ FindAsyncï¼ˆAppUser ä¸å®ç° IMultiTenantï¼Œä¸å—è‡ªåŠ¨è¿‡æ»¤å½±å“ï¼‰
    var users = await _userFactory.FindAsync(filter);
    
    return users;
}
```

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. è‡ªåŠ¨ç§Ÿæˆ·è¿‡æ»¤å·²å¤±æ•ˆ

`DatabaseOperationFactory.ApplyTenantFilter` ä¸å†è‡ªåŠ¨æ·»åŠ  `CompanyId` è¿‡æ»¤ï¼Œå› ä¸º `TenantContext.GetCurrentCompanyId()` è¿”å› nullã€‚

**å½±å“**ï¼š
- æ‰€æœ‰æŸ¥è¯¢ `IMultiTenant` å®ä½“çš„ä»£ç å¿…é¡»æ‰‹åŠ¨æ·»åŠ  `CompanyId` è¿‡æ»¤
- å¿…é¡»ç¡®ä¿å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»ï¼Œé¿å…è·¨ä¼ä¸šæ•°æ®æ³„éœ²

### 2. æ€§èƒ½è€ƒè™‘

ä»æ•°æ®åº“è·å–ä¼ä¸šIDä¼šå¢åŠ ä¸€æ¬¡æ•°æ®åº“æŸ¥è¯¢ã€‚è€ƒè™‘ï¼š

```csharp
// âœ… åœ¨æ–¹æ³•å¼€å§‹æ—¶è·å–ä¸€æ¬¡ï¼Œé‡å¤ä½¿ç”¨
public async Task<List<Role>> GetRolesAsync()
{
    var companyId = await GetCurrentCompanyIdAsync();  // åªæŸ¥è¯¢ä¸€æ¬¡
    
    // åœ¨åŒä¸€ä¸ªæ–¹æ³•ä¸­é‡å¤ä½¿ç”¨ companyId
    var roles = await GetRolesByCompanyAsync(companyId);
    var stats = await GetRoleStatsAsync(companyId);
    
    return roles;
}
```

### 3. ç¼“å­˜ç­–ç•¥ï¼ˆå¯é€‰ï¼‰

å¦‚æœé¢‘ç¹è®¿é—®ï¼Œå¯ä»¥è€ƒè™‘ç¼“å­˜ï¼š

```csharp
// âœ… å¯é€‰ï¼šç¼“å­˜å½“å‰ç”¨æˆ·çš„ä¼ä¸šIDï¼ˆä½œç”¨åŸŸå†…ï¼‰
private string? _cachedCompanyId;

private async Task<string> GetCurrentCompanyIdAsync()
{
    if (!string.IsNullOrEmpty(_cachedCompanyId))
        return _cachedCompanyId;
    
    var userId = _userFactory.GetRequiredUserId();
    var user = await _userFactory.GetByIdAsync(userId);
    if (user == null || string.IsNullOrEmpty(user.CurrentCompanyId))
    {
        throw new UnauthorizedAccessException("æœªæ‰¾åˆ°å½“å‰ä¼ä¸šä¿¡æ¯");
    }
    
    _cachedCompanyId = user.CurrentCompanyId;
    return _cachedCompanyId;
}
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [JWT CurrentCompanyId ç§»é™¤ä¿®å¤](mdc:docs/bugfixes/JWT-CURRENT-COMPANY-ID-REMOVAL.md)
- [ä¼ä¸šåˆ‡æ¢æƒé™ä¿®å¤](mdc:docs/bugfixes/COMPANY-SWITCH-PERMISSION-FIX.md)
- [å¤šç§Ÿæˆ·å®ä½“å®Œæ•´è®¾è®¡è§„èŒƒ](mdc:.cursor/rules/multi-tenant-entity-design-complete.mdc)
- [BaseApiController](mdc:Platform.ServiceDefaults/Controllers/BaseApiController.cs)
- [JwtService](mdc:Platform.ApiService/Services/JwtService.cs)

## ğŸ¯ è®°ä½

1. **JWT token ä¸åŒ…å«ä¼ä¸šID** - å·²å®Œå…¨ç§»é™¤ `currentCompanyId` å’Œ `companyId` claim
2. **ç»Ÿä¸€ä»æ•°æ®åº“è·å–** - æ‰€æœ‰ä¼ä¸šIDä» `user.CurrentCompanyId` è·å–
3. **æ‰‹åŠ¨æ·»åŠ è¿‡æ»¤** - æŸ¥è¯¢ `IMultiTenant` å®ä½“æ—¶å¿…é¡»æ‰‹åŠ¨æ·»åŠ  `CompanyId` è¿‡æ»¤
4. **ä½¿ç”¨ FindWithoutTenantFilterAsync** - å½“å·²æ‰‹åŠ¨æ·»åŠ è¿‡æ»¤æ—¶ï¼Œè·³è¿‡è‡ªåŠ¨è¿‡æ»¤
5. **å®æ—¶æ€§æ›´å¥½** - ä»æ•°æ®åº“è·å–ç¡®ä¿åˆ‡æ¢ä¼ä¸šåç«‹å³ç”Ÿæ•ˆï¼Œä¸å— JWT token å»¶è¿Ÿå½±å“

éµå¾ªè¿™äº›è§„èŒƒï¼Œç¡®ä¿å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»çš„æ­£ç¡®æ€§å’Œä¸€è‡´æ€§ï¼
