---
globs: Platform.ApiService/Services/*.cs,Platform.ServiceDefaults/Services/*.cs
description: æ—¥å¿—è®°å½•å’Œç›‘æ§è§„èŒƒ
---
# æ—¥å¿—è®°å½•å’Œç›‘æ§è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

### ä½¿ç”¨ç»Ÿä¸€çš„æ—¥å¿—è®°å½•å’Œç›‘æ§æœºåˆ¶ï¼Œç¡®ä¿ç³»ç»Ÿå¯è§‚æµ‹æ€§å’Œé—®é¢˜æ’æŸ¥èƒ½åŠ›

## âœ… æ—¥å¿—è®°å½•æ¶æ„

### æ—¥å¿—æœåŠ¡æ¥å£

```csharp
// Platform.ServiceDefaults/Services/ILoggingService.cs
public interface ILoggingService
{
    void LogInformation(string message, params object[] args);
    void LogWarning(string message, params object[] args);
    void LogError(string message, Exception? exception = null, params object[] args);
    void LogDebug(string message, params object[] args);
    void LogTrace(string message, params object[] args);
    
    void LogOperation(string operation, string? entityId = null, object? data = null);
    void LogSecurityEvent(string eventType, string? userId = null, object? data = null);
    void LogPerformance(string operation, long elapsedMs, object? data = null);
}

public class LoggingService : ILoggingService
{
    private readonly ILogger<LoggingService> _logger;
    private readonly ITenantContext _tenantContext;

    public LoggingService(ILogger<LoggingService> logger, ITenantContext tenantContext)
    {
        _logger = logger;
        _tenantContext = tenantContext;
    }

    public void LogInformation(string message, params object[] args)
    {
        _logger.LogInformation(message, args);
    }

    public void LogWarning(string message, params object[] args)
    {
        _logger.LogWarning(message, args);
    }

    public void LogError(string message, Exception? exception = null, params object[] args)
    {
        if (exception != null)
        {
            _logger.LogError(exception, message, args);
        }
        else
        {
            _logger.LogError(message, args);
        }
    }

    public void LogDebug(string message, params object[] args)
    {
        _logger.LogDebug(message, args);
    }

    public void LogTrace(string message, params object[] args)
    {
        _logger.LogTrace(message, args);
    }

    public void LogOperation(string operation, string? entityId = null, object? data = null)
    {
        var userId = _tenantContext.GetCurrentUserId();
        var username = _tenantContext.GetCurrentUsername();
        var companyId = _tenantContext.GetCurrentCompanyId();

        _logger.LogInformation("æ“ä½œ: {Operation}, ç”¨æˆ·: {UserId}, ç”¨æˆ·å: {Username}, ä¼ä¸š: {CompanyId}, å®ä½“ID: {EntityId}, æ•°æ®: {@Data}",
            operation, userId, username, companyId, entityId, data);
    }

    public void LogSecurityEvent(string eventType, string? userId = null, object? data = null)
    {
        var currentUserId = _tenantContext.GetCurrentUserId();
        var currentUsername = _tenantContext.GetCurrentUsername();
        var companyId = _tenantContext.GetCurrentCompanyId();

        _logger.LogWarning("å®‰å…¨äº‹ä»¶: {EventType}, ç”¨æˆ·: {UserId}, ç”¨æˆ·å: {Username}, ä¼ä¸š: {CompanyId}, ç›®æ ‡ç”¨æˆ·: {TargetUserId}, æ•°æ®: {@Data}",
            eventType, currentUserId, currentUsername, companyId, userId, data);
    }

    public void LogPerformance(string operation, long elapsedMs, object? data = null)
    {
        var userId = _tenantContext.GetCurrentUserId();
        var companyId = _tenantContext.GetCurrentCompanyId();

        _logger.LogInformation("æ€§èƒ½ç›‘æ§: {Operation}, è€—æ—¶: {ElapsedMs}ms, ç”¨æˆ·: {UserId}, ä¼ä¸š: {CompanyId}, æ•°æ®: {@Data}",
            operation, elapsedMs, userId, companyId, data);
    }
}
```

### ç»“æ„åŒ–æ—¥å¿—è®°å½•

```csharp
// Platform.ServiceDefaults/Extensions/StructuredLoggingExtensions.cs
public static class StructuredLoggingExtensions
{
    /// <summary>
    /// è®°å½•ç”¨æˆ·æ“ä½œæ—¥å¿—
    /// </summary>
    public static void LogUserOperation(this ILogger logger, string operation, string userId, string? entityId = null, object? data = null)
    {
        logger.LogInformation("ç”¨æˆ·æ“ä½œ: {Operation}, ç”¨æˆ·ID: {UserId}, å®ä½“ID: {EntityId}, æ•°æ®: {@Data}",
            operation, userId, entityId, data);
    }

    /// <summary>
    /// è®°å½•æ•°æ®åº“æ“ä½œæ—¥å¿—
    /// </summary>
    public static void LogDatabaseOperation(this ILogger logger, string operation, string collection, string? entityId = null, long elapsedMs = 0)
    {
        logger.LogInformation("æ•°æ®åº“æ“ä½œ: {Operation}, é›†åˆ: {Collection}, å®ä½“ID: {EntityId}, è€—æ—¶: {ElapsedMs}ms",
            operation, collection, entityId, elapsedMs);
    }

    /// <summary>
    /// è®°å½•APIè¯·æ±‚æ—¥å¿—
    /// </summary>
    public static void LogApiRequest(this ILogger logger, string method, string path, int statusCode, long elapsedMs, string? userId = null)
    {
        logger.LogInformation("APIè¯·æ±‚: {Method} {Path}, çŠ¶æ€ç : {StatusCode}, è€—æ—¶: {ElapsedMs}ms, ç”¨æˆ·: {UserId}",
            method, path, statusCode, elapsedMs, userId);
    }

    /// <summary>
    /// è®°å½•å®‰å…¨äº‹ä»¶æ—¥å¿—
    /// </summary>
    public static void LogSecurityEvent(this ILogger logger, string eventType, string? userId = null, string? ipAddress = null, object? data = null)
    {
        logger.LogWarning("å®‰å…¨äº‹ä»¶: {EventType}, ç”¨æˆ·: {UserId}, IP: {IpAddress}, æ•°æ®: {@Data}",
            eventType, userId, ipAddress, data);
    }

    /// <summary>
    /// è®°å½•æ€§èƒ½æŒ‡æ ‡æ—¥å¿—
    /// </summary>
    public static void LogPerformanceMetric(this ILogger logger, string metricName, double value, string? unit = null, object? tags = null)
    {
        logger.LogInformation("æ€§èƒ½æŒ‡æ ‡: {MetricName}, å€¼: {Value}, å•ä½: {Unit}, æ ‡ç­¾: {@Tags}",
            metricName, value, unit, tags);
    }
}
```

## ğŸ¯ æœåŠ¡å±‚æ—¥å¿—è®°å½•

### ç”¨æˆ·æœåŠ¡æ—¥å¿—è®°å½•

```csharp
// âœ… æ­£ç¡® - å®Œæ•´çš„æ—¥å¿—è®°å½•
public class UserService : IUserService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    private readonly ILoggingService _loggingService;
    private readonly ILogger<UserService> _logger;

    public UserService(
        IDatabaseOperationFactory<User> userFactory,
        ILoggingService loggingService,
        ILogger<UserService> logger)
    {
        _userFactory = userFactory;
        _loggingService = loggingService;
        _logger = logger;
    }

    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        var stopwatch = Stopwatch.StartNew();
        
        try
        {
            _logger.LogInformation("å¼€å§‹åˆ›å»ºç”¨æˆ·: {Username}, é‚®ç®±: {Email}", request.Username, request.Email);
            
            // 1. å‚æ•°éªŒè¯
            if (request == null)
                throw new ArgumentNullException(nameof(request));

            // 2. ä¸šåŠ¡éªŒè¯
            await ValidateCreateUserRequestAsync(request);
            
            // 3. æ£€æŸ¥å”¯ä¸€æ€§
            await _uniquenessChecker.EnsureUniqueAsync<User>(u => u.Username, request.Username);
            await _uniquenessChecker.EnsureUniqueAsync<User>(u => u.Email, request.Email);
            
            // 4. åˆ›å»ºç”¨æˆ·å®ä½“
            var user = new User
            {
                Username = request.Username.Trim(),
                Email = request.Email.Trim().ToLowerInvariant(),
                CompanyId = _userFactory.GetRequiredCompanyId(),
                CreatedBy = _userFactory.GetCurrentUserId(),
                CreatedAt = DateTime.UtcNow
            };
            
            var createdUser = await _userFactory.CreateAsync(user);
            
            // 5. è®°å½•æ“ä½œæ—¥å¿—
            _loggingService.LogOperation("åˆ›å»ºç”¨æˆ·", createdUser.Id, new { 
                Username = request.Username, 
                Email = request.Email 
            });
            
            var elapsed = stopwatch.ElapsedMilliseconds;
            _loggingService.LogPerformance("åˆ›å»ºç”¨æˆ·", elapsed, new { 
                Username = request.Username, 
                UserId = createdUser.Id 
            });
            
            _logger.LogInformation("ç”¨æˆ·åˆ›å»ºæˆåŠŸ: {UserId}, ç”¨æˆ·å: {Username}, è€—æ—¶: {ElapsedMs}ms", 
                createdUser.Id, createdUser.Username, elapsed);
            
            return createdUser;
        }
        catch (ArgumentException ex)
        {
            var elapsed = stopwatch.ElapsedMilliseconds;
            _logger.LogWarning(ex, "ç”¨æˆ·åˆ›å»ºå‚æ•°é”™è¯¯: {Username}, è€—æ—¶: {ElapsedMs}ms", 
                request?.Username, elapsed);
            throw;
        }
        catch (InvalidOperationException ex)
        {
            var elapsed = stopwatch.ElapsedMilliseconds;
            _logger.LogWarning(ex, "ç”¨æˆ·åˆ›å»ºä¸šåŠ¡é”™è¯¯: {Username}, è€—æ—¶: {ElapsedMs}ms", 
                request?.Username, elapsed);
            throw;
        }
        catch (Exception ex)
        {
            var elapsed = stopwatch.ElapsedMilliseconds;
            _logger.LogError(ex, "ç”¨æˆ·åˆ›å»ºå¤±è´¥: {Username}, è€—æ—¶: {ElapsedMs}ms", 
                request?.Username, elapsed);
            throw new InvalidOperationException("ç”¨æˆ·åˆ›å»ºå¤±è´¥", ex);
        }
    }

    public async Task<User?> GetUserByIdAsync(string id)
    {
        var stopwatch = Stopwatch.StartNew();
        
        try
        {
            _logger.LogDebug("å¼€å§‹è·å–ç”¨æˆ·: {UserId}", id);
            
            if (string.IsNullOrEmpty(id))
                throw new ArgumentException("ç”¨æˆ·IDä¸èƒ½ä¸ºç©º", nameof(id));

            var user = await _userFactory.GetByIdAsync(id);
            if (user == null)
            {
                var elapsed = stopwatch.ElapsedMilliseconds;
                _logger.LogWarning("ç”¨æˆ·ä¸å­˜åœ¨: {UserId}, è€—æ—¶: {ElapsedMs}ms", id, elapsed);
                throw new KeyNotFoundException($"ç”¨æˆ· {id} ä¸å­˜åœ¨");
            }

            var elapsed = stopwatch.ElapsedMilliseconds;
            _logger.LogDebug("ç”¨æˆ·è·å–æˆåŠŸ: {UserId}, ç”¨æˆ·å: {Username}, è€—æ—¶: {ElapsedMs}ms", 
                user.Id, user.Username, elapsed);
            
            return user;
        }
        catch (ArgumentException)
        {
            throw;
        }
        catch (KeyNotFoundException)
        {
            throw;
        }
        catch (Exception ex)
        {
            var elapsed = stopwatch.ElapsedMilliseconds;
            _logger.LogError(ex, "è·å–ç”¨æˆ·å¤±è´¥: {UserId}, è€—æ—¶: {ElapsedMs}ms", id, elapsed);
            throw new InvalidOperationException("è·å–ç”¨æˆ·å¤±è´¥", ex);
        }
    }

    public async Task<bool> UpdateUserAsync(UpdateUserRequest request)
    {
        var stopwatch = Stopwatch.StartNew();
        
        try
        {
            _logger.LogInformation("å¼€å§‹æ›´æ–°ç”¨æˆ·: {UserId}", request.Id);
            
            // 1. å‚æ•°éªŒè¯
            if (request == null)
                throw new ArgumentNullException(nameof(request));

            if (string.IsNullOrEmpty(request.Id))
                throw new ArgumentException("ç”¨æˆ·IDä¸èƒ½ä¸ºç©º", nameof(request.Id));

            // 2. è·å–ç°æœ‰ç”¨æˆ·
            var existingUser = await _userFactory.GetByIdAsync(request.Id);
            if (existingUser == null)
            {
                var elapsed = stopwatch.ElapsedMilliseconds;
                _logger.LogWarning("ç”¨æˆ·ä¸å­˜åœ¨: {UserId}, è€—æ—¶: {ElapsedMs}ms", request.Id, elapsed);
                throw new KeyNotFoundException($"ç”¨æˆ· {request.Id} ä¸å­˜åœ¨");
            }

            // 3. ä¸šåŠ¡éªŒè¯
            await ValidateUpdateUserRequestAsync(request, existingUser);
            
            // 4. æ£€æŸ¥å”¯ä¸€æ€§ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if (!string.IsNullOrEmpty(request.Username) && request.Username != existingUser.Username)
            {
                await _uniquenessChecker.EnsureUniqueAsync<User>(u => u.Username, request.Username);
            }
            
            if (!string.IsNullOrEmpty(request.Email) && request.Email != existingUser.Email)
            {
                await _uniquenessChecker.EnsureUniqueAsync<User>(u => u.Email, request.Email);
            }

            // 5. æ„å»ºæ›´æ–°æ“ä½œ
            var update = _userFactory.CreateUpdateBuilder()
                .SetCurrentTimestamp()
                .SetOperationTracking(_userFactory.GetCurrentUserId(), _userFactory.GetCurrentUsername())
                .Build();

            if (!string.IsNullOrEmpty(request.Username))
            {
                update = _userFactory.CreateUpdateBuilder()
                    .Set(u => u.Username, request.Username)
                    .SetCurrentTimestamp()
                    .SetOperationTracking(_userFactory.GetCurrentUserId(), _userFactory.GetCurrentUsername())
                    .Build();
            }

            if (!string.IsNullOrEmpty(request.Email))
            {
                update = _userFactory.CreateUpdateBuilder()
                    .Set(u => u.Email, request.Email)
                    .SetCurrentTimestamp()
                    .SetOperationTracking(_userFactory.GetCurrentUserId(), _userFactory.GetCurrentUsername())
                    .Build();
            }

            // 6. æ‰§è¡Œæ›´æ–°
            var result = await _userFactory.UpdateAsync(existingUser, new OperationContext
            {
                UserId = _userFactory.GetCurrentUserId(),
                Username = _userFactory.GetCurrentUsername(),
                CompanyId = _userFactory.GetCurrentCompanyId(),
                OperationType = OperationType.Update,
                Description = "æ›´æ–°ç”¨æˆ·ä¿¡æ¯"
            });

            if (result)
            {
                // 7. è®°å½•æ“ä½œæ—¥å¿—
                _loggingService.LogOperation("æ›´æ–°ç”¨æˆ·", request.Id, new { 
                    Username = request.Username, 
                    Email = request.Email 
                });
                
                var elapsed = stopwatch.ElapsedMilliseconds;
                _loggingService.LogPerformance("æ›´æ–°ç”¨æˆ·", elapsed, new { 
                    UserId = request.Id, 
                    Username = request.Username 
                });
                
                _logger.LogInformation("ç”¨æˆ·æ›´æ–°æˆåŠŸ: {UserId}, è€—æ—¶: {ElapsedMs}ms", request.Id, elapsed);
            }
            else
            {
                var elapsed = stopwatch.ElapsedMilliseconds;
                _logger.LogWarning("ç”¨æˆ·æ›´æ–°å¤±è´¥: {UserId}, è€—æ—¶: {ElapsedMs}ms", request.Id, elapsed);
            }

            return result;
        }
        catch (ArgumentException)
        {
            throw;
        }
        catch (KeyNotFoundException)
        {
            throw;
        }
        catch (InvalidOperationException)
        {
            throw;
        }
        catch (Exception ex)
        {
            var elapsed = stopwatch.ElapsedMilliseconds;
            _logger.LogError(ex, "ç”¨æˆ·æ›´æ–°å¤±è´¥: {UserId}, è€—æ—¶: {ElapsedMs}ms", request?.Id, elapsed);
            throw new InvalidOperationException("ç”¨æˆ·æ›´æ–°å¤±è´¥", ex);
        }
    }

    public async Task<bool> DeleteUserAsync(string id)
    {
        var stopwatch = Stopwatch.StartNew();
        
        try
        {
            _logger.LogInformation("å¼€å§‹åˆ é™¤ç”¨æˆ·: {UserId}", id);
            
            if (string.IsNullOrEmpty(id))
                throw new ArgumentException("ç”¨æˆ·IDä¸èƒ½ä¸ºç©º", nameof(id));

            // 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
            var user = await _userFactory.GetByIdAsync(id);
            if (user == null)
            {
                var elapsed = stopwatch.ElapsedMilliseconds;
                _logger.LogWarning("ç”¨æˆ·ä¸å­˜åœ¨: {UserId}, è€—æ—¶: {ElapsedMs}ms", id, elapsed);
                throw new KeyNotFoundException($"ç”¨æˆ· {id} ä¸å­˜åœ¨");
            }

            // 2. ä¸šåŠ¡è§„åˆ™æ£€æŸ¥
            await ValidateUserDeletionAsync(user);

            // 3. æ‰§è¡Œè½¯åˆ é™¤
            var result = await _userFactory.SoftDeleteAsync(id, new OperationContext
            {
                UserId = _userFactory.GetCurrentUserId(),
                Username = _userFactory.GetCurrentUsername(),
                CompanyId = _userFactory.GetCurrentCompanyId(),
                OperationType = OperationType.Delete,
                Description = "åˆ é™¤ç”¨æˆ·"
            });

            if (result)
            {
                // 4. è®°å½•æ“ä½œæ—¥å¿—
                _loggingService.LogOperation("åˆ é™¤ç”¨æˆ·", id, new { 
                    Username = user.Username, 
                    Email = user.Email 
                });
                
                var elapsed = stopwatch.ElapsedMilliseconds;
                _loggingService.LogPerformance("åˆ é™¤ç”¨æˆ·", elapsed, new { 
                    UserId = id, 
                    Username = user.Username 
                });
                
                _logger.LogInformation("ç”¨æˆ·åˆ é™¤æˆåŠŸ: {UserId}, ç”¨æˆ·å: {Username}, è€—æ—¶: {ElapsedMs}ms", 
                    id, user.Username, elapsed);
            }
            else
            {
                var elapsed = stopwatch.ElapsedMilliseconds;
                _logger.LogWarning("ç”¨æˆ·åˆ é™¤å¤±è´¥: {UserId}, è€—æ—¶: {ElapsedMs}ms", id, elapsed);
            }

            return result;
        }
        catch (ArgumentException)
        {
            throw;
        }
        catch (KeyNotFoundException)
        {
            throw;
        }
        catch (InvalidOperationException)
        {
            throw;
        }
        catch (Exception ex)
        {
            var elapsed = stopwatch.ElapsedMilliseconds;
            _logger.LogError(ex, "ç”¨æˆ·åˆ é™¤å¤±è´¥: {UserId}, è€—æ—¶: {ElapsedMs}ms", id, elapsed);
            throw new InvalidOperationException("ç”¨æˆ·åˆ é™¤å¤±è´¥", ex);
        }
    }

    private async Task ValidateCreateUserRequestAsync(CreateUserRequest request)
    {
        if (string.IsNullOrEmpty(request.Username))
            throw new ArgumentException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º", nameof(request.Username));

        if (request.Username.Length < 3 || request.Username.Length > 50)
            throw new ArgumentException("ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¸ªå­—ç¬¦ä¹‹é—´", nameof(request.Username));

        if (!IsValidUsername(request.Username))
            throw new ArgumentException("ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿", nameof(request.Username));

        if (string.IsNullOrEmpty(request.Email))
            throw new ArgumentException("é‚®ç®±ä¸èƒ½ä¸ºç©º", nameof(request.Email));

        if (!IsValidEmail(request.Email))
            throw new ArgumentException("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®", nameof(request.Email));

        if (string.IsNullOrEmpty(request.Password))
            throw new ArgumentException("å¯†ç ä¸èƒ½ä¸ºç©º", nameof(request.Password));

        if (!IsStrongPassword(request.Password))
            throw new ArgumentException("å¯†ç å¿…é¡»åŒ…å«å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦ï¼Œé•¿åº¦è‡³å°‘8ä½", nameof(request.Password));
    }

    private async Task ValidateUpdateUserRequestAsync(UpdateUserRequest request, User existingUser)
    {
        if (string.IsNullOrEmpty(request.Username) && string.IsNullOrEmpty(request.Email))
            throw new ArgumentException("è‡³å°‘éœ€è¦æ›´æ–°ä¸€ä¸ªå­—æ®µ");

        if (!string.IsNullOrEmpty(request.Username))
        {
            if (request.Username.Length < 3 || request.Username.Length > 50)
                throw new ArgumentException("ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¸ªå­—ç¬¦ä¹‹é—´");

            if (!IsValidUsername(request.Username))
                throw new ArgumentException("ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿");
        }

        if (!string.IsNullOrEmpty(request.Email))
        {
            if (!IsValidEmail(request.Email))
                throw new ArgumentException("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®");
        }
    }

    private async Task ValidateUserDeletionAsync(User user)
    {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰å…³è”æ•°æ®
        var hasActivityLogs = await _activityLogs.CountDocumentsAsync(
            Builders<UserActivityLog>.Filter.Eq(al => al.UserId, user.Id)
        ) > 0;

        if (hasActivityLogs)
        {
            throw new InvalidOperationException("ç”¨æˆ·æœ‰æ´»åŠ¨è®°å½•ï¼Œæ— æ³•åˆ é™¤");
        }

        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ä¼ä¸šç®¡ç†å‘˜
        var isAdmin = await _userCompanies.CountDocumentsAsync(
            Builders<UserCompany>.Filter.And(
                Builders<UserCompany>.Filter.Eq(uc => uc.UserId, user.Id),
                Builders<UserCompany>.Filter.Eq(uc => uc.IsAdmin, true)
            )
        ) > 0;

        if (isAdmin)
        {
            throw new InvalidOperationException("ä¼ä¸šç®¡ç†å‘˜æ— æ³•åˆ é™¤");
        }
    }

    private bool IsValidUsername(string username)
    {
        return username.All(c => char.IsLetterOrDigit(c) || c == '_');
    }

    private bool IsValidEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }

    private bool IsStrongPassword(string password)
    {
        if (string.IsNullOrEmpty(password) || password.Length < 8)
            return false;

        var hasLetter = password.Any(char.IsLetter);
        var hasDigit = password.Any(char.IsDigit);
        var hasSpecialChar = password.Any(c => !char.IsLetterOrDigit(c));

        return hasLetter && hasDigit && hasSpecialChar;
    }
}

// âŒ é”™è¯¯ - æ²¡æœ‰æ—¥å¿—è®°å½•
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // æ²¡æœ‰æ—¥å¿—è®°å½•
        var user = new User
        {
            Username = request.Username,
            Email = request.Email
        };
        
        return await _userFactory.CreateAsync(user);
    }
}
```

## ğŸ¯ ç›‘æ§å’ŒæŒ‡æ ‡

### æ€§èƒ½ç›‘æ§

```csharp
// Platform.ServiceDefaults/Services/PerformanceMonitoringService.cs
public interface IPerformanceMonitoringService
{
    void RecordOperationDuration(string operation, long elapsedMs);
    void RecordDatabaseOperation(string operation, string collection, long elapsedMs);
    void RecordApiRequest(string method, string path, int statusCode, long elapsedMs);
    void RecordCustomMetric(string metricName, double value, string? unit = null);
}

public class PerformanceMonitoringService : IPerformanceMonitoringService
{
    private readonly ILogger<PerformanceMonitoringService> _logger;
    private readonly IMetrics _metrics;

    public PerformanceMonitoringService(ILogger<PerformanceMonitoringService> logger, IMetrics metrics)
    {
        _logger = logger;
        _metrics = metrics;
    }

    public void RecordOperationDuration(string operation, long elapsedMs)
    {
        _metrics.Timer($"operation.{operation}.duration").Record(elapsedMs);
        _logger.LogPerformanceMetric($"operation.{operation}.duration", elapsedMs, "ms");
    }

    public void RecordDatabaseOperation(string operation, string collection, long elapsedMs)
    {
        _metrics.Timer($"database.{operation}.duration").Record(elapsedMs);
        _metrics.Counter($"database.{operation}.count").Increment();
        _logger.LogPerformanceMetric($"database.{operation}.duration", elapsedMs, "ms", new { Collection = collection });
    }

    public void RecordApiRequest(string method, string path, int statusCode, long elapsedMs)
    {
        _metrics.Timer($"api.request.duration").Record(elapsedMs);
        _metrics.Counter($"api.request.count").Increment();
        _metrics.Counter($"api.request.status.{statusCode}").Increment();
        _logger.LogPerformanceMetric("api.request.duration", elapsedMs, "ms", new { Method = method, Path = path, StatusCode = statusCode });
    }

    public void RecordCustomMetric(string metricName, double value, string? unit = null)
    {
        _metrics.Gauge(metricName).SetValue(value);
        _logger.LogPerformanceMetric(metricName, value, unit);
    }
}
```

### å¥åº·æ£€æŸ¥

```csharp
// Platform.ApiService/HealthChecks/UserServiceHealthCheck.cs
public class UserServiceHealthCheck : IHealthCheck
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    private readonly ILogger<UserServiceHealthCheck> _logger;

    public UserServiceHealthCheck(
        IDatabaseOperationFactory<User> userFactory,
        ILogger<UserServiceHealthCheck> logger)
    {
        _userFactory = userFactory;
        _logger = logger;
    }

    public async Task<HealthCheckResult> CheckHealthAsync(HealthCheckContext context, CancellationToken cancellationToken = default)
    {
        try
        {
            var stopwatch = Stopwatch.StartNew();
            
            // 1. æ£€æŸ¥æ•°æ®åº“è¿æ¥
            var userCount = await _userFactory.CountAsync();
            
            // 2. æ£€æŸ¥æ€§èƒ½æŒ‡æ ‡
            var testUser = await _userFactory.FindAsync(null, null, 1);
            var elapsed = stopwatch.ElapsedMilliseconds;
            
            // 3. è¯„ä¼°å¥åº·çŠ¶æ€
            if (elapsed > 1000) // è¶…è¿‡1ç§’è®¤ä¸ºä¸å¥åº·
            {
                _logger.LogWarning("ç”¨æˆ·æœåŠ¡å“åº”ç¼“æ…¢: {ElapsedMs}ms", elapsed);
                return HealthCheckResult.Unhealthy($"ç”¨æˆ·æœåŠ¡å“åº”ç¼“æ…¢: {elapsed}ms");
            }
            
            if (userCount < 0)
            {
                _logger.LogError("ç”¨æˆ·æ•°é‡å¼‚å¸¸: {UserCount}", userCount);
                return HealthCheckResult.Unhealthy("ç”¨æˆ·æ•°é‡å¼‚å¸¸");
            }
            
            _logger.LogInformation("ç”¨æˆ·æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡: {UserCount}ä¸ªç”¨æˆ·, å“åº”æ—¶é—´: {ElapsedMs}ms", userCount, elapsed);
            return HealthCheckResult.Healthy($"ç”¨æˆ·æœåŠ¡æ­£å¸¸: {userCount}ä¸ªç”¨æˆ·, å“åº”æ—¶é—´: {elapsed}ms");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "ç”¨æˆ·æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥");
            return HealthCheckResult.Unhealthy("ç”¨æˆ·æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥", ex);
        }
    }
}
```

## ğŸš« ç¦æ­¢çš„åšæ³•

### ä¸è¦å¿½ç•¥æ—¥å¿—è®°å½•

```csharp
// âŒ é”™è¯¯ - å¿½ç•¥æ—¥å¿—è®°å½•
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // æ²¡æœ‰æ—¥å¿—è®°å½•
        var user = new User
        {
            Username = request.Username,
            Email = request.Email
        };
        
        return await _userFactory.CreateAsync(user);
    }
}

// âœ… æ­£ç¡® - å®Œæ•´çš„æ—¥å¿—è®°å½•
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        var stopwatch = Stopwatch.StartNew();
        
        try
        {
            _logger.LogInformation("å¼€å§‹åˆ›å»ºç”¨æˆ·: {Username}", request.Username);
            
            var user = new User
            {
                Username = request.Username,
                Email = request.Email
            };
            
            var result = await _userFactory.CreateAsync(user);
            
            var elapsed = stopwatch.ElapsedMilliseconds;
            _logger.LogInformation("ç”¨æˆ·åˆ›å»ºæˆåŠŸ: {UserId}, è€—æ—¶: {ElapsedMs}ms", result.Id, elapsed);
            
            return result;
        }
        catch (Exception ex)
        {
            var elapsed = stopwatch.ElapsedMilliseconds;
            _logger.LogError(ex, "ç”¨æˆ·åˆ›å»ºå¤±è´¥: {Username}, è€—æ—¶: {ElapsedMs}ms", request?.Username, elapsed);
            throw;
        }
    }
}
```

### ä¸è¦ç¡¬ç¼–ç æ—¥å¿—æ¶ˆæ¯

```csharp
// âŒ é”™è¯¯ - ç¡¬ç¼–ç æ—¥å¿—æ¶ˆæ¯
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        _logger.LogInformation("å¼€å§‹åˆ›å»ºç”¨æˆ·: " + request.Username); // ç¡¬ç¼–ç 
        // ...
    }
}

// âœ… æ­£ç¡® - ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        _logger.LogInformation("å¼€å§‹åˆ›å»ºç”¨æˆ·: {Username}", request.Username); // ç»“æ„åŒ–
        // ...
    }
}
```

### ä¸è¦å¿½ç•¥æ€§èƒ½ç›‘æ§

```csharp
// âŒ é”™è¯¯ - å¿½ç•¥æ€§èƒ½ç›‘æ§
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // æ²¡æœ‰æ€§èƒ½ç›‘æ§
        var user = new User
        {
            Username = request.Username,
            Email = request.Email
        };
        
        return await _userFactory.CreateAsync(user);
    }
}

// âœ… æ­£ç¡® - å®Œæ•´çš„æ€§èƒ½ç›‘æ§
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        var stopwatch = Stopwatch.StartNew();
        
        try
        {
            var user = new User
            {
                Username = request.Username,
                Email = request.Email
            };
            
            var result = await _userFactory.CreateAsync(user);
            
            var elapsed = stopwatch.ElapsedMilliseconds;
            _performanceMonitoring.RecordOperationDuration("CreateUser", elapsed);
            
            return result;
        }
        catch (Exception ex)
        {
            var elapsed = stopwatch.ElapsedMilliseconds;
            _performanceMonitoring.RecordOperationDuration("CreateUser", elapsed);
            throw;
        }
    }
}
```

## ğŸ“‹ æ—¥å¿—è®°å½•æ£€æŸ¥æ¸…å•

åˆ›å»ºæˆ–ä¿®æ”¹æœåŠ¡æ—¶æ£€æŸ¥ï¼š

- [ ] ä½¿ç”¨ç»Ÿä¸€çš„æ—¥å¿—æœåŠ¡
- [ ] è®°å½•æ“ä½œå¼€å§‹å’Œç»“æŸ
- [ ] è®°å½•æ€§èƒ½æŒ‡æ ‡
- [ ] è®°å½•é”™è¯¯å’Œå¼‚å¸¸
- [ ] ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—
- [ ] é¿å…ç¡¬ç¼–ç æ—¥å¿—æ¶ˆæ¯
- [ ] è®°å½•å®‰å…¨äº‹ä»¶
- [ ] é…ç½®æ—¥å¿—çº§åˆ«
- [ ] æ·»åŠ æ€§èƒ½ç›‘æ§
- [ ] å®ç°å¥åº·æ£€æŸ¥

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç”¨æˆ·æœåŠ¡å®ç°](mdc:Platform.ApiService/Services/UserService.cs)
- [è§’è‰²æœåŠ¡å®ç°](mdc:Platform.ApiService/Services/RoleService.cs)
- [ä¼ä¸šæœåŠ¡å®ç°](mdc:Platform.ApiService/Services/CompanyService.cs)
- [æ—¥å¿—è®°å½•æœåŠ¡](mdc:Platform.ServiceDefaults/Services/ILoggingService.cs)
