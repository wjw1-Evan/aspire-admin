---
globs: Platform.ApiService/**/*.cs,Platform.Admin/src/**/*.ts,Platform.App/**/*.ts
description: æ—¥å¿—è®°å½•å’Œç›‘æ§è§„èŒƒ
---

# æ—¥å¿—è®°å½•å’Œç›‘æ§è§„èŒƒ

## ğŸ¯ æ¦‚è¿°

åŸºäº .NET å†…ç½®æ—¥å¿—æ¡†æ¶å’Œç»“æ„åŒ–æ—¥å¿—ï¼Œæä¾›ç»Ÿä¸€çš„æ—¥å¿—è®°å½•å’Œç›‘æ§è§„èŒƒã€‚

## ğŸ—ï¸ æ—¥å¿—æ¶æ„

### æ—¥å¿—çº§åˆ«ä½¿ç”¨

```csharp
// âœ… æ­£ç¡®çš„æ—¥å¿—çº§åˆ«ä½¿ç”¨
_logger.LogTrace("è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼Œä»…åœ¨å¼€å‘ç¯å¢ƒä½¿ç”¨");
_logger.LogDebug("è°ƒè¯•ä¿¡æ¯ï¼Œç”¨äºè¯Šæ–­é—®é¢˜");
_logger.LogInformation("ä¸€èˆ¬ä¿¡æ¯ï¼Œè®°å½•ä¸šåŠ¡æµç¨‹");
_logger.LogWarning("è­¦å‘Šä¿¡æ¯ï¼Œå¯èƒ½çš„é—®é¢˜ä½†ä¸å½±å“åŠŸèƒ½");
_logger.LogError("é”™è¯¯ä¿¡æ¯ï¼ŒåŠŸèƒ½å—å½±å“ä½†ç³»ç»Ÿå¯ç»§ç»­è¿è¡Œ");
_logger.LogCritical("ä¸¥é‡é”™è¯¯ï¼Œç³»ç»Ÿå¯èƒ½æ— æ³•ç»§ç»­è¿è¡Œ");
```

### ç»“æ„åŒ–æ—¥å¿—

```csharp
// âœ… ç»“æ„åŒ–æ—¥å¿—è®°å½•
_logger.LogInformation(
    "User {UserId} created {EntityType} {EntityId} at {Timestamp}",
    userId,
    entityType,
    entityId,
    DateTime.UtcNow);

// âœ… ä½¿ç”¨ä½œç”¨åŸŸ
using (_logger.BeginScope(new Dictionary<string, object>
{
    ["UserId"] = userId,
    ["RequestId"] = requestId
}))
{
    _logger.LogInformation("Processing user request");
    // æ‰€æœ‰æ—¥å¿—éƒ½ä¼šåŒ…å« UserId å’Œ RequestId
}
```

## âœ… æ¨èåšæ³•

### 1. æ§åˆ¶å™¨æ—¥å¿—è®°å½•

```csharp
// âœ… æ§åˆ¶å™¨æ—¥å¿—è®°å½•
[ApiController]
[Route("api/[controller]")]
public class UserController : BaseApiController
{
    private readonly ILogger<UserController> _logger;
    private readonly IUserService _userService;

    [HttpGet("{id}")]
    public async Task<IActionResult> GetUser(string id)
    {
        _logger.LogInformation("Getting user {UserId}", id);
        
        try
        {
            var user = await _userService.GetUserByIdAsync(id);
            if (user == null)
            {
                _logger.LogWarning("User {UserId} not found", id);
                throw new KeyNotFoundException($"ç”¨æˆ· {id} ä¸å­˜åœ¨");
            }
            
            _logger.LogInformation("Successfully retrieved user {UserId}", id);
            return Success(user);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to get user {UserId}", id);
            throw;
        }
    }
}
```

### 2. æœåŠ¡å±‚æ—¥å¿—è®°å½•

```csharp
// âœ… æœåŠ¡å±‚æ—¥å¿—è®°å½•
public class UserService : IUserService
{
    private readonly ILogger<UserService> _logger;
    private readonly IUserRepository _userRepository;

    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        _logger.LogInformation("Creating user with email {Email}", request.Email);
        
        // éªŒè¯ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
        var existingUser = await _userRepository.GetByEmailAsync(request.Email);
        if (existingUser != null)
        {
            _logger.LogWarning("User with email {Email} already exists", request.Email);
            throw new InvalidOperationException("ç”¨æˆ·å·²å­˜åœ¨");
        }

        var user = new User
        {
            Email = request.Email,
            Username = request.Username,
            CreatedAt = DateTime.UtcNow
        };

        await _userRepository.CreateAsync(user);
        
        _logger.LogInformation("Successfully created user {UserId} with email {Email}", 
            user.Id, user.Email);
        
        return user;
    }
}
```

### 3. ä¸­é—´ä»¶æ—¥å¿—è®°å½•

```csharp
// âœ… ä¸­é—´ä»¶æ—¥å¿—è®°å½•
public class ActivityLogMiddleware
{
    private readonly ILogger<ActivityLogMiddleware> _logger;

    public async Task InvokeAsync(HttpContext context, IUserActivityLogService logService)
    {
        var stopwatch = Stopwatch.StartNew();
        var requestId = context.TraceIdentifier;
        
        using (_logger.BeginScope(new Dictionary<string, object>
        {
            ["RequestId"] = requestId,
            ["Method"] = context.Request.Method,
            ["Path"] = context.Request.Path
        }))
        {
            _logger.LogDebug("Processing request {RequestId}", requestId);
            
            try
            {
                await _next(context);
                _logger.LogInformation("Request {RequestId} completed in {ElapsedMs}ms", 
                    requestId, stopwatch.ElapsedMilliseconds);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Request {RequestId} failed after {ElapsedMs}ms", 
                    requestId, stopwatch.ElapsedMilliseconds);
                throw;
            }
        }
    }
}
```

### 4. å‰ç«¯æ—¥å¿—è®°å½•

```typescript
// âœ… å‰ç«¯æ—¥å¿—è®°å½•
class Logger {
  private static instance: Logger;
  private logLevel: LogLevel = LogLevel.INFO;

  static getInstance(): Logger {
    if (!Logger.instance) {
      Logger.instance = new Logger();
    }
    return Logger.instance;
  }

  debug(message: string, data?: any): void {
    if (this.logLevel <= LogLevel.DEBUG) {
      console.debug(`[DEBUG] ${message}`, data);
    }
  }

  info(message: string, data?: any): void {
    if (this.logLevel <= LogLevel.INFO) {
      console.info(`[INFO] ${message}`, data);
    }
  }

  warn(message: string, data?: any): void {
    if (this.logLevel <= LogLevel.WARN) {
      console.warn(`[WARN] ${message}`, data);
    }
  }

  error(message: string, error?: Error, data?: any): void {
    console.error(`[ERROR] ${message}`, error, data);
    
    // å‘é€é”™è¯¯åˆ°ç›‘æ§æœåŠ¡
    this.sendToMonitoring('error', message, error, data);
  }

  private sendToMonitoring(level: string, message: string, error?: Error, data?: any): void {
    // å‘é€åˆ°ç›‘æ§æœåŠ¡ï¼ˆå¦‚ Sentryã€LogRocket ç­‰ï¼‰
    if (window.gtag) {
      window.gtag('event', 'exception', {
        description: message,
        fatal: level === 'error'
      });
    }
  }
}
```

### 5. æ€§èƒ½ç›‘æ§

```csharp
// âœ… æ€§èƒ½ç›‘æ§
public class PerformanceMonitoringService
{
    private readonly ILogger<PerformanceMonitoringService> _logger;
    private readonly IMemoryCache _cache;

    public async Task<T> ExecuteWithMonitoring<T>(
        string operationName,
        Func<Task<T>> operation)
    {
        var stopwatch = Stopwatch.StartNew();
        
        try
        {
            var result = await operation();
            
            _logger.LogInformation(
                "Operation {OperationName} completed successfully in {ElapsedMs}ms",
                operationName, stopwatch.ElapsedMilliseconds);
            
            return result;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex,
                "Operation {OperationName} failed after {ElapsedMs}ms",
                operationName, stopwatch.ElapsedMilliseconds);
            throw;
        }
    }
}
```

## âŒ é¿å…çš„åšæ³•

### 1. ä¸è¦è®°å½•æ•æ„Ÿä¿¡æ¯

```csharp
// âŒ é”™è¯¯ï¼šè®°å½•æ•æ„Ÿä¿¡æ¯
_logger.LogInformation("User {UserId} logged in with password {Password}", 
    userId, password);

// âœ… æ­£ç¡®ï¼šä¸è®°å½•æ•æ„Ÿä¿¡æ¯
_logger.LogInformation("User {UserId} logged in successfully", userId);
```

### 2. ä¸è¦è¿‡åº¦è®°å½•

```csharp
// âŒ é”™è¯¯ï¼šè¿‡åº¦è®°å½•
public async Task<User> GetUser(string id)
{
    _logger.LogDebug("Starting GetUser method");
    _logger.LogDebug("Parameter id: {Id}", id);
    _logger.LogDebug("Calling repository method");
    var user = await _repository.GetByIdAsync(id);
    _logger.LogDebug("Repository method completed");
    _logger.LogDebug("Returning user: {User}", user);
    return user;
}

// âœ… æ­£ç¡®ï¼šé€‚åº¦è®°å½•
public async Task<User> GetUser(string id)
{
    _logger.LogInformation("Getting user {UserId}", id);
    var user = await _repository.GetByIdAsync(id);
    return user;
}
```

### 3. ä¸è¦å¿½ç•¥å¼‚å¸¸æ—¥å¿—

```csharp
// âŒ é”™è¯¯ï¼šå¿½ç•¥å¼‚å¸¸
try
{
    await DoSomething();
}
catch (Exception ex)
{
    // æ²¡æœ‰è®°å½•å¼‚å¸¸
    return null;
}

// âœ… æ­£ç¡®ï¼šè®°å½•å¼‚å¸¸
try
{
    await DoSomething();
}
catch (Exception ex)
{
    _logger.LogError(ex, "Failed to execute operation");
    throw;
}
```

### 4. ä¸è¦ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥

```csharp
// âŒ é”™è¯¯ï¼šå­—ç¬¦ä¸²æ‹¼æ¥
_logger.LogInformation("User " + userId + " created at " + DateTime.Now);

// âœ… æ­£ç¡®ï¼šç»“æ„åŒ–æ—¥å¿—
_logger.LogInformation("User {UserId} created at {Timestamp}", 
    userId, DateTime.UtcNow);
```

## ğŸ”§ æœ€ä½³å®è·µ

### 1. æ—¥å¿—é…ç½®

```csharp
// âœ… æ—¥å¿—é…ç½®
builder.Logging.ClearProviders();
builder.Logging.AddConsole();
builder.Logging.AddDebug();

if (builder.Environment.IsDevelopment())
{
    builder.Logging.AddConsole();
}
else
{
    // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—
    builder.Logging.AddJsonConsole(options =>
    {
        options.JsonWriterOptions = new JsonWriterOptions
        {
            Indented = false
        };
    });
}
```

### 2. æ—¥å¿—è¿‡æ»¤

```csharp
// âœ… æ—¥å¿—è¿‡æ»¤é…ç½®
builder.Logging.AddFilter("Microsoft", LogLevel.Warning);
builder.Logging.AddFilter("System", LogLevel.Warning);
builder.Logging.AddFilter("Platform.ApiService", LogLevel.Information);
```

### 3. å¥åº·æ£€æŸ¥æ—¥å¿—

```csharp
// âœ… å¥åº·æ£€æŸ¥æ—¥å¿—
public class DatabaseHealthCheck : IHealthCheck
{
    private readonly ILogger<DatabaseHealthCheck> _logger;

    public async Task<HealthCheckResult> CheckHealthAsync(
        HealthCheckContext context, 
        CancellationToken cancellationToken = default)
    {
        try
        {
            await _database.PingAsync(cancellationToken);
            _logger.LogDebug("Database health check passed");
            return HealthCheckResult.Healthy("Database is accessible");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Database health check failed");
            return HealthCheckResult.Unhealthy("Database is not accessible", ex);
        }
    }
}
```

### 4. å‰ç«¯é”™è¯¯è¾¹ç•Œ

```tsx
// âœ… React é”™è¯¯è¾¹ç•Œ
interface ErrorBoundaryState {
  hasError: boolean;
  error?: Error;
}

class ErrorBoundary extends React.Component<
  React.PropsWithChildren<{}>,
  ErrorBoundaryState
> {
  constructor(props: React.PropsWithChildren<{}>) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error: Error): ErrorBoundaryState {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    Logger.getInstance().error('React Error Boundary caught an error', error, {
      componentStack: errorInfo.componentStack
    });
  }

  render() {
    if (this.state.hasError) {
      return <ErrorFallback error={this.state.error} />;
    }

    return this.props.children;
  }
}
```

## ğŸ“‹ æ—¥å¿—è®°å½•æ£€æŸ¥æ¸…å•

è®°å½•æ—¥å¿—æ—¶æ£€æŸ¥ï¼š

- [ ] ä½¿ç”¨é€‚å½“çš„æ—¥å¿—çº§åˆ«
- [ ] ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—æ ¼å¼
- [ ] ä¸è®°å½•æ•æ„Ÿä¿¡æ¯
- [ ] åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯
- [ ] è®°å½•å¼‚å¸¸å’Œé”™è¯¯
- [ ] ä½¿ç”¨ä½œç”¨åŸŸè®°å½•ç›¸å…³æ“ä½œ
- [ ] è€ƒè™‘æ€§èƒ½å½±å“
- [ ] é…ç½®é€‚å½“çš„æ—¥å¿—è¿‡æ»¤
- [ ] ç¡®ä¿æ—¥å¿—æ ¼å¼ä¸€è‡´
- [ ] è€ƒè™‘æ—¥å¿—å­˜å‚¨å’Œæ£€ç´¢

## ğŸ§ª æ—¥å¿—æµ‹è¯•

```csharp
// âœ… æ—¥å¿—æµ‹è¯•
[Test]
public void Logging_ShouldRecordCorrectInformation()
{
    // Arrange
    var logger = new Mock<ILogger<UserService>>();
    var userService = new UserService(logger.Object, _userRepository);

    // Act
    userService.CreateUserAsync(new CreateUserRequest { Email = "test@example.com" });

    // Assert
    logger.Verify(
        x => x.Log(
            LogLevel.Information,
            It.IsAny<EventId>(),
            It.Is<It.IsAnyType>((v, t) => v.ToString().Contains("Creating user")),
            It.IsAny<Exception>(),
            It.IsAny<Func<It.IsAnyType, Exception, string>>()),
        Times.Once);
}
```

## ğŸ“š ç›¸å…³èµ„æº

- [.NET æ—¥å¿—è®°å½•æ–‡æ¡£](https://docs.microsoft.com/aspnet/core/fundamentals/logging/)
- [ç»“æ„åŒ–æ—¥å¿—è®°å½•](https://docs.microsoft.com/aspnet/core/fundamentals/logging/#log-structured-data)
- [å¥åº·æ£€æŸ¥](https://docs.microsoft.com/aspnet/core/host-and-deploy/health-checks)
- [æ´»åŠ¨æ—¥å¿—ä¸­é—´ä»¶](mdc:Platform.ApiService/Middleware/ActivityLogMiddleware.cs)
- [å‰ç«¯æ—¥å¿—æœåŠ¡](mdc:Platform.Admin/src/services/logger.ts)

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

1. **ç»“æ„åŒ–æ—¥å¿—** - ä½¿ç”¨å‚æ•°åŒ–æ—¥å¿—æ¶ˆæ¯
2. **é€‚å½“çº§åˆ«** - æ ¹æ®é‡è¦æ€§é€‰æ‹©æ—¥å¿—çº§åˆ«
3. **å®‰å…¨ç¬¬ä¸€** - ä¸è®°å½•æ•æ„Ÿä¿¡æ¯
4. **æ€§èƒ½è€ƒè™‘** - é¿å…å½±å“åº”ç”¨æ€§èƒ½
5. **ä¸Šä¸‹æ–‡ä¸°å¯Œ** - åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯
6. **å¼‚å¸¸è®°å½•** - è®°å½•æ‰€æœ‰å¼‚å¸¸å’Œé”™è¯¯
7. **é…ç½®çµæ´»** - æ”¯æŒä¸åŒç¯å¢ƒçš„æ—¥å¿—é…ç½®
8. **ç›‘æ§é›†æˆ** - ä¸ç›‘æ§ç³»ç»Ÿé›†æˆ