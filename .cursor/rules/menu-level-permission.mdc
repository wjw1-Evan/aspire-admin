---
globs: **/Controllers/*.cs,**/Attributes/*.cs
description: èœå•çº§æƒé™æ§åˆ¶è§„èŒƒ
---

# èœå•çº§æƒé™æ§åˆ¶è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**ç³»ç»Ÿé‡‡ç”¨èœå•çº§æƒé™æ§åˆ¶ï¼Œç§»é™¤æ“ä½œçº§æƒé™ç®¡ç†ã€‚ç”¨æˆ·èƒ½è®¿é—®æŸä¸ªèœå•ï¼Œå°±èƒ½è°ƒç”¨è¯¥èœå•ä¸‹çš„æ‰€æœ‰APIåŠŸèƒ½ã€‚**

## âœ… æ­£ç¡®çš„æƒé™æ§åˆ¶æ–¹å¼

### åç«¯APIå®ç°

```csharp
[ApiController]
[Route("api/[controller]")]
[Authorize]  // æ§åˆ¶å™¨çº§åˆ«è¦æ±‚ç™»å½•
public class UserController : BaseApiController
{
    [HttpGet]
    [RequireMenu("user-management")]
    public async Task<IActionResult> GetAll()
    {
        var users = await _userService.GetAllAsync();
        return Success(users);
    }
    
    [HttpPost]
    [RequireMenu("user-management")]
    public async Task<IActionResult> Create([FromBody] CreateUserRequest request)
    {
        var user = await _userService.CreateAsync(request);
        return Success(user, "åˆ›å»ºæˆåŠŸ");
    }
    
    [HttpPut("{id}")]
    [RequireMenu("user-management")]
    public async Task<IActionResult> Update(string id, [FromBody] UpdateUserRequest request)
    {
        var success = await _userService.UpdateAsync(id, request);
        success.EnsureSuccess("ç”¨æˆ·", id);
        return Success("æ›´æ–°æˆåŠŸ");
    }
    
    [HttpDelete("{id}")]
    [RequireMenu("user-management")]
    public async Task<IActionResult> Delete(string id)
    {
        var success = await _userService.DeleteAsync(id);
        success.EnsureSuccess("ç”¨æˆ·", id);
        return Success("åˆ é™¤æˆåŠŸ");
    }
}
```

### BaseApiControllerè¾…åŠ©æ–¹æ³•

```csharp
// æ£€æŸ¥èœå•è®¿é—®æƒé™
protected async Task<bool> HasMenuAccessAsync(string menuName)

// è¦æ±‚èœå•è®¿é—®æƒé™ï¼ˆæ— æƒé™æŠ›å¼‚å¸¸ï¼‰
protected async Task RequireMenuAccessAsync(string menuName)

// æ£€æŸ¥æ˜¯å¦æœ‰ä»»æ„ä¸€ä¸ªèœå•çš„æƒé™
protected async Task<bool> HasAnyMenuAccessAsync(params string[] menuNames)
```

### æ¡ä»¶æƒé™æ£€æŸ¥

```csharp
[HttpPost("bulk-action")]
[Authorize]
public async Task<IActionResult> BulkAction([FromBody] BulkActionRequest request)
{
    // æ ¹æ®æ“ä½œç±»å‹æ£€æŸ¥ä¸åŒèœå•æƒé™
    if (request.Action == "delete")
        await RequireMenuAccessAsync("user-management");
    else if (request.Action == "export")
        await RequireMenuAccessAsync("data-export");
    
    // æ‰§è¡Œæ“ä½œ
    var result = await _service.BulkActionAsync(request);
    return Success(result);
}
```

### è‡ªå·±æˆ–æœ‰æƒé™æ¨¡å¼

```csharp
[HttpGet("{id}")]
[Authorize]
public async Task<IActionResult> GetUser(string id)
{
    // å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„ä¿¡æ¯ï¼Œæˆ–è€…éœ€è¦user-managementèœå•æƒé™
    var currentUserId = CurrentUserId;
    if (currentUserId != id && !await HasMenuAccessAsync("user-management"))
    {
        throw new UnauthorizedAccessException("æ— æƒæŸ¥çœ‹å…¶ä»–ç”¨æˆ·ä¿¡æ¯");
    }
    
    var user = await _userService.GetUserByIdAsync(id);
    return Success(user.EnsureFound("ç”¨æˆ·", id));
}
```

## ğŸ“‹ èœå•ä¸APIæ˜ å°„

| èœå•åç§° | èœå•è·¯å¾„ | APIè·¯å¾„ | è¯´æ˜ |
|---------|---------|---------|------|
| `user-management` | `/system/user-management` | `/api/user/management/*` | ç”¨æˆ·ç®¡ç† |
| `role-management` | `/system/role-management` | `/api/role/*` | è§’è‰²ç®¡ç† |
| `user-log` | `/system/user-log` | `/api/users/activity-logs` | æ´»åŠ¨æ—¥å¿— |
| `tag` | `/system/tag` | `/api/tag/*` | æ ‡ç­¾ç®¡ç† |
| `notice` | `/notice` | `/api/notices/*` | é€šçŸ¥ç®¡ç† |
| `company-settings` | `/system/company-settings` | `/api/company/*` | ä¼ä¸šè®¾ç½® |
| `welcome` | `/welcome` | - | æ¬¢è¿é¡µï¼ˆæ‰€æœ‰ç”¨æˆ·ï¼‰ |

## ğŸ¨ å‰ç«¯å®ç°

### èœå•æ˜¾ç¤º

èœå•ç”±åç«¯APIè¿”å›ï¼Œå‰ç«¯è‡ªåŠ¨æ¸²æŸ“ï¼š

```typescript
// app.tsx - è‡ªåŠ¨å¤„ç†
menuDataRender: (menuData) => {
  if (initialState?.currentUser?.menus) {
    return convertMenuTreeToProLayout(initialState.currentUser.menus);
  }
  return menuData;
}
```

### æŒ‰é’®æ˜¾ç¤º

**v6.0é‡è¦å˜æ›´**: æ‰€æœ‰ç”¨æˆ·çœ‹åˆ°ç›¸åŒçš„æŒ‰é’®ï¼Œä¸åšå‰ç«¯æƒé™æ§åˆ¶

```tsx
// âœ… æ­£ç¡®ï¼šç›´æ¥æ˜¾ç¤ºæŒ‰é’®
<Button type="primary" onClick={handleCreate}>
  æ–°å¢ç”¨æˆ·
</Button>

<Button type="link" onClick={handleEdit}>
  ç¼–è¾‘
</Button>

<Button type="link" danger onClick={handleDelete}>
  åˆ é™¤
</Button>

// âŒ å·²åºŸå¼ƒï¼šä¸å†ä½¿ç”¨PermissionControl
<PermissionControl permission="user:create">
  <Button type="primary">æ–°å¢ç”¨æˆ·</Button>
</PermissionControl>
```

### é”™è¯¯å¤„ç†

å½“ç”¨æˆ·ç‚¹å‡»æ— æƒé™çš„æŒ‰é’®æ—¶ï¼Œåç«¯è¿”å›403é”™è¯¯ï¼š

```typescript
try {
  await deleteUser(id);
  message.success('åˆ é™¤æˆåŠŸ');
} catch (error) {
  // åç«¯è¿”å›: "æ— æƒè®¿é—®èœå•: user-management"
  message.error(error.message || 'æ“ä½œå¤±è´¥');
}
```

## ğŸ‘¥ è§’è‰²é…ç½®

### åˆ›å»ºè§’è‰²æµç¨‹

1. **åŸºæœ¬ä¿¡æ¯**: å¡«å†™è§’è‰²åç§°å’Œæè¿°
2. **èœå•æƒé™**: é€‰æ‹©è¯¥è§’è‰²å¯è®¿é—®çš„èœå•
3. **ä¿å­˜**: åˆ›å»ºè§’è‰²

### èœå•åˆ†é…ç¤ºä¾‹

```typescript
// ç®¡ç†å‘˜è§’è‰² - æ‹¥æœ‰æ‰€æœ‰èœå•
{
  name: "ç®¡ç†å‘˜",
  menuIds: [
    "welcome-id",
    "user-management-id",
    "role-management-id",
    "user-log-id",
    "company-settings-id"
  ]
}

// æ™®é€šç”¨æˆ·è§’è‰² - æœ‰é™èœå•
{
  name: "æ™®é€šç”¨æˆ·",
  menuIds: [
    "welcome-id"
  ]
}
```

## ğŸ”§ å¼€å‘æŒ‡å—

### æ–°å¢éœ€è¦æƒé™çš„åŠŸèƒ½

#### æ­¥éª¤1: æ·»åŠ èœå•å®šä¹‰

```csharp
// DatabaseInitializerService.cs
new Models.Menu
{
    Name = "data-export",
    Title = "æ•°æ®å¯¼å‡º",
    Path = "/system/data-export",
    Component = "./data-export",
    Icon = "download",
    ParentId = systemMenu.Id,
    SortOrder = 7,
    IsEnabled = true,
    CreatedAt = now,
    UpdatedAt = now
}
```

#### æ­¥éª¤2: æ·»åŠ Controller

```csharp
[ApiController]
[Route("api/[controller]")]
[Authorize]
public class DataExportController : BaseApiController
{
    [HttpPost("export")]
    [RequireMenu("data-export")]
    public async Task<IActionResult> Export([FromBody] ExportRequest request)
    {
        var data = await _service.ExportAsync(request);
        return File(data, "application/octet-stream", "export.xlsx");
    }
}
```

#### æ­¥éª¤3: æ·»åŠ å‰ç«¯è·¯ç”±

```typescript
// config/routes.ts
{
    path: '/system/data-export',
    component: './data-export',
    hideInMenu: true,
}
```

#### æ­¥éª¤4: åˆ†é…ç»™è§’è‰²

é€šè¿‡è§’è‰²ç®¡ç†é¡µé¢ï¼Œå°†æ–°èœå•åˆ†é…ç»™éœ€è¦çš„è§’è‰²ã€‚

## ğŸš« ç¦æ­¢çš„åšæ³•

### âŒ ä¸è¦ä½¿ç”¨å·²åºŸå¼ƒçš„Permissionç³»ç»Ÿ

```csharp
// âŒ é”™è¯¯ï¼šPermissionå®ä½“å·²åˆ é™¤
var permission = new Permission { ... };

// âŒ é”™è¯¯ï¼šRequirePermissionç‰¹æ€§å·²åˆ é™¤
[RequirePermission("user", "create")]

// âŒ é”™è¯¯ï¼šæ–¹æ³•å·²åˆ é™¤
await HasPermissionAsync("user", "create");
```

### âŒ ä¸è¦åœ¨å‰ç«¯éšè—æŒ‰é’®

```tsx
// âŒ é”™è¯¯ï¼šPermissionControlç»„ä»¶å·²åˆ é™¤
<PermissionControl permission="user:create">
  <Button>æ–°å¢ç”¨æˆ·</Button>
</PermissionControl>

// âŒ é”™è¯¯ï¼šaccessæƒé™æ£€æŸ¥å‡½æ•°å·²åˆ é™¤
{access.canCreateUser && <Button>æ–°å¢ç”¨æˆ·</Button>}

// âœ… æ­£ç¡®ï¼šç›´æ¥æ˜¾ç¤ºæŒ‰é’®
<Button onClick={handleCreate}>æ–°å¢ç”¨æˆ·</Button>
```

### âŒ ä¸è¦åˆ›å»ºè¿‡åº¦ç»†åˆ†çš„èœå•

```csharp
// âŒ ä¸å¥½ï¼šè¿‡åº¦ç»†åˆ†
new Menu { Name = "user-view", Title = "æŸ¥çœ‹ç”¨æˆ·" }
new Menu { Name = "user-create", Title = "åˆ›å»ºç”¨æˆ·" }
new Menu { Name = "user-update", Title = "ç¼–è¾‘ç”¨æˆ·" }
new Menu { Name = "user-delete", Title = "åˆ é™¤ç”¨æˆ·" }

// âœ… å¥½ï¼šåˆç†ç²’åº¦
new Menu { Name = "user-management", Title = "ç”¨æˆ·ç®¡ç†" }
```

## ğŸ“Š æƒé™æ§åˆ¶æ¨¡å¼

### æ¨¡å¼1: æ ‡å‡†èœå•æƒé™ï¼ˆ97%çš„æƒ…å†µï¼‰

```csharp
[RequireMenu("menu-name")]
```

**é€‚ç”¨åœºæ™¯**ï¼š
- æ ‡å‡†çš„å¢åˆ æ”¹æŸ¥æ“ä½œ
- æƒé™è¦æ±‚å›ºå®šä¸å˜
- ä¸éœ€è¦æ¡ä»¶åˆ¤æ–­

### æ¨¡å¼2: æ¡ä»¶èœå•æƒé™ï¼ˆ3%çš„æƒ…å†µï¼‰

```csharp
[Authorize]
public async Task<IActionResult> Operation(...)
{
    if (condition)
        await RequireMenuAccessAsync("menu-1");
    else
        await RequireMenuAccessAsync("menu-2");
}
```

**é€‚ç”¨åœºæ™¯**ï¼š
- éœ€è¦æ ¹æ®å‚æ•°åˆ¤æ–­æƒé™
- å¤æ‚çš„æƒé™é€»è¾‘
- å¤šç§æ“ä½œç±»å‹çš„æ‰¹é‡æ¥å£

### æ¨¡å¼3: å…¬å…±æ¥å£ï¼ˆæ— ç‰¹æ®Šæƒé™ï¼‰

```csharp
[Authorize]  // åªæ£€æŸ¥ç™»å½•
public async Task<IActionResult> GetPublicData()
```

**é€‚ç”¨åœºæ™¯**ï¼š
- æ‰€æœ‰ç™»å½•ç”¨æˆ·éƒ½å¯è®¿é—®çš„åŠŸèƒ½
- æŸ¥çœ‹é€šçŸ¥ã€è·å–å…¬å…±é…ç½®ç­‰

### æ¨¡å¼4: åŒ¿åè®¿é—®

```csharp
[AllowAnonymous]
public async Task<IActionResult> GetAnonymousData()
```

**é€‚ç”¨åœºæ™¯**ï¼š
- ç™»å½•ã€æ³¨å†Œã€å¿˜è®°å¯†ç ç­‰
- å…¬å¼€çš„APIæ–‡æ¡£
- å¥åº·æ£€æŸ¥ç«¯ç‚¹

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

1. **ç®€åŒ–ä¼˜äºå¤æ‚** - èœå•çº§æƒé™è¶³å¤Ÿæ»¡è¶³å¤§å¤šæ•°åœºæ™¯
2. **åç«¯ä¸ºä¸»** - æƒé™éªŒè¯ä¸»è¦åœ¨åç«¯APIå±‚é¢è¿›è¡Œ
3. **ç”¨æˆ·ä½“éªŒ** - å‰ç«¯ä¸éšè—æŒ‰é’®ï¼Œé¿å…ç”¨æˆ·å›°æƒ‘
4. **å®‰å…¨ç¬¬ä¸€** - APIå±‚é¢çš„æƒé™éªŒè¯ç¡®ä¿å®‰å…¨æ€§
5. **ç²—ç²’åº¦æ§åˆ¶** - åˆç†çš„èœå•åˆ’åˆ†ï¼Œé¿å…è¿‡åº¦ç»†åˆ†

éµå¾ªè¿™äº›è§„èŒƒï¼Œå®ç°ç®€æ´ã€å®‰å…¨ã€æ˜“ç»´æŠ¤çš„æƒé™ç³»ç»Ÿï¼

