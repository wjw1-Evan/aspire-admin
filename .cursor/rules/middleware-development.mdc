---
globs: Platform.ApiService/Middleware/*.cs,Platform.ServiceDefaults/Middleware/*.cs
description: ä¸­é—´ä»¶å¼€å‘è§„èŒƒå’Œæœ€ä½³å®è·µ
---
# ä¸­é—´ä»¶å¼€å‘è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

### ä¸­é—´ä»¶è´Ÿè´£æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼Œæä¾›ç»Ÿä¸€çš„è¯·æ±‚å¤„ç†ã€å¼‚å¸¸å¤„ç†ã€æ—¥å¿—è®°å½•å’Œå“åº”æ ¼å¼åŒ–

## âœ… ä¸­é—´ä»¶å®ç°è§„èŒƒ

### å…¨å±€å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶

```csharp
// Platform.ApiService/Middleware/GlobalExceptionMiddleware.cs
public class GlobalExceptionMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger<GlobalExceptionMiddleware> _logger;

    public GlobalExceptionMiddleware(RequestDelegate next, ILogger<GlobalExceptionMiddleware> logger)
    {
        _next = next;
        _logger = logger;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        try
        {
            await _next(context);
        }
        catch (Exception ex)
        {
            await HandleExceptionAsync(context, ex);
        }
    }

    private async Task HandleExceptionAsync(HttpContext context, Exception exception)
    {
        var traceId = Activity.Current?.Id ?? context.TraceIdentifier;
        
        _logger.LogError(exception, 
            "Unhandled exception occurred. TraceId: {TraceId}, Path: {Path}", 
            traceId, 
            context.Request.Path);

        var response = exception switch
        {
            ArgumentException => CreateErrorResponse("å‚æ•°é”™è¯¯", "BAD_REQUEST", StatusCodes.Status400BadRequest, traceId),
            ArgumentNullException => CreateErrorResponse("å‚æ•°ä¸èƒ½ä¸ºç©º", "BAD_REQUEST", StatusCodes.Status400BadRequest, traceId),
            KeyNotFoundException => CreateErrorResponse("èµ„æºä¸å­˜åœ¨", "NOT_FOUND", StatusCodes.Status404NotFound, traceId),
            UnauthorizedAccessException => CreateErrorResponse("æœªæˆæƒè®¿é—®", "UNAUTHORIZED", StatusCodes.Status401Unauthorized, traceId),
            InvalidOperationException => CreateErrorResponse("æ“ä½œå¤±è´¥", "INVALID_OPERATION", StatusCodes.Status400BadRequest, traceId),
            TimeoutException => CreateErrorResponse("è¯·æ±‚è¶…æ—¶", "TIMEOUT", StatusCodes.Status408RequestTimeout, traceId),
            _ => CreateErrorResponse("æœåŠ¡å™¨å†…éƒ¨é”™è¯¯", "INTERNAL_ERROR", StatusCodes.Status500InternalServerError, traceId)
        };

        context.Response.StatusCode = response.StatusCode;
        context.Response.ContentType = "application/json";
        
        await context.Response.WriteAsync(JsonSerializer.Serialize(response.Body));
    }

    private (int StatusCode, object Body) CreateErrorResponse(
        string message, 
        string errorCode, 
        int statusCode,
        string traceId)
    {
        return (statusCode, new
        {
            success = false,
            errorMessage = message,
            errorCode,
            showType = 2, // ERROR_MESSAGE
            traceId,
            timestamp = DateTime.UtcNow
        });
    }
}
```

### æ´»åŠ¨æ—¥å¿—ä¸­é—´ä»¶

```csharp
// Platform.ApiService/Middleware/ActivityLogMiddleware.cs
public class ActivityLogMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger<ActivityLogMiddleware> _logger;

    public ActivityLogMiddleware(RequestDelegate next, ILogger<ActivityLogMiddleware> logger)
    {
        _next = next;
        _logger = logger;
    }

    public async Task InvokeAsync(HttpContext context, IUserActivityLogService logService)
    {
        var stopwatch = Stopwatch.StartNew();
        var requestId = context.TraceIdentifier;
        
        using (_logger.BeginScope(new Dictionary<string, object>
        {
            ["RequestId"] = requestId,
            ["Method"] = context.Request.Method,
            ["Path"] = context.Request.Path
        }))
        {
            _logger.LogDebug("Processing request {RequestId}", requestId);
            
            try
            {
                await _next(context);
                
                var elapsed = stopwatch.ElapsedMilliseconds;
                _logger.LogInformation("Request {RequestId} completed in {ElapsedMs}ms with status {StatusCode}",
                    requestId, elapsed, context.Response.StatusCode);
                
                // å¼‚æ­¥è®°å½•æ´»åŠ¨æ—¥å¿—
                _ = Task.Run(async () =>
                {
                    try
                    {
                        await logService.LogActivityAsync(new ActivityLogRequest
                        {
                            RequestId = requestId,
                            Method = context.Request.Method,
                            Path = context.Request.Path.Value ?? "",
                            StatusCode = context.Response.StatusCode,
                            ElapsedMs = elapsed,
                            UserId = GetUserId(context),
                            UserAgent = context.Request.Headers.UserAgent.ToString(),
                            ClientIp = GetClientIp(context)
                        });
                    }
                    catch (Exception ex)
                    {
                        _logger.LogError(ex, "Failed to log activity for request {RequestId}", requestId);
                    }
                });
            }
            catch (Exception ex)
            {
                var elapsed = stopwatch.ElapsedMilliseconds;
                _logger.LogError(ex, "Request {RequestId} failed after {ElapsedMs}ms",
                    requestId, elapsed);
                throw;
            }
        }
    }

    private string? GetUserId(HttpContext context)
    {
        return context.User?.FindFirst("userId")?.Value;
    }

    private string GetClientIp(HttpContext context)
    {
        return context.Connection.RemoteIpAddress?.ToString() ?? "unknown";
    }
}
```

### å“åº”æ ¼å¼åŒ–ä¸­é—´ä»¶

```csharp
// Platform.ApiService/Middleware/ResponseFormattingMiddleware.cs
public class ResponseFormattingMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger<ResponseFormattingMiddleware> _logger;

    public ResponseFormattingMiddleware(RequestDelegate next, ILogger<ResponseFormattingMiddleware> logger)
    {
        _next = next;
        _logger = logger;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        var originalBodyStream = context.Response.Body;
        
        using var responseBody = new MemoryStream();
        context.Response.Body = responseBody;

        try
        {
            await _next(context);
            
            // åªå¤„ç†æˆåŠŸçš„å“åº”
            if (context.Response.StatusCode >= 200 && context.Response.StatusCode < 300)
            {
                await FormatSuccessResponse(context);
            }
        }
        finally
        {
            responseBody.Seek(0, SeekOrigin.Begin);
            await responseBody.CopyToAsync(originalBodyStream);
        }
    }

    private async Task FormatSuccessResponse(HttpContext context)
    {
        var responseBody = await ReadResponseBody(context.Response.Body);
        
        if (!string.IsNullOrEmpty(responseBody))
        {
            try
            {
                // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯æ ‡å‡†æ ¼å¼
                var existingResponse = JsonSerializer.Deserialize<ApiResponse>(responseBody);
                if (existingResponse != null && existingResponse.Success.HasValue)
                {
                    return; // å·²ç»æ˜¯æ ‡å‡†æ ¼å¼ï¼Œä¸éœ€è¦é‡æ–°åŒ…è£…
                }
            }
            catch
            {
                // ä¸æ˜¯ JSON æ ¼å¼ï¼Œç»§ç»­åŒ…è£…
            }
        }

        // åŒ…è£…ä¸ºæ ‡å‡†å“åº”æ ¼å¼
        var formattedResponse = new ApiResponse<object>
        {
            Success = true,
            Data = string.IsNullOrEmpty(responseBody) ? null : JsonSerializer.Deserialize<object>(responseBody),
            Timestamp = DateTime.UtcNow
        };

        var jsonResponse = JsonSerializer.Serialize(formattedResponse);
        var bytes = Encoding.UTF8.GetBytes(jsonResponse);
        
        context.Response.ContentType = "application/json";
        context.Response.ContentLength = bytes.Length;
        
        await context.Response.Body.WriteAsync(bytes);
    }

    private async Task<string> ReadResponseBody(Stream body)
    {
        body.Seek(0, SeekOrigin.Begin);
        using var reader = new StreamReader(body, Encoding.UTF8, leaveOpen: true);
        return await reader.ReadToEndAsync();
    }
}
```

### è¯·æ±‚é™æµä¸­é—´ä»¶

```csharp
// Platform.ApiService/Middleware/RateLimitingMiddleware.cs
public class RateLimitingMiddleware
{
    private readonly RequestDelegate _next;
    private readonly IMemoryCache _cache;
    private readonly ILogger<RateLimitingMiddleware> _logger;

    public RateLimitingMiddleware(RequestDelegate next, IMemoryCache cache, ILogger<RateLimitingMiddleware> logger)
    {
        _next = next;
        _cache = cache;
        _logger = logger;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        var clientIp = GetClientIp(context);
        var endpoint = $"{context.Request.Method}:{context.Request.Path}";
        var key = $"rate_limit:{clientIp}:{endpoint}";
        
        var requestCount = _cache.GetOrCreate(key, entry =>
        {
            entry.AbsoluteExpirationRelativeToNow = TimeSpan.FromMinutes(1);
            return 0;
        });

        if (requestCount >= 100) // æ¯åˆ†é’Ÿæœ€å¤š100ä¸ªè¯·æ±‚
        {
            _logger.LogWarning("Rate limit exceeded for IP {ClientIp} on endpoint {Endpoint}", 
                clientIp, endpoint);
            
            context.Response.StatusCode = StatusCodes.Status429TooManyRequests;
            context.Response.ContentType = "application/json";
            
            var response = new
            {
                success = false,
                errorMessage = "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•",
                errorCode = "RATE_LIMIT_EXCEEDED",
                showType = 2,
                timestamp = DateTime.UtcNow
            };
            
            await context.Response.WriteAsync(JsonSerializer.Serialize(response));
            return;
        }

        _cache.Set(key, requestCount + 1, TimeSpan.FromMinutes(1));
        
        await _next(context);
    }

    private string GetClientIp(HttpContext context)
    {
        return context.Connection.RemoteIpAddress?.ToString() ?? "unknown";
    }
}
```

## ğŸ¯ ä¸­é—´ä»¶æ³¨å†Œå’Œé…ç½®

### ä¸­é—´ä»¶ç®¡é“é…ç½®

```csharp
// Platform.ApiService/Program.cs
public static void ConfigureMiddlewarePipeline(WebApplication app)
{
    // 1. å¼‚å¸¸å¤„ç†ï¼ˆæœ€å¤–å±‚ï¼‰
    app.UseMiddleware<GlobalExceptionMiddleware>();
    
    // 2. è¯·æ±‚é™æµ
    app.UseMiddleware<RateLimitingMiddleware>();
    
    // 3. è®¤è¯å’Œæˆæƒ
    app.UseAuthentication();
    app.UseAuthorization();
    
    // 4. æ´»åŠ¨æ—¥å¿—è®°å½•
    app.UseMiddleware<ActivityLogMiddleware>();
    
    // 5. CORS
    app.UseCors();
    
    // 6. å“åº”æ ¼å¼åŒ–
    app.UseMiddleware<ResponseFormattingMiddleware>();
    
    // 7. æ§åˆ¶å™¨
    app.MapControllers();
}
```

### ä¸­é—´ä»¶ä¾èµ–æ³¨å…¥

```csharp
// Platform.ApiService/Program.cs
public static void ConfigureServices(IServiceCollection services)
{
    // æ³¨å†Œä¸­é—´ä»¶ä¾èµ–çš„æœåŠ¡
    services.AddScoped<IUserActivityLogService, UserActivityLogService>();
    services.AddMemoryCache();
    
    // æ³¨å†Œä¸­é—´ä»¶
    services.AddScoped<GlobalExceptionMiddleware>();
    services.AddScoped<ActivityLogMiddleware>();
    services.AddScoped<ResponseFormattingMiddleware>();
    services.AddScoped<RateLimitingMiddleware>();
}
```

## ğŸ¯ è‡ªå®šä¹‰ä¸­é—´ä»¶ç‰¹æ€§

### ä¸­é—´ä»¶ç‰¹æ€§

```csharp
// Platform.ApiService/Attributes/SkipMiddlewareAttribute.cs
[AttributeUsage(AttributeTargets.Method | AttributeTargets.Class)]
public class SkipMiddlewareAttribute : Attribute
{
    public Type[] MiddlewareTypes { get; }

    public SkipMiddlewareAttribute(params Type[] middlewareTypes)
    {
        MiddlewareTypes = middlewareTypes;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
[SkipMiddleware(typeof(ActivityLogMiddleware))]
public async Task<IActionResult> HealthCheck()
{
    return Success("OK");
}
```

### ä¸­é—´ä»¶æ¡ä»¶æ‰§è¡Œ

```csharp
// Platform.ApiService/Middleware/ConditionalMiddleware.cs
public class ConditionalMiddleware
{
    private readonly RequestDelegate _next;
    private readonly Func<HttpContext, bool> _condition;

    public ConditionalMiddleware(RequestDelegate next, Func<HttpContext, bool> condition)
    {
        _next = next;
        _condition = condition;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        if (_condition(context))
        {
            await _next(context);
        }
        else
        {
            // è·³è¿‡ä¸­é—´ä»¶å¤„ç†
            await _next(context);
        }
    }
}
```

## ğŸš« ç¦æ­¢çš„åšæ³•

### ä¸è¦å¿½ç•¥å¼‚å¸¸å¤„ç†

```csharp
// âŒ é”™è¯¯ - æ²¡æœ‰å¼‚å¸¸å¤„ç†
public async Task InvokeAsync(HttpContext context)
{
    await _next(context); // å¼‚å¸¸ä¼šç›´æ¥æŠ›å‡º
}

// âœ… æ­£ç¡® - é€‚å½“çš„å¼‚å¸¸å¤„ç†
public async Task InvokeAsync(HttpContext context)
{
    try
    {
        await _next(context);
    }
    catch (Exception ex)
    {
        await HandleExceptionAsync(context, ex);
    }
}
```

### ä¸è¦é˜»å¡è¯·æ±‚ç®¡é“

```csharp
// âŒ é”™è¯¯ - åŒæ­¥æ“ä½œé˜»å¡ç®¡é“
public async Task InvokeAsync(HttpContext context)
{
    var result = _service.DoSomethingSync(); // åŒæ­¥æ“ä½œ
    await _next(context);
}

// âœ… æ­£ç¡® - å¼‚æ­¥æ“ä½œ
public async Task InvokeAsync(HttpContext context)
{
    var result = await _service.DoSomethingAsync(); // å¼‚æ­¥æ“ä½œ
    await _next(context);
}
```

### ä¸è¦å¿½ç•¥æ€§èƒ½å½±å“

```csharp
// âŒ é”™è¯¯ - æ¯æ¬¡è¯·æ±‚éƒ½æ‰§è¡Œé‡æ“ä½œ
public async Task InvokeAsync(HttpContext context)
{
    var data = await _database.GetAllDataAsync(); // æ¯æ¬¡éƒ½æŸ¥è¯¢æ•°æ®åº“
    await _next(context);
}

// âœ… æ­£ç¡® - ä½¿ç”¨ç¼“å­˜æˆ–æ¡ä»¶æ‰§è¡Œ
public async Task InvokeAsync(HttpContext context)
{
    if (ShouldExecute(context))
    {
        var data = await _cache.GetOrCreateAsync("key", async entry =>
        {
            entry.AbsoluteExpirationRelativeToNow = TimeSpan.FromMinutes(5);
            return await _database.GetAllDataAsync();
        });
    }
    await _next(context);
}
```

## ğŸ“‹ ä¸­é—´ä»¶å¼€å‘æ£€æŸ¥æ¸…å•

åˆ›å»ºæˆ–ä¿®æ”¹ä¸­é—´ä»¶æ—¶æ£€æŸ¥ï¼š

- [ ] å®ç°æ­£ç¡®çš„ä¸­é—´ä»¶æ¥å£
- [ ] æ·»åŠ é€‚å½“çš„å¼‚å¸¸å¤„ç†
- [ ] ä½¿ç”¨å¼‚æ­¥æ“ä½œé¿å…é˜»å¡
- [ ] æ·»åŠ æ—¥å¿—è®°å½•
- [ ] è€ƒè™‘æ€§èƒ½å½±å“
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•
- [ ] é…ç½®æ­£ç¡®çš„æ‰§è¡Œé¡ºåº
- [ ] å¤„ç†è¾¹ç•Œæƒ…å†µ
- [ ] æ·»åŠ é…ç½®é€‰é¡¹
- [ ] æ–‡æ¡£åŒ–ä¸­é—´ä»¶åŠŸèƒ½

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å…¨å±€å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶](mdc:Platform.ApiService/Middleware/GlobalExceptionMiddleware.cs)
- [æ´»åŠ¨æ—¥å¿—ä¸­é—´ä»¶](mdc:Platform.ApiService/Middleware/ActivityLogMiddleware.cs)
- [å“åº”æ ¼å¼åŒ–ä¸­é—´ä»¶](mdc:Platform.ApiService/Middleware/ResponseFormattingMiddleware.cs)
- [ASP.NET Core ä¸­é—´ä»¶æ–‡æ¡£](https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/)
