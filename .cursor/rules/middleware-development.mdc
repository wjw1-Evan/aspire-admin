---
globs: Platform.ApiService/Middleware/*.cs,Platform.ServiceDefaults/Middleware/*.cs
description: ä¸­é—´ä»¶å¼€å‘è§„èŒƒå’Œæœ€ä½³å®è·µ
---
# ä¸­é—´ä»¶å¼€å‘è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

### ä¸­é—´ä»¶è´Ÿè´£æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼Œæä¾›ç»Ÿä¸€çš„è¯·æ±‚å¤„ç†ã€å¼‚å¸¸å¤„ç†ã€æ—¥å¿—è®°å½•å’Œå“åº”æ ¼å¼åŒ–

## âœ… ä¸­é—´ä»¶å®ç°è§„èŒƒ

### å…¨å±€å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶

```csharp
// Platform.ApiService/Middleware/GlobalExceptionMiddleware.cs
public class GlobalExceptionMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger<GlobalExceptionMiddleware> _logger;

    public GlobalExceptionMiddleware(RequestDelegate next, ILogger<GlobalExceptionMiddleware> logger)
    {
        _next = next;
        _logger = logger;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        try
        {
            await _next(context);
        }
        catch (Exception ex)
        {
            await HandleExceptionAsync(context, ex);
        }
    }

    private async Task HandleExceptionAsync(HttpContext context, Exception exception)
    {
        var traceId = Activity.Current?.Id ?? context.TraceIdentifier;
        
        _logger.LogError(exception, 
            "Unhandled exception occurred. TraceId: {TraceId}, Path: {Path}", 
            traceId, 
            context.Request.Path);

        var response = exception switch
        {
            ArgumentException => CreateErrorResponse("å‚æ•°é”™è¯¯", "BAD_REQUEST", StatusCodes.Status400BadRequest, traceId),
            ArgumentNullException => CreateErrorResponse("å‚æ•°ä¸èƒ½ä¸ºç©º", "BAD_REQUEST", StatusCodes.Status400BadRequest, traceId),
            KeyNotFoundException => CreateErrorResponse("èµ„æºä¸å­˜åœ¨", "NOT_FOUND", StatusCodes.Status404NotFound, traceId),
            UnauthorizedAccessException => CreateErrorResponse("æœªæˆæƒè®¿é—®", "UNAUTHORIZED", StatusCodes.Status401Unauthorized, traceId),
            InvalidOperationException => CreateErrorResponse("æ“ä½œå¤±è´¥", "INVALID_OPERATION", StatusCodes.Status400BadRequest, traceId),
            TimeoutException => CreateErrorResponse("è¯·æ±‚è¶…æ—¶", "TIMEOUT", StatusCodes.Status408RequestTimeout, traceId),
            _ => CreateErrorResponse("æœåŠ¡å™¨å†…éƒ¨é”™è¯¯", "INTERNAL_ERROR", StatusCodes.Status500InternalServerError, traceId)
        };

        context.Response.StatusCode = response.StatusCode;
        context.Response.ContentType = "application/json";
        
        await context.Response.WriteAsync(JsonSerializer.Serialize(response.Body));
    }

    private (int StatusCode, object Body) CreateErrorResponse(
        string message, 
        string errorCode, 
        int statusCode,
        string traceId)
    {
        return (statusCode, new
        {
            success = false,
            errorMessage = message,
            errorCode,
            showType = 2, // ERROR_MESSAGE
            traceId,
            timestamp = DateTime.UtcNow
        });
    }
}
```

### æ´»åŠ¨æ—¥å¿—ä¸­é—´ä»¶

```csharp
// Platform.ApiService/Middleware/ActivityLogMiddleware.cs
public class ActivityLogMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger<ActivityLogMiddleware> _logger;
    private readonly IConfiguration _configuration;
    private readonly IServiceProvider _serviceProvider;  // âœ… ä½¿ç”¨ IServiceProvider åˆ›å»º Scope

    // æ’é™¤è·¯å¾„åˆ—è¡¨
    private static readonly string[] ExcludedPaths =
    {
        "/health",
        "/api/openapi",
        "/scalar/",
        "/metrics",
        "/_framework/",
        "/favicon.ico"
    };

    public ActivityLogMiddleware(
        RequestDelegate next,
        ILogger<ActivityLogMiddleware> logger,
        IConfiguration configuration,
        IServiceProvider serviceProvider)  // âœ… æ³¨å…¥ IServiceProvider
    {
        _next = next;
        _logger = logger;
        _configuration = configuration;
        _serviceProvider = serviceProvider;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        // æ£€æŸ¥æ˜¯å¦å¯ç”¨æ—¥å¿—è®°å½•
        var enabled = _configuration.GetValue<bool>("ActivityLog:Enabled", true);
        if (!enabled)
        {
            await _next(context);
            return;
        }

        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ’é™¤æ­¤è·¯å¾„
        if (ShouldExclude(context.Request.Path))
        {
            await _next(context);
            return;
        }

        // è®°å½•è¯·æ±‚å¼€å§‹å¹¶è®¡æ—¶
        var stopwatch = Stopwatch.StartNew();

        // æ‰§è¡Œè¯·æ±‚
        await _next(context);

        // åœæ­¢è®¡æ—¶
        stopwatch.Stop();

        // âš ï¸ å…³é”®ï¼šåœ¨è¯·æ±‚çº¿ç¨‹ä¸­æå–æ‰€æœ‰æ•°æ®ï¼Œé¿å…åœ¨åå°çº¿ç¨‹è®¿é—® HttpContext
        var logData = ExtractLogData(context, stopwatch.ElapsedMilliseconds);
        
        if (logData.HasValue)
        {
            // å¼‚æ­¥è®°å½•æ—¥å¿—ï¼ˆä¸ç­‰å¾…å®Œæˆï¼Œé¿å…é˜»å¡å“åº”ï¼‰
            // ä½¿ç”¨æ ¹ ServiceProvider åˆ›å»ºæ–°çš„ Scope
            _ = Task.Run(async () =>
            {
                try
                {
                    // åˆ›å»ºæ–°çš„ Scopeï¼Œç¡®ä¿ Scoped æœåŠ¡æ­£å¸¸å·¥ä½œ
                    using var scope = _serviceProvider.CreateScope();
                    var scopedLogService = scope.ServiceProvider.GetRequiredService<IUserActivityLogService>();
                    
                    await LogRequestAsync(logData.Value, scopedLogService);
                }
                catch (OperationCanceledException)
                {
                    // æ­£å¸¸å–æ¶ˆï¼Œä¸è®°å½•æ—¥å¿—
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, "Failed to log activity for {Path}", logData.Value.path);
                }
            }, context.RequestAborted);
        }
    }

    /// <summary>
    /// æ£€æŸ¥æ˜¯å¦åº”è¯¥æ’é™¤æ­¤è·¯å¾„
    /// </summary>
    private bool ShouldExclude(PathString path)
    {
        var pathString = path.Value?.ToLower() ?? string.Empty;

        // æ£€æŸ¥é¢„å®šä¹‰çš„æ’é™¤è·¯å¾„
        if (ExcludedPaths.Any(excludedPath => pathString.StartsWith(excludedPath.ToLower())))
        {
            return true;
        }

        // æ£€æŸ¥é…ç½®çš„æ’é™¤è·¯å¾„
        var configuredExcludedPaths = _configuration.GetSection("ActivityLog:ExcludedPaths").Get<string[]>();
        if (configuredExcludedPaths != null && configuredExcludedPaths.Any(excludedPath => pathString.StartsWith(excludedPath.ToLower())))
        {
            return true;
        }

        return false;
    }

    /// <summary>
    /// åœ¨è¯·æ±‚çº¿ç¨‹ä¸­æå–æ—¥å¿—æ•°æ®ï¼ˆé¿å…åå°çº¿ç¨‹è®¿é—® HttpContextï¼‰
    /// </summary>
    private (string? userId, string? username, string httpMethod, string path, string? queryString, string scheme, string host, int statusCode, long durationMs, string? ipAddress, string? userAgent)? ExtractLogData(HttpContext context, long durationMs)
    {
        // æå–ç”¨æˆ·ä¿¡æ¯
        string? userId = null;
        string? username = null;

        if (context.User?.Identity?.IsAuthenticated == true)
        {
            userId = context.User.FindFirst("userId")?.Value;
            username = context.User.FindFirst("username")?.Value
                      ?? context.User.FindFirst("name")?.Value
                      ?? context.User.Identity.Name;
        }

        // æ£€æŸ¥æ˜¯å¦åŒ…å«åŒ¿åç”¨æˆ·
        var includeAnonymous = _configuration.GetValue<bool>("ActivityLog:IncludeAnonymous", false);
        if (string.IsNullOrEmpty(userId) && !includeAnonymous)
        {
            return null; // ä¸è®°å½•åŒ¿åè¯·æ±‚
        }

        // æå–è¯·æ±‚ä¿¡æ¯
        var httpMethod = context.Request.Method;
        var path = context.Request.Path.Value ?? string.Empty;
        var queryString = context.Request.QueryString.Value;

        // æå– URL ç›¸å…³ä¿¡æ¯
        var scheme = context.Request.Scheme; // http æˆ– https
        var host = context.Request.Host.Value ?? "localhost"; // åŒ…å«ä¸»æœºåå’Œç«¯å£

        // é™åˆ¶æŸ¥è¯¢å­—ç¬¦ä¸²é•¿åº¦
        var maxQueryStringLength = _configuration.GetValue<int>("ActivityLog:MaxQueryStringLength", 500);
        if (!string.IsNullOrEmpty(queryString) && queryString.Length > maxQueryStringLength)
        {
            queryString = queryString.Substring(0, maxQueryStringLength) + "...";
        }

        // æ£€æŸ¥æ˜¯å¦åŒ…å«æŸ¥è¯¢å­—ç¬¦ä¸²
        var includeQueryString = _configuration.GetValue<bool>("ActivityLog:IncludeQueryString", true);
        if (!includeQueryString)
        {
            queryString = null;
        }

        // æå–IPåœ°å€
        var ipAddress = context.Connection.RemoteIpAddress?.ToString();

        // æå–User-Agent
        var userAgent = context.Request.Headers["User-Agent"].ToString();

        // å“åº”çŠ¶æ€ç 
        var statusCode = context.Response.StatusCode;

        return (userId, username, httpMethod, path, queryString, scheme, host, statusCode, durationMs, ipAddress, userAgent);
    }

    /// <summary>
    /// è®°å½•è¯·æ±‚ä¿¡æ¯ï¼ˆä½¿ç”¨å·²æå–çš„æ•°æ®ï¼Œä¸è®¿é—® HttpContextï¼‰
    /// </summary>
    private static async Task LogRequestAsync(
        (string? userId, string? username, string httpMethod, string path, string? queryString, string scheme, string host, int statusCode, long durationMs, string? ipAddress, string? userAgent) logData,
        IUserActivityLogService logService)
    {
        var (userId, username, httpMethod, path, queryString, scheme, host, statusCode, durationMs, ipAddress, userAgent) = logData;

        // æ„å»ºè¯·æ±‚å¯¹è±¡
        var request = new LogHttpRequestRequest
        {
            UserId = userId,
            Username = username,
            HttpMethod = httpMethod,
            Path = path,
            QueryString = queryString,
            Scheme = scheme,
            Host = host,
            StatusCode = statusCode,
            DurationMs = durationMs,
            IpAddress = ipAddress,
            UserAgent = userAgent
        };

        // è°ƒç”¨æ—¥å¿—æœåŠ¡è®°å½•
        await logService.LogHttpRequestAsync(request);
    }
}
```

**å…³é”®è®¾è®¡è¦ç‚¹**ï¼š

1. **âœ… åœ¨è¯·æ±‚çº¿ç¨‹ä¸­æå–æ•°æ®** - `ExtractLogData` æ–¹æ³•åœ¨è¯·æ±‚å¤„ç†çº¿ç¨‹ä¸­æå–æ‰€æœ‰éœ€è¦çš„æ•°æ®ï¼Œé¿å…åœ¨åå°çº¿ç¨‹è®¿é—® `HttpContext`
2. **âœ… ä½¿ç”¨ IServiceProvider åˆ›å»º Scope** - åœ¨åå°çº¿ç¨‹ä¸­ä½¿ç”¨ `_serviceProvider.CreateScope()` åˆ›å»ºæ–°çš„ Scopeï¼Œç¡®ä¿ Scoped æœåŠ¡æ­£å¸¸å·¥ä½œ
3. **âœ… å¼‚æ­¥ä¸é˜»å¡** - ä½¿ç”¨ `Task.Run` å¼‚æ­¥è®°å½•æ—¥å¿—ï¼Œä¸é˜»å¡è¯·æ±‚å“åº”
4. **âœ… æ’é™¤ç‰¹å®šè·¯å¾„** - è‡ªåŠ¨æ’é™¤å¥åº·æ£€æŸ¥ã€API æ–‡æ¡£ç­‰ä¸éœ€è¦è®°å½•çš„è·¯å¾„
5. **âœ… å¯é…ç½®** - æ”¯æŒé€šè¿‡é…ç½®æ–‡ä»¶å¯ç”¨/ç¦ç”¨ã€æ’é™¤è·¯å¾„ã€åŒ¿åç”¨æˆ·ç­‰é…ç½®

### UserActivityLogService è®¾è®¡è¯´æ˜

**âš ï¸ é‡è¦**ï¼š`UserActivityLogService` åœ¨åå°çº¿ç¨‹ä¸­è®°å½•æ—¥å¿—ï¼Œå› æ­¤ä¸èƒ½ä½¿ç”¨ `ITenantContext` æˆ– `IHttpContextAccessor`ï¼ˆè¿™äº›ä¾èµ– `HttpContext`ï¼‰ã€‚

**âœ… æ­£ç¡®åšæ³•**ï¼šç›´æ¥ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·çš„ä¼ä¸šIDï¼š

```csharp
public class UserActivityLogService : IUserActivityLogService
{
    private readonly IDatabaseOperationFactory<UserActivityLog> _activityLogFactory;
    private readonly IDatabaseOperationFactory<AppUser> _userFactory;  // âœ… ç›´æ¥æŸ¥è¯¢ç”¨æˆ·

    /// <summary>
    /// å°è¯•è·å–ç”¨æˆ·çš„ä¼ä¸šIDï¼ˆä»æ•°æ®åº“è·å–ï¼Œä¸ä½¿ç”¨ JWT tokenï¼‰
    /// âš ï¸ é‡è¦ï¼šåå°çº¿ç¨‹æ— æ³•è®¿é—® HttpContextï¼Œå› æ­¤ç›´æ¥æŸ¥è¯¢æ•°æ®åº“
    /// </summary>
    private async Task<string?> TryGetUserCompanyIdAsync(string? userId)
    {
        if (string.IsNullOrEmpty(userId))
        {
            return null;
        }

        try
        {
            var user = await _userFactory.GetByIdAsync(userId);
            return user?.CurrentCompanyId;  // âœ… ä»æ•°æ®åº“è·å– CurrentCompanyId
        }
        catch
        {
            return null;
        }
    }

    public async Task LogHttpRequestAsync(LogHttpRequestRequest request)
    {
        // âœ… ä»æ•°æ®åº“è·å–ä¼ä¸šIDï¼Œè€Œä¸æ˜¯ä» JWT token
        var companyId = await TryGetUserCompanyIdAsync(request.UserId);

        var log = new UserActivityLog
        {
            UserId = request.UserId ?? "anonymous",
            Username = request.Username ?? "åŒ¿åç”¨æˆ·",
            HttpMethod = request.HttpMethod,
            Path = request.Path,
            QueryString = request.QueryString,
            StatusCode = request.StatusCode,
            Duration = request.DurationMs,
            IpAddress = request.IpAddress,
            UserAgent = request.UserAgent,
            CompanyId = companyId ?? string.Empty  // âœ… ä»æ•°æ®åº“è·å–
        };

        await _activityLogFactory.CreateAsync(log);
    }
}
```

**âŒ é”™è¯¯åšæ³•**ï¼š

```csharp
// âŒ é”™è¯¯ï¼šåœ¨åå°çº¿ç¨‹ä¸­æ— æ³•è®¿é—® HttpContext
public class UserActivityLogService : IUserActivityLogService
{
    private readonly ITenantContext _tenantContext;  // âŒ ä¾èµ– HttpContextï¼Œåå°çº¿ç¨‹ä¸å¯ç”¨
    private readonly IHttpContextAccessor _httpContextAccessor;  // âŒ åå°çº¿ç¨‹ä¸å¯ç”¨

    public async Task LogHttpRequestAsync(...)
    {
        var companyId = _tenantContext.GetCurrentCompanyId();  // âŒ ä¼šåœ¨åå°çº¿ç¨‹ä¸­å¤±è´¥
        // ...
    }
}
```

### å“åº”æ ¼å¼åŒ–ä¸­é—´ä»¶

```csharp
// Platform.ApiService/Middleware/ResponseFormattingMiddleware.cs
public class ResponseFormattingMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger<ResponseFormattingMiddleware> _logger;

    public ResponseFormattingMiddleware(RequestDelegate next, ILogger<ResponseFormattingMiddleware> logger)
    {
        _next = next;
        _logger = logger;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        var originalBodyStream = context.Response.Body;
        
        using var responseBody = new MemoryStream();
        context.Response.Body = responseBody;

        try
        {
            await _next(context);
            
            // åªå¤„ç†æˆåŠŸçš„å“åº”
            if (context.Response.StatusCode >= 200 && context.Response.StatusCode < 300)
            {
                await FormatSuccessResponse(context);
            }
        }
        finally
        {
            responseBody.Seek(0, SeekOrigin.Begin);
            await responseBody.CopyToAsync(originalBodyStream);
        }
    }

    private async Task FormatSuccessResponse(HttpContext context)
    {
        var responseBody = await ReadResponseBody(context.Response.Body);
        
        if (!string.IsNullOrEmpty(responseBody))
        {
            try
            {
                // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯æ ‡å‡†æ ¼å¼
                var existingResponse = JsonSerializer.Deserialize<ApiResponse>(responseBody);
                if (existingResponse != null && existingResponse.Success.HasValue)
                {
                    return; // å·²ç»æ˜¯æ ‡å‡†æ ¼å¼ï¼Œä¸éœ€è¦é‡æ–°åŒ…è£…
                }
            }
            catch
            {
                // ä¸æ˜¯ JSON æ ¼å¼ï¼Œç»§ç»­åŒ…è£…
            }
        }

        // åŒ…è£…ä¸ºæ ‡å‡†å“åº”æ ¼å¼
        var formattedResponse = new ApiResponse<object>
        {
            Success = true,
            Data = string.IsNullOrEmpty(responseBody) ? null : JsonSerializer.Deserialize<object>(responseBody),
            Timestamp = DateTime.UtcNow
        };

        var jsonResponse = JsonSerializer.Serialize(formattedResponse);
        var bytes = Encoding.UTF8.GetBytes(jsonResponse);
        
        context.Response.ContentType = "application/json";
        context.Response.ContentLength = bytes.Length;
        
        await context.Response.Body.WriteAsync(bytes);
    }

    private async Task<string> ReadResponseBody(Stream body)
    {
        body.Seek(0, SeekOrigin.Begin);
        using var reader = new StreamReader(body, Encoding.UTF8, leaveOpen: true);
        return await reader.ReadToEndAsync();
    }
}
```

### è¯·æ±‚é™æµä¸­é—´ä»¶

```csharp
// Platform.ApiService/Middleware/RateLimitingMiddleware.cs
public class RateLimitingMiddleware
{
    private readonly RequestDelegate _next;
    private readonly IMemoryCache _cache;
    private readonly ILogger<RateLimitingMiddleware> _logger;

    public RateLimitingMiddleware(RequestDelegate next, IMemoryCache cache, ILogger<RateLimitingMiddleware> logger)
    {
        _next = next;
        _cache = cache;
        _logger = logger;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        var clientIp = GetClientIp(context);
        var endpoint = $"{context.Request.Method}:{context.Request.Path}";
        var key = $"rate_limit:{clientIp}:{endpoint}";
        
        var requestCount = _cache.GetOrCreate(key, entry =>
        {
            entry.AbsoluteExpirationRelativeToNow = TimeSpan.FromMinutes(1);
            return 0;
        });

        if (requestCount >= 100) // æ¯åˆ†é’Ÿæœ€å¤š100ä¸ªè¯·æ±‚
        {
            _logger.LogWarning("Rate limit exceeded for IP {ClientIp} on endpoint {Endpoint}", 
                clientIp, endpoint);
            
            context.Response.StatusCode = StatusCodes.Status429TooManyRequests;
            context.Response.ContentType = "application/json";
            
            var response = new
            {
                success = false,
                errorMessage = "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•",
                errorCode = "RATE_LIMIT_EXCEEDED",
                showType = 2,
                timestamp = DateTime.UtcNow
            };
            
            await context.Response.WriteAsync(JsonSerializer.Serialize(response));
            return;
        }

        _cache.Set(key, requestCount + 1, TimeSpan.FromMinutes(1));
        
        await _next(context);
    }

    private string GetClientIp(HttpContext context)
    {
        return context.Connection.RemoteIpAddress?.ToString() ?? "unknown";
    }
}
```

## ğŸ¯ ä¸­é—´ä»¶æ³¨å†Œå’Œé…ç½®

### ä¸­é—´ä»¶ç®¡é“é…ç½®

```csharp
// Platform.ApiService/Program.cs
public static void ConfigureMiddlewarePipeline(WebApplication app)
{
    // 1. å¼‚å¸¸å¤„ç†ï¼ˆæœ€å¤–å±‚ï¼‰
    app.UseMiddleware<GlobalExceptionMiddleware>();
    
    // 2. è¯·æ±‚é™æµ
    app.UseMiddleware<RateLimitingMiddleware>();
    
    // 3. è®¤è¯å’Œæˆæƒ
    app.UseAuthentication();
    app.UseAuthorization();
    
    // 4. æ´»åŠ¨æ—¥å¿—è®°å½•
    app.UseMiddleware<ActivityLogMiddleware>();
    
    // 5. CORS
    app.UseCors();
    
    // 6. å“åº”æ ¼å¼åŒ–
    app.UseMiddleware<ResponseFormattingMiddleware>();
    
    // 7. æ§åˆ¶å™¨
    app.MapControllers();
}
```

### ä¸­é—´ä»¶ä¾èµ–æ³¨å…¥

```csharp
// Platform.ApiService/Program.cs
public static void ConfigureServices(IServiceCollection services)
{
    // æ³¨å†Œä¸­é—´ä»¶ä¾èµ–çš„æœåŠ¡
    services.AddScoped<IUserActivityLogService, UserActivityLogService>();  // âœ… æ³¨å†Œæ—¥å¿—æœåŠ¡
    services.AddMemoryCache();
    
    // âš ï¸ æ³¨æ„ï¼šä¸­é—´ä»¶ä¸éœ€è¦æ³¨å†Œä¸ºæœåŠ¡ï¼Œå®ƒä»¬é€šè¿‡ UseMiddleware ç›´æ¥å®ä¾‹åŒ–
    // ActivityLogMiddleware éœ€è¦æ³¨å…¥ IServiceProviderï¼Œé€šè¿‡ä¾èµ–æ³¨å…¥è‡ªåŠ¨æä¾›
}
```

**ä¸­é—´ä»¶æ³¨å†Œæ–¹å¼**ï¼š

```csharp
// Platform.ApiService/Program.cs
public static void ConfigureMiddlewarePipeline(WebApplication app)
{
    // 1. å¼‚å¸¸å¤„ç†ï¼ˆæœ€å¤–å±‚ï¼‰
    app.UseMiddleware<GlobalExceptionMiddleware>();
    
    // 2. è¯·æ±‚é™æµ
    app.UseMiddleware<RateLimitingMiddleware>();
    
    // 3. è®¤è¯å’Œæˆæƒ
    app.UseAuthentication();
    app.UseAuthorization();
    
    // 4. æ´»åŠ¨æ—¥å¿—è®°å½•
    // âœ… UseMiddleware ä¼šè‡ªåŠ¨è§£ææ„é€ å‡½æ•°ä¾èµ–ï¼ˆåŒ…æ‹¬ IServiceProviderï¼‰
    app.UseMiddleware<ActivityLogMiddleware>();
    
    // 5. CORS
    app.UseCors();
    
    // 6. æ§åˆ¶å™¨
    app.MapControllers();
}
```

## ğŸ¯ è‡ªå®šä¹‰ä¸­é—´ä»¶ç‰¹æ€§

### ä¸­é—´ä»¶ç‰¹æ€§

```csharp
// Platform.ApiService/Attributes/SkipMiddlewareAttribute.cs
[AttributeUsage(AttributeTargets.Method | AttributeTargets.Class)]
public class SkipMiddlewareAttribute : Attribute
{
    public Type[] MiddlewareTypes { get; }

    public SkipMiddlewareAttribute(params Type[] middlewareTypes)
    {
        MiddlewareTypes = middlewareTypes;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
[SkipMiddleware(typeof(ActivityLogMiddleware))]
public async Task<IActionResult> HealthCheck()
{
    return Success("OK");
}
```

### ä¸­é—´ä»¶æ¡ä»¶æ‰§è¡Œ

```csharp
// Platform.ApiService/Middleware/ConditionalMiddleware.cs
public class ConditionalMiddleware
{
    private readonly RequestDelegate _next;
    private readonly Func<HttpContext, bool> _condition;

    public ConditionalMiddleware(RequestDelegate next, Func<HttpContext, bool> condition)
    {
        _next = next;
        _condition = condition;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        if (_condition(context))
        {
            await _next(context);
        }
        else
        {
            // è·³è¿‡ä¸­é—´ä»¶å¤„ç†
            await _next(context);
        }
    }
}
```

## ğŸš« ç¦æ­¢çš„åšæ³•

### ä¸è¦å¿½ç•¥å¼‚å¸¸å¤„ç†

```csharp
// âŒ é”™è¯¯ - æ²¡æœ‰å¼‚å¸¸å¤„ç†
public async Task InvokeAsync(HttpContext context)
{
    await _next(context); // å¼‚å¸¸ä¼šç›´æ¥æŠ›å‡º
}

// âœ… æ­£ç¡® - é€‚å½“çš„å¼‚å¸¸å¤„ç†
public async Task InvokeAsync(HttpContext context)
{
    try
    {
        await _next(context);
    }
    catch (Exception ex)
    {
        await HandleExceptionAsync(context, ex);
    }
}
```

### ä¸è¦é˜»å¡è¯·æ±‚ç®¡é“

```csharp
// âŒ é”™è¯¯ - åŒæ­¥æ“ä½œé˜»å¡ç®¡é“
public async Task InvokeAsync(HttpContext context)
{
    var result = _service.DoSomethingSync(); // åŒæ­¥æ“ä½œ
    await _next(context);
}

// âœ… æ­£ç¡® - å¼‚æ­¥æ“ä½œ
public async Task InvokeAsync(HttpContext context)
{
    var result = await _service.DoSomethingAsync(); // å¼‚æ­¥æ“ä½œ
    await _next(context);
}
```

### ä¸è¦å¿½ç•¥æ€§èƒ½å½±å“

```csharp
// âŒ é”™è¯¯ - æ¯æ¬¡è¯·æ±‚éƒ½æ‰§è¡Œé‡æ“ä½œ
public async Task InvokeAsync(HttpContext context)
{
    var data = await _database.GetAllDataAsync(); // æ¯æ¬¡éƒ½æŸ¥è¯¢æ•°æ®åº“
    await _next(context);
}

// âœ… æ­£ç¡® - ä½¿ç”¨ç¼“å­˜æˆ–æ¡ä»¶æ‰§è¡Œ
public async Task InvokeAsync(HttpContext context)
{
    if (ShouldExecute(context))
    {
        var data = await _cache.GetOrCreateAsync("key", async entry =>
        {
            entry.AbsoluteExpirationRelativeToNow = TimeSpan.FromMinutes(5);
            return await _database.GetAllDataAsync();
        });
    }
    await _next(context);
}
```

## ğŸ“‹ ä¸­é—´ä»¶å¼€å‘æ£€æŸ¥æ¸…å•

åˆ›å»ºæˆ–ä¿®æ”¹ä¸­é—´ä»¶æ—¶æ£€æŸ¥ï¼š

- [ ] å®ç°æ­£ç¡®çš„ä¸­é—´ä»¶æ¥å£
- [ ] æ·»åŠ é€‚å½“çš„å¼‚å¸¸å¤„ç†
- [ ] ä½¿ç”¨å¼‚æ­¥æ“ä½œé¿å…é˜»å¡
- [ ] æ·»åŠ æ—¥å¿—è®°å½•
- [ ] è€ƒè™‘æ€§èƒ½å½±å“
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•
- [ ] é…ç½®æ­£ç¡®çš„æ‰§è¡Œé¡ºåº
- [ ] å¤„ç†è¾¹ç•Œæƒ…å†µ
- [ ] æ·»åŠ é…ç½®é€‰é¡¹
- [ ] æ–‡æ¡£åŒ–ä¸­é—´ä»¶åŠŸèƒ½

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å…¨å±€å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶](mdc:Platform.ApiService/Middleware/GlobalExceptionMiddleware.cs)
- [æ´»åŠ¨æ—¥å¿—ä¸­é—´ä»¶](mdc:Platform.ApiService/Middleware/ActivityLogMiddleware.cs)
- [å“åº”æ ¼å¼åŒ–ä¸­é—´ä»¶](mdc:Platform.ApiService/Middleware/ResponseFormattingMiddleware.cs)
- [ASP.NET Core ä¸­é—´ä»¶æ–‡æ¡£](https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/)
