---
description: React Native 和 Expo 移动端开发规范
globs: **/Platform.App/**,**/app/**,**/components/**,**/hooks/**,**/services/**,*.tsx,*.ts,*.js,*.jsx,app.json,expo-env.d.ts
---

# React Native 和 Expo 移动端开发最佳实践

## 🎯 核心原则

**移动端开发需要考虑性能、用户体验和跨平台兼容性**

## 📱 Expo Router 路由系统

### 文件系统路由
```tsx
// ✅ 正确：app/(tabs)/index.tsx - 主页面
import { View, Text, StyleSheet } from 'react-native';
import { useAuth } from '@/contexts/AuthContext';
import { Redirect } from 'expo-router';

export default function HomeScreen() {
  const { user, isLoading } = useAuth();

  if (isLoading) {
    return <LoadingScreen />;
  }

  if (!user) {
    return <Redirect href="/login" />;
  }

  return (
    <View style={styles.container}>
      <Text style={styles.title}>欢迎, {user.username}!</Text>
    </View>
  );
}

// ✅ 正确：app/(tabs)/profile.tsx - 个人资料页面
import { View, Text, TouchableOpacity } from 'react-native';
import { useRouter } from 'expo-router';
import { useAuth } from '@/contexts/AuthContext';

export default function ProfileScreen() {
  const { user, logout } = useAuth();
  const router = useRouter();

  const handleLogout = async () => {
    await logout();
    router.replace('/login');
  };

  return (
    <View style={styles.container}>
      <Text style={styles.username}>{user?.username}</Text>
      <Text style={styles.email}>{user?.email}</Text>
      
      <TouchableOpacity style={styles.logoutButton} onPress={handleLogout}>
        <Text style={styles.logoutText}>退出登录</Text>
      </TouchableOpacity>
    </View>
  );
}
```

### 路由守卫和认证
```tsx
// ✅ 正确：app/_layout.tsx - 根布局
import { Stack } from 'expo-router';
import { AuthProvider } from '@/contexts/AuthContext';
import { ThemeProvider } from '@/contexts/ThemeContext';
import { StatusBar } from 'expo-status-bar';

export default function RootLayout() {
  return (
    <ThemeProvider>
      <AuthProvider>
        <StatusBar style="auto" />
        <Stack screenOptions={{ headerShown: false }}>
          <Stack.Screen name="(tabs)" options={{ headerShown: false }} />
          <Stack.Screen name="login" options={{ title: '登录' }} />
          <Stack.Screen name="register" options={{ title: '注册' }} />
        </Stack>
      </AuthProvider>
    </ThemeProvider>
  );
}

// ✅ 正确：认证守卫组件
import { useEffect } from 'react';
import { useRouter, useSegments } from 'expo-router';
import { useAuth } from '@/contexts/AuthContext';

export function AuthGuard({ children }: { children: React.ReactNode }) {
  const { user, isLoading } = useAuth();
  const router = useRouter();
  const segments = useSegments();

  useEffect(() => {
    if (isLoading) return;

    const inAuthGroup = segments[0] === '(tabs)';

    if (!user && inAuthGroup) {
      router.replace('/login');
    } else if (user && !inAuthGroup) {
      router.replace('/(tabs)');
    }
  }, [user, isLoading, segments]);

  return <>{children}</>;
}
```

## 🎨 主题化和样式

### 主题系统
```tsx
// ✅ 正确：主题上下文
interface Theme {
  colors: {
    primary: string;
    secondary: string;
    background: string;
    surface: string;
    text: string;
    textSecondary: string;
    border: string;
    error: string;
    success: string;
  };
  spacing: {
    xs: number;
    sm: number;
    md: number;
    lg: number;
    xl: number;
  };
  borderRadius: {
    sm: number;
    md: number;
    lg: number;
  };
}

const lightTheme: Theme = {
  colors: {
    primary: '#1890ff',
    secondary: '#722ed1',
    background: '#ffffff',
    surface: '#f5f5f5',
    text: '#262626',
    textSecondary: '#8c8c8c',
    border: '#d9d9d9',
    error: '#ff4d4f',
    success: '#52c41a',
  },
  spacing: { xs: 4, sm: 8, md: 16, lg: 24, xl: 32 },
  borderRadius: { sm: 4, md: 8, lg: 12 },
};

export const ThemeContext = createContext<{
  theme: Theme;
  isDark: boolean;
  toggleTheme: () => void;
}>({
  theme: lightTheme,
  isDark: false,
  toggleTheme: () => {},
});
```

### 样式组件
```tsx
// ✅ 正确：主题化组件
import { View, Text, StyleSheet } from 'react-native';
import { useTheme } from '@/contexts/ThemeContext';

interface CardProps {
  title: string;
  children: React.ReactNode;
}

export function Card({ title, children }: CardProps) {
  const { theme } = useTheme();
  
  return (
    <View style={[styles.card, { backgroundColor: theme.colors.surface }]}>
      <Text style={[styles.title, { color: theme.colors.text }]}>
        {title}
      </Text>
      {children}
    </View>
  );
}

const styles = StyleSheet.create({
  card: {
    padding: 16,
    borderRadius: 8,
    marginVertical: 8,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 3,
  },
  title: {
    fontSize: 18,
    fontWeight: '600',
    marginBottom: 12,
  },
});
```

## 🔄 状态管理

### Context + useReducer 模式
```tsx
// ✅ 正确：认证状态管理
interface AuthState {
  user: User | null;
  isLoading: boolean;
  error: string | null;
}

type AuthAction =
  | { type: 'LOGIN_START' }
  | { type: 'LOGIN_SUCCESS'; payload: User }
  | { type: 'LOGIN_ERROR'; payload: string }
  | { type: 'LOGOUT' }
  | { type: 'CLEAR_ERROR' };

const authReducer = (state: AuthState, action: AuthAction): AuthState => {
  switch (action.type) {
    case 'LOGIN_START':
      return { ...state, isLoading: true, error: null };
    case 'LOGIN_SUCCESS':
      return { ...state, user: action.payload, isLoading: false, error: null };
    case 'LOGIN_ERROR':
      return { ...state, isLoading: false, error: action.payload };
    case 'LOGOUT':
      return { ...state, user: null, isLoading: false, error: null };
    case 'CLEAR_ERROR':
      return { ...state, error: null };
    default:
      return state;
  }
};

export const AuthProvider = ({ children }: { children: React.ReactNode }) => {
  const [state, dispatch] = useReducer(authReducer, {
    user: null,
    isLoading: false,
    error: null,
  });

  const login = async (username: string, password: string) => {
    dispatch({ type: 'LOGIN_START' });
    try {
      const user = await authService.login(username, password);
      dispatch({ type: 'LOGIN_SUCCESS', payload: user });
    } catch (error) {
      dispatch({ type: 'LOGIN_ERROR', payload: error.message });
    }
  };

  const logout = async () => {
    await authService.logout();
    dispatch({ type: 'LOGOUT' });
  };

  return (
    <AuthContext.Provider value={{ ...state, login, logout }}>
      {children}
    </AuthContext.Provider>
  );
};
```

### 自定义 Hooks
```tsx
// ✅ 正确：API 调用 Hook
export function useApi<T>(
  apiCall: () => Promise<T>,
  dependencies: any[] = []
) {
  const [data, setData] = useState<T | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const execute = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      const result = await apiCall();
      setData(result);
    } catch (err) {
      setError(err instanceof Error ? err.message : '未知错误');
    } finally {
      setLoading(false);
    }
  }, dependencies);

  useEffect(() => {
    execute();
  }, [execute]);

  return { data, loading, error, refetch: execute };
}

// ✅ 正确：使用示例
export function UserProfileScreen() {
  const { user } = useAuth();
  const { data: profile, loading, error, refetch } = useApi(
    () => userService.getProfile(user!.id),
    [user?.id]
  );

  if (loading) return <LoadingScreen />;
  if (error) return <ErrorScreen error={error} onRetry={refetch} />;

  return (
    <View>
      <Text>{profile?.username}</Text>
      <Text>{profile?.email}</Text>
    </View>
  );
}
```

## 📊 性能优化

### 列表优化
```tsx
// ✅ 正确：FlatList 性能优化
import { FlatList, ListRenderItem } from 'react-native';

interface User {
  id: string;
  username: string;
  email: string;
}

export function UserList({ users }: { users: User[] }) {
  const renderItem: ListRenderItem<User> = useCallback(({ item }) => (
    <UserItem user={item} />
  ), []);

  const keyExtractor = useCallback((item: User) => item.id, []);

  const getItemLayout = useCallback((data: any, index: number) => ({
    length: 80,
    offset: 80 * index,
    index,
  }), []);

  return (
    <FlatList
      data={users}
      renderItem={renderItem}
      keyExtractor={keyExtractor}
      getItemLayout={getItemLayout}
      removeClippedSubviews={true}
      maxToRenderPerBatch={10}
      windowSize={10}
      initialNumToRender={10}
    />
  );
}

// ✅ 正确：用户项组件优化
const UserItem = React.memo(({ user }: { user: User }) => {
  const { theme } = useTheme();
  
  return (
    <View style={[styles.item, { backgroundColor: theme.colors.surface }]}>
      <Text style={[styles.username, { color: theme.colors.text }]}>
        {user.username}
      </Text>
      <Text style={[styles.email, { color: theme.colors.textSecondary }]}>
        {user.email}
      </Text>
    </View>
  );
});
```

### 图片优化
```tsx
// ✅ 正确：图片懒加载和缓存
import { Image } from 'expo-image';

interface OptimizedImageProps {
  uri: string;
  width: number;
  height: number;
  placeholder?: string;
}

export function OptimizedImage({ uri, width, height, placeholder }: OptimizedImageProps) {
  return (
    <Image
      source={{ uri }}
      style={{ width, height }}
      placeholder={placeholder}
      contentFit="cover"
      transition={200}
      cachePolicy="memory-disk"
    />
  );
}

// ✅ 正确：头像组件
export function Avatar({ uri, size = 40 }: { uri: string; size?: number }) {
  return (
    <OptimizedImage
      uri={uri}
      width={size}
      height={size}
      placeholder="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=="
    />
  );
}
```

## 🔧 平台适配

### 平台特定代码
```tsx
// ✅ 正确：平台检测
import { Platform, StatusBar } from 'react-native';

export function PlatformSpecificComponent() {
  const isIOS = Platform.OS === 'ios';
  const isAndroid = Platform.OS === 'android';

  return (
    <View style={styles.container}>
      {isIOS && <IOSSpecificComponent />}
      {isAndroid && <AndroidSpecificComponent />}
      
      <StatusBar
        barStyle={isIOS ? 'dark-content' : 'light-content'}
        backgroundColor={isAndroid ? '#1890ff' : undefined}
      />
    </View>
  );
}

// ✅ 正确：平台特定样式
const styles = StyleSheet.create({
  container: {
    flex: 1,
    paddingTop: Platform.OS === 'ios' ? 44 : StatusBar.currentHeight,
  },
  button: {
    borderRadius: Platform.OS === 'ios' ? 8 : 4,
    ...Platform.select({
      ios: {
        shadowColor: '#000',
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.1,
        shadowRadius: 4,
      },
      android: {
        elevation: 3,
      },
    }),
  },
});
```

### 设备适配
```tsx
// ✅ 正确：响应式设计
import { Dimensions } from 'react-native';

const { width: screenWidth, height: screenHeight } = Dimensions.get('window');

export function ResponsiveComponent() {
  const isTablet = screenWidth >= 768;
  const isLandscape = screenWidth > screenHeight;

  return (
    <View style={[
      styles.container,
      isTablet && styles.tabletContainer,
      isLandscape && styles.landscapeContainer,
    ]}>
      <Text style={[
        styles.text,
        isTablet && styles.tabletText,
      ]}>
        响应式文本
      </Text>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    padding: 16,
  },
  tabletContainer: {
    padding: 32,
    maxWidth: 600,
    alignSelf: 'center',
  },
  landscapeContainer: {
    flexDirection: 'row',
  },
  text: {
    fontSize: 16,
  },
  tabletText: {
    fontSize: 20,
  },
});
```

## 🧪 测试策略

### 组件测试
```tsx
// ✅ 正确：组件测试
import { render, fireEvent, waitFor } from '@testing-library/react-native';
import { ThemeProvider } from '@/contexts/ThemeContext';
import { LoginScreen } from '../LoginScreen';

const renderWithProviders = (component: React.ReactElement) => {
  return render(
    <ThemeProvider>
      {component}
    </ThemeProvider>
  );
};

describe('LoginScreen', () => {
  it('should render login form', () => {
    const { getByPlaceholderText, getByText } = renderWithProviders(
      <LoginScreen />
    );

    expect(getByPlaceholderText('用户名')).toBeTruthy();
    expect(getByPlaceholderText('密码')).toBeTruthy();
    expect(getByText('登录')).toBeTruthy();
  });

  it('should handle login submission', async () => {
    const mockLogin = jest.fn();
    const { getByPlaceholderText, getByText } = renderWithProviders(
      <LoginScreen onLogin={mockLogin} />
    );

    fireEvent.changeText(getByPlaceholderText('用户名'), 'testuser');
    fireEvent.changeText(getByPlaceholderText('密码'), 'password123');
    fireEvent.press(getByText('登录'));

    await waitFor(() => {
      expect(mockLogin).toHaveBeenCalledWith('testuser', 'password123');
    });
  });
});
```

## 📱 用户体验优化

### 加载状态
```tsx
// ✅ 正确：加载状态管理
export function LoadingScreen() {
  return (
    <View style={styles.container}>
      <ActivityIndicator size="large" color="#1890ff" />
      <Text style={styles.text}>加载中...</Text>
    </View>
  );
}

export function ErrorScreen({ error, onRetry }: { error: string; onRetry: () => void }) {
  return (
    <View style={styles.container}>
      <Text style={styles.errorText}>{error}</Text>
      <TouchableOpacity style={styles.retryButton} onPress={onRetry}>
        <Text style={styles.retryText}>重试</Text>
      </TouchableOpacity>
    </View>
  );
}
```

### 手势和交互
```tsx
// ✅ 正确：下拉刷新
import { RefreshControl } from 'react-native';

export function RefreshableList({ data, onRefresh }: { data: any[]; onRefresh: () => void }) {
  const [refreshing, setRefreshing] = useState(false);

  const handleRefresh = async () => {
    setRefreshing(true);
    await onRefresh();
    setRefreshing(false);
  };

  return (
    <FlatList
      data={data}
      renderItem={renderItem}
      refreshControl={
        <RefreshControl refreshing={refreshing} onRefresh={handleRefresh} />
      }
    />
  );
}
```

## 📋 移动端开发检查清单

### 性能优化
- [ ] 使用 FlatList 优化长列表
- [ ] 实现图片懒加载和缓存
- [ ] 使用 React.memo 优化组件渲染
- [ ] 避免不必要的重新渲染
- [ ] 优化包大小和启动时间

### 用户体验
- [ ] 实现加载状态和错误处理
- [ ] 添加下拉刷新和无限滚动
- [ ] 优化触摸反馈和动画
- [ ] 适配不同屏幕尺寸
- [ ] 支持深色模式

### 平台适配
- [ ] 处理 iOS 和 Android 差异
- [ ] 适配状态栏和导航栏
- [ ] 处理键盘弹出和收起
- [ ] 支持横屏和竖屏切换
- [ ] 处理不同设备性能差异

## 📚 相关资源

- [Expo Router 文档](https://expo.github.io/router/)
- [React Native 性能优化](https://reactnative.dev/docs/performance)
- [Expo 开发指南](https://docs.expo.dev/)
- [React Native 测试指南](https://reactnative.dev/docs/testing-overview)

## 🎯 记住

**移动端开发的核心是性能和用户体验**

- 优先考虑性能优化
- 重视跨平台兼容性
- 关注用户交互体验
- 使用适当的测试策略
- 持续优化和迭代