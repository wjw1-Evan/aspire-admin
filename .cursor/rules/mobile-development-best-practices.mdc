---
description: React Native å’Œ Expo ç§»åŠ¨ç«¯å¼€å‘è§„èŒƒ
globs: **/Platform.App/**,**/app/**,**/components/**,**/hooks/**,**/services/**,*.tsx,*.ts,*.js,*.jsx,app.json,expo-env.d.ts
---

# React Native å’Œ Expo ç§»åŠ¨ç«¯å¼€å‘æœ€ä½³å®è·µ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**ç§»åŠ¨ç«¯å¼€å‘éœ€è¦è€ƒè™‘æ€§èƒ½ã€ç”¨æˆ·ä½“éªŒå’Œè·¨å¹³å°å…¼å®¹æ€§**

## ğŸ“± Expo Router è·¯ç”±ç³»ç»Ÿ

### æ–‡ä»¶ç³»ç»Ÿè·¯ç”±
```tsx
// âœ… æ­£ç¡®ï¼šapp/(tabs)/index.tsx - ä¸»é¡µé¢
import { View, Text, StyleSheet } from 'react-native';
import { useAuth } from '@/contexts/AuthContext';
import { Redirect } from 'expo-router';

export default function HomeScreen() {
  const { user, isLoading } = useAuth();

  if (isLoading) {
    return <LoadingScreen />;
  }

  if (!user) {
    return <Redirect href="/login" />;
  }

  return (
    <View style={styles.container}>
      <Text style={styles.title}>æ¬¢è¿, {user.username}!</Text>
    </View>
  );
}

// âœ… æ­£ç¡®ï¼šapp/(tabs)/profile.tsx - ä¸ªäººèµ„æ–™é¡µé¢
import { View, Text, TouchableOpacity } from 'react-native';
import { useRouter } from 'expo-router';
import { useAuth } from '@/contexts/AuthContext';

export default function ProfileScreen() {
  const { user, logout } = useAuth();
  const router = useRouter();

  const handleLogout = async () => {
    await logout();
    router.replace('/login');
  };

  return (
    <View style={styles.container}>
      <Text style={styles.username}>{user?.username}</Text>
      <Text style={styles.email}>{user?.email}</Text>
      
      <TouchableOpacity style={styles.logoutButton} onPress={handleLogout}>
        <Text style={styles.logoutText}>é€€å‡ºç™»å½•</Text>
      </TouchableOpacity>
    </View>
  );
}
```

### è·¯ç”±å®ˆå«å’Œè®¤è¯
```tsx
// âœ… æ­£ç¡®ï¼šapp/_layout.tsx - æ ¹å¸ƒå±€
import { Stack } from 'expo-router';
import { AuthProvider } from '@/contexts/AuthContext';
import { ThemeProvider } from '@/contexts/ThemeContext';
import { StatusBar } from 'expo-status-bar';

export default function RootLayout() {
  return (
    <ThemeProvider>
      <AuthProvider>
        <StatusBar style="auto" />
        <Stack screenOptions={{ headerShown: false }}>
          <Stack.Screen name="(tabs)" options={{ headerShown: false }} />
          <Stack.Screen name="login" options={{ title: 'ç™»å½•' }} />
          <Stack.Screen name="register" options={{ title: 'æ³¨å†Œ' }} />
        </Stack>
      </AuthProvider>
    </ThemeProvider>
  );
}

// âœ… æ­£ç¡®ï¼šè®¤è¯å®ˆå«ç»„ä»¶
import { useEffect } from 'react';
import { useRouter, useSegments } from 'expo-router';
import { useAuth } from '@/contexts/AuthContext';

export function AuthGuard({ children }: { children: React.ReactNode }) {
  const { user, isLoading } = useAuth();
  const router = useRouter();
  const segments = useSegments();

  useEffect(() => {
    if (isLoading) return;

    const inAuthGroup = segments[0] === '(tabs)';

    if (!user && inAuthGroup) {
      router.replace('/login');
    } else if (user && !inAuthGroup) {
      router.replace('/(tabs)');
    }
  }, [user, isLoading, segments]);

  return <>{children}</>;
}
```

## ğŸ¨ ä¸»é¢˜åŒ–å’Œæ ·å¼

### ä¸»é¢˜ç³»ç»Ÿ
```tsx
// âœ… æ­£ç¡®ï¼šä¸»é¢˜ä¸Šä¸‹æ–‡
interface Theme {
  colors: {
    primary: string;
    secondary: string;
    background: string;
    surface: string;
    text: string;
    textSecondary: string;
    border: string;
    error: string;
    success: string;
  };
  spacing: {
    xs: number;
    sm: number;
    md: number;
    lg: number;
    xl: number;
  };
  borderRadius: {
    sm: number;
    md: number;
    lg: number;
  };
}

const lightTheme: Theme = {
  colors: {
    primary: '#1890ff',
    secondary: '#722ed1',
    background: '#ffffff',
    surface: '#f5f5f5',
    text: '#262626',
    textSecondary: '#8c8c8c',
    border: '#d9d9d9',
    error: '#ff4d4f',
    success: '#52c41a',
  },
  spacing: { xs: 4, sm: 8, md: 16, lg: 24, xl: 32 },
  borderRadius: { sm: 4, md: 8, lg: 12 },
};

export const ThemeContext = createContext<{
  theme: Theme;
  isDark: boolean;
  toggleTheme: () => void;
}>({
  theme: lightTheme,
  isDark: false,
  toggleTheme: () => {},
});
```

### æ ·å¼ç»„ä»¶
```tsx
// âœ… æ­£ç¡®ï¼šä¸»é¢˜åŒ–ç»„ä»¶
import { View, Text, StyleSheet } from 'react-native';
import { useTheme } from '@/contexts/ThemeContext';

interface CardProps {
  title: string;
  children: React.ReactNode;
}

export function Card({ title, children }: CardProps) {
  const { theme } = useTheme();
  
  return (
    <View style={[styles.card, { backgroundColor: theme.colors.surface }]}>
      <Text style={[styles.title, { color: theme.colors.text }]}>
        {title}
      </Text>
      {children}
    </View>
  );
}

const styles = StyleSheet.create({
  card: {
    padding: 16,
    borderRadius: 8,
    marginVertical: 8,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 3,
  },
  title: {
    fontSize: 18,
    fontWeight: '600',
    marginBottom: 12,
  },
});
```

## ğŸ”„ çŠ¶æ€ç®¡ç†

### Context + useReducer æ¨¡å¼
```tsx
// âœ… æ­£ç¡®ï¼šè®¤è¯çŠ¶æ€ç®¡ç†
interface AuthState {
  user: User | null;
  isLoading: boolean;
  error: string | null;
}

type AuthAction =
  | { type: 'LOGIN_START' }
  | { type: 'LOGIN_SUCCESS'; payload: User }
  | { type: 'LOGIN_ERROR'; payload: string }
  | { type: 'LOGOUT' }
  | { type: 'CLEAR_ERROR' };

const authReducer = (state: AuthState, action: AuthAction): AuthState => {
  switch (action.type) {
    case 'LOGIN_START':
      return { ...state, isLoading: true, error: null };
    case 'LOGIN_SUCCESS':
      return { ...state, user: action.payload, isLoading: false, error: null };
    case 'LOGIN_ERROR':
      return { ...state, isLoading: false, error: action.payload };
    case 'LOGOUT':
      return { ...state, user: null, isLoading: false, error: null };
    case 'CLEAR_ERROR':
      return { ...state, error: null };
    default:
      return state;
  }
};

export const AuthProvider = ({ children }: { children: React.ReactNode }) => {
  const [state, dispatch] = useReducer(authReducer, {
    user: null,
    isLoading: false,
    error: null,
  });

  const login = async (username: string, password: string) => {
    dispatch({ type: 'LOGIN_START' });
    try {
      const user = await authService.login(username, password);
      dispatch({ type: 'LOGIN_SUCCESS', payload: user });
    } catch (error) {
      dispatch({ type: 'LOGIN_ERROR', payload: error.message });
    }
  };

  const logout = async () => {
    await authService.logout();
    dispatch({ type: 'LOGOUT' });
  };

  return (
    <AuthContext.Provider value={{ ...state, login, logout }}>
      {children}
    </AuthContext.Provider>
  );
};
```

### è‡ªå®šä¹‰ Hooks
```tsx
// âœ… æ­£ç¡®ï¼šAPI è°ƒç”¨ Hook
export function useApi<T>(
  apiCall: () => Promise<T>,
  dependencies: any[] = []
) {
  const [data, setData] = useState<T | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const execute = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      const result = await apiCall();
      setData(result);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'æœªçŸ¥é”™è¯¯');
    } finally {
      setLoading(false);
    }
  }, dependencies);

  useEffect(() => {
    execute();
  }, [execute]);

  return { data, loading, error, refetch: execute };
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ç¤ºä¾‹
export function UserProfileScreen() {
  const { user } = useAuth();
  const { data: profile, loading, error, refetch } = useApi(
    () => userService.getProfile(user!.id),
    [user?.id]
  );

  if (loading) return <LoadingScreen />;
  if (error) return <ErrorScreen error={error} onRetry={refetch} />;

  return (
    <View>
      <Text>{profile?.username}</Text>
      <Text>{profile?.email}</Text>
    </View>
  );
}
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### åˆ—è¡¨ä¼˜åŒ–
```tsx
// âœ… æ­£ç¡®ï¼šFlatList æ€§èƒ½ä¼˜åŒ–
import { FlatList, ListRenderItem } from 'react-native';

interface User {
  id: string;
  username: string;
  email: string;
}

export function UserList({ users }: { users: User[] }) {
  const renderItem: ListRenderItem<User> = useCallback(({ item }) => (
    <UserItem user={item} />
  ), []);

  const keyExtractor = useCallback((item: User) => item.id, []);

  const getItemLayout = useCallback((data: any, index: number) => ({
    length: 80,
    offset: 80 * index,
    index,
  }), []);

  return (
    <FlatList
      data={users}
      renderItem={renderItem}
      keyExtractor={keyExtractor}
      getItemLayout={getItemLayout}
      removeClippedSubviews={true}
      maxToRenderPerBatch={10}
      windowSize={10}
      initialNumToRender={10}
    />
  );
}

// âœ… æ­£ç¡®ï¼šç”¨æˆ·é¡¹ç»„ä»¶ä¼˜åŒ–
const UserItem = React.memo(({ user }: { user: User }) => {
  const { theme } = useTheme();
  
  return (
    <View style={[styles.item, { backgroundColor: theme.colors.surface }]}>
      <Text style={[styles.username, { color: theme.colors.text }]}>
        {user.username}
      </Text>
      <Text style={[styles.email, { color: theme.colors.textSecondary }]}>
        {user.email}
      </Text>
    </View>
  );
});
```

### å›¾ç‰‡ä¼˜åŒ–
```tsx
// âœ… æ­£ç¡®ï¼šå›¾ç‰‡æ‡’åŠ è½½å’Œç¼“å­˜
import { Image } from 'expo-image';

interface OptimizedImageProps {
  uri: string;
  width: number;
  height: number;
  placeholder?: string;
}

export function OptimizedImage({ uri, width, height, placeholder }: OptimizedImageProps) {
  return (
    <Image
      source={{ uri }}
      style={{ width, height }}
      placeholder={placeholder}
      contentFit="cover"
      transition={200}
      cachePolicy="memory-disk"
    />
  );
}

// âœ… æ­£ç¡®ï¼šå¤´åƒç»„ä»¶
export function Avatar({ uri, size = 40 }: { uri: string; size?: number }) {
  return (
    <OptimizedImage
      uri={uri}
      width={size}
      height={size}
      placeholder="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=="
    />
  );
}
```

## ğŸ”§ å¹³å°é€‚é…

### å¹³å°ç‰¹å®šä»£ç 
```tsx
// âœ… æ­£ç¡®ï¼šå¹³å°æ£€æµ‹
import { Platform, StatusBar } from 'react-native';

export function PlatformSpecificComponent() {
  const isIOS = Platform.OS === 'ios';
  const isAndroid = Platform.OS === 'android';

  return (
    <View style={styles.container}>
      {isIOS && <IOSSpecificComponent />}
      {isAndroid && <AndroidSpecificComponent />}
      
      <StatusBar
        barStyle={isIOS ? 'dark-content' : 'light-content'}
        backgroundColor={isAndroid ? '#1890ff' : undefined}
      />
    </View>
  );
}

// âœ… æ­£ç¡®ï¼šå¹³å°ç‰¹å®šæ ·å¼
const styles = StyleSheet.create({
  container: {
    flex: 1,
    paddingTop: Platform.OS === 'ios' ? 44 : StatusBar.currentHeight,
  },
  button: {
    borderRadius: Platform.OS === 'ios' ? 8 : 4,
    ...Platform.select({
      ios: {
        shadowColor: '#000',
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.1,
        shadowRadius: 4,
      },
      android: {
        elevation: 3,
      },
    }),
  },
});
```

### è®¾å¤‡é€‚é…
```tsx
// âœ… æ­£ç¡®ï¼šå“åº”å¼è®¾è®¡
import { Dimensions } from 'react-native';

const { width: screenWidth, height: screenHeight } = Dimensions.get('window');

export function ResponsiveComponent() {
  const isTablet = screenWidth >= 768;
  const isLandscape = screenWidth > screenHeight;

  return (
    <View style={[
      styles.container,
      isTablet && styles.tabletContainer,
      isLandscape && styles.landscapeContainer,
    ]}>
      <Text style={[
        styles.text,
        isTablet && styles.tabletText,
      ]}>
        å“åº”å¼æ–‡æœ¬
      </Text>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    padding: 16,
  },
  tabletContainer: {
    padding: 32,
    maxWidth: 600,
    alignSelf: 'center',
  },
  landscapeContainer: {
    flexDirection: 'row',
  },
  text: {
    fontSize: 16,
  },
  tabletText: {
    fontSize: 20,
  },
});
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### ç»„ä»¶æµ‹è¯•
```tsx
// âœ… æ­£ç¡®ï¼šç»„ä»¶æµ‹è¯•
import { render, fireEvent, waitFor } from '@testing-library/react-native';
import { ThemeProvider } from '@/contexts/ThemeContext';
import { LoginScreen } from '../LoginScreen';

const renderWithProviders = (component: React.ReactElement) => {
  return render(
    <ThemeProvider>
      {component}
    </ThemeProvider>
  );
};

describe('LoginScreen', () => {
  it('should render login form', () => {
    const { getByPlaceholderText, getByText } = renderWithProviders(
      <LoginScreen />
    );

    expect(getByPlaceholderText('ç”¨æˆ·å')).toBeTruthy();
    expect(getByPlaceholderText('å¯†ç ')).toBeTruthy();
    expect(getByText('ç™»å½•')).toBeTruthy();
  });

  it('should handle login submission', async () => {
    const mockLogin = jest.fn();
    const { getByPlaceholderText, getByText } = renderWithProviders(
      <LoginScreen onLogin={mockLogin} />
    );

    fireEvent.changeText(getByPlaceholderText('ç”¨æˆ·å'), 'testuser');
    fireEvent.changeText(getByPlaceholderText('å¯†ç '), 'password123');
    fireEvent.press(getByText('ç™»å½•'));

    await waitFor(() => {
      expect(mockLogin).toHaveBeenCalledWith('testuser', 'password123');
    });
  });
});
```

## ğŸ“± ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### åŠ è½½çŠ¶æ€
```tsx
// âœ… æ­£ç¡®ï¼šåŠ è½½çŠ¶æ€ç®¡ç†
export function LoadingScreen() {
  return (
    <View style={styles.container}>
      <ActivityIndicator size="large" color="#1890ff" />
      <Text style={styles.text}>åŠ è½½ä¸­...</Text>
    </View>
  );
}

export function ErrorScreen({ error, onRetry }: { error: string; onRetry: () => void }) {
  return (
    <View style={styles.container}>
      <Text style={styles.errorText}>{error}</Text>
      <TouchableOpacity style={styles.retryButton} onPress={onRetry}>
        <Text style={styles.retryText}>é‡è¯•</Text>
      </TouchableOpacity>
    </View>
  );
}
```

### æ‰‹åŠ¿å’Œäº¤äº’
```tsx
// âœ… æ­£ç¡®ï¼šä¸‹æ‹‰åˆ·æ–°
import { RefreshControl } from 'react-native';

export function RefreshableList({ data, onRefresh }: { data: any[]; onRefresh: () => void }) {
  const [refreshing, setRefreshing] = useState(false);

  const handleRefresh = async () => {
    setRefreshing(true);
    await onRefresh();
    setRefreshing(false);
  };

  return (
    <FlatList
      data={data}
      renderItem={renderItem}
      refreshControl={
        <RefreshControl refreshing={refreshing} onRefresh={handleRefresh} />
      }
    />
  );
}
```

## ğŸ“‹ ç§»åŠ¨ç«¯å¼€å‘æ£€æŸ¥æ¸…å•

### æ€§èƒ½ä¼˜åŒ–
- [ ] ä½¿ç”¨ FlatList ä¼˜åŒ–é•¿åˆ—è¡¨
- [ ] å®ç°å›¾ç‰‡æ‡’åŠ è½½å’Œç¼“å­˜
- [ ] ä½¿ç”¨ React.memo ä¼˜åŒ–ç»„ä»¶æ¸²æŸ“
- [ ] é¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“
- [ ] ä¼˜åŒ–åŒ…å¤§å°å’Œå¯åŠ¨æ—¶é—´

### ç”¨æˆ·ä½“éªŒ
- [ ] å®ç°åŠ è½½çŠ¶æ€å’Œé”™è¯¯å¤„ç†
- [ ] æ·»åŠ ä¸‹æ‹‰åˆ·æ–°å’Œæ— é™æ»šåŠ¨
- [ ] ä¼˜åŒ–è§¦æ‘¸åé¦ˆå’ŒåŠ¨ç”»
- [ ] é€‚é…ä¸åŒå±å¹•å°ºå¯¸
- [ ] æ”¯æŒæ·±è‰²æ¨¡å¼

### å¹³å°é€‚é…
- [ ] å¤„ç† iOS å’Œ Android å·®å¼‚
- [ ] é€‚é…çŠ¶æ€æ å’Œå¯¼èˆªæ 
- [ ] å¤„ç†é”®ç›˜å¼¹å‡ºå’Œæ”¶èµ·
- [ ] æ”¯æŒæ¨ªå±å’Œç«–å±åˆ‡æ¢
- [ ] å¤„ç†ä¸åŒè®¾å¤‡æ€§èƒ½å·®å¼‚

## ğŸ“š ç›¸å…³èµ„æº

- [Expo Router æ–‡æ¡£](https://expo.github.io/router/)
- [React Native æ€§èƒ½ä¼˜åŒ–](https://reactnative.dev/docs/performance)
- [Expo å¼€å‘æŒ‡å—](https://docs.expo.dev/)
- [React Native æµ‹è¯•æŒ‡å—](https://reactnative.dev/docs/testing-overview)

## ğŸ¯ è®°ä½

**ç§»åŠ¨ç«¯å¼€å‘çš„æ ¸å¿ƒæ˜¯æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ**

- ä¼˜å…ˆè€ƒè™‘æ€§èƒ½ä¼˜åŒ–
- é‡è§†è·¨å¹³å°å…¼å®¹æ€§
- å…³æ³¨ç”¨æˆ·äº¤äº’ä½“éªŒ
- ä½¿ç”¨é€‚å½“çš„æµ‹è¯•ç­–ç•¥
- æŒç»­ä¼˜åŒ–å’Œè¿­ä»£