---
description: MongoDB åŸå­æ“ä½œæœ€ä½³å®è·µï¼Œé¿å…å¹¶å‘ç«æ€æ¡ä»¶
---
# MongoDB åŸå­æ“ä½œæœ€ä½³å®è·µ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**åœ¨å¹¶å‘åœºæ™¯ä¸‹ï¼Œå§‹ç»ˆä½¿ç”¨ MongoDB çš„åŸå­æ“ä½œï¼Œé¿å…"å…ˆæŸ¥è¯¢å†æ›´æ–°"çš„æ¨¡å¼**

## âœ… åŸå­æ“ä½œæ¨¡å¼

### 1. æ’å…¥æˆ–å¿½ç•¥ï¼ˆInsert or Ignoreï¼‰

```csharp
// âœ… ä½¿ç”¨ try-catch å¤„ç†å”¯ä¸€ç´¢å¼•å†²çª
try
{
    var document = new MyDocument { UniqueField = value };
    await collection.InsertOneAsync(document);
    return (true, document);  // æ’å…¥æˆåŠŸ
}
catch (MongoWriteException ex) when (ex.WriteError?.Category == ServerErrorCategory.DuplicateKey)
{
    // æ–‡æ¡£å·²å­˜åœ¨ï¼Œè·å–ç°æœ‰æ–‡æ¡£
    var existing = await collection.Find(x => x.UniqueField == value).FirstOrDefaultAsync();
    return (false, existing);  // å·²å­˜åœ¨
}

// âŒ é”™è¯¯ï¼šå…ˆæŸ¥è¯¢å†æ’å…¥ï¼ˆæœ‰ç«æ€æ¡ä»¶ï¼‰
var exists = await collection.Find(x => x.UniqueField == value).AnyAsync();
if (!exists)
{
    await collection.InsertOneAsync(new MyDocument { UniqueField = value });
}
```

### 2. æ›´æ–°æˆ–æ’å…¥ï¼ˆUpsertï¼‰

```csharp
// âœ… ä½¿ç”¨ Upsert åŸå­æ“ä½œ
var filter = Builders<MyDocument>.Filter.Eq(x => x.Id, id);
var update = Builders<MyDocument>.Update
    .Set(x => x.Name, newName)
    .Set(x => x.UpdatedAt, DateTime.UtcNow);

var options = new UpdateOptions { IsUpsert = true };
await collection.UpdateOneAsync(filter, update, options);

// âŒ é”™è¯¯ï¼šå…ˆæŸ¥è¯¢å†å†³å®šæ’å…¥æˆ–æ›´æ–°
var doc = await collection.Find(x => x.Id == id).FirstOrDefaultAsync();
if (doc == null)
{
    await collection.InsertOneAsync(new MyDocument { Id = id, Name = newName });
}
else
{
    await collection.UpdateOneAsync(x => x.Id == id, update);
}
```

### 3. æ¡ä»¶æ›´æ–°ï¼ˆCompare-and-Setï¼‰

```csharp
// âœ… ä½¿ç”¨ FindOneAndUpdate åŸå­æ›´æ–°
var filter = Builders<MyDocument>.Filter.And(
    Builders<MyDocument>.Filter.Eq(x => x.Id, id),
    Builders<MyDocument>.Filter.Eq(x => x.Status, "pending")  // åªæ›´æ–° pending çŠ¶æ€çš„
);

var update = Builders<MyDocument>.Update.Set(x => x.Status, "processing");

var options = new FindOneAndUpdateOptions<MyDocument>
{
    ReturnDocument = ReturnDocument.After
};

var result = await collection.FindOneAndUpdateAsync(filter, update, options);
if (result != null)
{
    // æ›´æ–°æˆåŠŸ
    return result;
}
else
{
    // çŠ¶æ€ä¸ç¬¦åˆæˆ–æ–‡æ¡£ä¸å­˜åœ¨
    throw new InvalidOperationException("Document not in expected state");
}

// âŒ é”™è¯¯ï¼šå…ˆæŸ¥è¯¢çŠ¶æ€å†æ›´æ–°
var doc = await collection.Find(x => x.Id == id).FirstOrDefaultAsync();
if (doc?.Status == "pending")
{
    await collection.UpdateOneAsync(
        x => x.Id == id, 
        Builders<MyDocument>.Update.Set(x => x.Status, "processing")
    );
}
```

### 4. åŸå­é€’å¢/é€’å‡

```csharp
// âœ… ä½¿ç”¨ $inc åŸå­æ“ä½œ
var filter = Builders<Counter>.Filter.Eq(x => x.Name, "page-views");
var update = Builders<Counter>.Update.Inc(x => x.Count, 1);

var options = new FindOneAndUpdateOptions<Counter>
{
    IsUpsert = true,
    ReturnDocument = ReturnDocument.After
};

var result = await counters.FindOneAndUpdateAsync(filter, update, options);
return result.Count;

// âŒ é”™è¯¯ï¼šè¯»å–ã€åŠ 1ã€å†™å…¥ï¼ˆéåŸå­ï¼‰
var counter = await counters.Find(x => x.Name == "page-views").FirstOrDefaultAsync();
var newCount = (counter?.Count ?? 0) + 1;
await counters.UpdateOneAsync(
    x => x.Name == "page-views",
    Builders<Counter>.Update.Set(x => x.Count, newCount)
);
```

### 5. æ•°ç»„åŸå­æ“ä½œ

```csharp
// âœ… ä½¿ç”¨ $addToSet æ·»åŠ å”¯ä¸€å…ƒç´ 
var filter = Builders<MyDocument>.Filter.Eq(x => x.Id, id);
var update = Builders<MyDocument>.Update.AddToSet(x => x.Tags, newTag);
await collection.UpdateOneAsync(filter, update);

// âœ… ä½¿ç”¨ $pull åˆ é™¤å…ƒç´ 
var update = Builders<MyDocument>.Update.Pull(x => x.Tags, tagToRemove);
await collection.UpdateOneAsync(filter, update);

// âŒ é”™è¯¯ï¼šè¯»å–æ•°ç»„ã€ä¿®æ”¹ã€å†™å›
var doc = await collection.Find(x => x.Id == id).FirstOrDefaultAsync();
if (!doc.Tags.Contains(newTag))
{
    doc.Tags.Add(newTag);
    await collection.ReplaceOneAsync(x => x.Id == id, doc);
}
```

## ğŸ”’ å”¯ä¸€ç´¢å¼•é…åˆåŸå­æ“ä½œ

### åˆ›å»ºå”¯ä¸€ç´¢å¼•

```csharp
// âœ… ä½¿ç”¨å”¯ä¸€ç´¢å¼•ä¿è¯å”¯ä¸€æ€§
var indexKeys = Builders<MyDocument>.IndexKeys.Ascending(x => x.UniqueField);
var indexOptions = new CreateIndexOptions 
{ 
    Unique = true,
    Name = "idx_uniqueField_unique" 
};

await collection.Indexes.CreateOneAsync(
    new CreateIndexModel<MyDocument>(indexKeys, indexOptions)
);
```

### å¤åˆå”¯ä¸€ç´¢å¼•

```csharp
// âœ… å¤šå­—æ®µç»„åˆå”¯ä¸€
var indexKeys = Builders<MyDocument>.IndexKeys
    .Ascending(x => x.CompanyId)
    .Ascending(x => x.Code);

var indexOptions = new CreateIndexOptions 
{ 
    Unique = true,
    Name = "idx_company_code_unique" 
};

await collection.Indexes.CreateOneAsync(
    new CreateIndexModel<MyDocument>(indexKeys, indexOptions)
);
```

## âš ï¸ å¸¸è§é™·é˜±

### é™·é˜± 1: è®¤ä¸ºæŸ¥è¯¢+æ›´æ–°æ˜¯å®‰å…¨çš„

```csharp
// âŒ å±é™©ï¼šåœ¨å¹¶å‘åœºæ™¯ä¸‹ä¸å®‰å…¨
var user = await users.Find(x => x.Username == username).FirstOrDefaultAsync();
if (user == null)
{
    // ä¸¤ä¸ªè¯·æ±‚å¯èƒ½åŒæ—¶åˆ°è¾¾è¿™é‡Œï¼
    await users.InsertOneAsync(new User { Username = username });
}

// âœ… å®‰å…¨ï¼šä½¿ç”¨åŸå­æ“ä½œ
try
{
    await users.InsertOneAsync(new User { Username = username });
}
catch (MongoWriteException ex) when (ex.WriteError?.Category == ServerErrorCategory.DuplicateKey)
{
    throw new InvalidOperationException("Username already exists");
}
```

### é™·é˜± 2: ä½¿ç”¨é”™è¯¯çš„ Filter æ¡ä»¶

```csharp
// âŒ é”™è¯¯ï¼šé€»è¾‘çŸ›ç›¾çš„ filter
var filter = Builders<Lock>.Filter.Or(
    Builders<Lock>.Filter.Eq(l => l.Name, name) 
        & Builders<Lock>.Filter.Exists(l => l.Id, false),  // âŒ è¿™ä¸¤ä¸ªæ¡ä»¶æ— æ³•åŒæ—¶æ»¡è¶³
    Builders<Lock>.Filter.Lt(l => l.ExpiresAt, now)
);

// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ¸…æ™°çš„é€»è¾‘
var filter = Builders<Lock>.Filter.And(
    Builders<Lock>.Filter.Eq(l => l.Name, name),
    Builders<Lock>.Filter.Lt(l => l.ExpiresAt, now)
);
```

### é™·é˜± 3: å¿˜è®°éªŒè¯æ›´æ–°ç»“æœ

```csharp
// âŒ ä¸å®Œæ•´ï¼šæ²¡æœ‰æ£€æŸ¥æ˜¯å¦çœŸçš„æ›´æ–°äº†
var result = await collection.FindOneAndUpdateAsync(filter, update);
// å¦‚æœ filter æ²¡åŒ¹é…åˆ°æ–‡æ¡£ï¼Œresult æ˜¯ null

// âœ… æ­£ç¡®ï¼šéªŒè¯ç»“æœ
var result = await collection.FindOneAndUpdateAsync(filter, update);
if (result == null)
{
    throw new InvalidOperationException("Document not found or condition not met");
}
return result;
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### æ‰¹é‡æ“ä½œ

```csharp
// âœ… ä½¿ç”¨æ‰¹é‡å†™å…¥
var bulkOps = new List<WriteModel<MyDocument>>();

foreach (var item in items)
{
    var filter = Builders<MyDocument>.Filter.Eq(x => x.Id, item.Id);
    var update = Builders<MyDocument>.Update.Set(x => x.Value, item.Value);
    bulkOps.Add(new UpdateOneModel<MyDocument>(filter, update) { IsUpsert = true });
}

await collection.BulkWriteAsync(bulkOps);

// âŒ ä½æ•ˆï¼šå¾ªç¯ä¸­å•ç‹¬æ›´æ–°
foreach (var item in items)
{
    await collection.UpdateOneAsync(
        x => x.Id == item.Id,
        Builders<MyDocument>.Update.Set(x => x.Value, item.Value)
    );
}
```

### æŠ•å½±ä¼˜åŒ–

```csharp
// âœ… åªè·å–éœ€è¦çš„å­—æ®µ
var projection = Builders<MyDocument>.Projection
    .Include(x => x.Id)
    .Include(x => x.Name)
    .Exclude(x => x.Id);  // æ’é™¤ _idï¼ˆå¦‚æœä¸éœ€è¦ï¼‰

var result = await collection.Find(filter)
    .Project(projection)
    .FirstOrDefaultAsync();

// âŒ è·å–æ•´ä¸ªæ–‡æ¡£ï¼ˆå½“æ–‡æ¡£å¾ˆå¤§æ—¶æµªè´¹å¸¦å®½ï¼‰
var result = await collection.Find(filter).FirstOrDefaultAsync();
```

## ğŸ§ª æµ‹è¯•åŸå­æ€§

### å¹¶å‘æµ‹è¯•ç¤ºä¾‹

```csharp
// æµ‹è¯•åŸå­æ’å…¥
[Fact]
public async Task InsertOne_Should_Be_Atomic_Under_Concurrency()
{
    var tasks = Enumerable.Range(0, 10).Select(async i =>
    {
        try
        {
            await collection.InsertOneAsync(new Document { UniqueField = "test" });
            return true;
        }
        catch (MongoWriteException ex) when (ex.WriteError?.Category == ServerErrorCategory.DuplicateKey)
        {
            return false;
        }
    });

    var results = await Task.WhenAll(tasks);
    
    // åº”è¯¥åªæœ‰ä¸€ä¸ªæˆåŠŸ
    Assert.Single(results.Where(r => r));
    
    // æ•°æ®åº“ä¸­åº”è¯¥åªæœ‰ä¸€æ¡è®°å½•
    var count = await collection.CountDocumentsAsync(x => x.UniqueField == "test");
    Assert.Equal(1, count);
}
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [MongoDB åŸå­æ“ä½œæ–‡æ¡£](https://docs.mongodb.com/manual/core/write-operations-atomicity/)
- [æ•°æ®åˆå§‹åŒ–å¾®æœåŠ¡æ¶æ„](mdc:docs/features/DATA-INITIALIZER-MICROSERVICE.md)
- [DataInitializerService å®ç°](mdc:Platform.DataInitializer/Services/DataInitializerService.cs)

## ğŸ¯ æœ€ä½³å®è·µæ€»ç»“

1. âœ… ä½¿ç”¨ `InsertOne` + try-catch å¤„ç†å”¯ä¸€æ€§
2. âœ… ä½¿ç”¨ `FindOneAndUpdate` å®ç°æ¡ä»¶æ›´æ–°
3. âœ… ä½¿ç”¨å”¯ä¸€ç´¢å¼•å¼ºåˆ¶æ•°æ®å”¯ä¸€æ€§
4. âœ… ä½¿ç”¨ `$inc`ã€`$addToSet`ã€`$pull` ç­‰åŸå­æ“ä½œç¬¦
5. âœ… æ‰¹é‡æ“ä½œä½¿ç”¨ `BulkWriteAsync`
6. âŒ é¿å…"æŸ¥è¯¢+æ›´æ–°"çš„éåŸå­æ¨¡å¼
7. âŒ é¿å…é€»è¾‘çŸ›ç›¾çš„ filter æ¡ä»¶
8. âŒ ä¸è¦å¿˜è®°éªŒè¯æ“ä½œç»“æœ

