---
description: å¤šå®ä¾‹éƒ¨ç½²æ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µ
---
# å¤šå®ä¾‹éƒ¨ç½²æ³¨æ„äº‹é¡¹

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**æ‰€æœ‰ä»£ç éƒ½åº”è¯¥å‡è®¾ä¼šåœ¨å¤šå®ä¾‹ç¯å¢ƒä¸­è¿è¡Œï¼Œç¡®ä¿å¹¶å‘å®‰å…¨å’Œæ•°æ®ä¸€è‡´æ€§**

## âœ… å¤šå®ä¾‹å®‰å…¨çš„å®ç°æ¨¡å¼

### 1. ä½¿ç”¨åˆ†å¸ƒå¼é”ä¿æŠ¤å…³é”®æ“ä½œ

```csharp
// âœ… æ•°æ®åº“åˆå§‹åŒ–ä½¿ç”¨åˆ†å¸ƒå¼é”
await _lockService.ExecuteWithLockAsync("database-initialization", async () =>
{
    await CreateIndexesAsync();
    await SeedDataAsync();
});

// âœ… å®šæ—¶ä»»åŠ¡ä½¿ç”¨åˆ†å¸ƒå¼é”
await _lockService.ExecuteWithLockAsync($"daily-report-{date:yyyy-MM-dd}", async () =>
{
    await GenerateDailyReportAsync(date);
});

// âŒ é”™è¯¯ï¼šå‡è®¾åªæœ‰ä¸€ä¸ªå®ä¾‹è¿è¡Œ
await CreateIndexesAsync();  // å¤šä¸ªå®ä¾‹å¯èƒ½åŒæ—¶åˆ›å»º
await GenerateDailyReportAsync(date);  // å¯èƒ½ç”Ÿæˆé‡å¤æŠ¥è¡¨
```

### 2. é¿å…ä½¿ç”¨å†…å­˜çŠ¶æ€

```csharp
// âŒ é”™è¯¯ï¼šä½¿ç”¨é™æ€å˜é‡å­˜å‚¨çŠ¶æ€ï¼ˆå®ä¾‹é—´ä¸å…±äº«ï¼‰
private static bool _isInitialized = false;

public async Task InitializeAsync()
{
    if (!_isInitialized)
    {
        await DoInitializationAsync();
        _isInitialized = true;  // åªåœ¨å½“å‰å®ä¾‹æœ‰æ•ˆ
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ•°æ®åº“æˆ–ç¼“å­˜å­˜å‚¨çŠ¶æ€
public async Task InitializeAsync()
{
    var initialized = await _database.GetCollection<InitFlag>("init_flags")
        .Find(x => x.Name == "database-initialized")
        .AnyAsync();
        
    if (!initialized)
    {
        await _lockService.ExecuteWithLockAsync("initialization", async () =>
        {
            // åŒé‡æ£€æŸ¥
            if (!await IsInitializedAsync())
            {
                await DoInitializationAsync();
                await MarkAsInitializedAsync();
            }
        });
    }
}
```

### 3. ä½¿ç”¨åŸå­æ“ä½œè€ŒéçŠ¶æ€æ£€æŸ¥

```csharp
// âŒ é”™è¯¯ï¼šæ£€æŸ¥çŠ¶æ€åæ“ä½œï¼ˆæœ‰ç«æ€æ¡ä»¶ï¼‰
var exists = await _collection.Find(x => x.Id == id).AnyAsync();
if (!exists)
{
    await _collection.InsertOneAsync(new Document { Id = id });
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨åŸå­æ“ä½œ
try
{
    await _collection.InsertOneAsync(new Document { Id = id });
}
catch (MongoWriteException ex) when (ex.WriteError?.Category == ServerErrorCategory.DuplicateKey)
{
    // å·²å­˜åœ¨ï¼Œå¤„ç†å†²çª
}
```

### 4. å¹‚ç­‰æ€§è®¾è®¡

```csharp
// âœ… æ‰€æœ‰æ“ä½œéƒ½åº”è¯¥æ˜¯å¹‚ç­‰çš„ï¼ˆå¯ä»¥å®‰å…¨é‡å¤æ‰§è¡Œï¼‰

// ç´¢å¼•åˆ›å»ºæ˜¯å¹‚ç­‰çš„
public async Task CreateIndexesAsync()
{
    try
    {
        await _collection.Indexes.CreateOneAsync(...);
    }
    catch (MongoCommandException ex) when (ex.CodeName == "IndexOptionsConflict")
    {
        // ç´¢å¼•å·²å­˜åœ¨ï¼Œè·³è¿‡
    }
}

// æ•°æ®åˆå§‹åŒ–æ˜¯å¹‚ç­‰çš„
public async Task SeedDataAsync()
{
    var exists = await _collection.Find(x => x.Id == seedId).AnyAsync();
    if (!exists)
    {
        await _collection.InsertOneAsync(seedData);
    }
}
```

## âš ï¸ å¤šå®ä¾‹åœºæ™¯ä¸‹çš„å¸¸è§é—®é¢˜

### é—®é¢˜ 1: é‡å¤çš„å®šæ—¶ä»»åŠ¡

```csharp
// âŒ é”™è¯¯ï¼šæ‰€æœ‰å®ä¾‹éƒ½ä¼šæ‰§è¡Œå®šæ—¶ä»»åŠ¡
public class DailyReportJob : IHostedService
{
    public async Task StartAsync(CancellationToken cancellationToken)
    {
        while (!cancellationToken.IsCancellationRequested)
        {
            await GenerateReportAsync();  // æ‰€æœ‰å®ä¾‹éƒ½æ‰§è¡Œï¼
            await Task.Delay(TimeSpan.FromDays(1), cancellationToken);
        }
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨åˆ†å¸ƒå¼é”
public class DailyReportJob : IHostedService
{
    private readonly IDistributedLockService _lockService;
    
    public async Task StartAsync(CancellationToken cancellationToken)
    {
        while (!cancellationToken.IsCancellationRequested)
        {
            var lockName = $"daily-report-{DateTime.UtcNow:yyyy-MM-dd}";
            
            await _lockService.ExecuteWithLockAsync(lockName, async () =>
            {
                await GenerateReportAsync();  // åªæœ‰ä¸€ä¸ªå®ä¾‹æ‰§è¡Œ
            });
            
            await Task.Delay(TimeSpan.FromDays(1), cancellationToken);
        }
    }
}
```

### é—®é¢˜ 2: å¹¶å‘åˆ›å»ºç›¸åŒèµ„æº

```csharp
// âŒ é”™è¯¯ï¼šå¯èƒ½åˆ›å»ºé‡å¤çš„èµ„æº
public async Task<Company> GetOrCreateCompanyAsync(string code)
{
    var company = await _companies.Find(x => x.Code == code).FirstOrDefaultAsync();
    if (company == null)
    {
        company = new Company { Code = code };
        await _companies.InsertOneAsync(company);  // å¤šä¸ªå®ä¾‹å¯èƒ½åŒæ—¶æ‰§è¡Œ
    }
    return company;
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨åŸå­æ“ä½œ
public async Task<Company> GetOrCreateCompanyAsync(string code)
{
    try
    {
        var company = new Company { Code = code };
        await _companies.InsertOneAsync(company);
        return company;
    }
    catch (MongoWriteException ex) when (ex.WriteError?.Category == ServerErrorCategory.DuplicateKey)
    {
        return await _companies.Find(x => x.Code == code).FirstOrDefaultAsync()
            ?? throw new InvalidOperationException("Company should exist");
    }
}
```

### é—®é¢˜ 3: Session æˆ–ç¼“å­˜ä¸å…±äº«

```csharp
// âŒ é”™è¯¯ï¼šä½¿ç”¨å†…å­˜ç¼“å­˜å­˜å‚¨ä¼šè¯ï¼ˆå®ä¾‹é—´ä¸å…±äº«ï¼‰
private static readonly Dictionary<string, UserSession> _sessions = new();

public void StoreSession(string sessionId, UserSession session)
{
    _sessions[sessionId] = session;  // åªåœ¨å½“å‰å®ä¾‹æœ‰æ•ˆ
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ Redis æˆ–æ•°æ®åº“å­˜å‚¨ä¼šè¯
public async Task StoreSessionAsync(string sessionId, UserSession session)
{
    await _redis.StringSetAsync(
        $"session:{sessionId}", 
        JsonSerializer.Serialize(session),
        TimeSpan.FromHours(1)
    );
}
```

### é—®é¢˜ 4: æ–‡ä»¶ä¸Šä¼ å¤„ç†

```csharp
// âŒ é”™è¯¯ï¼šä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼ˆå®ä¾‹é—´ä¸å…±äº«ï¼‰
public async Task<string> SaveFileAsync(IFormFile file)
{
    var path = Path.Combine("/uploads", file.FileName);
    using var stream = File.Create(path);
    await file.CopyToAsync(stream);
    return path;  // å…¶ä»–å®ä¾‹æ— æ³•è®¿é—®æ­¤æ–‡ä»¶
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å¯¹è±¡å­˜å‚¨æˆ–å…±äº«å­˜å‚¨
public async Task<string> SaveFileAsync(IFormFile file)
{
    using var stream = file.OpenReadStream();
    var blobName = $"{Guid.NewGuid()}/{file.FileName}";
    
    await _blobStorage.UploadAsync(blobName, stream);
    return _blobStorage.GetUrl(blobName);  // æ‰€æœ‰å®ä¾‹éƒ½èƒ½è®¿é—®
}
```

## ğŸ“Š è´Ÿè½½å‡è¡¡è€ƒè™‘

### å¥åº·æ£€æŸ¥ç«¯ç‚¹

```csharp
// âœ… æä¾›å¥åº·æ£€æŸ¥ç«¯ç‚¹
app.MapHealthChecks("/health", new HealthCheckOptions
{
    ResponseWriter = async (context, report) =>
    {
        context.Response.ContentType = "application/json";
        var response = new
        {
            status = report.Status.ToString(),
            checks = report.Entries.Select(e => new
            {
                name = e.Key,
                status = e.Value.Status.ToString(),
                description = e.Value.Description
            })
        };
        await context.Response.WriteAsJsonAsync(response);
    }
});

// æ·»åŠ ä¾èµ–é¡¹å¥åº·æ£€æŸ¥
builder.Services.AddHealthChecks()
    .AddMongoDb(mongoConnectionString, name: "mongodb")
    .AddCheck<CustomHealthCheck>("custom");
```

### ä¼˜é›…å…³é—­

```csharp
// âœ… å¤„ç†ä¼˜é›…å…³é—­ä¿¡å·
public class GracefulShutdownHostedService : IHostedService
{
    private readonly IHostApplicationLifetime _lifetime;
    private readonly ILogger<GracefulShutdownHostedService> _logger;
    
    public GracefulShutdownHostedService(
        IHostApplicationLifetime lifetime,
        ILogger<GracefulShutdownHostedService> logger)
    {
        _lifetime = lifetime;
        _logger = logger;
    }
    
    public Task StartAsync(CancellationToken cancellationToken)
    {
        _lifetime.ApplicationStopping.Register(() =>
        {
            _logger.LogInformation("åº”ç”¨æ­£åœ¨å…³é—­ï¼Œåœæ­¢æ¥å—æ–°è¯·æ±‚...");
            // æ¸…ç†èµ„æº
        });
        
        return Task.CompletedTask;
    }
    
    public Task StopAsync(CancellationToken cancellationToken) => Task.CompletedTask;
}
```

## ğŸ§ª æµ‹è¯•å¤šå®ä¾‹åœºæ™¯

### æœ¬åœ°æµ‹è¯•

```bash
# å¯åŠ¨å¤šä¸ªå®ä¾‹æµ‹è¯•
ASPNETCORE_URLS="http://localhost:5001" dotnet run &
ASPNETCORE_URLS="http://localhost:5002" dotnet run &
ASPNETCORE_URLS="http://localhost:5003" dotnet run &

# è§‚å¯Ÿæ—¥å¿—
tail -f instance-*.log
```

### ä½¿ç”¨æµ‹è¯•è„šæœ¬

```bash
# è¿è¡Œå¹¶å‘å¯åŠ¨æµ‹è¯•
./test-concurrent-startup.sh

# é¢„æœŸç»“æœï¼š
# - åªæœ‰ä¸€ä¸ªå®ä¾‹æ‰§è¡Œåˆå§‹åŒ–
# - å…¶ä»–å®ä¾‹è·³è¿‡åˆå§‹åŒ–
# - æ‰€æœ‰å®ä¾‹æ­£å¸¸è¿è¡Œ
```

## ğŸ“‹ éƒ¨ç½²æ¸…å•

éƒ¨ç½²åˆ°å¤šå®ä¾‹ç¯å¢ƒå‰ï¼Œç¡®ä¿ï¼š

- [ ] æ‰€æœ‰æ•°æ®åº“æ“ä½œä½¿ç”¨åŸå­æ“ä½œ
- [ ] å…³é”®æ“ä½œä½¿ç”¨åˆ†å¸ƒå¼é”ä¿æŠ¤
- [ ] ä¸ä½¿ç”¨å†…å­˜çŠ¶æ€ï¼ˆé™æ€å˜é‡ã€å•ä¾‹ç¼“å­˜ï¼‰
- [ ] å®šæ—¶ä»»åŠ¡ä½¿ç”¨åˆ†å¸ƒå¼é”
- [ ] æ–‡ä»¶ä¸Šä¼ ä½¿ç”¨å¯¹è±¡å­˜å‚¨
- [ ] Session ä½¿ç”¨ Redis æˆ–æ•°æ®åº“
- [ ] é…ç½®å¥åº·æ£€æŸ¥ç«¯ç‚¹
- [ ] å®ç°ä¼˜é›…å…³é—­
- [ ] æ‰€æœ‰æ“ä½œéƒ½æ˜¯å¹‚ç­‰çš„
- [ ] åœ¨å¤šå®ä¾‹ç¯å¢ƒä¸­æµ‹è¯•è¿‡

## ğŸ”§ Kubernetes éƒ¨ç½²ç¤ºä¾‹

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: platform-api
spec:
  replicas: 3  # å¤šå®ä¾‹éƒ¨ç½²
  selector:
    matchLabels:
      app: platform-api
  template:
    metadata:
      labels:
        app: platform-api
    spec:
      containers:
      - name: api
        image: platform-api:latest
        ports:
        - containerPort: 8080
        env:
        - name: ASPNETCORE_URLS
          value: "http://+:8080"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [åˆ†å¸ƒå¼é”ä½¿ç”¨è§„èŒƒ](mdc:.cursor/rules/distributed-lock-usage.mdc)
- [MongoDB åŸå­æ“ä½œ](mdc:.cursor/rules/mongodb-atomic-operations.mdc)
- [æ•°æ®åº“åˆå§‹åŒ–ä¼˜åŒ–](mdc:docs/optimization/DATABASE-INITIALIZATION-OPTIMIZATION.md)
- [åˆ†å¸ƒå¼é”æœåŠ¡](mdc:Platform.ApiService/Services/DistributedLockService.cs)

## ğŸ¯ æ ¸å¿ƒè¦ç‚¹

1. **å‡è®¾å¤šå®ä¾‹è¿è¡Œ**ï¼šä»£ç è®¾è®¡æ—¶å°±è€ƒè™‘å¹¶å‘åœºæ™¯
2. **åˆ†å¸ƒå¼é”ä¿æŠ¤**ï¼šå…³é”®æ“ä½œå¿…é¡»ä½¿ç”¨åˆ†å¸ƒå¼é”
3. **åŸå­æ“ä½œä¼˜å…ˆ**ï¼šé¿å…"æ£€æŸ¥-æ‰§è¡Œ"æ¨¡å¼
4. **æ— çŠ¶æ€è®¾è®¡**ï¼šä¸ä¾èµ–å†…å­˜çŠ¶æ€
5. **å¹‚ç­‰æ€§**ï¼šæ‰€æœ‰æ“ä½œå¯ä»¥å®‰å…¨é‡å¤æ‰§è¡Œ
6. **æµ‹è¯•éªŒè¯**ï¼šåœ¨å¤šå®ä¾‹ç¯å¢ƒä¸­å……åˆ†æµ‹è¯•
