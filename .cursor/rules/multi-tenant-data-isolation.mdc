---
description: å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»å¼€å‘è§„èŒƒå’Œæœ€ä½³å®è·µ
globs: *.cs,Platform.ApiService/**/*
---

# å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»å¼€å‘è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**æ‰€æœ‰ä¸šåŠ¡æ•°æ®å¿…é¡»å½’å±äºç‰¹å®šä¼ä¸šï¼ˆCompanyIdï¼‰ï¼Œç¡®ä¿ä¼ä¸šé—´æ•°æ®å®Œå…¨éš”ç¦»ã€‚**

## ğŸ“‹ å¤šç§Ÿæˆ·å®ä½“ç±»å‹

### 1. MultiTenantEntityï¼ˆæ¨èï¼‰
```csharp
// âœ… æ¨èï¼šä½¿ç”¨ MultiTenantEntity åŸºç±»
public class Menu : MultiTenantEntity, INamedEntity
{
    // CompanyId ç”±åŸºç±»æä¾›
    public string Name { get; set; }
    public string Title { get; set; }
    // ...
}

public class Permission : MultiTenantEntity
{
    // CompanyId ç”±åŸºç±»æä¾›
    public string ResourceName { get; set; }
    public string Action { get; set; }
    // ...
}
```

### 2. æ‰‹åŠ¨æ·»åŠ  CompanyId
```csharp
// âœ… å¯é€‰ï¼šæ‰‹åŠ¨æ·»åŠ  CompanyId å­—æ®µ
public class Role : ISoftDeletable, INamedEntity, ITimestamped
{
    [BsonElement("companyId")]
    public string CompanyId { get; set; } = string.Empty;  // âœ… å¿…é¡»æœ‰
    
    public string Name { get; set; }
    public string Description { get; set; }
    // ...
}
```

## ğŸ”§ Service å±‚å®ç°

### BaseService æä¾›çš„ä¼ä¸šä¸Šä¸‹æ–‡

```csharp
public class MyService : BaseService
{
    public MyService(
        IMongoDatabase database,
        IHttpContextAccessor httpContextAccessor,
        ILogger<MyService> logger)
        : base(database, httpContextAccessor, logger)
    {
    }
    
    // âœ… ä½¿ç”¨åŸºç±»æ–¹æ³•è·å–å½“å‰ä¼ä¸šID
    public async Task<Menu> CreateMenuAsync(CreateMenuRequest request)
    {
        var companyId = GetCurrentCompanyId();  // ä» JWT token è·å–
        
        var menu = new Menu
        {
            Name = request.Name,
            Title = request.Title,
            CompanyId = companyId,  // âœ… è®¾ç½®å½“å‰ä¼ä¸šID
            // ...
        };
        
        await _repository.CreateAsync(menu);
        return menu;
    }
}
```

### æŸ¥è¯¢æ—¶è¿‡æ»¤ä¼ä¸šæ•°æ®

```csharp
// âœ… æ­£ç¡®ï¼šæŸ¥è¯¢æ—¶è¿‡æ»¤ä¼ä¸šæ•°æ®
public async Task<List<Menu>> GetMenusAsync()
{
    var companyId = GetCurrentCompanyId();
    
    var filter = Builders<Menu>.Filter.And(
        Builders<Menu>.Filter.Eq(m => m.CompanyId, companyId),
        SoftDeleteExtensions.NotDeleted<Menu>()
    );
    
    return await _menus.Find(filter).ToListAsync();
}

// âŒ é”™è¯¯ï¼šä¸è¿‡æ»¤ä¼ä¸šï¼Œä¼šæ³„éœ²å…¶ä»–ä¼ä¸šæ•°æ®
public async Task<List<Menu>> GetMenusAsync()
{
    return await _menus.Find(_ => true).ToListAsync();  // âŒ å±é™©ï¼
}
```

### MultiTenantRepository è‡ªåŠ¨è¿‡æ»¤

```csharp
// âœ… æ¨èï¼šä½¿ç”¨ MultiTenantRepository
public class MenuService : BaseService
{
    private readonly MultiTenantRepository<Menu> _repository;
    
    public MenuService(
        IMongoDatabase database,
        IHttpContextAccessor httpContextAccessor,
        ILogger<MenuService> logger)
        : base(database, httpContextAccessor, logger)
    {
        _repository = new MultiTenantRepository<Menu>(
            database, 
            "menus", 
            httpContextAccessor
        );
    }
    
    // âœ… Repository è‡ªåŠ¨è¿‡æ»¤ä¼ä¸šæ•°æ®
    public async Task<List<Menu>> GetMenusAsync()
    {
        return await _repository.GetAllAsync();  // è‡ªåŠ¨è¿‡æ»¤ CompanyId
    }
}
```

## ğŸš« å¸¸è§é”™è¯¯

### âŒ é”™è¯¯ 1: åˆ›å»ºæ•°æ®æ—¶ä¸è®¾ç½® CompanyId
```csharp
// âŒ é”™è¯¯
var menu = new Menu
{
    Name = "dashboard",
    Title = "ä»ªè¡¨æ¿"
    // âŒ ç¼ºå°‘ CompanyId
};

// âœ… æ­£ç¡®
var menu = new Menu
{
    Name = "dashboard",
    Title = "ä»ªè¡¨æ¿",
    CompanyId = GetCurrentCompanyId()  // âœ… è®¾ç½®ä¼ä¸šID
};
```

### âŒ é”™è¯¯ 2: æŸ¥è¯¢æ—¶ä¸è¿‡æ»¤ä¼ä¸š
```csharp
// âŒ é”™è¯¯ï¼šä¼šè¿”å›æ‰€æœ‰ä¼ä¸šçš„æ•°æ®
var allMenus = await _menus.Find(_ => true).ToListAsync();

// âœ… æ­£ç¡®ï¼šåªè¿”å›å½“å‰ä¼ä¸šçš„æ•°æ®
var companyMenus = await _menus.Find(m => 
    m.CompanyId == GetCurrentCompanyId() && 
    !m.IsDeleted
).ToListAsync();
```

### âŒ é”™è¯¯ 3: è·¨ä¼ä¸šæ•°æ®è®¿é—®
```csharp
// âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨å…¶ä»–ä¼ä¸šçš„æ•°æ®ID
var menu = await _menus.Find(m => m.Id == menuId).FirstOrDefaultAsync();

// âœ… æ­£ç¡®ï¼šéªŒè¯æ•°æ®å½’å±
var menu = await _menus.Find(m => 
    m.Id == menuId && 
    m.CompanyId == GetCurrentCompanyId()
).FirstOrDefaultAsync();
```

### âŒ é”™è¯¯ 4: åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶åˆ›å»ºå…¨å±€æ•°æ®
```csharp
// âŒ é”™è¯¯ï¼šProgram.cs ä¸­åˆ›å»ºå…¨å±€æ•°æ®
var initialMenuData = new InitialMenuData(database);
await initialMenuData.InitializeAsync();  // åˆ›å»ºçš„æ•°æ®æ²¡æœ‰ CompanyId

// âœ… æ­£ç¡®ï¼šåœ¨ç”¨æˆ·æ³¨å†Œæ—¶åˆ›å»ºä¼ä¸šä¸“å±æ•°æ®
// å‚è€ƒï¼šAuthService.CreatePersonalCompanyAsync()
```

## âœ… æœ€ä½³å®è·µ

### 1. ä½¿ç”¨ MultiTenantEntity åŸºç±»
```csharp
public class Notice : MultiTenantEntity
{
    // CompanyId è‡ªåŠ¨ç»§æ‰¿
    public string Title { get; set; }
    public string Content { get; set; }
}
```

### 2. ä½¿ç”¨ MultiTenantRepository
```csharp
private readonly MultiTenantRepository<Notice> _repository;

public NoticeService(
    IMongoDatabase database,
    IHttpContextAccessor httpContextAccessor,
    ILogger<NoticeService> logger)
    : base(database, httpContextAccessor, logger)
{
    _repository = new MultiTenantRepository<Notice>(
        database, 
        "notices", 
        httpContextAccessor
    );
}

// âœ… è‡ªåŠ¨è¿‡æ»¤ä¼ä¸šæ•°æ®
public async Task<List<Notice>> GetNoticesAsync()
{
    return await _repository.GetAllAsync();
}
```

### 3. åˆ›å»ºæ•°æ®æ—¶è‡ªåŠ¨è®¾ç½® CompanyId
```csharp
public async Task<Notice> CreateNoticeAsync(CreateNoticeRequest request)
{
    var notice = new Notice
    {
        Title = request.Title,
        Content = request.Content,
        // CompanyId ç”± Repository è‡ªåŠ¨è®¾ç½®ï¼ˆé€šè¿‡ HttpContextï¼‰
    };
    
    return await _repository.CreateAsync(notice);
}
```

### 4. è·¨ä¼ä¸šæ“ä½œæ—¶æ˜ç¡®æŒ‡å®š
```csharp
// âœ… è¶…çº§ç®¡ç†å‘˜æŸ¥çœ‹æ‰€æœ‰ä¼ä¸šæ•°æ®ï¼ˆæ˜ç¡®æƒé™æ£€æŸ¥ï¼‰
public async Task<List<Menu>> GetAllCompanyMenusAsync()
{
    // 1. éªŒè¯è¶…çº§ç®¡ç†å‘˜æƒé™
    await RequirePermissionAsync("system", "admin");
    
    // 2. æ˜ç¡®è¯´æ˜æ˜¯è·¨ä¼ä¸šæŸ¥è¯¢
    var filter = SoftDeleteExtensions.NotDeleted<Menu>();
    return await _menus.Find(filter).ToListAsync();
}
```

## ğŸ” æ•°æ®éš”ç¦»éªŒè¯

### æ£€æŸ¥æ•°æ®å½’å±
```csharp
public async Task<bool> ValidateMenuOwnershipAsync(string menuId)
{
    var companyId = GetCurrentCompanyId();
    var menu = await _menus.Find(m => 
        m.Id == menuId && 
        m.CompanyId == companyId &&
        !m.IsDeleted
    ).FirstOrDefaultAsync();
    
    return menu != null;
}
```

### æ•°æ®åº“æŸ¥è¯¢éªŒè¯
```javascript
// æ£€æŸ¥æ˜¯å¦æœ‰å­¤å„¿æ•°æ®
db.menus.find({ companyId: { $exists: false } })
db.menus.find({ companyId: "" })
db.menus.find({ companyId: null })

// æ£€æŸ¥ä¼ä¸šæ•°æ®éš”ç¦»
db.menus.find({ companyId: "ä¼ä¸šAçš„ID" })  // åªè¿”å›ä¼ä¸šAçš„èœå•
db.menus.find({ companyId: "ä¼ä¸šBçš„ID" })  // åªè¿”å›ä¼ä¸šBçš„èœå•
```

## ğŸ“‹ ä»£ç å®¡æŸ¥æ¸…å•

å¼€å‘å¤šç§Ÿæˆ·åŠŸèƒ½æ—¶ï¼Œç¡®ä¿ï¼š

- [ ] å®ä½“ç»§æ‰¿ `MultiTenantEntity` æˆ–æ‰‹åŠ¨æ·»åŠ  `CompanyId`
- [ ] Service ç»§æ‰¿ `BaseService`
- [ ] ä½¿ç”¨ `MultiTenantRepository` æˆ–æ‰‹åŠ¨è¿‡æ»¤ `CompanyId`
- [ ] åˆ›å»ºæ•°æ®æ—¶è®¾ç½® `CompanyId`
- [ ] æŸ¥è¯¢æ•°æ®æ—¶è¿‡æ»¤ `CompanyId`
- [ ] æ›´æ–°/åˆ é™¤æ•°æ®æ—¶éªŒè¯ `CompanyId`
- [ ] ä¸åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶åˆ›å»ºå…¨å±€æ•°æ®
- [ ] è·¨ä¼ä¸šæ“ä½œæ—¶æ˜ç¡®æƒé™æ£€æŸ¥

## ğŸ¯ æ ¸å¿ƒæ¶æ„

```
ç”¨æˆ·è¯·æ±‚ â†’ JWT Token (å« CompanyId) â†’ BaseService
    â†“
MultiTenantRepository
    â†“
è‡ªåŠ¨è¿‡æ»¤ CompanyId â†’ åªè¿”å›å½“å‰ä¼ä¸šæ•°æ®
```

## ğŸ“š å‚è€ƒå®ç°

- [MultiTenantEntity åŸºç±»](mdc:Platform.ApiService/Models/BaseEntity.cs)
- [MultiTenantRepository](mdc:Platform.ApiService/Services/MultiTenantRepository.cs)
- [BaseService](mdc:Platform.ApiService/Services/BaseService.cs)
- [AuthService æ³¨å†Œæµç¨‹](mdc:Platform.ApiService/Services/AuthService.cs)
- [å¤šç§Ÿæˆ·ç³»ç»Ÿæ–‡æ¡£](mdc:docs/features/MULTI-TENANT-SYSTEM.md)

## ğŸ¯ æ ¸å¿ƒåŸåˆ™é‡ç”³

1. **ä¼ä¸šéš”ç¦»** - æ‰€æœ‰æ•°æ®éƒ½æœ‰ CompanyId
2. **è‡ªåŠ¨è¿‡æ»¤** - ä½¿ç”¨ MultiTenantRepository è‡ªåŠ¨è¿‡æ»¤
3. **å®‰å…¨éªŒè¯** - è·¨ä¼ä¸šæ“ä½œæ—¶éªŒè¯æƒé™
4. **æ— å…¨å±€æ•°æ®** - ç¦æ­¢åˆ›å»ºæ²¡æœ‰ CompanyId çš„æ•°æ®
5. **ç”¨æˆ·æ³¨å†Œåˆ›å»º** - æ•°æ®åœ¨ç”¨æˆ·æ³¨å†Œæ—¶è‡ªåŠ¨åˆ›å»º

éµå¾ªè¿™äº›è§„èŒƒï¼Œç¡®ä¿å¤šç§Ÿæˆ·ç³»ç»Ÿçš„æ•°æ®å®‰å…¨å’Œéš”ç¦»ï¼
