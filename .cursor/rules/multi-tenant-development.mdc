---
globs: Platform.ApiService/Services/*.cs,Platform.ServiceDefaults/Services/*.cs
description: å¤šç§Ÿæˆ·ç³»ç»Ÿå¼€å‘è§„èŒƒå’Œæœ€ä½³å®è·µ
---
# å¤šç§Ÿæˆ·ç³»ç»Ÿå¼€å‘è§„èŒƒå’Œæœ€ä½³å®è·µ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

### ç¡®ä¿æ•°æ®éš”ç¦»ã€æƒé™æ§åˆ¶å’Œç§Ÿæˆ·ä¸Šä¸‹æ–‡ç®¡ç†ï¼Œæ„å»ºå®‰å…¨å¯é çš„å¤šç§Ÿæˆ·ç³»ç»Ÿ

## âœ… å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»

### æ•°æ®æ¨¡å‹è®¾è®¡

```csharp
// âœ… æ­£ç¡® - å•ä¸€ä¼ä¸šå…³è”çš„å¤šç§Ÿæˆ·å®ä½“ï¼ˆRole, Notice, Tag ç­‰ï¼‰
public class Role : BaseEntity, IEntity, ISoftDeletable, ITimestamped, IMultiTenant
{
    [BsonId]
    [BsonRepresentation(BsonType.ObjectId)]
    public string Id { get; set; } = string.Empty;

    [BsonElement("companyId")]
    public string CompanyId { get; set; } = string.Empty; // âœ… å¤šç§Ÿæˆ·å­—æ®µï¼ˆå¿…é¡»éç©ºï¼‰

    [BsonElement("name")]
    public string Name { get; set; } = string.Empty;

    [BsonElement("description")]
    public string Description { get; set; } = string.Empty;

    [BsonElement("isDeleted")]
    public bool IsDeleted { get; set; } = false;

    [BsonElement("createdAt")]
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;

    [BsonElement("updatedAt")]
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
}

// âœ… æ­£ç¡® - å¤šä¼ä¸šå…³è”çš„å®ä½“ï¼ˆAppUser ä½¿ç”¨ CurrentCompanyIdï¼‰
public class AppUser : BaseEntity, IEntity, ISoftDeletable, ITimestamped
{
    [BsonId]
    [BsonRepresentation(BsonType.ObjectId)]
    public string Id { get; set; } = string.Empty;

    [BsonElement("username")]
    public string Username { get; set; } = string.Empty;

    [BsonElement("email")]
    public string Email { get; set; } = string.Empty;

    /// <summary>
    /// å½“å‰é€‰ä¸­çš„ä¼ä¸šIDï¼ˆç”¨äºæ•°æ®éš”ç¦»å’Œèœå•æƒé™ï¼‰
    /// </summary>
    [BsonElement("currentCompanyId")]
    public string? CurrentCompanyId { get; set; }

    /// <summary>
    /// ä¸ªäººä¼ä¸šIDï¼ˆæ³¨å†Œæ—¶è‡ªåŠ¨åˆ›å»ºï¼‰
    /// </summary>
    [BsonElement("personalCompanyId")]
    public string? PersonalCompanyId { get; set; }

    // âŒ æ²¡æœ‰ CompanyId å­—æ®µ
    // é€šè¿‡ UserCompany ä¸­é—´è¡¨ç®¡ç†å¤šå¯¹å¤šå…³ç³»

    [BsonElement("isDeleted")]
    public bool IsDeleted { get; set; } = false;

    [BsonElement("createdAt")]
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;

    [BsonElement("updatedAt")]
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
}

// âœ… æ­£ç¡® - å¤šç§Ÿæˆ·æ¥å£
public interface IMultiTenant
{
    string CompanyId { get; set; }  // å¿…é¡»éç©º
}

// âŒ é”™è¯¯ - AppUser ä¸åº”è¯¥å®ç° IMultiTenant
public class AppUser : BaseEntity, IMultiTenant
{
    // âŒ AppUser ä¸åº”è¯¥å®ç° IMultiTenantï¼Œåº”è¯¥ä½¿ç”¨ CurrentCompanyId
}
```

### æ•°æ®åº“æ“ä½œå·¥å‚å¤šç§Ÿæˆ·æ”¯æŒ

```csharp
// âœ… æ­£ç¡® - è‡ªåŠ¨å¤šç§Ÿæˆ·è¿‡æ»¤
public class DatabaseOperationFactory<T> : IDatabaseOperationFactory<T> where T : class, IEntity, ISoftDeletable, ITimestamped
{
    private readonly IMongoCollection<T> _collection;
    private readonly ITenantContext _tenantContext;

    public DatabaseOperationFactory(
        IMongoCollection<T> collection,
        ITenantContext tenantContext)
    {
        _collection = collection;
        _tenantContext = tenantContext;
    }

    public async Task<List<T>> FindAsync(FilterDefinition<T>? filter = null, SortDefinition<T>? sort = null, int? limit = null)
    {
        // è‡ªåŠ¨æ·»åŠ å¤šç§Ÿæˆ·è¿‡æ»¤
        var multiTenantFilter = CreateMultiTenantFilter();
        
        if (filter != null)
        {
            multiTenantFilter = Builders<T>.Filter.And(multiTenantFilter, filter);
        }

        var query = _collection.Find(multiTenantFilter);
        
        if (sort != null)
        {
            query = query.Sort(sort);
        }
        
        if (limit.HasValue)
        {
            query = query.Limit(limit.Value);
        }

        return await query.ToListAsync();
    }

    public async Task<T?> GetByIdAsync(string id)
    {
        var filter = Builders<T>.Filter.And(
            Builders<T>.Filter.Eq(x => x.Id, id),
            CreateMultiTenantFilter()
        );

        return await _collection.Find(filter).FirstOrDefaultAsync();
    }

    public async Task<long> CountAsync(FilterDefinition<T>? filter = null)
    {
        var multiTenantFilter = CreateMultiTenantFilter();
        
        if (filter != null)
        {
            multiTenantFilter = Builders<T>.Filter.And(multiTenantFilter, filter);
        }

        return await _collection.CountDocumentsAsync(multiTenantFilter);
    }

    /// <summary>
    /// åˆ›å»ºå¤šç§Ÿæˆ·è¿‡æ»¤å™¨ï¼ˆå·²ä¿®å¤ï¼šä»æ•°æ®åº“è¯»å–ä¼ä¸šIDï¼Œä½¿ç”¨æ­£ç¡®çš„MongoDBå­—æ®µåï¼‰
    /// </summary>
    private FilterDefinition<T> CreateMultiTenantFilter()
    {
        // âœ… ä»æ•°æ®åº“è¯»å–å½“å‰ç”¨æˆ·çš„ CurrentCompanyIdï¼ˆä¸ä½¿ç”¨ JWT tokenï¼‰
        var userId = _tenantContext.GetCurrentUserId();
        if (string.IsNullOrEmpty(userId))
        {
            throw new UnauthorizedAccessException("æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯");
        }
        
        // ä» users é›†åˆè¯»å– currentCompanyId
        var users = _database.GetCollection<BsonDocument>("users");
        var doc = users.Find(...).Project(...).FirstOrDefault();
        var companyId = doc?.GetValue("currentCompanyId", BsonNull.Value);
        
        if (string.IsNullOrEmpty(companyId?.AsString))
        {
            throw new UnauthorizedAccessException("æœªæ‰¾åˆ°ä¼ä¸šä¿¡æ¯");
        }

        // âœ… ä½¿ç”¨æ­£ç¡®çš„ MongoDB å­—æ®µåï¼ˆä» BsonElement ç‰¹æ€§è·å–ï¼‰
        var companyIdProperty = typeof(T).GetProperty("CompanyId");
        var bsonElementAttr = companyIdProperty?.GetCustomAttribute<Bson.Serialization.Attributes.BsonElementAttribute>();
        var fieldName = bsonElementAttr?.ElementName ?? "companyId";  // ç»Ÿä¸€ä½¿ç”¨å°å†™ camelCase
        
        // åªè¿”å›å½“å‰ä¼ä¸šçš„æ•°æ®
        return Builders<T>.Filter.Eq(fieldName, companyId.AsString);
    }

    // è·¨ç§Ÿæˆ·æŸ¥è¯¢æ–¹æ³•ï¼ˆç‰¹æ®Šåœºæ™¯ä½¿ç”¨ï¼‰
    public async Task<List<T>> FindWithoutTenantFilterAsync(FilterDefinition<T>? filter = null, SortDefinition<T>? sort = null, int? limit = null)
    {
        var query = _collection.Find(filter ?? Builders<T>.Filter.Empty);
        
        if (sort != null)
        {
            query = query.Sort(sort);
        }
        
        if (limit.HasValue)
        {
            query = query.Limit(limit.Value);
        }

        return await query.ToListAsync();
    }

    public async Task<T?> GetByIdWithoutTenantFilterAsync(string id)
    {
        var filter = Builders<T>.Filter.Eq(x => x.Id, id);
        return await _collection.Find(filter).FirstOrDefaultAsync();
    }
}

// âŒ é”™è¯¯ - æ²¡æœ‰å¤šç§Ÿæˆ·è¿‡æ»¤
public class DatabaseOperationFactory<T> : IDatabaseOperationFactory<T> where T : class, IEntity, ISoftDeletable, ITimestamped
{
    public async Task<List<T>> FindAsync(FilterDefinition<T>? filter = null, SortDefinition<T>? sort = null, int? limit = null)
    {
        // æ²¡æœ‰å¤šç§Ÿæˆ·è¿‡æ»¤ï¼Œå¯èƒ½è¿”å›å…¶ä»–ä¼ä¸šçš„æ•°æ®
        var query = _collection.Find(filter ?? Builders<T>.Filter.Empty);
        return await query.ToListAsync();
    }
}
```

### ç§Ÿæˆ·ä¸Šä¸‹æ–‡ç®¡ç†

```csharp
// âœ… æ­£ç¡® - ç§Ÿæˆ·ä¸Šä¸‹æ–‡æœåŠ¡
public interface ITenantContext
{
    string? GetCurrentUserId();
    string? GetCurrentUsername();
    string? GetCurrentCompanyId();
    string GetRequiredUserId();
    string GetRequiredCompanyId();
}

public class TenantContext : ITenantContext
{
    private readonly IHttpContextAccessor _httpContextAccessor;

    public TenantContext(IHttpContextAccessor httpContextAccessor)
    {
        _httpContextAccessor = httpContextAccessor;
    }

    public string? GetCurrentUserId()
    {
        return _httpContextAccessor.HttpContext?.User?.FindFirst("userId")?.Value;
    }

    public string? GetCurrentUsername()
    {
        return _httpContextAccessor.HttpContext?.User?.FindFirst("username")?.Value;
    }

    public string? GetCurrentCompanyId()
    {
        return _httpContextAccessor.HttpContext?.User?.FindFirst("companyId")?.Value;
    }

    public string GetRequiredUserId()
    {
        var userId = GetCurrentUserId();
        if (string.IsNullOrEmpty(userId))
        {
            throw new UnauthorizedAccessException("æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯");
        }
        return userId;
    }

    public string GetRequiredCompanyId()
    {
        var companyId = GetCurrentCompanyId();
        if (string.IsNullOrEmpty(companyId))
        {
            throw new UnauthorizedAccessException("æœªæ‰¾åˆ°ä¼ä¸šä¿¡æ¯");
        }
        return companyId;
    }
}

// âœ… æ­£ç¡® - æœåŠ¡ä¸­ä½¿ç”¨ç§Ÿæˆ·ä¸Šä¸‹æ–‡ï¼ˆå•ä¸€ä¼ä¸šå®ä½“ç¤ºä¾‹ï¼šRoleï¼‰
public class RoleService : IRoleService
{
    private readonly IDatabaseOperationFactory<Role> _roleFactory;
    private readonly ITenantContext _tenantContext;

    public RoleService(
        IDatabaseOperationFactory<Role> roleFactory,
        ITenantContext tenantContext)
    {
        _roleFactory = roleFactory;
        _tenantContext = tenantContext;
    }

    public async Task<Role> CreateRoleAsync(CreateRoleRequest request)
    {
        // è·å–å½“å‰ä¼ä¸šID
        var companyId = _tenantContext.GetRequiredCompanyId();
        var userId = _tenantContext.GetRequiredUserId();

        var role = new Role
        {
            Name = request.Name,
            Description = request.Description,
            CompanyId = companyId, // âœ… è®¾ç½®ä¼ä¸šIDï¼ˆå•ä¸€ä¼ä¸šå®ä½“ï¼‰
            CreatedAt = DateTime.UtcNow
        };

        return await _roleFactory.CreateAsync(role);
    }

    public async Task<List<Role>> GetRolesAsync(RoleListRequest request)
    {
        var filterBuilder = _roleFactory.CreateFilterBuilder();

        // âœ… æ•°æ®å·¥å‚ä¼šè‡ªåŠ¨æ·»åŠ ä¼ä¸šè¿‡æ»¤ï¼ˆå› ä¸º Role å®ç°äº† IMultiTenantï¼‰
        // åªæ·»åŠ ä¸šåŠ¡è¿‡æ»¤æ¡ä»¶
        if (!string.IsNullOrEmpty(request.Keyword))
        {
            filterBuilder.Regex(r => r.Name, request.Keyword);
        }

        var filter = filterBuilder.Build();
        var sort = _roleFactory.CreateSortBuilder()
            .Descending(r => r.CreatedAt)
            .Build();

        // âœ… æ•°æ®å·¥å‚ä¼šè‡ªåŠ¨æ·»åŠ ä¼ä¸šè¿‡æ»¤
        return await _roleFactory.FindAsync(filter, sort, request.Limit);
    }
}

// âœ… æ­£ç¡® - AppUser æœåŠ¡ï¼ˆå¤šä¼ä¸šå®ä½“ï¼Œä½¿ç”¨ CurrentCompanyIdï¼‰
public class UserService : IUserService
{
    private readonly IDatabaseOperationFactory<AppUser> _userFactory;
    private readonly ITenantContext _tenantContext;

    public UserService(
        IDatabaseOperationFactory<AppUser> userFactory,
        ITenantContext tenantContext)
    {
        _userFactory = userFactory;
        _tenantContext = tenantContext;
    }

    public async Task<AppUser> CreateUserAsync(CreateUserRequest request)
    {
        var companyId = _tenantContext.GetRequiredCompanyId();

        var user = new AppUser
        {
            Username = request.Username,
            Email = request.Email,
            CurrentCompanyId = companyId, // âœ… ä½¿ç”¨ CurrentCompanyIdï¼ˆå¤šä¼ä¸šå®ä½“ï¼‰
            CreatedAt = DateTime.UtcNow
        };

        return await _userFactory.CreateAsync(user);
    }

    public async Task<List<AppUser>> GetUsersAsync(UserListRequest request)
    {
        // âœ… æ‰‹åŠ¨æ·»åŠ  CurrentCompanyId è¿‡æ»¤ï¼ˆAppUser ä¸å®ç° IMultiTenantï¼‰
        var currentCompanyId = _tenantContext.GetRequiredCompanyId();
        var filter = _userFactory.CreateFilterBuilder()
            .Equal(u => u.CurrentCompanyId, currentCompanyId)  // âœ… æ‰‹åŠ¨æ·»åŠ è¿‡æ»¤
            .Build();

        if (!string.IsNullOrEmpty(request.Keyword))
        {
            var searchFilter = _userFactory.CreateFilterBuilder()
                .Regex(u => u.Username, request.Keyword)
                .Or()
                .Regex(u => u.Email, request.Keyword)
                .Build();
            
            filter = _userFactory.CreateFilterBuilder()
                .And(filter)
                .And(searchFilter)
                .Build();
        }

        var sort = _userFactory.CreateSortBuilder()
            .Descending(u => u.CreatedAt)
            .Build();

        return await _userFactory.FindAsync(filter, sort, request.Limit);
    }
}

// âŒ é”™è¯¯ - æ²¡æœ‰ä½¿ç”¨ç§Ÿæˆ·ä¸Šä¸‹æ–‡
public class RoleService : IRoleService
{
    public async Task<Role> CreateRoleAsync(CreateRoleRequest request)
    {
        var role = new Role
        {
            Name = request.Name,
            Description = request.Description,
            // âŒ æ²¡æœ‰è®¾ç½® CompanyId
        };

        return await _roleFactory.CreateAsync(role);
    }
}
```

## ğŸ¯ æƒé™æ§åˆ¶

### åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶

```csharp
// âœ… æ­£ç¡® - è§’è‰²æƒé™æ§åˆ¶
public class RoleService : IRoleService
{
    private readonly IDatabaseOperationFactory<Role> _roleFactory;
    private readonly ITenantContext _tenantContext;

    public RoleService(
        IDatabaseOperationFactory<Role> roleFactory,
        ITenantContext tenantContext)
    {
        _roleFactory = roleFactory;
        _tenantContext = tenantContext;
    }

    public async Task<Role> CreateRoleAsync(CreateRoleRequest request)
    {
        // æ£€æŸ¥æƒé™
        var currentUserId = _tenantContext.GetRequiredUserId();
        var currentUser = await _userFactory.GetByIdAsync(currentUserId);
        if (currentUser == null || !currentUser.IsAdmin)
        {
            throw new UnauthorizedAccessException("éœ€è¦ç®¡ç†å‘˜æƒé™");
        }

        var companyId = _tenantContext.GetRequiredCompanyId();

        var role = new Role
        {
            Name = request.Name,
            Description = request.Description,
            CompanyId = companyId, // è§’è‰²å±äºå½“å‰ä¼ä¸š
            CreatedBy = currentUserId,
            CreatedAt = DateTime.UtcNow
        };

        return await _roleFactory.CreateAsync(role);
    }

    public async Task<List<Role>> GetRolesAsync()
    {
        // åªè¿”å›å½“å‰ä¼ä¸šçš„è§’è‰²
        var filter = _roleFactory.CreateFilterBuilder()
            .ExcludeDeleted()
            .WithTenant()
            .Build();

        return await _roleFactory.FindAsync(filter);
    }

    public async Task<bool> AssignRoleToUserAsync(string userId, string roleId)
    {
        // æ£€æŸ¥æƒé™
        var currentUserId = _tenantContext.GetRequiredUserId();
        var currentUser = await _userFactory.GetByIdAsync(currentUserId);
        if (currentUser == null || !currentUser.IsAdmin)
        {
            throw new UnauthorizedAccessException("éœ€è¦ç®¡ç†å‘˜æƒé™");
        }

        var companyId = _tenantContext.GetRequiredCompanyId();

        // éªŒè¯ç”¨æˆ·å’Œè§’è‰²éƒ½å±äºå½“å‰ä¼ä¸š
        var user = await _userFactory.GetByIdAsync(userId);
        if (user == null || user.CompanyId != companyId)
        {
            throw new KeyNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨æˆ–ä¸å±äºå½“å‰ä¼ä¸š");
        }

        var role = await _roleFactory.GetByIdAsync(roleId);
        if (role == null || role.CompanyId != companyId)
        {
            throw new KeyNotFoundException("è§’è‰²ä¸å­˜åœ¨æˆ–ä¸å±äºå½“å‰ä¼ä¸š");
        }

        // åˆ†é…è§’è‰²
        var userRole = new UserRole
        {
            UserId = userId,
            RoleId = roleId,
            CompanyId = companyId,
            AssignedBy = currentUserId,
            AssignedAt = DateTime.UtcNow
        };

        await _userRoleFactory.CreateAsync(userRole);
        return true;
    }
}

// âŒ é”™è¯¯ - æ²¡æœ‰æƒé™æ§åˆ¶
public class RoleService : IRoleService
{
    public async Task<Role> CreateRoleAsync(CreateRoleRequest request)
    {
        // æ²¡æœ‰æƒé™æ£€æŸ¥
        var role = new Role
        {
            Name = request.Name,
            Description = request.Description
            // æ²¡æœ‰è®¾ç½® CompanyId
        };

        return await _roleFactory.CreateAsync(role);
    }
}
```

### èœå•æƒé™æ§åˆ¶

```csharp
// âœ… æ­£ç¡® - èœå•æƒé™æ§åˆ¶
public class MenuService : IMenuService
{
    private readonly IMongoCollection<Menu> _menus;
    private readonly IMongoCollection<Role> _roles;
    private readonly ITenantContext _tenantContext;

    public MenuService(
        IMongoCollection<Menu> menus,
        IMongoCollection<Role> roles,
        ITenantContext tenantContext)
    {
        _menus = menus;
        _roles = roles;
        _tenantContext = tenantContext;
    }

    public async Task<List<Menu>> GetUserMenusAsync()
    {
        var userId = _tenantContext.GetRequiredUserId();
        var companyId = _tenantContext.GetRequiredCompanyId();

        // è·å–ç”¨æˆ·è§’è‰²
        var userRoles = await _roles.Find(r => 
            r.UserIds.Contains(userId) && 
            r.CompanyId == companyId && 
            !r.IsDeleted).ToListAsync();

        // è·å–è§’è‰²å¯è®¿é—®çš„èœå•ID
        var menuIds = userRoles.SelectMany(r => r.MenuIds).Distinct().ToList();

        // è·å–èœå•
        var menus = await _menus.Find(m => 
            menuIds.Contains(m.Id) && 
            m.IsEnabled && 
            !m.IsDeleted).ToListAsync();

        return menus;
    }

    public async Task<bool> HasMenuAccessAsync(string menuId)
    {
        var userId = _tenantContext.GetRequiredUserId();
        var companyId = _tenantContext.GetRequiredCompanyId();

        // è·å–ç”¨æˆ·è§’è‰²
        var userRoles = await _roles.Find(r => 
            r.UserIds.Contains(userId) && 
            r.CompanyId == companyId && 
            !r.IsDeleted).ToListAsync();

        // æ£€æŸ¥æ˜¯å¦æœ‰èœå•è®¿é—®æƒé™
        return userRoles.Any(r => r.MenuIds.Contains(menuId));
    }

    public async Task<bool> HasPermissionAsync(string permission)
    {
        var userId = _tenantContext.GetRequiredUserId();
        var companyId = _tenantContext.GetRequiredCompanyId();

        // è·å–ç”¨æˆ·è§’è‰²
        var userRoles = await _roles.Find(r => 
            r.UserIds.Contains(userId) && 
            r.CompanyId == companyId && 
            !r.IsDeleted).ToListAsync();

        // æ£€æŸ¥æ˜¯å¦æœ‰æƒé™
        return userRoles.Any(r => r.Permissions.Contains(permission));
    }
}

// âŒ é”™è¯¯ - æ²¡æœ‰æƒé™æ§åˆ¶
public class MenuService : IMenuService
{
    public async Task<List<Menu>> GetUserMenusAsync()
    {
        // è¿”å›æ‰€æœ‰èœå•ï¼Œæ²¡æœ‰æƒé™æ§åˆ¶
        return await _menus.Find(m => m.IsEnabled && !m.IsDeleted).ToListAsync();
    }
}
```

## ğŸ¯ æ•°æ®å®‰å…¨

### æ•°æ®åŠ å¯†

```csharp
// âœ… æ­£ç¡® - æ•æ„Ÿæ•°æ®åŠ å¯†
public class UserService : IUserService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    private readonly IEncryptionService _encryptionService;

    public UserService(
        IDatabaseOperationFactory<User> userFactory,
        IEncryptionService encryptionService)
    {
        _userFactory = userFactory;
        _encryptionService = encryptionService;
    }

    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        var user = new User
        {
            Username = request.Username,
            Email = request.Email,
            // åŠ å¯†æ•æ„Ÿæ•°æ®
            PasswordHash = _encryptionService.HashPassword(request.Password),
            PhoneNumber = _encryptionService.Encrypt(request.PhoneNumber),
            CompanyId = _userFactory.GetRequiredCompanyId(),
            CreatedBy = _userFactory.GetCurrentUserId(),
            CreatedAt = DateTime.UtcNow
        };

        return await _userFactory.CreateAsync(user);
    }

    public async Task<bool> ValidatePasswordAsync(string userId, string password)
    {
        var user = await _userFactory.GetByIdAsync(userId);
        if (user == null)
            return false;

        return _encryptionService.VerifyPassword(password, user.PasswordHash);
    }
}

// âŒ é”™è¯¯ - æ•æ„Ÿæ•°æ®æœªåŠ å¯†
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        var user = new User
        {
            Username = request.Username,
            Email = request.Email,
            // å¯†ç æœªåŠ å¯†
            Password = request.Password,
            // æ‰‹æœºå·æœªåŠ å¯†
            PhoneNumber = request.PhoneNumber
        };

        return await _userFactory.CreateAsync(user);
    }
}
```

### å®¡è®¡æ—¥å¿—

```csharp
// âœ… æ­£ç¡® - å®¡è®¡æ—¥å¿—è®°å½•
public class UserService : IUserService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    private readonly IAuditService _auditService;

    public UserService(
        IDatabaseOperationFactory<User> userFactory,
        IAuditService auditService)
    {
        _userFactory = userFactory;
        _auditService = auditService;
    }

    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        var user = new User
        {
            Username = request.Username,
            Email = request.Email,
            CompanyId = _userFactory.GetRequiredCompanyId(),
            CreatedBy = _userFactory.GetCurrentUserId(),
            CreatedAt = DateTime.UtcNow
        };

        var createdUser = await _userFactory.CreateAsync(user);

        // è®°å½•å®¡è®¡æ—¥å¿—
        await _auditService.RecordOperationAsync(new OperationAudit
        {
            EntityType = nameof(User),
            EntityId = createdUser.Id,
            OperationType = OperationType.Create,
            UserId = _userFactory.GetCurrentUserId(),
            Username = _userFactory.GetCurrentUsername(),
            CompanyId = _userFactory.GetCurrentCompanyId(),
            Description = "åˆ›å»ºç”¨æˆ·",
            AfterData = JsonSerializer.Serialize(createdUser)
        });

        return createdUser;
    }

    public async Task<bool> UpdateUserAsync(UpdateUserRequest request)
    {
        var existingUser = await _userFactory.GetByIdAsync(request.Id);
        if (existingUser == null)
            return false;

        var beforeData = JsonSerializer.Serialize(existingUser);

        var update = _userFactory.CreateUpdateBuilder()
            .Set(u => u.Username, request.Username)
            .SetCurrentTimestamp()
            .SetOperationTracking(_userFactory.GetCurrentUserId(), _userFactory.GetCurrentUsername())
            .Build();

        var result = await _userFactory.UpdateAsync(existingUser, new OperationContext
        {
            UserId = _userFactory.GetCurrentUserId(),
            Username = _userFactory.GetCurrentUsername(),
            CompanyId = _userFactory.GetCurrentCompanyId(),
            OperationType = OperationType.Update,
            Description = "æ›´æ–°ç”¨æˆ·ä¿¡æ¯"
        });

        if (result)
        {
            // è®°å½•å®¡è®¡æ—¥å¿—
            await _auditService.RecordOperationAsync(new OperationAudit
            {
                EntityType = nameof(User),
                EntityId = request.Id,
                OperationType = OperationType.Update,
                UserId = _userFactory.GetCurrentUserId(),
                Username = _userFactory.GetCurrentUsername(),
                CompanyId = _userFactory.GetCurrentCompanyId(),
                Description = "æ›´æ–°ç”¨æˆ·ä¿¡æ¯",
                BeforeData = beforeData,
                AfterData = JsonSerializer.Serialize(existingUser)
            });
        }

        return result;
    }
}

// âŒ é”™è¯¯ - æ²¡æœ‰å®¡è®¡æ—¥å¿—
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        var user = new User
        {
            Username = request.Username,
            Email = request.Email
        };

        // æ²¡æœ‰è®°å½•å®¡è®¡æ—¥å¿—
        return await _userFactory.CreateAsync(user);
    }
}
```

## ğŸš« ç¦æ­¢çš„åšæ³•

### ä¸è¦å¿½ç•¥æ•°æ®éš”ç¦»

```csharp
// âŒ é”™è¯¯ - æ²¡æœ‰æ•°æ®éš”ç¦»
public class UserService : IUserService
{
    public async Task<List<User>> GetUsersAsync()
    {
        // è¿”å›æ‰€æœ‰ä¼ä¸šçš„ç”¨æˆ·ï¼Œæ²¡æœ‰æ•°æ®éš”ç¦»
        return await _userFactory.FindAsync();
    }
}

// âœ… æ­£ç¡® - æ•°æ®éš”ç¦»
public class UserService : IUserService
{
    public async Task<List<User>> GetUsersAsync()
    {
        // åªè¿”å›å½“å‰ä¼ä¸šçš„ç”¨æˆ·
        var filter = _userFactory.CreateFilterBuilder()
            .ExcludeDeleted()
            .WithTenant()
            .Build();

        return await _userFactory.FindAsync(filter);
    }
}
```

### ä¸è¦ç¡¬ç¼–ç ä¼ä¸šID

```csharp
// âŒ é”™è¯¯ - ç¡¬ç¼–ç ä¼ä¸šID
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        var user = new User
        {
            Username = request.Username,
            Email = request.Email,
            CompanyId = "company123" // ç¡¬ç¼–ç ä¼ä¸šID
        };

        return await _userFactory.CreateAsync(user);
    }
}

// âœ… æ­£ç¡® - åŠ¨æ€è·å–ä¼ä¸šID
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        var user = new User
        {
            Username = request.Username,
            Email = request.Email,
            CompanyId = _userFactory.GetRequiredCompanyId() // åŠ¨æ€è·å–
        };

        return await _userFactory.CreateAsync(user);
    }
}
```

### ä¸è¦å¿½ç•¥æƒé™æ£€æŸ¥

```csharp
// âŒ é”™è¯¯ - æ²¡æœ‰æƒé™æ£€æŸ¥
public class UserService : IUserService
{
    public async Task<bool> DeleteUserAsync(string id)
    {
        // æ²¡æœ‰æƒé™æ£€æŸ¥ï¼Œä»»ä½•äººéƒ½å¯ä»¥åˆ é™¤ç”¨æˆ·
        return await _userFactory.SoftDeleteAsync(id);
    }
}

// âœ… æ­£ç¡® - æƒé™æ£€æŸ¥
public class UserService : IUserService
{
    public async Task<bool> DeleteUserAsync(string id)
    {
        // æ£€æŸ¥æƒé™
        var currentUserId = _userFactory.GetRequiredUserId();
        var currentUser = await _userFactory.GetByIdAsync(currentUserId);
        if (currentUser == null || !currentUser.IsAdmin)
        {
            throw new UnauthorizedAccessException("éœ€è¦ç®¡ç†å‘˜æƒé™");
        }

        return await _userFactory.SoftDeleteAsync(id);
    }
}
```

## ğŸ“‹ å¤šç§Ÿæˆ·å¼€å‘æ£€æŸ¥æ¸…å•

åˆ›å»ºæˆ–ä¿®æ”¹å¤šç§Ÿæˆ·åŠŸèƒ½æ—¶æ£€æŸ¥ï¼š

- [ ] æ•°æ®æ¨¡å‹åŒ…å« CompanyId å­—æ®µï¼ˆIMultiTenant å®ä½“ï¼‰
- [ ] **æ•°æ®åº“æ“ä½œè‡ªåŠ¨è¿‡æ»¤ç§Ÿæˆ·æ•°æ®**ï¼š
  - [ ] æ‰€æœ‰å®ç°äº† `IMultiTenant` çš„å®ä½“æŸ¥è¯¢ä¼šè‡ªåŠ¨åº”ç”¨ä¼ä¸šè¿‡æ»¤
  - [ ] **ç¦æ­¢æ‰‹åŠ¨æ·»åŠ  CompanyId è¿‡æ»¤** - ä¾èµ–æ•°æ®å·¥å‚çš„è‡ªåŠ¨è¿‡æ»¤
  - [ ] åˆ›å»ºå®ä½“æ—¶å¿…é¡»è®¾ç½® `CompanyId`ï¼ˆä½¿ç”¨ `GetRequiredCompanyId()`ï¼‰
  - [ ] æ•°æ®å·¥å‚ä»æ•°æ®åº“è¯»å–ä¼ä¸šIDï¼ˆä¸ä½¿ç”¨ JWT tokenï¼‰
  - [ ] ä½¿ç”¨æ­£ç¡®çš„ MongoDB å­—æ®µåï¼ˆä» `BsonElement` ç‰¹æ€§è·å–ï¼‰
- [ ] æœåŠ¡ä½¿ç”¨ç§Ÿæˆ·ä¸Šä¸‹æ–‡
- [ ] æƒé™æ§åˆ¶æ­£ç¡®å®ç°
- [ ] æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- [ ] å®¡è®¡æ—¥å¿—å®Œæ•´è®°å½•
- [ ] è·¨ç§Ÿæˆ·æŸ¥è¯¢æœ‰æ˜ç¡®æ ‡è¯†
- [ ] èœå•æƒé™æ­£ç¡®æ§åˆ¶
- [ ] è§’è‰²æƒé™æ­£ç¡®åˆ†é…
- [ ] æ•°æ®éš”ç¦»æµ‹è¯•é€šè¿‡

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç”¨æˆ·æœåŠ¡å®ç°](mdc:Platform.ApiService/Services/UserService.cs)
- [è§’è‰²æœåŠ¡å®ç°](mdc:Platform.ApiService/Services/RoleService.cs)
- [ä¼ä¸šæœåŠ¡å®ç°](mdc:Platform.ApiService/Services/CompanyService.cs)
- [å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡](https://docs.microsoft.com/en-us/azure/sql-database/saas-tenancy-app-design-patterns)
