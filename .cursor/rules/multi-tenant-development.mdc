---
description: å¤šç§Ÿæˆ·ç³»ç»Ÿå¼€å‘è§„èŒƒå’Œæœ€ä½³å®è·µ
---

# å¤šç§Ÿæˆ·ç³»ç»Ÿå¼€å‘è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

æœ¬é¡¹ç›®é‡‡ç”¨**å…±äº«æ•°æ®åº“ + CompanyId å­—æ®µ**çš„å¤šç§Ÿæˆ·æ¶æ„ï¼š
- ç”¨æˆ·ä¸ä¼ä¸šï¼šä¸€å¯¹ä¸€å…³ç³»
- æ•°æ®éš”ç¦»ï¼šé€šè¿‡ `companyId` å­—æ®µ100%éš”ç¦»
- è‡ªåŠ¨è¿‡æ»¤ï¼šBaseRepository è‡ªåŠ¨å¤„ç†ç§Ÿæˆ·è¿‡æ»¤
- JWT Tokenï¼šåŒ…å« `companyId` claim

## âœ… æ­£ç¡®çš„å¼€å‘æ–¹å¼

### 1. æ–°å¢ä¸šåŠ¡å®ä½“æ—¶

**å¿…é¡»æ‰§è¡Œçš„æ­¥éª¤ï¼š**

#### â‘  æ·»åŠ  CompanyId å­—æ®µ

```csharp
// âœ… æ­£ç¡®ï¼šæ‰€æœ‰ä¸šåŠ¡å®ä½“éƒ½å¿…é¡»æ·»åŠ  companyId
[BsonElement("companyId")]
public string CompanyId { get; set; } = string.Empty;
```

#### â‘¡ å®ç°å¿…éœ€çš„æ¥å£

```csharp
// âœ… æ­£ç¡®ï¼šå®ç°ä¸‰ä¸ªæ¥å£
public class MyEntity : IEntity, ISoftDeletable, ITimestamped
{
    public string? Id { get; set; }
    
    [BsonElement("companyId")]
    public string CompanyId { get; set; } = string.Empty;
    
    // ISoftDeletable å­—æ®µ
    public bool IsDeleted { get; set; }
    public DateTime? DeletedAt { get; set; }
    public string? DeletedBy { get; set; }
    public string? DeletedReason { get; set; }
    
    // ITimestamped å­—æ®µ
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    
    // ä¸šåŠ¡å­—æ®µ...
}
```

#### â‘¢ ä½¿ç”¨ BaseRepository

```csharp
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ BaseRepository
public class MyService : BaseService, IMyService
{
    private readonly BaseRepository<MyEntity> _repository;
    
    public MyService(
        IMongoDatabase database,
        IHttpContextAccessor httpContextAccessor,
        ITenantContext tenantContext,  // âœ… å¿…é¡»åŒ…å«
        ILogger<MyService> logger)
        : base(database, httpContextAccessor, tenantContext, logger)
    {
        _repository = new BaseRepository<MyEntity>(
            database, 
            "my_entities", 
            httpContextAccessor, 
            tenantContext  // âœ… å¿…é¡»ä¼ é€’
        );
    }
    
    // âœ… æŸ¥è¯¢è‡ªåŠ¨è¿‡æ»¤åˆ°å½“å‰ä¼ä¸š
    public async Task<List<MyEntity>> GetAllAsync()
    {
        return await _repository.GetAllAsync();
        // è‡ªåŠ¨æŸ¥è¯¢ï¼šWHERE companyId = currentCompanyId AND isDeleted = false
    }
    
    // âœ… åˆ›å»ºæ—¶è‡ªåŠ¨è®¾ç½® CompanyId
    public async Task<MyEntity> CreateAsync(CreateRequest request)
    {
        var entity = new MyEntity
        {
            Name = request.Name
            // CompanyId ä¼šè‡ªåŠ¨è®¾ç½®
        };
        
        return await _repository.CreateAsync(entity);
    }
}
```

### 2. æŸ¥è¯¢æ•°æ®æ—¶

```csharp
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ BaseRepository æ–¹æ³•ï¼ˆè‡ªåŠ¨ç§Ÿæˆ·è¿‡æ»¤ï¼‰
var users = await _userRepository.GetAllAsync();
var user = await _userRepository.GetByIdAsync(id);
var exists = await _userRepository.ExistsAsync(filter);

// âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨ IMongoCollectionï¼ˆç»•è¿‡ç§Ÿæˆ·è¿‡æ»¤ï¼‰
var users = await _users.Find(_ => true).ToListAsync();
```

### 3. åˆ›å»ºæ•°æ®æ—¶

```csharp
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ BaseRepository.CreateAsyncï¼ˆè‡ªåŠ¨è®¾ç½® CompanyIdï¼‰
var entity = new MyEntity { Name = "Test" };
await _repository.CreateAsync(entity);

// âŒ é”™è¯¯ï¼šç›´æ¥æ’å…¥ï¼ˆCompanyId ä¸ä¼šè‡ªåŠ¨è®¾ç½®ï¼‰
await _collection.InsertOneAsync(entity);

// âŒ é”™è¯¯ï¼šæ‰‹åŠ¨è®¾ç½® CompanyIdï¼ˆåº”è¯¥è®©ç³»ç»Ÿè‡ªåŠ¨å¤„ç†ï¼‰
entity.CompanyId = GetCurrentCompanyId();
await _collection.InsertOneAsync(entity);
```

### 4. æœåŠ¡å±‚å¼€å‘

```csharp
// âœ… æ­£ç¡®ï¼šç»§æ‰¿ BaseService å¹¶åŒ…å« ITenantContext
public class MyService : BaseService, IMyService
{
    public MyService(
        IMongoDatabase database,
        IHttpContextAccessor httpContextAccessor,
        ITenantContext tenantContext,  // âœ… å¿…é¡»
        ILogger<MyService> logger)
        : base(database, httpContextAccessor, tenantContext, logger)
    {
        // åˆå§‹åŒ–...
    }
    
    // âœ… å¯ä»¥ä½¿ç”¨åŸºç±»æä¾›çš„æ–¹æ³•
    protected string GetCompanyId() => GetCurrentCompanyId();
    protected string GetRequiredCompanyId() => GetRequiredCompanyId();
}

// âŒ é”™è¯¯ï¼šç¼ºå°‘ ITenantContext
public MyService(
    IMongoDatabase database,
    IHttpContextAccessor httpContextAccessor,
    ILogger<MyService> logger)
    : base(database, httpContextAccessor, logger)  // âŒ ç¼–è¯‘é”™è¯¯
```

### 5. è·å–ç§Ÿæˆ·ä¿¡æ¯

```csharp
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ BaseService æä¾›çš„æ–¹æ³•
var companyId = GetCurrentCompanyId();      // å¯ä¸º null
var requiredId = GetRequiredCompanyId();    // ä¸å­˜åœ¨åˆ™æŠ›å¼‚å¸¸

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ TenantContextï¼ˆå¦‚æœç›´æ¥æ³¨å…¥ï¼‰
var companyId = _tenantContext.GetCurrentCompanyId();

// âŒ é”™è¯¯ï¼šæ‰‹åŠ¨ä» HttpContext æå–
var companyId = _httpContextAccessor.HttpContext?.User?.FindFirst("companyId")?.Value;
```

## ğŸš« ç¦æ­¢çš„åšæ³•

### âŒ ä¸è¦ç»•è¿‡ç§Ÿæˆ·è¿‡æ»¤

```csharp
// âŒ ç¦æ­¢ï¼šç›´æ¥ä½¿ç”¨ IMongoCollection æŸ¥è¯¢æ‰€æœ‰æ•°æ®
var allUsers = await _users.Find(_ => true).ToListAsync();

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ BaseRepository
var users = await _userRepository.GetAllAsync();
```

### âŒ ä¸è¦æ‰‹åŠ¨è¿‡æ»¤ CompanyId

```csharp
// âŒ ç¦æ­¢ï¼šæ‰‹åŠ¨æ·»åŠ  CompanyId è¿‡æ»¤
var companyId = GetCurrentCompanyId();
var filter = Builders<AppUser>.Filter.Eq(u => u.CompanyId, companyId);
var users = await _users.Find(filter).ToListAsync();

// âœ… æ­£ç¡®ï¼šè®© BaseRepository è‡ªåŠ¨å¤„ç†
var users = await _userRepository.GetAllAsync();
```

### âŒ ä¸è¦æ‰‹åŠ¨è®¾ç½® CompanyId

```csharp
// âŒ ç¦æ­¢ï¼šæ‰‹åŠ¨è®¾ç½® CompanyId
var entity = new MyEntity
{
    Name = "Test",
    CompanyId = GetCurrentCompanyId()  // âŒ ä¸éœ€è¦æ‰‹åŠ¨è®¾ç½®
};
await _collection.InsertOneAsync(entity);

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ BaseRepositoryï¼ˆè‡ªåŠ¨è®¾ç½®ï¼‰
var entity = new MyEntity { Name = "Test" };
await _repository.CreateAsync(entity);
```

### âŒ ä¸è¦è·¨ä¼ä¸šæ“ä½œ

```csharp
// âŒ ç¦æ­¢ï¼šå°è¯•è®¿é—®å…¶ä»–ä¼ä¸šçš„æ•°æ®
var otherCompanyId = "other-company-id";
var filter = Builders<AppUser>.Filter.Eq(u => u.CompanyId, otherCompanyId);
var users = await _users.Find(filter).ToListAsync();

// âœ… æ­£ç¡®ï¼šåªèƒ½è®¿é—®å½“å‰ä¼ä¸šçš„æ•°æ®
var users = await _userRepository.GetAllAsync();
```

## ğŸ”§ ç‰¹æ®Šåœºæ™¯å¤„ç†

### åœºæ™¯1ï¼šéœ€è¦è®¿é—®å¤šä¸ªä¼ä¸šæ•°æ®ï¼ˆç³»ç»Ÿçº§æ“ä½œï¼‰

```csharp
// âš ï¸ ç‰¹æ®Šåœºæ™¯ï¼šè¶…çº§ç®¡ç†å‘˜åŠŸèƒ½
// ç›´æ¥ä½¿ç”¨ IMongoCollectionï¼Œç»•è¿‡ç§Ÿæˆ·è¿‡æ»¤
public async Task<List<Company>> GetAllCompaniesAsync()
{
    // ç³»ç»Ÿçº§æ“ä½œï¼Œä¸ä½¿ç”¨ç§Ÿæˆ·è¿‡æ»¤
    var companies = _database.GetCollection<Company>("companies");
    var filter = Builders<Company>.Filter.Eq(c => c.IsDeleted, false);
    return await companies.Find(filter).ToListAsync();
}

// âš ï¸ å¿…é¡»æ·»åŠ æ³¨é‡Šè¯´æ˜ä¸ºä»€ä¹ˆç»•è¿‡ç§Ÿæˆ·è¿‡æ»¤
```

### åœºæ™¯2ï¼šè·¨ä¼ä¸šå…³è”æŸ¥è¯¢

```csharp
// å¦‚æœç¡®å®éœ€è¦è·¨ä¼ä¸šæŸ¥è¯¢ï¼ˆéå¸¸ç½•è§ï¼‰
// å¿…é¡»æœ‰æ˜ç¡®çš„ä¸šåŠ¡ç†ç”±å’Œå®‰å…¨æ£€æŸ¥
public async Task<MyEntity?> GetByIdWithoutTenantFilter(string id)
{
    // âš ï¸ è­¦å‘Šï¼šç»•è¿‡ç§Ÿæˆ·è¿‡æ»¤ï¼Œä»…ç”¨äºç³»ç»Ÿçº§æ“ä½œ
    var filter = Builders<MyEntity>.Filter.And(
        Builders<MyEntity>.Filter.Eq(e => e.Id, id),
        Builders<MyEntity>.Filter.Eq(e => e.IsDeleted, false)
    );
    return await _collection.Find(filter).FirstOrDefaultAsync();
}
```

### åœºæ™¯3ï¼šæ£€æŸ¥ä¼ä¸šé…é¢

```csharp
// âœ… åˆ›å»ºç”¨æˆ·å‰æ£€æŸ¥é…é¢
public async Task<AppUser> CreateUserAsync(CreateUserRequest request)
{
    var companyId = GetRequiredCompanyId();
    
    // æ£€æŸ¥ä¼ä¸šç”¨æˆ·é…é¢
    var companies = Database.GetCollection<Company>("companies");
    var company = await companies
        .Find(c => c.Id == companyId && c.IsDeleted == false)
        .FirstOrDefaultAsync();
    
    if (company != null)
    {
        var currentUserCount = await _users.CountDocumentsAsync(
            Builders<AppUser>.Filter.And(
                Builders<AppUser>.Filter.Eq(u => u.CompanyId, companyId),
                Builders<AppUser>.Filter.Eq(u => u.IsDeleted, false)
            )
        );

        if (currentUserCount >= company.MaxUsers)
        {
            throw new InvalidOperationException(ErrorMessages.MaxUsersReached);
        }
    }
    
    // åˆ›å»ºç”¨æˆ·...
}
```

### åœºæ™¯4ï¼šæ£€æŸ¥ä¼ä¸šçŠ¶æ€

```csharp
// âœ… ç™»å½•æ—¶æ£€æŸ¥ä¼ä¸šçŠ¶æ€
public async Task<ApiResponse<LoginData>> LoginAsync(LoginRequest request)
{
    // éªŒè¯ç”¨æˆ·...
    
    // æ£€æŸ¥ä¼ä¸šçŠ¶æ€
    var companies = _database.GetCollection<Company>("companies");
    var company = await companies
        .Find(c => c.Id == user.CompanyId && c.IsDeleted == false)
        .FirstOrDefaultAsync();
    
    if (company == null)
        return ApiResponse<LoginData>.ErrorResult("COMPANY_NOT_FOUND", "ä¼ä¸šä¸å­˜åœ¨");
        
    if (!company.IsActive)
        return ApiResponse<LoginData>.ErrorResult("COMPANY_INACTIVE", "ä¼ä¸šæœªæ¿€æ´»");
        
    if (company.ExpiresAt.HasValue && company.ExpiresAt.Value < DateTime.UtcNow)
        return ApiResponse<LoginData>.ErrorResult("COMPANY_EXPIRED", "ä¼ä¸šå·²è¿‡æœŸ");
    
    // ç”Ÿæˆ Token...
}
```

## ğŸ“‹ å¼€å‘æ¸…å•

### æ–°å¢ä¸šåŠ¡å®ä½“æ—¶

- [ ] å®ä½“æ·»åŠ  `companyId` å­—æ®µï¼ˆstring ç±»å‹ï¼Œ`[BsonElement("companyId")]`ï¼‰
- [ ] å®ä½“å®ç° `IEntity`, `ISoftDeletable`, `ITimestamped` æ¥å£
- [ ] ä½¿ç”¨ `BaseRepository<T>` è¿›è¡Œæ•°æ®è®¿é—®
- [ ] æœåŠ¡ç»§æ‰¿ `BaseService`ï¼ˆæ„é€ å‡½æ•°åŒ…å« `ITenantContext`ï¼‰
- [ ] åˆ›å»º BaseRepository æ—¶ä¼ é€’ `tenantContext` å‚æ•°
- [ ] æµ‹è¯•æ•°æ®éš”ç¦»ï¼ˆåˆ›å»ºå¤šä¸ªä¼ä¸šæµ‹è¯•ï¼‰
- [ ] åˆ›å»ºæˆ–æ›´æ–°æ•°æ®åº“ç´¢å¼•ï¼ˆ`companyId` ç›¸å…³ï¼‰

### ä»£ç å®¡æŸ¥æ¸…å•

- [ ] æ‰€æœ‰ä¸šåŠ¡å®ä½“éƒ½æœ‰ `companyId` å­—æ®µ
- [ ] æ‰€æœ‰æŸ¥è¯¢éƒ½ä½¿ç”¨ `BaseRepository`ï¼ˆä¸ç›´æ¥ä½¿ç”¨ IMongoCollectionï¼‰
- [ ] æ‰€æœ‰æœåŠ¡çš„æ„é€ å‡½æ•°åŒ…å« `ITenantContext`
- [ ] åˆ›å»º BaseRepository æ—¶ä¼ é€’äº† `tenantContext`
- [ ] æ²¡æœ‰æ‰‹åŠ¨è®¾ç½® `CompanyId`ï¼ˆç”± BaseRepository è‡ªåŠ¨è®¾ç½®ï¼‰
- [ ] æ²¡æœ‰æ‰‹åŠ¨è¿‡æ»¤ `CompanyId`ï¼ˆç”± BaseRepository è‡ªåŠ¨è¿‡æ»¤ï¼‰
- [ ] JWT Token åŒ…å« `companyId` claim
- [ ] ç™»å½•æ—¶æ£€æŸ¥ä¼ä¸šçŠ¶æ€ï¼ˆæ˜¯å¦æ¿€æ´»ã€æ˜¯å¦è¿‡æœŸï¼‰
- [ ] åˆ›å»ºç”¨æˆ·æ—¶æ£€æŸ¥ä¼ä¸šé…é¢

## ğŸ—ï¸ BaseRepository å·¥ä½œåŸç†

### è‡ªåŠ¨ç§Ÿæˆ·è¿‡æ»¤æœºåˆ¶

```csharp
protected FilterDefinition<T> BuildTenantFilter(FilterDefinition<T>? additionalFilter = null)
{
    var builder = Builders<T>.Filter;
    var filters = new List<FilterDefinition<T>>
    {
        builder.Eq(e => e.IsDeleted, false)  // è‡ªåŠ¨è¿‡æ»¤å·²åˆ é™¤
    };

    // âœ… ä½¿ç”¨åå°„æ£€æµ‹å®ä½“æ˜¯å¦æœ‰ CompanyId å±æ€§
    if (typeof(T).GetProperty("CompanyId") != null)
    {
        var companyId = _tenantContext.GetCurrentCompanyId();
        if (!string.IsNullOrEmpty(companyId))
        {
            filters.Add(builder.Eq("companyId", companyId));  // è‡ªåŠ¨ç§Ÿæˆ·è¿‡æ»¤
        }
    }

    if (additionalFilter != null)
        filters.Add(additionalFilter);
        
    return builder.And(filters);
}
```

**å…³é”®ç‚¹ï¼š**
- ä½¿ç”¨åå°„æ£€æµ‹ `CompanyId` å±æ€§
- ä» `TenantContext` è·å–å½“å‰ä¼ä¸šID
- è‡ªåŠ¨æ·»åŠ è¿‡æ»¤æ¡ä»¶
- æ‰€æœ‰æŸ¥è¯¢æ–¹æ³•éƒ½ä½¿ç”¨æ­¤è¿‡æ»¤å™¨

### è‡ªåŠ¨è®¾ç½® CompanyId

```csharp
public virtual async Task<T> CreateAsync(T entity)
{
    entity.CreatedAt = DateTime.UtcNow;
    entity.UpdatedAt = DateTime.UtcNow;
    entity.IsDeleted = false;
    
    // âœ… å¦‚æœå®ä½“æœ‰ CompanyId å±æ€§ï¼Œè‡ªåŠ¨è®¾ç½®
    if (typeof(T).GetProperty("CompanyId") != null)
    {
        var companyId = _tenantContext.GetCurrentCompanyId();
        if (!string.IsNullOrEmpty(companyId))
        {
            typeof(T).GetProperty("CompanyId")?.SetValue(entity, companyId);
        }
    }
    
    await Collection.InsertOneAsync(entity);
    return entity;
}
```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å§‹ç»ˆä½¿ç”¨ BaseRepository

```csharp
// âœ… æ¨è
private readonly BaseRepository<AppUser> _userRepository;

// âŒ ä¸æ¨èï¼ˆé™¤éæœ‰ç‰¹æ®Šéœ€æ±‚ï¼‰
private readonly IMongoCollection<AppUser> _users;
```

### 2. æœåŠ¡æ„é€ å‡½æ•°æ ‡å‡†æ¨¡æ¿

```csharp
public class MyService : BaseService, IMyService
{
    private readonly BaseRepository<MyEntity> _repository;
    
    public MyService(
        IMongoDatabase database,
        IHttpContextAccessor httpContextAccessor,
        ITenantContext tenantContext,  // âœ… å¿…é¡»
        ILogger<MyService> logger)
        : base(database, httpContextAccessor, tenantContext, logger)
    {
        _repository = new BaseRepository<MyEntity>(
            database, 
            "collection_name", 
            httpContextAccessor, 
            tenantContext  // âœ… å¿…é¡»
        );
    }
}
```

### 3. æŸ¥è¯¢æ¨¡å¼

```csharp
// âœ… ç®€å•æŸ¥è¯¢
var all = await _repository.GetAllAsync();
var one = await _repository.GetByIdAsync(id);

// âœ… æ¡ä»¶æŸ¥è¯¢
var filter = Builders<MyEntity>.Filter.Eq(e => e.Status, "active");
var items = await _repository.FindAsync(filter);

// âœ… åˆ†é¡µæŸ¥è¯¢
var (items, total) = await _repository.GetPagedAsync(filter, page, pageSize);
```

### 4. æ›´æ–°å’Œåˆ é™¤

```csharp
// âœ… æ›´æ–°
var update = Builders<MyEntity>.Update.Set(e => e.Status, "updated");
await _repository.UpdateAsync(id, update);

// âœ… è½¯åˆ é™¤
await _repository.SoftDeleteAsync(id, reason);

// âœ… æ‰¹é‡æ“ä½œ
await _repository.UpdateManyAsync(filter, update);
await _repository.SoftDeleteManyAsync(filter, reason);
```

## ğŸ” å®‰å…¨è€ƒè™‘

### 1. CompanyId æ¥æº

**å®‰å…¨çš„æ¥æºï¼š**
- âœ… ä» JWT Token çš„ `companyId` claim è·å–
- âœ… ç”± `TenantContext` æä¾›
- âœ… JWT ç”±æœåŠ¡å™¨ç­¾åï¼Œå®¢æˆ·ç«¯æ— æ³•ç¯¡æ”¹

**ä¸å®‰å…¨çš„æ¥æºï¼š**
- âŒ ä»è¯·æ±‚å‚æ•°è·å–ï¼ˆç”¨æˆ·å¯ç¯¡æ”¹ï¼‰
- âŒ ä» HTTP Header è·å–ï¼ˆç”¨æˆ·å¯ç¯¡æ”¹ï¼‰
- âŒ ä» Cookie è·å–ï¼ˆç”¨æˆ·å¯ç¯¡æ”¹ï¼‰

### 2. æ•°æ®è®¿é—®æƒé™

```csharp
// âœ… åªèƒ½è®¿é—®å½“å‰ä¼ä¸šçš„æ•°æ®
var users = await _userRepository.GetAllAsync();

// âŒ ç¦æ­¢å°è¯•è®¿é—®å…¶ä»–ä¼ä¸šçš„æ•°æ®
var filter = Builders<AppUser>.Filter.Eq(u => u.CompanyId, "other-company-id");
```

### 3. è·¨ä¼ä¸šè®¿é—®é˜²æŠ¤

ç³»ç»Ÿè‡ªåŠ¨é˜²æŠ¤ï¼š
- BaseRepository è‡ªåŠ¨æ·»åŠ  CompanyId è¿‡æ»¤
- æ— æ³•é€šè¿‡ä¿®æ”¹æŸ¥è¯¢æ¡ä»¶è®¿é—®å…¶ä»–ä¼ä¸šæ•°æ®
- CompanyId åœ¨ JWT ä¸­ï¼Œæ— æ³•ç¯¡æ”¹

## ğŸ“Š ç´¢å¼•è®¾è®¡åŸåˆ™

### å¤šç§Ÿæˆ·ç´¢å¼•è§„èŒƒ

```javascript
// âœ… æ­£ç¡®ï¼šCompanyId ä½œä¸ºç¬¬ä¸€åˆ—
db.users.createIndex({ companyId: 1, username: 1 }, { unique: true })
db.users.createIndex({ companyId: 1, email: 1 })
db.users.createIndex({ companyId: 1, isDeleted: 1, isActive: 1 })

// âŒ é”™è¯¯ï¼šCompanyId ä¸åœ¨ç¬¬ä¸€åˆ—
db.users.createIndex({ username: 1, companyId: 1 })
```

**åŸåˆ™ï¼š**
1. CompanyId å§‹ç»ˆä½œä¸ºå¤åˆç´¢å¼•çš„ç¬¬ä¸€åˆ—
2. ä¸šåŠ¡å”¯ä¸€æ€§çº¦æŸæ”¹ä¸º"ä¼ä¸šå†…å”¯ä¸€"
3. æ‰€æœ‰å¸¸ç”¨æŸ¥è¯¢éƒ½åº”æœ‰å¯¹åº”çš„å¤åˆç´¢å¼•

### ç´¢å¼•åˆ›å»ºä½ç½®

åœ¨ [CreateMultiTenantIndexes.cs](mdc:Platform.ApiService/Scripts/CreateMultiTenantIndexes.cs) ä¸­æ·»åŠ æ–°ç´¢å¼•ã€‚

## ğŸ§ª æµ‹è¯•è¦æ±‚

### å¿…é¡»æµ‹è¯•çš„åœºæ™¯

1. **æ•°æ®éš”ç¦»æµ‹è¯•**
   - åˆ›å»ºå¤šä¸ªä¼ä¸š
   - éªŒè¯ä¼ä¸šé—´æ•°æ®äº’ä¸å¯è§

2. **è‡ªåŠ¨è¿‡æ»¤æµ‹è¯•**
   - æŸ¥è¯¢åªè¿”å›å½“å‰ä¼ä¸šçš„æ•°æ®
   - æ— æ³•é€šè¿‡ ID è®¿é—®å…¶ä»–ä¼ä¸šçš„æ•°æ®

3. **è‡ªåŠ¨è®¾ç½®æµ‹è¯•**
   - åˆ›å»ºçš„å®ä½“è‡ªåŠ¨è®¾ç½®æ­£ç¡®çš„ CompanyId
   - CompanyId ä¸ä¸ºç©º

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [å¤šç§Ÿæˆ·ç³»ç»Ÿå®Œæ•´æ–‡æ¡£](mdc:docs/features/MULTI-TENANT-SYSTEM.md)
- [å¿«é€Ÿå¼€å§‹æŒ‡å—](mdc:docs/features/MULTI-TENANT-QUICK-START.md)
- [æµ‹è¯•æŒ‡å—](mdc:docs/features/MULTI-TENANT-TESTING-GUIDE.md)
- [BaseRepository å®ç°](mdc:Platform.ApiService/Services/BaseRepository.cs)
- [TenantContext å®ç°](mdc:Platform.ApiService/Services/TenantContext.cs)
- [CompanyService ç¤ºä¾‹](mdc:Platform.ApiService/Services/CompanyService.cs)

## ğŸ¯ è®°ä½

**æ ¸å¿ƒåŸåˆ™ï¼š**
1. âœ… æ‰€æœ‰ä¸šåŠ¡å®ä½“å¿…é¡»æœ‰ `companyId` å­—æ®µ
2. âœ… å§‹ç»ˆä½¿ç”¨ BaseRepository è¿›è¡Œæ•°æ®è®¿é—®
3. âœ… ä»ä¸æ‰‹åŠ¨è¿‡æ»¤æˆ–è®¾ç½® CompanyId
4. âœ… æœåŠ¡å¿…é¡»åŒ…å« ITenantContext ä¾èµ–
5. âœ… åˆ›å»ºç´¢å¼•æ—¶ CompanyId ä½œä¸ºç¬¬ä¸€åˆ—

**ç³»ç»Ÿä¿è¯ï¼š**
- 100% æ•°æ®éš”ç¦»
- è‡ªåŠ¨ç§Ÿæˆ·è¿‡æ»¤
- é˜²æ­¢è·¨ä¼ä¸šè®¿é—®
- JWT ç­¾åä¿æŠ¤

éµå¾ªè¿™äº›è§„èŒƒï¼Œç¡®ä¿å¤šç§Ÿæˆ·æ¶æ„çš„å®‰å…¨æ€§å’Œæ­£ç¡®æ€§ï¼
