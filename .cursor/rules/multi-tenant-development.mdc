---
globs: Platform.ApiService/Services/*.cs,Platform.ServiceDefaults/Services/*.cs,Platform.ApiService/Models/*.cs
description: å¤šç§Ÿæˆ·ç³»ç»Ÿå¼€å‘è§„èŒƒå’Œæœ€ä½³å®è·µ - å®ä½“è®¾è®¡ã€å­—æ®µä½¿ç”¨å’ŒæŸ¥è¯¢æ¨¡å¼
---

# å¤šç§Ÿæˆ·ç³»ç»Ÿå¼€å‘è§„èŒƒå’Œæœ€ä½³å®è·µ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**åŒºåˆ†å•ä¸€ä¼ä¸šå…³è”å®ä½“ï¼ˆCompanyId + IMultiTenantï¼‰å’Œå¤šä¼ä¸šå…³è”å®ä½“ï¼ˆCurrentCompanyId + UserCompanyï¼‰ï¼Œç¡®ä¿æ•°æ®éš”ç¦»ã€æƒé™æ§åˆ¶å’Œç§Ÿæˆ·ä¸Šä¸‹æ–‡ç®¡ç†**

## ğŸ“Š å®ä½“ç±»å‹å¯¹æ¯”è¡¨

| å®ä½“ç±»å‹ | å…³è”å…³ç³» | ä½¿ç”¨å­—æ®µ | æ˜¯å¦å®ç° IMultiTenant | è¿‡æ»¤æ–¹å¼ |
|---------|---------|---------|---------------------|---------|
| **Role** | å•ä¸€ä¼ä¸š | `CompanyId` | âœ… æ˜¯ | è‡ªåŠ¨è¿‡æ»¤ |
| **Notice** | å•ä¸€ä¼ä¸š | `CompanyId` | âœ… æ˜¯ | è‡ªåŠ¨è¿‡æ»¤ |
| **Tag** | å•ä¸€ä¼ä¸š | `CompanyId` | âœ… æ˜¯ | è‡ªåŠ¨è¿‡æ»¤ |
| **UserActivityLog** | å•ä¸€ä¼ä¸š | `CompanyId` | âœ… æ˜¯ | è‡ªåŠ¨è¿‡æ»¤ |
| **AppUser** | å¤šä¼ä¸š | `CurrentCompanyId` + `PersonalCompanyId` | âŒ å¦ | æ‰‹åŠ¨è¿‡æ»¤ |
| **UserCompany** | å…³è”è¡¨ | `CompanyId` (å…³è”å­—æ®µ) | âœ… æ˜¯ | è‡ªåŠ¨è¿‡æ»¤ |
| **Company** | ç‹¬ç«‹å®ä½“ | æ—  | âŒ å¦ | æ— éœ€è¿‡æ»¤ |
| **Menu** | å…¨å±€èµ„æº | æ—  | âŒ å¦ | æ— éœ€è¿‡æ»¤ |

## âœ… å•ä¸€ä¼ä¸šå…³è”å®ä½“ï¼ˆä½¿ç”¨ CompanyIdï¼‰

### ä½•æ—¶å®ç° IMultiTenant

ä»¥ä¸‹å®ä½“ç±»å‹**å¿…é¡»**å®ç° `IMultiTenant` æ¥å£æˆ–ç»§æ‰¿ `MultiTenantEntity`ï¼š

```csharp
// âœ… æ­£ç¡®ï¼šè§’è‰²å±äºå•ä¸€ä¼ä¸š
public class Role : BaseEntity, IEntity, ISoftDeletable, INamedEntity, ITimestamped, IMultiTenant
{
    [BsonElement("companyId")]
    public string CompanyId { get; set; } = string.Empty;  // âœ… éç©ºï¼Œé»˜è®¤ç©ºå­—ç¬¦ä¸²
    
    [BsonElement("name")]
    public string Name { get; set; } = string.Empty;
}

// âœ… æ­£ç¡®ï¼šé€šçŸ¥å±äºå•ä¸€ä¼ä¸š
public class Notice : MultiTenantEntity
{
    // CompanyId ç”± MultiTenantEntity æä¾›ï¼ˆéç©ºï¼‰
    
    [BsonElement("title")]
    public string Title { get; set; } = string.Empty;
    
    [BsonElement("content")]
    public string Content { get; set; } = string.Empty;
}
```

### IMultiTenant æ¥å£å®šä¹‰

```csharp
// Platform.ServiceDefaults/Models/BaseEntity.cs

/// <summary>
/// å¤šç§Ÿæˆ·æ¥å£ - æä¾›ä¼ä¸šéš”ç¦»
/// </summary>
public interface IMultiTenant
{
    /// <summary>
    /// ä¼ä¸šIDï¼ˆå¿…é¡»éç©ºï¼‰
    /// </summary>
    string CompanyId { get; set; }
}

/// <summary>
/// å¤šç§Ÿæˆ·å®ä½“åŸºç±» - åŒ…å«ä¼ä¸šéš”ç¦»
/// </summary>
public abstract class MultiTenantEntity : BaseEntity, IMultiTenant
{
    [BsonElement("companyId")]
    public string CompanyId { get; set; } = string.Empty;  // âœ… éç©ºï¼Œé»˜è®¤ç©ºå­—ç¬¦ä¸²
}
```

### å·¥ä½œåŸç†

å½“å®ä½“å®ç° `IMultiTenant` æ¥å£æ—¶ï¼Œ`DatabaseOperationFactory` ä¼šè‡ªåŠ¨ä¸ºæ‰€æœ‰æŸ¥è¯¢æ·»åŠ  `CompanyId` è¿‡æ»¤ï¼š

```csharp
// Platform.ServiceDefaults/Services/DatabaseOperationFactory.cs

/// <summary>
/// åº”ç”¨å¤šç§Ÿæˆ·è¿‡æ»¤
/// âš ï¸ ä¿®å¤ï¼šä½¿ç”¨ MongoDB å­—æ®µåï¼ˆä» BsonElement ç‰¹æ€§è·å–ï¼‰è€Œé C# å±æ€§å
/// </summary>
private FilterDefinition<T> ApplyTenantFilter(FilterDefinition<T> filter)
{
    // æ£€æŸ¥å®ä½“æ˜¯å¦å®ç°å¤šç§Ÿæˆ·æ¥å£
    if (typeof(IMultiTenant).IsAssignableFrom(typeof(T)))
    {
        // âœ… ä»æ•°æ®åº“è¯»å–å½“å‰ç”¨æˆ·çš„ CurrentCompanyIdï¼ˆä¸ä½¿ç”¨ JWT tokenï¼‰
        var companyId = ResolveCurrentCompanyId();
        if (!string.IsNullOrEmpty(companyId))
        {
            var companyIdProperty = typeof(T).GetProperty("CompanyId");
            if (companyIdProperty != null)
            {
                // âœ… è·å– MongoDB å­—æ®µåï¼šä¼˜å…ˆä½¿ç”¨ BsonElement ç‰¹æ€§ï¼Œå¦åˆ™ä½¿ç”¨ camelCase
                var bsonElementAttr = companyIdProperty.GetCustomAttribute<Bson.Serialization.Attributes.BsonElementAttribute>();
                var fieldName = bsonElementAttr?.ElementName ?? "companyId";  // ç»Ÿä¸€ä½¿ç”¨å°å†™ camelCase
                
                // âœ… ä½¿ç”¨ MongoDB å­—æ®µåæ„å»ºè¿‡æ»¤å™¨
                var companyFilter = Builders<T>.Filter.Eq(fieldName, companyId);
                return Builders<T>.Filter.And(filter, companyFilter);
            }
        }
    }
    return filter;
}
```

**å…³é”®ç‚¹ï¼š**
- âœ… å®ç° `IMultiTenant` çš„å®ä½“ä¼šè‡ªåŠ¨åº”ç”¨ä¼ä¸šè¿‡æ»¤
- âœ… æ•°æ®å·¥å‚ä»æ•°æ®åº“è¯»å–ä¼ä¸šIDï¼ˆä¸ä½¿ç”¨ JWT tokenï¼‰
- âœ… ä½¿ç”¨æ­£ç¡®çš„ MongoDB å­—æ®µåï¼ˆä» `BsonElement` ç‰¹æ€§è·å–ï¼‰
- âœ… æŸ¥è¯¢æ—¶æ— éœ€æ‰‹åŠ¨æ·»åŠ  `CompanyId` è¿‡æ»¤æ¡ä»¶
- âœ… åˆ›å»ºæ—¶ä½¿ç”¨ `_factory.GetRequiredCompanyId()` è®¾ç½® `CompanyId`
- âœ… **ç¦æ­¢æ‰‹åŠ¨æ·»åŠ  CompanyId è¿‡æ»¤** - æ‰€æœ‰å®ç°äº† `IMultiTenant` çš„å®ä½“éƒ½åº”è¯¥ä¾èµ–è‡ªåŠ¨è¿‡æ»¤

### ä½¿ç”¨ç¤ºä¾‹

```csharp
// âœ… åˆ›å»ºå•ä¸€ä¼ä¸šå®ä½“
var role = new Role
{
    Name = "ç®¡ç†å‘˜",
    CompanyId = _roleFactory.GetRequiredCompanyId()  // âœ… å¿…é¡»è®¾ç½®
};
await _roleFactory.CreateAsync(role);

// âœ… æŸ¥è¯¢å•ä¸€ä¼ä¸šå®ä½“ï¼ˆè‡ªåŠ¨è¿‡æ»¤ï¼‰
var roles = await _roleFactory.FindAsync();  // âœ… è‡ªåŠ¨åªè¿”å›å½“å‰ä¼ä¸šçš„è§’è‰²

// âŒ é”™è¯¯ï¼šä¸è¦æ‰‹åŠ¨æ·»åŠ  CompanyId è¿‡æ»¤
var companyId = await GetCurrentCompanyIdAsync();
var filter = _roleFactory.CreateFilterBuilder()
    .Equal(r => r.CompanyId, companyId)  // âŒ ä¸éœ€è¦æ‰‹åŠ¨æ·»åŠ 
    .Build();
var roles = await _roleFactory.FindAsync(filter);  // âŒ é”™è¯¯åšæ³•

// âœ… æ­£ç¡®ï¼šä¾èµ–è‡ªåŠ¨è¿‡æ»¤
var filter = _roleFactory.CreateFilterBuilder()
    .Equal(r => r.IsActive, true)  // âœ… åªæ·»åŠ ä¸šåŠ¡è¿‡æ»¤
    .Build();
var roles = await _roleFactory.FindAsync(filter);  // âœ… æ•°æ®å·¥å‚ä¼šè‡ªåŠ¨æ·»åŠ ä¼ä¸šè¿‡æ»¤
```

## âœ… å¤šä¼ä¸šå…³è”å®ä½“ï¼ˆä½¿ç”¨ CurrentCompanyIdï¼‰

### ä½•æ—¶ä¸å®ç° IMultiTenant

ä»¥ä¸‹å®ä½“ç±»å‹**ä¸åº”è¯¥**å®ç° `IMultiTenant` æ¥å£æˆ–ç»§æ‰¿ `MultiTenantEntity`ï¼š

```csharp
// âœ… æ­£ç¡®ï¼šAppUser ä¸ä¼ä¸šæ˜¯å¤šå¯¹å¤šå…³ç³»ï¼Œä¸å®ç° IMultiTenant
public class AppUser : BaseEntity, IEntity, ISoftDeletable, ITimestamped
{
    [BsonId]
    [BsonRepresentation(BsonType.ObjectId)]
    public string Id { get; set; } = string.Empty;
    
    [BsonElement("username")]
    public string Username { get; set; } = string.Empty;
    
    /// <summary>
    /// å½“å‰é€‰ä¸­çš„ä¼ä¸šIDï¼ˆç”¨äºæ•°æ®éš”ç¦»å’Œèœå•æƒé™ï¼‰
    /// </summary>
    [BsonElement("currentCompanyId")]
    public string? CurrentCompanyId { get; set; }
    
    /// <summary>
    /// ä¸ªäººä¼ä¸šIDï¼ˆæ³¨å†Œæ—¶è‡ªåŠ¨åˆ›å»ºï¼‰
    /// </summary>
    [BsonElement("personalCompanyId")]
    public string? PersonalCompanyId { get; set; }
    
    // âŒ æ²¡æœ‰ CompanyId å­—æ®µ
    // é€šè¿‡ UserCompany ä¸­é—´è¡¨ç®¡ç†å¤šå¯¹å¤šå…³ç³»
}

// âœ… æ­£ç¡®ï¼šä¼ä¸šå®ä½“æœ¬èº«ä¸éœ€è¦ CompanyId
public class Company : BaseEntity, IEntity, ISoftDeletable, ITimestamped
{
    [BsonElement("name")]
    public string Name { get; set; } = string.Empty;
    
    [BsonElement("code")]
    public string Code { get; set; } = string.Empty;
}

// âœ… æ­£ç¡®ï¼šMenu æ˜¯å…¨å±€ç³»ç»Ÿèµ„æºï¼ˆæ‰€æœ‰ä¼ä¸šå…±äº«ï¼‰
public class Menu : BaseEntity, IEntity, ISoftDeletable, ITimestamped
{
    // Menu æ²¡æœ‰ CompanyIdï¼Œå› ä¸ºå®ƒæ˜¯å…¨å±€èµ„æº
    [BsonElement("name")]
    public string Name { get; set; } = string.Empty;
    
    [BsonElement("path")]
    public string Path { get; set; } = string.Empty;
}
```

### ä½¿ç”¨ç¤ºä¾‹

```csharp
// âœ… åˆ›å»º AppUserï¼ˆä½¿ç”¨ CurrentCompanyIdï¼‰
var user = new AppUser
{
    Username = "test",
    Email = "test@example.com",
    CurrentCompanyId = companyId,      // âœ… ä½¿ç”¨ CurrentCompanyId
    PersonalCompanyId = personalCompanyId
};
await _userFactory.CreateAsync(user);

// âœ… æŸ¥è¯¢ AppUserï¼ˆæ‰‹åŠ¨æ·»åŠ  CurrentCompanyId è¿‡æ»¤ï¼‰
var currentUserId = _userFactory.GetRequiredUserId();
var currentUser = await _userFactory.GetByIdAsync(currentUserId);
var currentCompanyId = currentUser?.CurrentCompanyId ?? throw new UnauthorizedAccessException("æœªæ‰¾åˆ°ä¼ä¸šä¿¡æ¯");

var filter = _userFactory.CreateFilterBuilder()
    .Equal(u => u.CurrentCompanyId, currentCompanyId)  // âœ… æ‰‹åŠ¨æ·»åŠ è¿‡æ»¤æ¡ä»¶
    .Build();
var users = await _userFactory.FindAsync(filter);
```

## ğŸ”§ ç§Ÿæˆ·ä¸Šä¸‹æ–‡ç®¡ç†

### ITenantContext æ¥å£

```csharp
// âœ… æ­£ç¡® - ç§Ÿæˆ·ä¸Šä¸‹æ–‡æœåŠ¡ï¼ˆv6.1+ å¼‚æ­¥æ”¹é€ ï¼‰
public interface ITenantContext
{
    /// <summary>
    /// è·å–å½“å‰ç”¨æˆ·IDï¼ˆä» JWT token è¯»å–ï¼‰
    /// </summary>
    string? GetCurrentUserId();

    /// <summary>
    /// è·å–å½“å‰ç”¨æˆ·åï¼ˆä»æ•°æ®åº“è¯»å–ï¼‰
    /// </summary>
    Task<string?> GetCurrentUsernameAsync();

    /// <summary>
    /// è·å–å½“å‰ä¼ä¸šIDï¼ˆä»æ•°æ®åº“è¯»å– user.CurrentCompanyIdï¼‰
    /// âš ï¸ é‡è¦ï¼šä¸å†ä» JWT token è¯»å–ï¼Œç»Ÿä¸€ä»æ•°æ®åº“è¯»å–
    /// </summary>
    Task<string?> GetCurrentCompanyIdAsync();

    /// <summary>
    /// è·å–å½“å‰ä¼ä¸šåç§°ï¼ˆä»æ•°æ®åº“è¯»å–ï¼‰
    /// </summary>
    Task<string?> GetCurrentCompanyNameAsync();

    /// <summary>
    /// æ˜¯å¦ä¸ºç®¡ç†å‘˜ï¼ˆä»æ•°æ®åº“è¯»å–ï¼‰
    /// </summary>
    Task<bool> IsAdminAsync();
}
```

**âš ï¸ é‡è¦é™åˆ¶**ï¼š

1. **`ITenantContext` ä¾èµ– `HttpContext`** - åªèƒ½åœ¨è¯·æ±‚çº¿ç¨‹ä¸­ä½¿ç”¨
2. **åå°çº¿ç¨‹ä¸å¯ç”¨** - åœ¨ `Task.Run`ã€åå°ä»»åŠ¡ç­‰åœºæ™¯ä¸­ï¼Œ`HttpContext` ä¸å¯ç”¨
3. **åå°çº¿ç¨‹è§£å†³æ–¹æ¡ˆ** - ç›´æ¥é€šè¿‡ userId ä»æ•°æ®åº“æŸ¥è¯¢ä¼ä¸šIDï¼ˆè§ä¸‹æ–¹ç¤ºä¾‹ï¼‰

### æœåŠ¡ä¸­ä½¿ç”¨ç§Ÿæˆ·ä¸Šä¸‹æ–‡

```csharp
// âœ… æ­£ç¡® - æœåŠ¡ä¸­ä½¿ç”¨ç§Ÿæˆ·ä¸Šä¸‹æ–‡ï¼ˆå•ä¸€ä¼ä¸šå®ä½“ç¤ºä¾‹ï¼šRoleï¼‰
public class RoleService : IRoleService
{
    private readonly IDatabaseOperationFactory<Role> _roleFactory;
    private readonly ILogger<RoleService> _logger;

    public RoleService(
        IDatabaseOperationFactory<Role> roleFactory,
        ILogger<RoleService> logger)
    {
        _roleFactory = roleFactory;
        _logger = logger;
    }

    public async Task<Role> CreateRoleAsync(CreateRoleRequest request)
    {
        var role = new Role
        {
            Name = request.Name,
            Description = request.Description,
            CompanyId = _roleFactory.GetRequiredCompanyId(), // âœ… è®¾ç½®ä¼ä¸šIDï¼ˆå•ä¸€ä¼ä¸šå®ä½“ï¼‰
            IsActive = true
        };

        return await _roleFactory.CreateAsync(role);
    }

    public async Task<List<Role>> GetRolesAsync(RoleListRequest request)
    {
        var filterBuilder = _roleFactory.CreateFilterBuilder();

        // âœ… æ•°æ®å·¥å‚ä¼šè‡ªåŠ¨æ·»åŠ ä¼ä¸šè¿‡æ»¤ï¼ˆå› ä¸º Role å®ç°äº† IMultiTenantï¼‰
        // åªæ·»åŠ ä¸šåŠ¡è¿‡æ»¤æ¡ä»¶
        if (!string.IsNullOrEmpty(request.Keyword))
        {
            filterBuilder.Regex(r => r.Name, request.Keyword);
        }

        if (request.IsActive.HasValue)
        {
            filterBuilder.Equal(r => r.IsActive, request.IsActive.Value);
        }

        var filter = filterBuilder.Build();
        var sort = _roleFactory.CreateSortBuilder()
            .Descending(r => r.CreatedAt)
            .Build();

        // âœ… æ•°æ®å·¥å‚ä¼šè‡ªåŠ¨æ·»åŠ ä¼ä¸šè¿‡æ»¤
        return await _roleFactory.FindAsync(filter, sort);
    }
}

// âœ… æ­£ç¡® - AppUser æœåŠ¡ï¼ˆå¤šä¼ä¸šå®ä½“ï¼Œä½¿ç”¨ CurrentCompanyIdï¼‰
public class UserService : IUserService
{
    private readonly IDatabaseOperationFactory<AppUser> _userFactory;
    private readonly ILogger<UserService> _logger;

    public UserService(
        IDatabaseOperationFactory<AppUser> userFactory,
        ILogger<UserService> logger)
    {
        _userFactory = userFactory;
        _logger = logger;
    }

    public async Task<List<AppUser>> GetUsersAsync(UserListRequest request)
    {
        // âœ… è·å–å½“å‰ç”¨æˆ·çš„ä¼ä¸šIDï¼ˆAppUser ä¸å®ç° IMultiTenantï¼Œéœ€è¦æ‰‹åŠ¨è¿‡æ»¤ï¼‰
        var currentUserId = _userFactory.GetRequiredUserId();
        var currentUser = await _userFactory.GetByIdAsync(currentUserId);
        var currentCompanyId = currentUser?.CurrentCompanyId ?? throw new UnauthorizedAccessException("æœªæ‰¾åˆ°ä¼ä¸šä¿¡æ¯");
        
        var filterBuilder = _userFactory.CreateFilterBuilder();

        // âœ… æ‰‹åŠ¨æ·»åŠ  CurrentCompanyId è¿‡æ»¤ï¼ˆAppUser ä½¿ç”¨ CurrentCompanyIdï¼Œä¸æ˜¯ CompanyIdï¼‰
        filterBuilder.Equal(u => u.CurrentCompanyId, currentCompanyId);

        // æ·»åŠ æœç´¢æ¡ä»¶
        if (!string.IsNullOrEmpty(request.Keyword))
        {
            filterBuilder.Regex(u => u.Username, request.Keyword)
                        .Regex(u => u.Email, request.Keyword);
        }

        // æ·»åŠ çŠ¶æ€è¿‡æ»¤
        if (request.IsActive.HasValue)
        {
            filterBuilder.Equal(u => u.IsActive, request.IsActive.Value);
        }

        var filter = filterBuilder.Build();
        var sort = _userFactory.CreateSortBuilder()
            .Descending(u => u.CreatedAt)
            .Build();
        
        return await _userFactory.FindAsync(filter, sort);
    }
}
```

### åå°çº¿ç¨‹ä¸­è·å–ä¼ä¸šID

**âš ï¸ é‡è¦**ï¼šåœ¨åå°çº¿ç¨‹ï¼ˆå¦‚ `Task.Run`ã€åå°ä»»åŠ¡ã€æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†ç­‰ï¼‰ä¸­ï¼Œæ— æ³•è®¿é—® `HttpContext`ï¼Œå› æ­¤ä¸èƒ½ä½¿ç”¨ `ITenantContext` æˆ– `IHttpContextAccessor`ã€‚

**âœ… æ­£ç¡®åšæ³•**ï¼šç›´æ¥é€šè¿‡ userId ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·çš„ä¼ä¸šIDï¼š

```csharp
// âœ… åå°çº¿ç¨‹ä¸­è·å–ä¼ä¸šID
public class UserActivityLogService : IUserActivityLogService
{
    private readonly IDatabaseOperationFactory<AppUser> _userFactory;

    /// <summary>
    /// å°è¯•è·å–ç”¨æˆ·çš„ä¼ä¸šIDï¼ˆä»æ•°æ®åº“è·å–ï¼Œä¸ä½¿ç”¨ JWT tokenï¼‰
    /// âš ï¸ é‡è¦ï¼šåå°çº¿ç¨‹æ— æ³•è®¿é—® HttpContextï¼Œå› æ­¤ç›´æ¥æŸ¥è¯¢æ•°æ®åº“
    /// </summary>
    private async Task<string?> TryGetUserCompanyIdAsync(string? userId)
    {
        if (string.IsNullOrEmpty(userId))
        {
            return null;
        }

        try
        {
            var user = await _userFactory.GetByIdAsync(userId);
            return user?.CurrentCompanyId;  // âœ… ä»æ•°æ®åº“è·å– CurrentCompanyId
        }
        catch
        {
            return null;
        }
    }

    public async Task LogHttpRequestAsync(LogHttpRequestRequest request)
    {
        // âœ… ä»æ•°æ®åº“è·å–ä¼ä¸šIDï¼Œè€Œä¸æ˜¯ä» JWT token
        var companyId = await TryGetUserCompanyIdAsync(request.UserId);

        var log = new UserActivityLog
        {
            CompanyId = companyId ?? string.Empty,
            // ...
        };

        await _activityLogFactory.CreateAsync(log);
    }
}
```

**âŒ é”™è¯¯åšæ³•**ï¼š

```csharp
// âŒ é”™è¯¯ï¼šåœ¨åå°çº¿ç¨‹ä¸­æ— æ³•è®¿é—® HttpContext
public class UserActivityLogService : IUserActivityLogService
{
    private readonly ITenantContext _tenantContext;  // âŒ ä¾èµ– HttpContextï¼Œåå°çº¿ç¨‹ä¸å¯ç”¨
    private readonly IHttpContextAccessor _httpContextAccessor;  // âŒ åå°çº¿ç¨‹ä¸å¯ç”¨

    public async Task LogHttpRequestAsync(...)
    {
        // âŒ åœ¨åå°çº¿ç¨‹ä¸­ä¼šå¤±è´¥ï¼ŒHttpContext ä¸å¯ç”¨
        var companyId = await _tenantContext.GetCurrentCompanyIdAsync();
        // ...
    }
}
```

**å¸¸è§åœºæ™¯**ï¼š
- æ´»åŠ¨æ—¥å¿—ä¸­é—´ä»¶ï¼ˆ`ActivityLogMiddleware`ï¼‰
- åå°ä»»åŠ¡å¤„ç†
- æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è€…
- å®šæ—¶ä»»åŠ¡
- WebSocket åå°å¤„ç†

## ğŸ¯ æƒé™æ§åˆ¶

### åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶

```csharp
// âœ… æ­£ç¡® - è§’è‰²æƒé™æ§åˆ¶
public class RoleService : IRoleService
{
    private readonly IDatabaseOperationFactory<Role> _roleFactory;
    private readonly IDatabaseOperationFactory<AppUser> _userFactory;
    private readonly ILogger<RoleService> _logger;

    public RoleService(
        IDatabaseOperationFactory<Role> roleFactory,
        IDatabaseOperationFactory<AppUser> userFactory,
        ILogger<RoleService> logger)
    {
        _roleFactory = roleFactory;
        _userFactory = userFactory;
        _logger = logger;
    }

    public async Task<Role> CreateRoleAsync(CreateRoleRequest request)
    {
        // æ£€æŸ¥æƒé™
        var currentUserId = _roleFactory.GetRequiredUserId();
        var currentUser = await _userFactory.GetByIdAsync(currentUserId);
        if (currentUser == null || !currentUser.IsAdmin)
        {
            throw new UnauthorizedAccessException("éœ€è¦ç®¡ç†å‘˜æƒé™");
        }

        var role = new Role
        {
            Name = request.Name,
            Description = request.Description,
            CompanyId = _roleFactory.GetRequiredCompanyId(), // è§’è‰²å±äºå½“å‰ä¼ä¸š
            IsActive = true
        };

        return await _roleFactory.CreateAsync(role);
    }

    public async Task<List<Role>> GetRolesAsync()
    {
        // âœ… æ•°æ®å·¥å‚ä¼šè‡ªåŠ¨æ·»åŠ ä¼ä¸šè¿‡æ»¤ï¼ˆå› ä¸º Role å®ç°äº† IMultiTenantï¼‰
        // åªæ·»åŠ ä¸šåŠ¡è¿‡æ»¤æ¡ä»¶
        var filter = _roleFactory.CreateFilterBuilder()
            .Equal(r => r.IsActive, true)
            .Build();

        return await _roleFactory.FindAsync(filter);
    }
}
```

## ğŸ¯ æ•°æ®å®‰å…¨

### æ•°æ®åŠ å¯†

```csharp
// âœ… æ­£ç¡® - æ•æ„Ÿæ•°æ®åŠ å¯†
public class UserService : IUserService
{
    private readonly IDatabaseOperationFactory<AppUser> _userFactory;
    private readonly IPasswordHasher _passwordHasher;

    public UserService(
        IDatabaseOperationFactory<AppUser> userFactory,
        IPasswordHasher passwordHasher)
    {
        _userFactory = userFactory;
        _passwordHasher = passwordHasher;
    }

    public async Task<AppUser> CreateUserAsync(CreateUserRequest request)
    {
        var user = new AppUser
        {
            Username = request.Username,
            Email = request.Email,
            // åŠ å¯†æ•æ„Ÿæ•°æ®
            PasswordHash = _passwordHasher.HashPassword(request.Password),
            CurrentCompanyId = _userFactory.GetRequiredCompanyId(),
            IsActive = true
        };

        return await _userFactory.CreateAsync(user);
    }
}
```

## ğŸš« ç¦æ­¢çš„åšæ³•

### âŒ é”™è¯¯ 1: AppUser å®ç° IMultiTenant

```csharp
// âŒ é”™è¯¯ï¼šAppUser ä¸ä¼ä¸šæ˜¯å¤šå¯¹å¤šå…³ç³»ï¼Œä¸åº”è¯¥å®ç° IMultiTenant
public class AppUser : MultiTenantEntity
{
    // è¿™ä¼šå¯¼è‡´è‡ªåŠ¨è¿‡æ»¤å†²çª
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ BaseEntityï¼Œæ‰‹åŠ¨é€šè¿‡ CurrentCompanyId è¿‡æ»¤
public class AppUser : BaseEntity
{
    public string? CurrentCompanyId { get; set; }
    public string? PersonalCompanyId { get; set; }
}
```

### âŒ é”™è¯¯ 2: AppUser ä½¿ç”¨ CompanyId æŸ¥è¯¢

```csharp
// âŒ é”™è¯¯ï¼šAppUser æ²¡æœ‰ CompanyId å­—æ®µ
var filter = _userFactory.CreateFilterBuilder()
    .Equal(u => u.CompanyId, companyId)  // âŒ ç¼–è¯‘é”™è¯¯
    .Build();

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ CurrentCompanyId
var filter = _userFactory.CreateFilterBuilder()
    .Equal(u => u.CurrentCompanyId, companyId)  // âœ… æ­£ç¡®
    .Build();
```

### âŒ é”™è¯¯ 3: Role ä½¿ç”¨ CurrentCompanyId

```csharp
// âŒ é”™è¯¯ï¼šRole æ²¡æœ‰ CurrentCompanyId å­—æ®µ
var filter = _roleFactory.CreateFilterBuilder()
    .Equal(r => r.CurrentCompanyId, companyId)  // âŒ ç¼–è¯‘é”™è¯¯
    .Build();

// âœ… æ­£ç¡®ï¼šRole ä¼šè‡ªåŠ¨é€šè¿‡ CompanyId è¿‡æ»¤ï¼ˆå®ç° IMultiTenantï¼‰
var roles = await _roleFactory.FindAsync();  // âœ… è‡ªåŠ¨è¿‡æ»¤å½“å‰ä¼ä¸š
```

### âŒ é”™è¯¯ 4: CompanyId è®¾ä¸ºå¯ç©º

```csharp
// âŒ é”™è¯¯ï¼šCompanyId ä¸åº”è¯¥å¯ç©º
public class Role : IMultiTenant
{
    public string? CompanyId { get; set; }  // âŒ å¯ç©º
}

// âœ… æ­£ç¡®ï¼šCompanyId å¿…é¡»éç©º
public class Role : IMultiTenant
{
    public string CompanyId { get; set; } = string.Empty;  // âœ… éç©º
}
```

### âŒ é”™è¯¯ 5: åˆ›å»ºæ—¶æœªè®¾ç½® CompanyId

```csharp
// âŒ é”™è¯¯ï¼šåˆ›å»ºæ—¶æ²¡æœ‰è®¾ç½® CompanyId
var role = new Role
{
    Name = "ç®¡ç†å‘˜",
    // âŒ ç¼ºå°‘ CompanyId
};

// âœ… æ­£ç¡®ï¼šåˆ›å»ºæ—¶è®¾ç½® CompanyId
var role = new Role
{
    Name = "ç®¡ç†å‘˜",
    CompanyId = _roleFactory.GetRequiredCompanyId()  // âœ… è®¾ç½®ä¼ä¸šID
};
```

### âŒ é”™è¯¯ 6: æ‰‹åŠ¨æ·»åŠ  CompanyId è¿‡æ»¤ï¼ˆIMultiTenant å®ä½“ï¼‰

```csharp
// âŒ é”™è¯¯ï¼šä¸è¦æ‰‹åŠ¨æ·»åŠ  CompanyId è¿‡æ»¤ï¼ˆä¸éœ€è¦ï¼‰
public async Task<List<Role>> GetRolesAsync()
{
    // âŒ ä¸éœ€è¦æ‰‹åŠ¨è·å– CompanyIdï¼Œæ•°æ®å·¥å‚ä¼šè‡ªåŠ¨è¿‡æ»¤
    var filter = _roleFactory.CreateFilterBuilder()
        .Equal(r => r.IsActive, true)  // âŒ å³ä½¿è¿™æ ·ï¼Œä¹Ÿä¸éœ€è¦æ‰‹åŠ¨æ·»åŠ  CompanyId
        .Build();
    return await _roleFactory.FindAsync(filter);
    // âœ… æ­£ç¡®ï¼šç›´æ¥æŸ¥è¯¢ï¼Œå·¥å‚è‡ªåŠ¨è¿‡æ»¤ CompanyId
    // return await _roleFactory.FindAsync();
}

// âœ… æ­£ç¡®ï¼šä¾èµ–è‡ªåŠ¨è¿‡æ»¤
public async Task<List<Role>> GetRolesAsync()
{
    var filter = _roleFactory.CreateFilterBuilder()
        .Equal(r => r.IsActive, true)  // âœ… åªæ·»åŠ ä¸šåŠ¡è¿‡æ»¤
        .Build();
    // âœ… æ•°æ®å·¥å‚ä¼šè‡ªåŠ¨æ·»åŠ ä¼ä¸šè¿‡æ»¤
    return await _roleFactory.FindAsync(filter);
}
```

## ğŸ“‹ è®¾è®¡å†³ç­–æ£€æŸ¥æ¸…å•

åˆ›å»ºæ–°å®ä½“æ—¶ï¼ŒæŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ£€æŸ¥ï¼š

- [ ] **å®ä½“æ˜¯å¦å±äºå•ä¸€ä¼ä¸šï¼Ÿ**
  - âœ… æ˜¯ â†’ å®ç° `IMultiTenant` æˆ–ç»§æ‰¿ `MultiTenantEntity`
  - âŒ å¦ â†’ ä¸å®ç° `IMultiTenant`ï¼Œä½¿ç”¨æ‰‹åŠ¨è¿‡æ»¤

- [ ] **å®ä½“æ˜¯å¦æ”¯æŒå¤šä¼ä¸šå…³è”ï¼Ÿ**
  - âœ… æ˜¯ï¼ˆå¦‚ AppUserï¼‰â†’ ä¸å®ç° `IMultiTenant`ï¼Œä½¿ç”¨ `CurrentCompanyId` + `UserCompany`
  - âŒ å¦ â†’ å¯ä»¥å®ç° `IMultiTenant`

- [ ] **CompanyId å­—æ®µæ˜¯å¦å¿…é¡»éç©ºï¼Ÿ**
  - âœ… æ˜¯ â†’ ä½¿ç”¨ `string CompanyId { get; set; } = string.Empty;`
  - âŒ å¦ â†’ è€ƒè™‘æ˜¯å¦åº”è¯¥å®ç° `IMultiTenant`

- [ ] **åˆ›å»ºæ—¶æ˜¯å¦è®¾ç½®äº†æ­£ç¡®çš„ä¼ä¸šIDï¼Ÿ**
  - âœ… å•ä¸€ä¼ä¸šå®ä½“ â†’ `CompanyId = _factory.GetRequiredCompanyId()`
  - âœ… å¤šä¼ä¸šå®ä½“ â†’ `CurrentCompanyId = companyId`

- [ ] **æŸ¥è¯¢æ—¶æ˜¯å¦æ­£ç¡®å¤„ç†è¿‡æ»¤ï¼Ÿ**
  - âœ… å•ä¸€ä¼ä¸šå®ä½“ â†’ è‡ªåŠ¨è¿‡æ»¤ï¼ˆæ— éœ€æ‰‹åŠ¨æ·»åŠ ï¼‰
  - âœ… å¤šä¼ä¸šå®ä½“ â†’ æ‰‹åŠ¨æ·»åŠ  `CurrentCompanyId` è¿‡æ»¤

## ğŸ“‹ å¤šç§Ÿæˆ·å¼€å‘æ£€æŸ¥æ¸…å•

åˆ›å»ºæˆ–ä¿®æ”¹å¤šç§Ÿæˆ·åŠŸèƒ½æ—¶æ£€æŸ¥ï¼š

- [ ] æ•°æ®æ¨¡å‹åŒ…å« CompanyId å­—æ®µï¼ˆIMultiTenant å®ä½“ï¼‰
- [ ] **æ•°æ®åº“æ“ä½œè‡ªåŠ¨è¿‡æ»¤ç§Ÿæˆ·æ•°æ®**ï¼š
  - [ ] æ‰€æœ‰å®ç°äº† `IMultiTenant` çš„å®ä½“æŸ¥è¯¢ä¼šè‡ªåŠ¨åº”ç”¨ä¼ä¸šè¿‡æ»¤
  - [ ] **ç¦æ­¢æ‰‹åŠ¨æ·»åŠ  CompanyId è¿‡æ»¤** - ä¾èµ–æ•°æ®å·¥å‚çš„è‡ªåŠ¨è¿‡æ»¤
  - [ ] åˆ›å»ºå®ä½“æ—¶å¿…é¡»è®¾ç½® `CompanyId`ï¼ˆä½¿ç”¨ `_factory.GetRequiredCompanyId()`ï¼‰
  - [ ] æ•°æ®å·¥å‚ä»æ•°æ®åº“è¯»å–ä¼ä¸šIDï¼ˆä¸ä½¿ç”¨ JWT tokenï¼‰
  - [ ] ä½¿ç”¨æ­£ç¡®çš„ MongoDB å­—æ®µåï¼ˆä» `BsonElement` ç‰¹æ€§è·å–ï¼‰
- [ ] **ç§Ÿæˆ·ä¸Šä¸‹æ–‡ä½¿ç”¨**ï¼š
  - [ ] åœ¨è¯·æ±‚çº¿ç¨‹ä¸­ä½¿ç”¨ `IDatabaseOperationFactory` çš„ `GetRequiredCompanyId()` æ–¹æ³•
  - [ ] åœ¨åå°çº¿ç¨‹ä¸­ç›´æ¥æŸ¥è¯¢æ•°æ®åº“è·å–ä¼ä¸šIDï¼ˆä¸ä½¿ç”¨ `ITenantContext`ï¼‰
- [ ] æƒé™æ§åˆ¶æ­£ç¡®å®ç°
- [ ] æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- [ ] å®¡è®¡æ—¥å¿—å®Œæ•´è®°å½•
- [ ] è·¨ç§Ÿæˆ·æŸ¥è¯¢æœ‰æ˜ç¡®æ ‡è¯†
- [ ] èœå•æƒé™æ­£ç¡®æ§åˆ¶
- [ ] è§’è‰²æƒé™æ­£ç¡®åˆ†é…
- [ ] æ•°æ®éš”ç¦»æµ‹è¯•é€šè¿‡

## ğŸ” å¿«é€Ÿå‚è€ƒ

```csharp
// âœ… Roleï¼ˆå•ä¸€ä¼ä¸šï¼‰
var role = new Role
{
    Name = "ç®¡ç†å‘˜",
    CompanyId = _roleFactory.GetRequiredCompanyId()  // âœ… ä½¿ç”¨ CompanyId
};
// æŸ¥è¯¢æ—¶è‡ªåŠ¨è¿‡æ»¤ï¼Œæ— éœ€æ‰‹åŠ¨æ·»åŠ  CompanyId æ¡ä»¶

// âœ… AppUserï¼ˆå¤šä¼ä¸šï¼‰
var user = new AppUser
{
    Username = "test",
    CurrentCompanyId = companyId,      // âœ… ä½¿ç”¨ CurrentCompanyId
    PersonalCompanyId = personalCompanyId
};
// æŸ¥è¯¢æ—¶éœ€è¦æ‰‹åŠ¨æ·»åŠ  CurrentCompanyId è¿‡æ»¤æ¡ä»¶
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç”¨æˆ·æœåŠ¡å®ç°](mdc:Platform.ApiService/Services/UserService.cs)
- [è§’è‰²æœåŠ¡å®ç°](mdc:Platform.ApiService/Services/RoleService.cs)
- [ä¼ä¸šæœåŠ¡å®ç°](mdc:Platform.ApiService/Services/CompanyService.cs)
- [BaseEntity.cs](mdc:Platform.ServiceDefaults/Models/BaseEntity.cs) - IMultiTenant æ¥å£å®šä¹‰
- [RoleModels.cs](mdc:Platform.ApiService/Models/RoleModels.cs) - âœ… å•ä¸€ä¼ä¸šç¤ºä¾‹ï¼šRole å®ç° IMultiTenant
- [AuthModels.cs](mdc:Platform.ApiService/Models/AuthModels.cs) - âœ… å¤šä¼ä¸šç¤ºä¾‹ï¼šAppUser ä¸å®ç° IMultiTenant
- [DatabaseOperationFactory.cs](mdc:Platform.ServiceDefaults/Services/DatabaseOperationFactory.cs) - è‡ªåŠ¨è¿‡æ»¤å®ç°
- [åç«¯æ•°æ®è®¿é—®å±‚è§„èŒƒ](mdc:.cursor/rules/backend-data-access.mdc)

## ğŸ¯ æ ¸å¿ƒåŸåˆ™æ€»ç»“

1. **å•ä¸€ä¼ä¸šå…³è”** â†’ ä½¿ç”¨ `CompanyId` + å®ç° `IMultiTenant` â†’ è‡ªåŠ¨è¿‡æ»¤
2. **å¤šä¼ä¸šå…³è”** â†’ ä½¿ç”¨ `CurrentCompanyId` + `UserCompany` â†’ æ‰‹åŠ¨è¿‡æ»¤
3. **CompanyId å¿…é¡»éç©º** â†’ ä½¿ç”¨ `string CompanyId { get; set; } = string.Empty;`
4. **åˆ›å»ºæ—¶è®¾ç½®ä¼ä¸šID** â†’ ç¡®ä¿æ–°åˆ›å»ºçš„å®ä½“éƒ½è®¾ç½®äº†æ­£ç¡®çš„ä¼ä¸šID
5. **AppUser æ°¸è¿œä¸ä½¿ç”¨ CompanyId** â†’ åªä½¿ç”¨ `CurrentCompanyId` å’Œ `PersonalCompanyId`
6. **ç¦æ­¢æ‰‹åŠ¨æ·»åŠ  CompanyId è¿‡æ»¤** - æ‰€æœ‰å®ç°äº† `IMultiTenant` çš„å®ä½“éƒ½åº”è¯¥ä¾èµ–è‡ªåŠ¨è¿‡æ»¤

éµå¾ªè¿™äº›è§„èŒƒï¼Œç¡®ä¿å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»çš„æ­£ç¡®æ€§å’Œä¸€è‡´æ€§ï¼
