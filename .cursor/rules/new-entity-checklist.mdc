---
description: æ–°å¢ä¸šåŠ¡å®ä½“å¼€å‘æ¸…å•
---

# æ–°å¢ä¸šåŠ¡å®ä½“å¼€å‘æ¸…å•

## ğŸ¯ é€‚ç”¨åœºæ™¯

å½“ä½ éœ€è¦åˆ›å»ºæ–°çš„ä¸šåŠ¡å®ä½“ï¼ˆå¦‚ Productã€Orderã€Customer ç­‰ï¼‰æ—¶ï¼Œå¿…é¡»éµå¾ªä»¥ä¸‹æ¸…å•ã€‚

## âœ… å¼ºåˆ¶æ¸…å•

### 1. å®ä½“ç±»å®šä¹‰

```csharp
// âœ… å¿…é¡»å®ç°çš„æ¥å£
public class MyEntity : IEntity, ISoftDeletable, ITimestamped
{
    // âœ… ä¸»é”®ï¼ˆå¿…é¡»ï¼‰
    [BsonId]
    [BsonRepresentation(BsonType.ObjectId)]
    public string? Id { get; set; }
    
    // âœ… å¤šç§Ÿæˆ·å­—æ®µï¼ˆv3.0 å¿…é¡»ï¼‰
    [BsonElement("companyId")]
    public string CompanyId { get; set; } = string.Empty;
    
    // âœ… è½¯åˆ é™¤å­—æ®µï¼ˆå¿…é¡»ï¼‰
    [BsonElement("isDeleted")]
    public bool IsDeleted { get; set; } = false;
    
    [BsonElement("deletedAt")]
    public DateTime? DeletedAt { get; set; }
    
    [BsonElement("deletedBy")]
    public string? DeletedBy { get; set; }
    
    [BsonElement("deletedReason")]
    public string? DeletedReason { get; set; }
    
    // âœ… æ—¶é—´æˆ³å­—æ®µï¼ˆå¿…é¡»ï¼‰
    [BsonElement("createdAt")]
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    
    [BsonElement("updatedAt")]
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
    
    // âœ… ä¸šåŠ¡å­—æ®µ
    [BsonElement("name")]
    public string Name { get; set; } = string.Empty;
    
    // ... å…¶ä»–ä¸šåŠ¡å­—æ®µ
}
```

### 2. è¯·æ±‚/å“åº”æ¨¡å‹

```csharp
// âœ… åˆ›å»ºè¯·æ±‚æ¨¡å‹
public class CreateMyEntityRequest
{
    [Required(ErrorMessage = "åç§°ä¸èƒ½ä¸ºç©º")]
    [StringLength(100, ErrorMessage = "åç§°é•¿åº¦ä¸èƒ½è¶…è¿‡100ä¸ªå­—ç¬¦")]
    public string Name { get; set; } = string.Empty;
    
    // ... å…¶ä»–å­—æ®µ
}

// âœ… æ›´æ–°è¯·æ±‚æ¨¡å‹
public class UpdateMyEntityRequest
{
    public string? Name { get; set; }
    // ... å…¶ä»–å­—æ®µï¼ˆéƒ½æ˜¯å¯é€‰ï¼‰
}
```

### 3. æœåŠ¡å±‚å®ç°

```csharp
// âœ… æœåŠ¡æ¥å£
public interface IMyEntityService
{
    Task<List<MyEntity>> GetAllAsync();
    Task<MyEntity?> GetByIdAsync(string id);
    Task<MyEntity> CreateAsync(CreateMyEntityRequest request);
    Task<bool> UpdateAsync(string id, UpdateMyEntityRequest request);
    Task<bool> DeleteAsync(string id, string? reason = null);
}

// âœ… æœåŠ¡å®ç°
public class MyEntityService : IMyEntityService
{
    private readonly IDatabaseOperationFactory<MyEntity> _entityFactory;
    private readonly ILogger<MyEntityService> _logger;
    
    public MyEntityService(
        IDatabaseOperationFactory<MyEntity> entityFactory,
        ILogger<MyEntityService> logger)
    {
        _entityFactory = entityFactory;
        _logger = logger;
    }
    
    public async Task<List<MyEntity>> GetAllAsync()
    {
        // âœ… æ•°æ®å·¥å‚è‡ªåŠ¨å¤„ç†å¤šç§Ÿæˆ·è¿‡æ»¤å’Œè½¯åˆ é™¤è¿‡æ»¤
        return await _entityFactory.FindAsync();
    }
    
    public async Task<MyEntity?> GetByIdAsync(string id)
    {
        return await _entityFactory.GetByIdAsync(id);
    }
    
    public async Task<MyEntity> CreateAsync(CreateMyEntityRequest request)
    {
        var entity = new MyEntity
        {
            Name = request.Name,
            CompanyId = _entityFactory.GetRequiredCompanyId()  // âœ… ä»å·¥å‚è·å– CompanyId
            // âœ… CreatedAt, UpdatedAt, IsDeleted ç”±æ•°æ®å·¥å‚è‡ªåŠ¨è®¾ç½®
        };
        
        return await _entityFactory.CreateAsync(entity);
    }
    
    public async Task<bool> UpdateAsync(string id, UpdateMyEntityRequest request)
    {
        var filterBuilder = _entityFactory.CreateFilterBuilder();
        var filter = filterBuilder.Equal(e => e.Id, id).Build();
        
        var updateBuilder = _entityFactory.CreateUpdateBuilder();
        var updates = new List<UpdateDefinition<MyEntity>>();
        
        if (request.Name != null)
            updates.Add(updateBuilder.Set(e => e.Name, request.Name));
        
        var update = updateBuilder.SetCurrentTimestamp().Combine(updates).Build();
        var result = await _entityFactory.UpdateManyAsync(filter, update);
        return result > 0;
    }
    
    public async Task<bool> DeleteAsync(string id, string? reason = null)
    {
        // âœ… æ•°æ®å·¥å‚è‡ªåŠ¨å¤„ç†è½¯åˆ é™¤
        return await _entityFactory.SoftDeleteAsync(id);
    }
}
```

### 4. æ§åˆ¶å™¨å®ç°

```csharp
[ApiController]
[Route("api/my-entity")]
[Authorize]  // âœ… æ§åˆ¶å™¨çº§åˆ«è¦æ±‚ç™»å½•
public class MyEntityController : BaseApiController
{
    private readonly IMyEntityService _service;

    public MyEntityController(IMyEntityService service)
    {
        _service = service;
    }

    /// <summary>
    /// è·å–æ‰€æœ‰å®ä½“
    /// </summary>
    [HttpGet]
    [RequirePermission("my-entity", "read")]  // âœ… å£°æ˜å¼æƒé™
    public async Task<IActionResult> GetAll()
    {
        var entities = await _service.GetAllAsync();
        return Success(entities);
    }

    /// <summary>
    /// æ ¹æ®IDè·å–å®ä½“
    /// </summary>
    [HttpGet("{id}")]
    [RequirePermission("my-entity", "read")]
    public async Task<IActionResult> GetById(string id)
    {
        var entity = await _service.GetByIdAsync(id);
        return Success(entity.EnsureFound("å®ä½“", id));
    }

    /// <summary>
    /// åˆ›å»ºå®ä½“
    /// </summary>
    [HttpPost]
    [RequirePermission("my-entity", "create")]
    public async Task<IActionResult> Create([FromBody] CreateMyEntityRequest request)
    {
        request.Name.EnsureNotEmpty("åç§°");
        
        var entity = await _service.CreateAsync(request);
        return Success(entity, ErrorMessages.CreateSuccess);
    }

    /// <summary>
    /// æ›´æ–°å®ä½“
    /// </summary>
    [HttpPut("{id}")]
    [RequirePermission("my-entity", "update")]
    public async Task<IActionResult> Update(string id, [FromBody] UpdateMyEntityRequest request)
    {
        var success = await _service.UpdateAsync(id, request);
        success.EnsureSuccess("å®ä½“", id);
        return Success(ErrorMessages.UpdateSuccess);
    }

    /// <summary>
    /// åˆ é™¤å®ä½“
    /// </summary>
    [HttpDelete("{id}")]
    [RequirePermission("my-entity", "delete")]
    public async Task<IActionResult> Delete(string id, [FromQuery] string? reason = null)
    {
        var success = await _service.DeleteAsync(id, reason);
        success.EnsureSuccess("å®ä½“", id);
        return Success(ErrorMessages.DeleteSuccess);
    }
}
```

### 5. æœåŠ¡æ³¨å†Œ

åœ¨ [Program.cs](mdc:Platform.ApiService/Program.cs) ä¸­æ³¨å†Œï¼š

```csharp
// âœ… æ³¨å†Œæ•°æ®åº“æ“ä½œå·¥å‚ï¼ˆå¦‚æœè¿˜æ²¡æœ‰æ³¨å†Œï¼‰
builder.Services.AddDatabaseFactory();

// âœ… æ³¨å†ŒæœåŠ¡
builder.Services.AddScoped<IMyEntityService, MyEntityService>();
```

### 6. æ•°æ®åº“ç´¢å¼•

åœ¨ [CreateAllIndexes.cs](mdc:Platform.DataInitializer/Scripts/CreateAllIndexes.cs) ä¸­æ·»åŠ ç´¢å¼•ï¼š

```csharp
private async Task CreateMyEntityIndexesAsync()
{
    var collection = _database.GetCollection<MyEntity>("my_entities");

    // (CompanyId, Name) å¤åˆå”¯ä¸€ç´¢å¼• - ä¼ä¸šå†…åç§°å”¯ä¸€
    var companyNameIndex = Builders<MyEntity>.IndexKeys
        .Ascending(e => e.CompanyId)
        .Ascending(e => e.Name);
    await collection.Indexes.CreateOneAsync(
        new CreateIndexModel<MyEntity>(companyNameIndex, new CreateIndexOptions
        {
            Unique = true,
            Name = "idx_myentity_company_name_unique"
        })
    );

    // (CompanyId, IsDeleted) å¤åˆç´¢å¼•
    var companyDeletedIndex = Builders<MyEntity>.IndexKeys
        .Ascending(e => e.CompanyId)
        .Ascending(e => e.IsDeleted);
    await collection.Indexes.CreateOneAsync(
        new CreateIndexModel<MyEntity>(companyDeletedIndex, new CreateIndexOptions
        {
            Name = "idx_myentity_company_isdeleted"
        })
    );

    _logger.LogInformation("MyEntity ç´¢å¼•åˆ›å»ºå®Œæˆ");
}
```

å¹¶åœ¨ `CreateIndexesAsync()` æ–¹æ³•ä¸­è°ƒç”¨ï¼š

```csharp
public async Task CreateIndexesAsync()
{
    // ... ç°æœ‰ç´¢å¼•
    
    // 7. MyEntity ç´¢å¼•
    await CreateMyEntityIndexesAsync();
    
    _logger.LogInformation("å¤šç§Ÿæˆ·ç´¢å¼•åˆ›å»ºå®Œæˆï¼");
}
```

### 7. æƒé™åˆå§‹åŒ–

åœ¨ [PermissionService.cs](mdc:Platform.ApiService/Services/PermissionService.cs) çš„ `GetDefaultPermissions()` æ–¹æ³•ä¸­æ·»åŠ ï¼š

```csharp
var resources = new[]
{
    // ... ç°æœ‰èµ„æº
    ("my-entity", "æˆ‘çš„å®ä½“"),  // æ–°å¢
};
```

## ğŸ” å¸¸è§é”™è¯¯

### é”™è¯¯ 1ï¼šå¿˜è®°æ·»åŠ  CompanyId

```csharp
// âŒ é”™è¯¯ï¼šç¼ºå°‘ companyId å­—æ®µ
public class MyEntity : IEntity, ISoftDeletable, ITimestamped
{
    public string? Id { get; set; }
    public string Name { get; set; } = string.Empty;
    // âŒ ç¼ºå°‘ CompanyIdï¼
}

// âœ… æ­£ç¡®ï¼šåŒ…å« companyId
public class MyEntity : IEntity, ISoftDeletable, ITimestamped
{
    public string? Id { get; set; }
    
    [BsonElement("companyId")]
    public string CompanyId { get; set; } = string.Empty;  // âœ…
    
    public string Name { get; set; } = string.Empty;
}
```

### é”™è¯¯ 2ï¼šæœåŠ¡æ„é€ å‡½æ•°ç¼ºå°‘å¿…è¦çš„ä¾èµ–

```csharp
// âŒ é”™è¯¯ï¼šç¼ºå°‘ IDatabaseOperationFactory
public MyService(ILogger<MyService> logger)
{
    // âŒ æ— æ³•è¿›è¡Œæ•°æ®è®¿é—®
}

// âœ… æ­£ç¡®ï¼šæ³¨å…¥ IDatabaseOperationFactory
public MyService(
    IDatabaseOperationFactory<MyEntity> entityFactory,
    ILogger<MyService> logger)
{
    _entityFactory = entityFactory;  // âœ… é€šè¿‡å·¥å‚è¿›è¡Œæ•°æ®è®¿é—®
    _logger = logger;
}
```

### é”™è¯¯ 3ï¼šç›´æ¥ä½¿ç”¨ IMongoCollection æˆ– BaseRepository

```csharp
// âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨ IMongoCollectionï¼Œç»•è¿‡å¤šç§Ÿæˆ·è¿‡æ»¤
var collection = _database.GetCollection<MyEntity>("my_entities");
var all = await collection.Find(_ => true).ToListAsync();

// âŒ é”™è¯¯ï¼šä½¿ç”¨å·²ç§»é™¤çš„ BaseRepository
private readonly BaseRepository<MyEntity> _repository;

// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ•°æ®åº“æ“ä½œå·¥å‚
private readonly IDatabaseOperationFactory<MyEntity> _entityFactory;

public MyEntityService(IDatabaseOperationFactory<MyEntity> entityFactory)
{
    _entityFactory = entityFactory;  // âœ… é€šè¿‡ä¾èµ–æ³¨å…¥è·å–
}
```

### é”™è¯¯ 4ï¼šå¿˜è®°æ³¨å†Œæ•°æ®åº“æ“ä½œå·¥å‚

```csharp
// âŒ é”™è¯¯ï¼šåœ¨ Program.cs ä¸­å¿˜è®°æ³¨å†Œå·¥å‚
builder.Services.AddScoped<IMyEntityService, MyEntityService>();
// âŒ ç¼ºå°‘å·¥å‚æ³¨å†Œ

// âœ… æ­£ç¡®ï¼šæ³¨å†Œæ•°æ®åº“æ“ä½œå·¥å‚
builder.Services.AddDatabaseFactory();  // âœ… æ³¨å†Œæ‰€æœ‰å®ä½“å·¥å‚
// æˆ–è€…
builder.Services.AddDatabaseOperationFactory<MyEntity>();  // âœ… æ³¨å†Œç‰¹å®šå®ä½“å·¥å‚
builder.Services.AddScoped<IMyEntityService, MyEntityService>();
```

## ğŸ“ å®Œæ•´å¼€å‘æ¸…å•

æ–°å¢ä¸šåŠ¡å®ä½“æ—¶ï¼ŒæŒ‰é¡ºåºå®Œæˆï¼š

- [ ] 1. åˆ›å»ºå®ä½“ç±»ï¼ˆåŒ…å« CompanyIdï¼Œå®ç° IMultiTenant æ¥å£ï¼‰
- [ ] 2. å®ç° IEntity, ISoftDeletable, ITimestamped, IMultiTenant
- [ ] 3. åˆ›å»ºè¯·æ±‚/å“åº”æ¨¡å‹
- [ ] 4. åˆ›å»ºæœåŠ¡æ¥å£å’Œå®ç°ï¼ˆç›´æ¥å®ç°æ¥å£ï¼Œæ³¨å…¥ IDatabaseOperationFactoryï¼‰
- [ ] 5. ä½¿ç”¨ IDatabaseOperationFactory<T> è¿›è¡Œæ•°æ®è®¿é—®
- [ ] 6. åœ¨ Program.cs æ³¨å†Œæ•°æ®åº“æ“ä½œå·¥å‚å’ŒæœåŠ¡
- [ ] 7. åˆ›å»ºæ§åˆ¶å™¨ï¼ˆç»§æ‰¿ BaseApiControllerï¼‰
- [ ] 8. åœ¨æ•°æ®åˆå§‹åŒ–æœåŠ¡ä¸­åˆ›å»ºæ•°æ®åº“ç´¢å¼•ï¼ˆCompanyId ç›¸å…³ï¼‰
- [ ] 9. æ·»åŠ æƒé™å®šä¹‰åˆ° PermissionService
- [ ] 10. æµ‹è¯•æ•°æ®éš”ç¦»ï¼ˆåˆ›å»ºå¤šä¸ªä¼ä¸šéªŒè¯ï¼‰

## ğŸ¯ è®°ä½

**ä¸‰ä¸ªå¿…é¡»ï¼š**
1. âœ… å®ä½“å¿…é¡»æœ‰ `companyId` å­—æ®µå¹¶å®ç° `IMultiTenant` æ¥å£
2. âœ… æœåŠ¡å¿…é¡»ä½¿ç”¨ `IDatabaseOperationFactory<T>` è¿›è¡Œæ•°æ®è®¿é—®
3. âœ… å¿…é¡»åœ¨ Program.cs ä¸­æ³¨å†Œæ•°æ®åº“æ“ä½œå·¥å‚

éµå¾ªæ¸…å•ï¼Œç¡®ä¿å¤šç§Ÿæˆ·æ¶æ„çš„å®Œæ•´æ€§ï¼

