---
description: ç¦æ­¢åˆ›å»ºå…¨å±€æ•°æ®ï¼Œç¡®ä¿å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»
alwaysApply: true
---

# ç¦æ­¢åˆ›å»ºå…¨å±€æ•°æ® - å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»è§„èŒƒ

## ğŸš¨ æ ¸å¿ƒåŸåˆ™

**ä¸¥æ ¼ç¦æ­¢åˆ›å»ºæ²¡æœ‰ CompanyId çš„å…¨å±€æ•°æ®ã€‚æ‰€æœ‰ä¸šåŠ¡æ•°æ®å¿…é¡»å½’å±äºç‰¹å®šä¼ä¸šã€‚**

## âŒ ç¦æ­¢çš„è¡Œä¸º

### 1. åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶åˆ›å»ºå…¨å±€æ•°æ®

```csharp
// âŒ ç¦æ­¢ï¼šåœ¨ Program.cs ä¸­åˆ›å»ºå…¨å±€èœå•/è§’è‰²/æƒé™
var initialMenuData = new InitialMenuData(database);
await initialMenuData.InitializeAsync();  // åˆ›å»ºçš„æ•°æ®æ²¡æœ‰ CompanyId

var initializePermissions = new InitializePermissions(database, logger);
await initializePermissions.InitializeAsync();  // åˆ›å»ºçš„æ•°æ®æ²¡æœ‰ CompanyId
```

### 2. åˆ›å»ºæ²¡æœ‰ CompanyId çš„ä¸šåŠ¡æ•°æ®

```csharp
// âŒ ç¦æ­¢ï¼šRole æ²¡æœ‰ CompanyId
var role = new Role
{
    Name = "ç®¡ç†å‘˜",
    Description = "ç®¡ç†å‘˜è§’è‰²",
    // âŒ ç¼ºå°‘ CompanyId
};

// âŒ ç¦æ­¢ï¼šNotice æ²¡æœ‰ CompanyId
var notice = new Notice
{
    Title = "ç³»ç»Ÿé€šçŸ¥",
    Content = "æ¬¢è¿ä½¿ç”¨ç³»ç»Ÿ",
    // âŒ ç¼ºå°‘ CompanyIdï¼Œä¼šæˆä¸ºå­¤å„¿æ•°æ®
};

// âŒ ç¦æ­¢ï¼šTag æ²¡æœ‰ CompanyId
var tag = new Tag
{
    Name = "é‡è¦",
    Color = "#ff0000",
    // âŒ ç¼ºå°‘ CompanyId
};
```

## âœ… æ­£ç¡®çš„åšæ³•

### 1. ä¸šåŠ¡æ•°æ®å¿…é¡»è®¾ç½® CompanyId

```csharp
// âœ… æ­£ç¡®ï¼šRole è®¾ç½® CompanyId
var role = new Role
{
    Name = "ç®¡ç†å‘˜",
    Description = "ç®¡ç†å‘˜è§’è‰²",
    CompanyId = company.Id!  // âœ… å¿…é¡»è®¾ç½®
};

// âœ… æ­£ç¡®ï¼šNotice è®¾ç½® CompanyId
var notice = new Notice
{
    Title = "ä¼ä¸šé€šçŸ¥",
    Content = "æ¬¢è¿ä½¿ç”¨ç³»ç»Ÿ",
    CompanyId = company.Id!  // âœ… å¿…é¡»è®¾ç½®
};

// âœ… æ­£ç¡®ï¼šTag è®¾ç½® CompanyId
var tag = new Tag
{
    Name = "é‡è¦",
    Color = "#ff0000",
    CompanyId = company.Id!  // âœ… å¿…é¡»è®¾ç½®
};
```

### 2. ä½¿ç”¨å¤šç§Ÿæˆ·åŸºç±»

```csharp
// âœ… Notice ç»§æ‰¿ MultiTenantEntity
public class Notice : MultiTenantEntity
{
    // CompanyId ç”± MultiTenantEntity æä¾›
    public string Title { get; set; }
    public string Content { get; set; }
}

// âœ… Tag ç»§æ‰¿ MultiTenantEntity
public class Tag : MultiTenantEntity
{
    // CompanyId ç”± MultiTenantEntity æä¾›
    public string Name { get; set; }
    public string Color { get; set; }
}
```

### 3. åœ¨åˆ›å»ºæ—¶éªŒè¯ CompanyId

```csharp
// âœ… åˆ›å»ºå‰éªŒè¯
public async Task<Notice> CreateNoticeAsync(CreateNoticeRequest request)
{
    var companyId = GetRequiredCompanyId();  // è·å–å½“å‰ä¼ä¸šID
    
    var notice = new Notice
    {
        Title = request.Title,
        Content = request.Content,
        CompanyId = companyId,  // âœ… è®¾ç½®ä¼ä¸šID
        // ...
    };
    
    await _notices.InsertOneAsync(notice);
    return notice;
}
```

## ğŸ” æ£€æŸ¥å…¨å±€æ•°æ®

### æŸ¥è¯¢å¯èƒ½çš„å­¤å„¿æ•°æ®

```javascript
// MongoDB æŸ¥è¯¢æ£€æŸ¥ä¸šåŠ¡æ•°æ®æ˜¯å¦æœ‰ä¼ä¸šå½’å±
db.roles.find({ companyId: { $exists: false } })
db.roles.find({ companyId: "" })
db.roles.find({ companyId: null })

db.notices.find({ companyId: { $exists: false } })
db.notices.find({ companyId: "" })
db.notices.find({ companyId: null })

db.tags.find({ companyId: { $exists: false } })
db.tags.find({ companyId: "" })
db.tags.find({ companyId: null })
```

**é¢„æœŸç»“æœ**: æ‰€æœ‰æŸ¥è¯¢éƒ½åº”è¯¥è¿”å›ç©ºç»“æœ

## ğŸ“‹ å¤šç§Ÿæˆ·å®ä½“æ¸…å•

ä»¥ä¸‹å®ä½“å¿…é¡»æœ‰ CompanyIdï¼š

| å®ä½“ | åŸºç±» | CompanyId è¦æ±‚ |
|------|------|---------------|
| **Role** | ISoftDeletable | âœ… å¿…é¡» |
| **Notice** | MultiTenantEntity | âœ… å¿…é¡» |
| **Tag** | MultiTenantEntity | âœ… å¿…é¡» |
| **ActivityLog** | MultiTenantEntity | âœ… å¿…é¡» |

### ç‰¹æ®Šå®ä½“ï¼ˆæ—  CompanyId çš„åˆç†ä¾‹å¤–ï¼‰

| å®ä½“ | CompanyId | è¯´æ˜ |
|------|-----------|------|
| **Company** | âŒ ä¸éœ€è¦ | ä¼ä¸šå®ä½“æœ¬èº« |
| **Menu** | âŒ ä¸éœ€è¦ | â­ v5.0: å…¨å±€ç³»ç»Ÿèµ„æºï¼Œæ‰€æœ‰ä¼ä¸šå…±äº« |
| **AppUser** | âœ… éœ€è¦ | é€šè¿‡ CurrentCompanyId å…³è”ä¼ä¸š |
| **UserCompany** | âœ… éœ€è¦ | å…³è”è¡¨ï¼Œæœ‰ CompanyId å­—æ®µ |

### â­ v5.0 é‡è¦å˜æ›´ï¼šMenu æ˜¯å…¨å±€èµ„æº

**Menu ä¸å†æœ‰ CompanyId**ï¼ŒåŸå› ï¼š
- æ‰€æœ‰ä¼ä¸šä½¿ç”¨ç›¸åŒçš„ç³»ç»Ÿèœå•
- é€šè¿‡è§’è‰²çš„ MenuIds æ§åˆ¶ç”¨æˆ·å¯è§èœå•
- é€šè¿‡æƒé™æ§åˆ¶èœå•å†…çš„åŠŸèƒ½è®¿é—®
- èœå•åœ¨ç³»ç»Ÿåˆå§‹åŒ–æ—¶åˆ›å»ºï¼Œç”¨æˆ·ä¸èƒ½ç®¡ç†

è¯¦è§ï¼š[å…¨å±€èœå•æ¶æ„](mdc:.cursor/rules/global-menu-architecture.mdc)

## ğŸš« å·²åºŸå¼ƒçš„åˆå§‹åŒ–è„šæœ¬

ä»¥ä¸‹è„šæœ¬**ä¸åº”è¯¥åœ¨ Program.cs ä¸­è°ƒç”¨**ï¼š

```csharp
// âŒ å·²åºŸå¼ƒï¼šåˆ›å»ºå…¨å±€èœå•å’Œè§’è‰²
// var initialMenuData = new InitialMenuData(database);
// await initialMenuData.InitializeAsync();

// âŒ å·²åºŸå¼ƒï¼šåˆ›å»ºå…¨å±€æƒé™
// var initializePermissions = new InitializePermissions(database, logger);
// await initializePermissions.InitializeAsync();

// âŒ å·²åºŸå¼ƒï¼šåˆ›å»ºé»˜è®¤adminç”¨æˆ·
// var createAdminUser = new CreateAdminUser(database);
// await createAdminUser.CreateDefaultAdminAsync();
```

**åŸå› **ï¼š
- è¿™äº›è„šæœ¬åˆ›å»ºçš„æ•°æ®æ²¡æœ‰ CompanyId
- æˆä¸ºå­¤å„¿æ•°æ®ï¼Œæ— æ³•è¢«ä»»ä½•ç”¨æˆ·ä½¿ç”¨
- ç”¨æˆ·æ³¨å†Œæ—¶ä¼šè‡ªåŠ¨åˆ›å»ºä¼ä¸šä¸“å±æ•°æ®

## âœ… æ­£ç¡®çš„æ•°æ®åˆ›å»ºæ—¶æœº

### ç”¨æˆ·æ³¨å†Œæ—¶åˆ›å»º
```csharp
// âœ… åœ¨ç”¨æˆ·æ³¨å†Œæ—¶åˆ›å»ºä¼ä¸šä¸“å±æ•°æ®
public async Task<Company> CreatePersonalCompanyAsync(AppUser user)
{
    var company = new Company { /* ... */ };
    
    // åˆ›å»ºä¼ä¸šä¸“å±çš„æƒé™
    var permissions = CreateDefaultPermissions(company.Id!);
    
    // åˆ›å»ºä¼ä¸šä¸“å±çš„è§’è‰²
    var role = new Role { CompanyId = company.Id!, /* ... */ };
    
    // åˆ›å»ºä¼ä¸šä¸“å±çš„èœå•
    var menus = CreateDefaultMenus(company.Id!);
    
    // æ‰€æœ‰æ•°æ®éƒ½æœ‰ CompanyId
}
```

å‚è€ƒå®ç°ï¼š[AuthService.cs](mdc:Platform.ApiService/Services/AuthService.cs) - `CreatePersonalCompanyAsync()` æ–¹æ³•

## ğŸ”§ ä»£ç å®¡æŸ¥æ¸…å•

åœ¨åˆ›å»ºæˆ–ä¿®æ”¹å¤šç§Ÿæˆ·æ•°æ®æ—¶ï¼Œæ£€æŸ¥ï¼š

- [ ] æ‰€æœ‰ Role å®ä½“éƒ½è®¾ç½®äº† CompanyId
- [ ] æ‰€æœ‰ Notice å®ä½“éƒ½è®¾ç½®äº† CompanyId
- [ ] æ‰€æœ‰ Tag å®ä½“éƒ½è®¾ç½®äº† CompanyId
- [ ] æ‰€æœ‰ ActivityLog å®ä½“éƒ½è®¾ç½®äº† CompanyId
- [ ] ä¸åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶åˆ›å»ºå…¨å±€ä¸šåŠ¡æ•°æ®
- [ ] ä¸è°ƒç”¨å·²åºŸå¼ƒçš„åˆå§‹åŒ–è„šæœ¬
- [ ] æ•°æ®åˆ›å»ºä½¿ç”¨äº‹åŠ¡ä¿æŠ¤
- [ ] Menu å®ä½“æ­£ç¡®åœ°ä½œä¸ºå…¨å±€èµ„æºï¼ˆæ—  CompanyIdï¼‰

## ğŸ¯ æ ¸å¿ƒåŸåˆ™é‡ç”³

1. **æ— å…¨å±€æ•°æ®** - æ‰€æœ‰ä¸šåŠ¡æ•°æ®éƒ½æœ‰ CompanyId
2. **ä¼ä¸šéš”ç¦»** - æ¯ä¸ªä¼ä¸šçš„æ•°æ®å®Œå…¨ç‹¬ç«‹
3. **ç”¨æˆ·æ³¨å†Œåˆ›å»º** - æ•°æ®åœ¨ç”¨æˆ·æ³¨å†Œæ—¶è‡ªåŠ¨åˆ›å»º
4. **äº‹åŠ¡ä¿æŠ¤** - ç¡®ä¿æ•°æ®åˆ›å»ºçš„åŸå­æ€§
5. **ä¸¥æ ¼éªŒè¯** - åˆ›å»ºå‰å¿…é¡»éªŒè¯ CompanyId

éµå¾ªè¿™äº›è§„èŒƒï¼Œç¡®ä¿å¤šç§Ÿæˆ·ç³»ç»Ÿçš„æ•°æ®å®‰å…¨å’Œéš”ç¦»ï¼

