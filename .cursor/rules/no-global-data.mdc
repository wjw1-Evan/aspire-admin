---
description: ç¦æ­¢åˆ›å»ºå…¨å±€æ•°æ®ï¼Œç¡®ä¿å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»
alwaysApply: true
---

# ç¦æ­¢åˆ›å»ºå…¨å±€æ•°æ® - å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»è§„èŒƒ

## ğŸš¨ æ ¸å¿ƒåŸåˆ™

**ä¸¥æ ¼ç¦æ­¢åˆ›å»ºæ²¡æœ‰ CompanyId çš„å…¨å±€æ•°æ®ã€‚æ‰€æœ‰ä¸šåŠ¡æ•°æ®å¿…é¡»å½’å±äºç‰¹å®šä¼ä¸šã€‚**

## âŒ ç¦æ­¢çš„è¡Œä¸º

### 1. åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶åˆ›å»ºå…¨å±€æ•°æ®

```csharp
// âŒ ç¦æ­¢ï¼šåœ¨ Program.cs ä¸­åˆ›å»ºå…¨å±€èœå•/è§’è‰²/æƒé™
var initialMenuData = new InitialMenuData(database);
await initialMenuData.InitializeAsync();  // åˆ›å»ºçš„æ•°æ®æ²¡æœ‰ CompanyId

var initializePermissions = new InitializePermissions(database, logger);
await initializePermissions.InitializeAsync();  // åˆ›å»ºçš„æ•°æ®æ²¡æœ‰ CompanyId
```

### 2. åˆ›å»ºæ²¡æœ‰ CompanyId çš„å®ä½“

```csharp
// âŒ ç¦æ­¢ï¼šMenu æ²¡æœ‰ CompanyId
var menu = new Menu
{
    Name = "dashboard",
    Title = "ä»ªè¡¨æ¿",
    Path = "/dashboard",
    // âŒ ç¼ºå°‘ CompanyIdï¼Œä¼šæˆä¸ºå­¤å„¿æ•°æ®
};

// âŒ ç¦æ­¢ï¼šRole æ²¡æœ‰ CompanyId
var role = new Role
{
    Name = "ç®¡ç†å‘˜",
    Description = "ç®¡ç†å‘˜è§’è‰²",
    // âŒ ç¼ºå°‘ CompanyId
};

// âŒ ç¦æ­¢ï¼šPermission æ²¡æœ‰ CompanyId
var permission = new Permission
{
    ResourceName = "user",
    Action = "create",
    Code = "user:create",
    // âŒ ç¼ºå°‘ CompanyId
};
```

## âœ… æ­£ç¡®çš„åšæ³•

### 1. æ‰€æœ‰å®ä½“å¿…é¡»è®¾ç½® CompanyId

```csharp
// âœ… æ­£ç¡®ï¼šMenu è®¾ç½® CompanyId
var menu = new Menu
{
    Name = "dashboard",
    Title = "ä»ªè¡¨æ¿",
    Path = "/dashboard",
    CompanyId = company.Id!  // âœ… å¿…é¡»è®¾ç½®
};

// âœ… æ­£ç¡®ï¼šRole è®¾ç½® CompanyId
var role = new Role
{
    Name = "ç®¡ç†å‘˜",
    Description = "ç®¡ç†å‘˜è§’è‰²",
    CompanyId = company.Id!  // âœ… å¿…é¡»è®¾ç½®
};

// âœ… æ­£ç¡®ï¼šPermission è®¾ç½® CompanyId
var permission = new Permission
{
    ResourceName = "user",
    Action = "create",
    Code = "user:create",
    CompanyId = company.Id!  // âœ… å¿…é¡»è®¾ç½®
};
```

### 2. ä½¿ç”¨å¤šç§Ÿæˆ·åŸºç±»

```csharp
// âœ… Menu ç»§æ‰¿ MultiTenantEntity
public class Menu : MultiTenantEntity, INamedEntity
{
    // CompanyId ç”± MultiTenantEntity æä¾›
}

// âœ… Permission ç»§æ‰¿ MultiTenantEntity
public class Permission : MultiTenantEntity
{
    // CompanyId ç”± MultiTenantEntity æä¾›
}
```

### 3. åœ¨åˆ›å»ºæ—¶éªŒè¯ CompanyId

```csharp
// âœ… åˆ›å»ºå‰éªŒè¯
public async Task<Menu> CreateMenuAsync(CreateMenuRequest request)
{
    var companyId = GetRequiredCompanyId();  // è·å–å½“å‰ä¼ä¸šID
    
    var menu = new Menu
    {
        Name = request.Name,
        Title = request.Title,
        CompanyId = companyId,  // âœ… è®¾ç½®ä¼ä¸šID
        // ...
    };
    
    await _menus.InsertOneAsync(menu);
    return menu;
}
```

## ğŸ” æ£€æŸ¥å…¨å±€æ•°æ®

### æŸ¥è¯¢å¯èƒ½çš„å­¤å„¿æ•°æ®

```javascript
// MongoDB æŸ¥è¯¢
db.menus.find({ companyId: { $exists: false } })
db.menus.find({ companyId: "" })
db.menus.find({ companyId: null })

db.roles.find({ companyId: { $exists: false } })
db.roles.find({ companyId: "" })
db.roles.find({ companyId: null })

db.permissions.find({ companyId: { $exists: false } })
db.permissions.find({ companyId: "" })
db.permissions.find({ companyId: null })
```

**é¢„æœŸç»“æœ**: æ‰€æœ‰æŸ¥è¯¢éƒ½åº”è¯¥è¿”å›ç©ºç»“æœ

## ğŸ“‹ å¤šç§Ÿæˆ·å®ä½“æ¸…å•

ä»¥ä¸‹å®ä½“å¿…é¡»æœ‰ CompanyIdï¼š

| å®ä½“ | åŸºç±» | CompanyId è¦æ±‚ |
|------|------|---------------|
| **Menu** | MultiTenantEntity | âœ… å¿…é¡» |
| **Role** | ISoftDeletable | âœ… å¿…é¡» |
| **Permission** | MultiTenantEntity | âœ… å¿…é¡» |
| **Notice** | MultiTenantEntity | âœ… å¿…é¡» |
| **Tag** | MultiTenantEntity | âœ… å¿…é¡» |
| **ActivityLog** | MultiTenantEntity | âœ… å¿…é¡» |

### ç‰¹æ®Šå®ä½“

| å®ä½“ | CompanyId | è¯´æ˜ |
|------|-----------|------|
| **Company** | âŒ ä¸éœ€è¦ | ä¼ä¸šå®ä½“æœ¬èº« |
| **AppUser** | âœ… éœ€è¦ | é€šè¿‡ MultiTenantEntity |
| **UserCompany** | âœ… éœ€è¦ | å…³è”è¡¨ï¼Œæœ‰ CompanyId å­—æ®µ |

## ğŸš« å·²åºŸå¼ƒçš„åˆå§‹åŒ–è„šæœ¬

ä»¥ä¸‹è„šæœ¬**ä¸åº”è¯¥åœ¨ Program.cs ä¸­è°ƒç”¨**ï¼š

```csharp
// âŒ å·²åºŸå¼ƒï¼šåˆ›å»ºå…¨å±€èœå•å’Œè§’è‰²
// var initialMenuData = new InitialMenuData(database);
// await initialMenuData.InitializeAsync();

// âŒ å·²åºŸå¼ƒï¼šåˆ›å»ºå…¨å±€æƒé™
// var initializePermissions = new InitializePermissions(database, logger);
// await initializePermissions.InitializeAsync();

// âŒ å·²åºŸå¼ƒï¼šåˆ›å»ºé»˜è®¤adminç”¨æˆ·
// var createAdminUser = new CreateAdminUser(database);
// await createAdminUser.CreateDefaultAdminAsync();
```

**åŸå› **ï¼š
- è¿™äº›è„šæœ¬åˆ›å»ºçš„æ•°æ®æ²¡æœ‰ CompanyId
- æˆä¸ºå­¤å„¿æ•°æ®ï¼Œæ— æ³•è¢«ä»»ä½•ç”¨æˆ·ä½¿ç”¨
- ç”¨æˆ·æ³¨å†Œæ—¶ä¼šè‡ªåŠ¨åˆ›å»ºä¼ä¸šä¸“å±æ•°æ®

## âœ… æ­£ç¡®çš„æ•°æ®åˆ›å»ºæ—¶æœº

### ç”¨æˆ·æ³¨å†Œæ—¶åˆ›å»º
```csharp
// âœ… åœ¨ç”¨æˆ·æ³¨å†Œæ—¶åˆ›å»ºä¼ä¸šä¸“å±æ•°æ®
public async Task<Company> CreatePersonalCompanyAsync(AppUser user)
{
    var company = new Company { /* ... */ };
    
    // åˆ›å»ºä¼ä¸šä¸“å±çš„æƒé™
    var permissions = CreateDefaultPermissions(company.Id!);
    
    // åˆ›å»ºä¼ä¸šä¸“å±çš„è§’è‰²
    var role = new Role { CompanyId = company.Id!, /* ... */ };
    
    // åˆ›å»ºä¼ä¸šä¸“å±çš„èœå•
    var menus = CreateDefaultMenus(company.Id!);
    
    // æ‰€æœ‰æ•°æ®éƒ½æœ‰ CompanyId
}
```

å‚è€ƒå®ç°ï¼š[AuthService.cs](mdc:Platform.ApiService/Services/AuthService.cs) - `CreatePersonalCompanyAsync()` æ–¹æ³•

## ğŸ”§ ä»£ç å®¡æŸ¥æ¸…å•

åœ¨åˆ›å»ºæˆ–ä¿®æ”¹å¤šç§Ÿæˆ·æ•°æ®æ—¶ï¼Œæ£€æŸ¥ï¼š

- [ ] æ‰€æœ‰ Menu å®ä½“éƒ½è®¾ç½®äº† CompanyId
- [ ] æ‰€æœ‰ Role å®ä½“éƒ½è®¾ç½®äº† CompanyId
- [ ] æ‰€æœ‰ Permission å®ä½“éƒ½è®¾ç½®äº† CompanyId
- [ ] æ‰€æœ‰ Notice å®ä½“éƒ½è®¾ç½®äº† CompanyId
- [ ] ä¸åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶åˆ›å»ºå…¨å±€æ•°æ®
- [ ] ä¸è°ƒç”¨å·²åºŸå¼ƒçš„åˆå§‹åŒ–è„šæœ¬
- [ ] æ•°æ®åˆ›å»ºä½¿ç”¨äº‹åŠ¡ä¿æŠ¤

## ğŸ¯ æ ¸å¿ƒåŸåˆ™é‡ç”³

1. **æ— å…¨å±€æ•°æ®** - æ‰€æœ‰ä¸šåŠ¡æ•°æ®éƒ½æœ‰ CompanyId
2. **ä¼ä¸šéš”ç¦»** - æ¯ä¸ªä¼ä¸šçš„æ•°æ®å®Œå…¨ç‹¬ç«‹
3. **ç”¨æˆ·æ³¨å†Œåˆ›å»º** - æ•°æ®åœ¨ç”¨æˆ·æ³¨å†Œæ—¶è‡ªåŠ¨åˆ›å»º
4. **äº‹åŠ¡ä¿æŠ¤** - ç¡®ä¿æ•°æ®åˆ›å»ºçš„åŸå­æ€§
5. **ä¸¥æ ¼éªŒè¯** - åˆ›å»ºå‰å¿…é¡»éªŒè¯ CompanyId

éµå¾ªè¿™äº›è§„èŒƒï¼Œç¡®ä¿å¤šç§Ÿæˆ·ç³»ç»Ÿçš„æ•°æ®å®‰å…¨å’Œéš”ç¦»ï¼
