---
alwaysApply: true
description: OpenAPI + Scalar API æ–‡æ¡£è§„èŒƒ - ç§»é™¤å…¨éƒ¨ Swaggerï¼Œä½¿ç”¨ .NET 9 åŸç”Ÿ OpenAPI å’Œ Scalar
---

# OpenAPI + Scalar API æ–‡æ¡£è§„èŒƒ

## ğŸš« ç¦æ­¢ä½¿ç”¨ Swagger

**é¡¹ç›®å·²å®Œå…¨ç§»é™¤ Swagger/Swashbuckleï¼Œç»Ÿä¸€ä½¿ç”¨ .NET 9 åŸç”Ÿ OpenAPI + Scalar**

## âŒ ç¦æ­¢çš„åšæ³•

### 1. ä¸è¦æ·»åŠ  Swagger/Swashbuckle åŒ…

```xml
<!-- âŒ ç¦æ­¢ï¼šåœ¨ .csproj ä¸­æ·»åŠ  Swagger åŒ… -->
<ItemGroup>
  <PackageReference Include="Swashbuckle.AspNetCore" Version="6.5.0" />
  <PackageReference Include="Swashbuckle.AspNetCore.Annotations" Version="6.5.0" />
</ItemGroup>
```

### 2. ä¸è¦åœ¨ Program.cs ä¸­é…ç½® Swagger

```csharp
// âŒ ç¦æ­¢ï¼šä½¿ç”¨ Swagger é…ç½®
app.UseSwagger();
app.UseSwaggerUI(options =>
{
    options.SwaggerEndpoint("/swagger/v1/swagger.json", "My API V1");
    options.RoutePrefix = string.Empty;
});
```

### 3. ä¸è¦ä½¿ç”¨ Swagger ä¸­é—´ä»¶

```csharp
// âŒ ç¦æ­¢ï¼šä½¿ç”¨ SwaggerGen ä¸­é—´ä»¶
app.UseSwaggerGen();
```

### 4. ä¸è¦åœ¨æ–‡æ¡£ä¸­å¼•ç”¨ Swagger

```markdown
<!-- âŒ ç¦æ­¢ï¼šåœ¨æ–‡æ¡£ä¸­æ¨è Swagger -->
è¯·ä½¿ç”¨ Swagger Editor æŸ¥çœ‹ API æ–‡æ¡£ï¼šhttps://editor.swagger.io/
```

## âœ… æ­£ç¡®çš„åšæ³•

### 1. åœ¨é¡¹ç›®æ–‡ä»¶ä¸­å¯ç”¨ XML æ–‡æ¡£

```xml
<!-- âœ… æ­£ç¡®ï¼šåœ¨ .csproj ä¸­å¯ç”¨ XML æ–‡æ¡£ -->
<PropertyGroup>
  <TargetFramework>net9.0</TargetFramework>
  <ImplicitUsings>enable</ImplicitUsings>
  <Nullable>enable</Nullable>
  <GenerateDocumentationFile>true</GenerateDocumentationFile>
  <NoWarn>$(NoWarn);1591</NoWarn>
</PropertyGroup>
```

### 2. åœ¨ Program.cs ä¸­é…ç½® .NET 9 åŸç”Ÿ OpenAPI

```csharp
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ .NET 9 åŸç”Ÿ OpenAPI
builder.Services.AddOpenApi(options =>
{
    // æ–‡æ¡£è½¬æ¢å™¨ - é…ç½® API ä¿¡æ¯å’Œå®‰å…¨æ–¹æ¡ˆ
    options.AddDocumentTransformer((document, context, cancellationToken) =>
    {
        document.Info = new()
        {
            Title = "Platform API",
            Version = "v1",
            Description = "Aspire Admin Platform API - ä¼ä¸šçº§ç®¡ç†å¹³å°åç«¯æœåŠ¡",
            Contact = new()
            {
                Name = "Platform Team",
                Email = "support@platform.com"
            }
        };

        // æ·»åŠ  JWT è®¤è¯é…ç½®
        document.Components ??= new();
        document.Components.SecuritySchemes ??= new Dictionary<string, Microsoft.OpenApi.Models.OpenApiSecurityScheme>();
        document.Components.SecuritySchemes["Bearer"] = new()
        {
            Type = Microsoft.OpenApi.Models.SecuritySchemeType.Http,
            Scheme = "bearer",
            BearerFormat = "JWT",
            Description = "JWT Authorization header using the Bearer scheme."
        };

        // æ·»åŠ å…¨å±€å®‰å…¨è¦æ±‚
        document.SecurityRequirements ??= new List<Microsoft.OpenApi.Models.OpenApiSecurityRequirement>();
        document.SecurityRequirements.Add(new Microsoft.OpenApi.Models.OpenApiSecurityRequirement
        {
            [document.Components.SecuritySchemes["Bearer"]] = new string[0]
        });

        return Task.CompletedTask;
    });

    // æ“ä½œè½¬æ¢å™¨ - ä¸ºéœ€è¦è®¤è¯çš„ç«¯ç‚¹æ·»åŠ å®‰å…¨è¦æ±‚
    options.AddOperationTransformer((operation, context, cancellationToken) =>
    {
        var authorizeAttributes = context.Description.ActionDescriptor.EndpointMetadata
            .OfType<Microsoft.AspNetCore.Authorization.AuthorizeAttribute>();

        if (authorizeAttributes.Any())
        {
            operation.Security ??= new List<Microsoft.OpenApi.Models.OpenApiSecurityRequirement>();
            operation.Security.Add(new()
            {
                [new Microsoft.OpenApi.Models.OpenApiSecurityScheme
                {
                    Reference = new()
                    {
                        Type = Microsoft.OpenApi.Models.ReferenceType.SecurityScheme,
                        Id = "Bearer"
                    }
                }] = Array.Empty<string>()
            });
        }

        return Task.CompletedTask;
    });
});

// åœ¨ç®¡é“ä¸­æ˜ å°„ OpenAPI ç«¯ç‚¹
app.MapControllers();
app.MapOpenApi();  // âœ… ä½¿ç”¨ .NET 9 åŸç”Ÿ OpenAPI
app.MapDefaultEndpoints();
```

### 3. ä¸ºæ‰€æœ‰æ§åˆ¶å™¨å’Œæ–¹æ³•æ·»åŠ  XML æ³¨é‡Š

```csharp
/// <summary>
/// è·å–ç”¨æˆ·ä¿¡æ¯
/// </summary>
/// <param name="id">ç”¨æˆ·ID</param>
/// <returns>ç”¨æˆ·è¯¦ç»†ä¿¡æ¯</returns>
/// <remarks>
/// ç¤ºä¾‹è¯·æ±‚ï¼š
/// GET /api/user/123
///
/// ç¤ºä¾‹å“åº”ï¼š
/// ```json
/// {
///   "id": "123",
///   "username": "admin",
///   "email": "admin@example.com"
/// }
/// ```
/// </remarks>
[HttpGet("{id}")]
public async Task<IActionResult> GetUser(string id)
{
    var user = await _userService.GetUserByIdAsync(id);
    if (user == null)
        throw new KeyNotFoundException($"ç”¨æˆ· {id} ä¸å­˜åœ¨");

    return Success(user);
}
```

### 4. ä¸º DTO ç±»æ·»åŠ  XML æ³¨é‡Š

```csharp
/// <summary>
/// ç”¨æˆ·æ³¨å†Œè¯·æ±‚å‚æ•°
/// </summary>
public class RegisterRequest
{
    /// <summary>
    /// ç”¨æˆ·åï¼ˆ3-50ä¸ªå­—ç¬¦ï¼Œæ”¯æŒå­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼‰
    /// </summary>
    /// <example>admin</example>
    [Required]
    [StringLength(50, MinimumLength = 3)]
    public string Username { get; set; } = string.Empty;

    /// <summary>
    /// é‚®ç®±åœ°å€ï¼ˆå¿…é¡»æ˜¯æœ‰æ•ˆçš„é‚®ç®±æ ¼å¼ï¼‰
    /// </summary>
    /// <example>admin@example.com</example>
    [Required]
    [EmailAddress]
    public string Email { get; set; } = string.Empty;

    /// <summary>
    /// å¯†ç ï¼ˆè‡³å°‘8ä½ï¼Œå¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—ï¼‰
    /// </summary>
    /// <example>password123</example>
    [Required]
    [MinLength(8)]
    [RegularExpression(@"^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@$!%*#?&]{8,}$",
        ErrorMessage = "å¯†ç è‡³å°‘8ä½ï¼Œå¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—")]
    public string Password { get; set; } = string.Empty;
}
```

## ğŸ”§ è®¿é—®å’Œä½¿ç”¨ Scalar API æ–‡æ¡£

### 1. å¯åŠ¨é¡¹ç›®

```bash
dotnet run --project Platform.AppHost
```

### 2. æ‰“å¼€ Aspire Dashboard

è®¿é—®: **http://localhost:15003**

### 3. æŸ¥çœ‹ Scalar API æ–‡æ¡£

1. åœ¨ Aspire Dashboard ç‚¹å‡»é¡¶éƒ¨ **"Resources"** æ ‡ç­¾
2. åœ¨èµ„æºåˆ—è¡¨ä¸­æ‰¾åˆ° **"Scalar API Reference"** èµ„æº
3. ç‚¹å‡»è¯¥èµ„æºå³ä¾§çš„ **ç«¯ç‚¹é“¾æ¥å›¾æ ‡** ğŸ”—
4. Scalar API æ–‡æ¡£ä¼šåœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€

### 4. ä½¿ç”¨ JWT è®¤è¯æµ‹è¯• API

#### è·å– Token
```bash
curl -X POST http://localhost:15000/apiservice/login/account \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123"
  }'
```

#### åœ¨ Scalar ä¸­é…ç½®è®¤è¯
1. åœ¨ Scalar æ–‡æ¡£é¡µé¢ï¼Œç‚¹å‡»å³ä¸Šè§’çš„ **"Authorize"** æŒ‰é’®
2. è¾“å…¥ `Bearer <ä½ çš„token>`
3. ç‚¹å‡» **"Authorize"** ç¡®è®¤
4. ç°åœ¨æ‰€æœ‰éœ€è¦è®¤è¯çš„ API è°ƒç”¨éƒ½ä¼šè‡ªåŠ¨å¸¦ä¸Šè¿™ä¸ª token

## ğŸ“Š Scalar åŠŸèƒ½ç‰¹æ€§

- âœ… æµè§ˆæ‰€æœ‰ API ç«¯ç‚¹ï¼ˆæŒ‰ Controller åˆ†ç»„ï¼‰
- âœ… æŸ¥çœ‹è¯·æ±‚/å“åº”çš„ Schema å®šä¹‰
- âœ… æŸ¥çœ‹å‚æ•°è¯´æ˜å’Œç¤ºä¾‹
- âœ… ç›´æ¥æµ‹è¯• API è°ƒç”¨ï¼ˆæ”¯æŒå‚æ•°å¡«å†™ï¼‰
- âœ… é…ç½® JWT è®¤è¯
- âœ… æ˜¾ç¤ºè®¤è¯çŠ¶æ€å’Œç”¨æˆ·ä¿¡æ¯
- âœ… æ”¯æŒå¤šç§è¯·æ±‚æ ¼å¼ï¼ˆJSONã€XMLã€Formï¼‰
- âœ… æ˜¾ç¤ºå“åº”æ—¶é—´å’ŒçŠ¶æ€ç 

## ğŸ” éªŒè¯æ–¹æ³•

### 1. æ£€æŸ¥ OpenAPI JSON ç«¯ç‚¹

è®¿é—®: **http://localhost:15000/apiservice/openapi/v1.json**

ç¡®è®¤ï¼š
- [ ] JSON æ ¼å¼æ­£ç¡®
- [ ] æ‰€æœ‰ API ç«¯ç‚¹éƒ½å­˜åœ¨
- [ ] è¯·æ±‚/å“åº” schema å®Œæ•´
- [ ] JWT Bearer å®‰å…¨æ–¹æ¡ˆå·²é…ç½®
- [ ] XML æ³¨é‡Šæ­£ç¡®æ˜¾ç¤º

### 2. åœ¨ Scalar ä¸­éªŒè¯

åœ¨ Scalar æ–‡æ¡£ç•Œé¢ï¼š
- [ ] å·¦ä¾§å¯¼èˆªæ æ˜¾ç¤ºæ‰€æœ‰ API ç«¯ç‚¹
- [ ] ç‚¹å‡»ä»»æ„ç«¯ç‚¹æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
- [ ] è¯·æ±‚æ¨¡å‹å¯ä»¥å±•å¼€æŸ¥çœ‹
- [ ] å“åº”æ¨¡å‹æœ‰ç¤ºä¾‹æ•°æ®
- [ ] è®¤è¯å›¾æ ‡æ­£ç¡®æ˜¾ç¤ºï¼ˆğŸ”’ è¡¨ç¤ºéœ€è¦è®¤è¯ï¼‰

### 3. æµ‹è¯•è®¤è¯åŠŸèƒ½

1. æœªè®¤è¯çŠ¶æ€ï¼š
   - éœ€è¦è®¤è¯çš„ç«¯ç‚¹æ˜¾ç¤º ğŸ”’ å›¾æ ‡
   - ç‚¹å‡» "Try it out" æ—¶æç¤ºéœ€è¦è®¤è¯

2. è®¤è¯åï¼š
   - è®¤è¯æŒ‰é’®æ˜¾ç¤ºç»¿è‰²é”å›¾æ ‡
   - å¯ä»¥æ­£å¸¸è°ƒç”¨éœ€è¦è®¤è¯çš„ API
   - è¯·æ±‚å¤´ä¸­è‡ªåŠ¨åŒ…å« Authorization: Bearer token

## ğŸš« å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ

### âŒ é”™è¯¯ 1: INVALID_REFERENCE é”™è¯¯

**ç°è±¡**ï¼š
```
INVALID_REFERENCE: Can't resolve reference: #/components/schemas/LoginRequest
```

**åŸå› **ï¼š
- XML æ–‡æ¡£ç”Ÿæˆæœªå¯ç”¨
- ç¼ºå°‘ DocumentTransformer æˆ– OperationTransformer

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®ä¿é¡¹ç›®æ–‡ä»¶ä¸­å¯ç”¨ XML æ–‡æ¡£ï¼š
   ```xml
   <GenerateDocumentationFile>true</GenerateDocumentationFile>
   ```
2. ç¡®ä¿é…ç½®äº† DocumentTransformer å’Œ OperationTransformer
3. é‡å¯åº”ç”¨é‡æ–°ç”Ÿæˆæ–‡æ¡£

### âŒ é”™è¯¯ 2: æ— æ³•æŸ¥çœ‹è¯·æ±‚æ¨¡å‹

**ç°è±¡**ï¼š
- Scalar ä¸­è¯·æ±‚æ¨¡å‹æ˜¾ç¤ºä¸ºç©ºæˆ–é”™è¯¯

**åŸå› **ï¼š
- DTO ç±»ç¼ºå°‘ XML æ³¨é‡Š
- å‘½åç©ºé—´ä¸åŒ¹é…

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä¸ºæ‰€æœ‰ DTO ç±»æ·»åŠ å®Œæ•´çš„ XML æ³¨é‡Š
2. ç¡®ä¿ç±»åå’Œå‘½åç©ºé—´æ­£ç¡®
3. é‡å¯åº”ç”¨é‡æ–°ç”Ÿæˆæ–‡æ¡£

### âŒ é”™è¯¯ 3: JWT è®¤è¯ä¸å·¥ä½œ

**ç°è±¡**ï¼š
- Scalar ä¸­è®¤è¯æŒ‰é’®æ˜¾ç¤ºä½†æ— æ³•æ­£å¸¸å·¥ä½œ

**åŸå› **ï¼š
- JWT å®‰å…¨æ–¹æ¡ˆé…ç½®é”™è¯¯
- Token æ ¼å¼ä¸æ­£ç¡®

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ DocumentTransformer ä¸­çš„ JWT é…ç½®
2. ç¡®ä¿ Token æ ¼å¼ä¸ºï¼š`Bearer <token>`ï¼ˆæ³¨æ„ç©ºæ ¼ï¼‰
3. æ£€æŸ¥åç«¯ JWT éªŒè¯é€»è¾‘

## ğŸ“‹ ä»£ç å®¡æŸ¥æ¸…å•

æ·»åŠ æˆ–ä¿®æ”¹ API ç«¯ç‚¹æ—¶ï¼Œæ£€æŸ¥ï¼š

### åç«¯æ£€æŸ¥
- [ ] åœ¨é¡¹ç›®æ–‡ä»¶ä¸­å¯ç”¨äº† `<GenerateDocumentationFile>true</GenerateDocumentationFile>`
- [ ] ä¸ºæ–°çš„ Controller æ–¹æ³•æ·»åŠ äº†å®Œæ•´çš„ XML æ³¨é‡Š
- [ ] ä¸ºæ–°çš„ DTO ç±»æ·»åŠ äº† XML æ³¨é‡Š
- [ ] å¦‚æœéœ€è¦è®¤è¯ï¼Œå·²æ·»åŠ  `[Authorize]` ç‰¹æ€§
- [ ] Program.cs ä¸­æœ‰æ­£ç¡®çš„ OpenAPI é…ç½®
- [ ] é‡å¯åº”ç”¨åæ–‡æ¡£èƒ½æ­£ç¡®æ˜¾ç¤º

### æ–‡æ¡£æ£€æŸ¥
- [ ] æ›´æ–°äº†ç›¸å…³çš„åŠŸèƒ½æ–‡æ¡£
- [ ] æ›´æ–°äº† API ä½¿ç”¨è¯´æ˜
- [ ] æ›´æ–°äº† Scalar ä½¿ç”¨æŒ‡å—
- [ ] æ›´æ–°äº†æ–‡æ¡£ç´¢å¼•

### æµ‹è¯•æ£€æŸ¥
- [ ] åœ¨ Scalar ä¸­èƒ½æ­£ç¡®æŸ¥çœ‹æ–°ç«¯ç‚¹çš„æ–‡æ¡£
- [ ] å¦‚æœéœ€è¦è®¤è¯ï¼Œèƒ½æ­£ç¡®æµ‹è¯•è®¤è¯åŠŸèƒ½
- [ ] è¯·æ±‚å’Œå“åº”ç¤ºä¾‹æ­£ç¡®æ˜¾ç¤º

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¦‚ä½•æŸ¥çœ‹ API æ–‡æ¡£](mdc:docs/features/HOW-TO-VIEW-API-DOCS.md)
- [Scalar API æ–‡æ¡£ä¿®å¤](mdc:docs/bugfixes/SCALAR-API-REFERENCE-FIX.md)
- [.NET 9 OpenAPI å®˜æ–¹æ–‡æ¡£](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/openapi/overview)
- [Scalar å®˜æ–¹ç½‘ç«™](https://github.com/scalar/scalar)

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

1. **ç¦æ­¢ Swagger** - æ°¸ä¸ä½¿ç”¨ Swagger/Swashbuckle
2. **åŸç”Ÿ OpenAPI** - åªä½¿ç”¨ .NET 9 åŸç”Ÿ OpenAPI
3. **å®Œæ•´æ³¨é‡Š** - æ‰€æœ‰ API å…ƒç´ éƒ½è¦æœ‰ XML æ³¨é‡Š
4. **Scalar ä¼˜å…ˆ** - ä¸»è¦é€šè¿‡ Aspire Dashboard è®¿é—® Scalar
5. **åŠæ—¶æ›´æ–°** - ä»£ç å’Œæ–‡æ¡£åŒæ­¥æ›´æ–°
6. **å®Œæ•´æµ‹è¯•** - ç¡®ä¿ Scalar ä¸­æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ

## âš¡ å¿«é€ŸéªŒè¯å‘½ä»¤

```bash
# 1. æ£€æŸ¥ OpenAPI JSON æ ¼å¼
curl http://localhost:15000/apiservice/openapi/v1.json | jq '.info'

# 2. æ£€æŸ¥ç«¯ç‚¹æ•°é‡
curl http://localhost:15000/apiservice/openapi/v1.json | jq '.paths | length'

# 3. æ£€æŸ¥ JWT å®‰å…¨æ–¹æ¡ˆ
curl http://localhost:15000/apiservice/openapi/v1.json | jq '.components.securitySchemes'

# 4. æµ‹è¯•è®¤è¯
curl -H "Authorization: Bearer <your-token>" http://localhost:15000/apiservice/api/currentUser
```

## ğŸ¯ è®°ä½

**ç§»é™¤ Swaggerï¼Œæ‹¥æŠ± OpenAPI + Scalar** - è¿™æ˜¯ä¸€ä¸ªç°ä»£åŒ–çš„ã€ä¸ .NET Aspire å®Œç¾é›†æˆçš„ API æ–‡æ¡£è§£å†³æ–¹æ¡ˆã€‚
