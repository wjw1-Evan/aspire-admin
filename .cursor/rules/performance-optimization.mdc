---
globs: Platform.ApiService/Services/*.cs,Platform.ServiceDefaults/Services/*.cs
description: æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§è§„èŒƒ
---
# æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

### é€šè¿‡æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§ç¡®ä¿ç³»ç»Ÿé«˜æ•ˆè¿è¡Œï¼Œæä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ

## âœ… æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

### å­—æ®µæŠ•å½±ä¼˜åŒ–

**é‡è¦åŸåˆ™**ï¼šåœ¨åˆ—è¡¨æŸ¥è¯¢ã€æ‰¹é‡æŸ¥è¯¢ã€å…³è”æŸ¥è¯¢ç­‰åœºæ™¯ä¸­ï¼Œå¿…é¡»ä½¿ç”¨å­—æ®µæŠ•å½±åªè¿”å›éœ€è¦çš„å­—æ®µï¼Œå‡å°‘ç½‘ç»œä¼ è¾“é‡å’Œå†…å­˜ä½¿ç”¨ã€‚

```csharp
// âœ… æ­£ç¡® - ä½¿ç”¨å­—æ®µæŠ•å½±ä¼˜åŒ–æŸ¥è¯¢
public class UserService : IUserService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;

    public async Task<UserListWithRolesResponse> GetUsersWithRolesAsync(UserListRequest request)
    {
        var filter = _userFactory.CreateFilterBuilder()
            .Equal(u => u.CurrentCompanyId, currentCompanyId)
            .Build();

        // âœ… ä½¿ç”¨å­—æ®µæŠ•å½±ï¼Œåªè¿”å›åˆ—è¡¨éœ€è¦çš„å­—æ®µ
        var projection = _userFactory.CreateProjectionBuilder()
            .Include(u => u.Id)
            .Include(u => u.Username)
            .Include(u => u.Name)
            .Include(u => u.Email)
            .Include(u => u.PhoneNumber)
            .Include(u => u.Age)
            .Include(u => u.IsActive)
            .Include(u => u.LastLoginAt)
            .Include(u => u.CreatedAt)
            .Include(u => u.UpdatedAt)
            .Include(u => u.CurrentCompanyId)  // ç”¨äºåç»­è¿‡æ»¤
            .Build();

        // åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·ï¼ˆä½¿ç”¨æŠ•å½±ï¼‰
        var (users, total) = await _userFactory.FindPagedAsync(
            filter, sortBuilder.Build(), request.Page, request.PageSize, projection);

        // æ‰¹é‡åŠ è½½ç”¨æˆ·è§’è‰²ä¿¡æ¯
        var usersWithRoles = await EnrichUsersWithRolesAsync(users, currentCompanyId);
        return new UserListWithRolesResponse { Users = usersWithRoles, Total = (int)total };
    }

    // âœ… æ‰¹é‡æŸ¥è¯¢æ—¶ä½¿ç”¨æŠ•å½±
    private async Task<Dictionary<string, string>> GetRoleNameMapAsync(List<string> roleIds, string companyId)
    {
        if (!roleIds.Any()) return new Dictionary<string, string>();

        var roleFilter = _roleFactory.CreateFilterBuilder()
            .In(r => r.Id, roleIds)
            .Equal(r => r.CompanyId, companyId)
            .Build();
        
        // âœ… åªè¿”å› Id å’Œ Name
        var roleProjection = _roleFactory.CreateProjectionBuilder()
            .Include(r => r.Id)
            .Include(r => r.Name)
            .Build();
        
        var roles = await _roleFactory.FindAsync(roleFilter, projection: roleProjection);
        return roles.ToDictionary(r => r.Id!, r => r.Name);
    }
}

// âŒ é”™è¯¯ - ä¸ä½¿ç”¨æŠ•å½±ï¼Œè¿”å›æ‰€æœ‰å­—æ®µ
public class UserService : IUserService
{
    public async Task<UserListWithRolesResponse> GetUsersWithRolesAsync(UserListRequest request)
    {
        // âŒ è¿”å›æ‰€æœ‰å­—æ®µï¼ŒåŒ…æ‹¬ä¸éœ€è¦çš„ PasswordHashã€Avatar ç­‰å¤§å­—æ®µ
        var (users, total) = await _userFactory.FindPagedAsync(
            filter, sortBuilder.Build(), request.Page, request.PageSize);
        // æµªè´¹ç½‘ç»œå¸¦å®½å’Œå†…å­˜
    }
}
```

**æŠ•å½±ä½¿ç”¨åœºæ™¯**ï¼š

1. **åˆ—è¡¨æŸ¥è¯¢** - åªè¿”å›åˆ—è¡¨æ˜¾ç¤ºéœ€è¦çš„å­—æ®µ
2. **æ‰¹é‡æŸ¥è¯¢** - å‡å°‘å¤§é‡æ•°æ®ä¼ è¾“
3. **å…³è”æŸ¥è¯¢** - åªè¿”å›å…³è”å¯¹è±¡çš„å…³é”®å­—æ®µ
4. **ç»Ÿè®¡æŸ¥è¯¢** - åªè¿”å›ç»Ÿè®¡éœ€è¦çš„å­—æ®µ

**ä¸ä½¿ç”¨æŠ•å½±çš„åœºæ™¯**ï¼š

1. **è¯¦æƒ…æŸ¥è¯¢** - éœ€è¦è¿”å›å®Œæ•´å¯¹è±¡
2. **æ›´æ–°æŸ¥è¯¢** - éœ€è¦å®Œæ•´å¯¹è±¡è¿›è¡Œæ›´æ–°
3. **åˆ›å»ºæŸ¥è¯¢** - éœ€è¦è¿”å›å®Œæ•´å¯¹è±¡
4. **å¤æ‚ä¸šåŠ¡é€»è¾‘** - å¯èƒ½éœ€è¦è®¿é—®æ‰€æœ‰å­—æ®µ

**æŠ•å½±å­—æ®µé€‰æ‹©åŸåˆ™**ï¼š

1. **åªåŒ…å«éœ€è¦çš„å­—æ®µ** - ä¸è¦åŒ…å«"å¯èƒ½ç”¨åˆ°"çš„å­—æ®µ
2. **åŒ…å«å…³è”å­—æ®µ** - å¦‚æœåç»­éœ€è¦å…³è”æŸ¥è¯¢ï¼ŒåŒ…å«å¿…è¦çš„å…³è”å­—æ®µï¼ˆå¦‚ CompanyIdï¼‰
3. **åŒ…å«æ’åºå­—æ®µ** - å¦‚æœæŸ¥è¯¢éœ€è¦æ’åºï¼Œç¡®ä¿æ’åºå­—æ®µåœ¨æŠ•å½±ä¸­
4. **åŒ…å«è¿‡æ»¤å­—æ®µ** - å¦‚æœæŸ¥è¯¢éœ€è¦è¿‡æ»¤ï¼Œç¡®ä¿è¿‡æ»¤å­—æ®µåœ¨æŠ•å½±ä¸­

```csharp
// âœ… æ­£ç¡® - æŠ•å½±å­—æ®µé€‰æ‹©
var projection = _userFactory.CreateProjectionBuilder()
    .Include(u => u.Id)              // å¿…éœ€ï¼šç”¨äºæ ‡è¯†
    .Include(u => u.Username)         // éœ€è¦ï¼šåˆ—è¡¨æ˜¾ç¤º
    .Include(u => u.Email)            // éœ€è¦ï¼šåˆ—è¡¨æ˜¾ç¤º
    .Include(u => u.IsActive)         // éœ€è¦ï¼šåˆ—è¡¨æ˜¾ç¤ºå’Œè¿‡æ»¤
    .Include(u => u.CreatedAt)        // éœ€è¦ï¼šåˆ—è¡¨æ˜¾ç¤ºå’Œæ’åº
    .Include(u => u.CurrentCompanyId) // éœ€è¦ï¼šåç»­è¿‡æ»¤
    .Build();

// âŒ é”™è¯¯ - åŒ…å«ä¸éœ€è¦çš„å­—æ®µ
var projection = _userFactory.CreateProjectionBuilder()
    .Include(u => u.Id)
    .Include(u => u.Username)
    .Include(u => u.PasswordHash)     // âŒ ä¸éœ€è¦ï¼šå®‰å…¨é£é™©
    .Include(u => u.Avatar)           // âŒ ä¸éœ€è¦ï¼šå¤§å­—æ®µ
    .Build();
```

### æŸ¥è¯¢ä¼˜åŒ–

```csharp
// âœ… æ­£ç¡® - ä¼˜åŒ–çš„æ•°æ®åº“æŸ¥è¯¢
public class UserService : IUserService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;

    public UserService(IDatabaseOperationFactory<User> userFactory)
    {
        _userFactory = userFactory;
    }

    public async Task<List<User>> GetUsersAsync(UserListRequest request)
    {
        // 1. æ„å»ºé«˜æ•ˆçš„æŸ¥è¯¢æ¡ä»¶
        var filter = _userFactory.CreateFilterBuilder()
            .ExcludeDeleted()
            .WithTenant()
            .Build();

        // 2. æ·»åŠ ç´¢å¼•å‹å¥½çš„æœç´¢æ¡ä»¶
        if (!string.IsNullOrEmpty(request.Keyword))
        {
            var searchFilter = _userFactory.CreateFilterBuilder()
                .Regex(u => u.Username, request.Keyword)
                .Or()
                .Regex(u => u.Email, request.Keyword)
                .Build();
            
            filter = _userFactory.CreateFilterBuilder()
                .And(filter)
                .And(searchFilter)
                .Build();
        }

        // 3. ä½¿ç”¨ç´¢å¼•å‹å¥½çš„æ’åº
        var sort = _userFactory.CreateSortBuilder()
            .Descending(u => u.CreatedAt)
            .Build();

        // 4. é™åˆ¶ç»“æœæ•°é‡
        var limit = Math.Min(request.Limit ?? DEFAULT_PAGE_SIZE, MAX_PAGE_SIZE);

        // 5. æ‰§è¡ŒæŸ¥è¯¢
        return await _userFactory.FindAsync(filter, sort, limit);
    }

    public async Task<(List<User> items, long total)> GetUsersPagedAsync(UserListRequest request)
    {
        // 1. æ„å»ºæŸ¥è¯¢æ¡ä»¶
        var filter = _userFactory.CreateFilterBuilder()
            .ExcludeDeleted()
            .WithTenant()
            .Build();

        // 2. æ·»åŠ æœç´¢æ¡ä»¶
        if (!string.IsNullOrEmpty(request.Keyword))
        {
            var searchFilter = _userFactory.CreateFilterBuilder()
                .Regex(u => u.Username, request.Keyword)
                .Or()
                .Regex(u => u.Email, request.Keyword)
                .Build();
            
            filter = _userFactory.CreateFilterBuilder()
                .And(filter)
                .And(searchFilter)
                .Build();
        }

        // 3. æ„å»ºæ’åº
        var sort = _userFactory.CreateSortBuilder()
            .Descending(u => u.CreatedAt)
            .Build();

        // 4. æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢
        var page = Math.Max(1, request.Page ?? 1);
        var pageSize = Math.Min(request.PageSize ?? DEFAULT_PAGE_SIZE, MAX_PAGE_SIZE);

        return await _userFactory.FindPagedAsync(filter, sort, page, pageSize);
    }

    public async Task<UserStatistics> GetUserStatisticsAsync()
    {
        var companyId = _userFactory.GetRequiredCompanyId();
        
        // ä½¿ç”¨èšåˆæŸ¥è¯¢è€Œä¸æ˜¯åŠ è½½æ‰€æœ‰æ•°æ®
        var totalUsers = await _userFactory.CountAsync();
        var activeUsers = await _userFactory.CountAsync(
            _userFactory.CreateFilterBuilder()
                .Equal(u => u.IsActive, true)
                .Build()
        );
        var inactiveUsers = totalUsers - activeUsers;

        return new UserStatistics
        {
            TotalUsers = totalUsers,
            ActiveUsers = activeUsers,
            InactiveUsers = inactiveUsers,
            CompanyId = companyId,
            GeneratedAt = DateTime.UtcNow
        };
    }
}

// âŒ é”™è¯¯ - ä½æ•ˆçš„æ•°æ®åº“æŸ¥è¯¢
public class UserService : IUserService
{
    public async Task<List<User>> GetUsersAsync(UserListRequest request)
    {
        // è·å–æ‰€æœ‰ç”¨æˆ·ç„¶åè¿‡æ»¤ï¼ˆä½æ•ˆï¼‰
        var allUsers = await _userFactory.FindAsync();
        
        return allUsers
            .Where(u => string.IsNullOrEmpty(request.Keyword) || 
                       u.Username.Contains(request.Keyword) ||
                       u.Email.Contains(request.Keyword))
            .Take(request.Limit ?? DEFAULT_PAGE_SIZE)
            .ToList();
    }
}
```

### ç´¢å¼•ä¼˜åŒ–

```csharp
// âœ… æ­£ç¡® - ç´¢å¼•ä¼˜åŒ–
public class UserService : IUserService
{
    public async Task<List<User>> GetUsersAsync(UserListRequest request)
    {
        // ä½¿ç”¨å¤åˆç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
        var filter = _userFactory.CreateFilterBuilder()
            .ExcludeDeleted()
            .WithTenant()
            .Build();

        // æ·»åŠ çŠ¶æ€è¿‡æ»¤ï¼ˆä½¿ç”¨ç´¢å¼•ï¼‰
        if (request.IsActive.HasValue)
        {
            var statusFilter = _userFactory.CreateFilterBuilder()
                .Equal(u => u.IsActive, request.IsActive.Value)
                .Build();
            
            filter = _userFactory.CreateFilterBuilder()
                .And(filter)
                .And(statusFilter)
                .Build();
        }

        // æ·»åŠ æ—¶é—´èŒƒå›´è¿‡æ»¤ï¼ˆä½¿ç”¨ç´¢å¼•ï¼‰
        if (request.CreatedAfter.HasValue)
        {
            var timeFilter = _userFactory.CreateFilterBuilder()
                .GreaterThanOrEqual(u => u.CreatedAt, request.CreatedAfter.Value)
                .Build();
            
            filter = _userFactory.CreateFilterBuilder()
                .And(filter)
                .And(timeFilter)
                .Build();
        }

        // ä½¿ç”¨ç´¢å¼•å‹å¥½çš„æ’åº
        var sort = _userFactory.CreateSortBuilder()
            .Descending(u => u.CreatedAt)
            .Build();

        return await _userFactory.FindAsync(filter, sort, request.Limit);
    }
}

// âŒ é”™è¯¯ - æ²¡æœ‰ä½¿ç”¨ç´¢å¼•
public class UserService : IUserService
{
    public async Task<List<User>> GetUsersAsync(UserListRequest request)
    {
        // æ²¡æœ‰ä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢
        var filter = _userFactory.CreateFilterBuilder()
            .ExcludeDeleted()
            .WithTenant()
            .Build();

        // æ²¡æœ‰ä½¿ç”¨ç´¢å¼•çš„æ’åº
        var sort = _userFactory.CreateSortBuilder()
            .Ascending(u => u.Username) // æ²¡æœ‰ç´¢å¼•çš„å­—æ®µ
            .Build();

        return await _userFactory.FindAsync(filter, sort, request.Limit);
    }
}
```

### æ‰¹é‡æ“ä½œä¼˜åŒ–

```csharp
// âœ… æ­£ç¡® - æ‰¹é‡æ“ä½œä¼˜åŒ–
public class UserService : IUserService
{
    public async Task<List<User>> CreateManyUsersAsync(List<CreateUserRequest> requests)
    {
        // 1. æ‰¹é‡éªŒè¯
        await ValidateManyUsersAsync(requests);

        // 2. æ‰¹é‡åˆ›å»º
        var users = requests.Select(request => new User
        {
            Username = request.Username,
            Email = request.Email,
            CompanyId = _userFactory.GetRequiredCompanyId(),
            CreatedBy = _userFactory.GetCurrentUserId(),
            CreatedAt = DateTime.UtcNow
        }).ToList();

        return await _userFactory.CreateManyAsync(users);
    }

    public async Task<long> UpdateManyUsersAsync(List<UpdateUserRequest> requests)
    {
        // 1. æ‰¹é‡éªŒè¯
        await ValidateManyUpdatesAsync(requests);

        // 2. æ‰¹é‡æ›´æ–°
        var userIds = requests.Select(r => r.Id).ToList();
        var filter = _userFactory.CreateFilterBuilder()
            .In(u => u.Id, userIds)
            .Build();

        // æ³¨æ„ï¼šå¦‚æœæ‰¹é‡æ›´æ–°éœ€è¦è®¾ç½®ä¸šåŠ¡å­—æ®µï¼Œåº”è¯¥åœ¨è¿™é‡Œæ·»åŠ 
        // ä¾‹å¦‚ï¼š.Set(u => u.Status, "updated")
        // å®¡è®¡å­—æ®µä¼šè‡ªåŠ¨å¡«å……ï¼Œä¸éœ€è¦æ‰‹åŠ¨è®¾ç½®
        var update = _userFactory.CreateUpdateBuilder()
            .Build();

        return await _userFactory.UpdateManyAsync(filter, update);
    }

    public async Task<long> DeleteManyUsersAsync(List<string> userIds)
    {
        // 1. æ‰¹é‡éªŒè¯
        await ValidateManyDeletionsAsync(userIds);

        // 2. æ‰¹é‡åˆ é™¤
        return await _userFactory.SoftDeleteManyAsync(userIds);
    }

    private async Task ValidateManyUsersAsync(List<CreateUserRequest> requests)
    {
        foreach (var request in requests)
        {
            if (string.IsNullOrEmpty(request.Username))
                throw new ArgumentException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");
        }
    }

    private async Task ValidateManyUpdatesAsync(List<UpdateUserRequest> requests)
    {
        foreach (var request in requests)
        {
            if (string.IsNullOrEmpty(request.Id))
                throw new ArgumentException("ç”¨æˆ·IDä¸èƒ½ä¸ºç©º");
        }
    }

    private async Task ValidateManyDeletionsAsync(List<string> userIds)
    {
        foreach (var userId in userIds)
        {
            if (string.IsNullOrEmpty(userId))
                throw new ArgumentException("ç”¨æˆ·IDä¸èƒ½ä¸ºç©º");
        }
    }
}

// âŒ é”™è¯¯ - é€ä¸ªæ“ä½œ
public class UserService : IUserService
{
    public async Task<List<User>> CreateManyUsersAsync(List<CreateUserRequest> requests)
    {
        var users = new List<User>();
        
        // é€ä¸ªåˆ›å»ºï¼ˆä½æ•ˆï¼‰
        foreach (var request in requests)
        {
            var user = await CreateUserAsync(request);
            users.Add(user);
        }
        
        return users;
    }
}
```

## ğŸ¯ å†…å­˜ä½¿ç”¨ä¼˜åŒ–

### æµå¼å¤„ç†

```csharp
// âœ… æ­£ç¡® - æµå¼å¤„ç†
public class UserService : IUserService
{
    public async Task<List<User>> GetUsersAsync(UserListRequest request)
    {
        // 1. ä½¿ç”¨æµå¼å¤„ç†
        var filter = _userFactory.CreateFilterBuilder()
            .ExcludeDeleted()
            .WithTenant()
            .Build();

        var sort = _userFactory.CreateSortBuilder()
            .Descending(u => u.CreatedAt)
            .Build();

        var limit = Math.Min(request.Limit ?? DEFAULT_PAGE_SIZE, MAX_PAGE_SIZE);

        // 2. é™åˆ¶ç»“æœæ•°é‡
        return await _userFactory.FindAsync(filter, sort, limit);
    }

    public async Task<UserStatistics> GetUserStatisticsAsync()
    {
        var companyId = _userFactory.GetRequiredCompanyId();
        
        // 3. ä½¿ç”¨èšåˆæŸ¥è¯¢è€Œä¸æ˜¯åŠ è½½æ‰€æœ‰æ•°æ®
        var totalUsers = await _userFactory.CountAsync();
        var activeUsers = await _userFactory.CountAsync(
            _userFactory.CreateFilterBuilder()
                .Equal(u => u.IsActive, true)
                .Build()
        );
        var inactiveUsers = totalUsers - activeUsers;

        return new UserStatistics
        {
            TotalUsers = totalUsers,
            ActiveUsers = activeUsers,
            InactiveUsers = inactiveUsers,
            CompanyId = companyId,
            GeneratedAt = DateTime.UtcNow
        };
    }
}

// âŒ é”™è¯¯ - å†…å­˜ä½¿ç”¨ä¸å½“
public class UserService : IUserService
{
    public async Task<List<User>> GetUsersAsync(UserListRequest request)
    {
        // åŠ è½½æ‰€æœ‰ç”¨æˆ·åˆ°å†…å­˜ï¼ˆå†…å­˜æµªè´¹ï¼‰
        var allUsers = await _userFactory.FindAsync();
        
        return allUsers
            .Where(u => string.IsNullOrEmpty(request.Keyword) || 
                       u.Username.Contains(request.Keyword))
            .Take(request.Limit ?? DEFAULT_PAGE_SIZE)
            .ToList();
    }
}
```

### ç¼“å­˜ä¼˜åŒ–

```csharp
// âœ… æ­£ç¡® - ç¼“å­˜ä¼˜åŒ–
public class UserService : IUserService
{
    private readonly IMemoryCache _cache;
    private readonly IDatabaseOperationFactory<User> _userFactory;

    public UserService(
        IDatabaseOperationFactory<User> userFactory,
        IMemoryCache cache)
    {
        _userFactory = userFactory;
        _cache = cache;
    }

    public async Task<User?> GetUserByIdAsync(string id)
    {
        // 1. å°è¯•ä»ç¼“å­˜è·å–
        var cacheKey = $"user:{id}";
        if (_cache.TryGetValue(cacheKey, out User? cachedUser))
        {
            return cachedUser;
        }

        // 2. ä»æ•°æ®åº“è·å–
        var user = await _userFactory.GetByIdAsync(id);
        if (user != null)
        {
            // 3. ç¼“å­˜ç»“æœ
            _cache.Set(cacheKey, user, TimeSpan.FromMinutes(5));
        }

        return user;
    }

    public async Task<List<User>> GetUsersAsync(UserListRequest request)
    {
        // 1. æ„å»ºç¼“å­˜é”®
        var cacheKey = $"users:{request.Keyword}:{request.IsActive}:{request.Limit}";
        
        // 2. å°è¯•ä»ç¼“å­˜è·å–
        if (_cache.TryGetValue(cacheKey, out List<User>? cachedUsers))
        {
            return cachedUsers;
        }

        // 3. ä»æ•°æ®åº“è·å–
        var filter = _userFactory.CreateFilterBuilder()
            .ExcludeDeleted()
            .WithTenant()
            .Build();

        if (!string.IsNullOrEmpty(request.Keyword))
        {
            var searchFilter = _userFactory.CreateFilterBuilder()
                .Regex(u => u.Username, request.Keyword)
                .Or()
                .Regex(u => u.Email, request.Keyword)
                .Build();
            
            filter = _userFactory.CreateFilterBuilder()
                .And(filter)
                .And(searchFilter)
                .Build();
        }

        var sort = _userFactory.CreateSortBuilder()
            .Descending(u => u.CreatedAt)
            .Build();

        var limit = Math.Min(request.Limit ?? DEFAULT_PAGE_SIZE, MAX_PAGE_SIZE);
        var users = await _userFactory.FindAsync(filter, sort, limit);

        // 4. ç¼“å­˜ç»“æœ
        _cache.Set(cacheKey, users, TimeSpan.FromMinutes(2));

        return users;
    }

    public async Task<bool> UpdateUserAsync(UpdateUserRequest request)
    {
        var result = await _userFactory.UpdateAsync(existingUser, new OperationContext
        {
            UserId = _userFactory.GetCurrentUserId(),
            Username = _userFactory.GetCurrentUsername(),
            CompanyId = _userFactory.GetCurrentCompanyId(),
            OperationType = OperationType.Update,
            Description = "æ›´æ–°ç”¨æˆ·ä¿¡æ¯"
        });

        if (result)
        {
            // 5. æ¸…é™¤ç›¸å…³ç¼“å­˜
            _cache.Remove($"user:{request.Id}");
            _cache.Remove($"users:{request.Keyword}:{request.IsActive}:{request.Limit}");
        }

        return result;
    }
}

// âŒ é”™è¯¯ - æ²¡æœ‰ç¼“å­˜
public class UserService : IUserService
{
    public async Task<User?> GetUserByIdAsync(string id)
    {
        // æ¯æ¬¡éƒ½ä»æ•°æ®åº“è·å–ï¼ˆä½æ•ˆï¼‰
        return await _userFactory.GetByIdAsync(id);
    }
}
```

## ğŸ¯ æ€§èƒ½ç›‘æ§

### æ€§èƒ½æŒ‡æ ‡ç›‘æ§

```csharp
// âœ… æ­£ç¡® - æ€§èƒ½æŒ‡æ ‡ç›‘æ§
public class UserService : IUserService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    private readonly ILogger<UserService> _logger;
    private readonly IMetrics _metrics;

    public UserService(
        IDatabaseOperationFactory<User> userFactory,
        ILogger<UserService> logger,
        IMetrics metrics)
    {
        _userFactory = userFactory;
        _logger = logger;
        _metrics = metrics;
    }

    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        var stopwatch = Stopwatch.StartNew();
        
        try
        {
            // 1. è®°å½•å¼€å§‹æ—¶é—´
            _logger.LogInformation("å¼€å§‹åˆ›å»ºç”¨æˆ·: {Username}", request.Username);
            
            // 2. ä¸šåŠ¡é€»è¾‘å¤„ç†
            var user = new User
            {
                Username = request.Username,
                Email = request.Email,
                CompanyId = _userFactory.GetRequiredCompanyId(),
                CreatedBy = _userFactory.GetCurrentUserId(),
                CreatedAt = DateTime.UtcNow
            };

            var createdUser = await _userFactory.CreateAsync(user);
            
            // 3. è®°å½•æˆåŠŸæŒ‡æ ‡
            _metrics.Counter("user.created").Increment();
            _metrics.Timer("user.create.duration").Record(stopwatch.ElapsedMilliseconds);
            
            _logger.LogInformation("ç”¨æˆ·åˆ›å»ºæˆåŠŸ: {UserId}, è€—æ—¶: {ElapsedMs}ms", 
                createdUser.Id, stopwatch.ElapsedMilliseconds);
            
            return createdUser;
        }
        catch (Exception ex)
        {
            // 4. è®°å½•é”™è¯¯æŒ‡æ ‡
            _metrics.Counter("user.create.errors").Increment();
            _metrics.Timer("user.create.duration").Record(stopwatch.ElapsedMilliseconds);
            
            _logger.LogError(ex, "ç”¨æˆ·åˆ›å»ºå¤±è´¥: {Username}, è€—æ—¶: {ElapsedMs}ms", 
                request.Username, stopwatch.ElapsedMilliseconds);
            
            throw;
        }
    }

    public async Task<List<User>> GetUsersAsync(UserListRequest request)
    {
        var stopwatch = Stopwatch.StartNew();
        
        try
        {
            // 1. è®°å½•å¼€å§‹æ—¶é—´
            _logger.LogInformation("å¼€å§‹è·å–ç”¨æˆ·åˆ—è¡¨: {Keyword}", request.Keyword);
            
            // 2. æ„å»ºæŸ¥è¯¢æ¡ä»¶
            var filter = _userFactory.CreateFilterBuilder()
                .ExcludeDeleted()
                .WithTenant()
                .Build();

            if (!string.IsNullOrEmpty(request.Keyword))
            {
                var searchFilter = _userFactory.CreateFilterBuilder()
                    .Regex(u => u.Username, request.Keyword)
                    .Or()
                    .Regex(u => u.Email, request.Keyword)
                    .Build();
                
                filter = _userFactory.CreateFilterBuilder()
                    .And(filter)
                    .And(searchFilter)
                    .Build();
            }

            var sort = _userFactory.CreateSortBuilder()
                .Descending(u => u.CreatedAt)
                .Build();

            var limit = Math.Min(request.Limit ?? DEFAULT_PAGE_SIZE, MAX_PAGE_SIZE);
            var users = await _userFactory.FindAsync(filter, sort, limit);
            
            // 3. è®°å½•æˆåŠŸæŒ‡æ ‡
            _metrics.Counter("user.list.requests").Increment();
            _metrics.Timer("user.list.duration").Record(stopwatch.ElapsedMilliseconds);
            _metrics.Gauge("user.list.count").SetValue(users.Count);
            
            _logger.LogInformation("ç”¨æˆ·åˆ—è¡¨è·å–æˆåŠŸ: {Count}æ¡è®°å½•, è€—æ—¶: {ElapsedMs}ms", 
                users.Count, stopwatch.ElapsedMilliseconds);
            
            return users;
        }
        catch (Exception ex)
        {
            // 4. è®°å½•é”™è¯¯æŒ‡æ ‡
            _metrics.Counter("user.list.errors").Increment();
            _metrics.Timer("user.list.duration").Record(stopwatch.ElapsedMilliseconds);
            
            _logger.LogError(ex, "ç”¨æˆ·åˆ—è¡¨è·å–å¤±è´¥: {Keyword}, è€—æ—¶: {ElapsedMs}ms", 
                request.Keyword, stopwatch.ElapsedMilliseconds);
            
            throw;
        }
    }
}

// âŒ é”™è¯¯ - æ²¡æœ‰æ€§èƒ½ç›‘æ§
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // æ²¡æœ‰æ€§èƒ½ç›‘æ§
        var user = new User
        {
            Username = request.Username,
            Email = request.Email
        };

        return await _userFactory.CreateAsync(user);
    }
}
```

### å¥åº·æ£€æŸ¥

```csharp
// âœ… æ­£ç¡® - å¥åº·æ£€æŸ¥
public class UserServiceHealthCheck : IHealthCheck
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    private readonly ILogger<UserServiceHealthCheck> _logger;

    public UserServiceHealthCheck(
        IDatabaseOperationFactory<User> userFactory,
        ILogger<UserServiceHealthCheck> logger)
    {
        _userFactory = userFactory;
        _logger = logger;
    }

    public async Task<HealthCheckResult> CheckHealthAsync(HealthCheckContext context, CancellationToken cancellationToken = default)
    {
        try
        {
            // 1. æ£€æŸ¥æ•°æ®åº“è¿æ¥
            var userCount = await _userFactory.CountAsync();
            
            // 2. æ£€æŸ¥æ€§èƒ½æŒ‡æ ‡
            var stopwatch = Stopwatch.StartNew();
            await _userFactory.FindAsync(null, null, 1);
            var elapsed = stopwatch.ElapsedMilliseconds;
            
            // 3. è¯„ä¼°å¥åº·çŠ¶æ€
            if (elapsed > 1000) // è¶…è¿‡1ç§’è®¤ä¸ºä¸å¥åº·
            {
                return HealthCheckResult.Unhealthy($"ç”¨æˆ·æœåŠ¡å“åº”ç¼“æ…¢: {elapsed}ms");
            }
            
            if (userCount < 0)
            {
                return HealthCheckResult.Unhealthy("ç”¨æˆ·æ•°é‡å¼‚å¸¸");
            }
            
            return HealthCheckResult.Healthy($"ç”¨æˆ·æœåŠ¡æ­£å¸¸: {userCount}ä¸ªç”¨æˆ·, å“åº”æ—¶é—´: {elapsed}ms");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "ç”¨æˆ·æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥");
            return HealthCheckResult.Unhealthy("ç”¨æˆ·æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥", ex);
        }
    }
}

// âŒ é”™è¯¯ - æ²¡æœ‰å¥åº·æ£€æŸ¥
public class UserService : IUserService
{
    // æ²¡æœ‰å¥åº·æ£€æŸ¥å®ç°
}
```

## ğŸš« ç¦æ­¢çš„åšæ³•

### ä¸è¦å¿½ç•¥æ€§èƒ½å½±å“

```csharp
// âŒ é”™è¯¯ - å¿½ç•¥æ€§èƒ½å½±å“
public class UserService : IUserService
{
    public async Task<List<User>> GetUsersAsync()
    {
        // è·å–æ‰€æœ‰ç”¨æˆ·ï¼ˆæ€§èƒ½é—®é¢˜ï¼‰
        return await _userFactory.FindAsync();
    }
}

// âœ… æ­£ç¡® - è€ƒè™‘æ€§èƒ½å½±å“
public class UserService : IUserService
{
    public async Task<List<User>> GetUsersAsync(int? limit = null)
    {
        var actualLimit = limit ?? DEFAULT_PAGE_SIZE;
        if (actualLimit > MAX_PAGE_SIZE)
            actualLimit = MAX_PAGE_SIZE;

        return await _userFactory.FindAsync(null, null, actualLimit);
    }
}
```

### ä¸è¦å¿½ç•¥å†…å­˜ä½¿ç”¨

```csharp
// âŒ é”™è¯¯ - å†…å­˜ä½¿ç”¨ä¸å½“
public class UserService : IUserService
{
    public async Task<List<User>> GetUsersAsync()
    {
        // åŠ è½½æ‰€æœ‰ç”¨æˆ·åˆ°å†…å­˜ï¼ˆå†…å­˜æµªè´¹ï¼‰
        var allUsers = await _userFactory.FindAsync();
        return allUsers.ToList();
    }
}

// âœ… æ­£ç¡® - åˆç†ä½¿ç”¨å†…å­˜
public class UserService : IUserService
{
    public async Task<List<User>> GetUsersAsync(int? limit = null)
    {
        var actualLimit = limit ?? DEFAULT_PAGE_SIZE;
        return await _userFactory.FindAsync(null, null, actualLimit);
    }
}
```

### ä¸è¦å¿½ç•¥ç›‘æ§

```csharp
// âŒ é”™è¯¯ - æ²¡æœ‰ç›‘æ§
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // æ²¡æœ‰æ€§èƒ½ç›‘æ§
        var user = new User { Username = request.Username };
        return await _userFactory.CreateAsync(user);
    }
}

// âœ… æ­£ç¡® - å®Œæ•´çš„ç›‘æ§
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        var stopwatch = Stopwatch.StartNew();
        
        try
        {
            var user = new User { Username = request.Username };
            var result = await _userFactory.CreateAsync(user);
            
            _metrics.Counter("user.created").Increment();
            _metrics.Timer("user.create.duration").Record(stopwatch.ElapsedMilliseconds);
            
            return result;
        }
        catch (Exception ex)
        {
            _metrics.Counter("user.create.errors").Increment();
            throw;
        }
    }
}
```

## ğŸ“‹ æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•

åˆ›å»ºæˆ–ä¿®æ”¹ä»£ç æ—¶æ£€æŸ¥ï¼š

- [ ] **å­—æ®µæŠ•å½±ä¼˜åŒ–** - åˆ—è¡¨æŸ¥è¯¢ã€æ‰¹é‡æŸ¥è¯¢ä½¿ç”¨æŠ•å½±
- [ ] æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- [ ] ç´¢å¼•ä½¿ç”¨æ­£ç¡®
- [ ] æ‰¹é‡æ“ä½œå®ç°
- [ ] å†…å­˜ä½¿ç”¨åˆç†
- [ ] ç¼“å­˜ç­–ç•¥é€‚å½“
- [ ] æ€§èƒ½ç›‘æ§å®Œæ•´
- [ ] å¥åº·æ£€æŸ¥å®ç°
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] æ—¥å¿—è®°å½•è¯¦ç»†
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡

### å­—æ®µæŠ•å½±æ£€æŸ¥æ¸…å•

- [ ] åˆ—è¡¨æŸ¥è¯¢æ˜¯å¦ä½¿ç”¨äº†å­—æ®µæŠ•å½±ï¼Ÿ
- [ ] æ‰¹é‡æŸ¥è¯¢æ˜¯å¦ä½¿ç”¨äº†å­—æ®µæŠ•å½±ï¼Ÿ
- [ ] å…³è”æŸ¥è¯¢æ˜¯å¦ä½¿ç”¨äº†å­—æ®µæŠ•å½±ï¼Ÿ
- [ ] æŠ•å½±å­—æ®µæ˜¯å¦åªåŒ…å«éœ€è¦çš„å­—æ®µï¼Ÿ
- [ ] æŠ•å½±å­—æ®µæ˜¯å¦åŒ…å«å¿…è¦çš„å…³è”å­—æ®µï¼ˆå¦‚ CompanyIdï¼‰ï¼Ÿ
- [ ] æŠ•å½±å­—æ®µæ˜¯å¦åŒ…å«æ’åºå’Œè¿‡æ»¤å­—æ®µï¼Ÿ
- [ ] æ˜¯å¦æ’é™¤äº†ä¸éœ€è¦çš„å¤§å­—æ®µï¼ˆå¦‚ PasswordHashã€Avatarï¼‰ï¼Ÿ

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“æŸ¥è¯¢å­—æ®µæŠ•å½±ä¼˜åŒ–æ–‡æ¡£](mdc:docs/optimization/DATABASE-QUERY-PROJECTION-OPTIMIZATION.md)
- [ç”¨æˆ·æœåŠ¡å®ç°](mdc:Platform.ApiService/Services/UserService.cs)
- [è§’è‰²æœåŠ¡å®ç°](mdc:Platform.ApiService/Services/RoleService.cs)
- [ä¼ä¸šæœåŠ¡å®ç°](mdc:Platform.ApiService/Services/CompanyService.cs)
- [æ€§èƒ½ä¼˜åŒ–æŒ‡å—](https://docs.microsoft.com/en-us/aspnet/core/performance/)
