---
globs: Platform.ApiService/Services/*.cs,Platform.ServiceDefaults/Services/*.cs
description: èµ„æºæ£€æŸ¥è§„èŒƒ - ä½¿ç”¨ ResourceExtensions æ‰©å±•æ–¹æ³•
---
# èµ„æºæ£€æŸ¥è§„èŒƒ - ä½¿ç”¨ ResourceExtensions æ‰©å±•æ–¹æ³•

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

### ä½¿ç”¨ç»Ÿä¸€çš„ ResourceExtensions æ‰©å±•æ–¹æ³•è¿›è¡Œèµ„æºæ£€æŸ¥ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œä¸šåŠ¡è§„åˆ™ä¸€è‡´æ€§

## âœ… èµ„æºæ£€æŸ¥æ‰©å±•æ–¹æ³•

### åŸºç¡€èµ„æºæ£€æŸ¥æ‰©å±•

```csharp
// Platform.ServiceDefaults/Extensions/ResourceExtensions.cs
public static class ResourceExtensions
{
    /// <summary>
    /// æ£€æŸ¥èµ„æºæ˜¯å¦å­˜åœ¨
    /// </summary>
    public static async Task<T> EnsureExistsAsync<T>(this Task<T?> resourceTask, string resourceName, string resourceId) where T : class
    {
        var resource = await resourceTask;
        if (resource == null)
        {
            throw new KeyNotFoundException($"{resourceName} {resourceId} ä¸å­˜åœ¨");
        }
        return resource;
    }

    /// <summary>
    /// æ£€æŸ¥èµ„æºæ˜¯å¦å­˜åœ¨ï¼ˆå¸¦è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯ï¼‰
    /// </summary>
    public static async Task<T> EnsureExistsAsync<T>(this Task<T?> resourceTask, string errorMessage) where T : class
    {
        var resource = await resourceTask;
        if (resource == null)
        {
            throw new KeyNotFoundException(errorMessage);
        }
        return resource;
    }

    /// <summary>
    /// æ£€æŸ¥èµ„æºæ˜¯å¦ä¸å­˜åœ¨
    /// </summary>
    public static async Task EnsureNotExistsAsync<T>(this Task<T?> resourceTask, string resourceName, string resourceId) where T : class
    {
        var resource = await resourceTask;
        if (resource != null)
        {
            throw new InvalidOperationException($"{resourceName} {resourceId} å·²å­˜åœ¨");
        }
    }

    /// <summary>
    /// æ£€æŸ¥èµ„æºæ˜¯å¦ä¸å­˜åœ¨ï¼ˆå¸¦è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯ï¼‰
    /// </summary>
    public static async Task EnsureNotExistsAsync<T>(this Task<T?> resourceTask, string errorMessage) where T : class
    {
        var resource = await resourceTask;
        if (resource != null)
        {
            throw new InvalidOperationException(errorMessage);
        }
    }

    /// <summary>
    /// æ£€æŸ¥èµ„æºæ˜¯å¦å±äºå½“å‰ä¼ä¸š
    /// </summary>
    public static T EnsureBelongsToCurrentCompany<T>(this T resource, string currentCompanyId, string resourceName, string resourceId) where T : IMultiTenant
    {
        if (resource == null)
        {
            throw new KeyNotFoundException($"{resourceName} {resourceId} ä¸å­˜åœ¨");
        }

        if (resource.CompanyId != currentCompanyId)
        {
            throw new UnauthorizedAccessException($"æ— æƒè®¿é—® {resourceName} {resourceId}");
        }

        return resource;
    }

    /// <summary>
    /// æ£€æŸ¥èµ„æºæ˜¯å¦æœªè¢«åˆ é™¤
    /// </summary>
    public static T EnsureNotDeleted<T>(this T resource, string resourceName, string resourceId) where T : ISoftDeletable
    {
        if (resource == null)
        {
            throw new KeyNotFoundException($"{resourceName} {resourceId} ä¸å­˜åœ¨");
        }

        if (resource.IsDeleted)
        {
            throw new InvalidOperationException($"{resourceName} {resourceId} å·²è¢«åˆ é™¤");
        }

        return resource;
    }

    /// <summary>
    /// æ£€æŸ¥èµ„æºæ˜¯å¦å¤„äºæ´»è·ƒçŠ¶æ€
    /// </summary>
    public static T EnsureActive<T>(this T resource, string resourceName, string resourceId) where T : IActiveEntity
    {
        if (resource == null)
        {
            throw new KeyNotFoundException($"{resourceName} {resourceId} ä¸å­˜åœ¨");
        }

        if (!resource.IsActive)
        {
            throw new InvalidOperationException($"{resourceName} {resourceId} å·²åœç”¨");
        }

        return resource;
    }

    /// <summary>
    /// æ£€æŸ¥ç”¨æˆ·æƒé™
    /// </summary>
    public static T EnsureUserPermission<T>(this T resource, string currentUserId, string requiredPermission, string resourceName, string resourceId) where T : IEntity
    {
        if (resource == null)
        {
            throw new KeyNotFoundException($"{resourceName} {resourceId} ä¸å­˜åœ¨");
        }

        // è¿™é‡Œå¯ä»¥æ ¹æ®å…·ä½“çš„æƒé™æ£€æŸ¥é€»è¾‘æ¥å®ç°
        // ä¾‹å¦‚æ£€æŸ¥ç”¨æˆ·è§’è‰²ã€æƒé™ç­‰
        if (!HasPermission(currentUserId, requiredPermission))
        {
            throw new UnauthorizedAccessException($"æ— æƒæ‰§è¡Œ {requiredPermission} æ“ä½œ");
        }

        return resource;
    }

    /// <summary>
    /// æ£€æŸ¥èµ„æºæ•°é‡é™åˆ¶
    /// </summary>
    public static async Task EnsureWithinLimitAsync<T>(this Task<long> countTask, long limit, string resourceName)
    {
        var count = await countTask;
        if (count >= limit)
        {
            throw new InvalidOperationException($"{resourceName} æ•°é‡å·²è¾¾ä¸Šé™ {limit}");
        }
    }

    /// <summary>
    /// æ£€æŸ¥èµ„æºæ•°é‡é™åˆ¶ï¼ˆå¸¦è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯ï¼‰
    /// </summary>
    public static async Task EnsureWithinLimitAsync<T>(this Task<long> countTask, long limit, string errorMessage)
    {
        var count = await countTask;
        if (count >= limit)
        {
            throw new InvalidOperationException(errorMessage);
        }
    }

    private static bool HasPermission(string userId, string permission)
    {
        // è¿™é‡Œåº”è¯¥å®ç°å…·ä½“çš„æƒé™æ£€æŸ¥é€»è¾‘
        // ä¾‹å¦‚ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·è§’è‰²å’Œæƒé™
        return true; // ç®€åŒ–å®ç°
    }
}
```

### ä¸šåŠ¡ç‰¹å®šèµ„æºæ£€æŸ¥æ‰©å±•

```csharp
// Platform.ApiService/Extensions/BusinessResourceExtensions.cs
public static class BusinessResourceExtensions
{
    /// <summary>
    /// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ä»¥åˆ é™¤
    /// </summary>
    public static async Task<User> EnsureCanDeleteAsync(this Task<User?> userTask, string userId)
    {
        var user = await userTask.EnsureExistsAsync("ç”¨æˆ·", userId);
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ä¼ä¸šç®¡ç†å‘˜
        if (user.IsAdmin)
        {
            throw new InvalidOperationException("ä¼ä¸šç®¡ç†å‘˜æ— æ³•åˆ é™¤");
        }

        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æ´»è·ƒä¼šè¯
        if (user.LastLoginAt.HasValue && user.LastLoginAt.Value > DateTime.UtcNow.AddHours(-1))
        {
            throw new InvalidOperationException("æ— æ³•åˆ é™¤æœ‰æ´»è·ƒä¼šè¯çš„ç”¨æˆ·");
        }

        return user;
    }

    /// <summary>
    /// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ä»¥æ›´æ–°
    /// </summary>
    public static async Task<User> EnsureCanUpdateAsync(this Task<User?> userTask, string userId)
    {
        var user = await userTask.EnsureExistsAsync("ç”¨æˆ·", userId);
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è¢«åˆ é™¤
        user.EnsureNotDeleted("ç”¨æˆ·", userId);
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²åœç”¨ï¼ˆé™¤éæ˜¯æ¿€æ´»æ“ä½œï¼‰
        if (!user.IsActive)
        {
            throw new InvalidOperationException("æ— æ³•ä¿®æ”¹å·²åœç”¨ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯");
        }

        return user;
    }

    /// <summary>
    /// æ£€æŸ¥è§’è‰²æ˜¯å¦å¯ä»¥åˆ é™¤
    /// </summary>
    public static async Task<Role> EnsureCanDeleteAsync(this Task<Role?> roleTask, string roleId)
    {
        var role = await roleTask.EnsureExistsAsync("è§’è‰²", roleId);
        
        // æ£€æŸ¥è§’è‰²æ˜¯å¦è¢«ç”¨æˆ·ä½¿ç”¨
        var userCount = await _userFactory.CountAsync(
            _userFactory.CreateFilterBuilder()
                .Equal(u => u.RoleId, roleId)
                .Build()
        );

        if (userCount > 0)
        {
            throw new InvalidOperationException("è§’è‰²æ­£åœ¨è¢«ç”¨æˆ·ä½¿ç”¨ï¼Œæ— æ³•åˆ é™¤");
        }

        return role;
    }

    /// <summary>
    /// æ£€æŸ¥ä¼ä¸šæ˜¯å¦å¯ä»¥åˆ é™¤
    /// </summary>
    public static async Task<Company> EnsureCanDeleteAsync(this Task<Company?> companyTask, string companyId)
    {
        var company = await companyTask.EnsureExistsAsync("ä¼ä¸š", companyId);
        
        // æ£€æŸ¥ä¼ä¸šæ˜¯å¦æœ‰ç”¨æˆ·
        var userCount = await _userFactory.CountAsync(
            _userFactory.CreateFilterBuilder()
                .Equal(u => u.CompanyId, companyId)
                .Build()
        );

        if (userCount > 0)
        {
            throw new InvalidOperationException("ä¼ä¸šæœ‰ç”¨æˆ·ï¼Œæ— æ³•åˆ é™¤");
        }

        return company;
    }

    /// <summary>
    /// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ä»¥åˆ†é…è§’è‰²
    /// </summary>
    public static async Task<User> EnsureCanAssignRoleAsync(this Task<User?> userTask, string userId, string roleId)
    {
        var user = await userTask.EnsureExistsAsync("ç”¨æˆ·", userId);
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å±äºå½“å‰ä¼ä¸š
        user.EnsureBelongsToCurrentCompany(_tenantContext.GetCurrentCompanyId(), "ç”¨æˆ·", userId);
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è¢«åˆ é™¤
        user.EnsureNotDeleted("ç”¨æˆ·", userId);
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²åœç”¨
        user.EnsureActive("ç”¨æˆ·", userId);

        return user;
    }

    /// <summary>
    /// æ£€æŸ¥è§’è‰²æ˜¯å¦å¯ä»¥åˆ†é…ç»™ç”¨æˆ·
    /// </summary>
    public static async Task<Role> EnsureCanAssignToUserAsync(this Task<Role?> roleTask, string roleId, string userId)
    {
        var role = await roleTask.EnsureExistsAsync("è§’è‰²", roleId);
        
        // æ£€æŸ¥è§’è‰²æ˜¯å¦å±äºå½“å‰ä¼ä¸š
        role.EnsureBelongsToCurrentCompany(_tenantContext.GetCurrentCompanyId(), "è§’è‰²", roleId);
        
        // æ£€æŸ¥è§’è‰²æ˜¯å¦å·²è¢«åˆ é™¤
        role.EnsureNotDeleted("è§’è‰²", roleId);
        
        // æ£€æŸ¥è§’è‰²æ˜¯å¦å·²åœç”¨
        role.EnsureActive("è§’è‰²", roleId);

        return role;
    }
}
```

## ğŸ¯ æœåŠ¡ä¸­ä½¿ç”¨èµ„æºæ£€æŸ¥æ‰©å±•

### ç”¨æˆ·æœåŠ¡èµ„æºæ£€æŸ¥

```csharp
// âœ… æ­£ç¡® - ä½¿ç”¨èµ„æºæ£€æŸ¥æ‰©å±•
public class UserService : IUserService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    private readonly ITenantContext _tenantContext;
    private readonly ILogger<UserService> _logger;

    public UserService(
        IDatabaseOperationFactory<User> userFactory,
        ITenantContext tenantContext,
        ILogger<UserService> logger)
    {
        _userFactory = userFactory;
        _tenantContext = tenantContext;
        _logger = logger;
    }

    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        try
        {
            // 1. å‚æ•°éªŒè¯
            if (request == null)
                throw new ArgumentNullException(nameof(request));

            // 2. ä¸šåŠ¡éªŒè¯
            await ValidateCreateUserRequestAsync(request);
            
            // 3. æ£€æŸ¥å”¯ä¸€æ€§
            await _userFactory.GetByUsernameAsync(request.Username).EnsureNotExistsAsync("ç”¨æˆ·åå·²å­˜åœ¨");
            await _userFactory.GetByEmailAsync(request.Email).EnsureNotExistsAsync("é‚®ç®±å·²å­˜åœ¨");
            
            // 4. æ£€æŸ¥ç”¨æˆ·æ•°é‡é™åˆ¶
            await _userFactory.CountAsync().EnsureWithinLimitAsync(1000, "ä¼ä¸šç”¨æˆ·æ•°é‡å·²è¾¾ä¸Šé™");
            
            // 5. åˆ›å»ºç”¨æˆ·å®ä½“
            var user = new User
            {
                Username = request.Username.Trim(),
                Email = request.Email.Trim().ToLowerInvariant(),
                CompanyId = _tenantContext.GetRequiredCompanyId(),
                CreatedBy = _tenantContext.GetRequiredUserId(),
                CreatedAt = DateTime.UtcNow
            };
            
            var createdUser = await _userFactory.CreateAsync(user);
            
            _logger.LogInformation("ç”¨æˆ·åˆ›å»ºæˆåŠŸ: {UserId}, ç”¨æˆ·å: {Username}", 
                createdUser.Id, createdUser.Username);
            
            return createdUser;
        }
        catch (ArgumentException ex)
        {
            _logger.LogWarning(ex, "ç”¨æˆ·åˆ›å»ºå‚æ•°é”™è¯¯: {Username}", request?.Username);
            throw;
        }
        catch (InvalidOperationException ex)
        {
            _logger.LogWarning(ex, "ç”¨æˆ·åˆ›å»ºä¸šåŠ¡é”™è¯¯: {Username}", request?.Username);
            throw;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "ç”¨æˆ·åˆ›å»ºå¤±è´¥: {Username}", request?.Username);
            throw new InvalidOperationException("ç”¨æˆ·åˆ›å»ºå¤±è´¥", ex);
        }
    }

    public async Task<User?> GetUserByIdAsync(string id)
    {
        try
        {
            if (string.IsNullOrEmpty(id))
                throw new ArgumentException("ç”¨æˆ·IDä¸èƒ½ä¸ºç©º", nameof(id));

            var user = await _userFactory.GetByIdAsync(id);
            if (user == null)
            {
                _logger.LogWarning("ç”¨æˆ·ä¸å­˜åœ¨: {UserId}", id);
                throw new KeyNotFoundException($"ç”¨æˆ· {id} ä¸å­˜åœ¨");
            }

            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å±äºå½“å‰ä¼ä¸š
            user.EnsureBelongsToCurrentCompany(_tenantContext.GetCurrentCompanyId(), "ç”¨æˆ·", id);

            _logger.LogDebug("ç”¨æˆ·è·å–æˆåŠŸ: {UserId}, ç”¨æˆ·å: {Username}", user.Id, user.Username);
            return user;
        }
        catch (ArgumentException)
        {
            throw;
        }
        catch (KeyNotFoundException)
        {
            throw;
        }
        catch (UnauthorizedAccessException)
        {
            throw;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "è·å–ç”¨æˆ·å¤±è´¥: {UserId}", id);
            throw new InvalidOperationException("è·å–ç”¨æˆ·å¤±è´¥", ex);
        }
    }

    public async Task<bool> UpdateUserAsync(UpdateUserRequest request)
    {
        try
        {
            // 1. å‚æ•°éªŒè¯
            if (request == null)
                throw new ArgumentNullException(nameof(request));

            if (string.IsNullOrEmpty(request.Id))
                throw new ArgumentException("ç”¨æˆ·IDä¸èƒ½ä¸ºç©º", nameof(request.Id));

            // 2. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ä¸”å¯ä»¥æ›´æ–°
            var existingUser = await _userFactory.GetByIdAsync(request.Id).EnsureCanUpdateAsync(request.Id);
            
            // 3. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å±äºå½“å‰ä¼ä¸š
            existingUser.EnsureBelongsToCurrentCompany(_tenantContext.GetCurrentCompanyId(), "ç”¨æˆ·", request.Id);
            
            // 4. ä¸šåŠ¡éªŒè¯
            await ValidateUpdateUserRequestAsync(request, existingUser);
            
            // 5. æ£€æŸ¥å”¯ä¸€æ€§ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if (!string.IsNullOrEmpty(request.Username) && request.Username != existingUser.Username)
            {
                await _userFactory.GetByUsernameAsync(request.Username).EnsureNotExistsAsync("ç”¨æˆ·åå·²å­˜åœ¨");
            }
            
            if (!string.IsNullOrEmpty(request.Email) && request.Email != existingUser.Email)
            {
                await _userFactory.GetByEmailAsync(request.Email).EnsureNotExistsAsync("é‚®ç®±å·²å­˜åœ¨");
            }

            // 6. æ„å»ºæ›´æ–°æ“ä½œ
            var update = _userFactory.CreateUpdateBuilder()
                .SetCurrentTimestamp()
                .SetOperationTracking(_tenantContext.GetCurrentUserId(), _tenantContext.GetCurrentUsername())
                .Build();

            if (!string.IsNullOrEmpty(request.Username))
            {
                update = _userFactory.CreateUpdateBuilder()
                    .Set(u => u.Username, request.Username)
                    .SetCurrentTimestamp()
                    .SetOperationTracking(_tenantContext.GetCurrentUserId(), _tenantContext.GetCurrentUsername())
                    .Build();
            }

            if (!string.IsNullOrEmpty(request.Email))
            {
                update = _userFactory.CreateUpdateBuilder()
                    .Set(u => u.Email, request.Email)
                    .SetCurrentTimestamp()
                    .SetOperationTracking(_tenantContext.GetCurrentUserId(), _tenantContext.GetCurrentUsername())
                    .Build();
            }

            // 7. æ‰§è¡Œæ›´æ–°
            var result = await _userFactory.UpdateAsync(existingUser, new OperationContext
            {
                UserId = _tenantContext.GetCurrentUserId(),
                Username = _tenantContext.GetCurrentUsername(),
                CompanyId = _tenantContext.GetCurrentCompanyId(),
                OperationType = OperationType.Update,
                Description = "æ›´æ–°ç”¨æˆ·ä¿¡æ¯"
            });

            if (result)
            {
                _logger.LogInformation("ç”¨æˆ·æ›´æ–°æˆåŠŸ: {UserId}", request.Id);
            }
            else
            {
                _logger.LogWarning("ç”¨æˆ·æ›´æ–°å¤±è´¥: {UserId}", request.Id);
            }

            return result;
        }
        catch (ArgumentException)
        {
            throw;
        }
        catch (KeyNotFoundException)
        {
            throw;
        }
        catch (UnauthorizedAccessException)
        {
            throw;
        }
        catch (InvalidOperationException)
        {
            throw;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "ç”¨æˆ·æ›´æ–°å¤±è´¥: {UserId}", request?.Id);
            throw new InvalidOperationException("ç”¨æˆ·æ›´æ–°å¤±è´¥", ex);
        }
    }

    public async Task<bool> DeleteUserAsync(string id)
    {
        try
        {
            if (string.IsNullOrEmpty(id))
                throw new ArgumentException("ç”¨æˆ·IDä¸èƒ½ä¸ºç©º", nameof(id));

            // 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ä¸”å¯ä»¥åˆ é™¤
            var user = await _userFactory.GetByIdAsync(id).EnsureCanDeleteAsync(id);
            
            // 2. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å±äºå½“å‰ä¼ä¸š
            user.EnsureBelongsToCurrentCompany(_tenantContext.GetCurrentCompanyId(), "ç”¨æˆ·", id);

            // 3. æ‰§è¡Œè½¯åˆ é™¤
            var result = await _userFactory.SoftDeleteAsync(id, new OperationContext
            {
                UserId = _tenantContext.GetCurrentUserId(),
                Username = _tenantContext.GetCurrentUsername(),
                CompanyId = _tenantContext.GetCurrentCompanyId(),
                OperationType = OperationType.Delete,
                Description = "åˆ é™¤ç”¨æˆ·"
            });

            if (result)
            {
                _logger.LogInformation("ç”¨æˆ·åˆ é™¤æˆåŠŸ: {UserId}, ç”¨æˆ·å: {Username}", id, user.Username);
            }
            else
            {
                _logger.LogWarning("ç”¨æˆ·åˆ é™¤å¤±è´¥: {UserId}", id);
            }

            return result;
        }
        catch (ArgumentException)
        {
            throw;
        }
        catch (KeyNotFoundException)
        {
            throw;
        }
        catch (UnauthorizedAccessException)
        {
            throw;
        }
        catch (InvalidOperationException)
        {
            throw;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "ç”¨æˆ·åˆ é™¤å¤±è´¥: {UserId}", id);
            throw new InvalidOperationException("ç”¨æˆ·åˆ é™¤å¤±è´¥", ex);
        }
    }

    private async Task ValidateCreateUserRequestAsync(CreateUserRequest request)
    {
        if (string.IsNullOrEmpty(request.Username))
            throw new ArgumentException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º", nameof(request.Username));

        if (request.Username.Length < 3 || request.Username.Length > 50)
            throw new ArgumentException("ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¸ªå­—ç¬¦ä¹‹é—´", nameof(request.Username));

        if (!IsValidUsername(request.Username))
            throw new ArgumentException("ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿", nameof(request.Username));

        if (string.IsNullOrEmpty(request.Email))
            throw new ArgumentException("é‚®ç®±ä¸èƒ½ä¸ºç©º", nameof(request.Email));

        if (!IsValidEmail(request.Email))
            throw new ArgumentException("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®", nameof(request.Email));

        if (string.IsNullOrEmpty(request.Password))
            throw new ArgumentException("å¯†ç ä¸èƒ½ä¸ºç©º", nameof(request.Password));

        if (!IsStrongPassword(request.Password))
            throw new ArgumentException("å¯†ç å¿…é¡»åŒ…å«å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦ï¼Œé•¿åº¦è‡³å°‘8ä½", nameof(request.Password));
    }

    private async Task ValidateUpdateUserRequestAsync(UpdateUserRequest request, User existingUser)
    {
        if (string.IsNullOrEmpty(request.Username) && string.IsNullOrEmpty(request.Email))
            throw new ArgumentException("è‡³å°‘éœ€è¦æ›´æ–°ä¸€ä¸ªå­—æ®µ");

        if (!string.IsNullOrEmpty(request.Username))
        {
            if (request.Username.Length < 3 || request.Username.Length > 50)
                throw new ArgumentException("ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¸ªå­—ç¬¦ä¹‹é—´");

            if (!IsValidUsername(request.Username))
                throw new ArgumentException("ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿");
        }

        if (!string.IsNullOrEmpty(request.Email))
        {
            if (!IsValidEmail(request.Email))
                throw new ArgumentException("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®");
        }
    }

    private bool IsValidUsername(string username)
    {
        return username.All(c => char.IsLetterOrDigit(c) || c == '_');
    }

    private bool IsValidEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }

    private bool IsStrongPassword(string password)
    {
        if (string.IsNullOrEmpty(password) || password.Length < 8)
            return false;

        var hasLetter = password.Any(char.IsLetter);
        var hasDigit = password.Any(char.IsDigit);
        var hasSpecialChar = password.Any(c => !char.IsLetterOrDigit(c));

        return hasLetter && hasDigit && hasSpecialChar;
    }
}

// âŒ é”™è¯¯ - æ²¡æœ‰ä½¿ç”¨èµ„æºæ£€æŸ¥æ‰©å±•
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // æ‰‹åŠ¨æ£€æŸ¥ï¼ˆå®¹æ˜“é—æ¼ï¼‰
        var existingUser = await _userFactory.GetByUsernameAsync(request.Username);
        if (existingUser != null)
        {
            throw new InvalidOperationException("ç”¨æˆ·åå·²å­˜åœ¨");
        }
        
        // æ²¡æœ‰ä½¿ç”¨ç»Ÿä¸€çš„èµ„æºæ£€æŸ¥æ‰©å±•
        var user = new User
        {
            Username = request.Username,
            Email = request.Email
        };
        
        return await _userFactory.CreateAsync(user);
    }
}
```

## ğŸ¯ èµ„æºæ£€æŸ¥æ¥å£å®šä¹‰

### èµ„æºæ¥å£å®šä¹‰

```csharp
// Platform.ServiceDefaults/Models/ResourceInterfaces.cs
public interface IActiveEntity
{
    bool IsActive { get; set; }
}

public interface IMultiTenant
{
    string CompanyId { get; set; }
}

public interface ISoftDeletable
{
    bool IsDeleted { get; set; }
    DateTime? DeletedAt { get; set; }
    string? DeletedBy { get; set; }
}

public interface IEntity
{
    string? Id { get; set; }
}

public interface ITimestamped
{
    DateTime CreatedAt { get; set; }
    DateTime UpdatedAt { get; set; }
}

public interface IOperationTrackable
{
    string? CreatedBy { get; set; }
    string? CreatedByUsername { get; set; }
    string? UpdatedBy { get; set; }
    string? UpdatedByUsername { get; set; }
    string? LastOperationType { get; set; }
    DateTime? LastOperationAt { get; set; }
}
```

## ğŸš« ç¦æ­¢çš„åšæ³•

### ä¸è¦æ‰‹åŠ¨æ£€æŸ¥èµ„æº

```csharp
// âŒ é”™è¯¯ - æ‰‹åŠ¨æ£€æŸ¥èµ„æº
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // æ‰‹åŠ¨æ£€æŸ¥ï¼ˆå®¹æ˜“é—æ¼ï¼‰
        var existingUser = await _userFactory.GetByUsernameAsync(request.Username);
        if (existingUser != null)
        {
            throw new InvalidOperationException("ç”¨æˆ·åå·²å­˜åœ¨");
        }
        
        var existingEmail = await _userFactory.GetByEmailAsync(request.Email);
        if (existingEmail != null)
        {
            throw new InvalidOperationException("é‚®ç®±å·²å­˜åœ¨");
        }
    }
}

// âœ… æ­£ç¡® - ä½¿ç”¨èµ„æºæ£€æŸ¥æ‰©å±•
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // ä½¿ç”¨ç»Ÿä¸€çš„èµ„æºæ£€æŸ¥æ‰©å±•
        await _userFactory.GetByUsernameAsync(request.Username).EnsureNotExistsAsync("ç”¨æˆ·åå·²å­˜åœ¨");
        await _userFactory.GetByEmailAsync(request.Email).EnsureNotExistsAsync("é‚®ç®±å·²å­˜åœ¨");
    }
}
```

### ä¸è¦å¿½ç•¥èµ„æºæ£€æŸ¥

```csharp
// âŒ é”™è¯¯ - å¿½ç•¥èµ„æºæ£€æŸ¥
public class UserService : IUserService
{
    public async Task<User> GetUserByIdAsync(string id)
    {
        // æ²¡æœ‰æ£€æŸ¥èµ„æºæ˜¯å¦å­˜åœ¨
        return await _userFactory.GetByIdAsync(id);
    }
}

// âœ… æ­£ç¡® - å®Œæ•´çš„èµ„æºæ£€æŸ¥
public class UserService : IUserService
{
    public async Task<User> GetUserByIdAsync(string id)
    {
        // ä½¿ç”¨èµ„æºæ£€æŸ¥æ‰©å±•
        var user = await _userFactory.GetByIdAsync(id).EnsureExistsAsync("ç”¨æˆ·", id);
        user.EnsureBelongsToCurrentCompany(_tenantContext.GetCurrentCompanyId(), "ç”¨æˆ·", id);
        return user;
    }
}
```

### ä¸è¦é‡å¤èµ„æºæ£€æŸ¥é€»è¾‘

```csharp
// âŒ é”™è¯¯ - é‡å¤èµ„æºæ£€æŸ¥é€»è¾‘
public class UserService : IUserService
{
    public async Task<User> GetUserByIdAsync(string id)
    {
        var user = await _userFactory.GetByIdAsync(id);
        if (user == null)
        {
            throw new KeyNotFoundException($"ç”¨æˆ· {id} ä¸å­˜åœ¨");
        }
        return user;
    }

    public async Task<bool> UpdateUserAsync(UpdateUserRequest request)
    {
        var user = await _userFactory.GetByIdAsync(request.Id);
        if (user == null)
        {
            throw new KeyNotFoundException($"ç”¨æˆ· {request.Id} ä¸å­˜åœ¨");
        }
        // é‡å¤çš„æ£€æŸ¥é€»è¾‘
    }
}

// âœ… æ­£ç¡® - ä½¿ç”¨èµ„æºæ£€æŸ¥æ‰©å±•é¿å…é‡å¤
public class UserService : IUserService
{
    public async Task<User> GetUserByIdAsync(string id)
    {
        return await _userFactory.GetByIdAsync(id).EnsureExistsAsync("ç”¨æˆ·", id);
    }

    public async Task<bool> UpdateUserAsync(UpdateUserRequest request)
    {
        var user = await _userFactory.GetByIdAsync(request.Id).EnsureExistsAsync("ç”¨æˆ·", request.Id);
        // ä½¿ç”¨ç»Ÿä¸€çš„èµ„æºæ£€æŸ¥æ‰©å±•
    }
}
```

## ğŸ“‹ èµ„æºæ£€æŸ¥æ£€æŸ¥æ¸…å•

åˆ›å»ºæˆ–ä¿®æ”¹æœåŠ¡æ—¶æ£€æŸ¥ï¼š

- [ ] ä½¿ç”¨ ResourceExtensions æ‰©å±•æ–¹æ³•
- [ ] æ£€æŸ¥èµ„æºæ˜¯å¦å­˜åœ¨
- [ ] æ£€æŸ¥èµ„æºæ˜¯å¦å±äºå½“å‰ä¼ä¸š
- [ ] æ£€æŸ¥èµ„æºæ˜¯å¦æœªè¢«åˆ é™¤
- [ ] æ£€æŸ¥èµ„æºæ˜¯å¦å¤„äºæ´»è·ƒçŠ¶æ€
- [ ] æ£€æŸ¥ç”¨æˆ·æƒé™
- [ ] æ£€æŸ¥èµ„æºæ•°é‡é™åˆ¶
- [ ] ä½¿ç”¨ä¸šåŠ¡ç‰¹å®šèµ„æºæ£€æŸ¥æ‰©å±•
- [ ] é¿å…é‡å¤èµ„æºæ£€æŸ¥é€»è¾‘
- [ ] æä¾›æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç”¨æˆ·æœåŠ¡å®ç°](mdc:Platform.ApiService/Services/UserService.cs)
- [è§’è‰²æœåŠ¡å®ç°](mdc:Platform.ApiService/Services/RoleService.cs)
- [ä¼ä¸šæœåŠ¡å®ç°](mdc:Platform.ApiService/Services/CompanyService.cs)
- [èµ„æºæ£€æŸ¥æ‰©å±•æ–¹æ³•](mdc:Platform.ServiceDefaults/Extensions/ResourceExtensions.cs)
