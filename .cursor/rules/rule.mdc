---
alwaysApply: true
---

# Aspire Admin Platform - Cursor Rules

## 项目概述

Aspire Admin Platform 是基于 .NET Aspire 构建的多租户企业管理平台，包含后端服务、管理后台与跨平台移动应用。

**核心技术栈：**
- 后端：.NET 10, ASP.NET Core, MongoDB, SignalR
- 管理后台：React 19, Ant Design Pro, UmiJS
- 移动应用：React Native, Expo
- 基础设施：Docker, YARP 网关, OpenTelemetry

## 架构原则

### 1. 多租户数据隔离
- **强制规则**：所有实体访问必须通过 `IDatabaseOperationFactory<T>` 进行
- **禁止直接访问**：严禁直接使用 `IMongoCollection<T>`
- **自动过滤**：实现 `IMultiTenant` 的实体自动附加 `CompanyId` 过滤
- **企业上下文**：通过 `ITenantContext.GetCurrentCompanyIdAsync()` 获取当前企业ID

### 2. 权限控制模型
- **菜单级权限**：使用 `[RequireMenu("menu-name")]` 声明访问权限
- **角色权限**：角色仅包含 `MenuIds`，获得菜单即具备对应 API 访问权限
- **前端不隐藏**：前端不再隐藏按钮，真实权限由后端控制
- **权限验证**：所有敏感操作需要权限验证
- **统一实现**：权限校验统一使用 `Platform.ApiService.Attributes.RequireMenuAttribute`，禁止使用旧的 `RequirePermission` 风格自定义检查

> 菜单级权限、角色与菜单关系、前后端约定等详细规范，见 `docs/features/MENU-LEVEL-PERMISSION-GUIDE.md`。

### 3. 数据操作模式
- **创建**：`CreateAsync()` 自动设置 `IsDeleted=false`, `CreatedAt`, `UpdatedAt`
- **更新**：使用 `FindOneAndUpdateAsync()` 进行原子操作
- **删除**：使用 `SoftDeleteAsync()` 进行软删除，保留审计信息
- **查询**：使用 `FilterBuilder` 构建查询条件，支持链式调用
- **审计字段**：所有实现 `ISoftDeletable` / `ITimestamped` 的实体，其 `CreatedAt` / `UpdatedAt` / `IsDeleted` / `DeletedAt` / `CreatedBy` / `UpdatedBy` 等字段一律由 `DatabaseOperationFactory<T>` 自动维护，业务代码禁止手动赋值

> 中间件与日志、租户上下文和数据库审计字段的详细规范，见 `docs/features/BACKEND-RULES.md`。

## 中间件与审计日志规范（总纲）

- **统一响应中间件**：所有 HTTP API 必须启用 `ResponseFormattingMiddleware`，统一输出 `success` / `data` / `timestamp` 格式，仅对健康检查、OpenAPI、SignalR Hub 等特殊路径白名单跳过。
- **活动日志中间件**：必须启用 `ActivityLogMiddleware` 并通过 `IUserActivityLogService` 记录 HTTP 访问日志，禁止在业务代码中手写重复的访问审计逻辑。
- **租户上下文唯一入口**：除 `userId` 外，企业信息、角色与权限一律通过 `ITenantContext`（如 `GetCurrentCompanyIdAsync`、`IsAdminAsync`、`HasPermissionAsync` 等）从数据库获取，禁止直接从 JWT 读取这些字段。
- **审计字段自动维护**：创建、更新、软删除操作必须通过 `IDatabaseOperationFactory<T>` 完成，由工厂统一设置 `CreatedAt` / `UpdatedAt` / `IsDeleted` / `DeletedAt` / `CreatedBy` / `UpdatedBy` 等字段。

> 本节仅为硬性规则摘要，详细说明与示例请参考 `docs/features/BACKEND-RULES.md`。

## 后端开发规范

- **控制器**：所有业务控制器必须继承 `BaseApiController`，通过依赖注入调用服务层，不直接访问 MongoDB。
- **服务层**：服务只依赖 `IDatabaseOperationFactory<T>` 和 `ITenantContext`，使用 Filter/Sort/Update Builder 完成查询与更新。
- **实体设计**：业务实体实现 `IEntity`、`ISoftDeletable`、`ITimestamped`，多租户实体额外实现 `IMultiTenant` 或继承 `MultiTenantEntity`。
- **错误处理与验证**：统一使用 `ApiResponse<T>` + `BaseApiController` 提供的辅助方法处理错误，并通过 DataAnnotations 完成输入验证。

> 详细的后端模式（控制器/服务/实体）、错误处理与验证示例，见 `docs/features/BACKEND-RULES.md` 与 `docs/features/API-RESPONSE-RULES.md`。

## 前端开发规范

### 硬规则摘要

- **路由与菜单**：统一使用 `config/routes.ts` 管理路由与菜单元数据，所有语言的菜单文案在 `src/locales/*/menu.ts` 中维护并保持同步。
- **服务层**：所有 HTTP 调用必须通过 `src/services` + `@umijs/max` 的 `request` 完成，组件中禁止直接 `fetch`。
- **页面结构**：列表/表单页面应使用 Ant Design Pro/Ant Design 提供的标准骨架，并正确处理 loading 和错误状态。
- **状态管理**：优先使用 hooks（`useRequest`、`useModel` 等），避免不必要的全局状态工具。
- **权限联动**：前端不再以隐藏按钮/菜单实现权限控制，只负责展示；真实权限以后端菜单级校验为准。

> 前端路由、services、hooks、页面模板和多语言菜单等详细规范，见 `docs/features/FRONTEND-RULES.md`。

## 规则管理系统与 MCP / IoT 特定规范

- **规则实体**：规则列表项必须实现 `ISoftDeletable`、`IEntity`、`ITimestamped`、`IMultiTenant`，具备多租户与软删除能力，并携带 MCP 相关配置。
- **规则状态**：使用统一的 `RuleStatus` 常量管理规则生命周期（禁用/启用/草稿/过期），避免魔法数字。
- **查询与分页**：规则查询必须使用 `IDatabaseOperationFactory<RuleListItem>`，结合 Filter/Sort Builder 与分页查询模式。
- **MCP 配置**：通过 `McpRuleConfig` 管理工具、资源和提示词配置，确保 Rule → MCP 的映射清晰可追踪。

> 规则系统与 MCP 集成的详细设计与演进边界，请参考：
> - `docs/RULES.md`
> - `docs/features/RULES-MCP-INTEGRATION.md`

### 5. IoT 平台规则概要

- **命名与边界**：
  - IoT 相关控制器、服务与模型统一归属 IoT 模块（如 `IoTController`、`IoTService` 等）。
  - IoT 设备、网关、数据流等实体同样遵守多租户与软删除规则（实现 `IMultiTenant` / `ISoftDeletable` / `ITimestamped`）。
- **数据访问**：
  - 所有 IoT 相关 MongoDB 实体同样必须通过 `IDatabaseOperationFactory<T>` 访问。
  - 严格使用当前企业 `CompanyId` 进行隔离，禁止跨企业直接访问设备/数据。
- **权限与菜单**：
  - IoT 管理页面和 API 均应绑定对应的 IoT 菜单（如 `iot:device:list`），统一走菜单级权限模型。

> IoT 平台的详细设计、边界与最佳实践请参考：
> - `docs/features/IOT-PLATFORM-GUIDE.md`
> - `docs/features/IOT-QUICK-START.md`
> - `docs/features/IOT-IMPLEMENTATION-SUMMARY.md`
> - `docs/features/IOT-DOCUMENTATION-INDEX.md`

## 数据库操作指南

### 0. 数据库操作工厂统一定义

- **唯一入口**：所有 MongoDB 实体操作必须通过 `IDatabaseOperationFactory<T>` / `DatabaseOperationFactory<T>` 完成，禁止在服务中直接注入或使用 `IMongoCollection<T>`、`IMongoDatabase`
- **多租户与软删除内置**：`DatabaseOperationFactory<T>` 会自动附加当前企业 `CompanyId` 过滤（针对实现 `IMultiTenant` 的实体）以及 `IsDeleted = false` 软删除过滤，调用方无需手动追加
- **强制原子操作**：创建、更新、删除全部通过 `CreateAsync`、`FindOneAndUpdateAsync`、`FindOneAndSoftDeleteAsync` 等原子方法完成，避免先查后改的竞态条件
- **统一审计字段**：工厂自动维护 `CreatedAt`、`UpdatedAt`、`IsDeleted` 以及 `CreatedBy`、`UpdatedBy` 等审计字段，业务代码不要手动设置
- **跨租户操作**：仅在极少数需要跨企业运维/管理的场景下，才允许使用 `FindWithoutTenantFilterAsync`、`GetByIdWithoutTenantFilterAsync` 等 *WithoutTenantFilter* 方法，且必须有严格权限校验与审计

- FilterBuilder / SortBuilder / UpdateBuilder 统一由 `IDatabaseOperationFactory<T>` 提供，用于构建查询、排序与更新条件。

> 过滤、排序与更新构建器的具体用法示例，请参考 `docs/features/BACKEND-RULES.md`。

## 通用响应格式

### 1. 硬规则摘要

- **统一返回类型**：所有后端 API 必须返回 `ApiResponse<T>`（位于 `Platform.ServiceDefaults.Models`），禁止再使用旧的 `code` / `msg` 结构。
- **控制器基类**：所有 API 控制器必须继承 `BaseApiController`，通过其中的 `Success` / `SuccessPaged` / `Error` / `ValidationError` 等方法构造响应。
- **分页约定**：分页统一返回 `ApiResponse<PagedResult<T>>`，字段为 `list`、`total`、`page`、`pageSize`、`totalPages`。
- **错误码规范**：错误码需遵循统一约定（如 `VALIDATION_ERROR`、`NOT_FOUND`、`UNAUTHORIZED`、`FORBIDDEN`、`INTERNAL_ERROR`），禁止任意自定义返回格式。

> 统一响应模型、分页结构与 `BaseApiController` 的详细说明与示例，见 `docs/features/API-RESPONSE-RULES.md`。

## 安全最佳实践

### 1. 认证与授权
- 所有 API 端点需要 JWT 认证
- 使用 `[RequireMenu("menu-name")]` 进行权限检查
- 验证用户的企业归属

### 2. 数据验证
- 对所有输入进行验证
- 使用 DataAnnotations 进行声明式验证
- 在服务层进行业务逻辑验证

### 3. 审计日志
- 使用 `ActivityLogMiddleware` 记录所有请求
- 记录敏感操作（创建、更新、删除）
- 保留删除信息（DeletedAt, DeletedBy, DeletedReason）

### 4. 错误处理
- 不暴露内部错误信息
- 使用统一的错误响应格式
- 记录详细的错误日志

## 常见错误模式

- **错误 1：直接访问 MongoDB**：在业务代码中直接注入 `IMongoCollection<T>` 或 `IMongoDatabase`，绕过 `IDatabaseOperationFactory<T>`。
- **错误 2：硬编码企业ID**：使用固定字符串或从 JWT 读取 `companyId`，而不是通过 `ITenantContext.GetCurrentCompanyIdAsync()`。
- **错误 3：不进行权限检查**：对敏感操作（如删除、变更配置）未添加 `RequireMenu` 或等效权限校验。
- **错误 4：同步等待异步**：使用 `.Result` / `.Wait()` 阻塞异步调用，可能导致死锁或性能问题。
- **错误 5：不处理异常**：直接返回底层异常或未统一包装为 `ApiResponse<T>` 错误响应。

> 这些错误模式的详细代码示例和修复方式，请参考 `docs/features/BACKEND-RULES.md` 与 `docs/features/API-RESPONSE-RULES.md`。

## 相关文档链接

- [规则管理系统文档](docs/RULES.md)
- [MCP 集成指南](docs/features/RULES-MCP-INTEGRATION.md)
- [后端核心与中间件规范](docs/features/BACKEND-RULES.md)
- [统一 API 响应与控制器规范](docs/features/API-RESPONSE-RULES.md)
- [菜单级权限与角色模型规范](docs/features/MENU-LEVEL-PERMISSION-GUIDE.md)
- [前端开发规范（UmiJS & Ant Design Pro）](docs/features/FRONTEND-RULES.md)
- [IoT 平台文档索引](docs/features/IOT-DOCUMENTATION-INDEX.md)
- [快速开始指南](README.md)

## 更新日期

- **2024-12-03**: 创建完整的 Cursor Rules 文档
- **2024-12-04**: 补充数据库操作工厂、ApiResponse 统一响应格式及中间件/权限/前端规范拆分文档结构
