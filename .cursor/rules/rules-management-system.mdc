---
globs: Platform.ApiService/Controllers/RuleController.cs,Platform.ApiService/Services/RuleService.cs,Platform.ApiService/Models/RuleModels.cs
description: è§„åˆ™ç®¡ç†ç³»ç»Ÿå¼€å‘è§„èŒƒ
---

# è§„åˆ™ç®¡ç†ç³»ç»Ÿå¼€å‘è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

### è§„åˆ™ç®¡ç†ç³»ç»Ÿæ˜¯å¹³å°çš„æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼Œç”¨äºç®¡ç†ç³»ç»Ÿä¸­çš„å„ç±»è§„åˆ™ã€ç­–ç•¥å’Œé…ç½®ã€‚è§„åˆ™æ”¯æŒæƒé™æ§åˆ¶ã€ä¸šåŠ¡æµç¨‹ã€æ•°æ®éªŒè¯ç­‰å¤šä¸ªåœºæ™¯ï¼Œå¹¶ä¸ MCPï¼ˆModel Context Protocolï¼‰æ·±åº¦é›†æˆã€‚

> **ç›¸å…³æ–‡æ¡£**ï¼š
> - å®Œæ•´è§„åˆ™ç®¡ç†æ–‡æ¡£ï¼š[docs/RULES.md](mdc:docs/RULES.md)
> - MCP é›†æˆæŒ‡å—ï¼š[docs/features/RULES-MCP-INTEGRATION.md](mdc:docs/features/RULES-MCP-INTEGRATION.md)
> - åç«¯æ ¸å¿ƒå¼€å‘è§„èŒƒï¼š[core-backend-standards.mdc](mdc:.cursor/rules/core-backend-standards.mdc)
> - ä¸šåŠ¡é€»è¾‘è§„èŒƒï¼š[business-logic.mdc](mdc:.cursor/rules/business-logic.mdc)

## âœ… è§„åˆ™æ•°æ®æ¨¡å‹è§„èŒƒ

### è§„åˆ™åŸºæœ¬å±æ€§

```csharp
// Platform.ApiService/Models/RuleModels.cs

/// <summary>
/// è§„åˆ™åˆ—è¡¨é¡¹
/// </summary>
public class RuleListItem
{
    /// <summary>
    /// è§„åˆ™ ID
    /// </summary>
    public string Id { get; set; }

    /// <summary>
    /// è§„åˆ™åç§°ï¼ˆå¿…éœ€ï¼Œå”¯ä¸€ï¼‰
    /// </summary>
    public string Name { get; set; }

    /// <summary>
    /// è§„åˆ™æè¿°
    /// </summary>
    public string Desc { get; set; }

    /// <summary>
    /// è§„åˆ™æ‰€æœ‰è€…ï¼ˆç”¨æˆ· IDï¼‰
    /// </summary>
    public string Owner { get; set; }

    /// <summary>
    /// è§„åˆ™çŠ¶æ€ï¼š0=ç¦ç”¨, 1=å¯ç”¨, 2=è‰ç¨¿, 3=å·²è¿‡æœŸ
    /// </summary>
    public int Status { get; set; }

    /// <summary>
    /// è§„åˆ™æ ‡ç­¾ï¼Œç”¨äºåˆ†ç±»å’Œæœç´¢
    /// </summary>
    public List<string> Tags { get; set; } = new();

    /// <summary>
    /// è§„åˆ™ç‰ˆæœ¬å·ï¼ˆè‡ªåŠ¨é€’å¢ï¼‰
    /// </summary>
    public int Version { get; set; } = 1;

    /// <summary>
    /// MCP é…ç½®
    /// </summary>
    public McpRuleConfig? McpConfig { get; set; }

    /// <summary>
    /// åˆ›å»ºæ—¶é—´
    /// </summary>
    public DateTime CreatedAt { get; set; }

    /// <summary>
    /// æ›´æ–°æ—¶é—´
    /// </summary>
    public DateTime UpdatedAt { get; set; }
}

/// <summary>
/// è§„åˆ™è¯¦æƒ…
/// </summary>
public class RuleDetail
{
    /// <summary>
    /// è§„åˆ™ ID
    /// </summary>
    public string Id { get; set; }

    /// <summary>
    /// è§„åˆ™åç§°
    /// </summary>
    public string Name { get; set; }

    /// <summary>
    /// è§„åˆ™æè¿°
    /// </summary>
    public string Desc { get; set; }

    /// <summary>
    /// è§„åˆ™æ‰€æœ‰è€…
    /// </summary>
    public string Owner { get; set; }

    /// <summary>
    /// è§„åˆ™çŠ¶æ€
    /// </summary>
    public int Status { get; set; }

    /// <summary>
    /// è§„åˆ™å†…å®¹ï¼ˆJSON æ ¼å¼ï¼‰
    /// </summary>
    public Dictionary<string, object> Content { get; set; }

    /// <summary>
    /// è§„åˆ™æ ‡ç­¾
    /// </summary>
    public List<string> Tags { get; set; } = new();

    /// <summary>
    /// è§„åˆ™ç‰ˆæœ¬
    /// </summary>
    public int Version { get; set; }

    /// <summary>
    /// MCP é…ç½®
    /// </summary>
    public McpRuleConfig? McpConfig { get; set; }

    /// <summary>
    /// åˆ›å»ºæ—¶é—´
    /// </summary>
    public DateTime CreatedAt { get; set; }

    /// <summary>
    /// æ›´æ–°æ—¶é—´
    /// </summary>
    public DateTime UpdatedAt { get; set; }
}
```

### MCP è§„åˆ™é…ç½®

```csharp
/// <summary>
/// MCP è§„åˆ™é…ç½®
/// </summary>
public class McpRuleConfig
{
    /// <summary>
    /// æ˜¯å¦å¯ç”¨ MCP é›†æˆ
    /// </summary>
    public bool Enabled { get; set; } = false;

    /// <summary>
    /// MCP å·¥å…·åç§°ï¼ˆsnake_case æ ¼å¼ï¼‰
    /// </summary>
    public string? ToolName { get; set; }

    /// <summary>
    /// MCP å·¥å…·æè¿°
    /// </summary>
    public string? ToolDescription { get; set; }

    /// <summary>
    /// MCP å·¥å…·å‚æ•°æ¨¡å¼ï¼ˆJSON Schema æ ¼å¼ï¼‰
    /// </summary>
    public Dictionary<string, object>? InputSchema { get; set; }

    /// <summary>
    /// æ˜¯å¦ä¸º MCP èµ„æº
    /// </summary>
    public bool IsResource { get; set; } = false;

    /// <summary>
    /// MCP èµ„æº URIï¼ˆrule:// å‰ç¼€ï¼‰
    /// </summary>
    public string? ResourceUri { get; set; }

    /// <summary>
    /// MCP èµ„æº MIME ç±»å‹
    /// </summary>
    public string? ResourceMimeType { get; set; }

    /// <summary>
    /// æ˜¯å¦ä¸º MCP æç¤ºè¯
    /// </summary>
    public bool IsPrompt { get; set; } = false;

    /// <summary>
    /// MCP æç¤ºè¯å‚æ•°å®šä¹‰ï¼ˆJSON Schema æ ¼å¼ï¼‰
    /// </summary>
    public Dictionary<string, object>? PromptArguments { get; set; }

    /// <summary>
    /// MCP æç¤ºè¯å†…å®¹æ¨¡æ¿
    /// </summary>
    public string? PromptTemplate { get; set; }

    /// <summary>
    /// åˆ›å»ºæ—¶é—´
    /// </summary>
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;

    /// <summary>
    /// æ›´æ–°æ—¶é—´
    /// </summary>
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
}
```

## âœ… è§„åˆ™æœåŠ¡å±‚è§„èŒƒ

### è§„åˆ™æœåŠ¡æ¥å£

```csharp
// Platform.ApiService/Services/IRuleService.cs

public interface IRuleService
{
    // è§„åˆ™ CRUD æ“ä½œ
    Task<RuleDetail> CreateRuleAsync(CreateRuleRequest request);
    Task<RuleDetail?> GetRuleByIdAsync(string id);
    Task<PagedResult<RuleListItem>> GetRulesAsync(RuleListRequest request);
    Task<bool> UpdateRuleAsync(UpdateRuleRequest request);
    Task<bool> DeleteRuleAsync(string id);
    Task<int> DeleteRulesAsync(List<string> ids);

    // è§„åˆ™æœç´¢å’Œè¿‡æ»¤
    Task<List<RuleListItem>> SearchRulesByNameAsync(string name);
    Task<List<RuleListItem>> GetRulesByTagsAsync(List<string> tags);
    Task<List<RuleListItem>> GetRulesByOwnerAsync(string owner);
    Task<List<RuleListItem>> GetRulesByStatusAsync(int status);

    // MCP ç›¸å…³æ“ä½œ
    Task<List<RuleMcpToolResponse>> GetMcpToolsAsync();
    Task<List<RuleMcpResourceResponse>> GetMcpResourcesAsync();
    Task<List<RuleMcpPromptResponse>> GetMcpPromptsAsync();
    Task<RuleMcpToolResponse?> GetMcpToolByNameAsync(string toolName);
    Task<RuleMcpResourceResponse?> GetMcpResourceByUriAsync(string uri);
}
```

### è§„åˆ™æœåŠ¡å®ç°è§„èŒƒ

```csharp
// Platform.ApiService/Services/RuleService.cs

public class RuleService : IRuleService
{
    private readonly IDatabaseOperationFactory<RuleListItem> _ruleFactory;
    private readonly IUniquenessChecker _uniquenessChecker;
    private readonly IFieldValidationService _validationService;

    public RuleService(
        IDatabaseOperationFactory<RuleListItem> ruleFactory,
        IUniquenessChecker uniquenessChecker,
        IFieldValidationService validationService)
    {
        _ruleFactory = ruleFactory;
        _uniquenessChecker = uniquenessChecker;
        _validationService = validationService;
    }

    /// <summary>
    /// åˆ›å»ºè§„åˆ™
    /// </summary>
    public async Task<RuleDetail> CreateRuleAsync(CreateRuleRequest request)
    {
        // 1. ä¸šåŠ¡éªŒè¯
        await ValidateCreateRuleRequestAsync(request);

        // 2. æ£€æŸ¥è§„åˆ™åç§°å”¯ä¸€æ€§
        var exists = await _uniquenessChecker.CheckAsync(
            nameof(RuleListItem),
            nameof(RuleListItem.Name),
            request.Name);
        if (exists)
            throw new BusinessException($"è§„åˆ™åç§° '{request.Name}' å·²å­˜åœ¨");

        // 3. éªŒè¯ MCP é…ç½®ï¼ˆå¦‚æœæä¾›ï¼‰
        if (request.McpConfig?.Enabled == true)
        {
            ValidateMcpConfig(request.McpConfig);
        }

        // 4. åˆ›å»ºè§„åˆ™å¯¹è±¡
        var rule = new RuleListItem
        {
            Name = request.Name,
            Desc = request.Desc,
            Owner = request.Owner,
            Status = request.Status,
            Tags = request.Tags ?? new(),
            Content = request.Content,
            McpConfig = request.McpConfig,
            Version = 1
        };

        // 5. ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆå®¡è®¡å­—æ®µè‡ªåŠ¨å¡«å……ï¼‰
        var result = await _ruleFactory.CreateAsync(rule);
        
        return MapToRuleDetail(result);
    }

    /// <summary>
    /// æ›´æ–°è§„åˆ™
    /// </summary>
    public async Task<bool> UpdateRuleAsync(UpdateRuleRequest request)
    {
        // 1. è·å–ç°æœ‰è§„åˆ™
        var rule = await _ruleFactory.GetByIdAsync(request.Key);
        if (rule == null)
            throw new BusinessException($"è§„åˆ™ ID '{request.Key}' ä¸å­˜åœ¨");

        // 2. ä¸šåŠ¡éªŒè¯
        await ValidateUpdateRuleRequestAsync(request, rule);

        // 3. å¦‚æœä¿®æ”¹åç§°ï¼Œæ£€æŸ¥å”¯ä¸€æ€§
        if (!string.IsNullOrEmpty(request.Name) && request.Name != rule.Name)
        {
            var exists = await _uniquenessChecker.CheckAsync(
                nameof(RuleListItem),
                nameof(RuleListItem.Name),
                request.Name);
            if (exists)
                throw new BusinessException($"è§„åˆ™åç§° '{request.Name}' å·²å­˜åœ¨");
        }

        // 4. éªŒè¯ MCP é…ç½®ï¼ˆå¦‚æœæä¾›ï¼‰
        if (request.McpConfig?.Enabled == true)
        {
            ValidateMcpConfig(request.McpConfig);
        }

        // 5. æ›´æ–°è§„åˆ™å­—æ®µ
        if (!string.IsNullOrEmpty(request.Name))
            rule.Name = request.Name;
        if (!string.IsNullOrEmpty(request.Desc))
            rule.Desc = request.Desc;
        if (request.Status.HasValue)
            rule.Status = request.Status.Value;
        if (request.Content != null)
            rule.Content = request.Content;
        if (request.Tags != null)
            rule.Tags = request.Tags;
        if (request.McpConfig != null)
            rule.McpConfig = request.McpConfig;

        // 6. é€’å¢ç‰ˆæœ¬å·
        rule.Version++;

        // 7. ä¿å­˜æ›´æ–°ï¼ˆå®¡è®¡å­—æ®µè‡ªåŠ¨å¡«å……ï¼‰
        return await _ruleFactory.UpdateAsync(rule);
    }

    /// <summary>
    /// è·å–è§„åˆ™åˆ—è¡¨
    /// </summary>
    public async Task<PagedResult<RuleListItem>> GetRulesAsync(RuleListRequest request)
    {
        var query = _ruleFactory.GetQueryable();

        // æŒ‰åç§°è¿‡æ»¤
        if (!string.IsNullOrEmpty(request.Name))
            query = query.Where(r => r.Name.Contains(request.Name));

        // æŒ‰çŠ¶æ€è¿‡æ»¤
        if (request.Status.HasValue)
            query = query.Where(r => r.Status == request.Status.Value);

        // æŒ‰æ ‡ç­¾è¿‡æ»¤
        if (request.Tags?.Any() == true)
            query = query.Where(r => r.Tags.Any(t => request.Tags.Contains(t)));

        // æŒ‰æ‰€æœ‰è€…è¿‡æ»¤
        if (!string.IsNullOrEmpty(request.Owner))
            query = query.Where(r => r.Owner == request.Owner);

        // æ’åº
        query = query.OrderByDescending(r => r.UpdatedAt);

        // åˆ†é¡µ
        var total = await query.CountAsync();
        var items = await query
            .Skip((request.PageNum - 1) * request.PageSize)
            .Take(request.PageSize)
            .ToListAsync();

        return new PagedResult<RuleListItem>
        {
            Total = total,
            List = items
        };
    }

    /// <summary>
    /// è·å– MCP å·¥å…·åˆ—è¡¨
    /// </summary>
    public async Task<List<RuleMcpToolResponse>> GetMcpToolsAsync()
    {
        var rules = await _ruleFactory.GetQueryable()
            .Where(r => r.Status == 1 && r.McpConfig != null && r.McpConfig.Enabled && !r.McpConfig.IsResource && !r.McpConfig.IsPrompt)
            .ToListAsync();

        return rules.Select(r => new RuleMcpToolResponse
        {
            Name = r.McpConfig.ToolName,
            Description = r.McpConfig.ToolDescription,
            InputSchema = r.McpConfig.InputSchema,
            RuleId = r.Id,
            RuleName = r.Name
        }).ToList();
    }

    /// <summary>
    /// è·å– MCP èµ„æºåˆ—è¡¨
    /// </summary>
    public async Task<List<RuleMcpResourceResponse>> GetMcpResourcesAsync()
    {
        var rules = await _ruleFactory.GetQueryable()
            .Where(r => r.Status == 1 && r.McpConfig != null && r.McpConfig.Enabled && r.McpConfig.IsResource)
            .ToListAsync();

        return rules.Select(r => new RuleMcpResourceResponse
        {
            Uri = r.McpConfig.ResourceUri,
            Name = r.Name,
            Description = r.Desc,
            MimeType = r.McpConfig.ResourceMimeType,
            RuleId = r.Id
        }).ToList();
    }

    /// <summary>
    /// è·å– MCP æç¤ºè¯åˆ—è¡¨
    /// </summary>
    public async Task<List<RuleMcpPromptResponse>> GetMcpPromptsAsync()
    {
        var rules = await _ruleFactory.GetQueryable()
            .Where(r => r.Status == 1 && r.McpConfig != null && r.McpConfig.Enabled && r.McpConfig.IsPrompt)
            .ToListAsync();

        return rules.Select(r => new RuleMcpPromptResponse
        {
            Name = r.Name,
            Description = r.Desc,
            Arguments = r.McpConfig.PromptArguments,
            Template = r.McpConfig.PromptTemplate,
            RuleId = r.Id
        }).ToList();
    }

    // ç§æœ‰éªŒè¯æ–¹æ³•
    private async Task ValidateCreateRuleRequestAsync(CreateRuleRequest request)
    {
        if (string.IsNullOrWhiteSpace(request.Name))
            throw new ValidationException("è§„åˆ™åç§°ä¸èƒ½ä¸ºç©º");

        if (string.IsNullOrWhiteSpace(request.Owner))
            throw new ValidationException("è§„åˆ™æ‰€æœ‰è€…ä¸èƒ½ä¸ºç©º");

        if (request.Content == null || request.Content.Count == 0)
            throw new ValidationException("è§„åˆ™å†…å®¹ä¸èƒ½ä¸ºç©º");

        if (request.Name.Length > 100)
            throw new ValidationException("è§„åˆ™åç§°ä¸èƒ½è¶…è¿‡ 100 ä¸ªå­—ç¬¦");

        if (request.Desc?.Length > 500)
            throw new ValidationException("è§„åˆ™æè¿°ä¸èƒ½è¶…è¿‡ 500 ä¸ªå­—ç¬¦");
    }

    private async Task ValidateUpdateRuleRequestAsync(UpdateRuleRequest request, RuleListItem existingRule)
    {
        if (!string.IsNullOrWhiteSpace(request.Name) && request.Name.Length > 100)
            throw new ValidationException("è§„åˆ™åç§°ä¸èƒ½è¶…è¿‡ 100 ä¸ªå­—ç¬¦");

        if (!string.IsNullOrWhiteSpace(request.Desc) && request.Desc.Length > 500)
            throw new ValidationException("è§„åˆ™æè¿°ä¸èƒ½è¶…è¿‡ 500 ä¸ªå­—ç¬¦");
    }

    private void ValidateMcpConfig(McpRuleConfig config)
    {
        // éªŒè¯å·¥å…·é…ç½®
        if (!config.IsResource && !config.IsPrompt)
        {
            if (string.IsNullOrWhiteSpace(config.ToolName))
                throw new ValidationException("MCP å·¥å…·åç§°ä¸èƒ½ä¸ºç©º");

            if (config.ToolName.Length > 50)
                throw new ValidationException("MCP å·¥å…·åç§°ä¸èƒ½è¶…è¿‡ 50 ä¸ªå­—ç¬¦");

            // å·¥å…·åç§°åº”ä½¿ç”¨ snake_case
            if (!System.Text.RegularExpressions.Regex.IsMatch(config.ToolName, @"^[a-z_][a-z0-9_]*$"))
                throw new ValidationException("MCP å·¥å…·åç§°åº”ä½¿ç”¨ snake_case æ ¼å¼");

            if (config.InputSchema == null)
                throw new ValidationException("MCP å·¥å…·å‚æ•°æ¨¡å¼ä¸èƒ½ä¸ºç©º");
        }

        // éªŒè¯èµ„æºé…ç½®
        if (config.IsResource)
        {
            if (string.IsNullOrWhiteSpace(config.ResourceUri))
                throw new ValidationException("MCP èµ„æº URI ä¸èƒ½ä¸ºç©º");

            if (!config.ResourceUri.StartsWith("rule://"))
                throw new ValidationException("MCP èµ„æº URI åº”ä»¥ 'rule://' å¼€å¤´");
        }

        // éªŒè¯æç¤ºè¯é…ç½®
        if (config.IsPrompt)
        {
            if (string.IsNullOrWhiteSpace(config.PromptTemplate))
                throw new ValidationException("MCP æç¤ºè¯æ¨¡æ¿ä¸èƒ½ä¸ºç©º");

            if (config.PromptTemplate.Length > 2000)
                throw new ValidationException("MCP æç¤ºè¯æ¨¡æ¿ä¸èƒ½è¶…è¿‡ 2000 ä¸ªå­—ç¬¦");
        }
    }

    private RuleDetail MapToRuleDetail(RuleListItem rule)
    {
        return new RuleDetail
        {
            Id = rule.Id,
            Name = rule.Name,
            Desc = rule.Desc,
            Owner = rule.Owner,
            Status = rule.Status,
            Content = rule.Content,
            Tags = rule.Tags,
            Version = rule.Version,
            McpConfig = rule.McpConfig,
            CreatedAt = rule.CreatedAt,
            UpdatedAt = rule.UpdatedAt
        };
    }
}
```

## âœ… è§„åˆ™æ§åˆ¶å™¨è§„èŒƒ

### è§„åˆ™ API ç«¯ç‚¹

```csharp
// Platform.ApiService/Controllers/RuleController.cs

[ApiController]
[Route("api/[controller]")]
[Authorize]
public class RuleController : BaseApiController
{
    private readonly IRuleService _ruleService;

    public RuleController(IRuleService ruleService)
    {
        _ruleService = ruleService;
    }

    /// <summary>
    /// è·å–è§„åˆ™åˆ—è¡¨
    /// </summary>
    [HttpGet]
    [ProducesResponseType(typeof(ApiResponse<PagedResult<RuleListItem>>), StatusCodes.Status200OK)]
    public async Task<IActionResult> GetRules([FromQuery] RuleListRequest request)
    {
        var result = await _ruleService.GetRulesAsync(request);
        return Success(result);
    }

    /// <summary>
    /// è·å–è§„åˆ™è¯¦æƒ…
    /// </summary>
    [HttpGet("{id}")]
    [ProducesResponseType(typeof(ApiResponse<RuleDetail>), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(ProblemDetails), StatusCodes.Status404NotFound)]
    public async Task<IActionResult> GetRule(string id)
    {
        var result = await _ruleService.GetRuleByIdAsync(id);
        if (result == null)
            return NotFound(new ProblemDetails { Title = "è§„åˆ™ä¸å­˜åœ¨" });

        return Success(result);
    }

    /// <summary>
    /// åˆ›å»ºè§„åˆ™
    /// </summary>
    [HttpPost]
    [ProducesResponseType(typeof(ApiResponse<RuleDetail>), StatusCodes.Status201Created)]
    [ProducesResponseType(typeof(ProblemDetails), StatusCodes.Status400BadRequest)]
    public async Task<IActionResult> CreateRule([FromBody] CreateRuleRequest request)
    {
        var result = await _ruleService.CreateRuleAsync(request);
        return CreatedAtAction(nameof(GetRule), new { id = result.Id }, result);
    }

    /// <summary>
    /// æ›´æ–°è§„åˆ™
    /// </summary>
    [HttpPut]
    [ProducesResponseType(typeof(ApiResponse<object>), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(ProblemDetails), StatusCodes.Status400BadRequest)]
    public async Task<IActionResult> UpdateRule([FromBody] UpdateRuleRequest request)
    {
        var result = await _ruleService.UpdateRuleAsync(request);
        return Success(new { success = result });
    }

    /// <summary>
    /// åˆ é™¤è§„åˆ™
    /// </summary>
    [HttpDelete("{id}")]
    [ProducesResponseType(typeof(ApiResponse<object>), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(ProblemDetails), StatusCodes.Status404NotFound)]
    public async Task<IActionResult> DeleteRule(string id)
    {
        var result = await _ruleService.DeleteRuleAsync(id);
        if (!result)
            return NotFound(new ProblemDetails { Title = "è§„åˆ™ä¸å­˜åœ¨" });

        return Success(new { success = true });
    }

    /// <summary>
    /// æ‰¹é‡åˆ é™¤è§„åˆ™
    /// </summary>
    [HttpPost("delete")]
    [ProducesResponseType(typeof(ApiResponse<object>), StatusCodes.Status200OK)]
    public async Task<IActionResult> DeleteRules([FromBody] DeleteRulesRequest request)
    {
        var count = await _ruleService.DeleteRulesAsync(request.Keys);
        return Success(new { deletedCount = count });
    }

    /// <summary>
    /// è·å– MCP å·¥å…·åˆ—è¡¨
    /// </summary>
    [HttpGet("mcp/tools")]
    [ProducesResponseType(typeof(ApiResponse<List<RuleMcpToolResponse>>), StatusCodes.Status200OK)]
    public async Task<IActionResult> GetMcpTools()
    {
        var result = await _ruleService.GetMcpToolsAsync();
        return Success(result);
    }

    /// <summary>
    /// è·å– MCP èµ„æºåˆ—è¡¨
    /// </summary>
    [HttpGet("mcp/resources")]
    [ProducesResponseType(typeof(ApiResponse<List<RuleMcpResourceResponse>>), StatusCodes.Status200OK)]
    public async Task<IActionResult> GetMcpResources()
    {
        var result = await _ruleService.GetMcpResourcesAsync();
        return Success(result);
    }

    /// <summary>
    /// è·å– MCP æç¤ºè¯åˆ—è¡¨
    /// </summary>
    [HttpGet("mcp/prompts")]
    [ProducesResponseType(typeof(ApiResponse<List<RuleMcpPromptResponse>>), StatusCodes.Status200OK)]
    public async Task<IActionResult> GetMcpPrompts()
    {
        var result = await _ruleService.GetMcpPromptsAsync();
        return Success(result);
    }
}
```

## âœ… è§„åˆ™è¯·æ±‚/å“åº”æ¨¡å‹è§„èŒƒ

### è¯·æ±‚æ¨¡å‹

```csharp
/// <summary>
/// åˆ›å»ºè§„åˆ™è¯·æ±‚
/// </summary>
public class CreateRuleRequest
{
    /// <summary>
    /// è§„åˆ™åç§°ï¼ˆå¿…éœ€ï¼‰
    /// </summary>
    [Required(ErrorMessage = "è§„åˆ™åç§°ä¸èƒ½ä¸ºç©º")]
    [StringLength(100, ErrorMessage = "è§„åˆ™åç§°ä¸èƒ½è¶…è¿‡ 100 ä¸ªå­—ç¬¦")]
    public string Name { get; set; }

    /// <summary>
    /// è§„åˆ™æè¿°
    /// </summary>
    [StringLength(500, ErrorMessage = "è§„åˆ™æè¿°ä¸èƒ½è¶…è¿‡ 500 ä¸ªå­—ç¬¦")]
    public string? Desc { get; set; }

    /// <summary>
    /// è§„åˆ™æ‰€æœ‰è€…ï¼ˆå¿…éœ€ï¼‰
    /// </summary>
    [Required(ErrorMessage = "è§„åˆ™æ‰€æœ‰è€…ä¸èƒ½ä¸ºç©º")]
    public string Owner { get; set; }

    /// <summary>
    /// è§„åˆ™çŠ¶æ€ï¼ˆé»˜è®¤ 1=å¯ç”¨ï¼‰
    /// </summary>
    public int Status { get; set; } = 1;

    /// <summary>
    /// è§„åˆ™å†…å®¹ï¼ˆå¿…éœ€ï¼ŒJSON æ ¼å¼ï¼‰
    /// </summary>
    [Required(ErrorMessage = "è§„åˆ™å†…å®¹ä¸èƒ½ä¸ºç©º")]
    public Dictionary<string, object> Content { get; set; }

    /// <summary>
    /// è§„åˆ™æ ‡ç­¾
    /// </summary>
    public List<string>? Tags { get; set; }

    /// <summary>
    /// MCP é…ç½®
    /// </summary>
    public McpRuleConfig? McpConfig { get; set; }
}

/// <summary>
/// æ›´æ–°è§„åˆ™è¯·æ±‚
/// </summary>
public class UpdateRuleRequest
{
    /// <summary>
    /// è§„åˆ™ IDï¼ˆå¿…éœ€ï¼‰
    /// </summary>
    [Required(ErrorMessage = "è§„åˆ™ ID ä¸èƒ½ä¸ºç©º")]
    public string Key { get; set; }

    /// <summary>
    /// è§„åˆ™åç§°
    /// </summary>
    [StringLength(100, ErrorMessage = "è§„åˆ™åç§°ä¸èƒ½è¶…è¿‡ 100 ä¸ªå­—ç¬¦")]
    public string? Name { get; set; }

    /// <summary>
    /// è§„åˆ™æè¿°
    /// </summary>
    [StringLength(500, ErrorMessage = "è§„åˆ™æè¿°ä¸èƒ½è¶…è¿‡ 500 ä¸ªå­—ç¬¦")]
    public string? Desc { get; set; }

    /// <summary>
    /// è§„åˆ™çŠ¶æ€
    /// </summary>
    public int? Status { get; set; }

    /// <summary>
    /// è§„åˆ™å†…å®¹
    /// </summary>
    public Dictionary<string, object>? Content { get; set; }

    /// <summary>
    /// è§„åˆ™æ ‡ç­¾
    /// </summary>
    public List<string>? Tags { get; set; }

    /// <summary>
    /// MCP é…ç½®
    /// </summary>
    public McpRuleConfig? McpConfig { get; set; }
}

/// <summary>
/// è§„åˆ™åˆ—è¡¨æŸ¥è¯¢è¯·æ±‚
/// </summary>
public class RuleListRequest : PaginationRequest
{
    /// <summary>
    /// è§„åˆ™åç§°ï¼ˆæ¨¡ç³Šæœç´¢ï¼‰
    /// </summary>
    public string? Name { get; set; }

    /// <summary>
    /// è§„åˆ™çŠ¶æ€
    /// </summary>
    public int? Status { get; set; }

    /// <summary>
    /// è§„åˆ™æ ‡ç­¾
    /// </summary>
    public List<string>? Tags { get; set; }

    /// <summary>
    /// è§„åˆ™æ‰€æœ‰è€…
    /// </summary>
    public string? Owner { get; set; }
}

/// <summary>
/// æ‰¹é‡åˆ é™¤è§„åˆ™è¯·æ±‚
/// </summary>
public class DeleteRulesRequest
{
    /// <summary>
    /// è§„åˆ™ ID åˆ—è¡¨
    /// </summary>
    [Required(ErrorMessage = "è§„åˆ™ ID åˆ—è¡¨ä¸èƒ½ä¸ºç©º")]
    public List<string> Keys { get; set; }
}
```

### å“åº”æ¨¡å‹

```csharp
/// <summary>
/// MCP å·¥å…·å“åº”
/// </summary>
public class RuleMcpToolResponse
{
    /// <summary>
    /// å·¥å…·åç§°
    /// </summary>
    public string Name { get; set; }

    /// <summary>
    /// å·¥å…·æè¿°
    /// </summary>
    public string Description { get; set; }

    /// <summary>
    /// å·¥å…·å‚æ•°æ¨¡å¼
    /// </summary>
    public Dictionary<string, object>? InputSchema { get; set; }

    /// <summary>
    /// è§„åˆ™ ID
    /// </summary>
    public string RuleId { get; set; }

    /// <summary>
    /// è§„åˆ™åç§°
    /// </summary>
    public string RuleName { get; set; }
}

/// <summary>
/// MCP èµ„æºå“åº”
/// </summary>
public class RuleMcpResourceResponse
{
    /// <summary>
    /// èµ„æº URI
    /// </summary>
    public string Uri { get; set; }

    /// <summary>
    /// èµ„æºåç§°
    /// </summary>
    public string Name { get; set; }

    /// <summary>
    /// èµ„æºæè¿°
    /// </summary>
    public string? Description { get; set; }

    /// <summary>
    /// MIME ç±»å‹
    /// </summary>
    public string? MimeType { get; set; }

    /// <summary>
    /// è§„åˆ™ ID
    /// </summary>
    public string RuleId { get; set; }
}

/// <summary>
/// MCP æç¤ºè¯å“åº”
/// </summary>
public class RuleMcpPromptResponse
{
    /// <summary>
    /// æç¤ºè¯åç§°
    /// </summary>
    public string Name { get; set; }

    /// <summary>
    /// æç¤ºè¯æè¿°
    /// </summary>
    public string? Description { get; set; }

    /// <summary>
    /// æç¤ºè¯å‚æ•°å®šä¹‰
    /// </summary>
    public Dictionary<string, object>? Arguments { get; set; }

    /// <summary>
    /// æç¤ºè¯æ¨¡æ¿
    /// </summary>
    public string? Template { get; set; }

    /// <summary>
    /// è§„åˆ™ ID
    /// </summary>
    public string RuleId { get; set; }
}
```

## âŒ ç¦æ­¢äº‹é¡¹

### è§„åˆ™ç®¡ç†ä¸­çš„å¸¸è§é”™è¯¯

1. **ä¸è¦ç›´æ¥ä¿®æ”¹è§„åˆ™å†…å®¹è€Œä¸é€’å¢ç‰ˆæœ¬å·**
   ```csharp
   // âŒ é”™è¯¯ï¼šä¿®æ”¹å†…å®¹ä½†ç‰ˆæœ¬å·ä¸å˜
   rule.Content = newContent;
   await _ruleFactory.UpdateAsync(rule);

   // âœ… æ­£ç¡®ï¼šä¿®æ”¹å†…å®¹å¹¶é€’å¢ç‰ˆæœ¬å·
   rule.Content = newContent;
   rule.Version++;
   await _ruleFactory.UpdateAsync(rule);
   ```

2. **ä¸è¦åœ¨ MCP å·¥å…·åç§°ä¸­ä½¿ç”¨å¤§å†™å­—æ¯æˆ–ç‰¹æ®Šå­—ç¬¦**
   ```csharp
   // âŒ é”™è¯¯ï¼šä½¿ç”¨å¤§å†™å­—æ¯å’Œç‰¹æ®Šå­—ç¬¦
   mcpConfig.ToolName = "QueryUser-Info";

   // âœ… æ­£ç¡®ï¼šä½¿ç”¨ snake_case
   mcpConfig.ToolName = "query_user_info";
   ```

3. **ä¸è¦åˆ›å»ºé‡åè§„åˆ™**
   ```csharp
   // âŒ é”™è¯¯ï¼šæ²¡æœ‰æ£€æŸ¥è§„åˆ™åç§°å”¯ä¸€æ€§
   var rule = new RuleListItem { Name = request.Name };
   await _ruleFactory.CreateAsync(rule);

   // âœ… æ­£ç¡®ï¼šåˆ›å»ºå‰æ£€æŸ¥å”¯ä¸€æ€§
   var exists = await _uniquenessChecker.CheckAsync(
       nameof(RuleListItem),
       nameof(RuleListItem.Name),
       request.Name);
   if (exists)
       throw new BusinessException($"è§„åˆ™åç§° '{request.Name}' å·²å­˜åœ¨");
   ```

4. **ä¸è¦åœ¨è§„åˆ™å†…å®¹ä¸­å­˜å‚¨æ•æ„Ÿä¿¡æ¯**
   ```csharp
   // âŒ é”™è¯¯ï¼šåœ¨è§„åˆ™å†…å®¹ä¸­å­˜å‚¨å¯†ç æˆ– API å¯†é’¥
   rule.Content = new Dictionary<string, object>
   {
       { "apiKey", "secret-key-12345" },
       { "password", "admin123" }
   };

   // âœ… æ­£ç¡®ï¼šæ•æ„Ÿä¿¡æ¯åº”å­˜å‚¨åœ¨é…ç½®æˆ–å¯†é’¥ç®¡ç†ç³»ç»Ÿä¸­
   rule.Content = new Dictionary<string, object>
   {
       { "apiEndpoint", "https://api.example.com" },
       { "timeout", 30000 }
   };
   ```

5. **ä¸è¦è·³è¿‡ MCP é…ç½®éªŒè¯**
   ```csharp
   // âŒ é”™è¯¯ï¼šç›´æ¥ä¿å­˜ MCP é…ç½®è€Œä¸éªŒè¯
   rule.McpConfig = request.McpConfig;
   await _ruleFactory.UpdateAsync(rule);

   // âœ… æ­£ç¡®ï¼šéªŒè¯ MCP é…ç½®åå†ä¿å­˜
   if (request.McpConfig?.Enabled == true)
   {
       ValidateMcpConfig(request.McpConfig);
   }
   rule.McpConfig = request.McpConfig;
   await _ruleFactory.UpdateAsync(rule);
   ```

## ğŸ“‹ è§„åˆ™ç±»å‹ç¤ºä¾‹

### æƒé™è§„åˆ™

```json
{
  "name": "ç”¨æˆ·ç®¡ç†æƒé™è§„åˆ™",
  "desc": "å®šä¹‰ç”¨æˆ·ç®¡ç†æ¨¡å—çš„æƒé™",
  "owner": "admin",
  "status": 1,
  "content": {
    "resources": ["user:view", "user:create", "user:update", "user:delete"],
    "roles": ["admin", "manager"],
    "conditions": {
      "department": "HR"
    }
  },
  "tags": ["permission", "user"]
}
```

### ä¸šåŠ¡æµç¨‹è§„åˆ™

```json
{
  "name": "è¯·å‡å®¡æ‰¹æµç¨‹",
  "desc": "å®šä¹‰è¯·å‡ç”³è¯·çš„å®¡æ‰¹æµç¨‹",
  "owner": "admin",
  "status": 1,
  "content": {
    "steps": [
      {
        "id": "submit",
        "name": "æäº¤ç”³è¯·",
        "actor": "employee"
      },
      {
        "id": "review",
        "name": "éƒ¨é—¨ç»ç†å®¡æ‰¹",
        "actor": "manager",
        "condition": "amount > 1000"
      },
      {
        "id": "approve",
        "name": "HR å®¡æ‰¹",
        "actor": "hr"
      }
    ]
  },
  "tags": ["workflow", "leave"]
}
```

### MCP å·¥å…·è§„åˆ™

```json
{
  "name": "æŸ¥è¯¢ç”¨æˆ·è§„åˆ™",
  "desc": "ç”¨äºæŸ¥è¯¢ç³»ç»Ÿä¸­çš„ç”¨æˆ·ä¿¡æ¯",
  "owner": "admin",
  "status": 1,
  "mcpConfig": {
    "enabled": true,
    "toolName": "query_user",
    "toolDescription": "æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯",
    "inputSchema": {
      "type": "object",
      "properties": {
        "userId": {
          "type": "string",
          "description": "ç”¨æˆ·ID"
        }
      },
      "required": ["userId"]
    }
  },
  "tags": ["mcp", "tool"]
}
```

## ğŸ“š å‚è€ƒèµ„æº

- [è§„åˆ™ç®¡ç†å®Œæ•´æ–‡æ¡£](mdc:docs/RULES.md)
- [MCP é›†æˆæŒ‡å—](mdc:docs/features/RULES-MCP-INTEGRATION.md)
- [åç«¯æ ¸å¿ƒå¼€å‘è§„èŒƒ](mdc:.cursor/rules/core-backend-standards.mdc)
- [ä¸šåŠ¡é€»è¾‘è§„èŒƒ](mdc:.cursor/rules/business-logic.mdc)
- [æ‰©å±•æ–¹æ³•ä½¿ç”¨è§„èŒƒ](mdc:.cursor/rules/extension-methods-usage.mdc)

---

**æœ€åæ›´æ–°**ï¼š2025-12-03
