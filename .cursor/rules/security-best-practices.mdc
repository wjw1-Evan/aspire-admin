---
globs: Platform.ApiService/Services/*.cs,Platform.ServiceDefaults/Services/*.cs
description: å®‰å…¨æœ€ä½³å®è·µå’Œæ¼æ´é˜²æŠ¤è§„èŒƒ
---
# å®‰å…¨æœ€ä½³å®è·µå’Œæ¼æ´é˜²æŠ¤è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

### é€šè¿‡å®‰å…¨ç¼–ç¨‹å®è·µå’Œæ¼æ´é˜²æŠ¤ç¡®ä¿ç³»ç»Ÿå®‰å…¨ï¼Œä¿æŠ¤ç”¨æˆ·æ•°æ®å’Œç³»ç»Ÿèµ„æº

## âœ… è¾“å…¥éªŒè¯å’Œè¿‡æ»¤

### å‚æ•°éªŒè¯

```csharp
// âœ… æ­£ç¡® - å®Œæ•´çš„å‚æ•°éªŒè¯
public class UserService : IUserService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    private readonly IFieldValidationService _validationService;

    public UserService(
        IDatabaseOperationFactory<User> userFactory,
        IFieldValidationService validationService)
    {
        _userFactory = userFactory;
        _validationService = validationService;
    }

    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // 1. å‚æ•°éªŒè¯
        if (request == null)
            throw new ArgumentNullException(nameof(request));

        // 2. ä¸šåŠ¡éªŒè¯
        await ValidateCreateUserRequestAsync(request);
        
        // 3. åˆ›å»ºç”¨æˆ·å®ä½“
        var user = new User
        {
            Username = request.Username.Trim(), // å»é™¤ç©ºæ ¼
            Email = request.Email.Trim().ToLowerInvariant(), // æ ‡å‡†åŒ–é‚®ç®±
            CompanyId = _userFactory.GetRequiredCompanyId(),
            CreatedBy = _userFactory.GetCurrentUserId(),
            CreatedAt = DateTime.UtcNow
        };
        
        return await _userFactory.CreateAsync(user);
    }

    private async Task ValidateCreateUserRequestAsync(CreateUserRequest request)
    {
        // 1. ç”¨æˆ·åéªŒè¯
        if (string.IsNullOrWhiteSpace(request.Username))
            throw new ArgumentException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º", nameof(request.Username));

        if (request.Username.Length < 3 || request.Username.Length > 50)
            throw new ArgumentException("ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¸ªå­—ç¬¦ä¹‹é—´", nameof(request.Username));

        if (!IsValidUsername(request.Username))
            throw new ArgumentException("ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿", nameof(request.Username));

        // 2. é‚®ç®±éªŒè¯
        if (string.IsNullOrWhiteSpace(request.Email))
            throw new ArgumentException("é‚®ç®±ä¸èƒ½ä¸ºç©º", nameof(request.Email));

        if (!IsValidEmail(request.Email))
            throw new ArgumentException("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®", nameof(request.Email));

        // 3. å¯†ç éªŒè¯
        if (string.IsNullOrWhiteSpace(request.Password))
            throw new ArgumentException("å¯†ç ä¸èƒ½ä¸ºç©º", nameof(request.Password));

        if (!IsStrongPassword(request.Password))
            throw new ArgumentException("å¯†ç å¿…é¡»åŒ…å«å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦ï¼Œé•¿åº¦è‡³å°‘8ä½", nameof(request.Password));

        // 4. ä½¿ç”¨éªŒè¯æœåŠ¡
        await _validationService.ValidateUserAsync(request);
    }

    private bool IsValidUsername(string username)
    {
        // åªå…è®¸å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿
        return username.All(c => char.IsLetterOrDigit(c) || c == '_');
    }

    private bool IsValidEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }

    private bool IsStrongPassword(string password)
    {
        if (string.IsNullOrEmpty(password) || password.Length < 8)
            return false;

        var hasLetter = password.Any(char.IsLetter);
        var hasDigit = password.Any(char.IsDigit);
        var hasSpecialChar = password.Any(c => !char.IsLetterOrDigit(c));

        return hasLetter && hasDigit && hasSpecialChar;
    }
}

// âŒ é”™è¯¯ - æ²¡æœ‰è¾“å…¥éªŒè¯
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // æ²¡æœ‰éªŒè¯ç›´æ¥ä½¿ç”¨è¾“å…¥
        var user = new User
        {
            Username = request.Username,
            Email = request.Email,
            CompanyId = _userFactory.GetRequiredCompanyId(),
            CreatedBy = _userFactory.GetCurrentUserId(),
            CreatedAt = DateTime.UtcNow
        };
        
        return await _userFactory.CreateAsync(user);
    }
}
```

### SQLæ³¨å…¥é˜²æŠ¤

```csharp
// âœ… æ­£ç¡® - ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
public class UserService : IUserService
{
    public async Task<List<User>> SearchUsersAsync(string keyword)
    {
        // ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢é˜²æ­¢SQLæ³¨å…¥
        var filter = _userFactory.CreateFilterBuilder()
            .Regex(u => u.Username, keyword)
            .Or()
            .Regex(u => u.Email, keyword)
            .Build();

        return await _userFactory.FindAsync(filter);
    }

    public async Task<User?> GetUserByIdAsync(string id)
    {
        // éªŒè¯IDæ ¼å¼
        if (string.IsNullOrEmpty(id) || !IsValidObjectId(id))
            throw new ArgumentException("æ— æ•ˆçš„ç”¨æˆ·ID", nameof(id));

        return await _userFactory.GetByIdAsync(id);
    }

    private bool IsValidObjectId(string id)
    {
        return ObjectId.TryParse(id, out _);
    }
}

// âŒ é”™è¯¯ - å®¹æ˜“å—åˆ°SQLæ³¨å…¥æ”»å‡»
public class UserService : IUserService
{
    public async Task<List<User>> SearchUsersAsync(string keyword)
    {
        // ç›´æ¥æ‹¼æ¥å­—ç¬¦ä¸²ï¼ˆå±é™©ï¼‰
        var filter = $"{{ \"username\": {{ \"$regex\": \"{keyword}\" }} }}";
        return await _userFactory.FindAsync(filter);
    }
}
```

## ğŸ¯ èº«ä»½è®¤è¯å’Œæˆæƒ

### JWT Token å®‰å…¨

```csharp
// âœ… æ­£ç¡® - JWT Token å®‰å…¨
public class JwtService : IJwtService
{
    private readonly IConfiguration _configuration;
    private readonly ILogger<JwtService> _logger;

    public JwtService(IConfiguration configuration, ILogger<JwtService> logger)
    {
        _configuration = configuration;
        _logger = logger;
    }

    public string GenerateToken(User user)
    {
        var jwtSettings = _configuration.GetSection("JwtSettings").Get<JwtSettings>();
        var key = Encoding.ASCII.GetBytes(jwtSettings.SecretKey);

        var tokenDescriptor = new SecurityTokenDescriptor
        {
            Subject = new ClaimsIdentity(new[]
            {
                new Claim("userId", user.Id),
                new Claim("username", user.Username),
                new Claim("email", user.Email),
                new Claim("companyId", user.CompanyId),
                new Claim("isAdmin", user.IsAdmin.ToString()),
                new Claim("access", user.IsAdmin ? "admin" : "user")
            }),
            Expires = DateTime.UtcNow.AddMinutes(jwtSettings.ExpirationMinutes),
            Issuer = jwtSettings.Issuer,
            Audience = jwtSettings.Audience,
            SigningCredentials = new SigningCredentials(new SymmetricSecurityKey(key), SecurityAlgorithms.HmacSha256Signature)
        };

        var tokenHandler = new JwtSecurityTokenHandler();
        var token = tokenHandler.CreateToken(tokenDescriptor);
        return tokenHandler.WriteToken(token);
    }

    public string GenerateRefreshToken()
    {
        var randomNumber = new byte[32];
        using var rng = RandomNumberGenerator.Create();
        rng.GetBytes(randomNumber);
        return Convert.ToBase64String(randomNumber);
    }

    public ClaimsPrincipal? ValidateToken(string token)
    {
        try
        {
            var jwtSettings = _configuration.GetSection("JwtSettings").Get<JwtSettings>();
            var key = Encoding.ASCII.GetBytes(jwtSettings.SecretKey);

            var tokenHandler = new JwtSecurityTokenHandler();
            var validationParameters = new TokenValidationParameters
            {
                ValidateIssuerSigningKey = true,
                IssuerSigningKey = new SymmetricSecurityKey(key),
                ValidateIssuer = true,
                ValidIssuer = jwtSettings.Issuer,
                ValidateAudience = true,
                ValidAudience = jwtSettings.Audience,
                ValidateLifetime = true,
                ClockSkew = TimeSpan.Zero
            };

            var principal = tokenHandler.ValidateToken(token, validationParameters, out SecurityToken validatedToken);
            return principal;
        }
        catch (Exception ex)
        {
            _logger.LogWarning(ex, "JWT Token éªŒè¯å¤±è´¥: {Token}", token);
            return null;
        }
    }
}

// âŒ é”™è¯¯ - JWT Token ä¸å®‰å…¨
public class JwtService : IJwtService
{
    public string GenerateToken(User user)
    {
        // ä½¿ç”¨å¼±å¯†é’¥
        var key = Encoding.ASCII.GetBytes("weakkey");
        
        // æ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´
        var tokenDescriptor = new SecurityTokenDescriptor
        {
            Subject = new ClaimsIdentity(new[]
            {
                new Claim("userId", user.Id)
            }),
            SigningCredentials = new SigningCredentials(new SymmetricSecurityKey(key), SecurityAlgorithms.HmacSha256Signature)
        };

        var tokenHandler = new JwtSecurityTokenHandler();
        var token = tokenHandler.CreateToken(tokenDescriptor);
        return tokenHandler.WriteToken(token);
    }
}
```

### æƒé™æ§åˆ¶

```csharp
// âœ… æ­£ç¡® - æƒé™æ§åˆ¶
public class UserService : IUserService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    private readonly ITenantContext _tenantContext;

    public UserService(
        IDatabaseOperationFactory<User> userFactory,
        ITenantContext tenantContext)
    {
        _userFactory = userFactory;
        _tenantContext = tenantContext;
    }

    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // 1. æ£€æŸ¥ç”¨æˆ·æƒé™
        var currentUserId = _tenantContext.GetRequiredUserId();
        var currentUser = await _userFactory.GetByIdAsync(currentUserId);
        if (currentUser == null || !currentUser.IsActive)
        {
            throw new UnauthorizedAccessException("ç”¨æˆ·æœªè®¤è¯æˆ–å·²åœç”¨");
        }

        // 2. æ£€æŸ¥ä¼ä¸šæƒé™
        var companyId = _tenantContext.GetRequiredCompanyId();
        if (string.IsNullOrEmpty(companyId))
        {
            throw new UnauthorizedAccessException("æœªæ‰¾åˆ°ä¼ä¸šä¿¡æ¯");
        }

        // 3. æ£€æŸ¥ç®¡ç†å‘˜æƒé™
        if (!currentUser.IsAdmin)
        {
            throw new UnauthorizedAccessException("éœ€è¦ç®¡ç†å‘˜æƒé™");
        }

        // 4. ä¸šåŠ¡é€»è¾‘å¤„ç†
        await ValidateCreateUserRequestAsync(request);
        
        var user = new User
        {
            Username = request.Username.Trim(),
            Email = request.Email.Trim().ToLowerInvariant(),
            CompanyId = companyId,
            CreatedBy = currentUserId,
            CreatedAt = DateTime.UtcNow
        };
        
        return await _userFactory.CreateAsync(user);
    }

    public async Task<bool> DeleteUserAsync(string id)
    {
        // 1. æ£€æŸ¥ç”¨æˆ·æƒé™
        var currentUserId = _tenantContext.GetRequiredUserId();
        var currentUser = await _userFactory.GetByIdAsync(currentUserId);
        if (currentUser == null || !currentUser.IsActive)
        {
            throw new UnauthorizedAccessException("ç”¨æˆ·æœªè®¤è¯æˆ–å·²åœç”¨");
        }

        // 2. æ£€æŸ¥ç›®æ ‡ç”¨æˆ·
        var targetUser = await _userFactory.GetByIdAsync(id);
        if (targetUser == null)
        {
            throw new KeyNotFoundException($"ç”¨æˆ· {id} ä¸å­˜åœ¨");
        }

        // 3. æ£€æŸ¥åˆ é™¤æƒé™
        if (!currentUser.IsAdmin && currentUserId != id)
        {
            throw new UnauthorizedAccessException("åªèƒ½åˆ é™¤è‡ªå·±çš„è´¦æˆ·æˆ–éœ€è¦ç®¡ç†å‘˜æƒé™");
        }

        // 4. æ£€æŸ¥ä¸šåŠ¡è§„åˆ™
        if (targetUser.IsAdmin)
        {
            throw new InvalidOperationException("æ— æ³•åˆ é™¤ä¼ä¸šç®¡ç†å‘˜");
        }

        // 5. æ‰§è¡Œåˆ é™¤
        return await _userFactory.SoftDeleteAsync(id, new OperationContext
        {
            UserId = currentUserId,
            Username = currentUser.Username,
            CompanyId = currentUser.CompanyId,
            OperationType = OperationType.Delete,
            Description = "åˆ é™¤ç”¨æˆ·"
        });
    }
}

// âŒ é”™è¯¯ - æ²¡æœ‰æƒé™æ§åˆ¶
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // æ²¡æœ‰æƒé™æ£€æŸ¥
        var user = new User
        {
            Username = request.Username,
            Email = request.Email,
            CompanyId = _userFactory.GetRequiredCompanyId(),
            CreatedBy = _userFactory.GetCurrentUserId(),
            CreatedAt = DateTime.UtcNow
        };
        
        return await _userFactory.CreateAsync(user);
    }
}
```

## ğŸ¯ æ•°æ®åŠ å¯†å’Œå®‰å…¨

### å¯†ç å®‰å…¨

```csharp
// âœ… æ­£ç¡® - å¯†ç å®‰å…¨
public class PasswordHasher : IPasswordHasher
{
    private readonly ILogger<PasswordHasher> _logger;

    public PasswordHasher(ILogger<PasswordHasher> logger)
    {
        _logger = logger;
    }

    public string HashPassword(string password)
    {
        if (string.IsNullOrEmpty(password))
            throw new ArgumentException("å¯†ç ä¸èƒ½ä¸ºç©º", nameof(password));

        // ä½¿ç”¨ BCrypt è¿›è¡Œå¯†ç å“ˆå¸Œ
        return BCrypt.Net.BCrypt.HashPassword(password, BCrypt.Net.BCrypt.GenerateSalt(12));
    }

    public bool VerifyPassword(string password, string hashedPassword)
    {
        if (string.IsNullOrEmpty(password) || string.IsNullOrEmpty(hashedPassword))
            return false;

        try
        {
            return BCrypt.Net.BCrypt.Verify(password, hashedPassword);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "å¯†ç éªŒè¯å¤±è´¥");
            return false;
        }
    }

    public bool IsPasswordStrong(string password)
    {
        if (string.IsNullOrEmpty(password) || password.Length < 8)
            return false;

        var hasLetter = password.Any(char.IsLetter);
        var hasDigit = password.Any(char.IsDigit);
        var hasSpecialChar = password.Any(c => !char.IsLetterOrDigit(c));

        return hasLetter && hasDigit && hasSpecialChar;
    }
}

// âŒ é”™è¯¯ - å¯†ç ä¸å®‰å…¨
public class PasswordHasher : IPasswordHasher
{
    public string HashPassword(string password)
    {
        // ä½¿ç”¨å¼±å“ˆå¸Œç®—æ³•
        using var sha256 = SHA256.Create();
        var hashedBytes = sha256.ComputeHash(Encoding.UTF8.GetBytes(password));
        return Convert.ToBase64String(hashedBytes);
    }

    public bool VerifyPassword(string password, string hashedPassword)
    {
        var hashed = HashPassword(password);
        return hashed == hashedPassword;
    }
}
```

### æ•æ„Ÿæ•°æ®åŠ å¯†

```csharp
// âœ… æ­£ç¡® - æ•æ„Ÿæ•°æ®åŠ å¯†
public class EncryptionService : IEncryptionService
{
    private readonly IConfiguration _configuration;
    private readonly ILogger<EncryptionService> _logger;

    public EncryptionService(IConfiguration configuration, ILogger<EncryptionService> logger)
    {
        _configuration = configuration;
        _logger = logger;
    }

    public string Encrypt(string plainText)
    {
        if (string.IsNullOrEmpty(plainText))
            return string.Empty;

        try
        {
            var key = _configuration["Encryption:Key"];
            var iv = _configuration["Encryption:IV"];

            using var aes = Aes.Create();
            aes.Key = Convert.FromBase64String(key);
            aes.IV = Convert.FromBase64String(iv);
            aes.Mode = CipherMode.CBC;
            aes.Padding = PaddingMode.PKCS7;

            using var encryptor = aes.CreateEncryptor();
            using var msEncrypt = new MemoryStream();
            using var csEncrypt = new CryptoStream(msEncrypt, encryptor, CryptoStreamMode.Write);
            using var swEncrypt = new StreamWriter(csEncrypt);

            swEncrypt.Write(plainText);
            swEncrypt.Close();

            return Convert.ToBase64String(msEncrypt.ToArray());
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "æ•°æ®åŠ å¯†å¤±è´¥");
            throw new InvalidOperationException("æ•°æ®åŠ å¯†å¤±è´¥", ex);
        }
    }

    public string Decrypt(string cipherText)
    {
        if (string.IsNullOrEmpty(cipherText))
            return string.Empty;

        try
        {
            var key = _configuration["Encryption:Key"];
            var iv = _configuration["Encryption:IV"];

            using var aes = Aes.Create();
            aes.Key = Convert.FromBase64String(key);
            aes.IV = Convert.FromBase64String(iv);
            aes.Mode = CipherMode.CBC;
            aes.Padding = PaddingMode.PKCS7;

            using var decryptor = aes.CreateDecryptor();
            using var msDecrypt = new MemoryStream(Convert.FromBase64String(cipherText));
            using var csDecrypt = new CryptoStream(msDecrypt, decryptor, CryptoStreamMode.Read);
            using var srDecrypt = new StreamReader(csDecrypt);

            return srDecrypt.ReadToEnd();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "æ•°æ®è§£å¯†å¤±è´¥");
            throw new InvalidOperationException("æ•°æ®è§£å¯†å¤±è´¥", ex);
        }
    }
}

// âŒ é”™è¯¯ - æ•æ„Ÿæ•°æ®æœªåŠ å¯†
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        var user = new User
        {
            Username = request.Username,
            Email = request.Email,
            // å¯†ç æœªåŠ å¯†
            Password = request.Password,
            // æ‰‹æœºå·æœªåŠ å¯†
            PhoneNumber = request.PhoneNumber
        };

        return await _userFactory.CreateAsync(user);
    }
}
```

## ğŸ¯ å®‰å…¨æ—¥å¿—å’Œç›‘æ§

### å®‰å…¨äº‹ä»¶è®°å½•

```csharp
// âœ… æ­£ç¡® - å®‰å…¨äº‹ä»¶è®°å½•
public class UserService : IUserService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    private readonly IAuditService _auditService;
    private readonly ILogger<UserService> _logger;

    public UserService(
        IDatabaseOperationFactory<User> userFactory,
        IAuditService auditService,
        ILogger<UserService> logger)
    {
        _userFactory = userFactory;
        _auditService = auditService;
        _logger = logger;
    }

    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        var user = new User
        {
            Username = request.Username,
            Email = request.Email,
            CompanyId = _userFactory.GetRequiredCompanyId(),
            CreatedBy = _userFactory.GetCurrentUserId(),
            CreatedAt = DateTime.UtcNow
        };

        var createdUser = await _userFactory.CreateAsync(user);

        // è®°å½•å®‰å…¨äº‹ä»¶
        await _auditService.RecordSecurityEventAsync(new SecurityEvent
        {
            EventType = "UserCreated",
            UserId = _userFactory.GetCurrentUserId(),
            Username = _userFactory.GetCurrentUsername(),
            CompanyId = _userFactory.GetCurrentCompanyId(),
            Description = "åˆ›å»ºç”¨æˆ·",
            Data = new { Username = request.Username, Email = request.Email },
            Timestamp = DateTime.UtcNow
        });

        _logger.LogInformation("ç”¨æˆ·åˆ›å»ºæˆåŠŸ: {UserId}, æ“ä½œè€…: {OperatorId}", 
            createdUser.Id, _userFactory.GetCurrentUserId());

        return createdUser;
    }

    public async Task<bool> DeleteUserAsync(string id)
    {
        var currentUserId = _userFactory.GetRequiredUserId();
        var currentUser = await _userFactory.GetByIdAsync(currentUserId);
        if (currentUser == null || !currentUser.IsActive)
        {
            // è®°å½•å®‰å…¨äº‹ä»¶
            await _auditService.RecordSecurityEventAsync(new SecurityEvent
            {
                EventType = "UnauthorizedAccess",
                UserId = currentUserId,
                Username = currentUser?.Username,
                CompanyId = currentUser?.CompanyId,
                Description = "æœªæˆæƒè®¿é—®å°è¯•",
                Data = new { TargetUserId = id },
                Timestamp = DateTime.UtcNow
            });

            throw new UnauthorizedAccessException("ç”¨æˆ·æœªè®¤è¯æˆ–å·²åœç”¨");
        }

        var targetUser = await _userFactory.GetByIdAsync(id);
        if (targetUser == null)
        {
            throw new KeyNotFoundException($"ç”¨æˆ· {id} ä¸å­˜åœ¨");
        }

        if (!currentUser.IsAdmin && currentUserId != id)
        {
            // è®°å½•å®‰å…¨äº‹ä»¶
            await _auditService.RecordSecurityEventAsync(new SecurityEvent
            {
                EventType = "UnauthorizedAccess",
                UserId = currentUserId,
                Username = currentUser.Username,
                CompanyId = currentUser.CompanyId,
                Description = "æœªæˆæƒåˆ é™¤å°è¯•",
                Data = new { TargetUserId = id },
                Timestamp = DateTime.UtcNow
            });

            throw new UnauthorizedAccessException("åªèƒ½åˆ é™¤è‡ªå·±çš„è´¦æˆ·æˆ–éœ€è¦ç®¡ç†å‘˜æƒé™");
        }

        var result = await _userFactory.SoftDeleteAsync(id, new OperationContext
        {
            UserId = currentUserId,
            Username = currentUser.Username,
            CompanyId = currentUser.CompanyId,
            OperationType = OperationType.Delete,
            Description = "åˆ é™¤ç”¨æˆ·"
        });

        if (result)
        {
            // è®°å½•å®‰å…¨äº‹ä»¶
            await _auditService.RecordSecurityEventAsync(new SecurityEvent
            {
                EventType = "UserDeleted",
                UserId = currentUserId,
                Username = currentUser.Username,
                CompanyId = currentUser.CompanyId,
                Description = "åˆ é™¤ç”¨æˆ·",
                Data = new { TargetUserId = id, TargetUsername = targetUser.Username },
                Timestamp = DateTime.UtcNow
            });

            _logger.LogInformation("ç”¨æˆ·åˆ é™¤æˆåŠŸ: {TargetUserId}, æ“ä½œè€…: {OperatorId}", 
                id, currentUserId);
        }

        return result;
    }
}

// âŒ é”™è¯¯ - æ²¡æœ‰å®‰å…¨äº‹ä»¶è®°å½•
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        var user = new User
        {
            Username = request.Username,
            Email = request.Email
        };

        // æ²¡æœ‰è®°å½•å®‰å…¨äº‹ä»¶
        return await _userFactory.CreateAsync(user);
    }
}
```

## ğŸš« ç¦æ­¢çš„åšæ³•

### ä¸è¦å¿½ç•¥è¾“å…¥éªŒè¯

```csharp
// âŒ é”™è¯¯ - å¿½ç•¥è¾“å…¥éªŒè¯
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // æ²¡æœ‰éªŒè¯ç›´æ¥ä½¿ç”¨è¾“å…¥
        var user = new User
        {
            Username = request.Username,
            Email = request.Email,
            Password = request.Password
        };

        return await _userFactory.CreateAsync(user);
    }
}

// âœ… æ­£ç¡® - å®Œæ•´çš„è¾“å…¥éªŒè¯
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // å®Œæ•´çš„è¾“å…¥éªŒè¯
        await ValidateCreateUserRequestAsync(request);
        
        var user = new User
        {
            Username = request.Username.Trim(),
            Email = request.Email.Trim().ToLowerInvariant(),
            PasswordHash = _passwordHasher.HashPassword(request.Password)
        };

        return await _userFactory.CreateAsync(user);
    }
}
```

### ä¸è¦ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯

```csharp
// âŒ é”™è¯¯ - ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
public class JwtService : IJwtService
{
    public string GenerateToken(User user)
    {
        // ç¡¬ç¼–ç å¯†é’¥
        var key = Encoding.ASCII.GetBytes("hardcoded-secret-key");
        
        var tokenDescriptor = new SecurityTokenDescriptor
        {
            Subject = new ClaimsIdentity(new[]
            {
                new Claim("userId", user.Id)
            }),
            Expires = DateTime.UtcNow.AddMinutes(60),
            SigningCredentials = new SigningCredentials(new SymmetricSecurityKey(key), SecurityAlgorithms.HmacSha256Signature)
        };

        var tokenHandler = new JwtSecurityTokenHandler();
        var token = tokenHandler.CreateToken(tokenDescriptor);
        return tokenHandler.WriteToken(token);
    }
}

// âœ… æ­£ç¡® - ä½¿ç”¨é…ç½®ç®¡ç†æ•æ„Ÿä¿¡æ¯
public class JwtService : IJwtService
{
    private readonly IConfiguration _configuration;

    public JwtService(IConfiguration configuration)
    {
        _configuration = configuration;
    }

    public string GenerateToken(User user)
    {
        // ä»é…ç½®è·å–å¯†é’¥
        var jwtSettings = _configuration.GetSection("JwtSettings").Get<JwtSettings>();
        var key = Encoding.ASCII.GetBytes(jwtSettings.SecretKey);
        
        var tokenDescriptor = new SecurityTokenDescriptor
        {
            Subject = new ClaimsIdentity(new[]
            {
                new Claim("userId", user.Id)
            }),
            Expires = DateTime.UtcNow.AddMinutes(jwtSettings.ExpirationMinutes),
            SigningCredentials = new SigningCredentials(new SymmetricSecurityKey(key), SecurityAlgorithms.HmacSha256Signature)
        };

        var tokenHandler = new JwtSecurityTokenHandler();
        var token = tokenHandler.CreateToken(tokenDescriptor);
        return tokenHandler.WriteToken(token);
    }
}
```

### ä¸è¦å¿½ç•¥æƒé™æ£€æŸ¥

```csharp
// âŒ é”™è¯¯ - å¿½ç•¥æƒé™æ£€æŸ¥
public class UserService : IUserService
{
    public async Task<bool> DeleteUserAsync(string id)
    {
        // æ²¡æœ‰æƒé™æ£€æŸ¥ï¼Œä»»ä½•äººéƒ½å¯ä»¥åˆ é™¤ç”¨æˆ·
        return await _userFactory.SoftDeleteAsync(id);
    }
}

// âœ… æ­£ç¡® - å®Œæ•´çš„æƒé™æ£€æŸ¥
public class UserService : IUserService
{
    public async Task<bool> DeleteUserAsync(string id)
    {
        // æ£€æŸ¥ç”¨æˆ·æƒé™
        var currentUserId = _userFactory.GetRequiredUserId();
        var currentUser = await _userFactory.GetByIdAsync(currentUserId);
        if (currentUser == null || !currentUser.IsAdmin)
        {
            throw new UnauthorizedAccessException("éœ€è¦ç®¡ç†å‘˜æƒé™");
        }

        return await _userFactory.SoftDeleteAsync(id);
    }
}
```

## ğŸ“‹ å®‰å…¨å¼€å‘æ£€æŸ¥æ¸…å•

åˆ›å»ºæˆ–ä¿®æ”¹ä»£ç æ—¶æ£€æŸ¥ï¼š

- [ ] è¾“å…¥éªŒè¯å®Œæ•´
- [ ] å‚æ•°è¿‡æ»¤æ­£ç¡®
- [ ] SQLæ³¨å…¥é˜²æŠ¤
- [ ] èº«ä»½è®¤è¯å®‰å…¨
- [ ] æƒé™æ§åˆ¶æ­£ç¡®
- [ ] å¯†ç å®‰å…¨å­˜å‚¨
- [ ] æ•æ„Ÿæ•°æ®åŠ å¯†
- [ ] å®‰å…¨äº‹ä»¶è®°å½•
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] å®‰å…¨æµ‹è¯•é€šè¿‡

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç”¨æˆ·æœåŠ¡å®ç°](mdc:Platform.ApiService/Services/UserService.cs)
- [è§’è‰²æœåŠ¡å®ç°](mdc:Platform.ApiService/Services/RoleService.cs)
- [ä¼ä¸šæœåŠ¡å®ç°](mdc:Platform.ApiService/Services/CompanyService.cs)
- [å®‰å…¨æœ€ä½³å®è·µ](https://owasp.org/www-project-top-ten/)
