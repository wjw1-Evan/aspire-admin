---
globs: Platform.ApiService/Services/*.cs,Platform.ServiceDefaults/Services/*.cs
description: æœåŠ¡å±‚å¼€å‘è§„èŒƒå’Œæœ€ä½³å®è·µ
---
# æœåŠ¡å±‚å¼€å‘è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

### æœåŠ¡å±‚è´Ÿè´£ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œä½¿ç”¨æ•°æ®åº“æ“ä½œå·¥å‚è¿›è¡Œæ•°æ®è®¿é—®ï¼Œéµå¾ªå•ä¸€èŒè´£åŸåˆ™

## âœ… æœåŠ¡å±‚æ¶æ„

### åŸºç¡€æœåŠ¡ç±»

```csharp
// Platform.ServiceDefaults/Services/BaseService.cs
public abstract class BaseService
{
    protected readonly IMongoDatabase Database;
    protected readonly IHttpContextAccessor HttpContextAccessor;
    protected readonly ITenantContext TenantContext;
    protected readonly ILogger Logger;

    protected BaseService(
        IMongoDatabase database,
        IHttpContextAccessor httpContextAccessor,
        ITenantContext tenantContext,
        ILogger logger)
    {
        Database = database;
        HttpContextAccessor = httpContextAccessor;
        TenantContext = tenantContext;
        Logger = logger;
    }

    protected string GetCurrentUserId()
    {
        return HttpContextAccessor.HttpContext?.User?.FindFirst("userId")?.Value ?? string.Empty;
    }

    protected string GetCurrentCompanyId()
    {
        return TenantContext.CurrentCompanyId ?? string.Empty;
    }

    protected void LogOperation(string operation, string entityId, object? data = null)
    {
        Logger.LogInformation("æ“ä½œ: {Operation}, å®ä½“ID: {EntityId}, æ•°æ®: {@Data}", 
            operation, entityId, data);
    }
}
```

### ä¸šåŠ¡æœåŠ¡å®ç°

```csharp
// Platform.ApiService/Services/UserService.cs
public class UserService : BaseService, IUserService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    private readonly IUniquenessChecker _uniquenessChecker;
    private readonly IFieldValidationService _validationService;

    public UserService(
        IMongoDatabase database,
        IDatabaseOperationFactory<User> userFactory,
        IHttpContextAccessor httpContextAccessor,
        ITenantContext tenantContext,
        ILogger<UserService> logger,
        IUniquenessChecker uniquenessChecker,
        IFieldValidationService validationService)
        : base(database, httpContextAccessor, tenantContext, logger)
    {
        _userFactory = userFactory;
        _uniquenessChecker = uniquenessChecker;
        _validationService = validationService;
    }

    public async Task<List<User>> GetAllUsersAsync()
    {
        try
        {
            LogOperation("è·å–æ‰€æœ‰ç”¨æˆ·", "all");
            return await _userFactory.FindAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "è·å–æ‰€æœ‰ç”¨æˆ·å¤±è´¥");
            throw;
        }
    }

    public async Task<User?> GetUserByIdAsync(string id)
    {
        if (string.IsNullOrEmpty(id))
            throw new ArgumentException("ç”¨æˆ·IDä¸èƒ½ä¸ºç©º", nameof(id));

        try
        {
            LogOperation("æ ¹æ®IDè·å–ç”¨æˆ·", id);
            return await _userFactory.GetByIdAsync(id);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "è·å–ç”¨æˆ·å¤±è´¥, ID: {UserId}", id);
            throw;
        }
    }

    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // å‚æ•°éªŒè¯
        if (request == null)
            throw new ArgumentNullException(nameof(request));

        if (string.IsNullOrEmpty(request.Username))
            throw new ArgumentException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");

        // ä¸šåŠ¡è§„åˆ™éªŒè¯
        await _uniquenessChecker.EnsureUniqueAsync<User>(u => u.Username == request.Username);
        await _uniquenessChecker.EnsureUniqueAsync<User>(u => u.Email == request.Email);

        // å­—æ®µéªŒè¯
        await _validationService.ValidateAsync(request);

        try
        {
            var user = new User
            {
                Username = request.Username,
                Email = request.Email,
                PasswordHash = BCrypt.Net.BCrypt.HashPassword(request.Password),
                CompanyId = GetCurrentCompanyId(),
                IsActive = true,
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow
            };

            LogOperation("åˆ›å»ºç”¨æˆ·", user.Id, user);
            return await _userFactory.CreateAsync(user);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "åˆ›å»ºç”¨æˆ·å¤±è´¥, ç”¨æˆ·å: {Username}", request.Username);
            throw;
        }
    }
}
```

## ğŸ¯ æœåŠ¡æ¥å£å®šä¹‰

### æœåŠ¡æ¥å£

```csharp
// Platform.ApiService/Services/IUserService.cs
public interface IUserService
{
    Task<List<User>> GetAllUsersAsync();
    Task<User?> GetUserByIdAsync(string id);
    Task<User> CreateUserAsync(CreateUserRequest request);
    Task<bool> UpdateUserAsync(UpdateUserRequest request);
    Task<bool> DeleteUserAsync(string id);
    Task<List<User>> SearchUsersByNameAsync(string keyword);
    Task<bool> DeactivateUserAsync(string id);
    Task<bool> ActivateUserAsync(string id);
}
```

## ğŸ¯ æœåŠ¡æ³¨å†Œ

### ä¾èµ–æ³¨å…¥é…ç½®

```csharp
// Platform.ApiService/Program.cs
builder.Services.AddScoped<IUserService, UserService>();
builder.Services.AddScoped<IRoleService, RoleService>();
builder.Services.AddScoped<INoticeService, NoticeService>();
builder.Services.AddScoped<ITagService, TagService>();

// æ³¨å†Œæ•°æ®åº“æ“ä½œå·¥å‚
builder.Services.AddDatabaseFactory();
```

## ğŸ¯ ä¸šåŠ¡é€»è¾‘å¤„ç†

### å¤æ‚ä¸šåŠ¡é€»è¾‘

```csharp
// Platform.ApiService/Services/RoleService.cs
public class RoleService : BaseService, IRoleService
{
    private readonly IDatabaseOperationFactory<Role> _roleFactory;
    private readonly IDatabaseOperationFactory<User> _userFactory;

    public RoleService(
        IMongoDatabase database,
        IDatabaseOperationFactory<Role> roleFactory,
        IDatabaseOperationFactory<User> userFactory,
        IHttpContextAccessor httpContextAccessor,
        ITenantContext tenantContext,
        ILogger<RoleService> logger)
        : base(database, httpContextAccessor, tenantContext, logger)
    {
        _roleFactory = roleFactory;
        _userFactory = userFactory;
    }

    public async Task<List<RoleWithStats>> GetAllRolesWithStatsAsync()
    {
        try
        {
            var roles = await _roleFactory.FindAsync();
            var rolesWithStats = new List<RoleWithStats>();

            foreach (var role in roles)
            {
                var userCount = await GetUserCountByRoleAsync(role.Id);
                rolesWithStats.Add(new RoleWithStats
                {
                    Role = role,
                    UserCount = userCount
                });
            }

            LogOperation("è·å–è§’è‰²ç»Ÿè®¡", "all");
            return rolesWithStats;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "è·å–è§’è‰²ç»Ÿè®¡å¤±è´¥");
            throw;
        }
    }

    private async Task<int> GetUserCountByRoleAsync(string roleId)
    {
        var filter = _userFactory.CreateFilterBuilder()
            .Equal(u => u.RoleId, roleId)
            .Build();

        return await _userFactory.CountAsync(filter);
    }

    public async Task<bool> DeleteRoleAsync(string id)
    {
        if (string.IsNullOrEmpty(id))
            throw new ArgumentException("è§’è‰²IDä¸èƒ½ä¸ºç©º");

        // æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·ä½¿ç”¨æ­¤è§’è‰²
        var userCount = await GetUserCountByRoleAsync(id);
        if (userCount > 0)
            throw new InvalidOperationException($"æ— æ³•åˆ é™¤è§’è‰²ï¼Œè¿˜æœ‰ {userCount} ä¸ªç”¨æˆ·åœ¨ä½¿ç”¨æ­¤è§’è‰²");

        try
        {
            LogOperation("åˆ é™¤è§’è‰²", id);
            return await _roleFactory.SoftDeleteAsync(id);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "åˆ é™¤è§’è‰²å¤±è´¥, ID: {RoleId}", id);
            throw;
        }
    }
}
```

## ğŸ¯ äº‹åŠ¡å¤„ç†

### å¤æ‚äº‹åŠ¡æ“ä½œ

```csharp
// Platform.ApiService/Services/UserService.cs
public async Task<User> CreateUserWithRoleAsync(CreateUserWithRoleRequest request)
{
    if (request == null)
        throw new ArgumentNullException(nameof(request));

    using var session = await Database.Client.StartSessionAsync();
    
    try
    {
        session.StartTransaction();

        // 1. åˆ›å»ºç”¨æˆ·
        var user = new User
        {
            Username = request.Username,
            Email = request.Email,
            PasswordHash = BCrypt.Net.BCrypt.HashPassword(request.Password),
            CompanyId = GetCurrentCompanyId(),
            IsActive = true,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        };

        var createdUser = await _userFactory.CreateAsync(user);

        // 2. åˆ†é…è§’è‰²
        if (!string.IsNullOrEmpty(request.RoleId))
        {
            var role = await _roleFactory.GetByIdAsync(request.RoleId);
            if (role == null)
                throw new KeyNotFoundException($"è§’è‰² {request.RoleId} ä¸å­˜åœ¨");

            var userUpdate = _userFactory.CreateUpdateBuilder()
                .Set(u => u.RoleId, request.RoleId)
                .Set(u => u.UpdatedAt, DateTime.UtcNow)
                .Build();

            await _userFactory.UpdateAsync(createdUser.Id, userUpdate);
            createdUser.RoleId = request.RoleId;
        }

        await session.CommitTransactionAsync();
        
        LogOperation("åˆ›å»ºç”¨æˆ·å¹¶åˆ†é…è§’è‰²", createdUser.Id, request);
        return createdUser;
    }
    catch (Exception ex)
    {
        await session.AbortTransactionAsync();
        Logger.LogError(ex, "åˆ›å»ºç”¨æˆ·å¹¶åˆ†é…è§’è‰²å¤±è´¥, ç”¨æˆ·å: {Username}", request.Username);
        throw;
    }
}
```

## ğŸš« ç¦æ­¢çš„åšæ³•

### ä¸è¦ç›´æ¥ä½¿ç”¨ MongoDB é©±åŠ¨

```csharp
// âŒ é”™è¯¯ - ç›´æ¥ä½¿ç”¨ MongoDB é©±åŠ¨
public class UserService : BaseService
{
    private readonly IMongoCollection<User> _users;

    public UserService(IMongoDatabase database)
    {
        _users = database.GetCollection<User>("users");
    }

    public async Task<User> CreateUserAsync(User user)
    {
        await _users.InsertOneAsync(user); // âŒ æ²¡æœ‰å¤šç§Ÿæˆ·è¿‡æ»¤ã€å®¡è®¡ç­‰
        return user;
    }
}

// âœ… æ­£ç¡® - ä½¿ç”¨æ•°æ®åº“æ“ä½œå·¥å‚
public class UserService : BaseService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;

    public UserService(IDatabaseOperationFactory<User> userFactory)
    {
        _userFactory = userFactory;
    }

    public async Task<User> CreateUserAsync(User user)
    {
        return await _userFactory.CreateAsync(user); // âœ… è‡ªåŠ¨å¤„ç†å¤šç§Ÿæˆ·ã€å®¡è®¡ç­‰
    }
}
```

### ä¸è¦å¿½ç•¥å¼‚å¸¸å¤„ç†

```csharp
// âŒ é”™è¯¯ - å¿½ç•¥å¼‚å¸¸
public async Task<User> GetUserAsync(string id)
{
    return await _userFactory.GetByIdAsync(id); // å¯èƒ½æŠ›å‡ºå¼‚å¸¸
}

// âœ… æ­£ç¡® - é€‚å½“çš„å¼‚å¸¸å¤„ç†
public async Task<User?> GetUserAsync(string id)
{
    try
    {
        return await _userFactory.GetByIdAsync(id);
    }
    catch (Exception ex)
    {
        Logger.LogError(ex, "è·å–ç”¨æˆ·å¤±è´¥, ID: {UserId}", id);
        throw;
    }
}
```

### ä¸è¦å¿½ç•¥ä¸šåŠ¡è§„åˆ™éªŒè¯

```csharp
// âŒ é”™è¯¯ - æ²¡æœ‰ä¸šåŠ¡è§„åˆ™éªŒè¯
public async Task<User> CreateUserAsync(CreateUserRequest request)
{
    var user = new User
    {
        Username = request.Username,
        Email = request.Email,
        PasswordHash = BCrypt.Net.BCrypt.HashPassword(request.Password)
    };
    
    return await _userFactory.CreateAsync(user);
}

// âœ… æ­£ç¡® - å®Œæ•´çš„ä¸šåŠ¡è§„åˆ™éªŒè¯
public async Task<User> CreateUserAsync(CreateUserRequest request)
{
    // å‚æ•°éªŒè¯
    if (request == null)
        throw new ArgumentNullException(nameof(request));

    if (string.IsNullOrEmpty(request.Username))
        throw new ArgumentException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");

    // ä¸šåŠ¡è§„åˆ™éªŒè¯
    await _uniquenessChecker.EnsureUniqueAsync<User>(u => u.Username == request.Username);
    await _uniquenessChecker.EnsureUniqueAsync<User>(u => u.Email == request.Email);

    // å­—æ®µéªŒè¯
    await _validationService.ValidateAsync(request);

    var user = new User
    {
        Username = request.Username,
        Email = request.Email,
        PasswordHash = BCrypt.Net.BCrypt.HashPassword(request.Password),
        CompanyId = GetCurrentCompanyId(),
        IsActive = true,
        CreatedAt = DateTime.UtcNow,
        UpdatedAt = DateTime.UtcNow
    };

    return await _userFactory.CreateAsync(user);
}
```

## ğŸ“‹ æœåŠ¡å±‚å¼€å‘æ£€æŸ¥æ¸…å•

åˆ›å»ºæˆ–ä¿®æ”¹æœåŠ¡æ—¶æ£€æŸ¥ï¼š

- [ ] ç»§æ‰¿ BaseService åŸºç±»
- [ ] ä½¿ç”¨ IDatabaseOperationFactory&lt;T&gt; è¿›è¡Œæ•°æ®è®¿é—®
- [ ] å®ç°å¯¹åº”çš„æœåŠ¡æ¥å£
- [ ] æ·»åŠ é€‚å½“çš„å‚æ•°éªŒè¯
- [ ] æ·»åŠ ä¸šåŠ¡è§„åˆ™éªŒè¯
- [ ] æ·»åŠ å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•
- [ ] ä½¿ç”¨äº‹åŠ¡å¤„ç†å¤æ‚æ“ä½œ
- [ ] æ·»åŠ æ“ä½œå®¡è®¡æ—¥å¿—
- [ ] éµå¾ªå•ä¸€èŒè´£åŸåˆ™
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“æ“ä½œå·¥å‚ä½¿ç”¨æŒ‡å—](mdc:docs/features/DATABASE-OPERATION-FACTORY-GUIDE.md)
- [åç«¯æ•°æ®è®¿é—®å±‚è§„èŒƒ](mdc:.cursor/rules/backend-data-access.mdc)
- [APIæ§åˆ¶å™¨æ ‡å‡†è§„èŒƒ](mdc:.cursor/rules/api-controller-standards.mdc)
