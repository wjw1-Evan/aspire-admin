---
globs: **/*.test.ts,**/*.test.tsx,**/*.spec.ts,**/*.spec.tsx,**/__tests__/**
description: æµ‹è¯•è§„èŒƒå’Œæœ€ä½³å®è·µ
---

# æµ‹è¯•è§„èŒƒå’Œæœ€ä½³å®è·µ

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### æµ‹è¯•é‡‘å­—å¡”
1. **å•å…ƒæµ‹è¯•** - æµ‹è¯•å•ä¸ªå‡½æ•°æˆ–ç»„ä»¶
2. **é›†æˆæµ‹è¯•** - æµ‹è¯•ç»„ä»¶é—´çš„äº¤äº’
3. **ç«¯åˆ°ç«¯æµ‹è¯•** - æµ‹è¯•å®Œæ•´çš„ç”¨æˆ·æµç¨‹

### æµ‹è¯•å·¥å…·
- **Jest** - JavaScript æµ‹è¯•æ¡†æ¶
- **React Testing Library** - React ç»„ä»¶æµ‹è¯•
- **Expo Testing Library** - Expo åº”ç”¨æµ‹è¯•
- **MSW** - API æ¨¡æ‹Ÿ

## ğŸ¯ å•å…ƒæµ‹è¯•

### ç»„ä»¶æµ‹è¯•
```typescript
// âœ… æ¨èï¼šç»„ä»¶æµ‹è¯•ç¤ºä¾‹
import { render, screen, fireEvent } from '@testing-library/react-native';
import { ThemeProvider } from '@/contexts/ThemeContext';
import UserCard from './UserCard';

const renderWithTheme = (component: React.ReactElement) => {
  return render(
    <ThemeProvider>
      {component}
    </ThemeProvider>
  );
};

describe('UserCard', () => {
  const mockUser = {
    id: '1',
    username: 'testuser',
    email: 'test@example.com',
    role: 'user',
  };

  it('renders user information correctly', () => {
    renderWithTheme(<UserCard user={mockUser} />);
    
    expect(screen.getByText('testuser')).toBeTruthy();
    expect(screen.getByText('test@example.com')).toBeTruthy();
  });

  it('calls onEdit when edit button is pressed', () => {
    const mockOnEdit = jest.fn();
    renderWithTheme(<UserCard user={mockUser} onEdit={mockOnEdit} />);
    
    fireEvent.press(screen.getByText('ç¼–è¾‘'));
    expect(mockOnEdit).toHaveBeenCalledWith(mockUser);
  });
});
```

### Hook æµ‹è¯•
```typescript
// âœ… æ¨èï¼šHook æµ‹è¯•ç¤ºä¾‹
import { renderHook, act } from '@testing-library/react-hooks';
import { useUsers } from './useUsers';
import { UserService } from '@/services/UserService';

// Mock æœåŠ¡
jest.mock('@/services/UserService');
const mockUserService = UserService as jest.Mocked<typeof UserService>;

describe('useUsers', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  it('fetches users on mount', async () => {
    const mockUsers = [
      { id: '1', username: 'user1', email: 'user1@example.com' },
    ];
    mockUserService.getUsers.mockResolvedValue(mockUsers);

    const { result, waitForNextUpdate } = renderHook(() => useUsers());

    expect(result.current.loading).toBe(true);
    
    await waitForNextUpdate();
    
    expect(result.current.loading).toBe(false);
    expect(result.current.users).toEqual(mockUsers);
    expect(result.current.error).toBeNull();
  });

  it('handles fetch error', async () => {
    const errorMessage = 'Network error';
    mockUserService.getUsers.mockRejectedValue(new Error(errorMessage));

    const { result, waitForNextUpdate } = renderHook(() => useUsers());

    await waitForNextUpdate();
    
    expect(result.current.loading).toBe(false);
    expect(result.current.users).toEqual([]);
    expect(result.current.error).toBe(errorMessage);
  });
});
```

## ğŸ”§ é›†æˆæµ‹è¯•

### API é›†æˆæµ‹è¯•
```typescript
// âœ… æ¨èï¼šAPI é›†æˆæµ‹è¯•
import { rest } from 'msw';
import { setupServer } from 'msw/node';
import { UserService } from '@/services/UserService';

const server = setupServer(
  rest.get('http://localhost:15000/api/apiservice/api/users', (req, res, ctx) => {
    return res(
      ctx.json([
        { id: '1', username: 'user1', email: 'user1@example.com' },
      ])
    );
  }),
  rest.post('http://localhost:15000/api/apiservice/api/users', (req, res, ctx) => {
    return res(
      ctx.status(201),
      ctx.json({ id: '2', username: 'user2', email: 'user2@example.com' })
    );
  })
);

beforeAll(() => server.listen());
afterEach(() => server.resetHandlers());
afterAll(() => server.close());

describe('UserService Integration', () => {
  it('fetches users from API', async () => {
    const users = await UserService.getUsers();
    
    expect(users).toHaveLength(1);
    expect(users[0].username).toBe('user1');
  });

  it('creates user via API', async () => {
    const newUser = {
      username: 'user2',
      email: 'user2@example.com',
    };
    
    const createdUser = await UserService.createUser(newUser);
    
    expect(createdUser.id).toBe('2');
    expect(createdUser.username).toBe('user2');
  });
});
```

### ä¸»é¢˜ç³»ç»Ÿæµ‹è¯•
```typescript
// âœ… æ¨èï¼šä¸»é¢˜ç³»ç»Ÿæµ‹è¯•
import { renderHook, act } from '@testing-library/react-hooks';
import { ThemeProvider, useTheme } from '@/contexts/ThemeContext';

const wrapper = ({ children }: { children: React.ReactNode }) => (
  <ThemeProvider>{children}</ThemeProvider>
);

describe('ThemeContext', () => {
  it('provides default theme mode', () => {
    const { result } = renderHook(() => useTheme(), { wrapper });
    
    expect(result.current.themeMode).toBe('system');
    expect(result.current.isDark).toBe(false);
  });

  it('toggles theme mode', () => {
    const { result } = renderHook(() => useTheme(), { wrapper });
    
    act(() => {
      result.current.setThemeMode('dark');
    });
    
    expect(result.current.themeMode).toBe('dark');
    expect(result.current.isDark).toBe(true);
  });
});
```

## ğŸ“± ç§»åŠ¨ç«¯æµ‹è¯•

### å¯¼èˆªæµ‹è¯•
```typescript
// âœ… æ¨èï¼šå¯¼èˆªæµ‹è¯•
import { render, fireEvent } from '@testing-library/react-native';
import { NavigationContainer } from '@react-navigation/native';
import { createStackNavigator } from '@react-navigation/stack';
import HomeScreen from './HomeScreen';
import ProfileScreen from './ProfileScreen';

const Stack = createStackNavigator();

const renderWithNavigation = () => {
  return render(
    <NavigationContainer>
      <Stack.Navigator>
        <Stack.Screen name="Home" component={HomeScreen} />
        <Stack.Screen name="Profile" component={ProfileScreen} />
      </Stack.Navigator>
    </NavigationContainer>
  );
};

describe('Navigation', () => {
  it('navigates to profile screen', () => {
    const { getByText } = renderWithNavigation();
    
    fireEvent.press(getByText('ä¸ªäººä¸­å¿ƒ'));
    
    expect(getByText('ä¸ªäººèµ„æ–™')).toBeTruthy();
  });
});
```

### å¼‚æ­¥å­˜å‚¨æµ‹è¯•
```typescript
// âœ… æ¨èï¼šå¼‚æ­¥å­˜å‚¨æµ‹è¯•
import AsyncStorage from '@react-native-async-storage/async-storage';
import { AuthService } from '@/services/AuthService';

jest.mock('@react-native-async-storage/async-storage', () => ({
  setItem: jest.fn(),
  getItem: jest.fn(),
  removeItem: jest.fn(),
}));

describe('AuthService', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  it('stores token after login', async () => {
    const mockResponse = {
      token: 'mock-token',
      user: { id: '1', username: 'testuser' },
    };

    // Mock API response
    jest.spyOn(global, 'fetch').mockResolvedValue({
      json: () => Promise.resolve(mockResponse),
    } as Response);

    await AuthService.login({ username: 'testuser', password: 'password' });

    expect(AsyncStorage.setItem).toHaveBeenCalledWith('auth_token', 'mock-token');
    expect(AsyncStorage.setItem).toHaveBeenCalledWith('user_info', JSON.stringify(mockResponse.user));
  });
});
```

## ğŸš« é¿å…çš„åšæ³•

- ä¸è¦æµ‹è¯•å®ç°ç»†èŠ‚ï¼Œæµ‹è¯•è¡Œä¸º
- ä¸è¦å¿˜è®°æ¸…ç†æµ‹è¯•å‰¯ä½œç”¨
- ä¸è¦ç¡¬ç¼–ç æµ‹è¯•æ•°æ®
- ä¸è¦å¿½ç•¥å¼‚æ­¥æµ‹è¯•çš„ç­‰å¾…
- ä¸è¦åœ¨ç”Ÿäº§ä»£ç ä¸­ç•™ä¸‹æµ‹è¯•ä»£ç 

## ğŸ”§ æµ‹è¯•é…ç½®

### Jest é…ç½®
```javascript
// jest.config.js
module.exports = {
  preset: 'react-native',
  setupFilesAfterEnv: ['<rootDir>/tests/setupTests.js'],
  testMatch: [
    '**/__tests__/**/*.(ts|tsx|js)',
    '**/*.(test|spec).(ts|tsx|js)',
  ],
  collectCoverageFrom: [
    'app/**/*.{ts,tsx}',
    'components/**/*.{ts,tsx}',
    'services/**/*.{ts,tsx}',
    '!**/*.d.ts',
    '!**/node_modules/**',
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
};
```

### æµ‹è¯•å·¥å…·å‡½æ•°
```typescript
// tests/test-utils.tsx
import React from 'react';
import { render } from '@testing-library/react-native';
import { ThemeProvider } from '@/contexts/ThemeContext';
import { NavigationContainer } from '@react-navigation/native';

export const renderWithProviders = (
  ui: React.ReactElement,
  options?: any
) => {
  return render(
    <NavigationContainer>
      <ThemeProvider>
        {ui}
      </ThemeProvider>
    </NavigationContainer>,
    options
  );
};
```

## ğŸ¯ æœ€ä½³å®è·µ

1. **æµ‹è¯•è¡Œä¸ºè€Œéå®ç°** - å…³æ³¨ç”¨æˆ·äº¤äº’å’Œé¢„æœŸç»“æœ
2. **ä¿æŒæµ‹è¯•ç®€å•** - æ¯ä¸ªæµ‹è¯•åªéªŒè¯ä¸€ä¸ªåŠŸèƒ½ç‚¹
3. **ä½¿ç”¨æè¿°æ€§åç§°** - æµ‹è¯•åç§°åº”è¯¥æ¸…æ¥šè¯´æ˜æµ‹è¯•å†…å®¹
4. **æ¨¡æ‹Ÿå¤–éƒ¨ä¾èµ–** - ä½¿ç”¨ Mock éš”ç¦»æµ‹è¯•å•å…ƒ
5. **ä¿æŒæµ‹è¯•ç‹¬ç«‹** - æµ‹è¯•ä¹‹é—´ä¸åº”è¯¥ç›¸äº’ä¾èµ–