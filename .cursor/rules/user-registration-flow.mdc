---
description: ç”¨æˆ·æ³¨å†Œæµç¨‹å’Œä¼ä¸šè‡ªåŠ¨åˆ›å»ºè§„èŒƒ
---

# ç”¨æˆ·æ³¨å†Œæµç¨‹å’Œä¼ä¸šè‡ªåŠ¨åˆ›å»º

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**æ‰€æœ‰ç”¨æˆ·å¿…é¡»é€šè¿‡æ³¨å†Œæµç¨‹åˆ›å»ºè´¦æˆ·ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºæ¯ä¸ªç”¨æˆ·åˆ›å»ºä¸ªäººä¼ä¸šå¹¶è®¾ç½®ä¸ºç®¡ç†å‘˜ã€‚**

## âœ… ç”¨æˆ·æ³¨å†Œæ—¶è‡ªåŠ¨åˆ›å»ºçš„å†…å®¹

ç”¨æˆ·æ³¨å†Œæ—¶ï¼Œç³»ç»Ÿä¼šåœ¨ MongoDB äº‹åŠ¡ä¸­è‡ªåŠ¨åˆ›å»ºä»¥ä¸‹å†…å®¹ï¼š

### 1. ä¸ªäººä¼ä¸š
```csharp
var company = new Company
{
    Name = $"{user.Username} çš„ä¼ä¸š",
    Code = $"personal-{user.Id}",
    Description = "ä¸ªäººä¼ä¸š",
    IsActive = true,
    MaxUsers = 50
};
```

### 2. é»˜è®¤æƒé™ï¼ˆ28ä¸ª - 7èµ„æº Ã— 4æ“ä½œï¼‰
```csharp
// ä¸ºä¼ä¸šåˆ›å»ºæƒé™ï¼Œå¿…é¡»è®¾ç½® CompanyId
var permission = new Permission
{
    ResourceName = perm.ResourceName,
    ResourceTitle = perm.ResourceTitle,
    Action = perm.Action,
    Code = $"{perm.ResourceName}:{perm.Action}",
    CompanyId = company.Id!,  // âœ… å¿…é¡»è®¾ç½®ä¼ä¸šID
    // ...
};
```

æƒé™åˆ—è¡¨ï¼š
- user:create, user:read, user:update, user:delete
- role:create, role:read, role:update, role:delete
- menu:create, menu:read, menu:update, menu:delete
- notice:create, notice:read, notice:update, notice:delete
- tag:create, tag:read, tag:update, tag:delete
- permission:create, permission:read, permission:update, permission:delete
- activity-log:create, activity-log:read, activity-log:update, activity-log:delete

### 3. ç®¡ç†å‘˜è§’è‰²
```csharp
var adminRole = new Role
{
    Name = "ç®¡ç†å‘˜",
    Description = "ä¼ä¸šç®¡ç†å‘˜ï¼Œæ‹¥æœ‰æ‰€æœ‰æƒé™",
    CompanyId = company.Id!,  // âœ… å¿…é¡»è®¾ç½®ä¼ä¸šID
    PermissionIds = permissionList.Select(p => p.Id!).ToList(),
    MenuIds = defaultMenus.Select(m => m.Id!).ToList()
};
```

### 4. é»˜è®¤èœå•ï¼ˆ3ä¸ªï¼‰
```csharp
// èœå•å¿…é¡»è®¾ç½® CompanyId
var menus = new List<Menu>
{
    new Menu { Name = "dashboard", Title = "ä»ªè¡¨æ¿", CompanyId = companyId },
    new Menu { Name = "user-management", Title = "ç”¨æˆ·ç®¡ç†", CompanyId = companyId },
    new Menu { Name = "system-settings", Title = "ç³»ç»Ÿè®¾ç½®", CompanyId = companyId }
};
```

### 5. ç”¨æˆ·-ä¼ä¸šå…³è”
```csharp
var userCompany = new UserCompany
{
    UserId = user.Id!,
    CompanyId = company.Id!,
    RoleIds = new List<string> { adminRole.Id! },
    IsAdmin = true,  // âœ… æ³¨å†Œç”¨æˆ·è‡ªåŠ¨æˆä¸ºç®¡ç†å‘˜
    Status = "active"
};
```

## ğŸš« ç¦æ­¢çš„åšæ³•

### âŒ é”™è¯¯ 1: åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶åˆ›å»ºé»˜è®¤ç”¨æˆ·
```csharp
// âŒ ç¦æ­¢ï¼šä¸è¦åœ¨ Program.cs ä¸­è‡ªåŠ¨åˆ›å»ºç”¨æˆ·
var createAdminUser = new CreateAdminUser(database);
await createAdminUser.CreateDefaultAdminAsync();
```

### âŒ é”™è¯¯ 2: åˆ›å»ºå…¨å±€æ•°æ®ï¼ˆæ²¡æœ‰ CompanyIdï¼‰
```csharp
// âŒ ç¦æ­¢ï¼šæ‰€æœ‰æ•°æ®å¿…é¡»æœ‰ CompanyId
var menu = new Menu
{
    Name = "dashboard",
    // âŒ ç¼ºå°‘ CompanyIdï¼Œä¼šæˆä¸ºå­¤å„¿æ•°æ®
};

// âœ… æ­£ç¡®ï¼šè®¾ç½® CompanyId
var menu = new Menu
{
    Name = "dashboard",
    CompanyId = company.Id!  // âœ… å¿…é¡»è®¾ç½®
};
```

### âŒ é”™è¯¯ 3: æ‰‹åŠ¨åˆ›å»ºä¼ä¸šæ•°æ®
```csharp
// âŒ ç¦æ­¢ï¼šä¸è¦æ‰‹åŠ¨åˆ›å»ºä¼ä¸šåˆå§‹åŒ–æ•°æ®
// åº”è¯¥ä½¿ç”¨æ³¨å†Œæµç¨‹ä¸­çš„è‡ªåŠ¨åˆ›å»ºé€»è¾‘
```

## âœ… æ­£ç¡®çš„å®ç°ä½ç½®

**å‚è€ƒå®ç°**: [AuthService.cs](mdc:Platform.ApiService/Services/AuthService.cs)

- `RegisterAsync()` - ç”¨æˆ·æ³¨å†Œå…¥å£
- `CreatePersonalCompanyAsync()` - ä¼ä¸šå’Œæ•°æ®è‡ªåŠ¨åˆ›å»ºï¼ˆä½¿ç”¨äº‹åŠ¡ï¼‰

## ğŸ”§ äº‹åŠ¡ä¿æŠ¤

æ‰€æœ‰æ•°æ®åˆ›å»ºå¿…é¡»åœ¨ MongoDB äº‹åŠ¡ä¸­æ‰§è¡Œï¼š

```csharp
using var session = await _database.Client.StartSessionAsync();
session.StartTransaction();

try
{
    // 1. åˆ›å»ºä¼ä¸š
    await companies.InsertOneAsync(session, company);
    
    // 2. åˆ›å»ºæƒé™
    await permissions.InsertManyAsync(session, permissionList);
    
    // 3. åˆ›å»ºè§’è‰²
    await roles.InsertOneAsync(session, adminRole);
    
    // 4. åˆ›å»ºèœå•
    await menus.InsertManyAsync(session, defaultMenus);
    
    // 5. åˆ›å»ºç”¨æˆ·-ä¼ä¸šå…³è”
    await userCompanies.InsertOneAsync(session, userCompany);
    
    // æäº¤äº‹åŠ¡
    await session.CommitTransactionAsync();
}
catch
{
    // å›æ»šäº‹åŠ¡
    await session.AbortTransactionAsync();
    throw;
}
```

## ğŸ“ æ–°å¢ç”¨æˆ·æ³¨å†Œæ—¶çš„æ£€æŸ¥æ¸…å•

å½“å®ç°æˆ–ä¿®æ”¹ç”¨æˆ·æ³¨å†Œé€»è¾‘æ—¶ï¼Œç¡®ä¿ï¼š

- [ ] åˆ›å»ºä¸ªäººä¼ä¸šï¼ˆåç§°ï¼š"{username} çš„ä¼ä¸š"ï¼‰
- [ ] åˆ›å»º28ä¸ªé»˜è®¤æƒé™ï¼ˆè®¾ç½® CompanyIdï¼‰
- [ ] åˆ›å»ºç®¡ç†å‘˜è§’è‰²ï¼ˆè®¾ç½® CompanyIdï¼‰
- [ ] åˆ›å»º3ä¸ªé»˜è®¤èœå•ï¼ˆè®¾ç½® CompanyIdï¼‰
- [ ] åˆ›å»ºç”¨æˆ·-ä¼ä¸šå…³è”ï¼ˆIsAdmin = trueï¼‰
- [ ] ä½¿ç”¨ MongoDB äº‹åŠ¡ä¿æŠ¤æ•°æ®ä¸€è‡´æ€§
- [ ] æ‰€æœ‰æ•°æ®éƒ½è®¾ç½®äº†æ­£ç¡®çš„ CompanyId

## ğŸ¯ æ ¸å¿ƒåŸåˆ™é‡ç”³

1. **ç”¨æˆ·è‡ªä¸»æ³¨å†Œ** - ä¸è‡ªåŠ¨åˆ›å»ºä»»ä½•é»˜è®¤ç”¨æˆ·
2. **ä¼ä¸šè‡ªåŠ¨åˆ›å»º** - æ¯ä¸ªç”¨æˆ·æ³¨å†Œæ—¶è‡ªåŠ¨åˆ›å»ºä¸ªäººä¼ä¸š
3. **è‡ªåŠ¨æˆä¸ºç®¡ç†å‘˜** - æ³¨å†Œç”¨æˆ·è‡ªåŠ¨æˆä¸ºå…¶ä¼ä¸šçš„ç®¡ç†å‘˜
4. **æ•°æ®å®Œå…¨éš”ç¦»** - æ‰€æœ‰æ•°æ®éƒ½æœ‰æ˜ç¡®çš„ CompanyId
5. **äº‹åŠ¡ä¿æŠ¤** - ç¡®ä¿æ•°æ®åˆ›å»ºçš„åŸå­æ€§

éµå¾ªè¿™äº›è§„èŒƒï¼Œç¡®ä¿å¤šç§Ÿæˆ·ç³»ç»Ÿçš„æ•°æ®éš”ç¦»å’Œä¸€è‡´æ€§ï¼

