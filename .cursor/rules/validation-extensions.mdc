---
globs: Platform.ApiService/Services/*.cs,Platform.ServiceDefaults/Services/*.cs
description: å‚æ•°éªŒè¯è§„èŒƒ - ä½¿ç”¨ ValidationExtensions æ‰©å±•æ–¹æ³•
---
# å‚æ•°éªŒè¯è§„èŒƒ - ä½¿ç”¨ ValidationExtensions æ‰©å±•æ–¹æ³•

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

### ä½¿ç”¨ç»Ÿä¸€çš„ ValidationExtensions æ‰©å±•æ–¹æ³•è¿›è¡Œå‚æ•°éªŒè¯ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œå®‰å…¨æ€§

## âœ… éªŒè¯æ‰©å±•æ–¹æ³•

### åŸºç¡€éªŒè¯æ‰©å±•

```csharp
// Platform.ServiceDefaults/Extensions/ValidationExtensions.cs
public static class ValidationExtensions
{
    /// <summary>
    /// éªŒè¯å­—ç¬¦ä¸²ä¸ä¸ºç©º
    /// </summary>
    public static string ValidateNotEmpty(this string value, string parameterName)
    {
        if (string.IsNullOrWhiteSpace(value))
            throw new ArgumentException($"{parameterName} ä¸èƒ½ä¸ºç©º", parameterName);
        return value;
    }

    /// <summary>
    /// éªŒè¯å­—ç¬¦ä¸²é•¿åº¦
    /// </summary>
    public static string ValidateLength(this string value, int minLength, int maxLength, string parameterName)
    {
        if (string.IsNullOrEmpty(value))
            throw new ArgumentException($"{parameterName} ä¸èƒ½ä¸ºç©º", parameterName);

        if (value.Length < minLength)
            throw new ArgumentException($"{parameterName} é•¿åº¦ä¸èƒ½å°‘äº {minLength} ä¸ªå­—ç¬¦", parameterName);

        if (value.Length > maxLength)
            throw new ArgumentException($"{parameterName} é•¿åº¦ä¸èƒ½è¶…è¿‡ {maxLength} ä¸ªå­—ç¬¦", parameterName);

        return value;
    }

    /// <summary>
    /// éªŒè¯é‚®ç®±æ ¼å¼
    /// </summary>
    public static string ValidateEmail(this string value, string parameterName)
    {
        if (string.IsNullOrWhiteSpace(value))
            throw new ArgumentException($"{parameterName} ä¸èƒ½ä¸ºç©º", parameterName);

        try
        {
            var addr = new System.Net.Mail.MailAddress(value);
            if (addr.Address != value)
                throw new ArgumentException($"{parameterName} æ ¼å¼ä¸æ­£ç¡®", parameterName);
        }
        catch
        {
            throw new ArgumentException($"{parameterName} æ ¼å¼ä¸æ­£ç¡®", parameterName);
        }

        return value;
    }

    /// <summary>
    /// éªŒè¯ç”¨æˆ·åæ ¼å¼
    /// </summary>
    public static string ValidateUsername(this string value, string parameterName)
    {
        if (string.IsNullOrWhiteSpace(value))
            throw new ArgumentException($"{parameterName} ä¸èƒ½ä¸ºç©º", parameterName);

        if (value.Length < 3 || value.Length > 50)
            throw new ArgumentException($"{parameterName} é•¿åº¦å¿…é¡»åœ¨3-50ä¸ªå­—ç¬¦ä¹‹é—´", parameterName);

        if (!value.All(c => char.IsLetterOrDigit(c) || c == '_'))
            throw new ArgumentException($"{parameterName} åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿", parameterName);

        return value;
    }

    /// <summary>
    /// éªŒè¯å¯†ç å¼ºåº¦
    /// </summary>
    public static string ValidatePassword(this string value, string parameterName)
    {
        if (string.IsNullOrWhiteSpace(value))
            throw new ArgumentException($"{parameterName} ä¸èƒ½ä¸ºç©º", parameterName);

        if (value.Length < 8)
            throw new ArgumentException($"{parameterName} é•¿åº¦ä¸èƒ½å°‘äº8ä¸ªå­—ç¬¦", parameterName);

        var hasLetter = value.Any(char.IsLetter);
        var hasDigit = value.Any(char.IsDigit);
        var hasSpecialChar = value.Any(c => !char.IsLetterOrDigit(c));

        if (!hasLetter)
            throw new ArgumentException($"{parameterName} å¿…é¡»åŒ…å«å­—æ¯", parameterName);

        if (!hasDigit)
            throw new ArgumentException($"{parameterName} å¿…é¡»åŒ…å«æ•°å­—", parameterName);

        if (!hasSpecialChar)
            throw new ArgumentException($"{parameterName} å¿…é¡»åŒ…å«ç‰¹æ®Šå­—ç¬¦", parameterName);

        return value;
    }

    /// <summary>
    /// éªŒè¯å¯¹è±¡IDæ ¼å¼
    /// </summary>
    public static string ValidateObjectId(this string value, string parameterName)
    {
        if (string.IsNullOrWhiteSpace(value))
            throw new ArgumentException($"{parameterName} ä¸èƒ½ä¸ºç©º", parameterName);

        if (!ObjectId.TryParse(value, out _))
            throw new ArgumentException($"{parameterName} æ ¼å¼ä¸æ­£ç¡®", parameterName);

        return value;
    }

    /// <summary>
    /// éªŒè¯æ•°å€¼èŒƒå›´
    /// </summary>
    public static T ValidateRange<T>(this T value, T minValue, T maxValue, string parameterName) where T : IComparable<T>
    {
        if (value.CompareTo(minValue) < 0)
            throw new ArgumentException($"{parameterName} ä¸èƒ½å°äº {minValue}", parameterName);

        if (value.CompareTo(maxValue) > 0)
            throw new ArgumentException($"{parameterName} ä¸èƒ½å¤§äº {maxValue}", parameterName);

        return value;
    }

    /// <summary>
    /// éªŒè¯é›†åˆä¸ä¸ºç©º
    /// </summary>
    public static IEnumerable<T> ValidateNotEmpty<T>(this IEnumerable<T> value, string parameterName)
    {
        if (value == null || !value.Any())
            throw new ArgumentException($"{parameterName} ä¸èƒ½ä¸ºç©º", parameterName);

        return value;
    }

    /// <summary>
    /// éªŒè¯é›†åˆæ•°é‡
    /// </summary>
    public static IEnumerable<T> ValidateCount<T>(this IEnumerable<T> value, int minCount, int maxCount, string parameterName)
    {
        if (value == null)
            throw new ArgumentException($"{parameterName} ä¸èƒ½ä¸ºç©º", parameterName);

        var count = value.Count();
        if (count < minCount)
            throw new ArgumentException($"{parameterName} æ•°é‡ä¸èƒ½å°‘äº {minCount}", parameterName);

        if (count > maxCount)
            throw new ArgumentException($"{parameterName} æ•°é‡ä¸èƒ½è¶…è¿‡ {maxCount}", parameterName);

        return value;
    }
}
```

### ä¸šåŠ¡éªŒè¯æ‰©å±•

```csharp
// Platform.ApiService/Extensions/BusinessValidationExtensions.cs
public static class BusinessValidationExtensions
{
    /// <summary>
    /// éªŒè¯ç”¨æˆ·åˆ›å»ºè¯·æ±‚
    /// </summary>
    public static CreateUserRequest ValidateCreateUserRequest(this CreateUserRequest request)
    {
        if (request == null)
            throw new ArgumentNullException(nameof(request));

        request.Username.ValidateUsername(nameof(request.Username));
        request.Email.ValidateEmail(nameof(request.Email));
        request.Password.ValidatePassword(nameof(request.Password));

        return request;
    }

    /// <summary>
    /// éªŒè¯ç”¨æˆ·æ›´æ–°è¯·æ±‚
    /// </summary>
    public static UpdateUserRequest ValidateUpdateUserRequest(this UpdateUserRequest request)
    {
        if (request == null)
            throw new ArgumentNullException(nameof(request));

        request.Id.ValidateObjectId(nameof(request.Id));

        if (!string.IsNullOrEmpty(request.Username))
            request.Username.ValidateUsername(nameof(request.Username));

        if (!string.IsNullOrEmpty(request.Email))
            request.Email.ValidateEmail(nameof(request.Email));

        return request;
    }

    /// <summary>
    /// éªŒè¯è§’è‰²åˆ›å»ºè¯·æ±‚
    /// </summary>
    public static CreateRoleRequest ValidateCreateRoleRequest(this CreateRoleRequest request)
    {
        if (request == null)
            throw new ArgumentNullException(nameof(request));

        request.Name.ValidateNotEmpty(nameof(request.Name))
            .ValidateLength(2, 50, nameof(request.Name));

        if (!string.IsNullOrEmpty(request.Description))
            request.Description.ValidateLength(0, 200, nameof(request.Description));

        return request;
    }

    /// <summary>
    /// éªŒè¯ä¼ä¸šåˆ›å»ºè¯·æ±‚
    /// </summary>
    public static CreateCompanyRequest ValidateCreateCompanyRequest(this CreateCompanyRequest request)
    {
        if (request == null)
            throw new ArgumentNullException(nameof(request));

        request.Name.ValidateNotEmpty(nameof(request.Name))
            .ValidateLength(2, 100, nameof(request.Name));

        if (!string.IsNullOrEmpty(request.Code))
            request.Code.ValidateLength(2, 20, nameof(request.Code));

        if (!string.IsNullOrEmpty(request.Description))
            request.Description.ValidateLength(0, 500, nameof(request.Description));

        return request;
    }

    /// <summary>
    /// éªŒè¯åˆ†é¡µè¯·æ±‚
    /// </summary>
    public static T ValidatePagination<T>(this T request) where T : IPaginationRequest
    {
        if (request == null)
            throw new ArgumentNullException(nameof(request));

        if (request.Page.HasValue)
            request.Page.Value.ValidateRange(1, int.MaxValue, nameof(request.Page));

        if (request.PageSize.HasValue)
            request.PageSize.Value.ValidateRange(1, 1000, nameof(request.PageSize));

        return request;
    }
}
```

## ğŸ¯ æœåŠ¡ä¸­ä½¿ç”¨éªŒè¯æ‰©å±•

### ç”¨æˆ·æœåŠ¡éªŒè¯

```csharp
// âœ… æ­£ç¡® - ä½¿ç”¨éªŒè¯æ‰©å±•
public class UserService : IUserService
{
    private readonly IDatabaseOperationFactory<User> _userFactory;
    private readonly IUniquenessChecker _uniquenessChecker;

    public UserService(
        IDatabaseOperationFactory<User> userFactory,
        IUniquenessChecker uniquenessChecker)
    {
        _userFactory = userFactory;
        _uniquenessChecker = uniquenessChecker;
    }

    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // 1. ä½¿ç”¨éªŒè¯æ‰©å±•è¿›è¡Œå‚æ•°éªŒè¯
        request.ValidateCreateUserRequest();
        
        // 2. æ£€æŸ¥å”¯ä¸€æ€§
        await _uniquenessChecker.EnsureUniqueAsync<User>(u => u.Username, request.Username);
        await _uniquenessChecker.EnsureUniqueAsync<User>(u => u.Email, request.Email);
        
        // 3. åˆ›å»ºç”¨æˆ·å®ä½“
        var user = new User
        {
            Username = request.Username.Trim(),
            Email = request.Email.Trim().ToLowerInvariant(),
            CompanyId = _userFactory.GetRequiredCompanyId(),
            CreatedBy = _userFactory.GetCurrentUserId(),
            CreatedAt = DateTime.UtcNow
        };
        
        return await _userFactory.CreateAsync(user);
    }

    public async Task<User?> GetUserByIdAsync(string id)
    {
        // ä½¿ç”¨éªŒè¯æ‰©å±•éªŒè¯ID
        id.ValidateObjectId(nameof(id));
        
        return await _userFactory.GetByIdAsync(id);
    }

    public async Task<bool> UpdateUserAsync(UpdateUserRequest request)
    {
        // 1. ä½¿ç”¨éªŒè¯æ‰©å±•è¿›è¡Œå‚æ•°éªŒè¯
        request.ValidateUpdateUserRequest();
        
        // 2. è·å–ç°æœ‰ç”¨æˆ·
        var existingUser = await _userFactory.GetByIdAsync(request.Id);
        if (existingUser == null)
        {
            throw new KeyNotFoundException($"ç”¨æˆ· {request.Id} ä¸å­˜åœ¨");
        }

        // 3. æ£€æŸ¥å”¯ä¸€æ€§ï¼ˆå¦‚æœéœ€è¦ï¼‰
        if (!string.IsNullOrEmpty(request.Username) && request.Username != existingUser.Username)
        {
            await _uniquenessChecker.EnsureUniqueAsync<User>(u => u.Username, request.Username);
        }
        
        if (!string.IsNullOrEmpty(request.Email) && request.Email != existingUser.Email)
        {
            await _uniquenessChecker.EnsureUniqueAsync<User>(u => u.Email, request.Email);
        }

        // 4. æ„å»ºæ›´æ–°æ“ä½œ
        var update = _userFactory.CreateUpdateBuilder()
            .SetCurrentTimestamp()
            .SetOperationTracking(_userFactory.GetCurrentUserId(), _userFactory.GetCurrentUsername())
            .Build();

        if (!string.IsNullOrEmpty(request.Username))
        {
            update = _userFactory.CreateUpdateBuilder()
                .Set(u => u.Username, request.Username)
                .SetCurrentTimestamp()
                .SetOperationTracking(_userFactory.GetCurrentUserId(), _userFactory.GetCurrentUsername())
                .Build();
        }

        if (!string.IsNullOrEmpty(request.Email))
        {
            update = _userFactory.CreateUpdateBuilder()
                .Set(u => u.Email, request.Email)
                .SetCurrentTimestamp()
                .SetOperationTracking(_userFactory.GetCurrentUserId(), _userFactory.GetCurrentUsername())
                .Build();
        }

        // 5. æ‰§è¡Œæ›´æ–°
        return await _userFactory.UpdateAsync(existingUser, new OperationContext
        {
            UserId = _userFactory.GetCurrentUserId(),
            Username = _userFactory.GetCurrentUsername(),
            CompanyId = _userFactory.GetCurrentCompanyId(),
            OperationType = OperationType.Update,
            Description = "æ›´æ–°ç”¨æˆ·ä¿¡æ¯"
        });
    }

    public async Task<List<User>> GetUsersAsync(UserListRequest request)
    {
        // ä½¿ç”¨éªŒè¯æ‰©å±•éªŒè¯åˆ†é¡µå‚æ•°
        request.ValidatePagination();
        
        // æ„å»ºæŸ¥è¯¢æ¡ä»¶
        var filter = _userFactory.CreateFilterBuilder()
            .ExcludeDeleted()
            .WithTenant()
            .Build();

        // æ·»åŠ æœç´¢æ¡ä»¶
        if (!string.IsNullOrEmpty(request.Keyword))
        {
            var searchFilter = _userFactory.CreateFilterBuilder()
                .Regex(u => u.Username, request.Keyword)
                .Or()
                .Regex(u => u.Email, request.Keyword)
                .Build();
            
            filter = _userFactory.CreateFilterBuilder()
                .And(filter)
                .And(searchFilter)
                .Build();
        }

        // æ„å»ºæ’åº
        var sort = _userFactory.CreateSortBuilder()
            .Descending(u => u.CreatedAt)
            .Build();

        // æ‰§è¡ŒæŸ¥è¯¢
        var limit = Math.Min(request.Limit ?? DEFAULT_PAGE_SIZE, MAX_PAGE_SIZE);
        return await _userFactory.FindAsync(filter, sort, limit);
    }
}

// âŒ é”™è¯¯ - æ²¡æœ‰ä½¿ç”¨éªŒè¯æ‰©å±•
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // æ‰‹åŠ¨éªŒè¯ï¼ˆå®¹æ˜“é—æ¼ï¼‰
        if (string.IsNullOrEmpty(request.Username))
            throw new ArgumentException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");
        
        if (string.IsNullOrEmpty(request.Email))
            throw new ArgumentException("é‚®ç®±ä¸èƒ½ä¸ºç©º");
        
        // æ²¡æœ‰ä½¿ç”¨ç»Ÿä¸€çš„éªŒè¯æ‰©å±•
        var user = new User
        {
            Username = request.Username,
            Email = request.Email
        };
        
        return await _userFactory.CreateAsync(user);
    }
}
```

### è§’è‰²æœåŠ¡éªŒè¯

```csharp
// âœ… æ­£ç¡® - ä½¿ç”¨éªŒè¯æ‰©å±•
public class RoleService : IRoleService
{
    private readonly IDatabaseOperationFactory<Role> _roleFactory;

    public RoleService(IDatabaseOperationFactory<Role> roleFactory)
    {
        _roleFactory = roleFactory;
    }

    public async Task<Role> CreateRoleAsync(CreateRoleRequest request)
    {
        // 1. ä½¿ç”¨éªŒè¯æ‰©å±•è¿›è¡Œå‚æ•°éªŒè¯
        request.ValidateCreateRoleRequest();
        
        // 2. æ£€æŸ¥æƒé™
        var currentUserId = _roleFactory.GetRequiredUserId();
        var currentUser = await _userFactory.GetByIdAsync(currentUserId);
        if (currentUser == null || !currentUser.IsAdmin)
        {
            throw new UnauthorizedAccessException("éœ€è¦ç®¡ç†å‘˜æƒé™");
        }

        // 3. åˆ›å»ºè§’è‰²å®ä½“
        var role = new Role
        {
            Name = request.Name.Trim(),
            Description = request.Description?.Trim(),
            CompanyId = _roleFactory.GetRequiredCompanyId(),
            CreatedBy = currentUserId,
            CreatedAt = DateTime.UtcNow
        };
        
        return await _roleFactory.CreateAsync(role);
    }

    public async Task<Role?> GetRoleByIdAsync(string id)
    {
        // ä½¿ç”¨éªŒè¯æ‰©å±•éªŒè¯ID
        id.ValidateObjectId(nameof(id));
        
        return await _roleFactory.GetByIdAsync(id);
    }

    public async Task<bool> UpdateRoleAsync(UpdateRoleRequest request)
    {
        // 1. ä½¿ç”¨éªŒè¯æ‰©å±•è¿›è¡Œå‚æ•°éªŒè¯
        request.Id.ValidateObjectId(nameof(request.Id));
        
        if (!string.IsNullOrEmpty(request.Name))
            request.Name.ValidateLength(2, 50, nameof(request.Name));

        if (!string.IsNullOrEmpty(request.Description))
            request.Description.ValidateLength(0, 200, nameof(request.Description));

        // 2. è·å–ç°æœ‰è§’è‰²
        var existingRole = await _roleFactory.GetByIdAsync(request.Id);
        if (existingRole == null)
        {
            throw new KeyNotFoundException($"è§’è‰² {request.Id} ä¸å­˜åœ¨");
        }

        // 3. æ£€æŸ¥æƒé™
        var currentUserId = _roleFactory.GetRequiredUserId();
        var currentUser = await _userFactory.GetByIdAsync(currentUserId);
        if (currentUser == null || !currentUser.IsAdmin)
        {
            throw new UnauthorizedAccessException("éœ€è¦ç®¡ç†å‘˜æƒé™");
        }

        // 4. æ„å»ºæ›´æ–°æ“ä½œ
        var update = _roleFactory.CreateUpdateBuilder()
            .SetCurrentTimestamp()
            .SetOperationTracking(currentUserId, currentUser.Username)
            .Build();

        if (!string.IsNullOrEmpty(request.Name))
        {
            update = _roleFactory.CreateUpdateBuilder()
                .Set(r => r.Name, request.Name)
                .SetCurrentTimestamp()
                .SetOperationTracking(currentUserId, currentUser.Username)
                .Build();
        }

        if (!string.IsNullOrEmpty(request.Description))
        {
            update = _roleFactory.CreateUpdateBuilder()
                .Set(r => r.Description, request.Description)
                .SetCurrentTimestamp()
                .SetOperationTracking(currentUserId, currentUser.Username)
                .Build();
        }

        // 5. æ‰§è¡Œæ›´æ–°
        return await _roleFactory.UpdateAsync(existingRole, new OperationContext
        {
            UserId = currentUserId,
            Username = currentUser.Username,
            CompanyId = currentUser.CompanyId,
            OperationType = OperationType.Update,
            Description = "æ›´æ–°è§’è‰²ä¿¡æ¯"
        });
    }
}
```

### ä¼ä¸šæœåŠ¡éªŒè¯

```csharp
// âœ… æ­£ç¡® - ä½¿ç”¨éªŒè¯æ‰©å±•
public class CompanyService : ICompanyService
{
    private readonly IDatabaseOperationFactory<Company> _companyFactory;

    public CompanyService(IDatabaseOperationFactory<Company> companyFactory)
    {
        _companyFactory = companyFactory;
    }

    public async Task<Company> CreateCompanyAsync(CreateCompanyRequest request)
    {
        // 1. ä½¿ç”¨éªŒè¯æ‰©å±•è¿›è¡Œå‚æ•°éªŒè¯
        request.ValidateCreateCompanyRequest();
        
        // 2. æ£€æŸ¥æƒé™
        var currentUserId = _companyFactory.GetRequiredUserId();
        var currentUser = await _userFactory.GetByIdAsync(currentUserId);
        if (currentUser == null || !currentUser.IsAdmin)
        {
            throw new UnauthorizedAccessException("éœ€è¦ç®¡ç†å‘˜æƒé™");
        }

        // 3. åˆ›å»ºä¼ä¸šå®ä½“
        var company = new Company
        {
            Name = request.Name.Trim(),
            Code = request.Code?.Trim(),
            Description = request.Description?.Trim(),
            CreatedBy = currentUserId,
            CreatedAt = DateTime.UtcNow
        };
        
        return await _companyFactory.CreateAsync(company);
    }

    public async Task<Company?> GetCompanyByIdAsync(string id)
    {
        // ä½¿ç”¨éªŒè¯æ‰©å±•éªŒè¯ID
        id.ValidateObjectId(nameof(id));
        
        return await _companyFactory.GetByIdAsync(id);
    }

    public async Task<List<Company>> GetCompaniesAsync(CompanyListRequest request)
    {
        // ä½¿ç”¨éªŒè¯æ‰©å±•éªŒè¯åˆ†é¡µå‚æ•°
        request.ValidatePagination();
        
        // æ„å»ºæŸ¥è¯¢æ¡ä»¶
        var filter = _companyFactory.CreateFilterBuilder()
            .ExcludeDeleted()
            .WithTenant()
            .Build();

        // æ·»åŠ æœç´¢æ¡ä»¶
        if (!string.IsNullOrEmpty(request.Keyword))
        {
            var searchFilter = _companyFactory.CreateFilterBuilder()
                .Regex(c => c.Name, request.Keyword)
                .Or()
                .Regex(c => c.Code, request.Keyword)
                .Build();
            
            filter = _companyFactory.CreateFilterBuilder()
                .And(filter)
                .And(searchFilter)
                .Build();
        }

        // æ„å»ºæ’åº
        var sort = _companyFactory.CreateSortBuilder()
            .Descending(c => c.CreatedAt)
            .Build();

        // æ‰§è¡ŒæŸ¥è¯¢
        var limit = Math.Min(request.Limit ?? DEFAULT_PAGE_SIZE, MAX_PAGE_SIZE);
        return await _companyFactory.FindAsync(filter, sort, limit);
    }
}
```

## ğŸ¯ è‡ªå®šä¹‰éªŒè¯æ‰©å±•

### ä¸šåŠ¡ç‰¹å®šéªŒè¯

```csharp
// Platform.ApiService/Extensions/CustomValidationExtensions.cs
public static class CustomValidationExtensions
{
    /// <summary>
    /// éªŒè¯ç”¨æˆ·çŠ¶æ€
    /// </summary>
    public static string ValidateUserStatus(this string status, string parameterName)
    {
        if (string.IsNullOrWhiteSpace(status))
            throw new ArgumentException($"{parameterName} ä¸èƒ½ä¸ºç©º", parameterName);

        var validStatuses = new[] { "active", "inactive", "pending", "suspended" };
        if (!validStatuses.Contains(status.ToLowerInvariant()))
            throw new ArgumentException($"{parameterName} å¿…é¡»æ˜¯ä»¥ä¸‹å€¼ä¹‹ä¸€: {string.Join(", ", validStatuses)}", parameterName);

        return status;
    }

    /// <summary>
    /// éªŒè¯è§’è‰²æƒé™
    /// </summary>
    public static List<string> ValidateRolePermissions(this List<string> permissions, string parameterName)
    {
        if (permissions == null)
            throw new ArgumentNullException(parameterName);

        var validPermissions = new[] { "read", "write", "delete", "admin" };
        var invalidPermissions = permissions.Where(p => !validPermissions.Contains(p.ToLowerInvariant())).ToList();
        
        if (invalidPermissions.Any())
            throw new ArgumentException($"{parameterName} åŒ…å«æ— æ•ˆæƒé™: {string.Join(", ", invalidPermissions)}", parameterName);

        return permissions;
    }

    /// <summary>
    /// éªŒè¯ä¼ä¸šä»£ç æ ¼å¼
    /// </summary>
    public static string ValidateCompanyCode(this string code, string parameterName)
    {
        if (string.IsNullOrWhiteSpace(code))
            throw new ArgumentException($"{parameterName} ä¸èƒ½ä¸ºç©º", parameterName);

        if (code.Length < 2 || code.Length > 20)
            throw new ArgumentException($"{parameterName} é•¿åº¦å¿…é¡»åœ¨2-20ä¸ªå­—ç¬¦ä¹‹é—´", parameterName);

        if (!code.All(c => char.IsLetterOrDigit(c) || c == '-' || c == '_'))
            throw new ArgumentException($"{parameterName} åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€è¿å­—ç¬¦å’Œä¸‹åˆ’çº¿", parameterName);

        return code;
    }

    /// <summary>
    /// éªŒè¯æ–‡ä»¶æ‰©å±•å
    /// </summary>
    public static string ValidateFileExtension(this string fileName, string[] allowedExtensions, string parameterName)
    {
        if (string.IsNullOrWhiteSpace(fileName))
            throw new ArgumentException($"{parameterName} ä¸èƒ½ä¸ºç©º", parameterName);

        var extension = Path.GetExtension(fileName).ToLowerInvariant();
        if (!allowedExtensions.Contains(extension))
            throw new ArgumentException($"{parameterName} æ–‡ä»¶ç±»å‹ä¸æ”¯æŒï¼Œæ”¯æŒçš„æ ¼å¼: {string.Join(", ", allowedExtensions)}", parameterName);

        return fileName;
    }
}
```

## ğŸš« ç¦æ­¢çš„åšæ³•

### ä¸è¦æ‰‹åŠ¨éªŒè¯

```csharp
// âŒ é”™è¯¯ - æ‰‹åŠ¨éªŒè¯
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // æ‰‹åŠ¨éªŒè¯ï¼ˆå®¹æ˜“é—æ¼å’Œé‡å¤ï¼‰
        if (request == null)
            throw new ArgumentNullException(nameof(request));
        
        if (string.IsNullOrEmpty(request.Username))
            throw new ArgumentException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");
        
        if (request.Username.Length < 3 || request.Username.Length > 50)
            throw new ArgumentException("ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¸ªå­—ç¬¦ä¹‹é—´");
        
        if (!request.Username.All(c => char.IsLetterOrDigit(c) || c == '_'))
            throw new ArgumentException("ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿");
        
        // é‡å¤çš„éªŒè¯é€»è¾‘...
    }
}

// âœ… æ­£ç¡® - ä½¿ç”¨éªŒè¯æ‰©å±•
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // ä½¿ç”¨ç»Ÿä¸€çš„éªŒè¯æ‰©å±•
        request.ValidateCreateUserRequest();
        
        var user = new User
        {
            Username = request.Username.Trim(),
            Email = request.Email.Trim().ToLowerInvariant()
        };
        
        return await _userFactory.CreateAsync(user);
    }
}
```

### ä¸è¦å¿½ç•¥éªŒè¯

```csharp
// âŒ é”™è¯¯ - å¿½ç•¥éªŒè¯
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // æ²¡æœ‰éªŒè¯ç›´æ¥ä½¿ç”¨
        var user = new User
        {
            Username = request.Username,
            Email = request.Email
        };
        
        return await _userFactory.CreateAsync(user);
    }
}

// âœ… æ­£ç¡® - å®Œæ•´éªŒè¯
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // å®Œæ•´çš„å‚æ•°éªŒè¯
        request.ValidateCreateUserRequest();
        
        var user = new User
        {
            Username = request.Username.Trim(),
            Email = request.Email.Trim().ToLowerInvariant()
        };
        
        return await _userFactory.CreateAsync(user);
    }
}
```

### ä¸è¦é‡å¤éªŒè¯é€»è¾‘

```csharp
// âŒ é”™è¯¯ - é‡å¤éªŒè¯é€»è¾‘
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // é‡å¤çš„éªŒè¯é€»è¾‘
        if (string.IsNullOrEmpty(request.Username))
            throw new ArgumentException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");
        
        if (request.Username.Length < 3 || request.Username.Length > 50)
            throw new ArgumentException("ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¸ªå­—ç¬¦ä¹‹é—´");
    }

    public async Task<bool> UpdateUserAsync(UpdateUserRequest request)
    {
        // é‡å¤çš„éªŒè¯é€»è¾‘
        if (!string.IsNullOrEmpty(request.Username))
        {
            if (string.IsNullOrEmpty(request.Username))
                throw new ArgumentException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");
            
            if (request.Username.Length < 3 || request.Username.Length > 50)
                throw new ArgumentException("ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¸ªå­—ç¬¦ä¹‹é—´");
        }
    }
}

// âœ… æ­£ç¡® - ä½¿ç”¨éªŒè¯æ‰©å±•é¿å…é‡å¤
public class UserService : IUserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        // ä½¿ç”¨ç»Ÿä¸€çš„éªŒè¯æ‰©å±•
        request.ValidateCreateUserRequest();
    }

    public async Task<bool> UpdateUserAsync(UpdateUserRequest request)
    {
        // ä½¿ç”¨ç»Ÿä¸€çš„éªŒè¯æ‰©å±•
        request.ValidateUpdateUserRequest();
    }
}
```

## ğŸ“‹ å‚æ•°éªŒè¯æ£€æŸ¥æ¸…å•

åˆ›å»ºæˆ–ä¿®æ”¹æœåŠ¡æ—¶æ£€æŸ¥ï¼š

- [ ] ä½¿ç”¨ ValidationExtensions æ‰©å±•æ–¹æ³•
- [ ] éªŒè¯æ‰€æœ‰è¾“å…¥å‚æ•°
- [ ] ä½¿ç”¨ä¸šåŠ¡éªŒè¯æ‰©å±•
- [ ] é¿å…é‡å¤éªŒè¯é€»è¾‘
- [ ] éªŒè¯å‚æ•°æ ¼å¼å’ŒèŒƒå›´
- [ ] éªŒè¯ä¸šåŠ¡è§„åˆ™
- [ ] æä¾›æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯
- [ ] æµ‹è¯•éªŒè¯é€»è¾‘
- [ ] æ–‡æ¡£åŒ–éªŒè¯è§„åˆ™
- [ ] ä¿æŒéªŒè¯ä¸€è‡´æ€§

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç”¨æˆ·æœåŠ¡å®ç°](mdc:Platform.ApiService/Services/UserService.cs)
- [è§’è‰²æœåŠ¡å®ç°](mdc:Platform.ApiService/Services/RoleService.cs)
- [ä¼ä¸šæœåŠ¡å®ç°](mdc:Platform.ApiService/Services/CompanyService.cs)
- [éªŒè¯æ‰©å±•æ–¹æ³•](mdc:Platform.ServiceDefaults/Extensions/ValidationExtensions.cs)
