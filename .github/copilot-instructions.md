# Copilot Instructions for Aspire Admin

- **Architecture map**: Aspire solution with AppHost orchestrating MongoDB → DataInitializer → ApiService → YARP gateway (`/apiservice`) → Admin (React) → App (Expo). AppHost entry: `Platform.AppHost/AppHost.cs`; backend entry: `Platform.ApiService/Program.cs`.
- **Data access (hard rule)**: Never touch `IMongoCollection`/`IMongoDatabase` directly. Use `IDatabaseOperationFactory<T>` + builders (`CreateFilterBuilder/SortBuilder/UpdateBuilder/ProjectionBuilder`). Entities implement `IEntity` + `ISoftDeletable` + `ITimestamped`; multi-tenant entities implement `IMultiTenant`/`MultiTenantEntity` to auto-attach `CompanyId` and soft-delete filters.
- **Audit & soft delete**: CRUD must use factory atomics: `CreateAsync`, `FindOneAndUpdateAsync`, `FindOneAndSoftDeleteAsync`, `FindOneAndReplaceAsync`. Audit fields (Created/Updated/Deleted* & usernames) are auto-managed—do not set manually.
- **Permissions**: All sensitive endpoints require `[RequireMenu("module:resource")]`; avoid deprecated `HasPermission/RequirePermission`. JWT claims only provide `userId`; fetch enterprise/roles via `ITenantContext`. Menu definitions live in `Platform.DataInitializer/Services/DataInitializerService.cs` (names with `-`, permissions with `:`).
- **Controllers & responses**: Controllers inherit `BaseApiController`; return `ApiResponse<T>` via helpers (`Success`, `SuccessPaged`, `ValidationError`, etc.). JSON: camelCase, ignore null, enums as camelCase strings. Pagination params strictly `page`/`pageSize` (1–10000 / 1–100); validate and pass page directly to factory `FindPagedAsync` (no manual skip).
- **Middleware order (must keep)**: `UseExceptionHandler → UseCors → UseAuthentication → UseAuthorization → ActivityLogMiddleware → ResponseFormattingMiddleware → MapControllers`. SSE/health/OpenAPI endpoints bypass response formatting; SSE uses `text/event-stream`.
- **SSE real-time**: `/api/chat/sse` handled by `ChatSseConnectionManager` + `ChatBroadcaster`; events include ReceiveMessage/SessionUpdated/MessageDeleted/MessageChunk/keepalive. Heartbeat every 30s, clean up connections on disconnect.
- **Back-end references**: Core patterns in `Platform.ApiService/Controllers/*`, services in `Services/`, middleware in `Middleware/`, extensions in `Extensions/`. Rule/IoT modules follow same multi-tenant + builder patterns.
- **Admin (Platform.Admin)**: React 19 + Ant Design 6 (no ProComponents). All requests go through `src/services` + `@umijs/max` `request`; responses are `ApiResponse<T>`. Use hooks `useMessage/useModal/useNotification`, `open` prop for Modal/Drawer/Popconfirm, `destroyOnHidden` instead of `destroyOnClose`. SSE hook: `src/hooks/useSseConnection.ts`.
- **Admin layout conventions**: Pages use `PageContainer` with `style={{ paddingBlock: 12 }}`; action buttons in `extra` wrapped by `Space wrap` (order: bulk → refresh → secondary → primary). Lists use `DataTable` wrapper, `scroll={{ x: 'max-content' }}`, `search={false}` when using standalone search forms. Manage search params via `useRef` to avoid duplicate requests; pagination keys `page/pageSize`. Operation column fixed right, width ~150–200, buttons `type="link" size="small"` with icons; "view" via clickable first column, not action column.
- **Internationalization**: Menu labels/keys under `src/locales/*/menu.ts` with dotted keys `menu.module.resource`; page titles `pages.xxx.title` and icons per module (e.g., workflow `PartitionOutlined`, user `UserOutlined`).
- **Mobile App (Platform.App)**: Expo Router; API client `services/api.ts` (axios) aligned to `ApiResponse<T>`, token refresh via `TokenRefreshManager`; do not create new fetch clients. SSE via EventSource to `/api/chat/sse?token=...`; close on unmount.
- **Build/run**: Full stack: `dotnet run --project Platform.AppHost` (starts Mongo, DataInitializer, ApiService, gateway, frontends). Backend only: `dotnet run --project Platform.ApiService`. Admin dev: `(cd Platform.Admin && npm install && npm run start)`. Mobile dev: `(cd Platform.App && npm install && npm start)`. CI tasks available: `dotnet build Platform.sln` / `dotnet publish Platform.sln`.
- **Testing/lint**: `dotnet test Platform.AppHost.Tests`; Admin/App use Biome/ESLint via `npm run lint` (see package scripts). Keep XML docs intact for Scalar/OpenAPI.
- **Security & safety**: Never hardcode CompanyId/permissions; never bypass factory tenant filters except explicit `*WithoutTenantFilter*` ops with audit logging. Handle errors with user-friendly messages (no raw exceptions). Password book uses AES-256-GCM; treat secrets carefully.
- **Commit style**: Git commit messages must be Simplified Chinese, conventional format (`feat: ...`, `fix: ...`).
- **Key docs**: `.cursor/rules/*.mdc` (global/back-end/front-end/mobile rules), `docs/features/` (API response, backend rules, menu permission guide, SSE, database factory), root `README.md` for architecture & endpoints.
