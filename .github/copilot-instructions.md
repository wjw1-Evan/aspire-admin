# Copilot Instructions for Aspire Admin

- **Architecture map**: AppHost orchestrates MongoDB → DataInitializer → ApiService → YARP gateway (`/apiservice`) → Admin (React) → App (Expo). Entry points: `Platform.AppHost/AppHost.cs`, `Platform.ApiService/Program.cs`.
- **Data access (hard rule)**: Never touch `IMongoCollection/IMongoDatabase` directly. Use `IDatabaseOperationFactory<T>` with builders (`CreateFilterBuilder/SortBuilder/UpdateBuilder/ProjectionBuilder`). Entities implement `IEntity` + `ISoftDeletable` + `ITimestamped`; multi-tenant entities implement `IMultiTenant`/`MultiTenantEntity` so `CompanyId` and soft-delete filters auto-apply.
- **Audit & CRUD**: Always use factory atomics: `CreateAsync`, `FindOneAndUpdateAsync`, `FindOneAndSoftDeleteAsync`, `FindOneAndReplaceAsync`; audit fields are auto-managed—do not set manually.
- **Permissions**: Sensitive endpoints require `[RequireMenu("module:resource")]`; avoid deprecated `HasPermission/RequirePermission`. JWT only carries `userId`; resolve enterprise/roles via `ITenantContext`. Menus defined in `Platform.DataInitializer/Services/DataInitializerService.cs` (names with `-`, permissions with `:`).
- **Controllers & responses**: Inherit `BaseApiController`; return `ApiResponse<T>` via `Success/SuccessPaged/ValidationError/...`. JSON camelCase, ignore null, enums camelCase. Pagination params strictly `page/pageSize` (1–10000 / 1–100); pass `page` directly to factory `FindPagedAsync` (no manual skip math).
- **Middleware order (must keep)**: `UseExceptionHandler → UseCors → UseAuthentication → UseAuthorization → ActivityLogMiddleware → ResponseFormattingMiddleware → MapControllers`; health/OpenAPI/SSE bypass response formatting. SSE uses `text/event-stream`.
- **SSE real-time**: `/api/chat/sse` handled by `ChatSseConnectionManager` + `ChatBroadcaster`; events include ReceiveMessage/SessionUpdated/MessageDeleted/MessageChunk/keepalive; heartbeat every 30s; cleanup on disconnect.
- **Backend patterns**: See `Platform.ApiService/Controllers/*` + `Services/` + `Middleware/` + `Extensions/` for standard usage; IoT/Rule modules follow same multi-tenant + builder pattern. Keep XML docs for public APIs (Scalar/OpenAPI).
- **Admin (Platform.Admin)**: React 19 + Ant Design 6 (no ProComponents). All HTTP via `src/services` + `@umijs/max` `request` returning `ApiResponse<T>`; use hooks `useMessage/useModal/useNotification`; Modal/Drawer/Popconfirm use `open` + `destroyOnHidden`.
- **Admin layout conventions**: `PageContainer` with `style={{ paddingBlock: 12 }}`; actions in `extra` with `Space wrap` (order: bulk → refresh → secondary → primary). Lists use `DataTable`, `scroll={{ x: 'max-content' }}`, `search={false}` when separate form. Manage search params via `useRef` to avoid duplicate fetch; pagination keys `page/pageSize`; action column fixed right width ~150–200, buttons `type="link" size="small"` with icons; “view” via clickable first column.
- **i18n**: Menu keys in `src/locales/*/menu.ts` as `menu.module.resource`; page titles `pages.xxx.title` with icons (e.g., workflow `PartitionOutlined`, user `UserOutlined`).
- **Mobile App (Platform.App)**: Expo Router; single API client `services/api.ts` (axios) aligned to `ApiResponse<T>`, token refresh via `TokenRefreshManager`; no new fetch clients. SSE via EventSource to `/api/chat/sse?token=...` and close on unmount.
- **Build/run**: Full stack `dotnet run --project Platform.AppHost` (starts Mongo, DataInitializer, ApiService, gateway, frontends). Backend only `dotnet run --project Platform.ApiService`. Admin dev `(cd Platform.Admin && npm install && npm run start)`. Mobile dev `(cd Platform.App && npm install && npm start)`. CI: `dotnet build Platform.sln` / `dotnet publish Platform.sln`.
- **Testing/lint**: `dotnet test Platform.AppHost.Tests`; Admin/App lint via `npm run lint` (Biome/ESLint).
- **Security & safety**: Never hardcode `CompanyId`/permissions; don’t bypass tenant filters except explicit `*WithoutTenantFilter*` with audit logging. Friendly error messages, no raw exceptions. Password book uses AES-256-GCM—treat secrets carefully.
- **Commit style**: Git commits must be Simplified Chinese, conventional format (`feat: ...`, `fix: ...`).
- **Key docs**: `.cursor/rules/*.mdc` (global/backend/admin/app), `docs/features/` (API response, backend rules, menu permission, SSE, database factory), root `README.md` for architecture/endpoints.
