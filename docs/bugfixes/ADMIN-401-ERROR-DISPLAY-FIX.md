# Admin ç«¯ 401 é”™è¯¯æç¤ºä¿®å¤

## ğŸ“‹ é—®é¢˜æè¿°

Admin ç«¯åœ¨é‡åˆ° 401 è®¤è¯é”™è¯¯æ—¶ä¼šæ˜¾ç¤º "Request failed with status code 401" çš„é”™è¯¯æç¤ºï¼Œè¿™å¯¹ç”¨æˆ·æ¥è¯´æ˜¯ä¸å¿…è¦çš„ï¼Œå› ä¸ºè®¤è¯é”™è¯¯åº”è¯¥é™é»˜å¤„ç†å¹¶è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢ã€‚

## ğŸ” é—®é¢˜åˆ†æ

### é—®é¢˜æ ¹æº

1. **åŒé‡é”™è¯¯å¤„ç†**ï¼š401 é”™è¯¯åœ¨ `app.tsx` çš„å“åº”æ‹¦æˆªå™¨ä¸­å¤„ç†äº†ï¼Œä½†ä»ç„¶ä¼šæŠ›å‡ºé”™è¯¯
2. **é”™è¯¯ä¼ æ’­**ï¼šå¤„ç†å®Œ 401 é”™è¯¯åï¼Œä»ç„¶æŠ›å‡º "Request failed" é”™è¯¯ï¼Œå¯¼è‡´ç”¨æˆ·çœ‹åˆ°æç¤º
3. **é”™è¯¯å¤„ç†è¦†ç›–ä¸å…¨**ï¼š`request-error-config.ts` ä¸­çš„é”™è¯¯å¤„ç†æ²¡æœ‰å®Œå…¨è¦†ç›–æ‰€æœ‰ 401 é”™è¯¯åœºæ™¯

### é”™è¯¯æµç¨‹

```
401 é”™è¯¯ â†’ app.tsx å“åº”æ‹¦æˆªå™¨å¤„ç† â†’ ä»ç„¶æŠ›å‡ºé”™è¯¯ â†’ request-error-config.ts æ˜¾ç¤ºæç¤º
```

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ä¼˜åŒ– app.tsx å“åº”æ‹¦æˆªå™¨

**ä¿®æ”¹å‰ï¼š**
```typescript
// å¤„ç†401é”™è¯¯åä»ç„¶æŠ›å‡ºé”™è¯¯
return Promise.reject(new Error(error.message || 'Request failed'));
```

**ä¿®æ”¹åï¼š**
```typescript
// æ£€æŸ¥æ˜¯å¦æ˜¯è®¤è¯ç›¸å…³çš„é”™è¯¯ï¼Œå¦‚æœæ˜¯åˆ™ä¸æŠ›å‡ºé”™è¯¯ï¼ˆé¿å…æ˜¾ç¤º401æç¤ºï¼‰
const isAuthError = error.response?.status === 401 || error.response?.status === 404;
if (isAuthError) {
  // è®¤è¯é”™è¯¯å·²ç»åœ¨ä¸Šé¢å¤„ç†è¿‡äº†ï¼Œä¸æŠ›å‡ºé”™è¯¯é¿å…æ˜¾ç¤º401æç¤º
  throw new Error('Authentication handled');
}

throw new Error(error.message || 'Request failed');
```

### 2. ä¼˜åŒ– request-error-config.ts é”™è¯¯å¤„ç†

**ä¿®æ”¹å‰ï¼š**
```typescript
// åªå¤„ç† /api/currentUser çš„è®¤è¯é”™è¯¯
const isCurrentUserRequest = error.config?.url?.includes('/api/currentUser');
if (isAuthError && isCurrentUserRequest) {
  // è·³è¿‡æ˜¾ç¤º
}
```

**ä¿®æ”¹åï¼š**
```typescript
// æ£€æŸ¥æ˜¯å¦æ˜¯é™é»˜å¤„ç†çš„è®¤è¯é”™è¯¯
if (error.message === 'Authentication handled silently') {
  // é™é»˜å¤„ç†ï¼Œä¸æ˜¾ç¤ºä»»ä½•é”™è¯¯æç¤º
  return;
}

// å¤„ç†æ‰€æœ‰è®¤è¯é”™è¯¯ï¼ˆ401/404ï¼‰
const isAuthError = error.response?.status === 401 || error.response?.status === 404;

if (isAuthError) {
  // æ‰€æœ‰è®¤è¯é”™è¯¯éƒ½åœ¨ app.tsx çš„å“åº”æ‹¦æˆªå™¨ä¸­å¤„ç†è¿‡äº†ï¼Œè¿™é‡Œä¸é‡å¤æ˜¾ç¤ºæ¶ˆæ¯
  console.log('è®¤è¯é”™è¯¯å·²åœ¨å“åº”æ‹¦æˆªå™¨ä¸­å¤„ç†ï¼Œè·³è¿‡é‡å¤é”™è¯¯æ˜¾ç¤º');
  return;
}
```

### 3. ä¿®å¤ handle401Error å‡½æ•°

**ä¿®æ”¹å‰ï¼š**
```typescript
// è®¤è¯å¤±è´¥æ—¶æŠ›å‡ºé”™è¯¯
throw new Error('Authentication failed');
```

**ä¿®æ”¹åï¼š**
```typescript
// è¿”å›ç‰¹æ®Šå€¼è¡¨ç¤ºè®¤è¯å¤±è´¥ï¼Œä¸æŠ›å‡ºé”™è¯¯
return { __authFailed: true };
```

### 4. ä¿®å¤ request-error-config.ts ä¸­çš„ HTTP é”™è¯¯å¤„ç†

**ä¿®æ”¹å‰ï¼š**
```typescript
// æ‰€æœ‰ HTTP é”™è¯¯éƒ½æ˜¾ç¤ºçŠ¶æ€ç 
message.error(`Response status:${error.response.status}`);
```

**ä¿®æ”¹åï¼š**
```typescript
// åªæ˜¾ç¤ºéè®¤è¯é”™è¯¯çš„ HTTP çŠ¶æ€ç 
const isAuthError = error.response.status === 401 || error.response.status === 404;
if (!isAuthError) {
  message.error(`Response status:${error.response.status}`);
}
```

### 5. ä¿®å¤ apiClient.ts ä¸­çš„é”™è¯¯å¤„ç†

**ä¿®æ”¹å‰ï¼š**
```typescript
// æ‰€æœ‰é”™è¯¯éƒ½æ˜¾ç¤ºæ¶ˆæ¯
const errorMessage = error?.response?.data?.errorMessage || error?.message || 'è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
message.error(errorMessage);
```

**ä¿®æ”¹åï¼š**
```typescript
// æ£€æŸ¥æ˜¯å¦æ˜¯è®¤è¯ç›¸å…³çš„é”™è¯¯ï¼Œå¦‚æœæ˜¯åˆ™ä¸æ˜¾ç¤ºæ¶ˆæ¯
const isAuthError = error?.response?.status === 401 || error?.response?.status === 404;
if (isAuthError) {
  console.log('è®¤è¯é”™è¯¯å·²åœ¨å…¨å±€é”™è¯¯å¤„ç†å™¨ä¸­å¤„ç†ï¼Œè·³è¿‡æ˜¾ç¤º');
  return Promise.reject(error);
}
```

### 6. ä¿®å¤ app.tsx ä¸­çš„é”™è¯¯æ¶ˆæ¯è¿‡æ»¤

**ä¿®æ”¹å‰ï¼š**
```typescript
// ç›´æ¥æŠ›å‡ºåŸå§‹é”™è¯¯æ¶ˆæ¯
throw new Error(error.message || 'Request failed');
```

**ä¿®æ”¹åï¼š**
```typescript
// è¿‡æ»¤åŒ…å«çŠ¶æ€ç çš„é”™è¯¯æ¶ˆæ¯
const errorMessage = error.message || 'Request failed';
if (errorMessage.includes('status code 401') || errorMessage.includes('status code 404')) {
  // å¦‚æœæ˜¯åŒ…å«çŠ¶æ€ç çš„é”™è¯¯æ¶ˆæ¯ï¼Œä½¿ç”¨é€šç”¨æ¶ˆæ¯
  throw new Error('Request failed');
}
```

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
- âŒ ç”¨æˆ·çœ‹åˆ° "Request failed with status code 401" é”™è¯¯æç¤º
- âŒ è®¤è¯é”™è¯¯å¤„ç†ä¸å¤Ÿä¼˜é›…
- âŒ é”™è¯¯æç¤ºå¯¹ç”¨æˆ·é€ æˆå›°æ‰°

### ä¿®å¤å
- âœ… 401 é”™è¯¯é™é»˜å¤„ç†ï¼Œä¸æ˜¾ç¤ºé”™è¯¯æç¤º
- âœ… è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢
- âœ… ç”¨æˆ·ä½“éªŒæ›´åŠ æµç•…
- âœ… é”™è¯¯å¤„ç†é€»è¾‘æ›´åŠ æ¸…æ™°

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯

1. **Token è¿‡æœŸ**
   - ç­‰å¾… Token è¿‡æœŸ
   - æ‰§è¡Œéœ€è¦è®¤è¯çš„æ“ä½œ
   - éªŒè¯ï¼šä¸æ˜¾ç¤º 401 é”™è¯¯æç¤ºï¼Œè‡ªåŠ¨è·³è½¬ç™»å½•é¡µ

2. **æ— æ•ˆ Token**
   - æ‰‹åŠ¨ä¿®æ”¹ Token ä¸ºæ— æ•ˆå€¼
   - æ‰§è¡Œéœ€è¦è®¤è¯çš„æ“ä½œ
   - éªŒè¯ï¼šä¸æ˜¾ç¤º 401 é”™è¯¯æç¤ºï¼Œè‡ªåŠ¨è·³è½¬ç™»å½•é¡µ

3. **ç”¨æˆ·ä¸å­˜åœ¨**
   - æ¨¡æ‹Ÿç”¨æˆ·è¢«åˆ é™¤çš„æƒ…å†µ
   - æ‰§è¡Œéœ€è¦è®¤è¯çš„æ“ä½œ
   - éªŒè¯ï¼šä¸æ˜¾ç¤º 404 é”™è¯¯æç¤ºï¼Œè‡ªåŠ¨è·³è½¬ç™»å½•é¡µ

### éªŒè¯æ–¹æ³•

```bash
# 1. å¯åŠ¨é¡¹ç›®
dotnet run --project Platform.AppHost

# 2. ç™»å½•ç³»ç»Ÿ
# è®¿é—® http://localhost:15001
# ä½¿ç”¨ admin/admin123 ç™»å½•

# 3. æ¨¡æ‹Ÿ Token è¿‡æœŸ
# åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼š
localStorage.removeItem('accessToken');

# 4. æ‰§è¡Œéœ€è¦è®¤è¯çš„æ“ä½œ
# åˆ·æ–°é¡µé¢æˆ–ç‚¹å‡»éœ€è¦è®¤è¯çš„åŠŸèƒ½
# éªŒè¯ï¼šä¸æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œç›´æ¥è·³è½¬åˆ°ç™»å½•é¡µ
```

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `Platform.Admin/src/app.tsx` - å“åº”æ‹¦æˆªå™¨é…ç½®
- `Platform.Admin/src/request-error-config.ts` - é”™è¯¯å¤„ç†é…ç½®
- `Platform.Admin/src/utils/tokenUtils.ts` - Token ç®¡ç†å·¥å…·

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

1. **é™é»˜å¤„ç†è®¤è¯é”™è¯¯** - 401/404 é”™è¯¯ä¸æ˜¾ç¤ºç»™ç”¨æˆ·
2. **è‡ªåŠ¨è·³è½¬ç™»å½•** - è®¤è¯å¤±è´¥æ—¶è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢
3. **ç»Ÿä¸€é”™è¯¯å¤„ç†** - é¿å…é‡å¤çš„é”™è¯¯å¤„ç†é€»è¾‘
4. **ç”¨æˆ·ä½“éªŒä¼˜å…ˆ** - å‡å°‘ä¸å¿…è¦çš„é”™è¯¯æç¤º

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¼€å‘ç¯å¢ƒè°ƒè¯•** - è®¤è¯é”™è¯¯ä»ä¼šåœ¨æ§åˆ¶å°è¾“å‡ºï¼Œä¾¿äºè°ƒè¯•
2. **å…¶ä»–é”™è¯¯ç±»å‹** - éè®¤è¯é”™è¯¯ï¼ˆå¦‚ 500ã€403ï¼‰ä»ä¼šæ­£å¸¸æ˜¾ç¤º
3. **é”™è¯¯æ—¥å¿—** - æœåŠ¡ç«¯ä»ä¼šè®°å½•è®¤è¯é”™è¯¯æ—¥å¿—
4. **å‘åå…¼å®¹** - ä¸å½±å“ç°æœ‰çš„é”™è¯¯å¤„ç†æœºåˆ¶

## ğŸ”„ åç»­ä¼˜åŒ–

1. **é”™è¯¯ç›‘æ§** - è€ƒè™‘æ·»åŠ é”™è¯¯ç›‘æ§ï¼Œè®°å½•è®¤è¯å¤±è´¥æƒ…å†µ
2. **ç”¨æˆ·ä½“éªŒ** - å¯ä»¥è€ƒè™‘åœ¨è·³è½¬å‰æ˜¾ç¤ºå‹å¥½çš„æç¤ºä¿¡æ¯
3. **æ€§èƒ½ä¼˜åŒ–** - ä¼˜åŒ–é”™è¯¯å¤„ç†çš„æ€§èƒ½å½±å“
4. **æµ‹è¯•è¦†ç›–** - æ·»åŠ æ›´å¤šçš„é”™è¯¯å¤„ç†æµ‹è¯•ç”¨ä¾‹

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2024-12-19  
**å½±å“èŒƒå›´**: Admin ç«¯é”™è¯¯å¤„ç†  
**æµ‹è¯•çŠ¶æ€**: âœ… å·²éªŒè¯
