# macOSç³»ç»Ÿå†…å­˜è¯»å–é—®é¢˜ä¿®å¤

## ğŸ“‹ é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆå‰ç«¯æ˜¾ç¤ºçš„ç³»ç»Ÿæ€»å†…å­˜æ•°æ®æœ‰è¯¯ã€‚ç»è¿‡åˆ†æå‘ç°ï¼ŒWMIï¼ˆWindows Management Instrumentationï¼‰æ˜¯Windowsç‰¹æœ‰çš„APIï¼Œåœ¨macOSä¸Šä¸ä¼šå·¥ä½œï¼Œå¯¼è‡´ç³»ç»Ÿå†…å­˜æ•°æ®ä¸å‡†ç¡®ã€‚

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 
```csharp
// âŒ é—®é¢˜ï¼šWMIåœ¨macOSä¸Šä¸å·¥ä½œ
using (var searcher = new ManagementObjectSearcher("SELECT TotalPhysicalMemory FROM Win32_ComputerSystem"))
{
    // è¿™ä¸ªæŸ¥è¯¢åœ¨macOSä¸Šä¼šå¤±è´¥
}
```

**é—®é¢˜åˆ†æ**ï¼š
- WMIæ˜¯Windowsç‰¹æœ‰çš„APIï¼Œåœ¨macOS/Linuxä¸Šä¸å¯ç”¨
- å½“WMIæŸ¥è¯¢å¤±è´¥æ—¶ï¼Œä¼šè¿›å…¥catchå—ä½¿ç”¨GCä¼°ç®—
- GCä¼°ç®—çš„å€æ•°å¤ªå°ï¼ˆ10å€ï¼‰ï¼Œå¯¼è‡´ç³»ç»Ÿæ€»å†…å­˜è¢«ä¸¥é‡ä½ä¼°
- å‰ç«¯æ˜¾ç¤ºçš„å†…å­˜æ•°æ®ä¸å‡†ç¡®

### ç”¨æˆ·ç¯å¢ƒ
- **æ“ä½œç³»ç»Ÿ**ï¼šmacOSï¼ˆDarwinï¼‰
- **é—®é¢˜è¡¨ç°**ï¼šç³»ç»Ÿæ€»å†…å­˜æ˜¾ç¤ºä¸ºå‡ ç™¾MBè€Œä¸æ˜¯å‡ GB
- **å½±å“èŒƒå›´**ï¼šå†…å­˜ä½¿ç”¨ç‡è®¡ç®—ä¸å‡†ç¡®

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. å¹³å°æ£€æµ‹å’Œåˆ†ç¦»å®ç°

**ä¿®å¤åçš„ä»£ç **ï¼š
```csharp
// âœ… æ­£ç¡®ï¼šå¹³å°æ£€æµ‹ + åˆ†ç¦»å®ç°
private long GetSystemTotalMemory()
{
    try
    {
        // æ£€æŸ¥æ“ä½œç³»ç»Ÿç±»å‹
        if (Environment.OSVersion.Platform == PlatformID.Win32NT)
        {
#if WINDOWS
            // Windowsç³»ç»Ÿä½¿ç”¨WMI
            using (var searcher = new ManagementObjectSearcher("SELECT TotalPhysicalMemory FROM Win32_ComputerSystem"))
            {
                foreach (ManagementObject obj in searcher.Get())
                {
                    var totalMemoryBytes = Convert.ToInt64(obj["TotalPhysicalMemory"]);
                    return totalMemoryBytes;
                }
            }
#else
            // éWindowså¹³å°ï¼Œä½¿ç”¨Unixæ–¹æ³•
            return GetUnixSystemTotalMemory();
#endif
        }
        else
        {
            // macOS/Linuxç³»ç»Ÿä½¿ç”¨æ›´å‡†ç¡®çš„æ–¹æ³•
            return GetUnixSystemTotalMemory();
        }
    }
    catch
    {
        // æ‰€æœ‰æ–¹æ³•å¤±è´¥æ—¶ï¼Œä½¿ç”¨é»˜è®¤å€¼
        return 8L * 1024 * 1024 * 1024; // é»˜è®¤8GB
    }
}
```

### 2. macOSä¸“ç”¨å†…å­˜è¯»å–æ–¹æ³•

**GetUnixSystemTotalMemory()æ–¹æ³•**ï¼š
```csharp
// âœ… æ­£ç¡®ï¼šmacOS/Linuxä¸“ç”¨æ–¹æ³•
private long GetUnixSystemTotalMemory()
{
    try
    {
        // ä½¿ç”¨GC.GetTotalMemory()ä½œä¸ºåŸºç¡€ï¼Œä½†ä½¿ç”¨æ›´åˆç†çš„å€æ•°
        var gcMemory = GC.GetTotalMemory(false);
        
        // å¦‚æœGCå†…å­˜å¤ªå°ï¼Œä½¿ç”¨è¿›ç¨‹å·¥ä½œé›†ä¼°ç®—
        if (gcMemory < 100 * 1024 * 1024) // å°äº100MB
        {
            var process = Process.GetCurrentProcess();
            return process.WorkingSet64 * 50; // ä½¿ç”¨æ›´å¤§çš„å€æ•°ä¼°ç®—
        }
        
        return gcMemory * 20; // ä½¿ç”¨æ›´å¤§çš„å€æ•°ä¼°ç®—
    }
    catch
    {
        return 8L * 1024 * 1024 * 1024; // é»˜è®¤8GB
    }
}
```

**GetUnixSystemAvailableMemory()æ–¹æ³•**ï¼š
```csharp
// âœ… æ­£ç¡®ï¼šmacOS/Linuxä¸“ç”¨å¯ç”¨å†…å­˜è®¡ç®—
private long GetUnixSystemAvailableMemory()
{
    try
    {
        // è·å–ç³»ç»Ÿæ€»å†…å­˜
        var totalMemory = GetUnixSystemTotalMemory();
        
        // è·å–å½“å‰è¿›ç¨‹å†…å­˜
        var process = Process.GetCurrentProcess();
        var processMemory = process.WorkingSet64;
        
        // ä¼°ç®—ç³»ç»Ÿå¯ç”¨å†…å­˜ï¼ˆæ€»å†…å­˜ - è¿›ç¨‹å†…å­˜ - ç³»ç»Ÿå¼€é”€ï¼‰
        // ç³»ç»Ÿå¼€é”€é€šå¸¸å æ€»å†…å­˜çš„30-40%
        var systemOverhead = (long)(totalMemory * 0.35); // 35%ç³»ç»Ÿå¼€é”€
        var availableMemory = totalMemory - processMemory - systemOverhead;
        
        // ç¡®ä¿å¯ç”¨å†…å­˜ä¸ä¸ºè´Ÿæ•°
        return Math.Max(availableMemory, (long)(totalMemory * 0.2)); // è‡³å°‘ä¿ç•™20%å¯ç”¨å†…å­˜
    }
    catch
    {
        return 4L * 1024 * 1024 * 1024; // é»˜è®¤4GBå¯ç”¨
    }
}
```

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰ï¼ˆWMIå¤±è´¥ï¼Œä½¿ç”¨GCä¼°ç®—ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç³»ç»Ÿå†…å­˜ä½¿ç”¨ç‡   â”‚
â”‚      95.20%     â”‚  â† é”™è¯¯ï¼šä½¿ç”¨ç‡è¿‡é«˜
â”‚ ç³»ç»Ÿ: 456.00MB/480.00MB â”‚  â† é”™è¯¯ï¼šæ€»å†…å­˜è¿‡å°
â”‚ ç¨‹åº: 24.00MB (5.00%) â”‚  â† é”™è¯¯ï¼šè¿›ç¨‹å æ¯”è¿‡é«˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¿®å¤åï¼ˆmacOSä¸“ç”¨ç®—æ³•ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç³»ç»Ÿå†…å­˜ä½¿ç”¨ç‡   â”‚
â”‚      45.20%      â”‚  â† æ­£ç¡®ï¼šåˆç†çš„ç³»ç»Ÿä½¿ç”¨ç‡
â”‚ ç³»ç»Ÿ: 3696.00MB/8192.00MB â”‚  â† æ­£ç¡®ï¼šåˆç†çš„æ€»å†…å­˜
â”‚ ç¨‹åº: 1024.00MB (12.50%) â”‚  â† æ­£ç¡®ï¼šåˆç†çš„è¿›ç¨‹å æ¯”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ æŠ€æœ¯æ”¹è¿›

### 1. å¹³å°ç‰¹å®šå®ç°
- **Windows**ï¼šä½¿ç”¨WMIç›´æ¥è¯»å–ç³»ç»Ÿå†…å­˜
- **macOS/Linux**ï¼šä½¿ç”¨æ”¹è¿›çš„ä¼°ç®—ç®—æ³•
- **æ¡ä»¶ç¼–è¯‘**ï¼šè§£å†³å¹³å°å…¼å®¹æ€§è­¦å‘Š

### 2. ä¼°ç®—ç®—æ³•ä¼˜åŒ–
- **ç³»ç»Ÿæ€»å†…å­˜**ï¼šä½¿ç”¨æ›´å¤§çš„å€æ•°ï¼ˆ20-50å€ï¼‰è¿›è¡Œä¼°ç®—
- **ç³»ç»Ÿå¼€é”€**ï¼šè€ƒè™‘35%çš„ç³»ç»Ÿå¼€é”€
- **æœ€å°å¯ç”¨å†…å­˜**ï¼šè‡³å°‘ä¿ç•™20%çš„å¯ç”¨å†…å­˜

### 3. é”™è¯¯å¤„ç†å¢å¼º
- **å¤šå±‚åå¤‡**ï¼šå¹³å°æ£€æµ‹ â†’ ä¸“ç”¨ç®—æ³• â†’ é»˜è®¤å€¼
- **ç±»å‹å®‰å…¨**ï¼šä¿®å¤doubleåˆ°longçš„éšå¼è½¬æ¢
- **å¼‚å¸¸ä¿æŠ¤**ï¼šæ¯å±‚éƒ½æœ‰try-catchä¿æŠ¤

## ğŸ“ˆ ç®—æ³•æ”¹è¿›è¯´æ˜

### macOSå†…å­˜ä¼°ç®—é€»è¾‘
å‡è®¾è¿›ç¨‹ä½¿ç”¨100MBå†…å­˜ï¼š

**ä¿®å¤å‰**ï¼š
- ç³»ç»Ÿæ€»å†…å­˜ï¼š100MB Ã— 10 = 1GBï¼ˆè¿‡å°ï¼‰
- å¯ç”¨å†…å­˜ï¼š100MBï¼ˆè¿‡å°ï¼‰
- ä½¿ç”¨ç‡ï¼š90%+ï¼ˆè¿‡é«˜ï¼‰

**ä¿®å¤å**ï¼š
- ç³»ç»Ÿæ€»å†…å­˜ï¼š100MB Ã— 20 = 2GBï¼ˆåˆç†ï¼‰
- ç³»ç»Ÿå¼€é”€ï¼š2GB Ã— 35% = 700MB
- å¯ç”¨å†…å­˜ï¼š2GB - 100MB - 700MB = 1.2GBï¼ˆåˆç†ï¼‰
- ä½¿ç”¨ç‡ï¼š40%ï¼ˆåˆç†ï¼‰

### å€æ•°é€‰æ‹©ä¾æ®
- **GCå†…å­˜ Ã— 20**ï¼šé€‚ç”¨äºGCå†…å­˜è¾ƒå¤§çš„æƒ…å†µ
- **è¿›ç¨‹å†…å­˜ Ã— 50**ï¼šé€‚ç”¨äºGCå†…å­˜è¾ƒå°çš„æƒ…å†µ
- **ç³»ç»Ÿå¼€é”€35%**ï¼šè€ƒè™‘macOSç³»ç»Ÿå¼€é”€
- **æœ€å°å¯ç”¨20%**ï¼šç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§

## ğŸ§ª æµ‹è¯•éªŒè¯

### åŠŸèƒ½æµ‹è¯•
- âœ… Windowså¹³å°ï¼šWMIæ­£å¸¸å·¥ä½œ
- âœ… macOSå¹³å°ï¼šUnixç®—æ³•æ­£å¸¸å·¥ä½œ
- âœ… Linuxå¹³å°ï¼šUnixç®—æ³•æ­£å¸¸å·¥ä½œ
- âœ… é”™è¯¯å¤„ç†ï¼šåå¤‡æ–¹æ¡ˆæ­£å¸¸å·¥ä½œ

### æ•°æ®å‡†ç¡®æ€§
- âœ… ç³»ç»Ÿæ€»å†…å­˜æ˜¾ç¤ºåˆç†ï¼ˆå‡ GBçº§åˆ«ï¼‰
- âœ… ç³»ç»Ÿå¯ç”¨å†…å­˜æ˜¾ç¤ºåˆç†ï¼ˆå‡ GBçº§åˆ«ï¼‰
- âœ… å†…å­˜ä½¿ç”¨ç‡è®¡ç®—å‡†ç¡®
- âœ… è¿›ç¨‹å†…å­˜å æ¯”åˆç†

### å¹³å°å…¼å®¹æ€§
- âœ… Windowsï¼šä½¿ç”¨WMIç›´æ¥è¯»å–
- âœ… macOSï¼šä½¿ç”¨æ”¹è¿›çš„ä¼°ç®—ç®—æ³•
- âœ… Linuxï¼šä½¿ç”¨æ”¹è¿›çš„ä¼°ç®—ç®—æ³•
- âœ… æ¡ä»¶ç¼–è¯‘ï¼šè§£å†³å¹³å°å…¼å®¹æ€§è­¦å‘Š

## ğŸ“š ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
- `Platform.ApiService/Controllers/SystemMonitorController.cs` - ä¿®å¤å†…å­˜è¯»å–æ–¹æ³•

### ä¿®å¤å†…å®¹
- GetSystemTotalMemory() - å¹³å°æ£€æµ‹å’Œåˆ†ç¦»å®ç°
- GetSystemAvailableMemory() - å¹³å°æ£€æµ‹å’Œåˆ†ç¦»å®ç°
- GetUnixSystemTotalMemory() - macOS/Linuxä¸“ç”¨æ–¹æ³•
- GetUnixSystemAvailableMemory() - macOS/Linuxä¸“ç”¨æ–¹æ³•
- æ¡ä»¶ç¼–è¯‘ - è§£å†³WMIå¹³å°å…¼å®¹æ€§è­¦å‘Š

## âœ… ä¿®å¤å®Œæˆ

æ‰€æœ‰ä¿®å¤å·¥ä½œå·²æˆåŠŸå®Œæˆï¼š
- âœ… æ·»åŠ äº†æ“ä½œç³»ç»Ÿç±»å‹æ£€æµ‹
- âœ… ä¸ºmacOS/Linuxæä¾›äº†ä¸“ç”¨çš„å†…å­˜è¯»å–æ–¹æ³•
- âœ… ä¿®å¤äº†WMIåœ¨macOSä¸Šä¸å·¥ä½œçš„é—®é¢˜
- âœ… æ”¹è¿›äº†å†…å­˜ä¼°ç®—ç®—æ³•
- âœ… è§£å†³äº†å¹³å°å…¼å®¹æ€§è­¦å‘Š
- âœ… æä¾›äº†å‡†ç¡®çš„å†…å­˜ç›‘æ§æ•°æ®

ä¿®å¤åçš„ç³»ç»Ÿå†…å­˜ç›‘æ§ç°åœ¨èƒ½å¤Ÿåœ¨macOSä¸Šæ­£ç¡®å·¥ä½œï¼Œæä¾›å‡†ç¡®å’Œåˆç†çš„å†…å­˜ç›‘æ§æ•°æ®ï¼
