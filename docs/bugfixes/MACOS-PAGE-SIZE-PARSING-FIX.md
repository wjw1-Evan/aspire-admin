# macOS vm_staté¡µé¢å¤§å°è§£æä¿®å¤

## ğŸ“‹ é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆç³»ç»Ÿèµ„æºç›‘æ§ä¸­å†…å­˜ä½¿ç”¨ç‡çš„"ç³»ç»Ÿå·²ä½¿ç”¨å†…å­˜"æ•°æ®æœ‰è¯¯ã€‚ç»è¿‡åˆ†æå‘ç°ï¼ŒmacOSç³»ç»Ÿä½¿ç”¨`vm_stat`å‘½ä»¤è·å–å¯ç”¨å†…å­˜æ—¶ï¼Œé¡µé¢å¤§å°è§£æå¤±è´¥ï¼Œå¯¼è‡´ä½¿ç”¨äº†é»˜è®¤å€¼4096å­—èŠ‚è€Œä¸æ˜¯å®é™…ç³»ç»Ÿçš„16384å­—èŠ‚ã€‚

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

**vm_statè¾“å‡ºæ ¼å¼**ï¼š
```
Mach Virtual Memory Statistics: (page size of 16384 bytes)
Pages free:                                7424.
Pages inactive:                          567443.
```

**åŸå§‹é”™è¯¯ä»£ç **ï¼š
```csharp
// âŒ é—®é¢˜ï¼šä½¿ç”¨ StartsWith æ— æ³•åŒ¹é…åŒ…å«æ‹¬å·çš„æ ¼å¼
else if (line.StartsWith("page size of"))
{
    var parts = line.Split(' ');
    if (parts.Length >= 4 && long.TryParse(parts[3], out var size))
        pageSize = size;
}
```

**é—®é¢˜åˆ†æ**ï¼š
1. `line.StartsWith("page size of")` æ— æ³•åŒ¹é… `"Mach Virtual Memory Statistics: (page size of 16384 bytes)"`
2. å› ä¸ºå®é™…è¡Œçš„å¼€å¤´æ˜¯ `"Mach"`ï¼Œä¸åŒ…å« `"page size of"`
3. å¯¼è‡´ä½¿ç”¨é»˜è®¤çš„4096å­—èŠ‚é¡µé¢å¤§å°
4. å®é™…ç³»ç»Ÿé¡µé¢å¤§å°æ˜¯16384å­—èŠ‚ï¼Œå·®å¼‚4å€
5. å¯¼è‡´å¯ç”¨å†…å­˜è®¡ç®—é”™è¯¯ï¼Œè¿›è€Œå½±å“"ç³»ç»Ÿå·²ä½¿ç”¨å†…å­˜"çš„æ˜¾ç¤º

### å½±å“èŒƒå›´

**é”™è¯¯è®¡ç®—ç¤ºä¾‹**ï¼š
```python
# å®é™…ç³»ç»Ÿæ•°æ®
free_pages = 7424
inactive_pages = 567443
total_pages = 574867
actual_page_size = 16384 bytes

# æ­£ç¡®è®¡ç®—
available_memory = 574867 Ã— 16384 = 9,418,620,928 bytes â‰ˆ 8.77 GB

# é”™è¯¯è®¡ç®—ï¼ˆä½¿ç”¨é»˜è®¤4096ï¼‰
wrong_available_memory = 574867 Ã— 4096 = 2,354,655,232 bytes â‰ˆ 2.19 GB

# å·®å¼‚
memory_diff = 8.77 - 2.19 = 6.58 GB

# å¯¹äº24GBç³»ç»Ÿæ€»å†…å­˜
wrong_used_memory = 24 - 2.19 = 21.81 GB (90.8%)
correct_used_memory = 24 - 8.77 = 15.23 GB (63.5%)

# å·®å¼‚ï¼š27.3%ä½¿ç”¨ç‡è®¡ç®—é”™è¯¯
```

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ä»£ç 

**ä¿®å¤åçš„ä»£ç **ï¼š
```csharp
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ Contains åŒ¹é…å¹¶çµæ´»è§£æ
else if (line.Contains("page size of"))
{
    // åŒ¹é…æ ¼å¼ï¼š"Mach Virtual Memory Statistics: (page size of 16384 bytes)"
    var parts = line.Split(' ');
    for (int i = 0; i < parts.Length; i++)
    {
        if (parts[i].Contains("bytes"))
        {
            // å°è¯•ä»åŒ…å«bytesçš„tokenä¸­æå–æ•°å­—ï¼ˆå¦‚"16384"æˆ–"bytes)"ï¼‰
            var token = parts[i].Replace("bytes)", "").Replace("bytes", "");
            if (long.TryParse(token, out var size))
            {
                pageSize = size;
                break;
            }
            // å¦‚æœå½“å‰tokenæ˜¯"bytes)"ï¼Œå°è¯•å‰ä¸€ä¸ªtoken
            if (i > 0 && long.TryParse(parts[i - 1], out var size2))
            {
                pageSize = size2;
                break;
            }
        }
    }
}
```

**æŠ€æœ¯è¯´æ˜**ï¼š
1. ä½¿ç”¨ `line.Contains("page size of")` è¿›è¡ŒåŒ¹é…ï¼Œä¸ä¾èµ–è¡Œå¼€å¤´
2. é€šè¿‡ `parts[i].Contains("bytes")` æ‰¾åˆ°åŒ…å«"bytes"çš„token
3. å¤„ç†ä¸¤ç§å¯èƒ½çš„æ ¼å¼ï¼š
   - `"16384"` - å•ç‹¬çš„æ•°å­—token
   - `"bytes)"` - åŒ…å«æ‹¬å·çš„tokenï¼Œéœ€è¦æ¸…ç†
4. ä¼˜å…ˆå°è¯•è§£æå½“å‰tokenï¼ˆå¯èƒ½åŒ…å«æ•°å­—ï¼‰
5. å¦‚æœå¤±è´¥ï¼Œå°è¯•è§£æå‰ä¸€ä¸ªtokenï¼ˆé€šå¸¸æ˜¯çº¯æ•°å­—ï¼‰

### è§£æé€»è¾‘æ¼”ç¤º

**è¾“å…¥**ï¼š`"Mach Virtual Memory Statistics: (page size of 16384 bytes)"`

**Splitç»“æœ**ï¼š
```
parts[0] = "Mach"
parts[1] = "Virtual"
parts[2] = "Memory"
parts[3] = "Statistics:"
parts[4] = "(page"
parts[5] = "size"
parts[6] = "of"
parts[7] = "16384"
parts[8] = "bytes)"
```

**è§£ææµç¨‹**ï¼š
1. `i=8`: æ£€æŸ¥ `parts[8] = "bytes)"` â†’ åŒ…å«"bytes"
2. æ¸…ç†token: `"bytes)".Replace("bytes)", "")` â†’ `""`
3. å°è¯•è§£æ `""` â†’ å¤±è´¥
4. å°è¯•è§£æå‰ä¸€ä¸ªtoken: `parts[7] = "16384"` â†’ æˆåŠŸ
5. ç»“æœ: `pageSize = 16384`

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç³»ç»Ÿå†…å­˜ä½¿ç”¨ç‡   â”‚
â”‚      90.8%      â”‚  â† é”™è¯¯ï¼šä½¿ç”¨ç‡è¿‡é«˜
â”‚ ç³»ç»Ÿ: 21810MB/24576MB â”‚  â† é”™è¯¯ï¼šä½¿ç”¨å†…å­˜è¿‡é«˜
â”‚ ç¨‹åº: 1024MB (4.2%) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ†æï¼š
- é¡µé¢å¤§å°ï¼š4096 bytesï¼ˆé»˜è®¤ï¼Œé”™è¯¯ï¼‰
- å¯ç”¨å†…å­˜ï¼š2.19 GBï¼ˆè¢«ä¸¥é‡ä½ä¼°ï¼‰
- ä½¿ç”¨å†…å­˜ï¼š21.81 GBï¼ˆè¢«ä¸¥é‡é«˜ä¼°ï¼‰
- ä½¿ç”¨ç‡ï¼š90.8%ï¼ˆæ˜æ˜¾åé«˜ï¼‰
```

### ä¿®å¤å
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç³»ç»Ÿå†…å­˜ä½¿ç”¨ç‡   â”‚
â”‚      63.5%      â”‚  â† æ­£ç¡®ï¼šåˆç†çš„ä½¿ç”¨ç‡
â”‚ ç³»ç»Ÿ: 15600MB/24576MB â”‚  â† æ­£ç¡®ï¼šçœŸå®çš„ä½¿ç”¨å†…å­˜
â”‚ ç¨‹åº: 1024MB (4.2%) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ†æï¼š
- é¡µé¢å¤§å°ï¼š16384 bytesï¼ˆå®é™…ç³»ç»Ÿï¼‰
- å¯ç”¨å†…å­˜ï¼š8.77 GBï¼ˆçœŸå®å€¼ï¼‰
- ä½¿ç”¨å†…å­˜ï¼š15.23 GBï¼ˆçœŸå®å€¼ï¼‰
- ä½¿ç”¨ç‡ï¼š63.5%ï¼ˆåˆç†èŒƒå›´ï¼‰
```

### å…·ä½“æ•°å€¼å¯¹æ¯”

| æŒ‡æ ‡ | ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰ | ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰ | å·®å¼‚ |
|---|---|---|---|
| **é¡µé¢å¤§å°** | 4096 bytes | 16384 bytes | 4å€ |
| **å¯ç”¨å†…å­˜** | 2.19 GB | 8.77 GB | +6.58 GB |
| **ä½¿ç”¨å†…å­˜** | 21.81 GB | 15.23 GB | -6.58 GB |
| **ä½¿ç”¨ç‡** | 90.8% | 63.5% | -27.3% |

## ğŸ”§ æŠ€æœ¯æ”¹è¿›

### 1. è§£æçµæ´»æ€§
- **å®½æ¾åŒ¹é…**ï¼šä½¿ç”¨ `Contains` è€Œä¸æ˜¯ `StartsWith`
- **æ ¼å¼å…¼å®¹**ï¼šæ”¯æŒå¸¦æ‹¬å·å’Œä¸å¸¦æ‹¬å·çš„æ ¼å¼
- **å¤štokenå¤„ç†**ï¼šèƒ½å¤Ÿå¤„ç†ä»»æ„ä½ç½®çš„"bytes"æ ‡è®°

### 2. å®¹é”™æ€§å¢å¼º
- **åŒé‡å°è¯•**ï¼šå…ˆè§£æå½“å‰tokenï¼Œå¤±è´¥åˆ™è§£æå‰ä¸€ä¸ªtoken
- **æ¸…ç†å¤„ç†**ï¼šè‡ªåŠ¨æ¸…ç†æ‹¬å·å’Œå…¶ä»–ç¬¦å·
- **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨ `long.TryParse` å®‰å…¨è§£æ

### 3. ä»£ç å¯è¯»æ€§
- **è¯¦ç»†æ³¨é‡Š**ï¼šè¯´æ˜åŒ¹é…æ ¼å¼å’Œè§£æé€»è¾‘
- **é€»è¾‘æ¸…æ™°**ï¼šåˆ†æ­¥å¤„ç†å’Œé€æ­¥å°è¯•
- **æ˜“äºç»´æŠ¤**ï¼šç»“æ„åŒ–çš„è§£ææµç¨‹

## ğŸ§ª æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•æ•°æ®

**æµ‹è¯•ç”¨ä¾‹1**ï¼šæ ‡å‡†æ ¼å¼ï¼ˆå¸¦æ‹¬å·ï¼‰
```bash
$ vm_stat
Mach Virtual Memory Statistics: (page size of 16384 bytes)
Pages free:                                7424.
Pages inactive:                          567443.

é¢„æœŸç»“æœï¼špageSize = 16384 âœ…
```

**æµ‹è¯•ç”¨ä¾‹2**ï¼šç®€åŒ–æ ¼å¼ï¼ˆä¸å¸¦æ‹¬å·ï¼‰
```csharp
// å‡è®¾çš„ç®€åŒ–æ ¼å¼
"page size of 4096 bytes"

é¢„æœŸç»“æœï¼špageSize = 4096 âœ…
```

### å®é™…ç³»ç»Ÿæµ‹è¯•

```bash
# å®é™…ç³»ç»ŸéªŒè¯
$ sysctl -n hw.memsize
25769803776  # 24 GB

$ vm_stat | grep -E "(Pages free|Pages inactive|page size)"
Mach Virtual Memory Statistics: (page size of 16384 bytes)
Pages free:                                7424.
Pages inactive:                          567443.

# è®¡ç®—éªŒè¯
available_pages = 7424 + 567443 = 574867
available_memory = 574867 Ã— 16384 = 9,418,620,928 bytes
available_memory_gb = 9,418,620,928 / 1024 / 1024 / 1024 â‰ˆ 8.77 GB
total_memory_gb = 25769803776 / 1024 / 1024 / 1024 = 24.00 GB
used_memory = 24.00 - 8.77 = 15.23 GB
usage_percent = 15.23 / 24.00 Ã— 100 = 63.5%
```

### APIè¿”å›éªŒè¯

**ä¿®å¤å‰**ï¼š
```json
{
  "memory": {
    "availableMemoryMB": 2238.84,
    "totalMemoryMB": 24576.00,
    "usagePercent": 90.89
  }
}
```

**ä¿®å¤å**ï¼š
```json
{
  "memory": {
    "availableMemoryMB": 8975.52,
    "totalMemoryMB": 24576.00,
    "usagePercent": 63.48
  }
}
```

## ğŸ“š ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
- `Platform.ApiService/Controllers/SystemMonitorController.cs` - ä¿®å¤é¡µé¢å¤§å°è§£æé€»è¾‘

### ä¿®å¤å†…å®¹
- `GetUnixSystemAvailableMemory()` - æ”¹è¿›vm_staté¡µé¢å¤§å°è§£æ
- æ·»åŠ åŒé‡è§£æé€»è¾‘ï¼ˆå½“å‰token + å‰ä¸€ä¸ªtokenï¼‰
- æ”¯æŒå¸¦æ‹¬å·å’Œä¸å¸¦æ‹¬å·çš„æ ¼å¼

## âœ… ä¿®å¤å®Œæˆ

æ‰€æœ‰ä¿®å¤å·¥ä½œå·²æˆåŠŸå®Œæˆï¼š
- âœ… ä¿®å¤äº†`page size of`è§£æé€»è¾‘
- âœ… æ”¯æŒå¸¦æ‹¬å·çš„å®é™…æ ¼å¼
- âœ… ä½¿ç”¨æ­£ç¡®çš„16384å­—èŠ‚é¡µé¢å¤§å°
- âœ… ä¿®å¤äº†macOSå¯ç”¨å†…å­˜è®¡ç®—
- âœ… ä¿®å¤äº†"ç³»ç»Ÿå·²ä½¿ç”¨å†…å­˜"æ˜¾ç¤º
- âœ… ä¿®å¤äº†å†…å­˜ä½¿ç”¨ç‡è®¡ç®—

ä¿®å¤åçš„macOSç³»ç»Ÿå†…å­˜ç›‘æ§ç°åœ¨èƒ½å¤Ÿæ­£ç¡®è§£æé¡µé¢å¤§å°ï¼Œæä¾›å‡†ç¡®çš„å†…å­˜ä½¿ç”¨æ•°æ®ï¼
