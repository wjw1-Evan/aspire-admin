# 🔐 安全部署检查清单

## 📋 概述

本检查清单确保系统安全部署，防止常见安全漏洞。

**使用方法**: 在部署到任何环境前，逐项检查并打钩确认。

---

## 🔑 密钥和敏感信息

### 后端（Platform.ApiService）

- [ ] **JWT SecretKey已配置**
  - 通过User Secrets（开发）或环境变量（生产）
  - 密钥长度至少32字符
  - 每个环境使用不同的密钥
  - 验证方法：启动应用，检查无异常

- [ ] **appsettings.json不包含真实密钥**
  - `Jwt:SecretKey` 字段为空或注释
  - 其他敏感配置已移除
  - 验证方法：`git grep -i secret appsettings.json`

- [ ] **数据库连接字符串安全配置**
  - 不在代码中硬编码
  - 使用环境变量或Aspire配置
  - 生产环境使用加密连接

### 前端（Platform.Admin）

- [ ] **API基础地址正确配置**
  - 生产环境使用 `REACT_APP_API_BASE_URL` 环境变量
  - 不使用硬编码的示例地址
  - 验证方法：检查 `src/app.tsx` 第436-440行

- [ ] **.env 文件不提交到Git**
  - `.gitignore` 包含 `.env.production`
  - 只有 `.env.example` 在Git中
  - 验证方法：`git status` 不显示 .env 文件

---

## 🌐 网络和CORS

### CORS配置

- [ ] **生产环境CORS限制正确**
  - `AllowedOrigins` 配置在 `appsettings.Production.json`
  - 只包含实际使用的域名
  - 不使用 `AllowAnyOrigin()`
  - 验证方法：检查 `Program.cs` 第26-49行

- [ ] **开发环境CORS可接受**
  - 开发环境可以宽松（便于调试）
  - 确认是 `IsDevelopment()` 条件
  - 验证方法：检查代码逻辑

### HTTPS配置

- [ ] **生产环境强制HTTPS**
  - API服务配置HTTPS重定向
  - 前端使用HTTPS加载资源
  - Cookie设置 `Secure` 标志

---

## 🔐 认证和授权

### JWT配置

- [ ] **Token过期时间合理**
  - Access Token：30-60分钟
  - Refresh Token：7-30天
  - 验证方法：检查 `appsettings.json` Jwt配置

- [ ] **Token刷新机制正常**
  - 测试Token过期后自动刷新
  - 刷新失败时正确跳转登录
  - 验证方法：手动测试或自动化测试

### 多租户隔离

- [ ] **GetRequiredCompanyId正确实现**
  - 无CompanyId时抛出异常
  - 所有需要企业上下文的API都调用此方法
  - 验证方法：检查 `BaseApiController.cs` 第51-56行

- [ ] **数据查询包含企业过滤**
  - 所有多租户数据查询过滤CompanyId
  - 使用BaseRepository自动过滤
  - 验证方法：代码审查或安全测试

---

## 📝 日志和监控

### 敏感信息保护

- [ ] **生产环境不输出敏感日志**
  - 不输出Token内容
  - 不输出密码（即使是哈希值）
  - 不输出完整的用户信息
  - 验证方法：检查 `app.tsx` 第448-472行

- [ ] **错误消息不暴露系统细节**
  - 生产环境使用通用错误消息
  - 详细错误只记录到服务器日志
  - 不返回堆栈跟踪给客户端

### 日志配置

- [ ] **日志级别适当**
  - 开发环境：Debug/Information
  - 生产环境：Warning/Error
  - 验证方法：检查 `appsettings.Production.json`

- [ ] **日志存储安全**
  - 日志文件访问权限限制
  - 考虑日志轮转和归档
  - 敏感信息已脱敏

---

## 🛡️ 输入验证和注入防护

### 输入验证

- [ ] **所有用户输入已验证**
  - 使用ValidationExtensions进行参数验证
  - 邮箱、密码、用户名格式验证
  - 验证方法：检查Controller和Service代码

- [ ] **文件上传安全**（如果有）
  - 验证文件类型和大小
  - 文件内容扫描
  - 存储在受限目录

### NoSQL注入防护

- [ ] **MongoDB查询使用参数化**
  - 不拼接查询字符串
  - 使用Builders<T>.Filter构建查询
  - 验证方法：代码审查

---

## 🔄 Rate Limiting（计划中）

- [ ] **实现请求频率限制**
  - 登录接口：5次/分钟
  - 注册接口：3次/小时
  - API接口：100次/分钟
  - 状态：待实施

---

## 🧪 安全测试

### 认证测试

- [ ] **JWT伪造测试**
  - 无法使用默认或空密钥伪造token
  - 无法使用过期token访问
  - 无法使用其他用户的token

- [ ] **密码强度测试**
  - 弱密码被拒绝
  - 密码正确哈希存储
  - 密码不在日志中出现

### 授权测试

- [ ] **跨企业访问测试**
  - 企业A用户无法访问企业B数据
  - GetRequiredCompanyId正确拒绝无权限请求
  - 角色权限正确执行

### XSS和CSRF测试

- [ ] **XSS防护**
  - 用户输入正确转义
  - 使用React自动转义
  - 危险HTML使用sanitize

- [ ] **CSRF防护**（如使用Cookie）
  - Token验证
  - SameSite Cookie配置

---

## 📦 依赖安全

### NPM依赖

- [ ] **运行安全审计**
  ```bash
  cd Platform.Admin
  npm audit
  npm audit fix
  ```

- [ ] **无高危漏洞**
  - 检查audit报告
  - 升级有漏洞的包
  - 考虑替代方案

### NuGet依赖

- [ ] **运行安全扫描**
  ```bash
  cd Platform.ApiService
  dotnet list package --vulnerable
  ```

- [ ] **包来源可信**
  - 只使用官方NuGet源
  - 验证包签名

---

## 🚀 部署配置

### 环境分离

- [ ] **开发/测试/生产环境独立**
  - 不同的数据库
  - 不同的密钥
  - 不同的域名

- [ ] **配置文件正确**
  - `appsettings.Development.json` 用于开发
  - `appsettings.Production.json` 用于生产
  - 环境变量覆盖文件配置

### 服务器安全

- [ ] **防火墙规则配置**
  - 只开放必要端口（80/443）
  - 限制MongoDB访问
  - 限制SSH访问

- [ ] **自动更新启用**
  - 操作系统安全补丁
  - 运行时版本更新
  - 依赖包定期更新

---

## 📚 文档和流程

### 文档完整性

- [ ] **安全文档已更新**
  - JWT配置指南
  - 部署检查清单
  - 安全事故响应流程

- [ ] **团队培训**
  - 所有开发者了解安全规范
  - 密钥管理流程清晰
  - 安全事件报告机制

### 备份和恢复

- [ ] **数据备份策略**
  - 定期备份数据库
  - 测试恢复流程
  - 备份存储加密

- [ ] **密钥备份和轮换**
  - 密钥安全存储（Key Vault）
  - 定期轮换计划（3-6个月）
  - 应急恢复流程

---

## ✅ 部署前最终检查

### 开发环境

- [ ] 使用 `dotnet user-secrets set` 配置JWT密钥
- [ ] 运行 `npm audit` 和 `dotnet list package --vulnerable`
- [ ] 测试所有关键功能
- [ ] 检查开发工具不暴露在生产

### 测试环境

- [ ] 配置环境变量
- [ ] 运行自动化测试
- [ ] 运行安全扫描
- [ ] 验证监控和日志

### 生产环境

- [ ] 所有密钥通过安全方式配置（环境变量/Key Vault）
- [ ] CORS只允许实际域名
- [ ] 启用HTTPS和HSTS
- [ ] 错误消息不暴露细节
- [ ] 日志级别设为Warning或Error
- [ ] 监控和告警配置完成
- [ ] 备份和恢复流程测试通过

---

## 🚨 安全事件响应

### 发现漏洞时

1. **评估影响范围**
2. **立即采取缓解措施**
3. **通知相关人员**
4. **修复漏洞**
5. **验证修复**
6. **更新文档和流程**

### 密钥泄露时

1. **立即轮换所有密钥**
2. **重启所有服务实例**
3. **检查日志和访问记录**
4. **通知用户重新登录**
5. **调查泄露原因**
6. **加强安全培训**

---

## 📊 检查表摘要

| 类别 | 检查项数量 | 必须项 | 建议项 |
|------|------------|--------|--------|
| 密钥和敏感信息 | 7 | 7 | 0 |
| 网络和CORS | 6 | 5 | 1 |
| 认证和授权 | 5 | 5 | 0 |
| 日志和监控 | 6 | 4 | 2 |
| 输入验证 | 4 | 4 | 0 |
| Rate Limiting | 1 | 0 | 1 |
| 安全测试 | 6 | 6 | 0 |
| 依赖安全 | 4 | 4 | 0 |
| 部署配置 | 6 | 6 | 0 |
| 文档和流程 | 4 | 2 | 2 |
| **总计** | **49** | **43** | **6** |

---

## 🎯 总结

**部署前必须完成所有必须项（43项）！**

建议项可根据项目情况和时间安排逐步完成。

定期（每季度）重新检查此清单，确保安全配置持续有效。

**记住**: 安全是一个持续的过程，而不是一次性的任务！

