# ç®¡ç†å‘˜åˆå§‹åŒ–ç³»ç»Ÿ v3.1

## ğŸ“‹ æ¦‚è¿°

ç®¡ç†å‘˜åˆå§‹åŒ–ç³»ç»Ÿå·²å‡çº§åˆ° v3.1 ç‰ˆæœ¬ï¼Œç°åœ¨æ”¯æŒå¤šç§Ÿæˆ·æ¶æ„ã€‚åˆå§‹åŒ–è„šæœ¬ä¼šè‡ªåŠ¨åˆ›å»ºï¼š

- âœ… ç³»ç»Ÿä¼ä¸šï¼ˆCompanyï¼‰
- âœ… è¶…çº§ç®¡ç†å‘˜è§’è‰²ï¼ˆRoleï¼‰
- âœ… ç®¡ç†å‘˜ç”¨æˆ·ï¼ˆAppUserï¼‰
- âœ… ç”¨æˆ·-ä¼ä¸šå…³è”ï¼ˆUserCompanyï¼‰

## ğŸ¯ åˆå§‹åŒ–å†…å®¹

### 1. ç³»ç»Ÿä¼ä¸šï¼ˆCompanyï¼‰

| å­—æ®µ | å€¼ | è¯´æ˜ |
|-----|-----|-----|
| **åç§°** | ç³»ç»Ÿä¼ä¸š | é»˜è®¤ç³»ç»Ÿä¼ä¸š |
| **ä»£ç ** | system | å”¯ä¸€æ ‡è¯†ç¬¦ |
| **æè¿°** | é»˜è®¤ç³»ç»Ÿä¼ä¸šï¼Œç”¨äºè¶…çº§ç®¡ç†å‘˜ | - |
| **è¡Œä¸š** | ç³»ç»Ÿ | - |
| **æœ€å¤§ç”¨æˆ·æ•°** | 10000 | è¶³å¤Ÿå®¹çº³ç³»ç»Ÿçº§ç”¨æˆ· |
| **è¿‡æœŸæ—¶é—´** | null | æ°¸ä¸è¿‡æœŸ |
| **çŠ¶æ€** | active | æ¿€æ´»çŠ¶æ€ |

### 2. è¶…çº§ç®¡ç†å‘˜è§’è‰²ï¼ˆRoleï¼‰

| å­—æ®µ | å€¼ | è¯´æ˜ |
|-----|-----|-----|
| **åç§°** | è¶…çº§ç®¡ç†å‘˜ | ç³»ç»Ÿæœ€é«˜æƒé™è§’è‰² |
| **æè¿°** | ç³»ç»Ÿè¶…çº§ç®¡ç†å‘˜ï¼Œæ‹¥æœ‰æ‰€æœ‰æƒé™ | - |
| **èœå•æƒé™** | [] | ç¨åç”±èœå•åˆå§‹åŒ–è„šæœ¬å¡«å…… |
| **åŠŸèƒ½æƒé™** | [] | ç¨åç”±æƒé™åˆå§‹åŒ–è„šæœ¬å¡«å…… |
| **çŠ¶æ€** | active | æ¿€æ´»çŠ¶æ€ |

### 3. ç®¡ç†å‘˜ç”¨æˆ·ï¼ˆAppUserï¼‰

| å­—æ®µ | å€¼ | è¯´æ˜ |
|-----|-----|-----|
| **ç”¨æˆ·å** | admin | ç™»å½•è´¦å· |
| **å¯†ç ** | admin123 | é»˜è®¤å¯†ç ï¼ˆâš ï¸ å»ºè®®é¦–æ¬¡ç™»å½•åä¿®æ”¹ï¼‰ |
| **é‚®ç®±** | admin@example.com | - |
| **å§“å** | ç³»ç»Ÿç®¡ç†å‘˜ | æ˜¾ç¤ºåç§° |
| **æ‰€å±ä¼ä¸š** | system | ç³»ç»Ÿä¼ä¸šID |
| **å½“å‰ä¼ä¸š** | system | å½“å‰é€‰ä¸­ä¼ä¸š |
| **ä¸ªäººä¼ä¸š** | system | ä¸ªäººä¼ä¸šID |
| **çŠ¶æ€** | active | æ¿€æ´»çŠ¶æ€ |

### 4. ç”¨æˆ·-ä¼ä¸šå…³è”ï¼ˆUserCompanyï¼‰

| å­—æ®µ | å€¼ | è¯´æ˜ |
|-----|-----|-----|
| **ç”¨æˆ·ID** | adminçš„ID | - |
| **ä¼ä¸šID** | systemçš„ID | - |
| **è§’è‰²åˆ—è¡¨** | [è¶…çº§ç®¡ç†å‘˜ID] | åœ¨ç³»ç»Ÿä¼ä¸šä¸­çš„è§’è‰² |
| **æ˜¯å¦ç®¡ç†å‘˜** | true | ä¼ä¸šç®¡ç†å‘˜ |
| **çŠ¶æ€** | active | æ¿€æ´»çŠ¶æ€ |

## ğŸ”§ åˆå§‹åŒ–æµç¨‹

```mermaid
graph TD
    A[å¼€å§‹] --> B{adminç”¨æˆ·å­˜åœ¨?}
    B -->|æ˜¯| C[è·³è¿‡åˆå§‹åŒ–]
    B -->|å¦| D{å·²åˆ é™¤çš„adminå­˜åœ¨?}
    D -->|æ˜¯| E[æ¢å¤adminç”¨æˆ·]
    D -->|å¦| F[åˆ›å»ºç³»ç»Ÿä¼ä¸š]
    F --> G[åˆ›å»ºè¶…çº§ç®¡ç†å‘˜è§’è‰²]
    G --> H[åˆ›å»ºadminç”¨æˆ·]
    H --> I[åˆ›å»ºç”¨æˆ·-ä¼ä¸šå…³è”]
    I --> J[è¾“å‡ºåˆå§‹åŒ–ä¿¡æ¯]
    J --> K[å®Œæˆ]
    C --> K
    E --> K
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### è‡ªåŠ¨åˆå§‹åŒ–

ç³»ç»Ÿå¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬ï¼š

```bash
# å¯åŠ¨åº”ç”¨ï¼ˆAppHostä¼šè‡ªåŠ¨è¿è¡Œåˆå§‹åŒ–ï¼‰
dotnet run --project Platform.AppHost
```

### æ‰‹åŠ¨åˆå§‹åŒ–

å¦‚æœéœ€è¦æ‰‹åŠ¨è§¦å‘åˆå§‹åŒ–ï¼Œå¯ä»¥åœ¨ `Program.cs` ä¸­è°ƒç”¨ï¼š

```csharp
var adminInitializer = new CreateAdminUser(database);
await adminInitializer.CreateDefaultAdminAsync();
```

## ğŸ“Š åˆå§‹åŒ–è¾“å‡ºç¤ºä¾‹

```
âœ… åˆ›å»ºç³»ç»Ÿä¼ä¸š: ç³»ç»Ÿä¼ä¸š (Code: system)
âœ… åˆ›å»ºè¶…çº§ç®¡ç†å‘˜è§’è‰²: è¶…çº§ç®¡ç†å‘˜
âœ… åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·: admin (å¯†ç : admin123)
âœ… åˆ›å»ºç”¨æˆ·-ä¼ä¸šå…³è”: admin â†” ç³»ç»Ÿä¼ä¸š

============================================================
ğŸ‰ ç®¡ç†å‘˜åˆå§‹åŒ–å®Œæˆï¼
============================================================
ä¼ä¸šåç§°: ç³»ç»Ÿä¼ä¸š
ä¼ä¸šä»£ç : system
ç®¡ç†å‘˜è´¦å·: admin
ç®¡ç†å‘˜å¯†ç : admin123
ç®¡ç†å‘˜é‚®ç®±: admin@example.com
ç®¡ç†å‘˜è§’è‰²: è¶…çº§ç®¡ç†å‘˜
============================================================
```

## ğŸ”’ é»˜è®¤ç™»å½•å‡­æ®

| å­—æ®µ | å€¼ |
|-----|-----|
| **ç”¨æˆ·å** | admin |
| **å¯†ç ** | admin123 |
| **ä¼ä¸šä»£ç ** | systemï¼ˆv3.1ä¸å†éœ€è¦è¾“å…¥ï¼‰ |

âš ï¸ **å®‰å…¨æç¤º**ï¼šé¦–æ¬¡ç™»å½•åï¼Œå¼ºçƒˆå»ºè®®ç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç ï¼

## ğŸ¯ å¤šç§Ÿæˆ·æ¶æ„è¯´æ˜

### v3.1 å¤šç§Ÿæˆ·æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç³»ç»Ÿä¼ä¸š (system)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - ç”¨äºç³»ç»Ÿçº§ç®¡ç†å‘˜                                       â”‚
â”‚  - æœ€å¤§ç”¨æˆ·æ•°ï¼š10000                                      â”‚
â”‚  - æ°¸ä¸è¿‡æœŸ                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                    ç”¨æˆ·-ä¼ä¸šå…³è”
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ç®¡ç†å‘˜ç”¨æˆ· (admin)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - CompanyId: systemä¼ä¸šID                               â”‚
â”‚  - CurrentCompanyId: systemä¼ä¸šID                        â”‚
â”‚  - PersonalCompanyId: systemä¼ä¸šID                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                  åœ¨ç³»ç»Ÿä¼ä¸šä¸­çš„è§’è‰²
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                è¶…çº§ç®¡ç†å‘˜è§’è‰² (è¶…çº§ç®¡ç†å‘˜)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - æ‹¥æœ‰æ‰€æœ‰èœå•æƒé™                                       â”‚
â”‚  - æ‹¥æœ‰æ‰€æœ‰åŠŸèƒ½æƒé™                                       â”‚
â”‚  - å¯ä»¥ç®¡ç†æ‰€æœ‰ä¼ä¸š                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®å…³ç³»

```typescript
// 1. Company (ç³»ç»Ÿä¼ä¸š)
{
  id: "...",
  code: "system",
  name: "ç³»ç»Ÿä¼ä¸š",
  maxUsers: 10000,
  expiresAt: null
}

// 2. Role (è¶…çº§ç®¡ç†å‘˜è§’è‰²)
{
  id: "...",
  name: "è¶…çº§ç®¡ç†å‘˜",
  description: "ç³»ç»Ÿè¶…çº§ç®¡ç†å‘˜ï¼Œæ‹¥æœ‰æ‰€æœ‰æƒé™",
  menuIds: [...],
  permissionIds: [...]
}

// 3. AppUser (ç®¡ç†å‘˜ç”¨æˆ·)
{
  id: "...",
  username: "admin",
  companyId: "<ç³»ç»Ÿä¼ä¸šID>",          // æ‰€å±ä¼ä¸š
  currentCompanyId: "<ç³»ç»Ÿä¼ä¸šID>",   // å½“å‰ä¼ä¸š
  personalCompanyId: "<ç³»ç»Ÿä¼ä¸šID>"   // ä¸ªäººä¼ä¸š
}

// 4. UserCompany (ç”¨æˆ·-ä¼ä¸šå…³è”)
{
  userId: "<adminç”¨æˆ·ID>",
  companyId: "<ç³»ç»Ÿä¼ä¸šID>",
  roleIds: ["<è¶…çº§ç®¡ç†å‘˜è§’è‰²ID>"],   // åœ¨è¯¥ä¼ä¸šä¸­çš„è§’è‰²
  isAdmin: true,                     // ä¼ä¸šç®¡ç†å‘˜
  status: "active"                   // çŠ¶æ€
}
```

## ğŸ”„ ä¸æ—§ç‰ˆæœ¬çš„å·®å¼‚

### v2.0ï¼ˆå·²åºŸå¼ƒï¼‰

```csharp
// âŒ æ—§ç‰ˆæœ¬ï¼šç›´æ¥åœ¨ç”¨æˆ·ä¸Šå­˜å‚¨è§’è‰²
var adminUser = new AppUser
{
    Username = "admin",
    RoleIds = new List<string> { adminRoleId },  // âŒ ç›´æ¥å­˜å‚¨
    // âŒ æ²¡æœ‰ä¼ä¸šæ¦‚å¿µ
};
```

### v3.1ï¼ˆå½“å‰ç‰ˆæœ¬ï¼‰

```csharp
// âœ… æ–°ç‰ˆæœ¬ï¼šé€šè¿‡ä¼ä¸šå…³è”å­˜å‚¨è§’è‰²
var adminUser = new AppUser
{
    Username = "admin",
    CompanyId = systemCompanyId,          // âœ… æ‰€å±ä¼ä¸š
    CurrentCompanyId = systemCompanyId,   // âœ… å½“å‰ä¼ä¸š
    PersonalCompanyId = systemCompanyId,  // âœ… ä¸ªäººä¼ä¸š
};

// âœ… è§’è‰²å­˜å‚¨åœ¨ç”¨æˆ·-ä¼ä¸šå…³è”ä¸­
var userCompany = new UserCompany
{
    UserId = adminUserId,
    CompanyId = systemCompanyId,
    RoleIds = new List<string> { adminRoleId },  // âœ… é€šè¿‡å…³è”è¡¨
    IsAdmin = true
};
```

## ğŸ› ï¸ ç»´æŠ¤å’Œç®¡ç†

### æ£€æŸ¥åˆå§‹åŒ–çŠ¶æ€

```csharp
// æ£€æŸ¥adminç”¨æˆ·
db.users.find({ username: "admin", isDeleted: false })

// æ£€æŸ¥ç³»ç»Ÿä¼ä¸š
db.companies.find({ code: "system", isDeleted: false })

// æ£€æŸ¥ç”¨æˆ·-ä¼ä¸šå…³è”
db.userCompanies.find({ userId: "<adminId>", isDeleted: false })
```

### é‡ç½®ç®¡ç†å‘˜å¯†ç 

```csharp
var passwordHash = BCrypt.Net.BCrypt.HashPassword("newPassword");
db.users.updateOne(
    { username: "admin" },
    { $set: { passwordHash: passwordHash, updatedAt: new Date() } }
)
```

### æ¢å¤å·²åˆ é™¤çš„ç®¡ç†å‘˜

åˆå§‹åŒ–è„šæœ¬ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶æ¢å¤å·²è½¯åˆ é™¤çš„ admin ç”¨æˆ·ã€‚

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¤šç§Ÿæˆ·ç³»ç»Ÿè¯´æ˜](../features/MULTI-TENANT-SYSTEM.md)
- [ç”¨æˆ·-ä¼ä¸šå…³è”è®¾è®¡](../features/MULTI-COMPANY-MEMBERSHIP-DESIGN.md)
- [æƒé™ç³»ç»Ÿæ–‡æ¡£](../permissions/CRUD-PERMISSION-SYSTEM.md)
- [BaseEntity æ ‡å‡†](../optimization/BASE-ENTITY-STANDARD.md)

## ğŸ¯ æœ€ä½³å®è·µ

1. âœ… **é¦–æ¬¡ç™»å½•åç«‹å³ä¿®æ”¹å¯†ç **
2. âœ… **ä¸ºä¸åŒä¼ä¸šåˆ›å»ºä¸åŒçš„ç®¡ç†å‘˜**
3. âœ… **å®šæœŸæ£€æŸ¥ç³»ç»Ÿä¼ä¸šçš„é…ç½®**
4. âœ… **ä½¿ç”¨è¶…çº§ç®¡ç†å‘˜è§’è‰²ç®¡ç†å…¶ä»–ä¼ä¸š**
5. âœ… **ä¸è¦åˆ é™¤ç³»ç»Ÿä¼ä¸šå’Œè¶…çº§ç®¡ç†å‘˜è§’è‰²**

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç³»ç»Ÿä¼ä¸š**ï¼šè¯·å‹¿åˆ é™¤æˆ–ä¿®æ”¹ç³»ç»Ÿä¼ä¸šçš„ codeï¼ˆ"system"ï¼‰
2. **è¶…çº§ç®¡ç†å‘˜è§’è‰²**ï¼šè¯·å‹¿åˆ é™¤è¶…çº§ç®¡ç†å‘˜è§’è‰²
3. **å¯†ç å®‰å…¨**ï¼šç”Ÿäº§ç¯å¢ƒè¯·åŠ¡å¿…ä¿®æ”¹é»˜è®¤å¯†ç 
4. **æ•°æ®ä¸€è‡´æ€§**ï¼šè¯·å‹¿ç›´æ¥ä¿®æ”¹æ•°æ®åº“ä¸­çš„å…³è”å…³ç³»

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šç™»å½•å¤±è´¥

**å¯èƒ½åŸå› **ï¼š
- å¯†ç é”™è¯¯
- admin ç”¨æˆ·è¢«åˆ é™¤
- ç”¨æˆ·-ä¼ä¸šå…³è”ç¼ºå¤±

**è§£å†³æ–¹æ³•**ï¼š
```bash
# é‡æ–°è¿è¡Œåˆå§‹åŒ–è„šæœ¬
dotnet run --project Platform.AppHost

# æˆ–è€…æ‰‹åŠ¨æ£€æŸ¥æ•°æ®åº“
mongo
use platformdb
db.users.find({ username: "admin" })
db.userCompanies.find({ userId: "<adminId>" })
```

### é—®é¢˜ï¼šæƒé™ä¸è¶³

**å¯èƒ½åŸå› **ï¼š
- è¶…çº§ç®¡ç†å‘˜è§’è‰²çš„æƒé™æœªåˆå§‹åŒ–
- èœå•æœªåˆå§‹åŒ–

**è§£å†³æ–¹æ³•**ï¼š
```bash
# è¿è¡Œæƒé™åˆå§‹åŒ–è„šæœ¬
# è¿è¡Œèœå•åˆå§‹åŒ–è„šæœ¬
```

## ğŸ“ æ›´æ–°æ—¥å¿—

### v3.1.0 (å½“å‰ç‰ˆæœ¬)
- âœ… æ”¯æŒå¤šç§Ÿæˆ·æ¶æ„
- âœ… è‡ªåŠ¨åˆ›å»ºç³»ç»Ÿä¼ä¸š
- âœ… åˆ›å»ºç”¨æˆ·-ä¼ä¸šå…³è”
- âœ… è®¾ç½® CompanyIdã€CurrentCompanyIdã€PersonalCompanyId
- âœ… è§’è‰²ä»ç”¨æˆ·æ¨¡å‹ç§»åˆ°å…³è”è¡¨

### v2.0 (å·²åºŸå¼ƒ)
- âŒ å•ç§Ÿæˆ·æ¶æ„
- âŒ è§’è‰²ç›´æ¥å­˜å‚¨åœ¨ç”¨æˆ·ä¸Š
- âŒ æ²¡æœ‰ä¼ä¸šæ¦‚å¿µ

---

**æœ€åæ›´æ–°**: 2024-01-14  
**ç‰ˆæœ¬**: v3.1.0  
**çŠ¶æ€**: âœ… ç¨³å®š

