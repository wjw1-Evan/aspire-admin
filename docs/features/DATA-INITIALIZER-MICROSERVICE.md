# æ•°æ®åˆå§‹åŒ–å¾®æœåŠ¡æ¶æ„

## ğŸ“‹ æ¦‚è¿°

`Platform.DataInitializer` æ˜¯ä¸€ä¸ªä¸“é—¨è´Ÿè´£æ•°æ®åˆå§‹åŒ–å·¥ä½œçš„å¾®æœåŠ¡ï¼Œå°†åŸæœ¬åœ¨ `Platform.ApiService` ä¸­çš„æ•°æ®åˆå§‹åŒ–é€»è¾‘åˆ†ç¦»å‡ºæ¥ï¼Œå®ç°æ›´æ¸…æ™°çš„èŒè´£åˆ†ç¦»å’Œæ›´å¥½çš„å¯ç»´æŠ¤æ€§ã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
- **æ•°æ®åº“ç´¢å¼•åˆ›å»º** - è‡ªåŠ¨åˆ›å»ºæ‰€æœ‰å¿…è¦çš„ MongoDB ç´¢å¼•
- **å…¨å±€èœå•åˆå§‹åŒ–** - åˆ›å»ºç³»ç»Ÿçº§èœå•ï¼ˆæ‰€æœ‰ä¼ä¸šå…±äº«ï¼‰
- **å•å®ä¾‹è¿è¡Œ** - ç¡®ä¿åªæœ‰ä¸€ä¸ªå®ä¾‹æ‰§è¡Œåˆå§‹åŒ–
- **å¹‚ç­‰æ€§ä¿è¯** - å¯ä»¥å®‰å…¨åœ°é‡å¤æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ

### æŠ€æœ¯ç‰¹æ€§
- **å¾®æœåŠ¡æ¶æ„** - ç‹¬ç«‹çš„ .NET 9 Web API æœåŠ¡
- **Aspire é›†æˆ** - å®Œå…¨é›†æˆåˆ° .NET Aspire ç”Ÿæ€
- **å¥åº·æ£€æŸ¥** - æä¾› `/health` ç«¯ç‚¹ç›‘æ§æœåŠ¡çŠ¶æ€
- **API æ–‡æ¡£** - é›†æˆ Scalar API æ–‡æ¡£
- **æ—¥å¿—è®°å½•** - è¯¦ç»†çš„åˆå§‹åŒ–è¿‡ç¨‹æ—¥å¿—

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æœåŠ¡èŒè´£åˆ†ç¦»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Platform.ApiService   â”‚    â”‚ Platform.DataInitializerâ”‚
â”‚                         â”‚    â”‚                         â”‚
â”‚  â€¢ ç”¨æˆ·è®¤è¯            â”‚    â”‚  â€¢ æ•°æ®åº“ç´¢å¼•åˆ›å»º       â”‚
â”‚  â€¢ ä¸šåŠ¡é€»è¾‘            â”‚    â”‚  â€¢ èœå•åˆå§‹åŒ–           â”‚
â”‚  â€¢ API æ¥å£            â”‚    â”‚  â€¢ åˆå§‹åŒ–çŠ¶æ€ç®¡ç†       â”‚
â”‚  â€¢ æ•°æ®æ“ä½œ            â”‚    â”‚  â€¢ å•å®ä¾‹è¿è¡Œä¿è¯       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                              â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚      MongoDB            â”‚
            â”‚                         â”‚
            â”‚  â€¢ æ•°æ®å­˜å‚¨             â”‚
            â”‚  â€¢ ç´¢å¼•ç®¡ç†             â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åˆå§‹åŒ–æµç¨‹

```mermaid
graph TD
    A[DataInitializer å¯åŠ¨] --> B[æ‰§è¡Œåˆå§‹åŒ–]
    B --> C[åˆ›å»ºæ•°æ®åº“ç´¢å¼•]
    C --> D[åˆ›å»ºå…¨å±€èœå•]
    D --> E[åˆå§‹åŒ–å®Œæˆ]
```

## ğŸ”§ å®ç°ç»†èŠ‚

### 1. æ•°æ®åˆå§‹åŒ–æœåŠ¡

```csharp
public class DataInitializerService : IDataInitializerService
{
    public async Task InitializeAsync()
    {
        // 1. åˆ›å»ºæ•°æ®åº“ç´¢å¼•
        await CreateIndexesAsync();
        
        // 2. åˆ›å»ºå…¨å±€èœå•
        await CreateSystemMenusAsync();
    }
}
```

**åŠŸèƒ½ï¼š**
- ç´¢å¼•åˆ›å»ºï¼ˆå¹‚ç­‰æ€§ï¼‰
- èœå•åˆå§‹åŒ–ï¼ˆå…¨å±€èµ„æºï¼‰
- é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- å•å®ä¾‹è¿è¡Œä¿è¯

### 2. èœå•åˆå§‹åŒ–

```csharp
private async Task CreateSystemMenusAsync()
{
    // æ£€æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–
    var existingCount = await menus.CountDocumentsAsync(Builders<Menu>.Filter.Empty);
    if (existingCount > 0) return;
    
    // åˆ›å»ºå…¨å±€èœå•
    var welcomeMenu = new Menu { Name = "welcome", Title = "æ¬¢è¿", ... };
    var systemMenu = new Menu { Name = "system", Title = "ç³»ç»Ÿç®¡ç†", ... };
    
    // æ’å…¥èœå•å’Œå­èœå•
}
```

## ğŸš€ éƒ¨ç½²å’Œé…ç½®

### AppHost é…ç½®

```csharp
// æ•°æ®åˆå§‹åŒ–æœåŠ¡
var datainitializer = builder.AddProject<Projects.Platform_DataInitializer>("datainitializer")
    .WithReference(mongodb)
    .WithEnvironment("ASPNETCORE_ENVIRONMENT", DevelopmentEnvironment)
    .WithEnvironment("Logging__LogLevel__Platform.DataInitializer", DebugLogLevel)
    .WithHttpEndpoint()
    .WithHttpHealthCheck("/health");

// API æœåŠ¡ä¾èµ–æ•°æ®åˆå§‹åŒ–æœåŠ¡
var apiservice = builder.AddProject<Projects.Platform_ApiService>("apiservice")
    .WithReference(mongodb)
    .WithReference(datainitializer) // ä¾èµ–å…³ç³»
    .WithHttpEndpoint().WithReplicas(3);
```

### æœåŠ¡ä¾èµ–å…³ç³»

```
MongoDB â† DataInitializer â† ApiService
                â†“
            Admin/App (å‰ç«¯åº”ç”¨)
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### å¥åº·æ£€æŸ¥ç«¯ç‚¹

```http
GET /health
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "status": "healthy",
  "service": "DataInitializer"
}
```

### åˆå§‹åŒ–ç«¯ç‚¹

```http
POST /initialize
```

**åŠŸèƒ½ï¼š**
- æ‰‹åŠ¨è§¦å‘æ•°æ®åˆå§‹åŒ–
- è¿”å›åˆå§‹åŒ–çŠ¶æ€
- é”™è¯¯å¤„ç†å’ŒæŠ¥å‘Š

### æ—¥å¿—è®°å½•

```
========== å¼€å§‹æ•°æ®åˆå§‹åŒ– ==========
å½“å‰å®ä¾‹è·å¾—åˆå§‹åŒ–é”ï¼Œå¼€å§‹æ‰§è¡Œåˆå§‹åŒ–...
å¼€å§‹åˆ›å»ºæ•°æ®åº“ç´¢å¼•...
âœ… åˆ›å»ºç´¢å¼•: menus.name (å…¨å±€å”¯ä¸€)
âœ… åˆ›å»ºç´¢å¼•: menus.parentId + sortOrder
å¼€å§‹åˆ›å»ºå…¨å±€ç³»ç»Ÿèœå•...
å…¨å±€ç³»ç»Ÿèœå•åˆ›å»ºå®Œæˆï¼Œå…±åˆ›å»º 7 ä¸ªèœå•
æ‰€æœ‰åˆå§‹åŒ–æ“ä½œæ‰§è¡Œå®Œæˆ
========== æ•°æ®åˆå§‹åŒ–å®Œæˆ ==========
```

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. åˆå§‹åŒ–å¤±è´¥

**ç°è±¡ï¼š** æ—¥å¿—æ˜¾ç¤ºåˆå§‹åŒ–å¤±è´¥
**åŸå› ï¼š** MongoDB è¿æ¥é—®é¢˜æˆ–æƒé™ä¸è¶³
**è§£å†³ï¼š** æ£€æŸ¥ MongoDB è¿æ¥é…ç½®å’Œæƒé™

#### 2. åˆå§‹åŒ–é‡å¤æ‰§è¡Œ

**ç°è±¡ï¼š** å¤šæ¬¡å¯åŠ¨æ—¶é‡å¤æ‰§è¡Œåˆå§‹åŒ–
**åŸå› ï¼š** å¹‚ç­‰æ€§è®¾è®¡ï¼Œé‡å¤æ‰§è¡Œæ˜¯å®‰å…¨çš„
**è§£å†³ï¼š** æ— éœ€å¤„ç†ï¼Œç³»ç»Ÿä¼šæ£€æŸ¥å·²å­˜åœ¨çš„æ•°æ®

#### 3. èœå•é‡å¤åˆ›å»º

**ç°è±¡ï¼š** èœå•æ•°æ®é‡å¤
**åŸå› ï¼š** åˆå§‹åŒ–é€»è¾‘é—®é¢˜
**è§£å†³ï¼š** æ£€æŸ¥å¹‚ç­‰æ€§é€»è¾‘ï¼Œç¡®ä¿æ­£ç¡®åˆ¤æ–­å·²å­˜åœ¨æ•°æ®

### è°ƒè¯•æ–¹æ³•

1. **æŸ¥çœ‹åˆå§‹åŒ–æ—¥å¿—**
   ```bash
   # åœ¨ Aspire Dashboard ä¸­æŸ¥çœ‹ DataInitializer æœåŠ¡æ—¥å¿—
   ```

2. **æ‰‹åŠ¨è§¦å‘åˆå§‹åŒ–**
   ```bash
   curl -X POST http://localhost:15000/datainitializer/initialize
   ```

3. **æ£€æŸ¥æ•°æ®åº“çŠ¶æ€**
   ```javascript
   // MongoDB æŸ¥è¯¢
   db.menus.countDocuments() // æ£€æŸ¥èœå•æ•°é‡
   db.menus.getIndexes()     // æ£€æŸ¥ç´¢å¼•
   ```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. åˆå§‹åŒ–é¡ºåº

- DataInitializer å¿…é¡»åœ¨ ApiService ä¹‹å‰å¯åŠ¨
- ç¡®ä¿ MongoDB è¿æ¥æ­£å¸¸
- ç›‘æ§åˆå§‹åŒ–æ—¥å¿—

### 2. é”™è¯¯å¤„ç†

- åˆå§‹åŒ–å¤±è´¥ä¸åº”é˜»æ­¢åº”ç”¨å¯åŠ¨
- æä¾›é‡è¯•æœºåˆ¶
- è®°å½•è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

### 3. æ€§èƒ½ä¼˜åŒ–

- å¹‚ç­‰æ€§æ£€æŸ¥é¿å…é‡å¤åˆå§‹åŒ–
- æ‰¹é‡æ“ä½œå‡å°‘æ•°æ®åº“è®¿é—®
- å•å®ä¾‹è¿è¡Œä¿è¯æ€§èƒ½

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¾®æœåŠ¡æ¶æ„è®¾è®¡](mdc:docs/features/MICROSERVICE-ARCHITECTURE.md)
- [æ•°æ®åº“åˆå§‹åŒ–è§„èŒƒ](mdc:.cursor/rules/database-initialization.mdc)
- [å…¨å±€èœå•æ¶æ„](mdc:.cursor/rules/global-menu-architecture.mdc)
- [Aspire æœåŠ¡ç¼–æ’](mdc:README.md)

## ğŸ”„ ç‰ˆæœ¬å†å²

### v1.0.0 (2024-01-XX)
- åˆå§‹ç‰ˆæœ¬
- åŸºç¡€æ•°æ®åˆå§‹åŒ–åŠŸèƒ½
- å•å®ä¾‹è¿è¡Œä¿è¯
- Aspire é›†æˆ

## ğŸ¯ æœªæ¥è§„åˆ’

- [ ] æ”¯æŒæ›´å¤šæ•°æ®ç±»å‹çš„åˆå§‹åŒ–
- [ ] æ·»åŠ æ•°æ®è¿ç§»åŠŸèƒ½
- [ ] æ”¯æŒé…ç½®åŒ–çš„åˆå§‹åŒ–è„šæœ¬
- [ ] æ·»åŠ åˆå§‹åŒ–è¿›åº¦ç›‘æ§
- [ ] æ”¯æŒå›æ»šæœºåˆ¶
