# 表情包功能实现说明

## 功能概述

在聊天页面中实现了表情包选择器功能，用户可以通过点击表情按钮打开表情面板，选择表情并插入到消息输入框中。

## 功能特性

1. **表情包选择器**：
   - 点击输入框右侧的表情按钮打开/关闭表情面板
   - 表情按类别分组显示（表情、情绪、手势、人物、心形、动物、食物、符号）
   - 支持滚动查看所有表情
   - 点击表情自动插入到输入框光标位置

2. **表情数据**：
   - 使用 Unicode emoji，兼容性好
   - 包含 8 个常用类别，共约 240+ 个常用表情
   - 支持所有平台（iOS、Android、Web）

3. **交互体验**：
   - 点击表情按钮切换表情面板显示/隐藏
   - 打开表情面板时自动隐藏键盘
   - 点击表情后自动聚焦输入框
   - 输入框聚焦时自动隐藏表情面板
   - 表情按钮在面板打开时显示激活状态

## 实现方式

### 1. 表情包选择器组件

创建了 `EmojiPicker` 组件：

```typescript
// Platform.App/components/chat/EmojiPicker.tsx
- 表情按类别分组（EMOJI_CATEGORIES）
- 使用 FlatList 渲染表情列表
- 每行显示 8 个表情
- 点击表情调用 onEmojiSelected 回调
```

### 2. 消息输入框集成

在 `MessageComposer` 中集成表情包选择器：

```typescript
// Platform.App/components/chat/MessageComposer.tsx
- 添加 showEmojiPicker 状态
- 添加 inputRef 引用（用于光标位置）
- handleEmojiPress: 切换表情面板显示
- handleEmojiSelected: 在光标位置插入表情
- 表情按钮显示激活状态
```

### 3. 表情插入逻辑

- 支持在光标位置插入表情
- 如果没有光标，则在文本末尾插入
- 插入后自动设置光标位置到插入的表情之后
- 延迟聚焦输入框，确保表情已正确插入

### 4. 消息显示

- React Native 的 `Text` 组件原生支持 Unicode emoji
- 不需要特殊处理，表情会正常显示
- 支持所有标准的 Unicode emoji

## 表情分类

表情按以下类别分组：

1. **表情**（30个）：😀 😃 😄 😁 😆 😅 🤣 😂 等
2. **情绪**（30个）：🤐 🤨 😐 😑 😶 😏 😒 🙄 等
3. **手势**（30个）：👍 👎 👊 ✊ 🤛 🤜 🤞 ✌️ 等
4. **人物**（30个）：👶 👦 👧 🧒 👨 👩 🧑 👱‍♂️ 等
5. **心形**（20个）：❤️ 🧡 💛 💚 💙 💜 🖤 🤍 等
6. **动物**（30个）：🐶 🐱 🐭 🐹 🐰 🦊 🐻 🐼 等
7. **食物**（30个）：🍏 🍎 🍐 🍊 🍋 🍌 🍉 🍇 等
8. **符号**（30个）：✅ ❌ ⭕ ❎ 💯 ✔️ ☑️ 🔘 等

## 使用方法

1. **打开表情面板**：
   - 在消息输入框右侧点击表情按钮（😊图标）
   - 表情面板会在输入框下方显示

2. **选择表情**：
   - 在表情面板中滚动查看不同类别的表情
   - 点击想要的表情即可插入到输入框

3. **关闭表情面板**：
   - 再次点击表情按钮关闭面板
   - 或者点击输入框聚焦时自动关闭

4. **发送消息**：
   - 插入表情后，正常输入其他文字
   - 点击发送按钮发送包含表情的消息

## 代码结构

### 新增文件

- `Platform.App/components/chat/EmojiPicker.tsx` - 表情包选择器组件

### 修改文件

- `Platform.App/components/chat/MessageComposer.tsx` - 集成表情包选择器

## 技术细节

### 光标位置处理

React Native 的 `TextInput` 不支持直接访问 `selectionStart` 和 `selectionEnd`，需要通过以下方式处理：

1. 使用 `inputRef.current` 访问输入框实例
2. 通过类型断言访问 `selectionStart` 和 `selectionEnd`
3. 插入表情后使用 `setNativeProps` 设置新的光标位置

### 表情数据存储

- 表情数据直接定义在组件中（`EMOJI_CATEGORIES`）
- 使用 Unicode emoji，不需要图片资源
- 所有表情都是纯文本，可以通过 API 正常传输和存储

### 性能优化

- 使用 `FlatList` 渲染大量表情，支持虚拟滚动
- 使用 `useCallback` 优化回调函数
- 表情按钮状态使用条件样式，避免不必要的重渲染

## 未来扩展

可以扩展的功能：

1. **表情搜索**：
   - 添加搜索框，支持按关键词搜索表情

2. **最近使用**：
   - 记录最近使用的表情
   - 在表情面板顶部显示最近使用的表情

3. **自定义表情包**：
   - 支持上传自定义表情包
   - 支持从相册选择图片作为表情

4. **表情面板优化**：
   - 添加分类标签页，快速切换类别
   - 优化表情大小和间距
   - 支持表情预览（长按显示大图）

## 相关代码

- `Platform.App/components/chat/EmojiPicker.tsx` - 表情包选择器组件
- `Platform.App/components/chat/MessageComposer.tsx` - 消息输入框组件
- `Platform.App/components/chat/MessageList.tsx` - 消息列表组件（显示表情）

## 创建日期

2025-01-27

