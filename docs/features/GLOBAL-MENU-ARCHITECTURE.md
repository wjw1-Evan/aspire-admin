# å…¨å±€èœå•æ¶æ„è®¾è®¡

## ğŸ“‹ æ¶æ„å˜æ›´è¯´æ˜

**å˜æ›´æ—¥æœŸ**: 2025-01-14  
**ç‰ˆæœ¬**: v5.0  
**ç±»å‹**: ğŸ”´ **é‡å¤§æ¶æ„å˜æ›´**

### æ ¸å¿ƒå†³ç­–

**èœå•ä»"ä¼ä¸šä¸“å±èµ„æº"å˜æ›´ä¸º"å…¨å±€ç³»ç»Ÿèµ„æº"**

- **ä¹‹å‰**: æ¯ä¸ªä¼ä¸šæœ‰è‡ªå·±çš„èœå•ï¼Œé€šè¿‡ `CompanyId` éš”ç¦»
- **ç°åœ¨**: æ‰€æœ‰ä¼ä¸šå…±äº«ç›¸åŒçš„ç³»ç»Ÿèœå•ï¼Œé€šè¿‡æƒé™æ§åˆ¶æ˜¾ç¤º

## ğŸ¯ è®¾è®¡ç†å¿µ

### ä¸ºä»€ä¹ˆé‡‡ç”¨å…¨å±€èœå•ï¼Ÿ

1. **ç»Ÿä¸€ç”¨æˆ·ä½“éªŒ**: æ‰€æœ‰ä¼ä¸šçœ‹åˆ°ç›¸åŒçš„èœå•ç»“æ„
2. **ç®€åŒ–ç®¡ç†**: ä¸éœ€è¦æ¯ä¸ªä¼ä¸šå•ç‹¬ç®¡ç†èœå•
3. **æƒé™æ§åˆ¶**: é€šè¿‡ç”¨æˆ·æƒé™å†³å®šèœå•æ˜¯å¦æ˜¾ç¤ºï¼Œè€Œä¸æ˜¯èœå•å½’å±
4. **ç³»ç»Ÿç»´æŠ¤**: èœå•ä½œä¸ºç³»ç»ŸåŠŸèƒ½ï¼Œç”±ç³»ç»Ÿç»Ÿä¸€ç®¡ç†

### èœå•æ˜¾ç¤ºé€»è¾‘

```
ç³»ç»Ÿèœå•ï¼ˆå…¨å±€ï¼‰
    â†“
ç”¨æˆ·æƒé™ï¼ˆä¼ä¸šä¸“å±ï¼‰
    â†“
æ ¹æ®æƒé™è¿‡æ»¤èœå•
    â†“
æ˜¾ç¤ºç”¨æˆ·å¯è§çš„èœå•
```

## ğŸ—ï¸ æŠ€æœ¯å®ç°

### 1. æ•°æ®æ¨¡å‹å˜æ›´

**ä¹‹å‰**:
```csharp
public class Menu : MultiTenantEntity, INamedEntity
{
    // æœ‰ CompanyId
}
```

**ç°åœ¨**:
```csharp
public class Menu : BaseEntity, INamedEntity
{
    // æ—  CompanyIdï¼Œå…¨å±€èµ„æº
}
```

### 2. èœå•åˆ›å»ºæ—¶æœº

**ä¹‹å‰**: ç”¨æˆ·æ³¨å†Œæ—¶åˆ›å»º
```csharp
// âŒ æ—§æ–¹å¼
CreatePersonalCompanyAsync()
  â”œâ”€ åˆ›å»ºä¼ä¸š
  â”œâ”€ åˆ›å»ºæƒé™
  â”œâ”€ åˆ›å»ºè§’è‰²
  â””â”€ åˆ›å»ºèœå• â† æ¯ä¸ªä¼ä¸šä¸€ä»½
```

**ç°åœ¨**: ç³»ç»Ÿåˆå§‹åŒ–æ—¶åˆ›å»º
```csharp
// âœ… æ–°æ–¹å¼
DatabaseInitializerService.InitializeAsync()
  â”œâ”€ åˆ›å»ºç´¢å¼•
  â””â”€ åˆ›å»ºå…¨å±€èœå• â† æ‰€æœ‰ä¼ä¸šå…±äº«
```

### 3. èœå•æƒé™æ§åˆ¶

æ¯ä¸ªèœå•å¯ä»¥é…ç½®æ‰€éœ€æƒé™ï¼š

```csharp
new Menu
{
    Name = "user-management",
    Title = "ç”¨æˆ·ç®¡ç†",
    Path = "/system/user-management",
    Permissions = new List<string> { "user:read" },  // âœ… éœ€è¦ç”¨æˆ·æŸ¥çœ‹æƒé™
    // ...
}
```

**æ˜¾ç¤ºé€»è¾‘**ï¼š
- ç”¨æˆ·æœ‰ `user:read` æƒé™ â†’ æ˜¾ç¤º"ç”¨æˆ·ç®¡ç†"èœå•
- ç”¨æˆ·æ—  `user:read` æƒé™ â†’ éšè—"ç”¨æˆ·ç®¡ç†"èœå•

## ğŸ“Š é»˜è®¤èœå•ç»“æ„

### èœå•æ ‘

```
æ¬¢è¿ (/welcome)
  - æ— æƒé™è¦æ±‚ï¼Œæ‰€æœ‰ç”¨æˆ·å¯è§

ç³»ç»Ÿç®¡ç† (/system)
  â”œâ”€ ç”¨æˆ·ç®¡ç† (/system/user-management)
  â”‚   â””â”€ éœ€è¦æƒé™ï¼šuser:read
  â”œâ”€ è§’è‰²ç®¡ç† (/system/role-management)
  â”‚   â””â”€ éœ€è¦æƒé™ï¼šrole:read
  â”œâ”€ ç”¨æˆ·æ—¥å¿— (/system/user-log)
  â”‚   â””â”€ éœ€è¦æƒé™ï¼šactivity-log:read
  â””â”€ ä¼ä¸šè®¾ç½® (/system/company-settings)
      â””â”€ éœ€è¦æƒé™ï¼šcompany:read
```

### èœå•è¯¦ç»†é…ç½®

| èœå• | Name | Path | Icon | Permissions | ParentId |
|-----|------|------|------|-------------|----------|
| æ¬¢è¿ | welcome | /welcome | smile | [] | null |
| ç³»ç»Ÿç®¡ç† | system | /system | setting | [] | null |
| ç”¨æˆ·ç®¡ç† | user-management | /system/user-management | user | [user:read] | system |
| è§’è‰²ç®¡ç† | role-management | /system/role-management | team | [role:read] | system |
| ç”¨æˆ·æ—¥å¿— | user-log | /system/user-log | file-text | [activity-log:read] | system |
| ä¼ä¸šè®¾ç½® | company-settings | /system/company-settings | bank | [company:read] | system |

## ğŸš« ç§»é™¤çš„åŠŸèƒ½

### 1. èœå•ç®¡ç†æ¨¡å—

- âŒ åˆ é™¤å‰ç«¯é¡µé¢ï¼š`Platform.Admin/src/pages/menu-management/`
- âŒ åˆ é™¤åç«¯æ§åˆ¶å™¨ï¼š`Platform.ApiService/Controllers/MenuController.cs`
- âŒ åˆ é™¤è·¯ç”±é…ç½®ï¼š`/system/menu-management`

**åŸå› **: èœå•ç”±ç³»ç»Ÿç»Ÿä¸€ç®¡ç†ï¼Œç”¨æˆ·ï¼ˆåŒ…æ‹¬ç®¡ç†å‘˜ï¼‰ä¸èƒ½ä¿®æ”¹

### 2. èœå•ç›¸å…³æƒé™

ä»é»˜è®¤æƒé™ä¸­ç§»é™¤ï¼š
- âŒ `menu:create`
- âŒ `menu:read`
- âŒ `menu:update`
- âŒ `menu:delete`

**åŸå› **: èœå•æ˜¯ç³»ç»Ÿèµ„æºï¼Œä¸éœ€è¦ CRUD æƒé™

### 3. ä¼ä¸šèœå•ç»Ÿè®¡

```csharp
// âŒ æ—§ç‰ˆæœ¬ç»Ÿè®¡
TotalMenus = await _menus.CountDocumentsAsync(...)

// âœ… æ–°ç‰ˆæœ¬
TotalMenus = 0,  // èœå•æ˜¯å…¨å±€èµ„æºï¼Œä¸å†ç»Ÿè®¡
```

## ğŸ”§ å¼€å‘è§„èŒƒ

### æ·»åŠ æ–°èœå•

è¦æ·»åŠ æ–°çš„ç³»ç»Ÿèœå•ï¼Œä¿®æ”¹ `DatabaseInitializerService.cs`ï¼š

```csharp
private async Task CreateSystemMenusAsync()
{
    // åœ¨ childMenus æ•°ç»„ä¸­æ·»åŠ æ–°èœå•
    new Models.Menu
    {
        Name = "new-feature",
        Title = "æ–°åŠŸèƒ½",
        Path = "/system/new-feature",
        Component = "./new-feature",
        Icon = "star",
        ParentId = systemMenu.Id,
        SortOrder = 5,
        IsEnabled = true,
        Permissions = new List<string> { "new-feature:read" },
        // ...
    }
}
```

**é‡è¦æ­¥éª¤**ï¼š
1. åœ¨ `DatabaseInitializerService.cs` ä¸­æ·»åŠ èœå•å®šä¹‰
2. åˆ›å»ºå¯¹åº”çš„å‰ç«¯é¡µé¢ç»„ä»¶
3. åœ¨ `routes.ts` ä¸­æ·»åŠ è·¯ç”±
4. åˆ›å»ºå¯¹åº”çš„æƒé™ï¼ˆå¦‚éœ€è¦ï¼‰
5. æ¸…ç©ºæ•°æ®åº“é‡æ–°åˆå§‹åŒ–ï¼Œæˆ–æ‰‹åŠ¨æ·»åŠ èœå•åˆ°æ•°æ®åº“

### èœå•æƒé™é…ç½®

```csharp
// ç®€å•æƒé™ï¼šå•ä¸ªæƒé™
Permissions = new List<string> { "user:read" }

// å¤æ‚æƒé™ï¼šå¤šä¸ªæƒé™ï¼ˆOR é€»è¾‘ï¼‰
Permissions = new List<string> { "user:read", "user:update" }

// æ— æƒé™è¦æ±‚ï¼ˆæ‰€æœ‰ç”¨æˆ·å¯è§ï¼‰
Permissions = new List<string>()
```

## ğŸ—„ï¸ æ•°æ®åº“å˜æ›´

### ç´¢å¼•å˜æ›´

**ä¹‹å‰**ï¼ˆå¤šç§Ÿæˆ·ç´¢å¼•ï¼‰:
```javascript
db.menus.createIndex({ companyId: 1, name: 1 })
db.menus.createIndex({ companyId: 1, parentId: 1 })
db.menus.createIndex({ companyId: 1, isDeleted: 1, isEnabled: 1 })
```

**ç°åœ¨**ï¼ˆå…¨å±€ç´¢å¼•ï¼‰:
```javascript
db.menus.createIndex({ name: 1 }, { unique: true })  // åç§°å…¨å±€å”¯ä¸€
db.menus.createIndex({ parentId: 1, sortOrder: 1 })
db.menus.createIndex({ isDeleted: 1, isEnabled: 1 })
```

### æ•°æ®è¿ç§»

å¦‚æœæœ‰æ—§æ•°æ®ï¼Œéœ€è¦æ¸…ç†ï¼š

```javascript
// 1. æ¸…ç©ºæ—§çš„ä¼ä¸šèœå•
db.menus.deleteMany({})

// 2. é‡å¯åº”ç”¨ï¼Œè‡ªåŠ¨åˆ›å»ºå…¨å±€èœå•
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### ç³»ç»Ÿåˆå§‹åŒ–æµ‹è¯•

```bash
# 1. æ¸…ç©ºæ•°æ®åº“
mongo aspire-admin --eval "db.dropDatabase()"

# 2. å¯åŠ¨åº”ç”¨
dotnet run --project Platform.AppHost

# 3. æ£€æŸ¥èœå•
mongo aspire-admin --eval "db.menus.find().pretty()"

# é¢„æœŸç»“æœï¼š
# - 6 ä¸ªå…¨å±€èœå•
# - æ²¡æœ‰ companyId å­—æ®µ
# - name å­—æ®µå”¯ä¸€
```

### ç”¨æˆ·æ³¨å†Œæµ‹è¯•

```bash
# 1. æ³¨å†Œæ–°ç”¨æˆ·
# è®¿é—® http://localhost:15001/user/register

# 2. æ£€æŸ¥æ•°æ®
db.companies.countDocuments()      // 1ï¼ˆç”¨æˆ·çš„ä¸ªäººä¼ä¸šï¼‰
db.users.countDocuments()          // 1ï¼ˆæ³¨å†Œçš„ç”¨æˆ·ï¼‰
db.permissions.countDocuments()    // 24ï¼ˆ6ä¸ªèµ„æº Ã— 4ä¸ªæ“ä½œï¼Œæ—  menuï¼‰
db.menus.countDocuments()          // 6ï¼ˆå…¨å±€èœå•ï¼Œä¸å¢åŠ ï¼‰

# 3. ç™»å½•åæŸ¥çœ‹èœå•
# åº”è¯¥çœ‹åˆ°æ ¹æ®æƒé™è¿‡æ»¤åçš„èœå•
```

### æƒé™æ§åˆ¶æµ‹è¯•

```bash
# åœºæ™¯1: ç®¡ç†å‘˜ç”¨æˆ·ï¼ˆæ‰€æœ‰æƒé™ï¼‰
# åº”è¯¥çœ‹åˆ°æ‰€æœ‰èœå•

# åœºæ™¯2: æ™®é€šç”¨æˆ·ï¼ˆéƒ¨åˆ†æƒé™ï¼‰
# åªçœ‹åˆ°æœ‰æƒé™çš„èœå•

# åœºæ™¯3: æ–°æ³¨å†Œç”¨æˆ·ï¼ˆé»˜è®¤ç®¡ç†å‘˜è§’è‰²ï¼‰
# åº”è¯¥çœ‹åˆ°æ‰€æœ‰èœå•
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. èœå•ä¸å¯ä¿®æ”¹

- ç”¨æˆ·ï¼ˆåŒ…æ‹¬ç®¡ç†å‘˜ï¼‰ä¸èƒ½åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤èœå•
- èœå•ç”±ç³»ç»Ÿç®¡ç†å‘˜é€šè¿‡ä»£ç ç»´æŠ¤
- éœ€è¦æ·»åŠ /ä¿®æ”¹èœå•æ—¶ï¼Œéœ€è¦æ›´æ–°ä»£ç å¹¶é‡æ–°éƒ¨ç½²

### 2. æƒé™ vs èœå•

- **æƒé™**: ä¼ä¸šä¸“å±ï¼Œæ§åˆ¶åŠŸèƒ½è®¿é—®
- **èœå•**: å…¨å±€å…±äº«ï¼Œæ§åˆ¶ç•Œé¢å¯¼èˆª
- **å…³ç³»**: èœå•é€šè¿‡ `Permissions` å­—æ®µå…³è”æƒé™

### 3. ç°æœ‰æ•°æ®å¤„ç†

å¦‚æœç³»ç»Ÿå·²æœ‰è¿è¡Œæ•°æ®ï¼š

**é€‰é¡¹1: æ¸…ç©ºé‡å»ºï¼ˆæ¨èï¼‰**
```bash
# åˆ é™¤æ‰€æœ‰èœå•
db.menus.deleteMany({})

# é‡å¯åº”ç”¨ï¼Œè‡ªåŠ¨åˆ›å»ºå…¨å±€èœå•
```

**é€‰é¡¹2: æ‰‹åŠ¨è¿ç§»ï¼ˆä¸æ¨èï¼‰**
```javascript
// ç§»é™¤ companyId å­—æ®µ
db.menus.updateMany({}, { $unset: { companyId: "" } })

// æ¸…ç†é‡å¤èœå•ï¼ˆä¿ç•™ä¸€ä»½ï¼‰
// æ‰‹åŠ¨å¤„ç†...
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [DatabaseInitializerService](mdc:Platform.ApiService/Services/DatabaseInitializerService.cs)
- [Menu æ¨¡å‹](mdc:Platform.ApiService/Models/MenuModels.cs)
- [å‰ç«¯è·¯ç”±é…ç½®](mdc:Platform.Admin/config/routes.ts)
- [æƒé™ç³»ç»Ÿæ–‡æ¡£](../permissions/CRUD-PERMISSION-SYSTEM.md)

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

### èœå•ç®¡ç†çš„æ–°åŸåˆ™

1. **å…¨å±€å”¯ä¸€**: èœå•åœ¨æ•´ä¸ªç³»ç»Ÿä¸­å…¨å±€å”¯ä¸€
2. **ç³»ç»Ÿç®¡ç†**: ç”±ç³»ç»Ÿä»£ç ç»´æŠ¤ï¼Œä¸æä¾›ç®¡ç†ç•Œé¢
3. **æƒé™æ§åˆ¶**: é€šè¿‡æƒé™æ§åˆ¶èœå•æ˜¾ç¤º
4. **ç»Ÿä¸€ä½“éªŒ**: æ‰€æœ‰ä¼ä¸šçœ‹åˆ°ç›¸åŒçš„ç³»ç»Ÿèœå•
5. **ç‰ˆæœ¬ç®¡ç†**: èœå•å˜æ›´é€šè¿‡ä»£ç ç‰ˆæœ¬æ§åˆ¶

### å¤šç§Ÿæˆ·ä¾‹å¤–è§„åˆ™

è™½ç„¶å¼ºè°ƒ"æ‰€æœ‰æ•°æ®å¿…é¡»æœ‰ CompanyId"ï¼Œä½†èœå•æ˜¯**åˆç†çš„ä¾‹å¤–**ï¼š

âœ… **ä¾‹å¤–çš„èµ„æº**ï¼ˆå…¨å±€ï¼‰:
- Menuï¼ˆèœå•ï¼‰- ç³»ç»Ÿå¯¼èˆªç»“æ„

âœ… **ä»éœ€ CompanyId çš„èµ„æº**ï¼ˆä¼ä¸šä¸“å±ï¼‰:
- Permissionï¼ˆæƒé™ï¼‰- ä¼ä¸šçš„åŠŸèƒ½è®¿é—®æ§åˆ¶
- Roleï¼ˆè§’è‰²ï¼‰- ä¼ä¸šçš„ç”¨æˆ·è§’è‰²
- Userï¼ˆç”¨æˆ·ï¼‰- ä¼ä¸šçš„ç”¨æˆ·æ•°æ®
- Noticeï¼ˆé€šçŸ¥ï¼‰- ä¼ä¸šçš„é€šçŸ¥æ¶ˆæ¯
- ActivityLogï¼ˆæ—¥å¿—ï¼‰- ä¼ä¸šçš„æ´»åŠ¨æ—¥å¿—

## ğŸ‰ ä¼˜åŠ¿æ€»ç»“

### ç”¨æˆ·ä½“éªŒ

- âœ… ç»Ÿä¸€çš„ç•Œé¢å¯¼èˆª
- âœ… ç®€åŒ–çš„æƒé™é…ç½®
- âœ… æ›´å¿«çš„åˆå§‹åŒ–ï¼ˆæ— éœ€ä¸ºæ¯ä¸ªä¼ä¸šåˆ›å»ºèœå•ï¼‰

### ç³»ç»Ÿç»´æŠ¤

- âœ… èœå•åœ¨ä»£ç ä¸­ç»´æŠ¤ï¼Œç‰ˆæœ¬å¯æ§
- âœ… å‡çº§æ—¶è‡ªåŠ¨æ›´æ–°èœå•
- âœ… å‡å°‘æ•°æ®åº“å­˜å‚¨ï¼ˆä¸€ä»½èœå• vs Nä»½ï¼‰

### æ€§èƒ½ä¼˜åŒ–

- âœ… æ³¨å†Œæ›´å¿«ï¼ˆæ— éœ€åˆ›å»ºèœå•ï¼‰
- âœ… æŸ¥è¯¢æ›´å¿«ï¼ˆæ— éœ€è¿‡æ»¤ CompanyIdï¼‰
- âœ… ç´¢å¼•æ›´ç®€å•ï¼ˆæ— å¤åˆç´¢å¼•ï¼‰

---

**è®¾è®¡è€…**: äº§å“å›¢é˜Ÿ  
**å®æ–½è€…**: AI Assistant  
**çŠ¶æ€**: âœ… å·²å®æ–½å¹¶éªŒè¯

