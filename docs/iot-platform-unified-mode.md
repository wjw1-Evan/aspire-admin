# 物联网平台统一模式设计

## 概述

系统已合并简化模式和传统模式，形成统一的采集模式。两种模式可以共存，系统会自动选择最优策略。

## 统一模式工作流程

```
数据采集任务启动
    ↓
┌─────────────────────────────────────┐
│ 第一步：HTTP网关简化模式            │
│ - 查找所有启用的HTTP网关            │
│ - 自动创建/获取设备                 │
│ - 自动发现数据点                    │
│ - 直接从网关地址采集数据            │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 第二步：传统模式（设备级采集）      │
│ - 查找所有启用的设备                │
│ - HTTP网关设备：跳过（已处理）      │
│ - 非HTTP网关设备：处理              │
│ - 手动创建的设备：处理              │
└─────────────────────────────────────┘
    ↓
合并结果，返回统计信息
```

## 处理策略

### HTTP网关处理

**简化模式（自动）**：
- 自动创建/获取设备（优先使用已有设备）
- 自动发现数据点（从API响应）
- 直接从网关地址采集
- 自动保存数据记录

**特点**：
- ✅ 零配置快速接入
- ✅ 自动发现数据点
- ✅ 无需手动创建设备

### 非HTTP网关处理

**传统模式（手动配置）**：
- 需要手动创建设备
- 需要手动创建数据点
- 使用设备/数据点配置采集

**特点**：
- ✅ 完整控制
- ✅ 精细配置
- ✅ 支持复杂协议

### 手动创建的设备

**传统模式（优先）**：
- 即使网关是HTTP，手动创建的设备也使用传统模式
- 使用手动创建的数据点配置
- 支持精细控制

**特点**：
- ✅ 覆盖自动创建
- ✅ 支持自定义配置
- ✅ 灵活管理

## 代码实现

### 采集流程 (`IoTDataCollector.RunOnceAsync`)

```csharp
// 第一步：处理HTTP网关（简化模式）
var simpleResult = await RunSimpleCollectionAsync(token);
// 合并结果...

// 第二步：处理所有设备（传统模式）
foreach (var device in devices)
{
    if (isHttpGateway)
    {
        // 跳过（已由简化模式处理）
        continue;
    }
    // 使用传统模式处理
    await ProcessDeviceAsync(device, token);
}
```

### 设备获取逻辑 (`SimpleHttpDataCollector.GetOrCreateDefaultDeviceAsync`)

```csharp
// 1. 优先使用已启用的设备
// 2. 如果没有，启用已存在的设备
// 3. 最后才创建默认设备
```

### 数据点发现逻辑 (`SimpleHttpDataCollector.EnsureDataPointsExistAsync`)

```csharp
// 1. 查找已存在的数据点
// 2. 为HTTP响应中的新字段自动创建数据点
// 3. 返回所有启用的数据点（包括手动创建和自动创建）
```

## 使用场景

### 场景1：HTTP API快速接入（推荐）

```
1. 网关管理：创建HTTP网关，配置地址
2. 系统自动：创建设备、发现数据点、采集数据
3. 可选优化：编辑数据点配置（单位、告警规则）
```

### 场景2：MQTT/其他协议

```
1. 网关管理：创建MQTT网关，配置连接信息
2. 设备管理：手动创建设备
3. 数据点管理：手动创建数据点
4. 系统自动：采集数据
```

### 场景3：混合模式

```
1. HTTP网关：自动处理（简化模式）
2. 手动设备：精细控制（传统模式）
3. 两种模式共存，互不干扰
```

## 优势

1. **灵活性**：支持快速接入和精细控制
2. **自动化**：HTTP网关零配置
3. **兼容性**：两种模式共存
4. **智能选择**：系统自动选择最优策略
5. **无重复**：避免重复采集

## 注意事项

1. **HTTP网关**：优先使用简化模式，自动处理
2. **手动设备**：即使网关是HTTP，也使用传统模式
3. **数据点**：自动发现的数据点可以手动编辑
4. **设备**：自动创建的设备可以手动管理

## 总结

统一模式实现了：
- ✅ HTTP网关：简化模式（自动）
- ✅ 非HTTP网关：传统模式（手动）
- ✅ 手动设备：传统模式（优先）
- ✅ 两种模式：共存且互不干扰

系统会根据网关类型和设备创建方式，自动选择最优的采集策略。
