# 物联网平台工作流 - 快速指南

## 📋 工作流概览

```
┌─────────────────┐
│   网关管理      │ ← 配置数据采集入口（HTTP地址、协议等）
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│   设备管理      │ ← 配置物理/逻辑设备（关联网关）
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│  数据点管理     │ ← 配置数据采集规则（类型、单位、告警等）
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│   数据采集      │ ← 自动定时采集（基于配置）
└────────┬────────┘
         │
         ↓
┌─────────────────┐      ┌─────────────────┐
│   数据中心      │      │   事件告警      │
│  (历史数据)     │      │  (事件记录)     │
└─────────────────┘      └─────────────────┘
```

## 🎯 各模块职责

### 1️⃣ 网关管理
**作用**：定义数据从哪里来

**配置内容**：
- 协议类型：HTTP、MQTT等
- 连接地址：`https://api.example.com/data`
- 请求方式：GET/POST/PUT等
- 认证信息：用户名、密码等
- 超时设置：请求超时时间

**自动化**：
- ✅ 每分钟自动Ping检测在线状态
- ✅ HTTP协议：发送HTTP请求检测
- ✅ 其他协议：TCP连接检测

---

### 2️⃣ 设备管理
**作用**：定义采集哪个设备的数据

**配置内容**：
- 设备名称、类型（传感器/执行器等）
- 关联网关（选择所属网关）
- 设备位置、标签等

**自动化**：
- ✅ HTTP网关简化模式：自动创建默认设备
- ✅ 自动更新设备最后上报时间
- ✅ 自动判断设备在线状态

---

### 3️⃣ 数据点管理
**作用**：定义采集什么数据、如何采集

**配置内容**：
- 数据点名称、类型（数值/字符串/JSON等）
- 单位、精度、采样间隔
- 告警规则（阈值、级别）

**显示内容**：
- ✅ 配置信息（名称、类型、单位等）
- ✅ 最后采集值（最新数据）
- ✅ 最后采集时间（相对时间显示）

**自动化**：
- ✅ HTTP网关简化模式：自动发现数据点
- ✅ 自动更新最后值和更新时间
- ✅ 自动评估告警规则

---

### 4️⃣ 事件告警
**作用**：记录和展示重要事件

**记录内容**：
- 设备连接/断开事件
- 数据告警事件（基于告警规则）
- 设备故障事件

**自动化**：
- ✅ 设备状态变化自动创建事件
- ✅ 数据告警自动创建告警事件
- ✅ 网关离线自动创建事件

---

### 5️⃣ 数据中心
**作用**：查看和分析历史数据

**功能**：
- 查询历史数据记录
- 按设备、数据点、时间范围过滤
- 查看数据值、上报时间、告警状态

**数据来源**：
- ✅ 自动采集：定时任务从网关采集
- ✅ 手动上报：通过API手动上报

---

## 🚀 快速开始流程

### 方式一：HTTP网关快速接入（推荐）

```
步骤1: 网关管理
  └─ 创建网关
     └─ 协议类型：HTTP
     └─ 地址：https://api.example.com/data
     └─ 请求方式：GET
     └─ 启用网关

步骤2: 等待自动采集（无需操作）
  └─ 系统自动创建默认设备
  └─ 系统自动发现数据点
  └─ 系统自动采集数据

步骤3: 数据点管理（可选优化）
  └─ 查看自动创建的数据点
  └─ 编辑配置（单位、告警规则等）

步骤4: 数据中心
  └─ 查看采集的历史数据
```

### 方式二：传统模式（完整配置）

```
步骤1: 网关管理
  └─ 创建网关 → 配置连接信息

步骤2: 设备管理
  └─ 创建设备 → 关联网关

步骤3: 数据点管理
  └─ 创建数据点 → 配置采集规则

步骤4: 等待自动采集
  └─ 系统定时采集数据

步骤5: 数据中心
  └─ 查看历史数据
```

---

## 📊 数据流向

### 采集流程

```
网关配置 (HTTP地址)
    ↓
定时任务触发
    ↓
HTTP请求 → API响应
    ↓
解析JSON数据
    ↓
映射到数据点
    ↓
去重检查
    ↓
保存数据记录
    ↓
更新统计信息
    ├─ 数据点.LastValue
    ├─ 数据点.LastUpdatedAt
    └─ 设备.LastReportedAt
    ↓
告警评估
    ↓
创建告警事件（如需要）
```

### 查询流程

```
用户查询
    ↓
前端页面
    ↓
API请求
    ↓
后端查询
    ├─ 多租户过滤
    └─ 软删除过滤
    ↓
返回数据
    ↓
前端展示
```

---

## 🔄 状态管理

### 网关状态
- **检测方式**：Ping网关地址
- **检测频率**：每1分钟
- **HTTP协议**：发送HTTP请求检测
- **其他协议**：TCP连接检测

### 设备状态
- **检测方式**：基于最后上报时间
- **判断规则**：如果最后上报时间超过阈值，标记为离线
- **自动更新**：数据采集时自动更新

---

## 📝 关键概念

### 配置 vs 数据

| 类型 | 模块 | 数据模型 | 操作 |
|------|------|---------|------|
| **配置** | 网关管理 | IoTGateway | 用户手动配置 |
| **配置** | 设备管理 | IoTDevice | 用户手动配置 |
| **配置** | 数据点管理 | IoTDataPoint | 用户手动配置 |
| **数据** | 数据中心 | IoTDataRecord | 系统自动生成 |
| **数据** | 事件告警 | IoTDeviceEvent | 系统自动生成 |

### 统一模式（已合并）

**系统现在同时支持两种方式，自动选择最优策略：**

| 网关类型 | 处理方式 | 说明 |
|---------|---------|------|
| **HTTP网关** | 简化模式（自动） | 自动创建设备和数据点，直接从网关地址采集 |
| **非HTTP网关** | 传统模式 | 使用手动创建的设备和数据点配置 |
| **手动创建的设备** | 传统模式 | 即使网关是HTTP，手动创建的设备也使用传统模式 |

**工作流程**：
1. **第一步**：处理所有HTTP网关（简化模式）
   - 自动创建/获取设备
   - 自动发现数据点
   - 直接从网关地址采集数据

2. **第二步**：处理所有设备（传统模式）
   - HTTP网关下的设备：跳过（已由简化模式处理）
   - 非HTTP网关下的设备：使用传统模式处理
   - 手动创建的设备：使用传统模式处理

**优势**：
- ✅ HTTP网关：零配置快速接入
- ✅ 非HTTP网关：完整控制
- ✅ 手动创建：精细管理
- ✅ 两种模式共存，互不干扰

---

## ✅ 最佳实践

1. **HTTP网关快速接入**
   - 优先使用简化模式
   - 配置网关后等待自动采集
   - 再优化数据点配置

2. **数据点配置**
   - 及时配置单位，便于理解数据
   - 配置告警规则，及时发现问题
   - 定期检查数据点状态

3. **数据中心查询**
   - 使用时间范围过滤，提高查询效率
   - 关注告警数据，及时处理问题

4. **事件告警**
   - 定期查看未处理告警
   - 及时处理重要告警

---

## 🎨 页面功能总结

| 页面 | 主要功能 | 数据类型 | 操作 |
|------|---------|---------|------|
| **网关管理** | 配置数据采集入口 | 配置 | 创建、编辑、删除、状态监控 |
| **设备管理** | 配置设备信息 | 配置 | 创建、编辑、删除、状态查看 |
| **数据点管理** | 配置采集规则 | 配置 + 状态 | 创建、编辑、删除、查看最后值 |
| **数据中心** | 查看历史数据 | 数据 | 查询、过滤、导出 |
| **事件告警** | 查看事件和告警 | 数据 | 查询、过滤、处理 |

---

## 🔗 关联关系

```
网关 (1) ──→ (N) 设备
设备 (1) ──→ (N) 数据点
数据点 (1) ──→ (N) 数据记录
数据记录 ──→ (0..1) 告警事件
设备 ──→ (N) 事件
```

---

## 📌 总结

**工作流核心**：
1. **配置层**（网关→设备→数据点）：定义"采集什么、从哪里采集"
2. **数据层**（数据记录→事件）：记录"采集到了什么"
3. **查询层**（数据中心、事件告警）：查看"采集结果"

**设计原则**：
- ✅ 配置与数据分离
- ✅ 简化优先（HTTP网关零配置）
- ✅ 自动化优先（自动采集、自动发现）
- ✅ 多租户隔离
- ✅ 软删除保护
