# 物联网平台工作流设计

## 概述

物联网平台采用分层架构，从网关到数据采集，形成完整的数据流转链路。

## 架构层次

```
网关管理 (IoTGateway)
    ↓
设备管理 (IoTDevice)
    ↓
数据点管理 (IoTDataPoint)
    ↓
数据采集 (自动/手动)
    ↓
数据记录 (IoTDataRecord)
    ↓
事件告警 (IoTDeviceEvent)
```

## 模块职责

### 1. 网关管理 (Gateway Management)

**职责**：管理数据采集的入口点

**核心功能**：
- 配置网关连接信息（协议类型、地址、认证信息）
- 配置HTTP采集参数（URL、请求方法、超时等）
- 监控网关在线状态（基于Ping检测）
- 管理网关下的设备统计

**数据模型**：
- `IoTGateway`: 网关配置信息
- 协议类型：HTTP、MQTT、Modbus等
- 状态：在线/离线（基于Ping检测）

**用户操作流程**：
1. 创建网关 → 配置协议类型（如HTTP）
2. 配置连接信息（地址、认证等）
3. 配置HTTP采集参数（URL、方法、超时）
4. 启用网关 → 系统自动检测在线状态

**自动化流程**：
- 每分钟自动Ping网关地址，更新在线状态
- HTTP协议：发送HTTP请求检测连通性
- 其他协议：TCP连接检测

---

### 2. 设备管理 (Device Management)

**职责**：管理物理设备或逻辑设备

**核心功能**：
- 创建设备并关联到网关
- 配置设备基本信息（名称、类型、位置等）
- 管理设备状态（在线/离线/故障/维护）
- 查看设备下的数据点列表

**数据模型**：
- `IoTDevice`: 设备信息
- 关联关系：`Device.GatewayId` → `Gateway.GatewayId`
- 数据点引用：`Device.DataPoints` → `DataPoint.DataPointId[]`

**用户操作流程**：
1. 选择网关 → 创建设备
2. 配置设备信息（名称、类型、位置等）
3. 启用设备 → 系统开始采集该设备的数据

**自动化流程**：
- 数据采集时自动更新设备最后上报时间
- 根据最后上报时间判断设备在线状态
- 删除数据点时自动从设备的数据点列表中移除

**简化模式**（HTTP网关）：
- 如果网关下没有设备，系统会自动创建默认设备
- 自动从HTTP响应中发现数据点并创建

---

### 3. 数据点管理 (Data Point Management)

**职责**：定义数据采集点的配置规则

**核心功能**：
- 配置数据点的元信息（名称、类型、单位、精度）
- 配置采样间隔
- 配置告警规则（阈值、级别）
- 查看最后采集的数据值和时间

**数据模型**：
- `IoTDataPoint`: 数据点配置
- 关联关系：`DataPoint.DeviceId` → `Device.DeviceId`
- 统计信息：`LastValue`、`LastUpdatedAt`

**用户操作流程**：
1. 选择设备 → 创建数据点
2. 配置数据点信息（名称、类型、单位等）
3. 配置告警规则（可选）
4. 启用数据点 → 系统开始采集该数据点

**自动化流程**：
- HTTP网关简化模式：自动从API响应中发现数据点
- 数据采集时自动更新数据点的最后值和更新时间
- 根据告警规则自动评估告警状态

**显示内容**：
- 配置信息：名称、类型、单位、采样间隔、告警配置
- 采集状态：最后采集值、最后采集时间（相对时间）

---

### 4. 事件告警 (Event & Alarm Management)

**职责**：记录和展示设备事件与告警信息

**核心功能**：
- 记录设备连接/断开事件
- 记录数据告警事件（基于数据点告警规则）
- 记录设备故障事件
- 查询和过滤事件

**数据模型**：
- `IoTDeviceEvent`: 设备事件记录
- 事件类型：连接、断开、告警、故障等
- 告警级别：Info、Warning、Error、Critical

**自动化流程**：
- 设备状态变化时自动创建事件
- 数据采集时根据告警规则自动创建告警事件
- 网关离线检测时自动创建事件

**用户操作流程**：
1. 查看事件列表（按时间、设备、类型过滤）
2. 查看告警详情
3. 处理告警（标记已处理）

---

### 5. 数据中心 (Data Center)

**职责**：展示和管理所有历史数据记录

**核心功能**：
- 查询历史数据记录
- 按设备、数据点、时间范围过滤
- 查看数据值、上报时间、告警状态
- 导出数据（可选）

**数据模型**：
- `IoTDataRecord`: 数据记录
- 关联关系：`Record.DeviceId` → `Device.DeviceId`，`Record.DataPointId` → `DataPoint.DataPointId`
- 数据值：字符串格式（支持数值、布尔、JSON等）

**数据来源**：
1. **自动采集**：定时任务从网关HTTP地址采集数据
2. **手动上报**：通过API手动上报数据

**用户操作流程**：
1. 选择查询条件（设备、数据点、时间范围）
2. 查看数据列表
3. 查看数据详情（JSON数据格式化显示）

**显示内容**：
- 设备ID、数据点ID
- 数据类型、数据值（JSON格式化）
- 上报时间（友好格式）
- 告警状态

---

## 完整工作流

### 场景1：HTTP网关快速接入

```
1. 网关管理
   └─ 创建HTTP网关
      └─ 配置：协议=HTTP，地址=https://api.example.com/data
      └─ 配置：请求方法=GET，超时=30秒
      └─ 启用网关

2. 自动流程（简化模式）
   └─ 系统检测到HTTP网关且无设备
      └─ 自动创建默认设备
      └─ 定时采集HTTP数据
      └─ 自动发现数据点（从API响应）
      └─ 自动创建数据点配置
      └─ 保存数据记录

3. 数据点管理（可选优化）
   └─ 查看自动创建的数据点
   └─ 编辑数据点配置（单位、告警规则等）

4. 数据中心
   └─ 查看采集的历史数据
```

### 场景2：传统模式（手动配置）

```
1. 网关管理
   └─ 创建网关（HTTP/MQTT/其他）
   └─ 配置连接信息

2. 设备管理
   └─ 创建设备
   └─ 关联到网关

3. 数据点管理
   └─ 创建数据点
   └─ 配置数据点信息
   └─ 配置告警规则

4. 数据采集
   └─ 定时任务采集数据
   └─ 保存数据记录
   └─ 评估告警规则

5. 事件告警
   └─ 自动创建告警事件

6. 数据中心
   └─ 查看历史数据
```

---

## 数据流向

### 采集流程

```
网关 (HTTP地址)
    ↓ HTTP请求
API响应 (JSON)
    ↓ 解析
数据点映射
    ↓ 去重检查
数据记录 (IoTDataRecord)
    ↓ 更新统计
数据点.LastValue
数据点.LastUpdatedAt
设备.LastReportedAt
    ↓ 告警评估
告警事件 (IoTDeviceEvent)
```

### 查询流程

```
用户查询
    ↓
数据中心页面
    ↓ API请求
后端查询服务
    ↓ 多租户过滤
    ↓ 软删除过滤
数据记录列表
    ↓ 返回
前端展示
```

---

## 关键设计原则

### 1. 简化优先
- HTTP网关支持零配置快速接入
- 自动发现数据点，减少手动配置
- 自动创建默认设备

### 2. 配置与数据分离
- **配置层**：网关、设备、数据点（用户手动配置）
- **数据层**：数据记录、事件（系统自动生成）

### 3. 多租户隔离
- 所有数据自动应用企业ID过滤
- 用户只能看到自己企业的数据

### 4. 软删除
- 删除操作使用软删除，数据可恢复
- 查询自动过滤已删除数据

### 5. 状态管理
- 网关状态：基于Ping检测
- 设备状态：基于最后上报时间
- 自动更新，无需手动维护

---

## 页面功能映射

| 页面 | 主要功能 | 数据模型 | 操作类型 |
|------|---------|---------|---------|
| 网关管理 | 网关配置、状态监控 | IoTGateway | 配置管理 |
| 设备管理 | 设备配置、状态查看 | IoTDevice | 配置管理 |
| 数据点管理 | 数据点配置、告警规则、最后值查看 | IoTDataPoint | 配置管理 + 状态查看 |
| 事件告警 | 事件查询、告警处理 | IoTDeviceEvent | 数据查询 |
| 数据中心 | 历史数据查询、数据分析 | IoTDataRecord | 数据查询 |

---

## 改进建议

### 当前实现
- ✅ 网关管理：支持HTTP协议，Ping状态检测
- ✅ 设备管理：设备配置，关联网关
- ✅ 数据点管理：配置管理，显示最后值
- ✅ 数据中心：历史数据查询
- ✅ 事件告警：事件记录和查询

### 可优化点
1. **数据点管理**：可以考虑添加批量导入/导出功能
2. **数据中心**：可以添加数据可视化（图表）
3. **事件告警**：可以添加告警规则模板
4. **网关管理**：可以添加网关分组/标签管理
5. **设备管理**：可以添加设备分组/批量操作

---

## 总结

当前工作流设计清晰，职责分明：

- **配置层**（网关→设备→数据点）：用户手动配置，定义采集规则
- **数据层**（数据记录→事件）：系统自动生成，记录采集结果
- **查询层**（数据中心、事件告警）：用户查询和分析数据

整个流程支持简化和传统两种模式，满足不同场景需求。
