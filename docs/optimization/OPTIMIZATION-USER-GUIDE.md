# 业务逻辑优化 - 用户使用指南

## 🎯 快速开始

本指南帮助你快速了解系统优化后的新功能和使用方法。

---

## 📦 部署和启动

### 1. 启动系统

```bash
# 完整启动（推荐）
dotnet run --project Platform.AppHost
```

**首次启动会自动执行**：
- ✅ 数据库迁移（Role → RoleIds）
- ✅ 数据库索引创建
- ✅ 权限系统初始化
- ✅ 默认角色创建

**控制台输出示例**：
```
开始迁移 Role 字段到 RoleIds...
创建管理员角色: 67...
创建普通用户角色: 67...
迁移用户: admin -> RoleIds: [67...]
迁移完成！共迁移 1 个用户

开始创建数据库索引...
创建 users 集合索引...
  - 创建唯一索引: username
  - 创建唯一索引: email (sparse)
  ...
数据库索引创建完成！
```

### 2. 访问地址

- **管理后台**: http://localhost:15001
- **Aspire Dashboard**: http://localhost:15003
- **API 文档**: http://localhost:15000/scalar/v1

### 3. 默认账户

- 用户名: `admin`
- 密码: `admin123`

---

## 🆕 新功能使用

### 1. 角色管理增强

#### 查看角色统计信息

在角色管理页面，现在可以看到每个角色的：
- 👥 **用户数量** - 有多少用户使用此角色
- 📁 **菜单数量** - 分配了多少个菜单
- 🔑 **权限数量** - 分配了多少个权限

![角色统计](./images/role-stats.png)

#### 删除角色（智能级联）

删除角色时：
1. 系统会显示影响的用户数量
2. 要求输入删除原因（选填）
3. 自动从所有用户的角色列表中移除此角色
4. 系统管理员角色受保护，无法删除

**使用步骤**：
1. 在角色列表中点击"更多" → "删除"
2. 确认对话框会显示：
   ```
   确定要删除角色"编辑者"吗？
   
   删除角色将自动从所有用户的角色列表中移除此角色
   
   请输入删除原因：
   [文本框]
   ```
3. 输入原因后点击"确定删除"

### 2. 用户管理增强

#### 按多个角色搜索

现在可以选择多个角色进行搜索：

**使用方法**：
1. 点击搜索区的"角色"下拉框
2. 选择一个或多个角色
3. 点击"查询"

**示例**：
- 选择"管理员"和"编辑者" → 显示所有拥有这两个角色之一的用户

#### 按日期范围搜索

新增创建时间范围搜索：

**使用方法**：
1. 点击搜索区的"创建时间"日期选择器
2. 选择起始和结束日期
3. 点击"查询"

**示例**：
- 选择"2025-10-01" 到 "2025-10-12" → 显示这个时间段创建的用户

#### 删除用户（带原因）

删除单个用户或批量删除时：

**使用步骤**：
1. 点击"删除"按钮
2. 在弹出的对话框中输入删除原因（选填）
3. 点击"确定删除"

**对话框内容**：
```
确定要删除这个用户吗？

此操作不可恢复，请输入删除原因：
[文本框 - 最多200字符]

[取消] [确定删除]
```

**批量删除**：
1. 选择多个用户（勾选复选框）
2. 点击"批量删除"按钮
3. 输入删除原因
4. 系统会显示 "确定要批量删除 3 个用户吗？"

### 3. 菜单管理增强

#### 删除菜单（级联清理）

删除菜单时会自动清理相关引用：

**使用步骤**：
1. 点击菜单的"删除"按钮
2. 系统会显示：
   ```
   确定要删除菜单"用户管理"吗？
   
   ⚠️ 删除菜单将自动从所有角色的菜单列表中移除此菜单
   ⚠️ 如果有子菜单，必须先删除所有子菜单
   
   请输入删除原因：
   [文本框]
   ```
3. 输入原因后确认删除

**保护机制**：
- 有子菜单的菜单无法删除
- 自动从角色中移除菜单引用
- 记录删除原因和操作人

### 4. 用户管理新搜索组合

**场景 1**: 查找本月新增的管理员
```
搜索：[空]
角色：✓ 管理员
状态：✓ 启用
创建时间：2025-10-01 ~ 2025-10-31
```

**场景 2**: 查找禁用的编辑者
```
搜索：[空]
角色：✓ 编辑者
状态：✓ 禁用
创建时间：[空]
```

**场景 3**: 按邮箱搜索多个角色的用户
```
搜索：@company.com
角色：✓ 管理员 ✓ 编辑者
状态：[空]
创建时间：[空]
```

---

## 🛡️ 安全保护机制

### 1. 不能删除自己

尝试删除自己的账户时：
```
错误提示：不能删除自己的账户
```

### 2. 不能修改自己的角色

尝试编辑自己的角色时：
```
错误提示：不能修改自己的角色
```

### 3. 不能删除系统管理员角色

尝试删除名为 "admin" 或 "系统管理员" 的角色时：
```
错误提示：不能删除系统管理员角色
```

### 4. 不能移除最后一个管理员

尝试移除最后一个拥有管理员角色的用户的角色时：
```
错误提示：不能移除最后一个管理员的角色，必须至少保留一个管理员
```

### 5. 有子菜单的菜单不能删除

尝试删除有子菜单的菜单时：
```
错误提示：不能删除有子菜单的菜单，请先删除子菜单
```

---

## 🔍 常见问题

### Q1: 为什么我的用户没有角色了？

**A**: 首次启动时，迁移脚本会自动将旧的 `role` 字段转换为 `roleIds`。如果看到用户没有角色：
1. 检查控制台日志，确认迁移是否成功
2. 手动为用户分配角色
3. 重新启动应用

### Q2: 删除角色后，用户还能访问系统吗？

**A**: 可以。删除角色只是从用户的角色列表中移除该角色，如果用户还有其他角色，仍然可以访问系统。如果用户没有任何角色，可以访问系统但权限受限。

### Q3: 删除菜单后会发生什么？

**A**: 系统会：
1. 检查是否有子菜单（有则阻止删除）
2. 自动从所有角色的菜单列表中移除此菜单
3. 用户重新登录后菜单会更新

### Q4: 如何查看删除的原因？

**A**: 删除原因会记录在数据库的 `deletedReason` 字段中。可以通过：
1. 直接查询数据库
2. 查看活动日志（如果记录了）
3. 后续可以添加"已删除项目"页面查看

### Q5: 批量操作为什么没有进度显示？

**A**: 当前版本的批量操作是一次性提交到后端执行的，后端会依次处理。进度显示功能已规划在后续优化中。

### Q6: 为什么角色选择器变成多选了？

**A**: 因为系统支持一个用户拥有多个角色，所以搜索时也支持按多个角色筛选。这样可以更灵活地查找用户。

### Q7: 如何清理数据库中的旧 Role 字段？

**A**: 迁移后，旧的 Role 字段数据仍保留在数据库中（为了安全）。确认迁移成功后，可以手动清理：

```javascript
// MongoDB Shell
use aspire-admin
db.users.updateMany({}, { $unset: { role: "" } })
```

### Q8: 索引创建失败怎么办？

**A**: 索引创建脚本具有幂等性。如果失败：
1. 检查 MongoDB 是否正常运行
2. 检查数据库连接配置
3. 重新启动应用（会自动重试创建索引）
4. 如果索引已存在，脚本会自动跳过

---

## 🎓 最佳实践

### 1. 角色分配

**推荐做法**：
- 为新用户至少分配一个角色
- 不要创建过多的角色（建议 3-10 个）
- 角色命名要清晰易懂
- 定期审查角色权限

### 2. 菜单配置

**推荐做法**：
- 菜单层级不要太深（建议 2-3 层）
- 使用有意义的排序值
- 删除前确认没有子菜单
- 定期整理不使用的菜单

### 3. 权限管理

**推荐做法**：
- 优先通过角色分配权限
- 自定义权限仅用于特殊情况
- 定期审查权限分配
- 遵循最小权限原则

### 4. 删除操作

**推荐做法**：
- 删除前确认影响范围
- 重要操作必须填写删除原因
- 软删除的数据定期归档
- 保留删除日志用于审计

---

## 📞 技术支持

如果在使用过程中遇到问题：

1. 查看 Aspire Dashboard 的日志
2. 查看浏览器控制台的错误信息
3. 检查 MongoDB 数据是否正确
4. 参考 [优化总结文档](./BUSINESS-LOGIC-OPTIMIZATION-SUMMARY.md)
5. 查看相关代码注释和文档

---

**享受优化后的系统！** 🚀

