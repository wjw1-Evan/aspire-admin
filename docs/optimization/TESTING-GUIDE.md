# 业务逻辑优化 - 测试指南

本文档提供详细的测试步骤，帮助验证优化后的功能是否正常工作。

---

## 🎯 测试环境准备

### 1. 启动系统

```bash
# 确保 Docker 正在运行
docker ps

# 启动完整系统
cd /Volumes/thinkplus/Projects/aspire-admin
dotnet run --project Platform.AppHost
```

### 2. 访问管理后台

打开浏览器访问：http://localhost:15001

使用默认账户登录：
- 用户名：`admin`
- 密码：`admin123`

### 3. 检查迁移日志

在控制台查看是否有以下输出：

```
开始迁移 Role 字段到 RoleIds...
创建管理员角色: 67...
创建普通用户角色: 67...
迁移用户: admin -> RoleIds: [67...]
迁移完成！

开始创建数据库索引...
创建 users 集合索引...
...
数据库索引创建完成！
```

---

## 📋 测试清单

### 阶段 1: 数据模型和迁移验证 ✅

#### Test 1.1: 验证 Role 字段迁移

**目的**: 确认所有用户的 Role 字段已正确迁移到 RoleIds

**步骤**：
1. 访问 MongoDB Express: http://localhost:8081
2. 选择数据库 `aspire-admin` → 集合 `users`
3. 查看 admin 用户的数据

**预期结果**：
```json
{
  "_id": ObjectId("67..."),
  "username": "admin",
  "roleIds": ["67abc..."],  // ✅ 包含角色ID
  "role": "admin",           // 旧字段仍存在（可选清理）
  "isActive": true,
  "isDeleted": false
}
```

**验证**：
- ✅ `roleIds` 字段存在且为数组
- ✅ `roleIds` 包含至少一个角色ID

#### Test 1.2: 验证默认角色创建

**步骤**：
1. 在 MongoDB Express 中查看 `roles` 集合
2. 确认存在以下角色：
   - `admin` (管理员)
   - `user` (普通用户)

**预期结果**：
```json
[
  {
    "_id": ObjectId("67..."),
    "name": "admin",
    "description": "系统管理员角色",
    "menuIds": [],
    "permissionIds": [],
    "isActive": true,
    "isDeleted": false
  },
  {
    "_id": ObjectId("67..."),
    "name": "user",
    "description": "普通用户角色",
    ...
  }
]
```

#### Test 1.3: 验证数据库索引

**步骤**：
1. 在 MongoDB Shell 中执行：
   ```javascript
   use aspire-admin
   db.users.getIndexes()
   db.roles.getIndexes()
   db.menus.getIndexes()
   db.permissions.getIndexes()
   db.user_activity_logs.getIndexes()
   ```

**预期结果**：
- ✅ users: 至少 5 个索引（包括 _id）
- ✅ roles: 至少 3 个索引
- ✅ menus: 至少 4 个索引
- ✅ permissions: 至少 3 个索引
- ✅ user_activity_logs: 至少 3 个索引

---

### 阶段 2: API 功能验证 ✅

#### Test 2.1: 用户列表搜索（按多角色）

**步骤**：
1. 进入"用户管理"页面
2. 在搜索区选择角色："管理员"
3. 点击"查询"
4. 再添加"用户"角色
5. 点击"查询"

**预期结果**：
- ✅ 第一次查询：只显示管理员角色的用户
- ✅ 第二次查询：显示拥有管理员或用户角色的所有用户

**API 请求检查**（浏览器 Network 标签）：
```json
POST /api/user/list
{
  "roleIds": ["67abc...", "67def..."]
}
```

#### Test 2.2: 用户列表搜索（按日期范围）

**步骤**：
1. 在搜索区选择"创建时间"
2. 选择范围：最近7天
3. 点击"查询"

**预期结果**：
- ✅ 只显示最近7天创建的用户

**API 请求检查**：
```json
POST /api/user/list
{
  "startDate": "2025-10-05",
  "endDate": "2025-10-12"
}
```

#### Test 2.3: 删除用户（带原因输入）

**步骤**：
1. 创建一个测试用户
2. 点击该用户的"删除"按钮
3. 在弹出的对话框中输入原因："测试删除功能"
4. 点击"确定删除"

**预期结果**：
- ✅ 弹窗显示删除确认
- ✅ 有文本框输入删除原因
- ✅ 删除成功后显示"删除成功"
- ✅ 列表自动刷新

**API 请求检查**：
```http
DELETE /api/user/67xxx?reason=测试删除功能
```

#### Test 2.4: 批量删除用户（带原因）

**步骤**：
1. 创建3个测试用户
2. 勾选这3个用户
3. 点击"批量删除"
4. 输入删除原因："批量清理测试账户"
5. 确认删除

**预期结果**：
- ✅ 显示 "确定要批量删除 3 个用户吗？"
- ✅ 删除成功后显示 "批量删除成功"
- ✅ 3个用户全部被删除
- ✅ 选择状态被清除

**API 请求检查**：
```json
POST /api/user/bulk-action
{
  "userIds": ["67...", "67...", "67..."],
  "action": "delete",
  "reason": "批量清理测试账户"
}
```

---

### 阶段 3: 级联删除验证 ✅

#### Test 3.1: 删除角色（级联清理用户引用）

**准备工作**：
1. 创建一个新角色："测试角色"
2. 创建2个用户，都分配"测试角色"
3. 记录这2个用户的ID

**测试步骤**：
1. 进入"角色管理"页面
2. 找到"测试角色"，点击"更多" → "删除"
3. 输入删除原因："测试级联删除"
4. 确认删除

**预期结果**：
- ✅ 角色被成功删除
- ✅ 查看这2个用户，`roleIds` 中不再包含"测试角色"的ID

**数据库验证**（MongoDB）：
```javascript
db.users.find({ _id: ObjectId("之前记录的用户ID") })
// roleIds 数组中不应包含已删除角色的ID
```

#### Test 3.2: 删除菜单（级联清理角色引用）

**准备工作**：
1. 创建一个新菜单："测试菜单"
2. 创建一个新角色："菜单测试角色"，分配"测试菜单"
3. 记录菜单ID和角色ID

**测试步骤**：
1. 进入"菜单管理"页面
2. 找到"测试菜单"，点击"删除"
3. 输入删除原因："测试级联删除"
4. 确认删除

**预期结果**：
- ✅ 菜单被成功删除
- ✅ 查看"菜单测试角色"，`menuIds` 中不再包含"测试菜单"的ID

**数据库验证**：
```javascript
db.roles.find({ _id: ObjectId("角色ID") })
// menuIds 数组中不应包含已删除菜单的ID
```

#### Test 3.3: 删除权限（级联清理角色和用户引用）

**准备工作**：
1. 创建一个自定义权限："test:custom"
2. 将此权限分配给一个角色
3. 将此权限分配给一个用户的自定义权限

**测试步骤**：
1. 进入"权限管理"页面
2. 找到"test:custom"权限，点击"删除"
3. 确认删除

**预期结果**：
- ✅ 权限被成功删除
- ✅ 角色的 `permissionIds` 中不再包含此权限ID
- ✅ 用户的 `customPermissionIds` 中不再包含此权限ID

**控制台日志检查**：
```
已从 1 个角色的权限列表中移除权限 test:custom (67...)
已从 1 个用户的自定义权限列表中移除权限 test:custom (67...)
已删除权限: test:custom (67...), 原因: 未提供
```

---

### 阶段 4: 安全规则验证 ✅

#### Test 4.1: 尝试删除自己的账户

**步骤**：
1. 使用 admin 账户登录
2. 进入"用户管理"
3. 找到 admin 用户，点击"删除"

**预期结果**：
- ❌ 删除失败
- ✅ 显示错误：`不能删除自己的账户`

#### Test 4.2: 尝试修改自己的角色

**步骤**：
1. 使用 admin 账户登录
2. 进入"用户管理"
3. 找到 admin 用户，点击"编辑"
4. 尝试修改 RoleIds
5. 点击"保存"

**预期结果**：
- ❌ 保存失败
- ✅ 显示错误：`不能修改自己的角色`

#### Test 4.3: 尝试删除系统管理员角色

**步骤**：
1. 进入"角色管理"页面
2. 找到名为"admin"的角色
3. 点击"删除"

**预期结果**：
- ❌ 删除失败
- ✅ 显示错误：`不能删除系统管理员角色`

#### Test 4.4: 尝试删除有子菜单的菜单

**步骤**：
1. 进入"菜单管理"页面
2. 找到一个有子菜单的父菜单（例如"系统管理"）
3. 点击"删除"
4. 确认删除

**预期结果**：
- ❌ 删除失败
- ✅ 显示错误：`不能删除有子菜单的菜单，请先删除子菜单`

#### Test 4.5: 权限验证

**步骤**：
1. 创建一个普通用户（不分配任何角色）
2. 使用该用户登录
3. 尝试访问"用户管理"页面

**预期结果**：
- ✅ 根据权限配置决定是否能访问
- ✅ 无权限时显示相应提示

---

### 阶段 5: 性能验证 ✅

#### Test 5.1: 活动日志查询性能

**准备工作**：
- 确保数据库中有至少 50 条活动日志

**测试步骤**：
1. 打开浏览器开发者工具 → Network 标签
2. 进入"用户活动日志"页面
3. 观察网络请求

**预期结果**：
- ✅ 只有 1 次 API 请求到 `/api/users/activity-logs`
- ✅ 没有额外的用户信息查询请求
- ✅ 页面加载速度快（< 1秒）

**Before (N+1 问题)**:
```
GET /api/users/activity-logs     → 获取日志
GET /api/user/67xxx              → 查询用户1
GET /api/user/67yyy              → 查询用户2
...
总计: 1 + N 次请求
```

**After (优化后)**:
```
GET /api/users/activity-logs     → 批量获取日志和用户
总计: 1 次请求
```

#### Test 5.2: 用户列表查询性能

**测试步骤**：
1. 打开浏览器开发者工具
2. 进入"用户管理"页面
3. 进行各种搜索操作
4. 观察响应时间

**测试场景**：
- 搜索用户名
- 按角色过滤
- 按状态过滤
- 按日期范围过滤
- 组合搜索

**预期结果**：
- ✅ 所有查询响应时间 < 500ms
- ✅ 分页加载流畅

#### Test 5.3: 角色列表统计性能

**测试步骤**：
1. 进入"角色管理"页面
2. 观察加载时间

**预期结果**：
- ✅ 页面加载完成时间 < 1秒
- ✅ 统计信息正确显示

---

### 阶段 6: 用户体验验证 ✅

#### Test 6.1: 搜索功能增强

**测试 6.1.1: 多角色搜索**

**步骤**：
1. 创建3个角色：A、B、C
2. 创建3个用户：
   - 用户1：角色 A
   - 用户2：角色 B
   - 用户3：角色 A + C
3. 搜索角色 [A]
4. 搜索角色 [A, C]

**预期结果**：
- ✅ 搜索 [A]：显示用户1、用户3
- ✅ 搜索 [A, C]：显示用户1、用户3
- ✅ 搜索结果准确无误

**测试 6.1.2: 日期范围搜索**

**步骤**：
1. 确保有不同日期创建的用户
2. 选择日期范围：今天
3. 查询

**预期结果**：
- ✅ 只显示今天创建的用户

**测试 6.1.3: 组合搜索**

**步骤**：
1. 搜索：输入 "test"
2. 角色：选择 "管理员"
3. 状态：选择 "启用"
4. 日期：最近7天

**预期结果**：
- ✅ 只显示符合所有条件的用户

#### Test 6.2: 删除原因记录

**步骤**：
1. 删除一个用户，输入原因："测试删除原因记录"
2. 在 MongoDB 中查看该用户的数据

**预期结果**：
```json
{
  "_id": ObjectId("67..."),
  "username": "testuser",
  "isDeleted": true,
  "deletedReason": "测试删除原因记录",  // ✅ 原因已记录
  "deletedBy": "67...",                // ✅ 操作人已记录
  "deletedAt": "2025-10-12T10:00:00Z"  // ✅ 删除时间已记录
}
```

#### Test 6.3: 角色统计信息显示

**步骤**：
1. 进入"角色管理"页面
2. 观察角色列表

**预期结果**：
- ✅ 每个角色名称旁边显示用户数量 Badge
- ✅ "统计"列显示：用户 | 菜单 | 权限 数量
- ✅ 数字准确

**示例**：
```
角色名称              统计
管理员 [5]           用户: 5 | 菜单: 10 | 权限: 28
编辑者 [2]           用户: 2 | 菜单: 5 | 权限: 12
```

---

### 阶段 7: 数据一致性验证 ✅

#### Test 7.1: 角色删除后用户数据一致性

**步骤**：
1. 创建角色"临时角色"
2. 创建用户"临时用户"，分配"临时角色"
3. 删除"临时角色"
4. 查看"临时用户"的数据

**预期结果**：

数据库中：
```json
{
  "username": "临时用户",
  "roleIds": [],  // ✅ 空数组，角色已被移除
  "isActive": true
}
```

前端显示：
```
角色：[未分配]  // ✅ 显示"未分配"或空
```

#### Test 7.2: 菜单删除后角色数据一致性

**步骤**：
1. 创建菜单"临时菜单"
2. 创建角色"临时角色2"，分配"临时菜单"
3. 删除"临时菜单"
4. 查看"临时角色2"的菜单列表

**预期结果**：

API 响应（`GET /api/role/{id}/menus`）：
```json
{
  "success": true,
  "data": []  // ✅ 空数组，菜单已被移除
}
```

角色管理页面：
- ✅ 菜单计数减1
- ✅ 配置菜单权限时不再显示已删除的菜单

#### Test 7.3: 权限删除后数据一致性

**步骤**：
1. 创建权限"test:temp"
2. 分配给角色A和用户B的自定义权限
3. 删除权限"test:temp"
4. 查看角色A和用户B

**预期结果**：

角色A：
```json
{
  "permissionIds": []  // ✅ 不包含已删除的权限
}
```

用户B：
```json
{
  "customPermissionIds": []  // ✅ 不包含已删除的权限
}
```

---

### 阶段 8: 边界情况测试 ✅

#### Test 8.1: 删除最后一个管理员角色

**场景**: 系统必须至少保留一个管理员

**步骤**：
1. 确保只有一个用户拥有管理员角色
2. 创建一个新角色"备份管理员"
3. 尝试移除该用户的所有管理员角色

**预期结果**：
- ❌ 操作失败
- ✅ 显示错误：`不能移除最后一个管理员的角色，必须至少保留一个管理员`

#### Test 8.2: 空 RoleIds 的用户

**步骤**：
1. 创建一个用户，不分配任何角色
2. 登录该用户
3. 尝试访问各个页面

**预期结果**：
- ✅ 可以登录成功
- ✅ 根据权限配置决定可访问的页面
- ✅ 用户列表显示"未分配"

#### Test 8.3: 菜单层级删除

**步骤**：
1. 创建菜单层级：
   - 父菜单1
     - 子菜单1-1
     - 子菜单1-2
2. 尝试直接删除"父菜单1"
3. 删除"子菜单1-1"
4. 删除"子菜单1-2"
5. 删除"父菜单1"

**预期结果**：
- ❌ 步骤2失败：`不能删除有子菜单的菜单，请先删除子菜单`
- ✅ 步骤3-4成功
- ✅ 步骤5成功

---

## 🎨 前端功能测试

### Test F1: 角色选择器（多选）

**位置**: 用户管理 → 搜索区 → 角色

**步骤**：
1. 点击角色下拉框
2. 选择"管理员"
3. 再选择"用户"
4. 应该显示两个已选项

**预期结果**：
- ✅ 下拉框支持多选
- ✅ 显示已选择的角色
- ✅ 可以删除已选项
- ✅ 清空选择功能正常

### Test F2: 日期范围选择器

**位置**: 用户管理 → 搜索区 → 创建时间

**步骤**：
1. 点击日期选择器
2. 选择起始日期
3. 选择结束日期
4. 确认选择

**预期结果**：
- ✅ 日历弹窗显示
- ✅ 可以选择日期范围
- ✅ 显示已选择的范围
- ✅ 清空选择功能正常

### Test F3: 删除确认弹窗

**位置**: 任何删除操作

**步骤**：
1. 点击删除按钮
2. 观察弹窗内容
3. 输入删除原因
4. 点击确认

**预期结果**：
- ✅ 弹窗标题清晰
- ✅ 显示影响范围提示
- ✅ 文本框支持输入
- ✅ 有字符限制（200字符）
- ✅ 取消按钮功能正常
- ✅ 确定按钮功能正常

### Test F4: 统计信息展示

**位置**: 角色管理页面

**步骤**：
1. 进入角色管理页面
2. 观察表格内容

**预期结果**：
- ✅ "统计"列正确显示
- ✅ 用户数量与实际相符
- ✅ 菜单数量与实际相符
- ✅ 权限数量与实际相符
- ✅ 数量 Badge 显示正确

---

## 🔍 回归测试

确保优化没有破坏现有功能：

### 基础功能

- [ ] 用户登录
- [ ] 用户登出
- [ ] 获取当前用户信息
- [ ] Token 刷新
- [ ] 修改密码

### 用户管理

- [ ] 创建用户
- [ ] 编辑用户
- [ ] 删除用户
- [ ] 启用/禁用用户
- [ ] 批量操作
- [ ] 用户列表分页
- [ ] 用户统计信息

### 角色管理

- [ ] 创建角色
- [ ] 编辑角色
- [ ] 删除角色
- [ ] 分配菜单权限
- [ ] 分配操作权限
- [ ] 查看角色权限

### 菜单管理

- [ ] 创建菜单
- [ ] 编辑菜单
- [ ] 删除菜单
- [ ] 菜单排序
- [ ] 菜单树展示
- [ ] 用户菜单获取

### 权限管理

- [ ] 创建权限
- [ ] 编辑权限
- [ ] 删除权限
- [ ] 按资源分组查看
- [ ] 权限验证

---

## 🐛 已知问题和限制

### 1. 角色统计性能

**问题**: `GET /api/role/with-stats` 对每个角色查询用户数量，角色较多时可能较慢

**影响**: 角色超过 50 个时可能需要 2-3 秒加载

**临时方案**: 使用 `GET /api/role` 获取不带统计信息的列表

**计划**: 后续优化为聚合查询

### 2. 批量操作无进度显示

**问题**: 批量操作是一次性提交，无法显示实时进度

**影响**: 批量操作大量数据时用户无法了解进度

**临时方案**: 避免一次性操作过多数据（建议 < 100）

**计划**: 后续实现流式处理和进度推送

### 3. 迁移脚本的反射使用

**问题**: 迁移脚本使用反射读取已删除的 Role 字段

**影响**: 仅在首次迁移时使用，不影响运行时性能

**说明**: 这是一次性操作，迁移完成后不再执行

---

## ✅ 测试完成标准

系统通过测试的标准：

### 功能完整性
- ✅ 所有新功能正常工作
- ✅ 所有现有功能未受影响
- ✅ 所有 API 返回正确的数据

### 数据一致性
- ✅ Role 字段成功迁移到 RoleIds
- ✅ 级联删除正确清理引用
- ✅ 无孤儿数据（引用已删除的对象）

### 性能标准
- ✅ 活动日志查询只有 1 次数据库请求
- ✅ 用户列表查询响应时间 < 500ms
- ✅ 数据库索引创建成功

### 安全标准
- ✅ 所有保护规则正常工作
- ✅ 权限验证正确
- ✅ 无法执行非法操作

### 用户体验
- ✅ 搜索功能强大且易用
- ✅ 删除操作有明确提示
- ✅ 统计信息准确显示
- ✅ 错误消息清晰友好

---

## 📝 测试报告模板

测试完成后，填写以下报告：

```markdown
# 测试报告

**测试人员**: [姓名]
**测试日期**: [日期]
**测试环境**: [开发/测试/生产]

## 测试结果统计

- 总测试用例: [数量]
- 通过: [数量]
- 失败: [数量]
- 阻塞: [数量]

## 详细结果

### 阶段 1: 数据模型验证
- [x] Test 1.1: Role 字段迁移 - 通过
- [x] Test 1.2: 默认角色创建 - 通过
- [x] Test 1.3: 数据库索引 - 通过

### 阶段 2: API 功能验证
- [x] Test 2.1: 多角色搜索 - 通过
- [x] Test 2.2: 日期范围搜索 - 通过
- [x] Test 2.3: 删除原因输入 - 通过
- [x] Test 2.4: 批量删除 - 通过

### 阶段 3: 级联删除验证
- [x] Test 3.1: 角色级联删除 - 通过
- [x] Test 3.2: 菜单级联删除 - 通过
- [x] Test 3.3: 权限级联删除 - 通过

### 阶段 4: 安全规则验证
- [x] Test 4.1: 不能删除自己 - 通过
- [x] Test 4.2: 不能修改自己的角色 - 通过
- [x] Test 4.3: 不能删除管理员角色 - 通过
- [x] Test 4.4: 不能删除有子菜单的菜单 - 通过
- [x] Test 4.5: 权限验证 - 通过

### 阶段 5: 性能验证
- [x] Test 5.1: 活动日志性能 - 通过
- [x] Test 5.2: 用户列表性能 - 通过
- [x] Test 5.3: 角色统计性能 - 通过

### 阶段 6: 用户体验验证
- [x] Test 6.1.1: 多角色搜索 - 通过
- [x] Test 6.1.2: 日期范围搜索 - 通过
- [x] Test 6.1.3: 组合搜索 - 通过
- [x] Test 6.2: 删除原因记录 - 通过
- [x] Test 6.3: 角色统计显示 - 通过

## 发现的问题

[列出发现的问题和Bug]

## 建议

[提出改进建议]

## 结论

[测试结论：通过/不通过/需要修复]
```

---

## 🎯 自动化测试建议

### 单元测试

```csharp
// 建议添加的单元测试
[Test]
public async Task DeleteRole_ShouldRemoveFromUsers()
{
    // Arrange
    var role = await CreateTestRole();
    var user = await CreateTestUserWithRole(role.Id);
    
    // Act
    await _roleService.DeleteRoleAsync(role.Id, "测试");
    
    // Assert
    var updatedUser = await _userService.GetUserByIdAsync(user.Id);
    Assert.IsFalse(updatedUser.RoleIds.Contains(role.Id));
}
```

### 集成测试

```csharp
[Test]
public async Task DeleteMenu_ShouldRemoveFromRoles()
{
    // Arrange
    var menu = await CreateTestMenu();
    var role = await CreateTestRoleWithMenu(menu.Id);
    
    // Act
    var result = await _menuService.DeleteMenuAsync(menu.Id, "测试");
    
    // Assert
    Assert.IsTrue(result);
    var updatedRole = await _roleService.GetRoleByIdAsync(role.Id);
    Assert.IsFalse(updatedRole.MenuIds.Contains(menu.Id));
}
```

---

**按照此指南完成测试后，系统优化验证完成！** ✅

