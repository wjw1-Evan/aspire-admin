# 开发规范

> 面向 Aspire Admin Platform 的后端（.NET Aspire）、管理后台（React 19 + Ant Design Pro）与移动端（Expo Router）开发者。若存在冲突，以各专项文档为准（见文末链接）。

## 通用原则

- 统一：接口响应、授权模型、审计日志、异常处理、命名风格一致。
- 安全优先：JWT / HSTS / HTTPS、菜单级权限、敏感字段过滤、最小权限。
- 可审计：所有业务写操作需记录活动日志，数据访问走工厂自动填充审计字段与租户过滤。
- 可维护：遵循本文档及专项指南；提交使用 Conventional Commit；公共类型补充注释。

## 技术栈基线

- 后端：.NET 10 + Aspire，MongoDB（含 GridFS），YARP 网关，OpenTelemetry，SSE 实时通信，OpenAI 客户端。
- 管理后台：React 19 + Ant Design Pro + UmiJS（@umijs/max），`@` 路径别名，统一 request 封装。
- 移动端：React Native（Expo Router），`@` 路径别名，统一 apiService 封装。

## 后端规范（Platform.ApiService）

- 中间件顺序：ExceptionHandler → CORS → Auth → ActivityLog → ResponseFormatting → Controllers。
- 统一响应：控制器继承 `BaseApiController`，返回 `ApiResponse<T>` / `ApiResponse<PagedResult<T>>`，使用 `Success/SuccessPaged/Error/ValidationError` 等辅助方法；禁止裸 JSON。
- 授权与租户：权限粒度=菜单，使用 `[RequireMenu("module:resource:action")]`；业务上下文仅通过 `ICurrentUserContext` 获取用户/企业/权限；禁止直读 JWT 或直接访问 Mongo 无租户过滤。
- 数据访问：CRUD 必须走 `IDatabaseOperationFactory<T>`；实体至少实现 `IEntity`、`ISoftDeletable`、`ITimestamped`，多租户优先 `MultiTenantEntity`；禁止直接注入 `IMongoCollection/IMongoDatabase`。
- 审计与日志：`ActivityLogMiddleware` 必开；日志需过滤敏感字段（密码、密钥、token）；异常走统一处理输出标准错误码（如 `VALIDATION_ERROR/NOT_FOUND/UNAUTHORIZED/FORBIDDEN/INTERNAL_ERROR`）。
- 配置与安全：JWT Secret 必填（user-secrets/env）；生产启用 HSTS 与 HTTPS 重定向；CORS 白名单按环境配置；OpenAPI/Scalar 启用授权调试。
- 实时通信：SSE 端点 `/api/chat/sse`，事件类型遵循文档（Connected/Keepalive/Message/MessageChunk/MessageComplete/...）。
- 注册与扩展：各服务在启动时调用 `AddApplicationServices()`（自动注册业务服务与配置）。

## 管理后台规范（Platform.Admin）

- 请求：所有请求使用 `@umijs/max` 的 `request`，封装于 `src/services/*`；统一处理刷新 token 与错误提示。
- 路由与菜单：路由在 `config/routes.ts`；菜单多语言在 `src/locales/*/menu.ts`；新增页面需同步菜单文案。
- 页面版式：
  - 列表页使用 `PageContainer`，`paddingBlock: 12`；统计区用 `StatCard`。
  - 表格必须使用 `ProTable`（禁用原生 `Table`），操作列固定 150px，操作按钮 `Button type="text"`，删除需 `Popconfirm`。
  - 详情页使用右侧 `Drawer` + `Card` + `Descriptions`，宽度响应式。
- 页面风格规范：
  - 文字与排版：一级标题 `24/600`，卡片标题 `16/600`，正文 `14/400`，次要文字 `12/400`；行高≥1.5。
  - 间距：区块内边距 16；分区间距 12；表单项上下 12；按钮组间距 8；列表顶部/底部留白 12。
  - 颜色：主色使用 AntD token `colorPrimary`；禁用自定义全局色板；状态色统一 `success/info/warning/error` 的 AntD 语义色。
  - 组件：
    - 卡片：`<Card bordered={false}>`，标题区可放操作按钮；统计卡用 `StatCard`。
    - 表单：`ProForm` 系列，必填项 `required` + 校验规则；操作按钮固定在底部吸底区或抽屉底部。
    - 表格：`ProTable` 内置搜索折叠，分页固定底部；操作列固定右侧且 150px。
    - 弹层：优先 `Drawer` 右侧，宽度 480/720/960（按内容）；简单确认用 `Modal.confirm`，删除必须 `Popconfirm`。
    - 空状态：使用 AntD `Empty`；加载用 `Skeleton`；结果反馈用 `Result`。
  - 图标：使用 `@ant-design/icons`，尺寸 14/16；禁止自定义 SVG 作为按钮图标。
  - 响应式：`xl` 及以上 3-4 栏，`lg` 2-3 栏，`md` 2 栏，`sm` 单列；抽屉宽度随断点调整。
- 样式：禁止自定义全局 CSS class，优先 AntD/Pro 组件与内联样式。
- 权限：前端不依赖“隐藏按钮”防护；真实授权由后端菜单权限控制。

## 移动端规范（Platform.App）

- 路由：使用 Expo Router 文件路由；受控页面加 `AuthGuard`。
- API：统一通过 `services/apiService`，处理 token 刷新与错误提示。
- 实时通信：遵循 SSE 事件类型，支持自动重连（指数退避）与 30s 心跳；权限基于 JWT。
- 类型与风格：TypeScript `strict: true`，保持与后台响应模型一致；复用主题与组件库，避免自定义样式分叉。

## 跨端 API 约定

- 统一响应结构：`{ success, data, errorCode?, errorMessage?, showType?, timestamp }`。
- 分页：`ApiResponse<PagedResult<T>>`，包含 `items`, `page`, `pageSize`, `total`。
- 错误码：`VALIDATION_ERROR/NOT_FOUND/UNAUTHORIZED/FORBIDDEN/INTERNAL_ERROR` 等，前端按 `showType` 渲染。

## 代码质量与流程

- 提交：遵循 Conventional Commit（header ≤150 字符）。
- 类型与检查：前端至少执行 `npm run lint`（当前为 `tsc --noEmit`）；若引入 ESLint/格式化，请在脚本中补充并在 CI 强制。
- 文档：公共类型与接口补充注释；新增模块同步更新相关指南与菜单文档。
- 测试：后端使用 `dotnet test`；前端建议为关键逻辑添加单测/组件测试；SSE/权限等敏感流程应有集成验证。

## 参考文档

### Cursor AI 开发规则（模块化规则）

- `.cursor/rules/rule.mdc` – 规则索引与快速入口
- `.cursor/rules/00-global.mdc` – 通用架构原则与规范
- `.cursor/rules/backend.mdc` – 后端/API/ServiceDefaults/数据初始化规范
- `.cursor/rules/frontend-admin.mdc` – 管理后台（Platform.Admin）开发规范
- `.cursor/rules/frontend-app.mdc` – 移动端（Platform.App）开发规范

### 功能模块文档

- 后端核心与中间件：`docs/features/BACKEND-RULES.md`
- 统一 API 响应：`docs/features/API-RESPONSE-RULES.md`
- 菜单级权限：`docs/features/MENU-LEVEL-PERMISSION-GUIDE.md`
- 前端规范：`docs/features/FRONTEND-RULES.md`
- 实时通信：`docs/features/SSE-REALTIME-COMMUNICATION.md`
- 数据访问工厂：`docs/features/DATABASE-OPERATION-FACTORY-GUIDE.md`
- 数据初始化微服务：`docs/features/DATA-INITIALIZER-MICROSERVICE.md`
- 任务与项目管理：`docs/features/TASK-PROJECT-MANAGEMENT.md`
- 密码本：`docs/features/PASSWORD-BOOK-GUIDE.md`
- 安全审计：`docs/security/PASSWORD-BOOK-SECURITY-AUDIT.md`
